"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformProgram=transformProgram;var _SimpleTransform=require("../transform/SimpleTransform"),_astNodeMutationHelpers=require("../transform/astNodeMutationHelpers"),_SimpleTraverser=require("../traverse/SimpleTraverser"),_createSyntaxError=require("../utils/createSyntaxError");const nodeWith=_SimpleTransform.SimpleTransform.nodeWith,EMPTY_PARENT=null;function createDefaultPosition(){return{line:1,column:0}}function mapDeclareComponent(e){return{type:"DeclareVariable",id:nodeWith(e.id,{typeAnnotation:{type:"TypeAnnotation",typeAnnotation:{type:"AnyTypeAnnotation",loc:e.loc,range:e.range,parent:null},loc:e.loc,range:e.range,parent:null}}),kind:"const",loc:e.loc,range:e.range,parent:e.parent}}function getComponentParameterName(e){switch(e.type){case"Identifier":return e.name;case"Literal":return e.value;default:throw(0,_createSyntaxError.createSyntaxError)(e,`Unknown Component parameter name type of "${e.type}"`)}}function createPropsTypeAnnotation(e,t,n,a){const r=()=>({loc:{start:null!=(null==n?void 0:n.start)?n.start:createDefaultPosition(),end:null!=(null==n?void 0:n.end)?n.end:createDefaultPosition()},range:null!=a?a:[0,0],parent:null});if(null!=t&&0===e.length)return{type:"TypeAnnotation",typeAnnotation:t.argument,...r()};const o=[...e];null!=t&&o.unshift(t);const l={type:"ObjectTypeAnnotation",callProperties:[],properties:o,indexers:[],internalSlots:[],exact:!1,inexact:!1,...r()};return{type:"TypeAnnotation",typeAnnotation:{type:"GenericTypeAnnotation",id:{type:"Identifier",name:"$ReadOnly",optional:!1,typeAnnotation:null,...r()},typeParameters:{type:"TypeParameterInstantiation",params:[l],...r()},...r()},...r()}}function mapComponentParameters(e,t){var n;if(0===e.length)return{props:null,ref:null};if(1===e.length&&"RestElement"===e[0].type&&"Identifier"===e[0].argument.type){return{props:e[0].argument,ref:null}}let a=null;const r="18"===(null!=(n=t.reactRuntimeTarget)?n:"18")?e.filter(e=>"ComponentParameter"!==e.type||"ref"!==getComponentParameterName(e.name)||(a=e,!1)):e,[o,l]=r.reduce(([e,t],n)=>{switch(n.type){case"RestElement":if(null!=t)throw(0,_createSyntaxError.createSyntaxError)(n,"Invalid state, multiple rest elements found as Component Parameters");return[e,mapComponentParameterRestElementType(n)];case"ComponentParameter":return e.push(mapComponentParameterType(n)),[e,t]}},[[],null]),p=r.flatMap(mapComponentParameter);let i=null;if(0===p.length){if(null==a)throw new Error("StripComponentSyntax: Invalid state, ref should always be set at this point if props are empty");const e={start:a.loc.start,end:a.loc.start},t=[a.range[0],a.range[0]];i={type:"Identifier",name:"_$$empty_props_placeholder$$",optional:!1,typeAnnotation:createPropsTypeAnnotation([],null,e,t),loc:e,range:t,parent:null}}else{const e=p[p.length-1];i={type:"ObjectPattern",properties:p,typeAnnotation:createPropsTypeAnnotation(o,l,{start:e.loc.end,end:e.loc.end},[e.range[1],e.range[1]]),loc:{start:p[0].loc.start,end:e.loc.end},range:[p[0].range[0],e.range[1]],parent:null}}let c=null;return null!=a&&(c=a.local),{props:i,ref:c}}function mapComponentParameterType(e){var t;const n="AssignmentPattern"===e.local.type?e.local.left.typeAnnotation:e.local.typeAnnotation,a="AssignmentPattern"===e.local.type||"Identifier"===e.local.type&&e.local.optional;return{type:"ObjectTypeProperty",key:(0,_astNodeMutationHelpers.shallowCloneNode)(e.name),value:null!=(t=null==n?void 0:n.typeAnnotation)?t:{type:"AnyTypeAnnotation",loc:e.local.loc,range:e.local.range,parent:null},kind:"init",optional:a,method:!1,static:!1,proto:!1,variance:null,loc:e.local.loc,range:e.local.range,parent:null}}function mapComponentParameterRestElementType(e){var t,n;if("Identifier"!==e.argument.type&&"ObjectPattern"!==e.argument.type)throw(0,_createSyntaxError.createSyntaxError)(e,`Invalid ${e.argument.type} encountered in restParameter`);return{type:"ObjectTypeSpreadProperty",argument:null!=(t=null==(n=e.argument.typeAnnotation)?void 0:n.typeAnnotation)?t:{type:"AnyTypeAnnotation",loc:e.loc,range:e.range,parent:null},loc:e.loc,range:e.range,parent:null}}function mapComponentParameter(e){switch(e.type){case"RestElement":switch(e.argument.type){case"Identifier":return[nodeWith(e,{typeAnnotation:null,argument:nodeWith(e.argument,{typeAnnotation:null})})];case"ObjectPattern":return e.argument.properties.map(e=>nodeWith(e,{typeAnnotation:null}));default:throw(0,_createSyntaxError.createSyntaxError)(e,`Unhandled ${e.argument.type} encountered in restParameter`)}case"ComponentParameter":{let t;return t="AssignmentPattern"===e.local.type?nodeWith(e.local,{left:nodeWith(e.local.left,{typeAnnotation:null,optional:!1})}):nodeWith(e.local,{typeAnnotation:null,optional:!1}),"Identifier"!==e.name.type||!e.shorthand||"Identifier"!==t.type&&"AssignmentPattern"!==t.type?[{type:"Property",key:e.name,kind:"init",value:t,method:!1,shorthand:!1,computed:!1,loc:e.loc,range:e.range,parent:null}]:[{type:"Property",key:e.name,kind:"init",value:t,method:!1,shorthand:!0,computed:!1,loc:e.loc,range:e.range,parent:null}]}default:throw(0,_createSyntaxError.createSyntaxError)(e,`Unknown Component parameter type of "${e.type}"`)}}function createForwardRefWrapper(e){const t={type:"Identifier",name:`${e.id.name}_withRef`,optional:!1,typeAnnotation:null,loc:e.id.loc,range:e.id.range,parent:null};return{forwardRefStatement:{type:"VariableDeclaration",kind:"const",declarations:[{type:"VariableDeclarator",id:(0,_astNodeMutationHelpers.shallowCloneNode)(e.id),init:{type:"CallExpression",callee:{type:"MemberExpression",object:{type:"Identifier",name:"React",optional:!1,typeAnnotation:null,loc:e.loc,range:e.range,parent:null},property:{type:"Identifier",name:"forwardRef",optional:!1,typeAnnotation:null,loc:e.loc,range:e.range,parent:null},computed:!1,optional:!1,loc:e.loc,range:e.range,parent:null},arguments:[(0,_astNodeMutationHelpers.shallowCloneNode)(t)],typeArguments:null,optional:!1,loc:e.loc,range:e.range,parent:null},loc:e.loc,range:e.range,parent:null}],loc:e.loc,range:e.range,parent:e.parent},internalCompId:t,forwardRefCompId:e.id}}function mapComponentDeclaration(e,t){const n=()=>({loc:{start:e.body.loc.end,end:e.body.loc.end},range:[e.body.range[1],e.body.range[1]],parent:null}),a={type:"TypeAnnotation",typeAnnotation:{type:"GenericTypeAnnotation",id:{type:"QualifiedTypeIdentifier",qualification:{type:"Identifier",name:"React",optional:!1,typeAnnotation:null,...n()},id:{type:"Identifier",name:"Node",optional:!1,typeAnnotation:null,...n()},...n()},typeParameters:null,...n()},...n()},{props:r,ref:o}=mapComponentParameters(e.params,t);let l=null;null!=o&&(l=createForwardRefWrapper(e));return{comp:{type:"FunctionDeclaration",id:null!=l?(0,_astNodeMutationHelpers.shallowCloneNode)(l.internalCompId):(0,_astNodeMutationHelpers.shallowCloneNode)(e.id),__componentDeclaration:!0,typeParameters:e.typeParameters,params:null==r?[]:null==o?[r]:[r,o],returnType:a,body:e.body,async:!1,generator:!1,predicate:null,loc:e.loc,range:e.range,parent:e.parent},forwardRefDetails:l}}function mapDeclareHook(e){return{type:"DeclareFunction",id:{type:"Identifier",name:e.id.name,optional:e.id.optional,typeAnnotation:{type:"TypeAnnotation",typeAnnotation:{type:"FunctionTypeAnnotation",this:null,params:e.id.typeAnnotation.typeAnnotation.params,typeParameters:e.id.typeAnnotation.typeAnnotation.typeParameters,rest:e.id.typeAnnotation.typeAnnotation.rest,returnType:e.id.typeAnnotation.typeAnnotation.returnType,loc:e.id.typeAnnotation.typeAnnotation.loc,range:e.id.typeAnnotation.typeAnnotation.range,parent:e.id.typeAnnotation.typeAnnotation.parent},loc:e.id.typeAnnotation.loc,range:e.id.typeAnnotation.range,parent:e.id.typeAnnotation.parent},loc:e.id.loc,range:e.id.range,parent:e.id.parent},loc:e.loc,range:e.range,parent:e.parent,predicate:null}}function mapHookDeclaration(e){return{type:"FunctionDeclaration",id:e.id&&(0,_astNodeMutationHelpers.shallowCloneNode)(e.id),__hookDeclaration:!0,typeParameters:e.typeParameters,params:e.params,returnType:e.returnType,body:e.body,async:!1,generator:!1,predicate:null,loc:e.loc,range:e.range,parent:e.parent}}function scanForFirstComponentReference(e,t){for(let n=0;n<t.length;n++){const a=t[n];let r=null;if(_SimpleTraverser.SimpleTraverser.traverse(a,{enter(t){if("Identifier"===t.type)if(t.name===e)throw r=n,_SimpleTraverser.SimpleTraverser.Break},leave(e){}}),null!=r)return r}return null}function mapComponentDeclarationIntoList(e,t,n,a){const{comp:r,forwardRefDetails:o}=mapComponentDeclaration(e,n);if(null!=o){const e=scanForFirstComponentReference(o.forwardRefCompId.name,t);return null!=e?t.splice(e,0,o.forwardRefStatement):t.push(o.forwardRefStatement),t.push(r),void(null!=a&&t.push(a(o.forwardRefCompId)))}t.push(null!=a?a(r):r)}function mapStatementList(e,t){const n=[];for(const p of e)switch(p.type){case"ComponentDeclaration":mapComponentDeclarationIntoList(p,n,t);break;case"HookDeclaration":{const e=mapHookDeclaration(p);n.push(e);break}case"ExportNamedDeclaration":var a,r;if("ComponentDeclaration"===(null==(a=p.declaration)?void 0:a.type)){mapComponentDeclarationIntoList(p.declaration,n,t,e=>{switch(e.type){case"FunctionDeclaration":return nodeWith(p,{declaration:e});case"Identifier":return{type:"ExportNamedDeclaration",declaration:null,specifiers:[{type:"ExportSpecifier",exported:(0,_astNodeMutationHelpers.shallowCloneNode)(e),local:(0,_astNodeMutationHelpers.shallowCloneNode)(e),loc:p.loc,range:p.range,parent:null}],exportKind:"value",source:null,loc:p.loc,range:p.range,parent:p.parent}}});break}if("HookDeclaration"===(null==(r=p.declaration)?void 0:r.type)){const e=mapHookDeclaration(p.declaration);n.push(nodeWith(p,{declaration:e}));break}n.push(p);break;case"ExportDefaultDeclaration":var o,l;if("ComponentDeclaration"===(null==(o=p.declaration)?void 0:o.type)){mapComponentDeclarationIntoList(p.declaration,n,t,e=>nodeWith(p,{declaration:e}));break}if("HookDeclaration"===(null==(l=p.declaration)?void 0:l.type)){const e=mapHookDeclaration(p.declaration);n.push(nodeWith(p,{declaration:e}));break}n.push(p);break;default:n.push(p)}return n}function transformProgram(e,t){return _SimpleTransform.SimpleTransform.transformProgram(e,{transform(e){switch(e.type){case"DeclareComponent":return mapDeclareComponent(e);case"DeclareHook":return mapDeclareHook(e);case"Program":case"BlockStatement":return nodeWith(e,{body:mapStatementList(e.body,t)});case"SwitchCase":{const n=mapStatementList(e.consequent,t);return nodeWith(e,{consequent:n})}case"ComponentDeclaration":var n;throw(0,_createSyntaxError.createSyntaxError)(e,`Components must be defined at the top level of a module or within a BlockStatement, instead got parent of "${null==(n=e.parent)?void 0:n.type}".`);case"HookDeclaration":var a;throw(0,_createSyntaxError.createSyntaxError)(e,`Hooks must be defined at the top level of a module or within a BlockStatement, instead got parent of "${null==(a=e.parent)?void 0:a.type}".`);default:return e}}})}