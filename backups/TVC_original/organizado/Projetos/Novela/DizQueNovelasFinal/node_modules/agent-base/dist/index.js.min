"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,o,n)}:function(t,e,r,o){void 0===o&&(o=r),t[o]=e[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&__createBinding(e,t,r);return __setModuleDefault(e,t),e},__exportStar=this&&this.__exportStar||function(t,e){for(var r in t)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||__createBinding(e,t,r)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Agent=void 0;const net=__importStar(require("net")),http=__importStar(require("http")),https_1=require("https");__exportStar(require("./helpers"),exports);const INTERNAL=Symbol("AgentBaseInternalState");class Agent extends http.Agent{constructor(t){super(t),this[INTERNAL]={}}isSecureEndpoint(t){if(t){if("boolean"==typeof t.secureEndpoint)return t.secureEndpoint;if("string"==typeof t.protocol)return"https:"===t.protocol}const{stack:e}=new Error;return"string"==typeof e&&e.split("\n").some(t=>-1!==t.indexOf("(https.js:")||-1!==t.indexOf("node:https:"))}incrementSockets(t){if(this.maxSockets===1/0&&this.maxTotalSockets===1/0)return null;this.sockets[t]||(this.sockets[t]=[]);const e=new net.Socket({writable:!1});return this.sockets[t].push(e),this.totalSocketCount++,e}decrementSockets(t,e){if(!this.sockets[t]||null===e)return;const r=this.sockets[t],o=r.indexOf(e);-1!==o&&(r.splice(o,1),this.totalSocketCount--,0===r.length&&delete this.sockets[t])}getName(t){return this.isSecureEndpoint(t)?https_1.Agent.prototype.getName.call(this,t):super.getName(t)}createSocket(t,e,r){const o={...e,secureEndpoint:this.isSecureEndpoint(e)},n=this.getName(o),s=this.incrementSockets(n);Promise.resolve().then(()=>this.connect(t,o)).then(i=>{if(this.decrementSockets(n,s),i instanceof http.Agent)try{return i.addRequest(t,o)}catch(t){return r(t)}this[INTERNAL].currentSocket=i,super.createSocket(t,e,r)},t=>{this.decrementSockets(n,s),r(t)})}createConnection(){const t=this[INTERNAL].currentSocket;if(this[INTERNAL].currentSocket=void 0,!t)throw new Error("No socket was returned in the `connect()` function");return t}get defaultPort(){return this[INTERNAL].defaultPort??("https:"===this.protocol?443:80)}set defaultPort(t){this[INTERNAL]&&(this[INTERNAL].defaultPort=t)}get protocol(){return this[INTERNAL].protocol??(this.isSecureEndpoint()?"https:":"http:")}set protocol(t){this[INTERNAL]&&(this[INTERNAL].protocol=t)}}exports.Agent=Agent;