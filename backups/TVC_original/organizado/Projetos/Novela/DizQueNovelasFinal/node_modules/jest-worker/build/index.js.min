"use strict";function _os(){const e=require("os");return _os=function(){return e},e}function _path(){const e=require("path");return _path=function(){return e},e}function _url(){const e=require("url");return _url=function(){return e},e}Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"FifoQueue",{enumerable:!0,get:function(){return _FifoQueue.default}}),Object.defineProperty(exports,"PriorityQueue",{enumerable:!0,get:function(){return _PriorityQueue.default}}),exports.Worker=void 0,Object.defineProperty(exports,"messageParent",{enumerable:!0,get:function(){return _messageParent.default}});var _Farm=_interopRequireDefault(require("./Farm")),_WorkerPool=_interopRequireDefault(require("./WorkerPool")),_PriorityQueue=_interopRequireDefault(require("./PriorityQueue")),_FifoQueue=_interopRequireDefault(require("./FifoQueue")),_messageParent=_interopRequireDefault(require("./workers/messageParent"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getExposedMethods(e,r){let t=r.exposedMethods;if(!t){const r=require(e);t=Object.keys(r).filter(e=>"function"==typeof r[e]),"function"==typeof r&&(t=[...t,"default"])}return t}function getNumberOfCpus(){return"function"==typeof _os().availableParallelism?(0,_os().availableParallelism)():(0,_os().cpus)().length}class Worker{_ending;_farm;_options;_workerPool;constructor(e,r){if(this._options={...r},this._ending=!1,"string"!=typeof e&&(e=e.href),e.startsWith("file:"))e=(0,_url().fileURLToPath)(e);else if(!(0,_path().isAbsolute)(e))throw new Error(`'workerPath' must be absolute, got '${e}'`);const t={enableWorkerThreads:this._options.enableWorkerThreads??!1,forkOptions:this._options.forkOptions??{},idleMemoryLimit:this._options.idleMemoryLimit,maxRetries:this._options.maxRetries??3,numWorkers:this._options.numWorkers??Math.max(getNumberOfCpus()-1,1),resourceLimits:this._options.resourceLimits??{},setupArgs:this._options.setupArgs??[]};this._options.WorkerPool?this._workerPool=new this._options.WorkerPool(e,t):this._workerPool=new _WorkerPool.default(e,t),this._farm=new _Farm.default(t.numWorkers,this._workerPool.send.bind(this._workerPool),{computeWorkerKey:this._options.computeWorkerKey,taskQueue:this._options.taskQueue,workerSchedulingPolicy:this._options.workerSchedulingPolicy}),this._bindExposedWorkerMethods(e,this._options)}_bindExposedWorkerMethods(e,r){getExposedMethods(e,r).forEach(e=>{if(!e.startsWith("_")){if(this.constructor.prototype.hasOwnProperty(e))throw new TypeError(`Cannot define a method called ${e}`);this[e]=this._callFunctionWithArgs.bind(this,e)}})}_callFunctionWithArgs(e,...r){if(this._ending)throw new Error("Farm is ended, no more calls can be done to it");return this._farm.doWork(e,...r)}getStderr(){return this._workerPool.getStderr()}getStdout(){return this._workerPool.getStdout()}async start(){await this._workerPool.start()}async end(){if(this._ending)throw new Error("Farm is ended, no more calls can be done to it");return this._ending=!0,this._workerPool.end()}}exports.Worker=Worker;