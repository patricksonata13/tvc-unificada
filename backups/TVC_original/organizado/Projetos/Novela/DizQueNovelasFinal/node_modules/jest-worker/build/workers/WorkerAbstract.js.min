"use strict";function _stream(){const e=require("stream");return _stream=function(){return e},e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _types=require("../types");class WorkerAbstract extends _stream().EventEmitter{#e=_types.WorkerStates.STARTING;_fakeStream=null;_exitPromise;_resolveExitPromise;_workerReadyPromise;_resolveWorkerReady;get state(){return this.#e}set state(e){if(this.#e!==e){const t=this.#e;this.#e=e,this.emit(_types.WorkerEvents.STATE_CHANGE,e,t)}}constructor(e){if(super(),"object"==typeof e.on)for(const[t,r]of Object.entries(e.on))if("function"==typeof r)super.on(t,r);else for(const e of r)super.on(t,e);this._exitPromise=new Promise(e=>{this._resolveExitPromise=e}),this._exitPromise.then(()=>{this.state=_types.WorkerStates.SHUT_DOWN})}waitForWorkerReady(){return this._workerReadyPromise||(this._workerReadyPromise=new Promise((e,t)=>{let r,s=!1;switch(this.state){case _types.WorkerStates.OUT_OF_MEMORY:case _types.WorkerStates.SHUTTING_DOWN:case _types.WorkerStates.SHUT_DOWN:s=!0,t(new Error(`Worker state means it will never be ready: ${this.state}`));break;case _types.WorkerStates.STARTING:case _types.WorkerStates.RESTARTING:this._resolveWorkerReady=()=>{s=!0,e(),r&&clearTimeout(r)};break;case _types.WorkerStates.OK:s=!0,e()}s||(r=setTimeout(()=>{s||t(new Error("Timeout starting worker"))},500))})),this._workerReadyPromise}_shutdown(){this.state,_types.WorkerStates.SHUT_DOWN,this._fakeStream&&(this._fakeStream.end(),this._fakeStream=null),this._resolveExitPromise()}_getFakeStream(){return this._fakeStream||(this._fakeStream=new(_stream().PassThrough)),this._fakeStream}}exports.default=WorkerAbstract;