"use strict";function _mergeStream(){const e=_interopRequireDefault(require("merge-stream"));return _mergeStream=function(){return e},e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _types=require("../types");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const FORCE_EXIT_DELAY=500,emptyMethod=()=>{};class BaseWorkerPool{_stderr;_stdout;_options;_workers;_workerPath;constructor(e,r){this._options=r,this._workerPath=e,this._workers=new Array(r.numWorkers);const t=(0,_mergeStream().default)(),o=(0,_mergeStream().default)(),{forkOptions:s,maxRetries:i,resourceLimits:a,setupArgs:n}=r;for(let u=0;u<r.numWorkers;u++){const r={forkOptions:s,idleMemoryLimit:this._options.idleMemoryLimit,maxRetries:i,resourceLimits:a,setupArgs:n,workerId:u,workerPath:e},d=this.createWorker(r),_=d.getStdout(),m=d.getStderr();_&&t.add(_),m&&o.add(m),this._workers[u]=d}this._stdout=t,this._stderr=o}getStderr(){return this._stderr}getStdout(){return this._stdout}getWorkers(){return this._workers}getWorkerById(e){return this._workers[e]}restartWorkerIfShutDown(e){if(this._workers[e].state===_types.WorkerStates.SHUT_DOWN){const{forkOptions:r,maxRetries:t,resourceLimits:o,setupArgs:s}=this._options,i={forkOptions:r,idleMemoryLimit:this._options.idleMemoryLimit,maxRetries:t,resourceLimits:o,setupArgs:s,workerId:e,workerPath:this._workerPath},a=this.createWorker(i);this._workers[e]=a}}createWorker(e){throw Error("Missing method createWorker in WorkerPool")}async start(){await Promise.all(this._workers.map(async e=>{await e.waitForWorkerReady(),await new Promise((r,t)=>{e.send([_types.CHILD_MESSAGE_CALL_SETUP],emptyMethod,e=>{e?t(e):r()},emptyMethod)})}))}async end(){const e=this._workers.map(async e=>{e.send([_types.CHILD_MESSAGE_END,!1],emptyMethod,emptyMethod,emptyMethod);let r=!1;const t=setTimeout(()=>{e.forceExit(),r=!0},500);return await e.waitForExit(),clearTimeout(t),r});return(await Promise.all(e)).reduce((e,r)=>({forceExited:e.forceExited||r}),{forceExited:!1})}}exports.default=BaseWorkerPool;