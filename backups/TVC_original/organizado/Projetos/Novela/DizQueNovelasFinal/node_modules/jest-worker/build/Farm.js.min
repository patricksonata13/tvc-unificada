"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _FifoQueue=_interopRequireDefault(require("./FifoQueue")),_types=require("./types");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}class Farm{_computeWorkerKey;_workerSchedulingPolicy;_cacheKeys=Object.create(null);_locks=[];_offset=0;_taskQueue;constructor(e,t,s={}){this._numOfWorkers=e,this._callback=t,this._computeWorkerKey=s.computeWorkerKey,this._workerSchedulingPolicy=s.workerSchedulingPolicy??"round-robin",this._taskQueue=s.taskQueue??new _FifoQueue.default}doWork(e,...t){const s=new Set,r=e=>{s.forEach(t=>t(e))},u=new Promise(((t,u,o)=>{const i=this._computeWorkerKey,n=[_types.CHILD_MESSAGE_CALL,!1,e,t];let c=null,l=null;i&&(l=i.call(this,e,...t),c=null==l?null:this._cacheKeys[l]);const _={onCustomMessage:r,onEnd:(e,t)=>{s.clear(),e?o(e):u(t)},onStart:e=>{null!=l&&(this._cacheKeys[l]=e)},request:n};c?(this._taskQueue.enqueue(_,c.getWorkerId()),this._process(c.getWorkerId())):this._push(_)}).bind(null,t));return u.UNSTABLE_onCustomMessage=e=>(s.add(e),()=>{s.delete(e)}),u}_process(e){if(this._isLocked(e))return this;const t=this._taskQueue.dequeue(e);if(!t)return this;if(t.request[1])throw new Error("Queue implementation returned processed task");let s=t.onEnd;return t.request[1]=!0,this._lock(e),this._callback(e,t.request,t.onStart,(t,r)=>{s&&s(t,r),s=null,this._unlock(e),this._process(e)},t.onCustomMessage),this}_push(e){this._taskQueue.enqueue(e);const t=this._getNextWorkerOffset();for(let s=0;s<this._numOfWorkers&&(this._process((t+s)%this._numOfWorkers),!e.request[1]);s++);return this}_getNextWorkerOffset(){switch(this._workerSchedulingPolicy){case"in-order":return 0;case"round-robin":return this._offset++}}_lock(e){this._locks[e]=!0}_unlock(e){this._locks[e]=!1}_isLocked(e){return this._locks[e]}}exports.default=Farm;