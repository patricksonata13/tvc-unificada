/**
 * @license
 * Copyright (c) 2016, Contributors
 * SPDX-License-Identifier: ISC
 */
import{tokenizeArgString}from"./tokenize-arg-string.js";import{DefaultValuesForTypeKey}from"./yargs-parser-types.js";import{camelCase,decamelize,looksLikeNumber}from"./string-utils.js";let mixin;export class YargsParser{constructor(e){mixin=e}parse(e,t){const n=Object.assign({alias:void 0,array:void 0,boolean:void 0,config:void 0,configObjects:void 0,configuration:void 0,coerce:void 0,count:void 0,default:void 0,envPrefix:void 0,narg:void 0,normalize:void 0,string:void 0,number:void 0,__:void 0,key:void 0},t),o=tokenizeArgString(e),r="string"==typeof e,a=combineAliases(Object.assign(Object.create(null),n.alias)),s=Object.assign({"boolean-negation":!0,"camel-case-expansion":!0,"combine-arrays":!1,"dot-notation":!0,"duplicate-arguments-array":!0,"flatten-duplicate-arrays":!0,"greedy-arrays":!0,"halt-at-non-option":!1,"nargs-eats-options":!1,"negation-prefix":"no-","parse-numbers":!0,"parse-positional-numbers":!0,"populate--":!1,"set-placeholder-key":!1,"short-option-groups":!0,"strip-aliased":!1,"strip-dashed":!1,"unknown-options-as-args":!1},n.configuration),i=Object.assign(Object.create(null),n.default),c=n.configObjects||[],l=n.envPrefix,f=s["populate--"],u=f?"--":"_",y=Object.create(null),p=Object.create(null),h=n.__||mixin.format,g={aliases:Object.create(null),arrays:Object.create(null),bools:Object.create(null),strings:Object.create(null),numbers:Object.create(null),counts:Object.create(null),normalize:Object.create(null),configs:Object.create(null),nargs:Object.create(null),coercions:Object.create(null),keys:[]},m=/^-([0-9]+(\.[0-9]+)?|\.[0-9]+)$/,b=new RegExp("^--"+s["negation-prefix"]+"(.+)");[].concat(n.array||[]).filter(Boolean).forEach(function(e){const t="object"==typeof e?e.key:e,n=Object.keys(e).map(function(e){return{boolean:"bools",string:"strings",number:"numbers"}[e]}).filter(Boolean).pop();n&&(g[n][t]=!0),g.arrays[t]=!0,g.keys.push(t)}),[].concat(n.boolean||[]).filter(Boolean).forEach(function(e){g.bools[e]=!0,g.keys.push(e)}),[].concat(n.string||[]).filter(Boolean).forEach(function(e){g.strings[e]=!0,g.keys.push(e)}),[].concat(n.number||[]).filter(Boolean).forEach(function(e){g.numbers[e]=!0,g.keys.push(e)}),[].concat(n.count||[]).filter(Boolean).forEach(function(e){g.counts[e]=!0,g.keys.push(e)}),[].concat(n.normalize||[]).filter(Boolean).forEach(function(e){g.normalize[e]=!0,g.keys.push(e)}),"object"==typeof n.narg&&Object.entries(n.narg).forEach(([e,t])=>{"number"==typeof t&&(g.nargs[e]=t,g.keys.push(e))}),"object"==typeof n.coerce&&Object.entries(n.coerce).forEach(([e,t])=>{"function"==typeof t&&(g.coercions[e]=t,g.keys.push(e))}),void 0!==n.config&&(Array.isArray(n.config)||"string"==typeof n.config?[].concat(n.config).filter(Boolean).forEach(function(e){g.configs[e]=!0}):"object"==typeof n.config&&Object.entries(n.config).forEach(([e,t])=>{"boolean"!=typeof t&&"function"!=typeof t||(g.configs[e]=t)})),function(...e){e.forEach(function(e){Object.keys(e||{}).forEach(function(e){g.aliases[e]||(g.aliases[e]=[].concat(a[e]||[]),g.aliases[e].concat(e).forEach(function(t){if(/-/.test(t)&&s["camel-case-expansion"]){const n=camelCase(t);n!==e&&-1===g.aliases[e].indexOf(n)&&(g.aliases[e].push(n),y[n]=!0)}}),g.aliases[e].concat(e).forEach(function(t){if(t.length>1&&/[A-Z]/.test(t)&&s["camel-case-expansion"]){const n=decamelize(t,"-");n!==e&&-1===g.aliases[e].indexOf(n)&&(g.aliases[e].push(n),y[n]=!0)}}),g.aliases[e].forEach(function(t){g.aliases[t]=[e].concat(g.aliases[e].filter(function(e){return t!==e}))}))})})}(n.key,a,n.default,g.arrays),Object.keys(i).forEach(function(e){(g.aliases[e]||[]).forEach(function(t){i[t]=i[e]})});let d=null;Object.keys(g.counts).find(e=>F(e,g.arrays)?(d=Error(h("Invalid configuration: %s, opts.count excludes opts.array.",e)),!0):!!F(e,g.nargs)&&(d=Error(h("Invalid configuration: %s, opts.count excludes opts.narg.",e)),!0));let j=[];const O=Object.assign(Object.create(null),{_:[]}),A={};for(let e=0;e<o.length;e++){const t=o[e],n=t.replace(/^-{3,}/,"---");let r,a,i,c,l,f;if("--"!==t&&/^-/.test(t)&&V(t))E(t);else{if(n.match(/^---+(=|$)/)){E(t);continue}if(t.match(/^--.+=/)||!s["short-option-groups"]&&t.match(/^-.+=/))c=t.match(/^--?([^=]+)=([\s\S]*)$/),null!==c&&Array.isArray(c)&&c.length>=3&&(F(c[1],g.arrays)?e=v(e,c[1],o,c[2]):!1!==F(c[1],g.nargs)?e=k(e,c[1],o,c[2]):x(c[1],c[2],!0));else if(t.match(b)&&s["boolean-negation"])c=t.match(b),null!==c&&Array.isArray(c)&&c.length>=2&&(a=c[1],x(a,!!F(a,g.arrays)&&[!1]));else if(t.match(/^--.+/)||!s["short-option-groups"]&&t.match(/^-[^-]+/))c=t.match(/^--?(.+)/),null!==c&&Array.isArray(c)&&c.length>=2&&(a=c[1],F(a,g.arrays)?e=v(e,a,o):!1!==F(a,g.nargs)?e=k(e,a,o):(l=o[e+1],void 0===l||l.match(/^-/)&&!l.match(m)||F(a,g.bools)||F(a,g.counts)?/^(true|false)$/.test(l)?(x(a,l),e++):x(a,w(a)):(x(a,l),e++)));else if(t.match(/^-.\..+=/))c=t.match(/^-([^=]+)=([\s\S]*)$/),null!==c&&Array.isArray(c)&&c.length>=3&&x(c[1],c[2]);else if(t.match(/^-.\..+/)&&!t.match(m))l=o[e+1],c=t.match(/^-(.\..+)/),null!==c&&Array.isArray(c)&&c.length>=2&&(a=c[1],void 0===l||l.match(/^-/)||F(a,g.bools)||F(a,g.counts)?x(a,w(a)):(x(a,l),e++));else if(t.match(/^-[^-]+/)&&!t.match(m)){i=t.slice(1,-1).split(""),r=!1;for(let n=0;n<i.length;n++){if(l=t.slice(n+2),i[n+1]&&"="===i[n+1]){f=t.slice(n+3),a=i[n],F(a,g.arrays)?e=v(e,a,o,f):!1!==F(a,g.nargs)?e=k(e,a,o,f):x(a,f),r=!0;break}if("-"!==l){if(/[A-Za-z]/.test(i[n])&&/^-?\d+(\.\d*)?(e-?\d+)?$/.test(l)&&!1===F(l,g.bools)){x(i[n],l),r=!0;break}if(i[n+1]&&i[n+1].match(/\W/)){x(i[n],l),r=!0;break}x(i[n],w(i[n]))}else x(i[n],l)}a=t.slice(-1)[0],r||"-"===a||(F(a,g.arrays)?e=v(e,a,o):!1!==F(a,g.nargs)?e=k(e,a,o):(l=o[e+1],void 0===l||/^(-|--)[^-]/.test(l)&&!l.match(m)||F(a,g.bools)||F(a,g.counts)?/^(true|false)$/.test(l)?(x(a,l),e++):x(a,w(a)):(x(a,l),e++)))}else if(t.match(/^-[0-9]$/)&&t.match(m)&&F(t.slice(1),g.bools))a=t.slice(1),x(a,w(a));else{if("--"===t){j=o.slice(e+1);break}if(s["halt-at-non-option"]){j=o.slice(e);break}E(t)}}}function E(e){const t=N("_",e);"string"!=typeof t&&"number"!=typeof t||O._.push(t)}function k(e,t,n,o){let r,a=F(t,g.nargs);if(a="number"!=typeof a||isNaN(a)?1:a,0===a)return R(o)||(d=Error(h("Argument unexpected for: %s",t))),x(t,w(t)),e;let i=R(o)?0:1;if(s["nargs-eats-options"])n.length-(e+1)+i<a&&(d=Error(h("Not enough arguments following: %s",t))),i=a;else{for(r=e+1;r<n.length&&(!n[r].match(/^-[^0-9]/)||n[r].match(m)||V(n[r]));r++)i++;i<a&&(d=Error(h("Not enough arguments following: %s",t)))}let c=Math.min(i,a);for(!R(o)&&c>0&&(x(t,o),c--),r=e+1;r<c+e+1;r++)x(t,n[r]);return e+c}function v(e,t,n,o){let a=[],c=o||n[e+1];const l=F(t,g.nargs);if(F(t,g.bools)&&!/^(true|false)$/.test(c))a.push(!0);else if(R(c)||R(o)&&/^-/.test(c)&&!m.test(c)&&!V(c)){if(void 0!==i[t]){const e=i[t];a=Array.isArray(e)?e:[e]}}else{R(o)||a.push(z(t,o,!0));for(let o=e+1;o<n.length&&!(!s["greedy-arrays"]&&a.length>0||l&&"number"==typeof l&&a.length>=l)&&(c=n[o],!/^-/.test(c)||m.test(c)||V(c));o++)e=o,a.push(z(t,c,r))}return"number"==typeof l&&(l&&a.length<l||isNaN(l)&&0===a.length)&&(d=Error(h("Not enough arguments following: %s",t))),x(t,a),e}function x(e,t,n=r){if(/-/.test(e)&&s["camel-case-expansion"]){const t=e.split(".").map(function(e){return camelCase(e)}).join(".");_(e,t)}const o=z(e,t,n),a=e.split(".");if(D(O,a,o),g.aliases[e]&&g.aliases[e].forEach(function(e){const t=e.split(".");D(O,t,o)}),a.length>1&&s["dot-notation"]&&(g.aliases[a[0]]||[]).forEach(function(t){let n=t.split(".");const r=[].concat(a);r.shift(),n=n.concat(r),(g.aliases[e]||[]).includes(n.join("."))||D(O,n,o)}),F(e,g.normalize)&&!F(e,g.arrays)){[e].concat(g.aliases[e]||[]).forEach(function(e){Object.defineProperty(A,e,{enumerable:!0,get:()=>t,set(e){t="string"==typeof e?mixin.normalize(e):e}})})}}function _(e,t){g.aliases[e]&&g.aliases[e].length||(g.aliases[e]=[t],y[t]=!0),g.aliases[t]&&g.aliases[t].length||_(t,e)}function z(e,t,n){n&&(t=stripQuotes(t)),(F(e,g.bools)||F(e,g.counts))&&"string"==typeof t&&(t="true"===t);let o=Array.isArray(t)?t.map(function(t){return N(e,t)}):N(e,t);return F(e,g.counts)&&(R(o)||"boolean"==typeof o)&&(o=increment()),F(e,g.normalize)&&F(e,g.arrays)&&(o=Array.isArray(t)?t.map(e=>mixin.normalize(e)):mixin.normalize(t)),o}function N(e,t){if(!s["parse-positional-numbers"]&&"_"===e)return t;if(!F(e,g.strings)&&!F(e,g.bools)&&!Array.isArray(t)){(looksLikeNumber(t)&&s["parse-numbers"]&&Number.isSafeInteger(Math.floor(parseFloat(`${t}`)))||!R(t)&&F(e,g.numbers))&&(t=Number(t))}return t}function $(e,t){Object.keys(e).forEach(function(n){const o=e[n],r=t?t+"."+n:n;"object"==typeof o&&null!==o&&!Array.isArray(o)&&s["dot-notation"]?$(o,r):(!T(O,r.split("."))||F(r,g.arrays)&&s["combine-arrays"])&&x(r,o)})}function B(e,t){if(void 0===l)return;const n="string"==typeof l?l:"",o=mixin.env();Object.keys(o).forEach(function(r){if(""===n||0===r.lastIndexOf(n,0)){const a=r.split("__").map(function(e,t){return 0===t&&(e=e.substring(n.length)),camelCase(e)});(t&&g.configs[a.join(".")]||!t)&&!T(e,a)&&x(a.join("."),o[r])}})}function K(e,t,n,o=!1){Object.keys(n).forEach(function(r){T(e,r.split("."))||(D(e,r.split("."),n[r]),o&&(p[r]=!0),(t[r]||[]).forEach(function(t){T(e,t.split("."))||D(e,t.split("."),n[r])}))})}function T(e,t){let n=e;s["dot-notation"]||(t=[t.join(".")]),t.slice(0,-1).forEach(function(e){n=n[e]||{}});const o=t[t.length-1];return"object"==typeof n&&o in n}function D(e,t,n){let o=e;s["dot-notation"]||(t=[t.join(".")]),t.slice(0,-1).forEach(function(e){e=sanitizeKey(e),"object"==typeof o&&void 0===o[e]&&(o[e]={}),"object"!=typeof o[e]||Array.isArray(o[e])?(Array.isArray(o[e])?o[e].push({}):o[e]=[o[e],{}],o=o[e][o[e].length-1]):o=o[e]});const r=sanitizeKey(t[t.length-1]),a=F(t.join("."),g.arrays),i=Array.isArray(n);let c=s["duplicate-arguments-array"];!c&&F(r,g.nargs)&&(c=!0,(!R(o[r])&&1===g.nargs[r]||Array.isArray(o[r])&&o[r].length===g.nargs[r])&&(o[r]=void 0)),n===increment()?o[r]=increment(o[r]):Array.isArray(o[r])?c&&a&&i?o[r]=s["flatten-duplicate-arrays"]?o[r].concat(n):(Array.isArray(o[r][0])?o[r]:[o[r]]).concat([n]):c||Boolean(a)!==Boolean(i)?o[r]=o[r].concat([n]):o[r]=n:void 0===o[r]&&a?o[r]=i?n:[n]:!c||void 0===o[r]||F(r,g.counts)||F(r,g.bools)?o[r]=n:o[r]=[o[r],n]}function F(e,t){const n=[].concat(g.aliases[e]||[],e),o=Object.keys(t),r=n.find(e=>o.includes(e));return!!r&&t[r]}function S(e){const t=Object.keys(g);return[].concat(t.map(e=>g[e])).some(function(t){return Array.isArray(t)?t.includes(e):t[e]})}function V(e){return s["unknown-options-as-args"]&&function(e){if(e=e.replace(/^-{3,}/,"--"),e.match(m))return!1;if(function(e){if(e.match(m)||!e.match(/^-[^-]+/))return!1;let t,n=!0;const o=e.slice(1).split("");for(let r=0;r<o.length;r++){if(t=e.slice(r+2),!S(o[r])){n=!1;break}if(o[r+1]&&"="===o[r+1]||"-"===t||/[A-Za-z]/.test(o[r])&&/^-?\d+(\.\d*)?(e-?\d+)?$/.test(t)||o[r+1]&&o[r+1].match(/\W/))break}return n}(e))return!1;return!function(e,...t){return[].concat(...t).some(function(t){const n=e.match(t);return n&&S(n[1])})}(e,/^-+([^=]+?)=[\s\S]*$/,b,/^-+([^=]+?)$/,/^-+([^=]+?)-$/,/^-+([^=]+?\d+)$/,/^-+([^=]+?)\W+.*$/)}(e)}function w(e){return F(e,g.bools)||F(e,g.counts)||!(`${e}`in i)?(t=function(e){let t=DefaultValuesForTypeKey.BOOLEAN;return F(e,g.strings)?t=DefaultValuesForTypeKey.STRING:F(e,g.numbers)?t=DefaultValuesForTypeKey.NUMBER:F(e,g.bools)?t=DefaultValuesForTypeKey.BOOLEAN:F(e,g.arrays)&&(t=DefaultValuesForTypeKey.ARRAY),t}(e),{[DefaultValuesForTypeKey.BOOLEAN]:!0,[DefaultValuesForTypeKey.STRING]:"",[DefaultValuesForTypeKey.NUMBER]:void 0,[DefaultValuesForTypeKey.ARRAY]:[]}[t]):i[e];var t}function R(e){return void 0===e}return B(O,!0),B(O,!1),function(e){const t=Object.create(null);K(t,g.aliases,i),Object.keys(g.configs).forEach(function(n){const o=e[n]||t[n];if(o)try{let e=null;const t=mixin.resolve(mixin.cwd(),o),r=g.configs[n];if("function"==typeof r){try{e=r(t)}catch(t){e=t}if(e instanceof Error)return void(d=e)}else e=mixin.require(t);$(e)}catch(t){"PermissionDenied"===t.name?d=t:e[n]&&(d=Error(h("Invalid JSON config file: %s",o)))}})}(O),void 0!==c&&c.forEach(function(e){$(e)}),K(O,g.aliases,i,!0),function(e){let t;const n=new Set;Object.keys(e).forEach(function(o){if(!n.has(o)&&(t=F(o,g.coercions),"function"==typeof t))try{const r=N(o,t(e[o]));[].concat(g.aliases[o]||[],o).forEach(t=>{n.add(t),e[t]=r})}catch(e){d=e}})}(O),s["set-placeholder-key"]&&function(e){g.keys.forEach(t=>{~t.indexOf(".")||void 0===e[t]&&(e[t]=void 0)})}(O),Object.keys(g.counts).forEach(function(e){T(O,e.split("."))||x(e,0)}),f&&j.length&&(O[u]=[]),j.forEach(function(e){O[u].push(e)}),s["camel-case-expansion"]&&s["strip-dashed"]&&Object.keys(O).filter(e=>"--"!==e&&e.includes("-")).forEach(e=>{delete O[e]}),s["strip-aliased"]&&[].concat(...Object.keys(a).map(e=>a[e])).forEach(e=>{s["camel-case-expansion"]&&e.includes("-")&&delete O[e.split(".").map(e=>camelCase(e)).join(".")],delete O[e]}),{aliases:Object.assign({},g.aliases),argv:Object.assign(A,O),configuration:s,defaulted:Object.assign({},p),error:d,newAliases:Object.assign({},y)}}}function combineAliases(e){const t=[],n=Object.create(null);let o=!0;for(Object.keys(e).forEach(function(n){t.push([].concat(e[n],n))});o;){o=!1;for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){if(t[e].filter(function(e){return-1!==t[n].indexOf(e)}).length){t[e]=t[e].concat(t[n]),t.splice(n,1),o=!0;break}}}return t.forEach(function(e){const t=(e=e.filter(function(e,t,n){return n.indexOf(e)===t})).pop();void 0!==t&&"string"==typeof t&&(n[t]=e)}),n}function increment(e){return void 0!==e?e+1:1}function sanitizeKey(e){return"__proto__"===e?"___proto___":e}function stripQuotes(e){return"string"!=typeof e||"'"!==e[0]&&'"'!==e[0]||e[e.length-1]!==e[0]?e:e.substring(1,e.length-1)}