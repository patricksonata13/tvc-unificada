"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveReactNativeModule=resolveReactNativeModule,exports.createReactNativeConfigAsync=createReactNativeConfigAsync,exports.resolveAppProjectConfigAsync=resolveAppProjectConfigAsync;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),androidResolver_1=require("./androidResolver"),config_1=require("./config"),iosResolver_1=require("./iosResolver"),ExpoModuleConfig_1=require("../ExpoModuleConfig"),dependencies_1=require("../dependencies"),webResolver_1=require("./webResolver"),isMissingFBReactNativeSpecCodegenOutput=async e=>{const t=path_1.default.resolve(e,"React/FBReactNativeSpec");try{return!(await fs_1.default.promises.lstat(t)).isDirectory()}catch{return!0}};async function resolveReactNativeModule(e,t,a,n){if(n.has(e.name))return null;if("react-native"===e.name||"react-native-macos"===e.name)return null;const i=await(0,config_1.loadConfigAsync)(e.path),o={...i?.dependency,...t?.dependencies?.[e.name]};if(Object.keys(i?.platforms??{}).length>0)return null;let r;if(!i)try{r=await(0,ExpoModuleConfig_1.discoverExpoModuleConfigAsync)(e.path)}catch{}let s=null;return"android"===a?s=await(0,androidResolver_1.resolveDependencyConfigImplAndroidAsync)(e.path,o.platforms?.android,r):"ios"===a?s=await(0,iosResolver_1.resolveDependencyConfigImplIosAsync)(e,o.platforms?.ios,r):"web"===a&&(s=await(0,webResolver_1.checkDependencyWebAsync)(e,o,r)),s&&{root:e.path,name:e.name,platforms:{[a]:s}}}async function createReactNativeConfigAsync({appRoot:e,sourceDir:t,autolinkingOptions:a}){const n=new Set(a.exclude),i=await(0,config_1.loadConfigAsync)(e),o=a.nativeModulesDir?[a.nativeModulesDir,...a.searchPaths]:a.searchPaths,r=a.legacy_shallowReactNativeLinking?1:void 0,s=(0,dependencies_1.mergeResolutionResults)(await Promise.all([(0,dependencies_1.scanDependenciesFromRNProjectConfig)(e,i),...o.map(e=>(0,dependencies_1.scanDependenciesInSearchPath)(e)),(0,dependencies_1.scanDependenciesRecursively)(e,{limitDepth:r})])),c=await(0,dependencies_1.filterMapResolutionResult)(s,e=>resolveReactNativeModule(e,i,a.platform,n)),l=s["react-native"];return l&&"ios"===a.platform&&await isMissingFBReactNativeSpecCodegenOutput(l.path)&&(c["react-native"]={root:l.path,name:"react-native",platforms:{ios:{podspecPath:"",version:l.version,configurations:[],scriptPhases:[]}}}),{root:e,reactNativePath:s["react-native"]?.path,dependencies:c,project:await resolveAppProjectConfigAsync(e,a.platform,t)}}async function resolveAppProjectConfigAsync(e,t,a){if("android"===t){const t=a??path_1.default.join(e,"android"),{gradle:n,manifest:i}=await(0,androidResolver_1.findGradleAndManifestAsync)({androidDir:t,isLibrary:!1});if(null==n||null==i)return{};return{android:{packageName:await(0,androidResolver_1.parsePackageNameAsync)(i,n)??"",sourceDir:a??path_1.default.join(e,"android")}}}return"ios"===t?{ios:{sourceDir:a??path_1.default.join(e,"ios")}}:{}}