"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadPackageJson=exports.maybeRealpath=exports.fastJoin=void 0,exports.defaultShouldIncludeDependency=defaultShouldIncludeDependency,exports.mergeWithDuplicate=mergeWithDuplicate,exports.filterMapResolutionResult=filterMapResolutionResult,exports.mergeResolutionResults=mergeResolutionResults;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),utils_1=require("../utils"),NODE_MODULES_PATTERN=`${path_1.default.sep}node_modules${path_1.default.sep}`;function defaultShouldIncludeDependency(e){const t="@"===e[0]?e.slice(1,e.indexOf("/")):null;if("babel"===t||"types"===t||"eslint"===t||"typescript-eslint"===t||"testing-library"===t||"aws-crypto"===t||"aws-sdk"===t)return!1;switch(e){case"@expo/cli":case"@expo/config":case"@expo/metro-config":case"@expo/package-manager":case"@expo/prebuild-config":case"@expo/webpack-config":case"@expo/env":case"@react-native/codegen":case"@react-native/community-cli-plugin":case"eslint":case"eslint-config-expo":case"eslint-plugin-expo":case"eslint-plugin-import":case"jest-expo":case"jest":case"metro":case"ts-node":case"typescript":case"webpack":return!1;default:return!0}}exports.fastJoin="/"===path_1.default.sep?(e,t)=>`${e}${path_1.default.sep}${t}`:(e,t)=>`${e}${path_1.default.sep}${"@"===t[0]?t.replace("/",path_1.default.sep):t}`;const maybeRealpath=async e=>{try{return await fs_1.default.promises.realpath(e)}catch{return null}};function mergeWithDuplicate(e,t){let a,s;if(e.depth<t.depth)a=e,s=t;else if(t.depth<e.depth)a=t,s=e;else{const l=e.originPath.split(NODE_MODULES_PATTERN).length,n=t.originPath.split(NODE_MODULES_PATTERN).length;l<n?(a=e,s=t):n<l?(a=t,s=e):(a=e,s=t)}const l=a.duplicates||(a.duplicates=[]);return a.path!==s.path&&l.push({name:s.name,version:s.version,path:s.path,originPath:s.originPath}),s.duplicates?.length&&l.push(...s.duplicates.filter(e=>l.every(t=>t.path!==e.path))),a}async function filterMapResolutionResult(e,t){const a=await Promise.all(Object.keys(e).map(async a=>{const s=e[a];return s?await t(s):null})),s=Object.create(null);for(let e=0;e<a.length;e++){const t=a[e];null!=t&&(s[t.name]=t)}return s}function mergeResolutionResults(e,t){if(null==t&&1===e.length)return e[0];const a=null==t?Object.create(null):t;for(let t=0;t<e.length;t++)for(const s in e[t]){const l=e[t][s],n=a[s];a[s]=null!=n?mergeWithDuplicate(n,l):l}return a}exports.maybeRealpath=maybeRealpath,exports.loadPackageJson=(0,utils_1.memoize)(async function(e){try{const t=await fs_1.default.promises.readFile(e,"utf8"),a=JSON.parse(t);return"object"!=typeof a||null==a?null:a}catch{return null}});