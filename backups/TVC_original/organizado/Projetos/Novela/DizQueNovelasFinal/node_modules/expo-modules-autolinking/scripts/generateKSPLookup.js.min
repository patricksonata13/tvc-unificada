#!/usr/bin/env node
const fs=require("fs"),minKotlinVersion="2.0.0",maxKotlinVersion="2.2.20",groupId="com.google.devtools.ksp",artifactId="symbol-processing-gradle-plugin",path=require("path").resolve(__dirname,"../android/expo-gradle-plugin/expo-autolinking-plugin/src/main/kotlin/expo/modules/plugin/KSPLookup.kt"),numberPerPage=30,githubReleaseUrl="https://api.github.com/repos/google/ksp/releases";async function*fetchKSPReleases(){const e=`${githubReleaseUrl}?per_page=30`;let o=1;for(;;){const n=`${e}&page=${o}`;console.log(`Fetching versions from: ${n}...`);const t=await fetch(n);if(!t.ok)throw new Error(`HTTP error, status: ${t.status}`);const r=(await t.json()).map(e=>e.tag_name).filter(e=>!/(rc|beta|m1)/i.test(e));yield r,o+=1}}async function filterByKotinVersion(e,o,n){let t=!0;const r=[];for(;t;){const{value:s}=await e.next(),i=s.map(e=>{const[o]=e.split("-");return{kotlinVersion:o,version:e}});t=!i.some(({kotlinVersion:e})=>e<o),r.push(...i.filter(({kotlinVersion:e})=>e>=o&&e<=n))}return r}function groupByKotlinVersion(e){const o={};return e.forEach(({kotlinVersion:e,version:n})=>{(!o[e]||o[e]<n)&&(o[e]=n)}),Object.entries(o).map(([e,o])=>({kotlinVersion:e,version:o}))}async function generateKSPLookup(){const e=fetchKSPReleases(groupId,artifactId,"2.0.0"),o=groupByKotlinVersion(await filterByKotinVersion(e,"2.0.0","2.2.20"));console.log(`Found stable versions for ${groupId}:${artifactId}:`);for(const{kotlinVersion:e,version:n}of o)console.log(` ${e} => ${n}`);console.log("Genereating KSP lookup file...");const n=`// Copyright 2015-present 650 Industries. All rights reserved.\n// Generated using './scripts/generateKSPLookUp.js'\npackage expo.modules.plugin\n\nval KSPLookup = mapOf(\n${o.map(({kotlinVersion:e,version:o})=>`  "${e}" to "${o}"`).join(",\n")}\n)\n`;fs.writeFileSync(path,n,"utf-8")}generateKSPLookup();