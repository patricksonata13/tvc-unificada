"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.verifyCommand=verifyCommand,exports.verifySearchResults=verifySearchResults;const chalk_1=__importDefault(require("chalk")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),autolinkingOptions_1=require("./autolinkingOptions"),dependencies_1=require("../dependencies"),INCLUDE_PACKAGES=["react-native","react-native-tvos"];function verifyCommand(e){return(0,autolinkingOptions_1.registerAutolinkingArguments)(e.command("verify")).option("-v, --verbose","Output all results instead of just warnings.",()=>!0,!1).option("-j, --json","Output results in the plain JSON format.",()=>!0,!1).option("-p, --platform [platform]",'The platform to validate native modules for. Available options: "android", "ios", "both"',"both").action(async e=>{const o="both"===e.platform?["android","ios"]:[e.platform],t=(0,autolinkingOptions_1.createAutolinkingOptionsLoader)(e),n=await t.getAppRoot(),s=(0,dependencies_1.makeCachedDependenciesLinker)({projectRoot:n}),i=(0,dependencies_1.mergeResolutionResults)(await Promise.all(o.map(e=>(0,dependencies_1.scanDependencyResolutionsForPlatform)(s,e,INCLUDE_PACKAGES))));await verifySearchResults(i,{appRoot:n,verbose:!!e.verbose,json:!!e.json})})}async function verifySearchResults(e,o){const{appRoot:t}=o;async function n(e){let o=e.version||null;if(!o)try{const t=await fs_1.default.promises.readFile(path_1.default.join(e.path,"package.json"),"utf8"),n=JSON.parse(t);n&&"object"==typeof n&&"version"in n&&"string"==typeof n.version&&(o=n.version)}catch(e){o=null}const n=path_1.default.relative(t,e.originPath);return o?`${e.name}@${o} (at: ${n})`:`${e.name} at: ${n}`}const s={reactNativeProjectConfig:[],searchPaths:[],dependencies:[],duplicates:[]};for(const o in e){const t=e[o];if(t)if(t.duplicates?.length)s.duplicates.push(t);else switch(t.source){case 2:s.reactNativeProjectConfig.push(t);break;case 1:s.searchPaths.push(t);break;case 0:s.dependencies.push(t)}}if(o.json)console.log(JSON.stringify(s));else{if(o.verbose){const e=e=>[...e].sort((e,o)=>e.name.localeCompare(o.name));if(s.reactNativeProjectConfig.length){console.log(`ğŸ”  Found ${s.reactNativeProjectConfig.length} modules from React Native project config`);for(const o of e(s.reactNativeProjectConfig))console.log(` - ${await n(o)}`)}if(s.searchPaths.length){console.log(`ğŸ”  Found ${s.searchPaths.length} modules in search paths`);for(const o of e(s.searchPaths))console.log(` - ${await n(o)}`)}console.log(`ğŸ”  Found ${s.dependencies.length} modules in dependencies`);for(const o of e(s.dependencies))console.log(` - ${await n(o)}`)}if(s.duplicates.length){for(const e of s.duplicates){console.warn(`âš ï¸  Found duplicate installations for ${chalk_1.default.green(e.name)}`);const o=[e,...e.duplicates??[]];for(let e=0;e<o.length;e++){const t=e!==o.length-1?"â”œâ”€":"â””â”€",s=o[e];console.log(`  ${t} ${await n(s)}`)}}console.warn("âš ï¸  Multiple versions of the same module may introduce some side effects or compatibility issues.\nResolve your dependency issues and deduplicate your dependencies. Learn more: https://expo.fyi/resolving-dependency-issues")}else console.log("âœ… Everything is fine!")}}