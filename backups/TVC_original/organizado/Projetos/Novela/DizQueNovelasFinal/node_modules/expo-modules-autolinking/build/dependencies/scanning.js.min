"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.scanDependenciesInSearchPath=scanDependenciesInSearchPath;const fs_1=__importDefault(require("fs")),utils_1=require("./utils");async function resolveDependency(e,a,n){if(a&&!n(a))return null;const t=a?(0,utils_1.fastJoin)(e,a):e,s=await(0,utils_1.maybeRealpath)(t),i=await(0,utils_1.loadPackageJson)((0,utils_1.fastJoin)(s||t,"package.json"));return i?{source:1,name:i.name,version:i.version||"",path:s||t,originPath:t,duplicates:null,depth:0}:a&&s?{source:1,name:a.toLowerCase(),version:"",path:s,originPath:t,duplicates:null,depth:0}:null}async function scanDependenciesInSearchPath(e,{shouldIncludeDependency:a=utils_1.defaultShouldIncludeDependency}={}){const n=await(0,utils_1.maybeRealpath)(e),t=Object.create(null);if(!n)return t;const s=[];if(await(0,utils_1.maybeRealpath)((0,utils_1.fastJoin)(n,"package.json"))){const e=await resolveDependency(n,null,a);e&&s.push(e)}else{const e=await fs_1.default.promises.readdir(n,{withFileTypes:!0});await Promise.all(e.map(async e=>{if(e.isSymbolicLink()){const t=await resolveDependency(n,e.name,a);t&&s.push(t)}else if(e.isDirectory())if(e.name,"."===e.name[0]);else if("@"===e.name[0]){const t=(0,utils_1.fastJoin)(n,e.name),i=await fs_1.default.promises.readdir(t,{withFileTypes:!0});await Promise.all(i.map(async t=>{const i=`${e.name}/${t.name}`;if(t.isDirectory()||t.isSymbolicLink()){const e=await resolveDependency(n,i,a);e&&s.push(e)}}))}else{const t=await resolveDependency(n,e.name,a);t&&s.push(t)}}))}for(let e=0;e<s.length;e++){const a=s[e],n=t[a.name];null!=n&&a.path!==n.path?(n.duplicates??(n.duplicates=[])).push({name:a.name,version:a.version,path:a.path,originPath:a.originPath}):null==n&&(t[a.name]=a)}return t}