"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getConfiguration=getConfiguration,exports.generatePackageListAsync=generatePackageListAsync,exports.isAndroidProject=isAndroidProject,exports.resolveModuleAsync=resolveModuleAsync,exports.resolveExtraBuildDependenciesAsync=resolveExtraBuildDependenciesAsync,exports.resolveGradlePropertyAsync=resolveGradlePropertyAsync,exports.convertPackageToProjectName=convertPackageToProjectName,exports.convertPackageWithGradleToProjectName=convertPackageWithGradleToProjectName,exports.searchGradlePropertyFirst=searchGradlePropertyFirst;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),utils_1=require("../../utils"),ANDROID_PROPERTIES_FILE="gradle.properties",ANDROID_EXTRA_BUILD_DEPS_KEY="android.extraMavenRepos";function getConfiguration(e){return e.buildFromSource?{buildFromSource:e.buildFromSource}:void 0}async function generatePackageListAsync(e,t,a){const r=await generatePackageListFileContentAsync(e,a),n=path_1.default.dirname(t);fs_1.default.existsSync(n)||await fs_1.default.promises.mkdir(n,{recursive:!0}),await fs_1.default.promises.writeFile(t,r,"utf8")}function isAndroidProject(e){return fs_1.default.existsSync(path_1.default.join(e,"build.gradle"))||fs_1.default.existsSync(path_1.default.join(e,"build.gradle.kts"))}async function resolveModuleAsync(e,t){if("@unimodules/react-native-adapter"===e)return null;const a=(t.config?.androidGradlePlugins()??[]).map(({id:e,group:a,sourceDir:r,applyToRootProject:n})=>({id:e,group:a,sourceDir:path_1.default.join(t.path,r),applyToRootProject:n??!0})),r=convertPackageToProjectName(e),n=t.config?.androidProjects(r)?.filter(e=>!e.isDefault||isAndroidProject(path_1.default.join(t.path,e.path)));if(!n?.length)return a.length?{packageName:e,plugins:a}:null;const o=n.map(e=>{const a=path_1.default.join(t.path,e.path),n=(e.gradleAarProjects??[])?.map(e=>{const n=`${r}$${e.name}`,o=path_1.default.join(a,"build",n);return{name:n,aarFilePath:path_1.default.join(t.path,e.aarFilePath),projectDir:o}}),{publication:o}=e,s=e.shouldUsePublicationScriptPath?path_1.default.join(t.path,e.shouldUsePublicationScriptPath):void 0;return{name:e.name,sourceDir:a,modules:e.modules??[],...s?{shouldUsePublicationScriptPath:s}:{},...o?{publication:o}:{},...n?.length>0?{aarProjects:n}:{}}}),s=t.config?.coreFeatures()??[];return{packageName:e,projects:o,...a?.length>0?{plugins:a}:{},...s.length>0?{coreFeatures:s}:{}}}async function resolveExtraBuildDependenciesAsync(e){const t=await resolveGradlePropertyAsync(e,ANDROID_EXTRA_BUILD_DEPS_KEY);if(t)try{return JSON.parse(t)}catch{}return null}async function resolveGradlePropertyAsync(e,t){const a=path_1.default.join(e,ANDROID_PROPERTIES_FILE);try{const e=searchGradlePropertyFirst(await fs_1.default.promises.readFile(a,"utf8"),t);if(e)return e}catch{}return null}async function generatePackageListFileContentAsync(e,t){const a=await findAndroidPackagesAsync(e.filter(e=>"expo"!==e.packageName)),r=await findAndroidModules(e);return`package ${t};\n\nimport java.util.Arrays;\nimport java.util.List;\nimport expo.modules.core.interfaces.Package;\nimport expo.modules.kotlin.modules.Module;\nimport expo.modules.kotlin.ModulesProvider;\n\npublic class ExpoModulesPackageList implements ModulesProvider {\n  private static class LazyHolder {\n    static final List<Package> packagesList = Arrays.<Package>asList(\n${a.map(e=>`      new ${e}()`).join(",\n")}\n    );\n\n    static final List<Class<? extends Module>> modulesList = Arrays.<Class<? extends Module>>asList(\n      ${r.map(e=>`      ${e}.class`).join(",\n")}\n    );\n  }\n\n  public static List<Package> getPackageList() {\n    return LazyHolder.packagesList;\n  }\n\n  @Override\n  public List<Class<? extends Module>> getModulesList() {\n    return LazyHolder.modulesList;\n  }\n}\n`}function findAndroidModules(e){const t=e.flatMap(e=>e.projects??[]).filter(e=>e.modules?.length>0);return[].concat(...t.map(e=>e.modules))}async function findAndroidPackagesAsync(e){const t=[],a=[];for(const t of e)for(const e of t.projects??[])a.push(e.sourceDir);return await Promise.all(a.map(async e=>{for await(const a of(0,utils_1.scanFilesRecursively)(e)){if(!a.name.endsWith("Package.java")&&!a.name.endsWith("Package.kt"))continue;const e=await fs_1.default.promises.readFile(a.path,"utf8");if(!(()=>process.env.EXPO_SHOULD_USE_LEGACY_PACKAGE_INTERFACE?/\bimport\s+org\.unimodules\.core\.(interfaces\.Package|BasePackage)\b/:/\bimport\s+expo\.modules\.core\.(interfaces\.Package|BasePackage)\b/)().test(e))continue;const r=e.match(/^package ([\w.]+)\b/m);if(r){const e=path_1.default.basename(a.name,path_1.default.extname(a.name));t.push(`${r[1]}.${e}`)}}})),t.sort()}function convertPackageToProjectName(e){return e.replace(/^@/g,"").replace(/\W+/g,"-")}function convertPackageWithGradleToProjectName(e,t){const a=convertPackageToProjectName(e),r=path_1.default.dirname(t).replace(/\//g,"-");return"android"===r?a:`${a}$${r}`}function searchGradlePropertyFirst(e,t){const a=e.split("\n");for(let e=0;e<a.length;e++){const r=a[e].trim();if(r&&!r.startsWith("#")){const e=r.indexOf("=");if(r.slice(0,e)===t){return r.slice(e+1,r.length)}}}return null}