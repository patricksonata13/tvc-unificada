"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeCachedDependenciesLinker=makeCachedDependenciesLinker,exports.scanDependencyResolutionsForPlatform=scanDependencyResolutionsForPlatform,exports.scanExpoModuleResolutionsForPlatform=scanExpoModuleResolutionsForPlatform;const fs_1=__importDefault(require("fs")),resolution_1=require("./resolution"),rncliLocal_1=require("./rncliLocal"),scanning_1=require("./scanning"),utils_1=require("./utils"),findModules_1=require("../autolinking/findModules"),autolinkingOptions_1=require("../commands/autolinkingOptions"),reactNativeConfig_1=require("../reactNativeConfig"),config_1=require("../reactNativeConfig/config");function makeCachedDependenciesLinker(e){const n=(0,autolinkingOptions_1.createAutolinkingOptionsLoader)({projectRoot:e.projectRoot});let t;const a=()=>t||(t=n.getAppRoot()),i=new Map;let o,s,r;return{async getOptionsForPlatform(e){const t=await n.getPlatformOptions(e);return makeCachedDependenciesSearchOptions(t)},loadReactNativeProjectConfig:async()=>(void 0===o&&(o=(0,config_1.loadConfigAsync)(await a())),o),async scanDependenciesFromRNProjectConfig(){const e=await this.loadReactNativeProjectConfig();return s||(s=(0,rncliLocal_1.scanDependenciesFromRNProjectConfig)(await a(),e))},scanDependenciesRecursively:async()=>r||(r=(0,resolution_1.scanDependenciesRecursively)(await a())),async scanDependenciesInSearchPath(e){let n=i.get(e);return n||i.set(e,n=(0,scanning_1.scanDependenciesInSearchPath)(e)),n}}}async function scanDependencyResolutionsForPlatform(e,n,t){const{excludeNames:a,searchPaths:i}=await e.getOptionsForPlatform(n),o=new Set(t),s=await e.loadReactNativeProjectConfig(),r=(0,utils_1.mergeResolutionResults)(await Promise.all([e.scanDependenciesFromRNProjectConfig(),...i.map(n=>e.scanDependenciesInSearchPath(n)),e.scanDependenciesRecursively()]));return await(0,utils_1.filterMapResolutionResult)(r,async e=>{if(a.has(e.name))return null;if(o.has(e.name))return e;if(2===e.source){if(!await(0,reactNativeConfig_1.resolveReactNativeModule)(e,s,n,a))return null}else{const[t,i]=await Promise.all([(0,reactNativeConfig_1.resolveReactNativeModule)(e,s,n,a),(0,findModules_1.resolveExpoModule)(e,n,a)]);if(!t&&!i)return null}return e})}async function scanExpoModuleResolutionsForPlatform(e,n){const{excludeNames:t,searchPaths:a}=await e.getOptionsForPlatform(n),i=(0,utils_1.mergeResolutionResults)(await Promise.all([...a.map(n=>e.scanDependenciesInSearchPath(n)),e.scanDependenciesRecursively()].filter(e=>null!=e)));return await(0,utils_1.filterMapResolutionResult)(i,async e=>t.has(e.name)?null:await(0,findModules_1.resolveExpoModule)(e,n,t))}const makeCachedDependenciesSearchOptions=e=>({excludeNames:new Set(e.exclude),searchPaths:e.nativeModulesDir&&fs_1.default.existsSync(e.nativeModulesDir)?[e.nativeModulesDir,...e.searchPaths??[]]:e.searchPaths??[]});