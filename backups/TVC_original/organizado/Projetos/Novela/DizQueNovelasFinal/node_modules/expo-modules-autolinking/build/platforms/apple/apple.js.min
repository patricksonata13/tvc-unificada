"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSwiftModuleNames=getSwiftModuleNames,exports.resolveModuleAsync=resolveModuleAsync,exports.resolveExtraBuildDependenciesAsync=resolveExtraBuildDependenciesAsync,exports.generateModulesProviderAsync=generateModulesProviderAsync,exports.formatArrayOfReactDelegateHandler=formatArrayOfReactDelegateHandler;const spawn_async_1=__importDefault(require("@expo/spawn-async")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),utils_1=require("../../utils"),APPLE_PROPERTIES_FILE="Podfile.properties.json",APPLE_EXTRA_BUILD_DEPS_KEY="apple.extraPods",indent="  ";async function findPodspecFiles(e){const t=e.config?.applePodspecPaths();return t&&t.length?t:await(0,utils_1.listFilesInDirectories)(e.path,e=>e.endsWith(".podspec"))}function getSwiftModuleNames(e,t){return t&&t.length?t:e.map(e=>e.podName.replace(/[^a-zA-Z0-9]/g,"_"))}async function resolveModuleAsync(e,t,n){const a=await findPodspecFiles(t);if(!a.length)return null;const r=a.map(e=>({podName:path_1.default.basename(e,path_1.default.extname(e)),podspecDir:path_1.default.dirname(path_1.default.join(t.path,e))})),s=getSwiftModuleNames(r,t.config?.appleSwiftModuleNames()),o=t.config?.coreFeatures()??[];return{packageName:e,pods:r,swiftModuleNames:s,flags:n.flags,modules:t.config?.appleModules()??[],appDelegateSubscribers:t.config?.appleAppDelegateSubscribers()??[],reactDelegateHandlers:t.config?.appleReactDelegateHandlers()??[],debugOnly:t.config?.appleDebugOnly()??!1,...o.length>0?{coreFeatures:o}:{}}}async function resolveExtraBuildDependenciesAsync(e){const t=path_1.default.join(e,APPLE_PROPERTIES_FILE);try{const e=await fs_1.default.promises.readFile(t,"utf8"),n=JSON.parse(e);if(n[APPLE_EXTRA_BUILD_DEPS_KEY]){return JSON.parse(n[APPLE_EXTRA_BUILD_DEPS_KEY])}}catch{}return null}async function generateModulesProviderAsync(e,t,n){const a=path_1.default.basename(t,path_1.default.extname(t)),r=await parseEntitlementsAsync(n),s=await generatePackageListFileContentAsync(e,a,r),o=path_1.default.dirname(t);await fs_1.default.promises.mkdir(o,{recursive:!0}),await fs_1.default.promises.writeFile(t,s,"utf8")}async function generatePackageListFileContentAsync(e,t,n){const a=e.filter(e=>e.modules.length||e.appDelegateSubscribers.length||e.reactDelegateHandlers.length),r=a.filter(e=>!e.debugOnly),s=a.filter(e=>e.debugOnly),o=[].concat(...r.map(e=>e.swiftModuleNames)).filter(Boolean),l=[].concat(...s.map(e=>e.swiftModuleNames)).filter(Boolean),i=[].concat(...r.map(e=>e.modules)).filter(Boolean),p=[].concat(...s.map(e=>e.modules)).filter(Boolean),u=[].concat(...r.map(e=>e.appDelegateSubscribers)),c=[].concat(...s.map(e=>e.appDelegateSubscribers)),d=r.filter(e=>!!e.reactDelegateHandlers.length),f=s.filter(e=>!!e.reactDelegateHandlers.length);return`/**\n * Automatically generated by expo-modules-autolinking.\n *\n * This autogenerated class provides a list of classes of native Expo modules,\n * but only these that are written in Swift and use the new API for creating Expo modules.\n */\n\nimport ExpoModulesCore\n${generateCommonImportList(o)}\n${generateDebugOnlyImportList(l)}\n@objc(${t})\npublic class ${t}: ModulesProvider {\n  public override func getModuleClasses() -> [AnyModule.Type] {\n${generateModuleClasses(i,p)}\n  }\n\n  public override func getAppDelegateSubscribers() -> [ExpoAppDelegateSubscriber.Type] {\n${generateModuleClasses(u,c)}\n  }\n\n  public override func getReactDelegateHandlers() -> [ExpoReactDelegateHandlerTupleType] {\n${generateReactDelegateHandlers(d,f)}\n  }\n\n  public override func getAppCodeSignEntitlements() -> AppCodeSignEntitlements {\n    return AppCodeSignEntitlements.from(json: #"${JSON.stringify(n)}"#)\n  }\n}\n`}function generateCommonImportList(e){return e.map(e=>`import ${e}`).join("\n")}function generateDebugOnlyImportList(e){return e.length?wrapInDebugConfigurationCheck(0,e.map(e=>`import ${e}`).join("\n"))+"\n":""}function generateModuleClasses(e,t){const n=formatArrayOfClassNames(e);return t.length>0?wrapInDebugConfigurationCheck(2,`return ${formatArrayOfClassNames(e.concat(t))}`,`return ${n}`):`${indent.repeat(2)}return ${n}`}function formatArrayOfClassNames(e){return`[${e.map(e=>`\n${indent.repeat(3)}${e}.self`).join(",")}\n${indent.repeat(2)}]`}function generateReactDelegateHandlers(e,t){const n=formatArrayOfReactDelegateHandler(e);return t.length>0?wrapInDebugConfigurationCheck(2,`return ${formatArrayOfReactDelegateHandler(e.concat(t))}`,`return ${n}`):`${indent.repeat(2)}return ${n}`}function formatArrayOfReactDelegateHandler(e){const t=[];for(const n of e)for(const e of n.reactDelegateHandlers)t.push(`(packageName: "${n.packageName}", handler: ${e}.self)`);return`[${t.map(e=>`\n${indent.repeat(3)}${e}`).join(",")}\n${indent.repeat(2)}]`}function wrapInDebugConfigurationCheck(e,t,n=null){return n?`${indent.repeat(e)}#if EXPO_CONFIGURATION_DEBUG\n${indent.repeat(e)}${t}\n${indent.repeat(e)}#else\n${indent.repeat(e)}${n}\n${indent.repeat(e)}#endif`:`${indent.repeat(e)}#if EXPO_CONFIGURATION_DEBUG\n${indent.repeat(e)}${t}\n${indent.repeat(e)}#endif`}async function parseEntitlementsAsync(e){if(!e||!await(0,utils_1.fileExistsAsync)(e))return{};const{stdout:t}=await(0,spawn_async_1.default)("plutil",["-convert","json","-o","-",e]);return{appGroups:JSON.parse(t)["com.apple.security.application-groups"]||void 0}}