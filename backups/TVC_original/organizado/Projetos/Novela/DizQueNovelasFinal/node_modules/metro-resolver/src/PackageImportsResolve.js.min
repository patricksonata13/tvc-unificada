"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolvePackageTargetFromImports=resolvePackageTargetFromImports;var _InvalidPackageConfigurationError=_interopRequireDefault(require("./errors/InvalidPackageConfigurationError")),_PackageImportNotResolvedError=_interopRequireDefault(require("./errors/PackageImportNotResolvedError")),_resolveAsset=_interopRequireDefault(require("./resolveAsset")),_isAssetFile=_interopRequireDefault(require("./utils/isAssetFile")),_isSubpathDefinedInExportsLike=require("./utils/isSubpathDefinedInExportsLike"),_matchSubpathFromExportsLike=require("./utils/matchSubpathFromExportsLike"),_path=_interopRequireDefault(require("path"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function resolvePackageTargetFromImports(e,t,r,o,i){const s=e=>new _InvalidPackageConfigurationError.default({reason:e,packagePath:t}),a=Object.keys(o),n=a.filter(e=>!e.startsWith("#"));if(0===a.length)throw s('The "imports" field cannot be empty');if(0!==n.length)throw s('The "imports" field cannot have keys which do not start with #');const l=new Map(Object.entries(o));if(!(0,_isSubpathDefinedInExportsLike.isSubpathDefinedInExportsLike)(l,r))throw new _PackageImportNotResolvedError.default({importSpecifier:r,reason:`"${r}" could not be matched using "imports" of ${t}`});const{target:u,patternMatch:p}=(0,_matchSubpathFromExportsLike.matchSubpathFromExportsLike)(e,r,l,i,s);if(null==u)throw new _PackageImportNotResolvedError.default({importSpecifier:r,reason:`"${r}" which matches a subpath "imports" in ${t}however no match was resolved for this request (platform = ${i??"null"}).`});const h=_path.default.join(t,null!=p?u.replaceAll("*",p):u);if((0,_isAssetFile.default)(h,e.assetExts)){const t=(0,_resolveAsset.default)(e,h);if(null!=t)return t}const f=e.fileSystemLookup(h);if(f.exists&&"f"===f.type)return{type:"sourceFile",filePath:f.realPath};throw s(`The resolved path for "${r}" defined in "imports" is ${h}, however this file does not exist.`)}