"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=resolve;var _FailedToResolveNameError=_interopRequireDefault(require("./errors/FailedToResolveNameError")),_FailedToResolvePathError=_interopRequireDefault(require("./errors/FailedToResolvePathError")),_formatFileCandidates=_interopRequireDefault(require("./errors/formatFileCandidates")),_InvalidPackageConfigurationError=_interopRequireDefault(require("./errors/InvalidPackageConfigurationError")),_InvalidPackageError=_interopRequireDefault(require("./errors/InvalidPackageError")),_PackageImportNotResolvedError=_interopRequireDefault(require("./errors/PackageImportNotResolvedError")),_PackagePathNotExportedError=_interopRequireDefault(require("./errors/PackagePathNotExportedError")),_PackageExportsResolve=require("./PackageExportsResolve"),_PackageImportsResolve=require("./PackageImportsResolve"),_PackageResolve=require("./PackageResolve"),_resolveAsset=_interopRequireDefault(require("./resolveAsset")),_isAssetFile=_interopRequireDefault(require("./utils/isAssetFile")),_path=_interopRequireDefault(require("path"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function resolve(e,t,a){const r=e.resolveRequest;if(r&&r!==resolve)return r(Object.freeze({...e,resolveRequest:resolve}),t,a);if(isRelativeImport(t)||_path.default.isAbsolute(t)){const r=resolveModulePath(e,t,a);if("failed"===r.type)throw new _FailedToResolvePathError.default(r.candidates);return r.resolution}if(isSubpathImport(t)){const r=e.getPackageForModule(e.originModulePath),o=r?.packageJson.imports;if(null==r)throw new _PackageImportNotResolvedError.default({importSpecifier:t,reason:`Could not find a package.json file relative to module ${e.originModulePath}`});if(null==o)throw new _PackageImportNotResolvedError.default({importSpecifier:t,reason:`Missing field "imports" in package.json. Check package.json at: ${r.rootPath}`});try{const i=(0,_PackageImportsResolve.resolvePackageTargetFromImports)(e,r.rootPath,t,o,a);if(null!=i)return i}catch(t){if(t instanceof _PackageImportNotResolvedError.default)e.unstable_logWarning(t.message+' Falling back to file-based resolution. Consider updating the call site or checking there is a matching subpath inside "imports" of package.json.');else{if(!(t instanceof _InvalidPackageConfigurationError.default))throw t;e.unstable_logWarning(t.message+" Falling back to file-based resolution.")}}}const o=(0,_PackageResolve.redirectModulePath)(e,t);if(!1===o)return{type:"empty"};const{originModulePath:i}=e;if(isRelativeImport(o)||_path.default.isAbsolute(o)){const t=i.lastIndexOf("node_modules"+_path.default.sep)+13,r=i.slice(0,i.indexOf(_path.default.sep,t)),l=_path.default.join(r,o),s=resolveModulePath(e,l,a);if("failed"===s.type)throw new _FailedToResolvePathError.default(s.candidates);return s.resolution}const l=parseBareSpecifier(o);if(e.allowHaste){if(l.isSinglePart){const t=e.resolveHasteModule(l.firstPart);if(null!=t)return{type:"sourceFile",filePath:t}}if(l.isValidPackageName){const t=resolveHastePackage(e,l,a);if("resolved"===t.type)return t.resolution}}const{disableHierarchicalLookup:s}=e,n=[];let u=_path.default.dirname(i);if(!s){let e;do{e=u;const t=e.endsWith(_path.default.sep)?e+"node_modules":e+_path.default.sep+"node_modules";n.push(t),u=_path.default.dirname(e)}while(e!==u)}n.push(...e.nodeModulesPaths);const d=[],{extraNodeModules:c}=e;if(c&&c[l.packageName]){const e=c[l.packageName];d.push(_path.default.join(e,l.posixSubpath))}const f=n.map(t=>{let a=null;const r="."!==l.posixSubpath||l.packageName.length>l.firstPart.length?t+_path.default.sep+l.firstPart:t;return a=e.fileSystemLookup(r),a.exists&&"d"===a.type?_path.default.join(t,o):null}).filter(Boolean).concat(d);for(let t=0;t<f.length;++t){const r=(0,_PackageResolve.redirectModulePath)(e,f[t]);if(!1===r)return{type:"empty"};const o=resolvePackage(e,r,a);if("resolved"===o.type)return o.resolution}throw new _FailedToResolveNameError.default(n,d)}function parseBareSpecifier(e){const t="/"===_path.default.sep?e:e.replaceAll("\\","/"),a=t.indexOf("/");if(t.startsWith("@")&&-1!==a){const e=t.indexOf("/",a+1);return-1===e?{isSinglePart:!1,isValidPackageName:!0,firstPart:t.slice(0,a),normalizedSpecifier:t,packageName:t,posixSubpath:"."}:{isSinglePart:!1,isValidPackageName:!0,firstPart:t.slice(0,a),normalizedSpecifier:t,packageName:t.slice(0,e),posixSubpath:"."+t.slice(e)}}if(-1===a)return{isSinglePart:!0,isValidPackageName:!t.startsWith("@"),firstPart:t,normalizedSpecifier:t,packageName:t,posixSubpath:"."};const r=t.slice(0,a);return{isSinglePart:!1,isValidPackageName:!0,firstPart:r,normalizedSpecifier:t,packageName:r,posixSubpath:"."+t.slice(a)}}function resolveModulePath(e,t,a){const r=_path.default.isAbsolute(t)?"/"===_path.default.sep?t:t.replaceAll("/","\\"):_path.default.join(_path.default.dirname(e.originModulePath),t),o=(0,_PackageResolve.redirectModulePath)(e,r);if(!1===o)return resolvedAs({type:"empty"});const i=_path.default.dirname(o),l=_path.default.basename(o),s=o.endsWith(_path.default.sep)?null:resolveFile(e,i,l,a);if(null!=s&&"resolved"===s.type)return s;const n=resolvePackageEntryPoint(e,o,a);return"resolved"===n.type?n:failedFor({file:s?.candidates??null,dir:n.candidates})}function resolveHastePackage(e,{normalizedSpecifier:t,packageName:a,posixSubpath:r},o){const i=e.resolveHastePackage(a);if(null==i)return failedFor();const l=resolvePackage(e,_path.default.join(i,"..",r),o);if("resolved"===l.type)return l;const{candidates:s}=l;throw new MissingFileInHastePackageError({moduleName:t,packageName:a,pathInModule:r,candidates:s})}class MissingFileInHastePackageError extends Error{constructor(e){super(`While resolving module \`${e.moduleName}\`, the Haste package \`${e.packageName}\` was found. However the subpath \`${e.pathInModule}\` could not be found within the package. Indeed, none of these files exist:\n\n`+[e.candidates.file,e.candidates.dir].filter(Boolean).map(e=>`  * \`${(0,_formatFileCandidates.default)(e)}\``).join("\n")),Object.assign(this,e)}}function resolvePackage(e,t,a){if(e.unstable_enablePackageExports){const r=e.getPackageForModule(t),o=r?.packageJson.exports;if(null!=r&&null!=o)try{const i=(0,_PackageExportsResolve.resolvePackageTargetFromExports)(e,r.rootPath,t,r.packageRelativePath,o,a);if(null!=i)return resolvedAs(i)}catch(t){if(t instanceof _PackagePathNotExportedError.default)e.unstable_logWarning(t.message+" Falling back to file-based resolution. Consider updating the call site or asking the package maintainer(s) to expose this API.");else{if(!(t instanceof _InvalidPackageConfigurationError.default))throw t;e.unstable_logWarning(t.message+" Falling back to file-based resolution.")}}}return resolveModulePath(e,t,a)}function resolvePackageEntryPoint(e,t,a){const r=e.fileSystemLookup(t);if(0==r.exists||"d"!==r.type)return failedFor({type:"sourceFile",filePathPrefix:t,candidateExts:[]});const o=_path.default.join(t,"package.json");if(!e.doesFileExist(o))return resolveFile(e,t,"index",a);const i={rootPath:_path.default.dirname(o),packageJson:e.getPackage(o)??{}},l=_path.default.join(i.rootPath,(0,_PackageResolve.getPackageEntryPoint)(e,i,a)),s=resolveFile(e,_path.default.dirname(l),_path.default.basename(l),a);if("resolved"===s.type)return s;const n=resolveFile(e,l,"index",a);if("resolved"!==n.type)throw new _InvalidPackageError.default({packageJsonPath:o,mainModulePath:l,fileCandidates:s.candidates,indexCandidates:n.candidates});return n}function resolveFile(e,t,a,r){if((0,_isAssetFile.default)(a,e.assetExts)){const r=(0,_resolveAsset.default)(e,_path.default.join(t,a));return null==r?failedFor({type:"asset",name:a}):resolvedAs(r)}const o=[],i=_path.default.join(t,a),l=resolveSourceFile({...e,candidateExts:o,filePathPrefix:i},r);return null!=l?resolvedAs("string"==typeof l?{type:"sourceFile",filePath:l}:l):failedFor({type:"sourceFile",filePathPrefix:i,candidateExts:o})}function resolveSourceFile(e,t){let a=resolveSourceFileForAllExts(e,"");if(a)return a;const{sourceExts:r}=e;for(let o=0;o<r.length;o++){if(a=resolveSourceFileForAllExts(e,`.${r[o]}`,t),null!=a)return a}return null}function resolveSourceFileForAllExts(e,t,a){if(null!=a){const r=resolveSourceFileForExt(e,`.${a}${t}`);if(r)return r}if(e.preferNativePlatform&&""!==t){const a=resolveSourceFileForExt(e,`.native${t}`);if(a)return a}return resolveSourceFileForExt(e,t)}function resolveSourceFileForExt(e,t){const a=`${e.filePathPrefix}${t}`,r=""!==t?(0,_PackageResolve.redirectModulePath)(e,a):a;if(!1===r)return{type:"empty"};const o=e.fileSystemLookup(r);return o.exists&&"f"===o.type?o.realPath:(e.candidateExts.push(t),null)}function isRelativeImport(e){return/^[.][.]?(?:[/]|$)/.test(e)}function isSubpathImport(e){return e.startsWith("#")}function resolvedAs(e){return{type:"resolved",resolution:e}}function failedFor(e){return{type:"failed",candidates:e}}