import{STATE_POSSIBLE,STATE_ENDED,STATE_FAILED,STATE_RECOGNIZED,STATE_CANCELLED,STATE_BEGAN,STATE_CHANGED}from"./recognizer-consts";import assign from"../utils/assign";import uniqueId from"../utils/unique-id";import invokeArrayArg from"../utils/invoke-array-arg";import inArray from"../utils/in-array";import boolOrFn from"../utils/bool-or-fn";import getRecognizerByNameIfManager from"./get-recognizer-by-name-if-manager";import stateStr from"./state-str";export default class Recognizer{constructor(t={}){this.options={enable:!0,...t},this.id=uniqueId(),this.manager=null,this.state=STATE_POSSIBLE,this.simultaneous={},this.requireFail=[]}set(t){return assign(this.options,t),this.manager&&this.manager.touchAction.update(),this}recognizeWith(t){if(invokeArrayArg(t,"recognizeWith",this))return this;let{simultaneous:i}=this;return i[(t=getRecognizerByNameIfManager(t,this)).id]||(i[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(t){return invokeArrayArg(t,"dropRecognizeWith",this)||(t=getRecognizerByNameIfManager(t,this),delete this.simultaneous[t.id]),this}requireFailure(t){if(invokeArrayArg(t,"requireFailure",this))return this;let{requireFail:i}=this;return t=getRecognizerByNameIfManager(t,this),-1===inArray(i,t)&&(i.push(t),t.requireFailure(this)),this}dropRequireFailure(t){if(invokeArrayArg(t,"dropRequireFailure",this))return this;t=getRecognizerByNameIfManager(t,this);let i=inArray(this.requireFail,t);return i>-1&&this.requireFail.splice(i,1),this}hasRequireFailures(){return this.requireFail.length>0}canRecognizeWith(t){return!!this.simultaneous[t.id]}emit(t){let i=this,{state:e}=this;function r(e){i.manager.emit(e,t)}e<STATE_ENDED&&r(i.options.event+stateStr(e)),r(i.options.event),t.additionalEvent&&r(t.additionalEvent),e>=STATE_ENDED&&r(i.options.event+stateStr(e))}tryEmit(t){if(this.canEmit())return this.emit(t);this.state=STATE_FAILED}canEmit(){let t=0;for(;t<this.requireFail.length;){if(!(this.requireFail[t].state&(STATE_FAILED|STATE_POSSIBLE)))return!1;t++}return!0}recognize(t){let i=assign({},t);if(!boolOrFn(this.options.enable,[this,i]))return this.reset(),void(this.state=STATE_FAILED);this.state&(STATE_RECOGNIZED|STATE_CANCELLED|STATE_FAILED)&&(this.state=STATE_POSSIBLE),this.state=this.process(i),this.state&(STATE_BEGAN|STATE_CHANGED|STATE_ENDED|STATE_CANCELLED)&&this.tryEmit(i)}process(t){}getTouchAction(){}reset(){}}