import assign from"./utils/assign";import TouchAction from"./touchactionjs/touchaction-constructor";import createInputInstance from"./inputjs/create-input-instance";import each from"./utils/each";import inArray from"./utils/in-array";import invokeArrayArg from"./utils/invoke-array-arg";import splitStr from"./utils/split-str";import prefixed from"./utils/prefixed";import Recognizer from"./recognizerjs/recognizer-constructor";import{STATE_BEGAN,STATE_ENDED,STATE_CHANGED,STATE_RECOGNIZED}from"./recognizerjs/recognizer-consts";import defaults from"./defaults";const STOP=1,FORCED_STOP=2;function toggleCssProps(t,e){const{element:s}=t;if(!s.style)return;let i;each(t.options.cssProps,(r,n)=>{i=prefixed(s.style,n),e?(t.oldCssProps[i]=s.style[i],s.style[i]=r):s.style[i]=t.oldCssProps[i]||""}),e||(t.oldCssProps={})}function triggerDomEvent(t,e){const s=document.createEvent("Event");s.initEvent(t,!0,!0),s.gesture=e,e.target.dispatchEvent(s)}export default class Manager{constructor(t,e){this.options=assign({},defaults,e||{}),this.options.inputTarget=this.options.inputTarget||t,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=createInputInstance(this),this.touchAction=new TouchAction(this,this.options.touchAction),toggleCssProps(this,!0),each(this.options.recognizers,t=>{const e=this.add(new t[0](t[1]));t[2]&&e.recognizeWith(t[2]),t[3]&&e.requireFailure(t[3])},this)}set(t){return assign(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this}stop(t){this.session.stopped=t?2:1}recognize(t){const{session:e}=this;if(e.stopped)return;let s;this.touchAction.preventDefaults(t);const{recognizers:i}=this;let{curRecognizer:r}=e;(!r||r&&r.state&STATE_RECOGNIZED)&&(e.curRecognizer=null,r=null);let n=0;for(;n<i.length;)s=i[n],2===e.stopped||r&&s!==r&&!s.canRecognizeWith(r)?s.reset():s.recognize(t),!r&&s.state&(STATE_BEGAN|STATE_CHANGED|STATE_ENDED)&&(e.curRecognizer=s,r=s),n++}get(t){if(t instanceof Recognizer)return t;const{recognizers:e}=this;for(let s=0;s<e.length;s++)if(e[s].options.event===t)return e[s];return null}add(t){if(invokeArrayArg(t,"add",this))return this;const e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t}remove(t){if(invokeArrayArg(t,"remove",this))return this;const e=this.get(t);if(t){const{recognizers:t}=this,s=inArray(t,e);-1!==s&&(t.splice(s,1),this.touchAction.update())}return this}on(t,e){if(void 0===t||void 0===e)return this;const{handlers:s}=this;return each(splitStr(t),t=>{s[t]=s[t]||[],s[t].push(e)}),this}off(t,e){if(void 0===t)return this;const{handlers:s}=this;return each(splitStr(t),t=>{e?s[t]&&s[t].splice(inArray(s[t],e),1):delete s[t]}),this}emit(t,e){this.options.domEvents&&triggerDomEvent(t,e);const s=this.handlers[t]&&this.handlers[t].slice();if(!s||!s.length)return;e.type=t,e.preventDefault=function(){e.srcEvent.preventDefault()};let i=0;for(;i<s.length;)s[i](e),i++}destroy(){this.element&&toggleCssProps(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}}