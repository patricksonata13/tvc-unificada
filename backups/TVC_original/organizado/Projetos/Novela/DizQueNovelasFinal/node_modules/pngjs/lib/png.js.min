"use strict";var util=require("util"),Stream=require("stream"),Parser=require("./parser-async"),Packer=require("./packer-async"),PNGSync=require("./png-sync"),PNG=exports.PNG=function(t){Stream.call(this),t=t||{},this.width=0|t.width,this.height=0|t.height,this.data=this.width>0&&this.height>0?new Buffer(4*this.width*this.height):null,t.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new Parser(t),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(t){this.data=t,this.emit("parsed",t)}.bind(this)),this._packer=new Packer(t),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};util.inherits(PNG,Stream),PNG.sync=PNGSync,PNG.prototype.pack=function(){return this.data&&this.data.length?(process.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this):(this.emit("error","No data provided"),this)},PNG.prototype.parse=function(t,i){var e,r;i&&(e=function(t){this.removeListener("error",r),this.data=t,i(null,this)}.bind(this),r=function(t){this.removeListener("parsed",e),i(t,null)}.bind(this),this.once("parsed",e),this.once("error",r));return this.end(t),this},PNG.prototype.write=function(t){return this._parser.write(t),!0},PNG.prototype.end=function(t){this._parser.end(t)},PNG.prototype._metadata=function(t){this.width=t.width,this.height=t.height,this.emit("metadata",t)},PNG.prototype._gamma=function(t){this.gamma=t},PNG.prototype._handleClose=function(){this._parser.writable||this._packer.readable||this.emit("close")},PNG.bitblt=function(t,i,e,r,a,h,s,n){if(r|=0,a|=0,h|=0,s|=0,n|=0,(e|=0)>t.width||r>t.height||e+a>t.width||r+h>t.height)throw new Error("bitblt reading outside image");if(s>i.width||n>i.height||s+a>i.width||n+h>i.height)throw new Error("bitblt writing outside image");for(var o=0;o<h;o++)t.data.copy(i.data,(n+o)*i.width+s<<2,(r+o)*t.width+e<<2,(r+o)*t.width+e+a<<2)},PNG.prototype.bitblt=function(t,i,e,r,a,h,s){return PNG.bitblt(this,t,i,e,r,a,h,s),this},PNG.adjustGamma=function(t){if(t.gamma){for(var i=0;i<t.height;i++)for(var e=0;e<t.width;e++)for(var r=t.width*i+e<<2,a=0;a<3;a++){var h=t.data[r+a]/255;h=Math.pow(h,1/2.2/t.gamma),t.data[r+a]=Math.round(255*h)}t.gamma=0}},PNG.prototype.adjustGamma=function(){PNG.adjustGamma(this)};