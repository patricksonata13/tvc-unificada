"use strict";var interlaceUtils=require("./interlace"),pixelBppMapper=[function(){},function(t,e,r,n){if(n===e.length)throw new Error("Ran out of data");var a=e[n];t[r]=a,t[r+1]=a,t[r+2]=a,t[r+3]=255},function(t,e,r,n){if(n+1>=e.length)throw new Error("Ran out of data");var a=e[n];t[r]=a,t[r+1]=a,t[r+2]=a,t[r+3]=e[n+1]},function(t,e,r,n){if(n+2>=e.length)throw new Error("Ran out of data");t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=255},function(t,e,r,n){if(n+3>=e.length)throw new Error("Ran out of data");t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=e[n+3]}],pixelBppCustomMapper=[function(){},function(t,e,r,n){var a=e[0];t[r]=a,t[r+1]=a,t[r+2]=a,t[r+3]=n},function(t,e,r){var n=e[0];t[r]=n,t[r+1]=n,t[r+2]=n,t[r+3]=e[1]},function(t,e,r,n){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=n},function(t,e,r){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3]}];function bitRetriever(t,e){var r=[],n=0;function a(){if(n===t.length)throw new Error("Ran out of data");var a,i,o,f,u,h,p,c,s=t[n];switch(n++,e){default:throw new Error("unrecognised depth");case 16:p=t[n],n++,r.push((s<<8)+p);break;case 4:p=15&s,c=s>>4,r.push(c,p);break;case 2:u=3&s,h=s>>2&3,p=s>>4&3,c=s>>6&3,r.push(c,p,h,u);break;case 1:a=1&s,i=s>>1&1,o=s>>2&1,f=s>>3&1,u=s>>4&1,h=s>>5&1,p=s>>6&1,c=s>>7&1,r.push(c,p,h,u,f,o,i,a)}}return{get:function(t){for(;r.length<t;)a();var e=r.slice(0,t);return r=r.slice(t),e},resetAfterLine:function(){r.length=0},end:function(){if(n!==t.length)throw new Error("extra data found")}}}function mapImage8Bit(t,e,r,n,a,i){for(var o=t.width,f=t.height,u=t.index,h=0;h<f;h++)for(var p=0;p<o;p++){var c=r(p,h,u);pixelBppMapper[n](e,a,c,i),i+=n}return i}function mapImageCustomBit(t,e,r,n,a,i){for(var o=t.width,f=t.height,u=t.index,h=0;h<f;h++){for(var p=0;p<o;p++){var c=a.get(n),s=r(p,h,u);pixelBppCustomMapper[n](e,c,s,i)}a.resetAfterLine()}}exports.dataToBitMap=function(t,e){var r,n=e.width,a=e.height,i=e.depth,o=e.bpp,f=e.interlace;if(8!==i)var u=bitRetriever(t,i);r=i<=8?new Buffer(n*a*4):new Uint16Array(n*a*4);var h,p,c=Math.pow(2,i)-1,s=0;if(f)h=interlaceUtils.getImagePasses(n,a),p=interlaceUtils.getInterlaceIterator(n,a);else{var l=0;p=function(){var t=l;return l+=4,t},h=[{width:n,height:a}]}for(var g=0;g<h.length;g++)8===i?s=mapImage8Bit(h[g],r,p,o,t,s):mapImageCustomBit(h[g],r,p,o,u,c);if(8===i){if(s!==t.length)throw new Error("extra data found")}else u.end();return r};