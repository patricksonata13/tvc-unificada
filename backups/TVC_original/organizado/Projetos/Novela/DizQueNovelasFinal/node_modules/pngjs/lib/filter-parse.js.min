"use strict";var interlaceUtils=require("./interlace"),paethPredictor=require("./paeth-predictor");function getByteWidth(e,t,i){var r=e*t;return 8!==i&&(r=Math.ceil(r/(8/i))),r}var Filter=module.exports=function(e,t){var i=e.width,r=e.height,s=e.interlace,h=e.bpp,n=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],s)for(var a=interlaceUtils.getImagePasses(i,r),l=0;l<a.length;l++)this._images.push({byteWidth:getByteWidth(a[l].width,h,n),height:a[l].height,lineIndex:0});else this._images.push({byteWidth:getByteWidth(i,h,n),height:r,lineIndex:0});this._xComparison=8===n?h:16===n?2*h:1};Filter.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))},Filter.prototype._unFilterType1=function(e,t,i){for(var r=this._xComparison,s=r-1,h=0;h<i;h++){var n=e[1+h],a=h>s?t[h-r]:0;t[h]=n+a}},Filter.prototype._unFilterType2=function(e,t,i){for(var r=this._lastLine,s=0;s<i;s++){var h=e[1+s],n=r?r[s]:0;t[s]=h+n}},Filter.prototype._unFilterType3=function(e,t,i){for(var r=this._xComparison,s=r-1,h=this._lastLine,n=0;n<i;n++){var a=e[1+n],l=h?h[n]:0,o=n>s?t[n-r]:0,p=Math.floor((o+l)/2);t[n]=a+p}},Filter.prototype._unFilterType4=function(e,t,i){for(var r=this._xComparison,s=r-1,h=this._lastLine,n=0;n<i;n++){var a=e[1+n],l=h?h[n]:0,o=n>s?t[n-r]:0,p=n>s&&h?h[n-r]:0,d=paethPredictor(o,l,p);t[n]=a+d}},Filter.prototype._reverseFilterLine=function(e){var t,i=e[0],r=this._images[this._imageIndex],s=r.byteWidth;if(0===i)t=e.slice(1,s+1);else switch(t=new Buffer(s),i){case 1:this._unFilterType1(e,t,s);break;case 2:this._unFilterType2(e,t,s);break;case 3:this._unFilterType3(e,t,s);break;case 4:this._unFilterType4(e,t,s);break;default:throw new Error("Unrecognised filter type - "+i)}this.write(t),r.lineIndex++,r.lineIndex>=r.height?(this._lastLine=null,this._imageIndex++,r=this._images[this._imageIndex]):this._lastLine=t,r?this.read(r.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())};