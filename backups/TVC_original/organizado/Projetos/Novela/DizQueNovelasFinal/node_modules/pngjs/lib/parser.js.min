"use strict";var constants=require("./constants"),CrcCalculator=require("./crc"),Parser=module.exports=function(t,e){this._options=t,t.checkCRC=!1!==t.checkCRC,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[constants.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[constants.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[constants.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[constants.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[constants.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[constants.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=e.read,this.error=e.error,this.metadata=e.metadata,this.gamma=e.gamma,this.transColor=e.transColor,this.palette=e.palette,this.parsed=e.parsed,this.inflateData=e.inflateData,this.finished=e.finished,this.simpleTransparency=e.simpleTransparency,this.headersFinished=e.headersFinished||function(){}};Parser.prototype.start=function(){this.read(constants.PNG_SIGNATURE.length,this._parseSignature.bind(this))},Parser.prototype._parseSignature=function(t){for(var e=constants.PNG_SIGNATURE,r=0;r<e.length;r++)if(t[r]!==e[r])return void this.error(new Error("Invalid file signature"));this.read(8,this._parseChunkBegin.bind(this))},Parser.prototype._parseChunkBegin=function(t){for(var e=t.readUInt32BE(0),r=t.readUInt32BE(4),s="",i=4;i<8;i++)s+=String.fromCharCode(t[i]);var n=Boolean(32&t[4]);if(this._hasIHDR||r===constants.TYPE_IHDR){if(this._crc=new CrcCalculator,this._crc.write(new Buffer(s)),this._chunks[r])return this._chunks[r](e);n?this.read(e+4,this._skipChunk.bind(this)):this.error(new Error("Unsupported critical chunk type "+s))}else this.error(new Error("Expected IHDR on beggining"))},Parser.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))},Parser.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))},Parser.prototype._parseChunkEnd=function(t){var e=t.readInt32BE(0),r=this._crc.crc32();this._options.checkCRC&&r!==e?this.error(new Error("Crc error - "+e+" - "+r)):this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))},Parser.prototype._handleIHDR=function(t){this.read(t,this._parseIHDR.bind(this))},Parser.prototype._parseIHDR=function(t){this._crc.write(t);var e=t.readUInt32BE(0),r=t.readUInt32BE(4),s=t[8],i=t[9],n=t[10],h=t[11],a=t[12];if(8===s||4===s||2===s||1===s||16===s)if(i in constants.COLORTYPE_TO_BPP_MAP)if(0===n)if(0===h)if(0===a||1===a){this._colorType=i;var o=constants.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:e,height:r,depth:s,interlace:Boolean(a),palette:Boolean(i&constants.COLORTYPE_PALETTE),color:Boolean(i&constants.COLORTYPE_COLOR),alpha:Boolean(i&constants.COLORTYPE_ALPHA),bpp:o,colorType:i}),this._handleChunkEnd()}else this.error(new Error("Unsupported interlace method"));else this.error(new Error("Unsupported filter method"));else this.error(new Error("Unsupported compression method"));else this.error(new Error("Unsupported color type"));else this.error(new Error("Unsupported bit depth "+s))},Parser.prototype._handlePLTE=function(t){this.read(t,this._parsePLTE.bind(this))},Parser.prototype._parsePLTE=function(t){this._crc.write(t);for(var e=Math.floor(t.length/3),r=0;r<e;r++)this._palette.push([t[3*r],t[3*r+1],t[3*r+2],255]);this.palette(this._palette),this._handleChunkEnd()},Parser.prototype._handleTRNS=function(t){this.simpleTransparency(),this.read(t,this._parseTRNS.bind(this))},Parser.prototype._parseTRNS=function(t){if(this._crc.write(t),this._colorType===constants.COLORTYPE_PALETTE_COLOR){if(0===this._palette.length)return void this.error(new Error("Transparency chunk must be after palette"));if(t.length>this._palette.length)return void this.error(new Error("More transparent colors than palette size"));for(var e=0;e<t.length;e++)this._palette[e][3]=t[e];this.palette(this._palette)}this._colorType===constants.COLORTYPE_GRAYSCALE&&this.transColor([t.readUInt16BE(0)]),this._colorType===constants.COLORTYPE_COLOR&&this.transColor([t.readUInt16BE(0),t.readUInt16BE(2),t.readUInt16BE(4)]),this._handleChunkEnd()},Parser.prototype._handleGAMA=function(t){this.read(t,this._parseGAMA.bind(this))},Parser.prototype._parseGAMA=function(t){this._crc.write(t),this.gamma(t.readUInt32BE(0)/constants.GAMMA_DIVISION),this._handleChunkEnd()},Parser.prototype._handleIDAT=function(t){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-t,this._parseIDAT.bind(this,t))},Parser.prototype._parseIDAT=function(t,e){if(this._crc.write(e),this._colorType===constants.COLORTYPE_PALETTE_COLOR&&0===this._palette.length)throw new Error("Expected palette not found");this.inflateData(e);var r=t-e.length;r>0?this._handleIDAT(r):this._handleChunkEnd()},Parser.prototype._handleIEND=function(t){this.read(t,this._parseIEND.bind(this))},Parser.prototype._parseIEND=function(t){this._crc.write(t),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()};