"use strict";var util=require("util"),zlib=require("zlib"),ChunkStream=require("./chunkstream"),FilterAsync=require("./filter-parse-async"),Parser=require("./parser"),bitmapper=require("./bitmapper"),formatNormaliser=require("./format-normaliser"),ParserAsync=module.exports=function(t){ChunkStream.call(this),this._parser=new Parser(t,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=t,this.writable=!0,this._parser.start()};util.inherits(ParserAsync,ChunkStream),ParserAsync.prototype._handleError=function(t){this.emit("error",t),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",function(){})),this.errord=!0},ParserAsync.prototype._inflateData=function(t){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=zlib.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{var i=(1+(this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3))*this._bitmapInfo.height,e=Math.max(i,zlib.Z_MIN_CHUNK);this._inflate=zlib.createInflate({chunkSize:e});var r=i,s=this.emit.bind(this,"error");this._inflate.on("error",function(t){r&&s(t)}),this._filter.on("complete",this._complete.bind(this));var a=this._filter.write.bind(this._filter);this._inflate.on("data",function(t){r&&(t.length>r&&(t=t.slice(0,r)),r-=t.length,a(t))}),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(t)},ParserAsync.prototype._handleMetaData=function(t){this._metaData=t,this._bitmapInfo=Object.create(t),this._filter=new FilterAsync(this._bitmapInfo)},ParserAsync.prototype._handleTransColor=function(t){this._bitmapInfo.transColor=t},ParserAsync.prototype._handlePalette=function(t){this._bitmapInfo.palette=t},ParserAsync.prototype._simpleTransparency=function(){this._metaData.alpha=!0},ParserAsync.prototype._headersFinished=function(){this.emit("metadata",this._metaData)},ParserAsync.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"),this.destroySoon())},ParserAsync.prototype._complete=function(t){if(!this.errord){try{var i=bitmapper.dataToBitMap(t,this._bitmapInfo),e=formatNormaliser(i,this._bitmapInfo);i=null}catch(t){return void this._handleError(t)}this.emit("parsed",e)}};