"use strict";var constants=require("./constants");module.exports=function(e,t,r,n){var a,o=-1!==[constants.COLORTYPE_COLOR_ALPHA,constants.COLORTYPE_ALPHA].indexOf(n.colorType);if(n.colorType===n.inputColorType){var s=(a=new ArrayBuffer(2),new DataView(a).setInt16(0,256,!0),256!==new Int16Array(a)[0]);if(8===n.bitDepth||16===n.bitDepth&&s)return e}var i=16!==n.bitDepth?e:new Uint16Array(e.buffer),O=255,c=constants.COLORTYPE_TO_BPP_MAP[n.inputColorType];4!==c||n.inputHasAlpha||(c=3);var p=constants.COLORTYPE_TO_BPP_MAP[n.colorType];16===n.bitDepth&&(O=65535,p*=2);var u=new Buffer(t*r*p),l=0,h=0,L=n.bgColor||{};function C(){var e,t,r,a=O;switch(n.inputColorType){case constants.COLORTYPE_COLOR_ALPHA:a=i[l+3],e=i[l],t=i[l+1],r=i[l+2];break;case constants.COLORTYPE_COLOR:e=i[l],t=i[l+1],r=i[l+2];break;case constants.COLORTYPE_ALPHA:a=i[l+1],t=e=i[l],r=e;break;case constants.COLORTYPE_GRAYSCALE:t=e=i[l],r=e;break;default:throw new Error("input color type:"+n.inputColorType+" is not supported at present")}return n.inputHasAlpha&&(o||(a/=O,e=Math.min(Math.max(Math.round((1-a)*L.red+a*e),0),O),t=Math.min(Math.max(Math.round((1-a)*L.green+a*t),0),O),r=Math.min(Math.max(Math.round((1-a)*L.blue+a*r),0),O))),{red:e,green:t,blue:r,alpha:a}}void 0===L.red&&(L.red=O),void 0===L.green&&(L.green=O),void 0===L.blue&&(L.blue=O);for(var P=0;P<r;P++)for(var T=0;T<t;T++){var A=C();switch(n.colorType){case constants.COLORTYPE_COLOR_ALPHA:case constants.COLORTYPE_COLOR:8===n.bitDepth?(u[h]=A.red,u[h+1]=A.green,u[h+2]=A.blue,o&&(u[h+3]=A.alpha)):(u.writeUInt16BE(A.red,h),u.writeUInt16BE(A.green,h+2),u.writeUInt16BE(A.blue,h+4),o&&u.writeUInt16BE(A.alpha,h+6));break;case constants.COLORTYPE_ALPHA:case constants.COLORTYPE_GRAYSCALE:var E=(A.red+A.green+A.blue)/3;8===n.bitDepth?(u[h]=E,o&&(u[h+1]=A.alpha)):(u.writeUInt16BE(E,h),o&&u.writeUInt16BE(A.alpha,h+2));break;default:throw new Error("unrecognised color Type "+n.colorType)}l+=c,h+=p}return u};