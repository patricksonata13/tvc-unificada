"use strict";var constants=require("./constants"),CrcStream=require("./crc"),bitPacker=require("./bitpacker"),filter=require("./filter-pack"),zlib=require("zlib"),Packer=module.exports=function(t){if(this._options=t,t.deflateChunkSize=t.deflateChunkSize||32768,t.deflateLevel=null!=t.deflateLevel?t.deflateLevel:9,t.deflateStrategy=null!=t.deflateStrategy?t.deflateStrategy:3,t.inputHasAlpha=null==t.inputHasAlpha||t.inputHasAlpha,t.deflateFactory=t.deflateFactory||zlib.createDeflate,t.bitDepth=t.bitDepth||8,t.colorType="number"==typeof t.colorType?t.colorType:constants.COLORTYPE_COLOR_ALPHA,t.inputColorType="number"==typeof t.inputColorType?t.inputColorType:constants.COLORTYPE_COLOR_ALPHA,-1===[constants.COLORTYPE_GRAYSCALE,constants.COLORTYPE_COLOR,constants.COLORTYPE_COLOR_ALPHA,constants.COLORTYPE_ALPHA].indexOf(t.colorType))throw new Error("option color type:"+t.colorType+" is not supported at present");if(-1===[constants.COLORTYPE_GRAYSCALE,constants.COLORTYPE_COLOR,constants.COLORTYPE_COLOR_ALPHA,constants.COLORTYPE_ALPHA].indexOf(t.inputColorType))throw new Error("option input color type:"+t.inputColorType+" is not supported at present");if(8!==t.bitDepth&&16!==t.bitDepth)throw new Error("option bit depth:"+t.bitDepth+" is not supported at present")};Packer.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}},Packer.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())},Packer.prototype.filterData=function(t,e,n){var o=bitPacker(t,e,n,this._options),r=constants.COLORTYPE_TO_BPP_MAP[this._options.colorType];return filter(o,e,n,this._options,r)},Packer.prototype._packChunk=function(t,e){var n=e?e.length:0,o=new Buffer(n+12);return o.writeUInt32BE(n,0),o.writeUInt32BE(t,4),e&&e.copy(o,8),o.writeInt32BE(CrcStream.crc32(o.slice(4,o.length-4)),o.length-4),o},Packer.prototype.packGAMA=function(t){var e=new Buffer(4);return e.writeUInt32BE(Math.floor(t*constants.GAMMA_DIVISION),0),this._packChunk(constants.TYPE_gAMA,e)},Packer.prototype.packIHDR=function(t,e){var n=new Buffer(13);return n.writeUInt32BE(t,0),n.writeUInt32BE(e,4),n[8]=this._options.bitDepth,n[9]=this._options.colorType,n[10]=0,n[11]=0,n[12]=0,this._packChunk(constants.TYPE_IHDR,n)},Packer.prototype.packIDAT=function(t){return this._packChunk(constants.TYPE_IDAT,t)},Packer.prototype.packIEND=function(){return this._packChunk(constants.TYPE_IEND,null)};