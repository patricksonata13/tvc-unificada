"use strict";const{execSync:execSync,spawnSync:spawnSync}=require("child_process"),fs=require("fs"),os=require("os"),path=require("path"),SDKS_DIR=path.normalize(path.join(__dirname,"..","..","sdks")),HERMES_DIR=path.join(SDKS_DIR,"hermes"),HERMES_TAG_FILE_PATH=path.join(SDKS_DIR,".hermesversion"),HERMES_SOURCE_TARBALL_BASE_URL="https://github.com/facebook/hermes/tarball/",HERMES_TARBALL_DOWNLOAD_DIR=path.join(SDKS_DIR,"download"),MACOS_BIN_DIR=path.join(SDKS_DIR,"hermesc","osx-bin"),MACOS_HERMESC_PATH=path.join(MACOS_BIN_DIR,"hermesc"),MACOS_IMPORT_HERMESC_PATH=path.join(MACOS_BIN_DIR,"ImportHermesc.cmake");function delegateSync(e,r,s){return spawnSync(e,r,{stdio:"inherit",...s})}function readHermesTag(){if(fs.existsSync(HERMES_TAG_FILE_PATH)){const e=fs.readFileSync(HERMES_TAG_FILE_PATH,{encoding:"utf8",flag:"r"}).trim();if(e.length>0)return e;throw new Error("[Hermes] .hermesversion file is empty.")}return"main"}function setHermesTag(e){readHermesTag()!==e&&(fs.existsSync(SDKS_DIR)||fs.mkdirSync(SDKS_DIR,{recursive:!0}),fs.writeFileSync(HERMES_TAG_FILE_PATH,e.trim()),console.log("Hermes tag has been updated. Please commit your changes."))}function getHermesTagSHA(e){return execSync(`git ls-remote https://github.com/facebook/hermes ${e} | cut -f 1`).toString().trim()}function getHermesTarballDownloadPath(e){const r=getHermesTagSHA(e);return path.join(HERMES_TARBALL_DOWNLOAD_DIR,`hermes-${r}.tgz`)}function downloadHermesSourceTarball(){const e=readHermesTag(),r=getHermesTagSHA(e),s=getHermesTarballDownloadPath(e);let t=HERMES_SOURCE_TARBALL_BASE_URL+e;if(!fs.existsSync(s)){fs.existsSync(HERMES_TARBALL_DOWNLOAD_DIR)||fs.mkdirSync(HERMES_TARBALL_DOWNLOAD_DIR,{recursive:!0}),console.info(`[Hermes] Downloading Hermes source code for commit ${r}`);try{delegateSync("curl",[t,"-Lo",s])}catch(e){throw new Error(`[Hermes] Failed to download Hermes tarball. ${e}`)}}}function expandHermesSourceTarball(){const e=readHermesTag(),r=getHermesTagSHA(e),s=getHermesTarballDownloadPath(e);if(!fs.existsSync(s))throw new Error("[Hermes] Could not locate Hermes tarball.");fs.existsSync(HERMES_DIR)||fs.mkdirSync(HERMES_DIR,{recursive:!0}),console.info(`[Hermes] Expanding Hermes tarball for commit ${r}`);try{delegateSync("tar",["-zxf",s,"--strip-components=1","--directory",HERMES_DIR])}catch(e){throw new Error("[Hermes] Failed to expand Hermes tarball.")}}function copyBuildScripts(){if(!fs.existsSync(SDKS_DIR))throw new Error("[Hermes] Failed to copy Hermes build scripts, no SDKs directory found.");fs.existsSync(HERMES_DIR)||fs.mkdirSync(path.join(HERMES_DIR,"utils"),{recursive:!0}),fs.copyFileSync(path.join(SDKS_DIR,"hermes-engine","utils","build-apple-framework.sh"),path.join(HERMES_DIR,"utils","build-apple-framework.sh")),fs.copyFileSync(path.join(SDKS_DIR,"hermes-engine","utils","build-ios-framework.sh"),path.join(HERMES_DIR,"utils","build-ios-framework.sh")),fs.copyFileSync(path.join(SDKS_DIR,"hermes-engine","utils","build-mac-framework.sh"),path.join(HERMES_DIR,"utils","build-mac-framework.sh"))}function copyPodSpec(){if(!fs.existsSync(SDKS_DIR))throw new Error("[Hermes] Failed to copy Hermes Podspec, no SDKs directory found.");fs.existsSync(HERMES_DIR)||fs.mkdirSync(HERMES_DIR,{recursive:!0});const e="hermes-engine.podspec";fs.copyFileSync(path.join(SDKS_DIR,"hermes-engine",e),path.join(HERMES_DIR,e));const r="hermes-utils.rb";fs.copyFileSync(path.join(SDKS_DIR,"hermes-engine",r),path.join(HERMES_DIR,r))}function isTestingAgainstLocalHermesTarball(){return"HERMES_ENGINE_TARBALL_PATH"in process.env}function shouldBuildHermesFromSource(e){return!isTestingAgainstLocalHermesTarball()&&e}function shouldUsePrebuiltHermesC(e){return"macos"===e&&fs.existsSync(MACOS_HERMESC_PATH)}function configureMakeForPrebuiltHermesC(){const e=`add_executable(native-hermesc IMPORTED)\nset_target_properties(native-hermesc PROPERTIES\n  IMPORTED_LOCATION "${MACOS_HERMESC_PATH}"\n  )`;try{fs.mkdirSync(MACOS_BIN_DIR,{recursive:!0}),fs.writeFileSync(MACOS_IMPORT_HERMESC_PATH,e)}catch(e){console.warn(`[Hermes] Re-compiling hermesc. Unable to configure make: ${e}`)}}function getHermesPrebuiltArtifactsTarballName(e){if(null==e)throw Error("Did not specify build type.");return`hermes-ios-${e.toLowerCase()}.tar.gz`}function createTarballFromDirectory(e,r){delegateSync("tar",["-C",e,"-czvf",r,"."])}function createHermesPrebuiltArtifactsTarball(e,r,s,t){let o;validateHermesFrameworksExist(path.join(e,"destroot")),fs.existsSync(s)||fs.mkdirSync(s,{recursive:!0});try{o=fs.mkdtempSync(path.join(os.tmpdir(),"hermes-engine-destroot-"));let r=["-a"];t&&(r.push("--exclude=dSYMs/"),r.push("--exclude=*.dSYM/")),r.push("./destroot"),r.push(o),delegateSync("rsync",r,{cwd:e}),fs.existsSync(path.join(e,"LICENSE"))&&delegateSync("cp",["LICENSE",o],{cwd:e})}catch(e){throw new Error(`Failed to copy destroot to tempdir: ${e}`)}const a=path.join(s,getHermesPrebuiltArtifactsTarballName(r));try{createTarballFromDirectory(o,a)}catch(e){throw new Error(`[Hermes] Failed to create tarball: ${e}`)}if(!fs.existsSync(a))throw new Error(`Tarball creation failed, could not locate tarball at ${a}`);return a}function validateHermesFrameworksExist(e){if(!fs.existsSync(path.join(e,"Library/Frameworks/macosx/hermes.framework")))throw new Error("Error: Hermes macOS Framework not found. Are you sure Hermes has been built?");if(!fs.existsSync(path.join(e,"Library/Frameworks/universal/hermes.xcframework")))throw new Error("Error: Hermes iOS XCFramework not found. Are you sure Hermes has been built?")}module.exports={configureMakeForPrebuiltHermesC:configureMakeForPrebuiltHermesC,copyBuildScripts:copyBuildScripts,copyPodSpec:copyPodSpec,createHermesPrebuiltArtifactsTarball:createHermesPrebuiltArtifactsTarball,createTarballFromDirectory:createTarballFromDirectory,downloadHermesSourceTarball:downloadHermesSourceTarball,expandHermesSourceTarball:expandHermesSourceTarball,getHermesTagSHA:getHermesTagSHA,getHermesTarballDownloadPath:getHermesTarballDownloadPath,getHermesPrebuiltArtifactsTarballName:getHermesPrebuiltArtifactsTarballName,readHermesTag:readHermesTag,setHermesTag:setHermesTag,shouldBuildHermesFromSource:shouldBuildHermesFromSource,shouldUsePrebuiltHermesC:shouldUsePrebuiltHermesC};