"use strict";const EventEmitter=require("events"),crypto=require("crypto"),http=require("http"),PerMessageDeflate=require("./permessage-deflate"),extension=require("./extension"),WebSocket=require("./websocket"),{GUID:GUID}=require("./constants"),keyRegex=/^[+/0-9A-Za-z]{22}==$/;class WebSocketServer extends EventEmitter{constructor(e,t){if(super(),null==(e=Object.assign({maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null},e)).port&&!e.server&&!e.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');null!=e.port?(this._server=http.createServer((e,t)=>{const s=http.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server&&(this._removeListeners=addListeners(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(e,t,s)=>{this.handleUpgrade(e,t,s,t=>{this.emit("connection",t,e)})}})),!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(()=>this.emit("close")):process.nextTick(emitClose,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",socketOnError);const o=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),n=e.headers.upgrade,i=+e.headers["sec-websocket-version"],a={};if("GET"!==e.method||void 0===n||"websocket"!==n.toLowerCase()||!o||!keyRegex.test(o)||8!==i&&13!==i||!this.shouldHandle(e))return abortHandshake(t,400);if(this.options.perMessageDeflate){const s=new PerMessageDeflate(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=extension.parse(e.headers["sec-websocket-extensions"]);t[PerMessageDeflate.extensionName]&&(s.accept(t[PerMessageDeflate.extensionName]),a[PerMessageDeflate.extensionName]=s)}catch(e){return abortHandshake(t,400)}}if(this.options.verifyClient){const n={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.connection.authorized&&!e.connection.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(n,(n,i,c,l)=>{if(!n)return abortHandshake(t,i||401,c,l);this.completeUpgrade(o,a,e,t,s,r)});if(!this.options.verifyClient(n))return abortHandshake(t,401)}this.completeUpgrade(o,a,e,t,s,r)}completeUpgrade(e,t,s,r,o,n){if(!r.readable||!r.writable)return r.destroy();const i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${crypto.createHash("sha1").update(e+GUID).digest("base64")}`],a=new WebSocket(null);var c=s.headers["sec-websocket-protocol"];if(c&&(c=c.split(",").map(trim),(c=this.options.handleProtocols?this.options.handleProtocols(c,s):c[0])&&(i.push(`Sec-WebSocket-Protocol: ${c}`),a.protocol=c)),t[PerMessageDeflate.extensionName]){const e=t[PerMessageDeflate.extensionName].params,s=extension.format({[PerMessageDeflate.extensionName]:[e]});i.push(`Sec-WebSocket-Extensions: ${s}`),a._extensions=t}this.emit("headers",i,s),r.write(i.concat("\r\n").join("\r\n")),r.removeListener("error",socketOnError),a.setSocket(r,o,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),n(a)}}function addListeners(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}function emitClose(e){e.emit("close")}function socketOnError(){this.destroy()}function abortHandshake(e,t,s,r){e.writable&&(s=s||http.STATUS_CODES[t],r=Object.assign({Connection:"close","Content-type":"text/html","Content-Length":Buffer.byteLength(s)},r),e.write(`HTTP/1.1 ${t} ${http.STATUS_CODES[t]}\r\n`+Object.keys(r).map(e=>`${e}: ${r[e]}`).join("\r\n")+"\r\n\r\n"+s)),e.removeListener("error",socketOnError),e.destroy()}function trim(e){return e.trim()}module.exports=WebSocketServer;