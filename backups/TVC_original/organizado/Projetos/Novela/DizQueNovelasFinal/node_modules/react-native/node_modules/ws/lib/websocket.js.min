"use strict";const EventEmitter=require("events"),crypto=require("crypto"),https=require("https"),http=require("http"),net=require("net"),tls=require("tls"),url=require("url"),PerMessageDeflate=require("./permessage-deflate"),EventTarget=require("./event-target"),extension=require("./extension"),Receiver=require("./receiver"),Sender=require("./sender"),{BINARY_TYPES:BINARY_TYPES,EMPTY_BUFFER:EMPTY_BUFFER,GUID:GUID,kStatusCode:kStatusCode,kWebSocket:kWebSocket,NOOP:NOOP}=require("./constants"),readyStates=["CONNECTING","OPEN","CLOSING","CLOSED"],protocolVersions=[8,13],closeTimeout=3e4;class WebSocket extends EventEmitter{constructor(e,t,o){super(),this.readyState=WebSocket.CONNECTING,this.protocol="",this._binaryType=BINARY_TYPES[0],this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._closeCode=1006,this._extensions={},this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(o=t,t=void 0),initAsClient(this,e,t,o)):this._isServer=!0}get CONNECTING(){return WebSocket.CONNECTING}get CLOSING(){return WebSocket.CLOSING}get CLOSED(){return WebSocket.CLOSED}get OPEN(){return WebSocket.OPEN}get binaryType(){return this._binaryType}set binaryType(e){BINARY_TYPES.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?(this._socket.bufferSize||0)+this._sender._bufferedBytes:0}get extensions(){return Object.keys(this._extensions).join()}setSocket(e,t,o){const r=new Receiver(this._binaryType,this._extensions,o);this._sender=new Sender(e,this._extensions),this._receiver=r,this._socket=e,r[kWebSocket]=this,e[kWebSocket]=this,r.on("conclude",receiverOnConclude),r.on("drain",receiverOnDrain),r.on("error",receiverOnError),r.on("message",receiverOnMessage),r.on("ping",receiverOnPing),r.on("pong",receiverOnPong),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",socketOnClose),e.on("data",socketOnData),e.on("end",socketOnEnd),e.on("error",socketOnError),this.readyState=WebSocket.OPEN,this.emit("open")}emitClose(){this.readyState=WebSocket.CLOSED,this._socket?(this._extensions[PerMessageDeflate.extensionName]&&this._extensions[PerMessageDeflate.extensionName].cleanup(),this._receiver.removeAllListeners(),this.emit("close",this._closeCode,this._closeMessage)):this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==WebSocket.CLOSED){if(this.readyState===WebSocket.CONNECTING){const e="WebSocket was closed before the connection was established";return abortHandshake(this,this._req,e)}this.readyState!==WebSocket.CLOSING?(this.readyState=WebSocket.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&this._closeFrameReceived&&this._socket.end()}}ping(e,t,o){if("function"==typeof e?(o=e,e=t=void 0):"function"==typeof t&&(o=t,t=void 0),this.readyState!==WebSocket.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} (${readyStates[this.readyState]})`);if(o)return o(e);throw e}"number"==typeof e&&(e=e.toString()),void 0===t&&(t=!this._isServer),this._sender.ping(e||EMPTY_BUFFER,t,o)}pong(e,t,o){if("function"==typeof e?(o=e,e=t=void 0):"function"==typeof t&&(o=t,t=void 0),this.readyState!==WebSocket.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} (${readyStates[this.readyState]})`);if(o)return o(e);throw e}"number"==typeof e&&(e=e.toString()),void 0===t&&(t=!this._isServer),this._sender.pong(e||EMPTY_BUFFER,t,o)}send(e,t,o){if("function"==typeof t&&(o=t,t={}),this.readyState!==WebSocket.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} (${readyStates[this.readyState]})`);if(o)return o(e);throw e}"number"==typeof e&&(e=e.toString());const r=Object.assign({binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0},t);this._extensions[PerMessageDeflate.extensionName]||(r.compress=!1),this._sender.send(e||EMPTY_BUFFER,r,o)}terminate(){if(this.readyState!==WebSocket.CLOSED){if(this.readyState===WebSocket.CONNECTING){const e="WebSocket was closed before the connection was established";return abortHandshake(this,this._req,e)}this._socket&&(this.readyState=WebSocket.CLOSING,this._socket.destroy())}}}function initAsClient(e,t,o,r){const s=Object.assign({protocolVersion:protocolVersions[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10},r,{createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,auth:void 0,host:void 0,path:void 0,port:void 0});if(!protocolVersions.includes(s.protocolVersion))throw new RangeError(`Unsupported protocol version: ${s.protocolVersion} (supported versions: ${protocolVersions.join(", ")})`);var n;"object"==typeof t&&void 0!==t.href?(n=t,e.url=t.href):(n=url.URL?new url.URL(t):url.parse(t),e.url=t);const i="ws+unix:"===n.protocol;if(!(n.host||i&&n.pathname))throw new Error(`Invalid URL: ${e.url}`);const a="wss:"===n.protocol||"https:"===n.protocol,c=a?443:80,h=crypto.randomBytes(16).toString("base64"),d=a?https.get:http.get,l=n.search?`${n.pathname||"/"}${n.search}`:n.pathname||"/";var S;if(s.createConnection=a?tlsConnect:netConnect,s.defaultPort=s.defaultPort||c,s.port=n.port||c,s.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname,s.headers=Object.assign({"Sec-WebSocket-Version":s.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket"},s.headers),s.path=l,s.timeout=s.handshakeTimeout,s.perMessageDeflate&&(S=new PerMessageDeflate(!0!==s.perMessageDeflate?s.perMessageDeflate:{},!1,s.maxPayload),s.headers["Sec-WebSocket-Extensions"]=extension.format({[PerMessageDeflate.extensionName]:S.offer()})),o&&(s.headers["Sec-WebSocket-Protocol"]=o),s.origin&&(s.protocolVersion<13?s.headers["Sec-WebSocket-Origin"]=s.origin:s.headers.Origin=s.origin),n.auth?s.auth=n.auth:(n.username||n.password)&&(s.auth=`${n.username}:${n.password}`),i){const e=l.split(":");s.socketPath=e[0],s.path=e[1]}var k=e._req=d(s);s.timeout&&k.on("timeout",()=>{abortHandshake(e,k,"Opening handshake has timed out")}),k.on("error",t=>{e._req.aborted||(k=e._req=null,e.readyState=WebSocket.CLOSING,e.emit("error",t),e.emitClose())}),k.on("response",n=>{const i=n.headers.location,a=n.statusCode;if(i&&s.followRedirects&&a>=300&&a<400){if(++e._redirects>s.maxRedirects)return void abortHandshake(e,k,"Maximum redirects exceeded");k.abort();const n=url.URL?new url.URL(i,t):url.resolve(t,i);initAsClient(e,n,o,r)}else e.emit("unexpected-response",k,n)||abortHandshake(e,k,`Unexpected server response: ${n.statusCode}`)}),k.on("upgrade",(t,r,n)=>{if(e.emit("upgrade",t),e.readyState!==WebSocket.CONNECTING)return;k=e._req=null;const i=crypto.createHash("sha1").update(h+GUID).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void abortHandshake(e,r,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"],c=(o||"").split(/, */);var d;if(!o&&a?d="Server sent a subprotocol but none was requested":o&&!a?d="Server sent no subprotocol":a&&!c.includes(a)&&(d="Server sent an invalid subprotocol"),d)abortHandshake(e,r,d);else{if(a&&(e.protocol=a),S)try{const o=extension.parse(t.headers["sec-websocket-extensions"]);o[PerMessageDeflate.extensionName]&&(S.accept(o[PerMessageDeflate.extensionName]),e._extensions[PerMessageDeflate.extensionName]=S)}catch(t){return void abortHandshake(e,r,"Invalid Sec-WebSocket-Extensions header")}e.setSocket(r,n,s.maxPayload)}})}function netConnect(e){return e.protocolVersion&&(e.path=e.socketPath),net.connect(e)}function tlsConnect(e){return e.path=void 0,e.servername=e.servername||e.host,tls.connect(e)}function abortHandshake(e,t,o){e.readyState=WebSocket.CLOSING;const r=new Error(o);Error.captureStackTrace(r,abortHandshake),t.setHeader?(t.abort(),t.once("abort",e.emitClose.bind(e)),e.emit("error",r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function receiverOnConclude(e,t){const o=this[kWebSocket];o._socket.removeListener("data",socketOnData),o._socket.resume(),o._closeFrameReceived=!0,o._closeMessage=t,o._closeCode=e,1005===e?o.close():o.close(e,t)}function receiverOnDrain(){this[kWebSocket]._socket.resume()}function receiverOnError(e){const t=this[kWebSocket];t._socket.removeListener("data",socketOnData),t.readyState=WebSocket.CLOSING,t._closeCode=e[kStatusCode],t.emit("error",e),t._socket.destroy()}function receiverOnFinish(){this[kWebSocket].emitClose()}function receiverOnMessage(e){this[kWebSocket].emit("message",e)}function receiverOnPing(e){const t=this[kWebSocket];t.pong(e,!t._isServer,NOOP),t.emit("ping",e)}function receiverOnPong(e){this[kWebSocket].emit("pong",e)}function socketOnClose(){const e=this[kWebSocket];this.removeListener("close",socketOnClose),this.removeListener("end",socketOnEnd),e.readyState=WebSocket.CLOSING,e._socket.read(),e._receiver.end(),this.removeListener("data",socketOnData),this[kWebSocket]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",receiverOnFinish),e._receiver.on("finish",receiverOnFinish))}function socketOnData(e){this[kWebSocket]._receiver.write(e)||this.pause()}function socketOnEnd(){const e=this[kWebSocket];e.readyState=WebSocket.CLOSING,e._receiver.end(),this.end()}function socketOnError(){const e=this[kWebSocket];this.removeListener("error",socketOnError),this.on("error",NOOP),e.readyState=WebSocket.CLOSING,this.destroy()}readyStates.forEach((e,t)=>{WebSocket[e]=t}),["open","error","close","message"].forEach(e=>{Object.defineProperty(WebSocket.prototype,`on${e}`,{get(){const t=this.listeners(e);for(var o=0;o<t.length;o++)if(t[o]._listener)return t[o]._listener},set(t){const o=this.listeners(e);for(var r=0;r<o.length;r++)o[r]._listener&&this.removeListener(e,o[r]);this.addEventListener(e,t)}})}),WebSocket.prototype.addEventListener=EventTarget.addEventListener,WebSocket.prototype.removeEventListener=EventTarget.removeEventListener,module.exports=WebSocket;