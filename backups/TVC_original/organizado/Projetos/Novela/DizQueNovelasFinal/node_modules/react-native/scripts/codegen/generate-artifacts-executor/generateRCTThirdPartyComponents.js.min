"use strict";const{TEMPLATES_FOLDER_PATH:TEMPLATES_FOLDER_PATH}=require("./constants"),{codegenLog:codegenLog,isReactNativeCoreLibrary:isReactNativeCoreLibrary,parseiOSAnnotations:parseiOSAnnotations}=require("./utils"),fs=require("fs"),path=require("path"),THIRD_PARTY_COMPONENTS_H_TEMPLATE_PATH=path.join(TEMPLATES_FOLDER_PATH,"RCTThirdPartyComponentsProviderH.template"),THIRD_PARTY_COMPONENTS_MM_TEMPLATE_PATH=path.join(TEMPLATES_FOLDER_PATH,"RCTThirdPartyComponentsProviderMM.template");function generateRCTThirdPartyComponents(e,n){fs.mkdirSync(n,{recursive:!0}),codegenLog("Generating RCTThirdPartyComponentsProvider.h");const t=fs.readFileSync(THIRD_PARTY_COMPONENTS_H_TEMPLATE_PATH,"utf8"),o=path.join(n,"RCTThirdPartyComponentsProvider.h");fs.writeFileSync(o,t),codegenLog(`Generated artifact: ${o}`),codegenLog("Generating RCTThirdPartyComponentsProvider.mm");let r={};const s=e.filter(({config:e,libraryPath:n})=>!isReactNativeCoreLibrary(e.name)&&"modules"!==e.type),i={},a=[],c=[];for(const e of s)e.config.ios?.components||!e.config.ios?.componentProvider?a.push(e):c.push(e);c.forEach(e=>{const{config:n,libraryPath:t}=e,o=JSON.parse(fs.readFileSync(path.join(t,"package.json"),"utf8")).name;i[o]=e;const s=n.ios?.componentProvider;delete i[o],r[o]=r[o]||[],Object.keys(s).forEach(e=>{r[o].push({componentName:e,className:s[e]})})});const p=parseiOSAnnotations(a);for(const[e,n]of Object.entries(p)){const{library:t,components:o}=n;i[e]=t;for(const[n,t]of Object.entries(o))t.className&&(delete i[e],r[e]=r[e]||[],r[e].push({componentName:n,className:t.className}))}Object.entries(i).forEach(([e,n])=>{const{libraryPath:t}=n;codegenLog(`Crawling ${e} library for components`);const o=findFilesWithExtension(t,".mm").flatMap(e=>findRCTComponentViewProtocolClass(e)).filter(Boolean);0!==o.length&&codegenLog(`[DEPRECATED] ${e} should add the 'ios.componentProvider' property in their codegenConfig`,!0),r[e]=o});const l=Object.keys(r).flatMap(e=>r[e].map(({componentName:n,className:t})=>`\t\t@"${n}": NSClassFromString(@"${t}"), // ${e}`)).join("\n"),d=fs.readFileSync(THIRD_PARTY_COMPONENTS_MM_TEMPLATE_PATH,"utf8").replace(/{thirdPartyComponentsMapping}/,l),T=path.join(n,"RCTThirdPartyComponentsProvider.mm");fs.writeFileSync(T,d),codegenLog(`Generated artifact: ${T}`)}function findFilesWithExtension(e,n){const t=[];return fs.readdirSync(e).forEach(o=>{const r=path.join(e,o);return r.includes(`${path.sep}react-native${path.sep}`)||r.includes(`${path.sep}.`)&&!r.includes(`${path.sep}.pnpm`)?null:void(fs.existsSync(r)&&fs.statSync(r).isDirectory()?t.push(...findFilesWithExtension(r,n)):o.endsWith(n)&&t.push(r))}),t}function findRCTComponentViewProtocolClass(e){const n=fs.readFileSync(e,"utf8"),t=/Class<RCTComponentViewProtocol> (.*)Cls\(/,o=n.match(t);if(o){const e=o[1],r=n.split("\n"),s=r.findIndex(e=>t.test(e)),i=/return (.*)\.class/,a=String(r.slice(s).join("\n")).match(i);if(a){const n=a[1];return codegenLog(`Match found ${e} -> ${n}`),{componentName:e,className:n}}return console.warn(`Could not find class name for component ${e}. Register it manually`),null}return null}module.exports={generateRCTThirdPartyComponents:generateRCTThirdPartyComponents};