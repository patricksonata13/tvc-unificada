"use strict";const{CODEGEN_REPO_PATH:CODEGEN_REPO_PATH,CORE_LIBRARIES_WITH_OUTPUT_FOLDER:CORE_LIBRARIES_WITH_OUTPUT_FOLDER,REACT_NATIVE:REACT_NATIVE}=require("./constants"),{execSync:execSync}=require("child_process"),fs=require("fs"),path=require("path");function pkgJsonIncludesGeneratedCode(e){return e.codegenConfig&&e.codegenConfig.includesGeneratedCode}const codegenLog=(e,n=!1)=>{const r="[0m",i=n?"[33m":"";console.log(`[36m[1m[Codegen]${r} ${i}${e}${r}`)};function readPkgJsonInDirectory(e){const n=path.join(e,"package.json");if(!fs.existsSync(n))throw`[Codegen] Error: ${n} does not exist.`;return JSON.parse(fs.readFileSync(n,"utf8"))}function buildCodegenIfNeeded(){if(!fs.existsSync(CODEGEN_REPO_PATH))return;const e=path.join(CODEGEN_REPO_PATH,"lib");fs.existsSync(e)&&fs.readdirSync(e).length>0||(codegenLog("Building react-native-codegen package.",!0),execSync("yarn install",{cwd:CODEGEN_REPO_PATH,stdio:"inherit"}),execSync("yarn build",{cwd:CODEGEN_REPO_PATH,stdio:"inherit"}))}function cleanupEmptyFilesAndFolders(e){const n=fs.statSync(e);if(n.isFile()&&0===n.size)return void fs.rmSync(e);if(n.isFile())return;fs.readdirSync(e).forEach(n=>cleanupEmptyFilesAndFolders(path.join(e,n)));0!==fs.readdirSync(e).length||fs.rmdirSync(e)}function readGeneratedAutolinkingOutput(e){const n=path.resolve(e,"build/generated/autolinking/autolinking.json");return fs.existsSync(n)?require(n):(codegenLog(`Could not find generated autolinking output at: ${n}`),null)}function readReactNativeConfig(e,n){const r=readGeneratedAutolinkingOutput(n),i=path.resolve(e,"react-native.config.js");return r||(fs.existsSync(i)?require(i):(codegenLog(`Could not find React Native config at: ${i}`),{}))}function findCodegenEnabledLibraries(e,n,r,i){const o=findProjectRootLibraries(e,n);if(pkgJsonIncludesGeneratedCode(e))return o;{const t=[...o];return readGeneratedAutolinkingOutput(r)||t.push(...findExternalLibraries(e,n)),t.push(...findLibrariesFromReactNativeConfig(n,i)),t}}function findProjectRootLibraries(e,n){if(codegenLog("Searching for codegen-enabled libraries in the app.",!0),null==e.codegenConfig)return codegenLog('The "codegenConfig" field is not defined in package.json. Assuming there is nothing to generate at the app level.',!0),[];if("object"!=typeof e.codegenConfig)throw'The "codegenConfig" field must be an Object.';return extractLibrariesFromJSON(e,n)}function findLibrariesFromReactNativeConfig(e,n){return codegenLog("Searching for codegen-enabled libraries in react-native.config.js",!0),n.dependencies?Object.keys(n.dependencies).flatMap(r=>{const i=n.dependencies[r];if(!i.root)return[];const o=path.resolve(e,i.root);let t;try{t=readPkgJsonInDirectory(o)}catch{return[]}return extractLibrariesFromJSON(t,o)}):[]}function findExternalLibraries(e,n){const r={...e.dependencies,...e.devDependencies,...e.peerDependencies};return codegenLog("Searching for codegen-enabled libraries in the project dependencies.",!0),Object.keys(r).flatMap(i=>{let o="";try{o=require.resolve(path.join(i,"package.json"),{paths:[n]})}catch(t){if(!r[i].startsWith(".")&&!r[i].startsWith("/"))return[];o=path.join(n,e.dependencies[i],"package.json")}return extractLibrariesFromJSON(JSON.parse(fs.readFileSync(o,"utf8")),path.dirname(o))})}function extractLibrariesFromJSON(e,n){if(null==e.codegenConfig)return[];if(codegenLog(`Found ${e.name}`),null==e.codegenConfig.libraries){const r=e.codegenConfig;return[{name:e.name,config:r,libraryPath:n}]}return printDeprecationWarningIfNeeded(e.name),extractLibrariesFromConfigurationArray(e,n)}function printDeprecationWarningIfNeeded(e){e!==REACT_NATIVE&&(codegenLog(`CodegenConfig Deprecated Setup for ${e}.\n    The configuration file still contains the codegen in the libraries array.\n    If possible, replace it with a single object.\n  `),codegenLog('BEFORE:\n    {\n      // ...\n      "codegenConfig": {\n        "libraries": [\n          {\n            "name": "libName1",\n            "type": "all|components|modules",\n            "jsSrcsRoot": "libName1/js"\n          },\n          {\n            "name": "libName2",\n            "type": "all|components|modules",\n            "jsSrcsRoot": "libName2/src"\n          }\n        ]\n      }\n    }\n\n    AFTER:\n    {\n      "codegenConfig": {\n        "name": "libraries",\n        "type": "all",\n        "jsSrcsRoot": "."\n      }\n    }\n  '))}function extractLibrariesFromConfigurationArray(e,n){return e.codegenConfig.libraries.map(e=>({name:e.name,config:e,libraryPath:n}))}function isReactNativeCoreLibrary(e){return e in CORE_LIBRARIES_WITH_OUTPUT_FOLDER}function parseiOSAnnotations(e){const n={},r={},i={};for(const o of e){const e=o?.config?.ios;if(!e)continue;const t=getLibraryName(o);i[t]=i[t]||{library:o,modules:{},components:{}};const{modules:a,components:s}=e;if(a)for(const[e,r]of Object.entries(a))n[e]=n[e]||new Set,n[e].add(t),i[t].modules[e]={...r};if(s)for(const[e,n]of Object.entries(s))r[e]=r[e]||new Set,r[e].add(t),i[t].components[e]={...n}}const o=Object.entries(n).filter(([e,n])=>n.size>1).map(([e,n])=>`  Module { "${e}" } => Libraries{ ${Array.from(n).join(", ")} }\n`),t=Object.entries(r).filter(([e,n])=>n.size>1).map(([e,n])=>`  Component { "${e}" } => Libraries{ ${Array.from(n).join(", ")} }\n`);if(o.length>0||t.length>0)throw new Error("Some components or modules are declared in more than one libraries: \n"+[...o,...t].join("\n"));return i}function getLibraryName(e){return JSON.parse(fs.readFileSync(path.join(e.libraryPath,"package.json"),"utf8")).name}function findDisabledLibrariesByPlatform(e,n){const r=e.dependencies??{};return Object.keys(r).filter(e=>null===r[e].platforms?.[n])}module.exports={buildCodegenIfNeeded:buildCodegenIfNeeded,pkgJsonIncludesGeneratedCode:pkgJsonIncludesGeneratedCode,codegenLog:codegenLog,readPkgJsonInDirectory:readPkgJsonInDirectory,isReactNativeCoreLibrary:isReactNativeCoreLibrary,cleanupEmptyFilesAndFolders:cleanupEmptyFilesAndFolders,findCodegenEnabledLibraries:findCodegenEnabledLibraries,findProjectRootLibraries:findProjectRootLibraries,extractLibrariesFromJSON:extractLibrariesFromJSON,parseiOSAnnotations:parseiOSAnnotations,readReactNativeConfig:readReactNativeConfig,findDisabledLibrariesByPlatform:findDisabledLibrariesByPlatform};