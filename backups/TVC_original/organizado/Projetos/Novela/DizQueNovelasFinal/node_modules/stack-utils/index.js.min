"use strict";const escapeStringRegexp=require("escape-string-regexp"),cwd="object"==typeof process&&process&&"function"==typeof process.cwd?process.cwd():".",natives=[].concat(require("module").builtinModules,"bootstrap_node","node").map(e=>new RegExp(`(?:\\((?:node:)?${e}(?:\\.js)?:\\d+:\\d+\\)$|^\\s*at (?:node:)?${e}(?:\\.js)?:\\d+:\\d+$)`));natives.push(/\((?:node:)?internal\/[^:]+:\d+:\d+\)$/,/\s*at (?:node:)?internal\/[^:]+:\d+:\d+$/,/\/\.node-spawn-wrap-\w+-\w+\/node:\d+:\d+\)?$/);class StackUtils{constructor(e){"internals"in(e={ignoredPackages:[],...e})==!1&&(e.internals=StackUtils.nodeInternals()),"cwd"in e==!1&&(e.cwd=cwd),this._cwd=e.cwd.replace(/\\/g,"/"),this._internals=[].concat(e.internals,ignoredPackagesRegExp(e.ignoredPackages)),this._wrapCallSite=e.wrapCallSite||!1}static nodeInternals(){return[...natives]}clean(e,t=0){t=" ".repeat(t),Array.isArray(e)||(e=e.split("\n")),!/^\s*at /.test(e[0])&&/^\s*at /.test(e[1])&&(e=e.slice(1));let r=!1,n=null;const a=[];return e.forEach(e=>{if(e=e.replace(/\\/g,"/"),this._internals.some(t=>t.test(e)))return;const t=/^\s*at /.test(e);r?e=e.trimEnd().replace(/^(\s+)at /,"$1"):(e=e.trim(),t&&(e=e.slice(3))),(e=e.replace(`${this._cwd}/`,""))&&(t?(n&&(a.push(n),n=null),a.push(e)):(r=!0,n=e))}),a.map(e=>`${t}${e}\n`).join("")}captureString(e,t=this.captureString){"function"==typeof e&&(t=e,e=1/0);const{stackTraceLimit:r}=Error;e&&(Error.stackTraceLimit=e);const n={};Error.captureStackTrace(n,t);const{stack:a}=n;return Error.stackTraceLimit=r,this.clean(a)}capture(e,t=this.capture){"function"==typeof e&&(t=e,e=1/0);const{prepareStackTrace:r,stackTraceLimit:n}=Error;Error.prepareStackTrace=(e,t)=>this._wrapCallSite?t.map(this._wrapCallSite):t,e&&(Error.stackTraceLimit=e);const a={};Error.captureStackTrace(a,t);const{stack:c}=a;return Object.assign(Error,{prepareStackTrace:r,stackTraceLimit:n}),c}at(e=this.at){const[t]=this.capture(1,e);if(!t)return{};const r={line:t.getLineNumber(),column:t.getColumnNumber()};let n;setFile(r,t.getFileName(),this._cwd),t.isConstructor()&&Object.defineProperty(r,"constructor",{value:!0,configurable:!0}),t.isEval()&&(r.evalOrigin=t.getEvalOrigin()),t.isNative()&&(r.native=!0);try{n=t.getTypeName()}catch(e){}n&&"Object"!==n&&"[object Object]"!==n&&(r.type=n);const a=t.getFunctionName();a&&(r.function=a);const c=t.getMethodName();return c&&a!==c&&(r.method=c),r}parseLine(e){const t=e&&e.match(re);if(!t)return null;const r="new"===t[1];let n=t[2];const a=t[3],c=t[4],s=Number(t[5]),i=Number(t[6]);let o=t[7];const l=t[8],p=t[9],u="native"===t[10],d=")"===t[11];let g;const m={};if(l&&(m.line=Number(l)),p&&(m.column=Number(p)),d&&o){let e=0;for(let t=o.length-1;t>0;t--)if(")"===o.charAt(t))e++;else if("("===o.charAt(t)&&" "===o.charAt(t-1)&&(e--,-1===e&&" "===o.charAt(t-1))){const e=o.slice(0,t-1),r=o.slice(t+1);o=r,n+=` (${e}`;break}}if(n){const e=n.match(methodRe);e&&(n=e[1],g=e[2])}return setFile(m,o,this._cwd),r&&Object.defineProperty(m,"constructor",{value:!0,configurable:!0}),a&&(m.evalOrigin=a,m.evalLine=s,m.evalColumn=i,m.evalFile=c&&c.replace(/\\/g,"/")),u&&(m.native=!0),n&&(m.function=n),g&&n!==g&&(m.method=g),m}}function setFile(e,t,r){t&&((t=t.replace(/\\/g,"/")).startsWith(`${r}/`)&&(t=t.slice(r.length+1)),e.file=t)}function ignoredPackagesRegExp(e){if(0===e.length)return[];const t=e.map(e=>escapeStringRegexp(e));return new RegExp(`[/\\\\]node_modules[/\\\\](?:${t.join("|")})[/\\\\][^:]+:\\d+:\\d+`)}const re=new RegExp("^(?:\\s*at )?(?:(new) )?(?:(.*?) \\()?(?:eval at ([^ ]+) \\((.+?):(\\d+):(\\d+)\\), )?(?:(.+?):(\\d+):(\\d+)|(native))(\\)?)$"),methodRe=/^(.*?) \[as (.*?)\]$/;module.exports=StackUtils;