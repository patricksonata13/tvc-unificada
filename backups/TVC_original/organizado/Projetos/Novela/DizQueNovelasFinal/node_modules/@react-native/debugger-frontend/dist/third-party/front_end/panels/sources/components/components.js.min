import"../../../ui/components/icon_button/icon_button.js";import*as e from"../../../core/common/common.js";import*as t from"../../../core/host/host.js";import*as n from"../../../core/i18n/i18n.js";import*as o from"../../../core/platform/platform.js";import{assertNotNullOrUndefined as i}from"../../../core/platform/platform.js";import*as a from"../../../core/sdk/sdk.js";import*as r from"../../../models/bindings/bindings.js";import*as s from"../../../models/breakpoints/breakpoints.js";import*as l from"../../../models/text_utils/text_utils.js";import*as c from"../../../models/workspace/workspace.js";import*as d from"../../../ui/components/input/input.js";import*as p from"../../../ui/components/legacy_wrapper/legacy_wrapper.js";import*as h from"../../../ui/components/render_coordinator/render_coordinator.js";import*as u from"../../../ui/legacy/legacy.js";import*as g from"../../../ui/lit/lit.js";import*as m from"../../../ui/visual_logging/visual_logging.js";import*as b from"../../../models/persistence/persistence.js";import"../../../ui/components/buttons/buttons.js";import*as k from"../../../ui/components/helpers/helpers.js";var v={cssText:`:host{flex:auto;display:flex;flex-direction:column}.code-snippet{width:100%;font-family:var(--source-code-font-family);font-size:var(--source-code-font-size);color:var(--sys-color-token-subtle);text-overflow:ellipsis;overflow:hidden;white-space:nowrap;flex-shrink:100;cursor:pointer}.code-snippet:hover{color:var(--sys-color-on-surface);text-decoration:underline}input{height:12px;width:12px;flex-shrink:0;margin:3px 0}details{border-top:1px solid var(--sys-color-divider);padding:2px 0}details:not(.active){background-color:var(--sys-color-state-disabled-container);opacity:30%}details > summary{min-height:20px;list-style:none;display:flex;padding:0 8px 0 6px;align-items:center}details > summary:hover{background-color:var(--sys-color-state-hover-on-subtle)}details > summary::before{display:block;user-select:none;mask-image:var(--image-file-arrow-collapse);background-color:var(--icon-default);content:"";height:var(--sys-size-8);min-width:var(--sys-size-8);max-width:var(--sys-size-8);margin-top:calc(-1 * var(--sys-size-2));margin-left:calc(-1 * var(--sys-size-3));overflow:hidden}details[open] > summary::before{mask-image:var(--image-file-arrow-drop-down)}.group-header{display:inline-flex;align-items:center;width:100%;padding-right:8px;overflow:hidden}.group-icon-or-disable{justify-content:center;display:flex;width:16px;margin-left:2px}.group-header-title{margin-left:4px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.group-header-differentiator{font-weight:normal;color:var(--sys-color-state-disabled);margin-left:8px}.group-hover-actions{display:flex;align-items:center;justify-content:right;font-size:10px;font-weight:500}.breakpoint-item-location-or-actions{min-width:20px;flex:0 0 auto;display:flex;padding-left:8px;justify-content:right}button{cursor:pointer;width:13px;height:13px;border:none;background-color:transparent;display:none;align-items:center;justify-content:center}button + span{padding-left:6px}button + button{padding-left:11px}summary:hover button{display:flex}devtools-icon{width:16px;height:16px;button:hover &{color:var(--icon-default-hover)}}.type-indicator{--override-color-conditional-breakpoint:var(--ref-palette-orange70);--override-color-logpoint:var(--ref-palette-pink60);border-right:4px solid;border-radius:0 2px 2px 0;border-color:transparent;height:16px}.breakpoint-item{display:flex;align-items:center;line-height:13px;height:20px;padding-right:8px}.breakpoint-item.hit{background-color:var(--sys-color-yellow-container);color:var(--sys-color-on-yellow-container)}.breakpoint-item.hit:focus{background-color:var(--sys-color-tonal-container)}.theme-with-dark-background .type-indicator,\n:host-context(.theme-with-dark-background) .type-indicator{--override-color-conditional-breakpoint:var(--ref-palette-yellow60);--override-color-logpoint:var(--ref-palette-pink70)}.breakpoint-item.logpoint > label > .type-indicator{border-color:var(--override-color-logpoint)}.breakpoint-item.conditional-breakpoint > label > .type-indicator{border-color:var(--override-color-conditional-breakpoint)}.checkbox-label{display:flex;align-items:center}.checkbox-label > input{margin-left:16px;margin-right:6px}devtools-icon[name="file-script"]{color:var(--icon-file-script);width:18px;height:18px;summary:hover &{display:none}}input.group-checkbox{margin:0;display:none}summary:hover .group-checkbox{display:flex}.location{line-height:14px;text-overflow:ellipsis;overflow:hidden}.breakpoint-item:hover button{display:flex}.pause-on-uncaught-exceptions{margin-top:3px}.pause-on-caught-exceptions{margin-bottom:3px}input:disabled + span{color:var(--sys-color-state-disabled)}.pause-on-caught-exceptions > .checkbox-label > input,\n.pause-on-uncaught-exceptions > .checkbox-label > input{margin-left:6px}.pause-on-caught-exceptions > .checkbox-label > span,\n.pause-on-uncaught-exceptions > .checkbox-label > span{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.pause-on-uncaught-exceptions,\n.pause-on-caught-exceptions{line-height:13px;height:18px;padding-right:8px;& > label{width:fit-content}}details > summary:focus,\n.breakpoint-item:focus,\n.pause-on-uncaught-exceptions:focus,\n.pause-on-caught-exceptions:focus{background-color:var(--sys-color-tonal-container);outline-width:0}\n/*# sourceURL=${import.meta.resolve("./breakpointsView.css")} */\n`};const f=e=>null!==e.getAttribute("data-first-pause")||null!==e.getAttribute("data-last-pause"),x=e=>!(e=>"treeitem"===e.getAttribute("role"))(e),y=e=>null!==e.getAttribute("open"),w=e=>e.querySelector("[data-first-breakpoint]"),S=e=>{const t=E(e);return t&&t instanceof HTMLDetailsElement?t?.querySelector("summary"):null},C=e=>e.querySelector("summary"),E=e=>{const t=e.nextElementSibling;return t&&t instanceof HTMLDetailsElement?t:null};async function I(e,t,i){if(f(e))return function(e,t){console.assert(f(e));let i=null;switch(t){case"ArrowUp":{const t=e.previousElementSibling;t instanceof HTMLElement&&(i=t,console.assert(f(i)));break}case"ArrowDown":{const t=e.nextElementSibling;if(t instanceof HTMLElement)if("tree"===t.getAttribute("role")){const e=t.querySelector("[data-first-group]");e&&(i=C(e))}else i=t,console.assert(f(i));break}}return i}(e,t);const n=e.parentElement;if(!(n&&n instanceof HTMLDetailsElement))throw new Error("The selected nodes should be direct children of an HTMLDetails element.");let o=null;switch(t){case"ArrowLeft":if(!x(e))return C(n);y(n)&&await i(n,!1);break;case"ArrowRight":if(x(e)){if(y(n))return w(n);await i(n,!0)}break;case"ArrowDown":if(x(e))o=y(n)?w(n):S(n);else{const t=e.nextElementSibling;o=t&&t instanceof HTMLDivElement?t:S(n)}break;case"ArrowUp":if(x(e)){const e=(e=>{const t=e.previousElementSibling;return t&&t instanceof HTMLDetailsElement?t:null})(n);if(e)o=y(e)?(e=>e.querySelector("[data-last-breakpoint]"))(e):C(e);else{const e=n.parentElement?.previousElementSibling;e instanceof HTMLElement&&(o=e)}}else{const t=e.previousElementSibling;t instanceof HTMLElement&&(o=t)}}return o}function B(e,t,i){const n=[];let o=t.filter(t=>t!==e);for(let t=i;t<e.length;++t){const i=e[t];if(n.push(i),o=o.filter(e=>e.length>t&&e[t]===i),0===o.length)break}return n}function T(t,n){const o=t.map(t=>{const n=e.ParsedURL.ParsedURL.fromString(t)?.folderPathComponents.slice(1);return i(n),n.split("/").reverse()}),s=function(e){const t=e[0];let i=-1;for(let n=0;n<t.length&&-1===i;++n){const o=t[n];for(let t=1;t<e.length;++t){const s=e[t];if(s.length<=n||s[n]!==o){i=n;break}}}return-1===i?t.length:i}(o);for(let e=0;e<o.length;++e){const i=B(o[e],o,s).reverse().join("/");0===s?n.set(t[e],i+"/"):n.set(t[e],i+"/â€¦/")}console.assert(new Set(n.values()).size===t.length,"Differentiators should be unique.")}function L(e){const t=new Map,i=new Map;for(const{name:i,url:n}of e)t.has(i)||t.set(i,[]),t.get(i)?.push(n);for(const e of t.values())e.length>1&&T(e,i);return i}var $=Object.freeze({__proto__:null,findNextNodeForKeyboardNavigation:I,getDifferentiatingPathMap:L});const A=new CSSStyleSheet;A.replaceSync(v.cssText);const{html:O,Directives:{ifDefined:M,repeat:D,classMap:H,live:R}}=g,j={pauseOnUncaughtExceptions:"Pause on uncaught exceptions",pauseOnCaughtExceptions:"Pause on caught exceptions",checked:"checked",unchecked:"unchecked",indeterminate:"mixed",breakpointHit:"{PH1} breakpoint hit",removeAllBreakpointsInFile:"Remove all breakpoints in file",disableAllBreakpointsInFile:"Disable all breakpoints in file",enableAllBreakpointsInFile:"Enable all breakpoints in file",editCondition:"Edit condition",editLogpoint:"Edit logpoint",disableAllBreakpoints:"Disable all breakpoints",enableAllBreakpoints:"Enable all breakpoints",removeBreakpoint:"Remove breakpoint",removeAllBreakpoints:"Remove all breakpoints",removeOtherBreakpoints:"Remove other breakpoints",revealLocation:"Reveal location",conditionCode:"Condition: {PH1}",logpointCode:"Logpoint: {PH1}"},N=n.i18n.registerUIStrings("panels/sources/components/BreakpointsView.ts",j),P=n.i18n.getLocalizedString.bind(void 0,N);let F,U;class W{#e;#t=new WeakMap;#i;#n;#o;#s;#a;#r;#l=!1;#c=!1;constructor(t,i){this.#s=e.Settings.Settings.instance().createSetting("collapsed-files",[]),this.#a=new Set(this.#s.get()),this.#e=t,this.#e.addEventListener(s.BreakpointManager.Events.BreakpointAdded,this.#d,this),this.#e.addEventListener(s.BreakpointManager.Events.BreakpointRemoved,this.#p,this),this.#i=i.moduleSetting("breakpoints-active"),this.#i.addChangeListener(this.update,this),this.#n=i.moduleSetting("pause-on-uncaught-exception"),this.#n.addChangeListener(this.update,this),this.#o=i.moduleSetting("pause-on-caught-exception"),this.#o.addChangeListener(this.update,this)}static instance({forceNew:t,breakpointManager:i,settings:n}={forceNew:null,breakpointManager:s.BreakpointManager.BreakpointManager.instance(),settings:e.Settings.Settings.instance()}){return U&&!t||(U=new W(i,n)),U}static removeInstance(){U=null}static targetSupportsIndependentPauseOnExceptionToggles(){return!a.TargetManager.TargetManager.instance().targets().some(e=>e.type()===a.Target.Type.NODE)}flavorChanged(e){this.update()}breakpointEditFinished(e,i){this.#r&&this.#r===e&&(i&&t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointConditionEditedFromSidebar),this.#r=void 0)}breakpointStateChanged(e,t){this.#h(e).forEach(e=>{e.breakpoint.setEnabled(t)})}async breakpointEdited(t,i){const n=this.#h(t);let o;for(const e of n)(!o||e.uiLocation.compareTo(o.uiLocation)<0)&&(o=e);o&&(i&&(this.#r=o.breakpoint),await e.Revealer.reveal(o))}breakpointsRemoved(e){e.flatMap(e=>this.#h(e)).forEach(e=>e?.breakpoint.remove(!1))}expandedStateChanged(e,t){t?this.#a.delete(e):this.#a.add(e),this.#u()}async jumpToSource(t){const i=this.#h(t).map(e=>e.uiLocation);let n;for(const e of i)(!n||e.compareTo(n)<0)&&(n=e);n&&await e.Revealer.reveal(n)}setPauseOnUncaughtExceptions(e){this.#n.set(e)}setPauseOnCaughtExceptions(e){this.#o.set(e)}async update(){if(this.#l=!0,!this.#c){for(this.#c=!0;this.#l;){this.#l=!1;const e=await this.getUpdatedBreakpointViewData();_.instance().data=e}this.#c=!1}}async getUpdatedBreakpointViewData(){const e=this.#i.get(),t=W.targetSupportsIndependentPauseOnExceptionToggles(),i=this.#n.get(),n=this.#o.get(),o=this.#m();if(!o.length)return{breakpointsActive:e,pauseOnCaughtExceptions:n,pauseOnUncaughtExceptions:i,independentPauseToggles:t,groups:[]};const s=this.#g(o),a=this.#b(o),[r,c]=await Promise.all([this.#k(s),this.#v()]),d=new Map;for(let e=0;e<s.length;e++){const t=s[e],i=t[0],n=i.uiLocation.uiSourceCode.url(),o=i.uiLocation.uiSourceCode.canonicalScriptId(),p=i.uiLocation,h=null!==c&&t.some(e=>e.uiLocation.id()===c.id()),u=a.get(p.lineId()).size>1,m=p.lineAndColumnText(u),g=r[e],b=g instanceof l.WasmDisassembly.WasmDisassembly?g.lines[g.bytecodeOffsetToLineNumber(p.columnNumber??0)]??"":g.textObj.lineAt(p.lineNumber);h&&this.#a.has(n)&&(this.#a.delete(n),this.#u());const k=!this.#a.has(n),v=this.#f(t),{type:f,hoverText:x}=this.#x(t),y={id:i.breakpoint.breakpointStorageId(),location:m,codeSnippet:b,isHit:h,status:v,type:f,hoverText:x};this.#t.set(y,t);let w=d.get(o);if(w)w.breakpointItems.push(y),w.expanded||=k;else{const e=this.#e.supportsConditionalBreakpoints(p.uiSourceCode);w={url:n,name:p.uiSourceCode.displayName(),editable:e,expanded:k,breakpointItems:[y]},d.set(o,w)}}return{breakpointsActive:e,pauseOnCaughtExceptions:n,pauseOnUncaughtExceptions:i,independentPauseToggles:t,groups:Array.from(d.values())}}#d(e){const t=e.data.breakpoint;return"USER_ACTION"===t.origin&&this.#a.has(t.url())&&(this.#a.delete(t.url()),this.#u()),this.update()}#p(e){const t=e.data.breakpoint;return this.#a.has(t.url())&&(s.BreakpointManager.BreakpointManager.instance().allBreakpointLocations().some(e=>e.breakpoint.url()===t.url())||(this.#a.delete(t.url()),this.#u())),this.update()}#u(){this.#s.set(Array.from(this.#a.values()))}#x(e){const t=e.find(e=>Boolean(e.breakpoint.condition())),i=t?.breakpoint;if(!i||!i.condition())return{type:"REGULAR_BREAKPOINT"};const n=i.condition();return i.isLogpoint()?{type:"LOGPOINT",hoverText:n}:{type:"CONDITIONAL_BREAKPOINT",hoverText:n}}#h(e){const t=this.#t.get(e);return i(t),t}async#v(){const e=u.Context.Context.instance().flavor(a.DebuggerModel.DebuggerPausedDetails);return e?.callFrames.length?await r.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.callFrames[0].location()):null}#m(){const e=this.#e.allBreakpointLocations().filter(e=>e.uiLocation.uiSourceCode.project().type()!==c.Workspace.projectTypes.Debugger);e.sort((e,t)=>e.uiLocation.compareTo(t.uiLocation));const t=[];let i=null,n=null;for(const o of e)(o.breakpoint!==i||n&&o.uiLocation.compareTo(n))&&(t.push(o),i=o.breakpoint,n=o.uiLocation);return t}#g(e){const t=new o.MapUtilities.Multimap;for(const i of e){const e=i.uiLocation;t.set(e.id(),i)}const i=[];for(const e of t.keysArray()){const n=Array.from(t.get(e));n.length&&i.push(n)}return i}#b(e){const t=new o.MapUtilities.Multimap;for(const i of e){const e=i.uiLocation;t.set(e.lineId(),e.id())}return t}#f(e){const t=e.some(e=>e.breakpoint.enabled()),i=e.some(e=>!e.breakpoint.enabled());let n;return n=t?i?"INDETERMINATE":"ENABLED":"DISABLED",n}#k(e){return Promise.all(e.map(async([{uiLocation:{uiSourceCode:e}}])=>{const t=await e.requestContentData({cachedWasmOnly:!0});return l.ContentData.ContentData.contentDataOrEmpty(t)}))}}class _ extends p.LegacyWrapper.WrappableComponent{#y;static instance({forceNew:e}={forceNew:!1}){return F&&!e||(F=p.LegacyWrapper.legacyWrapper(u.Widget.Widget,new _)),F.getComponent()}constructor(){super(),this.#y=W.instance(),this.setAttribute("jslog",`${m.section("sources.js-breakpoints")}`),this.#y.update()}#w=this.attachShadow({mode:"open"});#E=!1;#S=!1;#$=!1;#C=!0;#L=[];#I=new Map;set data(e){this.#E=e.pauseOnUncaughtExceptions,this.#S=e.pauseOnCaughtExceptions,this.#$=e.independentPauseToggles,this.#C=e.breakpointsActive,this.#L=e.groups;const t=[];for(const i of e.groups)t.push({name:i.name,url:i.url});this.#I=L(t),this.render()}connectedCallback(){this.#w.adoptedStyleSheets=[d.checkboxStyles,A]}async render(){await h.write("BreakpointsView render",()=>{const e=async e=>{const t=e.currentTarget;await this.#T(t),e.consume()},t=(this.#$||this.#E)&&this.#S,i=!this.#$&&!this.#E,n=O`
        <div class='pause-on-uncaught-exceptions'
            tabindex='0'
            @click=${e}
            @keydown=${this.#A}
            role='checkbox'
            aria-checked=${this.#E}
            data-first-pause>
          <label class='checkbox-label'>
            <input type='checkbox' tabindex=-1 class="small" ?checked=${this.#E} @change=${this.#j.bind(this)} jslog=${m.toggle("pause-uncaught").track({change:!0})}>
            <span>${P(j.pauseOnUncaughtExceptions)}</span>
          </label>
        </div>
        <div class='pause-on-caught-exceptions'
              tabindex='-1'
              @click=${e}
              @keydown=${this.#A}
              role='checkbox'
              aria-checked=${t}
              data-last-pause>
            <label class='checkbox-label'>
              <input data-pause-on-caught-checkbox type='checkbox' class="small" tabindex=-1 ?checked=${t} ?disabled=${i} @change=${this.#B.bind(this)} jslog=${m.toggle("pause-on-caught-exception").track({change:!0})}>
              <span>${P(j.pauseOnCaughtExceptions)}</span>
            </label>
        </div>
        <div role=tree>
          ${D(this.#L,e=>e.url,(e,t)=>O`${this.#M(e,t)}`)}
        </div>`;g.render(n,this.#w,{host:this})}),await h.write("BreakpointsView make pause-on-exceptions focusable",()=>{if(null===this.#w.querySelector('[tabindex="0"]')){const e=this.#w.querySelector("[data-first-pause]");e?.setAttribute("tabindex","0")}})}async#A(e){if(e.target&&e.target instanceof HTMLElement){if("Home"===e.key||"End"===e.key)return e.consume(!0),await this.#O(e.key);if(o.KeyboardUtilities.keyIsArrowKey(e.key))return e.consume(!0),await this.#P(e.key,e.target);if(o.KeyboardUtilities.isEnterOrSpaceKey(e)){const t=e.currentTarget;await this.#T(t);const i=t.querySelector("input");i&&i.click(),e.consume()}}}async#T(e){e&&h.write("BreakpointsView focus on selected element",()=>{const t=this.#w.querySelector('[tabindex="0"]');t?.setAttribute("tabindex","-1"),e.setAttribute("tabindex","0"),e.focus()})}async#P(e,t){const i=await I(t,e,(e,t)=>t?h.write("BreakpointsView expand",()=>{e.setAttribute("open","")}):h.write("BreakpointsView expand",()=>{e.removeAttribute("open")}));return await this.#T(i)}async#O(e){if("Home"===e){const e=this.#w.querySelector("[data-first-pause]");return await this.#T(e)}if("End"===e){const e=this.#L.length;if(0===e){const e=this.#w.querySelector("[data-last-pause]");return await this.#T(e)}const t=e-1;if(this.#L[t].expanded){const e=this.#w.querySelector("[data-last-group] > [data-last-breakpoint]");return await this.#T(e)}const i=this.#w.querySelector("[data-last-group] > summary");return await this.#T(i)}}#D(e){const t="LOGPOINT"===e.type?P(j.editLogpoint):P(j.editCondition);return O`
    <button data-edit-breakpoint @click=${t=>{this.#y.breakpointEdited(e,!0),t.consume()}} title=${t} jslog=${m.action("edit-breakpoint").track({click:!0})}>
      <devtools-icon name="edit"></devtools-icon>
    </button>
      `}#N(e,i,n){return O`
    <button data-remove-breakpoint @click=${i=>{t.userMetrics.actionTaken(n),this.#y.breakpointsRemoved(e),i.consume()}} title=${i} aria-label=${i} jslog=${m.action("remove-breakpoint").track({click:!0})}>
      <devtools-icon name="bin"></devtools-icon>
    </button>
      `}#R(e,i){const{breakpointItems:n}=i,o=new u.ContextMenu.ContextMenu(e);o.defaultSection().appendItem(P(j.removeAllBreakpointsInFile),()=>{t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointsInFileRemovedFromContextMenu),this.#y.breakpointsRemoved(n)},{jslogContext:"remove-file-breakpoints"});const s=this.#L.filter(e=>e!==i);o.defaultSection().appendItem(P(j.removeOtherBreakpoints),()=>{const e=s.map(({breakpointItems:e})=>e).flat();this.#y.breakpointsRemoved(e)},{disabled:0===s.length,jslogContext:"remove-other-breakpoints"}),o.defaultSection().appendItem(P(j.removeAllBreakpoints),()=>{const e=this.#L.map(({breakpointItems:e})=>e).flat();this.#y.breakpointsRemoved(e)},{jslogContext:"remove-all-breakpoints"});const a=n.filter(e=>"ENABLED"!==e.status);o.debugSection().appendItem(P(j.enableAllBreakpointsInFile),()=>{t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointsInFileEnabledDisabledFromContextMenu);for(const e of a)this.#y.breakpointStateChanged(e,!0)},{disabled:0===a.length,jslogContext:"enable-file-breakpoints"});const r=n.filter(e=>"DISABLED"!==e.status);o.debugSection().appendItem(P(j.disableAllBreakpointsInFile),()=>{t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointsInFileEnabledDisabledFromContextMenu);for(const e of r)this.#y.breakpointStateChanged(e,!1)},{disabled:0===r.length,jslogContext:"disable-file-breakpoints"}),o.show()}#M(e,i){return O`
      <details class=${H({active:this.#C})}
               ?data-first-group=${0===i}
               ?data-last-group=${i===this.#L.length-1}
               role=group
               aria-label='${e.name}'
               aria-description='${e.url}'
               ?open=${R(e.expanded)}
               @toggle=${t=>{const i=t.target;e.expanded=i.open,this.#y.expandedStateChanged(e.url,e.expanded)}}>
          <summary @contextmenu=${t=>{this.#R(t,e),t.consume()}}
                   tabindex='-1'
                   @keydown=${this.#A}
                   @click=${async e=>{const i=e.currentTarget;await this.#T(i),t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointGroupExpandedStateChanged),e.consume()}}>
            <span class='group-header' aria-hidden=true><span class='group-icon-or-disable'>${this.#H()}${this.#U(e)}</span><span class='group-header-title' title='${e.url}'>${e.name}<span class='group-header-differentiator'>${this.#I.get(e.url)}</span></span></span>
            <span class='group-hover-actions'>
              ${this.#N(e.breakpointItems,P(j.removeAllBreakpointsInFile),t.UserMetrics.Action.BreakpointsInFileRemovedFromRemoveButton)}
            </span>
          </summary>
        ${D(e.breakpointItems,e=>e.id,(t,n)=>this.#z(t,e.editable,i,n))}
      </details>
      `}#U(e){const i=e.breakpointItems.some(e=>"ENABLED"===e.status);return O`
      <input class='group-checkbox small' type='checkbox'
            aria-label=''
            .checked=${i}
            @change=${i=>{t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointsInFileCheckboxToggled);const n=i.target,o=n.checked?"ENABLED":"DISABLED";e.breakpointItems.filter(e=>e.status!==o).forEach(e=>{this.#y.breakpointStateChanged(e,n.checked)}),i.consume()}}
            tabindex=-1
            jslog=${m.toggle("breakpoint-group").track({change:!0})}>
    `}#H(){return O`<devtools-icon name="file-script"></devtools-icon>`}#_(e,i,n){const o=this.#L.map(({breakpointItems:e})=>e).flat(),s=o.filter(e=>e!==i),a=new u.ContextMenu.ContextMenu(e),r="LOGPOINT"===i.type?P(j.editLogpoint):P(j.editCondition);a.revealSection().appendItem(P(j.revealLocation),()=>{this.#y.jumpToSource(i)},{jslogContext:"jump-to-breakpoint"}),a.editSection().appendItem(r,()=>{this.#y.breakpointEdited(i,!1)},{disabled:!n,jslogContext:"edit-breakpoint"}),a.defaultSection().appendItem(P(j.enableAllBreakpoints),o.forEach.bind(o,e=>this.#y.breakpointStateChanged(e,!0)),{disabled:o.every(e=>"ENABLED"===e.status),jslogContext:"enable-all-breakpoints"}),a.defaultSection().appendItem(P(j.disableAllBreakpoints),o.forEach.bind(o,e=>this.#y.breakpointStateChanged(e,!1)),{disabled:o.every(e=>"DISABLED"===e.status),jslogContext:"disable-all-breakpoints"}),a.footerSection().appendItem(P(j.removeBreakpoint),()=>{t.userMetrics.actionTaken(t.UserMetrics.Action.BreakpointRemovedFromContextMenu),this.#y.breakpointsRemoved([i])},{jslogContext:"remove-breakpoint"}),a.footerSection().appendItem(P(j.removeOtherBreakpoints),()=>{this.#y.breakpointsRemoved(s)},{disabled:0===s.length,jslogContext:"remove-other-breakpoints"}),a.footerSection().appendItem(P(j.removeAllBreakpoints),()=>{const e=this.#L.map(({breakpointItems:e})=>e).flat();this.#y.breakpointsRemoved(e)},{jslogContext:"remove-all-breakpoints"}),a.show()}#z(e,i,n,s){const a=this.#F(e),r=o.StringUtilities.trimEndWithMaxLength(e.codeSnippet,200),l=this.#W(e.type,e.hoverText),c=this.#L[n].breakpointItems;return O`
    <div class=${H({"breakpoint-item":!0,hit:e.isHit,"conditional-breakpoint":"CONDITIONAL_BREAKPOINT"===e.type,logpoint:"LOGPOINT"===e.type})}
         ?data-first-breakpoint=${0===s}
         ?data-last-breakpoint=${s===c.length-1}
         aria-label=${a}
         role=treeitem
         tabindex='-1'
         @contextmenu=${t=>{this.#_(t,e,i),t.consume()}}
         @click=${async e=>{const t=e.currentTarget;await this.#T(t),e.consume()}}
         @keydown=${this.#A}>
      <label class='checkbox-label'>
        <span class='type-indicator'></span>
        <input type='checkbox'
              aria-label=${e.location}
              class='small'
              ?indeterminate=${"INDETERMINATE"===e.status}
              .checked=${"ENABLED"===e.status}
              @change=${t=>this.#q(t,e)}
              tabindex=-1
              jslog=${m.toggle("breakpoint").track({change:!0})}>
      </label>
      <span class='code-snippet' @click=${t=>{this.#y.jumpToSource(e),t.consume()}} title=${M(l)} jslog=${m.action("sources.jump-to-breakpoint").track({click:!0})}>${r}</span>
      <span class='breakpoint-item-location-or-actions'>
        ${i?this.#D(e):g.nothing}
        ${this.#N([e],P(j.removeBreakpoint),t.UserMetrics.Action.BreakpointRemovedFromRemoveButton)}
        <span class='location'>${e.location}</span>
      </span>
    </div>
    `}#W(e,t){switch(e){case"REGULAR_BREAKPOINT":return;case"CONDITIONAL_BREAKPOINT":return i(t),P(j.conditionCode,{PH1:t});case"LOGPOINT":return i(t),P(j.logpointCode,{PH1:t})}}#F(e){let t;switch(e.status){case"ENABLED":t=P(j.checked);break;case"DISABLED":t=P(j.unchecked);break;case"INDETERMINATE":t=P(j.indeterminate)}return e.isHit?P(j.breakpointHit,{PH1:t}):t}#q(e,t){const i=e.target;this.#y.breakpointStateChanged(t,i.checked)}#B(e){const{checked:t}=e.target;this.#y.setPauseOnCaughtExceptions(t)}#j(e){const{checked:t}=e.target;if(!this.#$){const e=this.#w.querySelector("[data-pause-on-caught-checkbox]");i(e),!t&&e.checked&&e.click(),h.write("BreakpointsView update pause-on-uncaught-exception",()=>{e.disabled=!t})}this.#y.setPauseOnUncaughtExceptions(t)}}customElements.define("devtools-breakpoint-view",_);var G=Object.freeze({__proto__:null,BreakpointsSidebarController:W,BreakpointsView:_}),V={cssText:`:host{flex-grow:1;padding:6px}.row{display:flex;flex-direction:row;color:var(--sys-color-token-property-special);font-family:var(--monospace-font-family);font-size:var(--monospace-font-size);align-items:center;line-height:24px}.row devtools-button{line-height:1;margin-left:0.1em}.row devtools-button:nth-of-type(1){margin-left:0.8em}.padded{margin-left:2em}.separator{margin-right:0.5em;color:var(--sys-color-on-surface)}.editable{cursor:text;color:var(--sys-color-on-surface);overflow-wrap:break-word;min-height:18px;line-height:18px;min-width:0.5em;background:transparent;border:none;outline:none;display:inline-block}.editable.red{color:var(--sys-color-token-property-special)}.editable:hover,\n.editable:focus{border:1px solid var(--sys-color-neutral-outline);border-radius:2px}.row .inline-button{opacity:0%;visibility:hidden;transition:opacity 200ms}.row:focus-within .inline-button:not([hidden]),\n.row:hover .inline-button:not([hidden]){opacity:100%;visibility:visible}.center-wrapper{height:100%;display:flex;justify-content:center;align-items:center}.centered{margin:1em;max-width:300px;text-align:center}.error-header{font-weight:bold;margin-bottom:1em}.error-body{line-height:1.5em;color:var(--sys-color-token-subtle)}.add-block{margin-top:3px}.header-name,\n.header-value{min-width:min-content}.link{color:var(--sys-color-primary);text-decoration:underline;cursor:pointer;outline-offset:2px;padding:0}.learn-more-row{line-height:24px}\n/*# sourceURL=${import.meta.resolve("./HeadersView.css")} */\n`};const q=new CSSStyleSheet;q.replaceSync(V.cssText);const{html:z}=g,K={addHeader:"Add a header",removeHeader:"Remove this header",removeBlock:"Remove this '`ApplyTo`'-section",errorWhenParsing:"Error when parsing ''{PH1}''.",parsingErrorExplainer:"This is most likely due to a syntax error in ''{PH1}''. Try opening this file in an external editor to fix the error or delete the file and re-create the override.",addOverrideRule:"Add override rule",learnMore:"Learn more"},J=n.i18n.registerUIStrings("panels/sources/components/HeadersView.ts",K),Q=n.i18n.getLocalizedString.bind(void 0,J),X="header value",Y=e=>`header-name-${e}`;class Z extends u.View.SimpleView{#V=new ee;#K;constructor(e){super(n.i18n.lockedString("HeadersView")),this.element.setAttribute("jslog",`${m.pane("headers-view")}`),this.#K=e,this.#K.addEventListener(c.UISourceCode.Events.WorkingCopyChanged,this.#G,this),this.#K.addEventListener(c.UISourceCode.Events.WorkingCopyCommitted,this.#Q,this),this.element.appendChild(this.#V),this.#X()}async#X(){const e=await this.#K.requestContent();this.#J(e.content||"")}#J(e){let t=!1,i=[];e=e||"[]";try{if(i=JSON.parse(e),!i.every(b.NetworkPersistenceManager.isHeaderOverride))throw new Error("Type mismatch after parsing")}catch{console.error("Failed to parse",this.#K.url(),"for locally overriding headers."),t=!0}this.#V.data={headerOverrides:i,uiSourceCode:this.#K,parsingError:t}}#G(){this.#J(this.#K.workingCopy())}#Q(){this.#J(this.#K.workingCopy())}getComponent(){return this.#V}dispose(){this.#K.removeEventListener(c.UISourceCode.Events.WorkingCopyChanged,this.#G,this),this.#K.removeEventListener(c.UISourceCode.Events.WorkingCopyCommitted,this.#Q,this)}}class ee extends HTMLElement{#w=this.attachShadow({mode:"open"});#Y=this.#Z.bind(this);#ee=[];#K=null;#te=!1;#ie=null;#ne="";constructor(){super(),this.#w.addEventListener("focusin",this.#oe.bind(this)),this.#w.addEventListener("focusout",this.#se.bind(this)),this.#w.addEventListener("click",this.#ae.bind(this)),this.#w.addEventListener("input",this.#re.bind(this)),this.#w.addEventListener("keydown",this.#le.bind(this)),this.#w.addEventListener("paste",this.#ce.bind(this)),this.addEventListener("contextmenu",this.#de.bind(this))}connectedCallback(){this.#w.adoptedStyleSheets=[q]}set data(e){this.#ee=e.headerOverrides,this.#K=e.uiSourceCode,this.#te=e.parsingError,k.ScheduledRender.scheduleRender(this,this.#Y)}#le(e){const t=e.target;if(!t.matches(".editable"))return;const i=e;!t.matches(".header-name")||""!==t.innerText||"Enter"!==i.key&&"Tab"!==i.key?"Enter"===i.key?(e.preventDefault(),t.blur(),this.#pe(t)):"Escape"===i.key&&(e.consume(),t.innerText=this.#ne,t.blur(),this.#he(t)):(e.preventDefault(),t.blur())}#pe(e){const t=Array.from(this.#w.querySelectorAll(".editable")),i=t.indexOf(e);-1!==i&&i+1<t.length&&t[i+1].focus()}#ue(e){const t=window.getSelection(),i=document.createRange();i.selectNodeContents(e),t?.removeAllRanges(),t?.addRange(i)}#oe(e){const t=e.target;t.matches(".editable")&&(this.#ue(t),this.#ne=t.innerText)}#se(e){const t=e.target;if(""===t.innerText){const e=t.closest(".row"),i=Number(e.dataset.blockIndex),n=Number(e.dataset.headerIndex);t.matches(".apply-to")?(t.innerText="*",this.#ee[i].applyTo="*",this.#me()):t.matches(".header-name")&&this.#ge(i,n)}const i=window.getSelection();i?.removeAllRanges(),this.#K?.commitWorkingCopy()}#de(e){if(!this.#K)return;const t=new u.ContextMenu.ContextMenu(e);t.appendApplicableItems(this.#K),t.show()}#be(e){const t=new Set(e.map(e=>e.name));let i=1;for(;t.has(Y(i));)i++;return Y(i)}#ae(e){const t=e.target,i=t.closest(".row"),n=Number(i?.dataset.blockIndex||0),o=Number(i?.dataset.headerIndex||0);t.matches(".add-header")?(this.#ee[n].headers.splice(o+1,0,{name:this.#be(this.#ee[n].headers),value:X}),this.#ie={blockIndex:n,headerIndex:o+1},this.#me()):t.matches(".remove-header")?this.#ge(n,o):t.matches(".add-block")?(this.#ee.push({applyTo:"*",headers:[{name:Y(1),value:X}]}),this.#ie={blockIndex:this.#ee.length-1},this.#me()):t.matches(".remove-block")&&(this.#ee.splice(n,1),this.#me())}#ke(e,t){return!(0===t&&1===this.#ee[e].headers.length&&this.#ee[e].headers[t].name===Y(1)&&this.#ee[e].headers[t].value===X)}#ge(e,t){this.#ee[e].headers.splice(t,1),0===this.#ee[e].headers.length&&this.#ee[e].headers.push({name:this.#be(this.#ee[e].headers),value:X}),this.#me()}#re(e){this.#he(e.target)}#he(e){const t=e.closest(".row"),i=Number(t.dataset.blockIndex),n=Number(t.dataset.headerIndex);e.matches(".header-name")&&(this.#ee[i].headers[n].name=e.innerText,this.#me()),e.matches(".header-value")&&(this.#ee[i].headers[n].value=e.innerText,this.#me()),e.matches(".apply-to")&&(this.#ee[i].applyTo=e.innerText,this.#me())}#me(){this.#K?.setWorkingCopy(JSON.stringify(this.#ee,null,2)),t.userMetrics.actionTaken(t.UserMetrics.Action.HeaderOverrideHeadersFileEdited)}#ce(e){const t=e;if(e.preventDefault(),t.clipboardData){const i=t.clipboardData.getData("text/plain"),n=this.#w.getSelection()?.getRangeAt(0);if(!n)return;n.deleteContents();const o=document.createTextNode(i);n.insertNode(o),n.selectNodeContents(o),n.collapse(!1);const s=window.getSelection();s?.removeAllRanges(),s?.addRange(n),this.#he(e.target)}}#Z(){if(!k.ScheduledRender.isScheduledRender(this))throw new Error("HeadersView render was not scheduled");if(this.#te){const e=this.#K?.name()||".headers";g.render(z`
        <div class="center-wrapper">
          <div class="centered">
            <div class="error-header">${Q(K.errorWhenParsing,{PH1:e})}</div>
            <div class="error-body">${Q(K.parsingErrorExplainer,{PH1:e})}</div>
          </div>
        </div>
      `,this.#w,{host:this})}else if(g.render(z`
      ${this.#ee.map((e,t)=>z`
          ${this.#ve(e.applyTo,t)}
          ${e.headers.map((e,i)=>z`
              ${this.#fe(e,t,i)}
            `)}
        `)}
      <devtools-button
          .variant=${"outlined"}
          .jslogContext=${"headers-view.add-override-rule"}
          class="add-block">
        ${Q(K.addOverrideRule)}
      </devtools-button>
      <div class="learn-more-row">
        <x-link
            href="https://goo.gle/devtools-override"
            class="link"
            jslog=${m.link("learn-more").track({click:!0})}>${Q(K.learnMore)}</x-link>
      </div>
    `,this.#w,{host:this}),this.#ie){let e=null;e=this.#ie.headerIndex?this.#w.querySelector(`[data-block-index="${this.#ie.blockIndex}"][data-header-index="${this.#ie.headerIndex}"] .header-name`):this.#w.querySelector(`[data-block-index="${this.#ie.blockIndex}"] .apply-to`),e&&e.focus(),this.#ie=null}}#ve(e,t){return z`
      <div class="row" data-block-index=${t}
           jslog=${m.treeItem("*"===e?e:void 0)}>
        <div>${n.i18n.lockedString("Apply to")}</div>
        <div class="separator">:</div>
        ${this.#xe(e,"apply-to")}
        <devtools-button
        title=${Q(K.removeBlock)}
        .size=${"SMALL"}
        .iconName=${"bin"}
        .iconWidth=${"14px"}
        .iconHeight=${"14px"}
        .variant=${"icon"}
        .jslogContext=${"headers-view.remove-apply-to-section"}
        class="remove-block inline-button"
      ></devtools-button>
      </div>
    `}#fe(e,t,i){return z`
      <div class="row padded" data-block-index=${t} data-header-index=${i}
           jslog=${m.treeItem(e.name).parent("headers-editor-row-parent")}>
        ${this.#xe(e.name,"header-name red",!0)}
        <div class="separator">:</div>
        ${this.#xe(e.value,"header-value")}
        <devtools-button
          title=${Q(K.addHeader)}
          .size=${"SMALL"}
          .iconName=${"plus"}
          .variant=${"icon"}
          .jslogContext=${"headers-view.add-header"}
          class="add-header inline-button"
        ></devtools-button>
        <devtools-button
          title=${Q(K.removeHeader)}
          .size=${"SMALL"}
          .iconName=${"bin"}
          .variant=${"icon"}
          ?hidden=${!this.#ke(t,i)}
          .jslogContext=${"headers-view.remove-header"}
          class="remove-header inline-button"
        ></devtools-button>
      </div>
    `}#xe(e,t,i){const n=i?m.key():m.value();return z`<span jslog=${n.track({change:!0,keydown:"Enter|Escape|Tab",click:!0})}
                              contenteditable="true"
                              class="editable ${t}"
                              tabindex="0"
                              .innerText=${g.Directives.live(e)}></span>`}}m.registerParentProvider("headers-editor-row-parent",e=>{for(;e.previousElementSibling?.classList?.contains("padded");)e=e.previousElementSibling;return e.previousElementSibling||void 0}),customElements.define("devtools-sources-headers-view",ee);var te=Object.freeze({__proto__:null,HeadersView:Z,HeadersViewComponent:ee});export{G as BreakpointsView,$ as BreakpointsViewUtils,te as HeadersView};