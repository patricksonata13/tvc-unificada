"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=getLatestRelease,exports.logIfUpdateAvailable=logIfUpdateAvailable;var _semver=_interopRequireDefault(require("semver")),_util=require("util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const debug=require("debug")("ReactNative:CommunityCliPlugin");async function logIfUpdateAvailable(e,t){const{reactNativeVersion:n}=e;let i=null;try{const e=await getLatestRelease(n);e&&(i=e)}catch(e){debug("Cannot detect current version of React Native, skipping check for a newer release"),debug(e)}null!=i&&_semver.default.gt(i.stable,n)&&t.update({type:"unstable_server_log",level:"info",data:`React Native v${i.stable} is now available (your project is running on v${n}).\nChangelog: ${(0,_util.styleText)(["dim","underline"],i?.changelogUrl??"none")}\nDiff: ${(0,_util.styleText)(["dim","underline"],i?.diffUrl??"none")}\n`})}function isDiffPurgeEntry(e){return 0===[e.name,e.zipball_url,e.tarball_url,e.node_id].filter(e=>void 0!==e).length}async function getLatestRelease(e){debug("Checking for a newer version of React Native");try{if(debug(`Current version: ${e}`),["-canary","-nightly"].some(t=>e.includes(t)))return;debug("Checking for newer releases on GitHub");const t=await getLatestRnDiffPurgeVersion();if(null==t)return void debug("Failed to get latest release");const{stable:n,candidate:i}=t;if(debug(`Latest release: ${n} (${i??""})`),_semver.default.compare(n,e)>=0)return{stable:n,candidate:i,changelogUrl:buildChangelogUrl(n),diffUrl:buildDiffUrl(e,n)}}catch(e){debug("Something went wrong with remote version checking, moving on"),debug(e)}}function buildChangelogUrl(e){return`https://github.com/facebook/react-native/releases/tag/v${e}`}function buildDiffUrl(e,t){return`https://react-native-community.github.io/upgrade-helper/?from=${e}&to=${t}`}async function getLatestRnDiffPurgeVersion(){const e=await fetch("https://api.github.com/repos/react-native-community/rn-diff-purge/tags",{headers:{"User-Agent":"@react-native/community-cli-plugin"}}),t={stable:"0.0.0"};if(200!==e.status)return;const n=(await e.json()).filter(isDiffPurgeEntry);for(const{name:e}of n)if(null!=t.candidate&&e.includes("-rc"))t.candidate=e.substring(8);else if(!e.includes("-rc"))return t.stable=e.substring(8),t;return t}