import*as e from"../../ui/components/icon_button/icon_button.js";import*as t from"../../ui/legacy/legacy.js";import*as i from"../../ui/visual_logging/visual_logging.js";import*as n from"../../core/common/common.js";import*as o from"../../core/host/host.js";import*as r from"../../core/i18n/i18n.js";import*as s from"../../core/platform/platform.js";import*as a from"../../ui/legacy/components/inline_editor/inline_editor.js";import*as l from"../../core/sdk/sdk.js";var d={cssText:`img{max-height:300px;border-radius:2px}.animation-progress{position:absolute;height:2px;bottom:0;left:0;background:var(--legacy-selection-bg-color)}\n/*# sourceURL=${import.meta.resolve("./animationScreenshotPopover.css")} */\n`};class c extends t.Widget.VBox{#t;#e;#i;#n;#s;#o;constructor(t){super(!0),this.registerRequiredCSS(d),console.assert(t.length>0),this.contentElement.classList.add("animation-screenshot-popover"),this.#t=t;for(const e of t)this.contentElement.appendChild(e),e.style.display="none";this.#e=0,this.#i=0,this.#t[0].style.display="block",this.#n=this.contentElement.createChild("div","animation-progress")}wasShown(){super.wasShown(),this.#e=this.contentElement.window().requestAnimationFrame(this.changeFrame.bind(this))}willHide(){this.contentElement.window().cancelAnimationFrame(this.#e),this.#o=void 0}changeFrame(){if(this.#e=this.contentElement.window().requestAnimationFrame(this.changeFrame.bind(this)),this.#o)return void this.#o--;if(this.#s=!this.#s,!this.#s)return;const t=this.#t.length;this.#t[this.#i%t].style.display="none",this.#i++,this.#t[this.#i%t].style.display="block",this.#i%t==t-1&&(this.#o=50),this.#n.style.width=(this.#i%t+1)/t*100+"%"}}var h=Object.freeze({__proto__:null,AnimationScreenshotPopover:c}),m={cssText:`:host{overflow:hidden;--timeline-controls-width:150px}.animation-node-row{width:100%;display:flex;border-bottom:1px dashed var(--sys-color-divider)}.animation-node-description{padding-left:8px;overflow:hidden;position:relative;background-color:var(--sys-color-cdt-base-container);display:flex;flex-direction:column;justify-content:space-around;align-items:flex-start;white-space:nowrap;flex:0 0 var(--timeline-controls-width);z-index:1}.animation-node-description > *{flex:0 0 auto}.animation-timeline-row{height:32px;position:relative}path.animation-keyframe{fill-opacity:20%}.animation-node-selected path.animation-keyframe,\nsvg.animation-ui g:first-child:hover path.animation-keyframe{fill-opacity:40%}line.animation-line{stroke-width:2px;stroke-linecap:round;fill:none}line.animation-delay-line{stroke-width:2px;stroke-dasharray:6,4}line.animation-delay-line.animation-fill{stroke-dasharray:none}circle.animation-keyframe-point{fill:var(--sys-color-cdt-base-container)}circle.animation-endpoint,\ncircle.animation-keyframe-point{stroke-width:2px;transition:transform 100ms cubic-bezier(0,0,0.2,1);transform:scale(1);transform-box:fill-box;transform-origin:50% 50%}circle.animation-endpoint:active,\ncircle.animation-keyframe-point:active{transform:scale(1)}.animation-ui circle.animation-endpoint:hover,\n.animation-ui circle.animation-keyframe-point:hover{transform:scale(1.2)}.animation-name{position:absolute;top:8px;color:var(--sys-color-on-surface);text-align:center;margin-left:-8px;white-space:nowrap}.animation-timeline-toolbar-container{display:flex;background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider);flex:0 0 auto}.animation-timeline-header{height:28px;border-bottom:1px solid var(--sys-color-divider);flex-shrink:0;display:flex}.animation-timeline-header::after{content:'';height:calc(100% - 48px - 28px);position:absolute;width:var(--timeline-controls-width);left:0;margin-top:28px;background-color:var(--sys-color-cdt-base-container);z-index:0;border-right:1px solid var(--sys-color-divider)}.animation-controls{flex:0 0 var(--timeline-controls-width);position:relative;display:flex;justify-content:flex-end;padding-right:8px}.animation-timeline-current-time{flex:0 0 auto;line-height:28px;margin-right:5px}.animation-grid-header{flex:1 0 auto;z-index:2}.animation-grid-header.scrubber-enabled{cursor:pointer}.animation-timeline-buffer{height:48px;flex:0 0 auto;border-bottom:1px solid var(--sys-color-divider);display:flex;padding:0 2px}.animation-timeline-buffer-hint{display:none}.animation-time-overlay{background-color:var(--sys-color-on-surface);opacity:5%;position:absolute;height:100%;width:100%;z-index:-1}.animation-timeline-end > .animation-time-overlay{visibility:hidden}.animation-scrubber{opacity:100%;position:absolute;left:10px;height:100%;width:100%;top:28px;border-left:1px solid var(--sys-color-error);z-index:2}.animation-scrubber-line{width:11px;background:linear-gradient(to right,transparent 5px,var(--sys-color-error) 5px,var(--sys-color-error) 6px,transparent 6px);position:absolute;top:-28px;height:28px;left:-6px;padding:0 5px;z-index:3}.animation-scrubber-head{width:7px;height:7px;transform:rotate(45deg);background:var(--sys-color-error);position:absolute;left:2px;top:1px;z-index:4}.grid-overflow-wrapper{position:absolute;left:calc(var(--timeline-controls-width) - 10px);top:76px;z-index:1;overflow:hidden;width:100%;height:100%}svg.animation-timeline-grid{position:absolute;inset:0;width:100%;height:100%}rect.animation-timeline-grid-line{fill:var(--sys-color-divider)}.animation-timeline-row > svg.animation-ui{position:absolute}.animation-node-timeline{flex-grow:1}.animation-node-description > div{position:absolute;top:50%;transform:translateY(-50%);max-height:100%}.animation-node-removed{filter:saturate(0);cursor:not-allowed}.animation-node-removed-overlay{width:100%;height:100%;z-index:100;cursor:not-allowed}svg.animation-ui g:first-child{opacity:100%}svg.animation-ui circle:focus-visible,\nsvg.animation-ui path:focus-visible{outline:2px solid -webkit-focus-ring-color}.animation-tail-iterations{opacity:50%}.animation-keyframe-step line{stroke-width:2;stroke-opacity:30%}text.animation-timeline-grid-label{font-size:10px;fill:var(--sys-color-token-subtle);text-anchor:middle}@keyframes --full-opacity-for-screenshots-container{from{opacity:100%}to{opacity:100%}}.preview-ui-container{position:relative;& .screenshot-arrow{background-image:var(--image-file-popoverArrows);background-position:0 76px;width:19px;height:19px;position:absolute;left:6px;top:-19px;z-index:100;pointer-events:none}& .screenshots-container{position:absolute;display:none;opacity:0%;left:6px;top:100%;z-index:100;border:1px solid transparent;box-shadow:var(--drop-shadow);border-radius:2px;max-width:220px;max-height:220px}& .screenshots-container.to-the-left{left:unset;right:6px}& .screenshots-container.to-the-left .screenshot-arrow{left:unset;right:6px}&:hover .screenshots-container:not(.no-screenshots){display:block;animation-name:--full-opacity-for-screenshots-container;animation-duration:0s;animation-delay:0.2s;animation-fill-mode:forwards}&:hover .screenshots-container:not(.no-screenshots):hover{display:none}&:has(.selected):hover .screenshots-container:not(.no-screenshots){display:none}}.animation-timeline-rows,\n.animation-timeline-rows-hint,\n.animation-timeline-buffer-hint{flex-grow:1;overflow:hidden auto;z-index:1}.animation-timeline-rows-hint{display:none}.animation-timeline-buffer:not(:empty) ~ .animation-timeline-rows:empty{flex-grow:0}.animation-timeline-rows:empty{display:none}.animation-timeline-buffer:not(:empty)\n  ~ .animation-timeline-rows:empty\n  ~ .animation-timeline-buffer-hint:not(:empty)\n  ~ .animation-timeline-rows-hint,\n.animation-timeline-buffer:empty ~ .animation-timeline-buffer-hint{font-size:14px;display:flex;align-items:center;justify-content:center;margin-left:var(--timeline-controls-width);padding:10px}.animation-controls-toolbar{flex:0 0 auto}.animation-node-row.animation-node-selected{background-color:var(--sys-color-state-ripple-primary)}.animation-node-selected > .animation-node-description{background-color:var(--sys-color-tonal-container)}.animation-buffer-preview{height:40px;margin:4px 2px;background-color:var(--sys-color-neutral-container);border:1px solid transparent;border-radius:2px;flex:1 1;padding:4px;max-width:100px;animation:newGroupAnim 200ms;position:relative}.animation-buffer-preview.no-animation{animation:none}.animation-buffer-preview .preview-icon{position:absolute;width:14px;height:14px;right:1px;bottom:2px;opacity:60%}.animation-buffer-preview-animation{width:100%;height:100%;border-radius:2px 0 0 2px;position:absolute;top:0;left:0;background:var(--sys-color-tonal-container);opacity:0%;border-right:1px solid var(--sys-color-divider)}.animation-buffer-preview:focus-visible{outline:-webkit-focus-ring-color auto 5px}.animation-buffer-preview.selected .preview-icon{opacity:100%}.animation-buffer-preview:not(.selected):focus-visible,\n.animation-buffer-preview:not(.selected):hover{background-color:var(--sys-color-surface-variant);& .preview-icon{opacity:80%}}.animation-buffer-preview.selected{background-color:var(--sys-color-tonal-container)}.animation-paused{align-items:center;justify-content:center;display:none}.animation-paused::before,\n.animation-paused::after{content:'';background:var(--sys-color-cdt-base-container);width:7px;height:20px;border-radius:2px;margin:2px;border:1px solid var(--sys-color-divider)}.animation-buffer-preview.paused .animation-paused{display:flex}.animation-buffer-preview > svg > line{stroke-width:1px}.animation-buffer-preview.selected > svg > line{stroke:var(\n    --sys-color-on-tonal-container\n  )!important}@keyframes newGroupAnim{from{clip-path:polygon(0% 0%,0% 100%,50% 100%,50% 0%)}to{clip-path:polygon(0% 0%,0% 100%,100% 100%,100% 0%)}}.animation-playback-rate-control{margin:4px 0 4px 2px;display:flex;width:120px}.animation-playback-rate-button{border-width:1px;border-style:solid;border-color:var(--sys-color-tonal-outline);border-right-width:0;color:var(--sys-color-on-surface);display:inline-block;margin-right:-1px;padding:1px 4px;background-color:transparent;flex:1 0 auto;text-align:center}.animation-playback-rate-button:first-child{border-radius:4px 0 0 4px}.animation-playback-rate-button:last-child{border-radius:0 4px 4px 0;border-right-width:1px}.animation-playback-rate-button.selected{color:var(--sys-color-on-tonal-container);background-color:var(--sys-color-tonal-container);border-color:var(--sys-color-tonal-container);z-index:1}.animation-playback-rate-button.selected:focus-visible{color:var(--sys-color-on-surface)}.animation-playback-rate-button:focus-visible{outline:2px solid var(--sys-color-primary);outline-offset:2px}.animation-playback-rate-button:not(.selected, [disabled]):hover{background:var(--sys-color-state-hover-on-subtle)}.animation-playback-rate-button[disabled]{background:unset;border-color:var(--sys-color-state-disabled);color:var(--sys-color-state-disabled)}.animation-remove-button{position:absolute;top:-3px;right:-3px;background:var(--sys-color-token-subtle);border-radius:12px;border:0;height:16px;width:16px;z-index:100;display:none;padding:0;& > devtools-icon{height:16px;width:16px;color:var(--sys-color-cdt-base-container)}&:hover{background-color:var(--sys-color-on-surface)}}.animation-buffer-preview:hover .animation-remove-button{display:flex}.timeline-controls-resizer{position:absolute;width:6px;height:100%;left:var(--timeline-controls-width);top:104px;z-index:3;margin-left:-4px}@media (forced-colors: active){.animation-playback-rate-button.selected,\n  .animation-playback-rate-button.selected:first-child,\n  .animation-playback-rate-button.selected:first-child:focus-visible,\n  .animation-playback-rate-button:focus-visible{forced-color-adjust:none;color:HighlightText;background-color:Highlight}.animation-node-description:focus-visible{background-color:var(--sys-color-cdt-base-container);forced-color-adjust:none}.monospace{forced-color-adjust:auto}}\n/*# sourceURL=${import.meta.resolve("./animationTimeline.css")} */\n`};const u={noEffectSelected:"No animation effect selected",selectAnEffectAboveToInspectAnd:"Select an effect above to inspect and modify",clearAll:"Clear all",pauseAll:"Pause all",playbackRates:"Playback rates",playbackRatePlaceholder:"{PH1}%",pause:"Pause",setSpeedToS:"Set speed to {PH1}",animationPreviews:"Animation previews",waitingForAnimations:"Currently waiting for animations",animationDescription:"On this page you can inspect and modify animations.",replayTimeline:"Replay timeline",resumeAll:"Resume all",playTimeline:"Play timeline",pauseTimeline:"Pause timeline",animationPreviewS:"Animation Preview {PH1}"},p=r.i18n.registerUIStrings("panels/animation/AnimationTimeline.ts",u),b=r.i18n.getLocalizedString.bind(void 0,p),f=new WeakMap,v=new WeakMap;let g;class y extends t.Widget.VBox{#a;#r;#l;#h;#d=[];#c;#m;#p;#u;#b;#v;#f;#g;#y;#w;#x;#A;#T;#k;#S;#C;#M;#L;#P;#R;#E;#G;#U;#D;#I;#F;#O;#z;#N;#B;#j;#H=new n.Throttler.Throttler(10);#V=new n.Throttler.Throttler(10);constructor(){super(!0),this.registerRequiredCSS(m),this.element.classList.add("animations-timeline"),this.element.setAttribute("jslog",`${i.panel("animations").track({resize:!0})}`),this.#z=this.contentElement.createChild("div","timeline-controls-resizer"),this.#a=this.contentElement.createChild("div","grid-overflow-wrapper"),this.#r=t.UIUtils.createSVGChild(this.#a,"svg","animation-timeline-grid"),this.#l=1,this.#h=!1,this.#F=!1,this.createHeader(),this.#c=this.contentElement.createChild("div","animation-timeline-rows"),this.#c.setAttribute("jslog",`${i.section("animations")}`);const e=this.contentElement.createChild("div","animation-timeline-buffer-hint"),n=new t.EmptyWidget.EmptyWidget(b(u.waitingForAnimations),b(u.animationDescription));n.appendLink("https://developer.chrome.com/docs/devtools/css/animations"),n.show(e);const s=this.contentElement.createChild("div","animation-timeline-rows-hint");new t.EmptyWidget.EmptyWidget(b(u.noEffectSelected),b(u.selectAnEffectAboveToInspectAnd)).show(s),this.#y=100,this.#w=this.#y,this.#A=new Map,this.#T=[],this.#k=[],this.#j=[],this.#S=new Map,this.#C=new Map,this.#x=150,this.element.style.setProperty("--timeline-controls-width",`${this.#x}px`),l.TargetManager.TargetManager.instance().addModelListener(l.DOMModel.DOMModel,l.DOMModel.Events.NodeRemoved,t=>this.markNodeAsRemoved(t.data.node),this,{scoped:!0}),l.TargetManager.TargetManager.instance().observeModels(l.AnimationModel.AnimationModel,this,{scoped:!0}),t.Context.Context.instance().addFlavorChangeListener(l.DOMModel.DOMNode,this.nodeChanged,this),this.#J()}static instance(t){return g&&!t?.forceNew||(g=new y),g}#J(){let e;t.UIUtils.installDragHandle(this.#z,t=>(e=t.clientX,!0),t=>{if(void 0===e)return;const i=this.#x+t.clientX-e;this.#x=Math.min(Math.max(i,120),720),e=t.clientX,this.element.style.setProperty("--timeline-controls-width",this.#x+"px"),this.onResize()},()=>{e=void 0},"ew-resize")}get previewMap(){return this.#S}get uiAnimations(){return this.#T}get groupBuffer(){return this.#k}wasShown(){super.wasShown();for(const t of l.TargetManager.TargetManager.instance().models(l.AnimationModel.AnimationModel,{scoped:!0}))this.#K(t),this.addEventListeners(t)}willHide(){for(const t of l.TargetManager.TargetManager.instance().models(l.AnimationModel.AnimationModel,{scoped:!0}))this.removeEventListeners(t)}#K(t){for(const e of t.animationGroups.values())this.#S.has(e)||this.addAnimationGroup(e)}#_(){t.ViewManager.ViewManager.instance().moveView("animations","drawer-view",{shouldSelectTab:!0,overrideSaving:!0})}async revealAnimationGroup(t){return this.#S.has(t)||await this.addAnimationGroup(t),this.#_(),await this.selectAnimationGroup(t)}modelAdded(t){this.isShowing()&&this.addEventListeners(t)}modelRemoved(t){this.removeEventListeners(t)}addEventListeners(t){t.addEventListener(l.AnimationModel.Events.AnimationGroupStarted,this.animationGroupStarted,this),t.addEventListener(l.AnimationModel.Events.AnimationGroupUpdated,this.animationGroupUpdated,this),t.addEventListener(l.AnimationModel.Events.ModelReset,this.reset,this)}removeEventListeners(t){t.removeEventListener(l.AnimationModel.Events.AnimationGroupStarted,this.animationGroupStarted,this),t.removeEventListener(l.AnimationModel.Events.AnimationGroupUpdated,this.animationGroupUpdated,this),t.removeEventListener(l.AnimationModel.Events.ModelReset,this.reset,this)}nodeChanged(){for(const t of this.#A.values())t.nodeChanged()}createScrubber(){return this.#u=document.createElement("div"),this.#u.classList.add("animation-scrubber"),this.#u.classList.add("hidden"),this.#M=this.#u.createChild("div","animation-scrubber-line"),this.#M.createChild("div","animation-scrubber-head"),this.#u.createChild("div","animation-time-overlay"),this.#u}createHeader(){const e=this.contentElement.createChild("div","animation-timeline-toolbar-container");e.setAttribute("jslog",`${i.toolbar()}`),e.role="toolbar";const n=e.createChild("devtools-toolbar","animation-timeline-toolbar");n.role="presentation",this.#v=new t.Toolbar.ToolbarButton(b(u.clearAll),"clear",void 0,"animations.clear"),this.#v.addEventListener("Click",()=>{o.userMetrics.actionTaken(o.UserMetrics.Action.AnimationGroupsCleared),this.reset()}),n.appendToolbarItem(this.#v),n.appendSeparator(),this.#L=new t.Toolbar.ToolbarToggle(b(u.pauseAll),"pause","resume","animations.pause-resume-all"),this.#L.addEventListener("Click",()=>{this.togglePauseAll()}),n.appendToolbarItem(this.#L);const s=e.createChild("div","animation-playback-rate-control");s.addEventListener("keydown",this.handlePlaybackRateControlKeyDown.bind(this)),t.ARIAUtils.markAsListBox(s),t.ARIAUtils.setLabel(s,b(u.playbackRates)),this.#m=[];for(const e of w){const n=s.createChild("button","animation-playback-rate-button");n.textContent=e?b(u.playbackRatePlaceholder,{PH1:100*e}):b(u.pause),n.setAttribute("jslog",`${i.action().context("animations.playback-rate-"+100*e).track({click:!0,keydown:"ArrowUp|ArrowDown|ArrowLeft|ArrowRight"})}`),v.set(n,e),n.addEventListener("click",this.setPlaybackRate.bind(this,e)),t.ARIAUtils.markAsOption(n),t.Tooltip.Tooltip.install(n,b(u.setSpeedToS,{PH1:n.textContent})),n.tabIndex=-1,this.#m.push(n)}this.updatePlaybackControls(),this.#p=this.contentElement.createChild("div","animation-timeline-buffer"),this.#p.setAttribute("jslog",`${i.section("film-strip")}`),t.ARIAUtils.markAsListBox(this.#p),t.ARIAUtils.setLabel(this.#p,b(u.animationPreviews));const a=this.contentElement.createChild("div","animation-timeline-header"),r=a.createChild("div","animation-controls");this.#b=r.createChild("div","animation-timeline-current-time monospace");const l=r.createChild("devtools-toolbar","animation-controls-toolbar");return this.#P=new t.Toolbar.ToolbarButton(b(u.replayTimeline),"replay",void 0,"animations.play-replay-pause-animation-group"),this.#P.element.classList.add("toolbar-state-on"),this.#R="replay-outline",this.#P.addEventListener("Click",this.controlButtonToggle.bind(this)),l.appendToolbarItem(this.#P),this.#N=a.createChild("div","animation-grid-header"),this.#N.setAttribute("jslog",`${i.timeline("animations.grid-header").track({drag:!0,click:!0})}`),t.UIUtils.installDragHandle(this.#N,this.scrubberDragStart.bind(this),this.scrubberDragMove.bind(this),this.scrubberDragEnd.bind(this),null),this.#a.appendChild(this.createScrubber()),this.clearCurrentTimeText(),a}handlePlaybackRateControlKeyDown(t){switch(t.key){case"ArrowLeft":case"ArrowUp":this.focusNextPlaybackRateButton(t.target,!0);break;case"ArrowRight":case"ArrowDown":this.focusNextPlaybackRateButton(t.target)}}focusNextPlaybackRateButton(t,e){const i=t,n=this.#m.indexOf(i),s=e?n-1:n+1;if(s<0||s>=this.#m.length)return;const o=this.#m[s];o.tabIndex=0,o.focus(),t&&(t.tabIndex=-1)}togglePauseAll(){this.#h=!this.#h,o.userMetrics.actionTaken(this.#h?o.UserMetrics.Action.AnimationsPaused:o.UserMetrics.Action.AnimationsResumed),this.setPlaybackRate(this.#l),this.#L&&this.#L.setTitle(this.#h?b(u.resumeAll):b(u.pauseAll))}setPlaybackRate(t){t!==this.#l&&o.userMetrics.animationPlaybackRateChanged(.1===t?2:.25===t?1:1===t?0:3),this.#l=t;for(const t of l.TargetManager.TargetManager.instance().models(l.AnimationModel.AnimationModel,{scoped:!0}))t.setPlaybackRate(this.#h?0:this.#l);o.userMetrics.actionTaken(o.UserMetrics.Action.AnimationsPlaybackRateChanged),this.#U&&(this.#U.playbackRate=this.effectivePlaybackRate()),this.updatePlaybackControls()}updatePlaybackControls(){for(const t of this.#m){const e=this.#l===v.get(t);t.classList.toggle("selected",e),t.tabIndex=e?0:-1}}controlButtonToggle(){"play-outline"===this.#R?this.togglePause(!1):"replay-outline"===this.#R?(o.userMetrics.actionTaken(o.UserMetrics.Action.AnimationGroupReplayed),this.replay()):this.togglePause(!0)}updateControlButton(){this.#P&&(this.#P.setEnabled(Boolean(this.#f)&&this.hasAnimationGroupActiveNodes()&&!this.#f?.isScrollDriven()),this.#f&&this.#f.paused()?(this.#R="play-outline",this.#P.element.classList.toggle("toolbar-state-on",!0),this.#P.setTitle(b(u.playTimeline)),this.#P.setGlyph("play")):!this.#U||!this.#U.currentTime||"number"!=typeof this.#U.currentTime||this.#U.currentTime>=this.duration()?(this.#R="replay-outline",this.#P.element.classList.toggle("toolbar-state-on",!0),this.#P.setTitle(b(u.replayTimeline)),this.#P.setGlyph("replay")):(this.#R="pause-outline",this.#P.element.classList.toggle("toolbar-state-on",!1),this.#P.setTitle(b(u.pauseTimeline)),this.#P.setGlyph("pause")))}effectivePlaybackRate(){return this.#h||this.#f&&this.#f.paused()?0:this.#l}togglePause(t){if(this.#f){this.#f.togglePause(t);const e=this.#S.get(this.#f);e&&e.element.classList.toggle("paused",t)}this.#U&&(this.#U.playbackRate=this.effectivePlaybackRate()),this.updateControlButton()}replay(){this.#f&&this.hasAnimationGroupActiveNodes()&&!this.#f.isScrollDriven()&&(this.#f.seekTo(0),this.animateTime(0),this.updateControlButton())}duration(){return this.#w}setDuration(t){this.#w=t,this.scheduleRedraw()}clearTimeline(){this.#f&&this.#B&&this.#f.scrollNode().then(t=>{t?.removeScrollEventListener(this.#B),this.#B=void 0}),this.#T=[],this.#A.clear(),this.#C.clear(),this.#c.removeChildren(),this.#w=this.#y,this.#u.classList.add("hidden"),this.#N.classList.remove("scrubber-enabled"),this.#f=null,this.#U&&this.#U.cancel(),this.#U=void 0,this.clearCurrentTimeText(),this.updateControlButton()}reset(){this.clearTimeline(),this.setPlaybackRate(this.#l);for(const t of this.#k)t.release();this.#k=[],this.clearPreviews(),this.renderGrid()}animationGroupStarted({data:t}){this.addAnimationGroup(t)}scheduledRedrawAfterAnimationGroupUpdatedForTest(){}animationGroupUpdated({data:t}){this.#V.schedule(async()=>{const e=this.#S.get(t);if(e&&e.replay(),this.#f===t){if(t.isScrollDriven()){const e=await t.scrollNode();if(e){const i="vertical"===t.scrollOrientation()?await e.verticalScrollRange():await e.horizontalScrollRange(),n="vertical"===t.scrollOrientation()?await e.scrollTop():await e.scrollLeft();null!==i&&this.setDuration(i),null!==n&&(this.setCurrentTimeText(n),this.setTimelineScrubberPosition(n))}}else this.setDuration(t.finiteDuration());this.updateControlButton(),this.scheduleRedraw(),this.scheduledRedrawAfterAnimationGroupUpdatedForTest()}})}clearPreviews(){this.#S.clear(),this.#d.forEach(t=>{t.detach()}),this.#p.removeChildren(),this.#d=[]}createPreview(e){const i=new R(e),n=document.createElement("div");n.classList.add("preview-ui-container"),n.appendChild(i.element);const s=document.createElement("div");if(s.classList.add("screenshots-container","no-screenshots"),s.createChild("span","screenshot-arrow"),s.addEventListener("animationend",()=>{const{right:t,left:e,width:i}=s.getBoundingClientRect();t>window.innerWidth&&e-i>=0&&s.classList.add("to-the-left")}),n.appendChild(s),this.#k.push(e),this.#S.set(e,i),this.#p.appendChild(n),i.removeButton().addEventListener("click",this.removeAnimationGroup.bind(this,e)),i.element.addEventListener("click",this.selectAnimationGroup.bind(this,e)),i.element.addEventListener("keydown",this.handleAnimationGroupKeyDown.bind(this,e)),i.element.addEventListener("mouseover",()=>{const t=e.screenshots();if(!t.length)return;s.classList.remove("no-screenshots");const i=()=>{const e=new c(t);this.#d.push(e),e.show(s)};t[0].complete?i():t[0].onload=i},{once:!0}),t.ARIAUtils.setLabel(i.element,b(u.animationPreviewS,{PH1:this.#k.indexOf(e)+1})),t.ARIAUtils.markAsOption(i.element),1===this.#S.size){const t=this.#S.get(this.#k[0]);t&&(t.element.tabIndex=0)}}previewsCreatedForTest(){}createPreviewForCollectedGroups(){this.#j.sort((t,e)=>t.isScrollDriven()&&!e.isScrollDriven()?-1:!t.isScrollDriven()&&e.isScrollDriven()?1:t.startTime()!==e.startTime()?t.startTime()-e.startTime():t.animations.length-e.animations.length);for(const t of this.#j)this.createPreview(t);this.#j=[],this.previewsCreatedForTest()}addAnimationGroup(t){const e=this.#S.get(t);if(e)return this.#f===t?this.syncScrubber():e.replay(),Promise.resolve();this.#k.sort((t,e)=>t.startTime()-e.startTime());const i=[],n=this.width()/50;for(;this.#k.length>n;){const t=this.#k.splice(this.#k[0]===this.#f?1:0,1);i.push(t[0])}for(const t of i){const e=this.#S.get(t);e&&(e.element.remove(),this.#S.delete(t),t.release())}return this.#j.push(t),this.#H.schedule(()=>Promise.resolve(this.createPreviewForCollectedGroups()))}handleAnimationGroupKeyDown(t,e){switch(e.key){case"Backspace":case"Delete":this.removeAnimationGroup(t,e);break;case"ArrowLeft":case"ArrowUp":this.focusNextGroup(t,e.target,!0);break;case"ArrowRight":case"ArrowDown":this.focusNextGroup(t,e.target)}}focusNextGroup(t,e,i){const n=this.#k.indexOf(t),s=i?n-1:n+1;if(s<0||s>=this.#k.length)return;const o=this.#S.get(this.#k[s]);o&&(o.element.tabIndex=0,o.element.focus()),e&&(e.tabIndex=-1)}removeAnimationGroup(t,e){const i=this.#k.indexOf(t);s.ArrayUtilities.removeElement(this.#k,t);const n=this.#S.get(t);if(n&&n.element.remove(),this.#S.delete(t),t.release(),e.consume(!0),this.#f===t&&(this.clearTimeline(),this.renderGrid()),0===this.#k.length)return void this.#v.element.focus();const o=i>=this.#k.length?this.#S.get(this.#k[this.#k.length-1]):this.#S.get(this.#k[i]);o&&(o.element.tabIndex=0,o.element.focus())}clearCurrentTimeText(){this.#b.textContent=""}setCurrentTimeText(t){this.#f&&(this.#b.textContent=this.#f?.isScrollDriven()?`${t.toFixed(0)}px`:r.TimeUtilities.millisToString(t))}async selectAnimationGroup(t){if(this.#f===t)return this.togglePause(!1),void this.replay();if(this.clearTimeline(),this.#f=t,this.#S.forEach((t,e)=>{t.element.classList.toggle("selected",this.#f===e)}),t.isScrollDriven()){const e=await t.scrollNode();if(!e)throw new Error("Scroll container is not found for the scroll driven animation");const i="vertical"===t.scrollOrientation()?await e.verticalScrollRange():await e.horizontalScrollRange(),n="vertical"===t.scrollOrientation()?await e.scrollTop():await e.scrollLeft();if("number"!=typeof i||"number"!=typeof n)throw new Error("Scroll range or scroll offset is not resolved for the scroll driven animation");this.#B=await e.addScrollEventListener(({scrollTop:e,scrollLeft:i})=>{const n="vertical"===t.scrollOrientation()?e:i;this.setCurrentTimeText(n),this.setTimelineScrubberPosition(n)}),this.setDuration(i),this.setCurrentTimeText(n),this.setTimelineScrubberPosition(n),this.#m.forEach(t=>{t.setAttribute("disabled","true")}),this.#L&&this.#L.setEnabled(!1)}else this.setDuration(t.finiteDuration()),this.#m.forEach(t=>{t.removeAttribute("disabled")}),this.#L&&this.#L.setEnabled(!0);await Promise.all(t.animations().map(t=>this.addAnimation(t))),this.scheduleRedraw(),this.togglePause(!1),this.replay(),this.hasAnimationGroupActiveNodes()&&(this.#u.classList.remove("hidden"),this.#N.classList.add("scrubber-enabled")),o.userMetrics.actionTaken(o.UserMetrics.Action.AnimationGroupSelected),this.#f.isScrollDriven()&&o.userMetrics.actionTaken(o.UserMetrics.Action.ScrollDrivenAnimationGroupSelected),this.animationGroupSelectedForTest()}animationGroupSelectedForTest(){}async addAnimation(t){let e=this.#A.get(t.source().backendNodeId());e||(e=new x(t.source()),this.#c.appendChild(e.element),this.#A.set(t.source().backendNodeId(),e));const i=e.createNewRow(),n=new C(t,this,i),s=await t.source().deferredNode().resolvePromise();n.setNode(s),s&&e&&(e.nodeResolved(s),f.set(s,e)),this.#T.push(n),this.#C.set(t.id(),t)}markNodeAsRemoved(t){f.get(t)?.nodeRemoved();for(const e of t.pseudoElements().values())e.forEach(t=>this.markNodeAsRemoved(t));t.children()?.forEach(t=>{this.markNodeAsRemoved(t)}),this.hasAnimationGroupActiveNodes()||(this.#N.classList.remove("scrubber-enabled"),this.#u.classList.add("hidden"),this.#U?.cancel(),this.#U=void 0,this.clearCurrentTimeText(),this.updateControlButton())}hasAnimationGroupActiveNodes(){for(const t of this.#A.values())if(t.hasActiveNode())return!0;return!1}renderGrid(){const e=this.#f?.isScrollDriven(),i=e?this.duration()/10:250;let n;this.#r.removeChildren();for(let e=0;e<this.duration();e+=i){const i=t.UIUtils.createSVGChild(this.#r,"rect","animation-timeline-grid-line");i.setAttribute("x",(e*this.pixelTimeRatio()+10).toString()),i.setAttribute("y","23"),i.setAttribute("height","100%"),i.setAttribute("width","1")}for(let s=0;s<this.duration();s+=i){const i=s*this.pixelTimeRatio();if(void 0===n||i-n>50){n=i;const o=t.UIUtils.createSVGChild(this.#r,"text","animation-timeline-grid-label");o.textContent=e?`${s.toFixed(0)}px`:r.TimeUtilities.millisToString(s),o.setAttribute("x",(i+12).toString()),o.setAttribute("y","16")}}}scheduleRedraw(){this.renderGrid(),this.#g=[];for(const t of this.#T)this.#g.push(t);this.#E||(this.#E=!0,this.#c.window().requestAnimationFrame(this.render.bind(this)))}render(t){for(;this.#g.length&&(!t||window.performance.now()-t<50);){const t=this.#g.shift();t&&t.redraw()}this.#g.length?this.#c.window().requestAnimationFrame(this.render.bind(this)):this.#E=void 0}onResize(){this.#G=Math.max(0,this.contentElement.offsetWidth-this.#x)||0,this.scheduleRedraw(),this.#U&&this.syncScrubber(),this.#D=void 0}width(){return this.#G||0}syncScrubber(){this.#f&&this.hasAnimationGroupActiveNodes()&&this.#f.currentTimePromise().then(this.animateTime.bind(this)).then(this.updateControlButton.bind(this))}animateTime(t){this.#f?.isScrollDriven()||(this.#U&&this.#U.cancel(),this.#U=this.#u.animate([{transform:"translateX(0px)"},{transform:"translateX("+this.width()+"px)"}],{duration:this.duration(),fill:"forwards"}),this.#U.playbackRate=this.effectivePlaybackRate(),this.#U.onfinish=this.updateControlButton.bind(this),this.#U.currentTime=t,this.element.window().requestAnimationFrame(this.updateScrubber.bind(this)))}pixelTimeRatio(){return this.width()/this.duration()||0}updateScrubber(t){this.#U&&(this.setCurrentTimeText(this.#Z()),"pending"!==this.#U.playState.toString()&&"running"!==this.#U.playState||this.element.window().requestAnimationFrame(this.updateScrubber.bind(this)))}scrubberDragStart(t){if(!this.#f||!this.hasAnimationGroupActiveNodes())return!1;this.#D||(this.#D=this.#r.getBoundingClientRect().left+10);const{x:e}=t,i=Math.max(0,e-this.#D)/this.pixelTimeRatio();if(this.#I=i,this.#O=e,this.setCurrentTimeText(i),this.#f.isScrollDriven())this.setTimelineScrubberPosition(i),this.updateScrollOffsetOnPage(i);else{const t=this.#U?.currentTime;this.#F=this.#f.paused()||"number"==typeof t&&t>=this.duration(),this.#f.seekTo(i),this.togglePause(!0),this.animateTime(i)}return!0}async updateScrollOffsetOnPage(t){const e=await(this.#f?.scrollNode());if(e)return"vertical"===this.#f?.scrollOrientation()?await e.setScrollTop(t):await e.setScrollLeft(t)}setTimelineScrubberPosition(t){this.#u.style.transform=`translateX(${t*this.pixelTimeRatio()}px)`}scrubberDragMove(t){const{x:e}=t,i=e-(this.#O||0),n=Math.max(0,Math.min((this.#I||0)+i/this.pixelTimeRatio(),this.duration()));this.#U?this.#U.currentTime=n:(this.setTimelineScrubberPosition(n),this.updateScrollOffsetOnPage(n)),this.setCurrentTimeText(n),this.#f&&!this.#f.isScrollDriven()&&this.#f.seekTo(n)}#Z(){return"number"==typeof this.#U?.currentTime?this.#U.currentTime:0}scrubberDragEnd(t){if(this.#U){const t=Math.max(0,this.#Z());this.#U.play(),this.#U.currentTime=t}o.userMetrics.actionTaken(o.UserMetrics.Action.AnimationGroupScrubbed),this.#f?.isScrollDriven()&&o.userMetrics.actionTaken(o.UserMetrics.Action.ScrollDrivenAnimationGroupScrubbed),this.#b.window().requestAnimationFrame(this.updateScrubber.bind(this)),this.#F||this.togglePause(!1)}}const w=[1,.25,.1];class x{element;#$;#X;#q;#W;constructor(e){this.element=document.createElement("div"),this.element.classList.add("animation-node-row"),this.#$=this.element.createChild("div","animation-node-description"),this.#$.setAttribute("jslog",`${i.tableCell("description").track({resize:!0})}`),this.#X=this.element.createChild("div","animation-node-timeline"),this.#X.setAttribute("jslog",`${i.tableCell("timeline").track({resize:!0})}`),t.ARIAUtils.markAsApplication(this.#X)}nodeResolved(e){e?(this.#W=e,this.nodeChanged(),n.Linkifier.Linkifier.linkify(e).then(t=>{t.addEventListener("click",()=>{o.userMetrics.actionTaken(o.UserMetrics.Action.AnimatedNodeDescriptionClicked)}),this.#$.appendChild(t)}),e.ownerDocument||this.nodeRemoved()):t.UIUtils.createTextChild(this.#$,"<node>")}createNewRow(){return this.#X.createChild("div","animation-timeline-row")}nodeRemoved(){this.element.classList.add("animation-node-removed"),this.#q||(this.#q=document.createElement("div"),this.#q.classList.add("animation-node-removed-overlay"),this.#$.appendChild(this.#q)),this.#W=null}hasActiveNode(){return Boolean(this.#W)}nodeChanged(){let e=!1;this.#W&&(e=this.#W===t.Context.Context.instance().flavor(l.DOMModel.DOMNode)),this.element.classList.toggle("animation-node-selected",e)}}class A{steps;stepAtPosition;constructor(t,e){this.steps=t,this.stepAtPosition=e}static parse(t){let e=t.match(/^steps\((\d+), (start|middle)\)$/);return e?new A(parseInt(e[1],10),e[2]):(e=t.match(/^steps\((\d+)\)$/),e?new A(parseInt(e[1],10),"end"):null)}}var k=Object.freeze({__proto__:null,AnimationGroupRevealer:class{async reveal(t){await y.instance().revealAnimationGroup(t)}},AnimationTimeline:y,GlobalPlaybackRates:w,NodeUI:x,StepTimingFunction:A});const T={animationEndpointSlider:"Animation Endpoint slider",animationKeyframeSlider:"Animation Keyframe slider",sSlider:"{PH1} slider"},M=r.i18n.registerUIStrings("panels/animation/AnimationUI.ts",T),S=r.i18n.getLocalizedString.bind(void 0,M);class C{#Y;#Q;#tt;#et;#it;#nt;#st;#ot;#at;#rt;#W;#lt;#ht;#dt;#ct;#mt;#pt;constructor(e,n,s){this.#Y=e,this.#Q=n;const o=this.#Y.source().keyframesRule();o&&(this.#tt=o.keyframes(),e.viewOrScrollTimeline()&&e.playbackRate()<0&&this.#tt.reverse()),this.#et=s.createChild("div","animation-name"),this.#et.textContent=this.#Y.name(),this.#it=t.UIUtils.createSVGChild(s,"svg","animation-ui"),this.#it.setAttribute("height",P.AnimationSVGHeight.toString()),this.#it.style.marginLeft="-"+P.AnimationMargin+"px",this.#it.addEventListener("contextmenu",this.onContextMenu.bind(this)),this.#nt=t.UIUtils.createSVGChild(this.#it,"g"),this.#nt.setAttribute("jslog",`${i.animationClip().track({drag:!0})}`),this.#Y.viewOrScrollTimeline()||(t.UIUtils.installDragHandle(this.#nt,this.mouseDown.bind(this,"AnimationDrag",null),this.mouseMove.bind(this),this.mouseUp.bind(this),"-webkit-grabbing","-webkit-grab"),C.installDragHandleKeyboard(this.#nt,this.keydownMove.bind(this,"AnimationDrag",null))),this.#st=[],this.#ot=0,this.#at=50,this.#rt=C.colorForAnimation(this.#Y)}static colorForAnimation(t){const e=Array.from(G.keys()),i=e[s.StringUtilities.hashCode(t.name()||t.id())%e.length],n=G.get(i);if(!n)throw new Error("Unable to locate color");return n.asString("rgb")||""}static installDragHandleKeyboard(t,e){t.addEventListener("keydown",e,!1)}animation(){return this.#Y}get nameElement(){return this.#et}get svg(){return this.#it}setNode(t){this.#W=t}createLine(e,i){const n=t.UIUtils.createSVGChild(e,"line",i);return n.setAttribute("x1",P.AnimationMargin.toString()),n.setAttribute("y1",P.AnimationHeight.toString()),n.setAttribute("y2",P.AnimationHeight.toString()),n.style.stroke=this.#rt,n}drawAnimationLine(t,e){const i=this.#st[t];i.animationLine||(i.animationLine=this.createLine(e,"animation-line")),i.animationLine&&i.animationLine.setAttribute("x2",(this.duration()*this.#Q.pixelTimeRatio()+P.AnimationMargin).toFixed(2))}drawDelayLine(t){this.#lt&&this.#ht||(this.#lt=this.createLine(t,"animation-delay-line"),this.#ht=this.createLine(t,"animation-delay-line"));const e=this.#Y.source().fill();this.#lt.classList.toggle("animation-fill","backwards"===e||"both"===e);const i=P.AnimationMargin;this.#lt.setAttribute("x1",i.toString()),this.#lt.setAttribute("x2",(this.delayOrStartTime()*this.#Q.pixelTimeRatio()+i).toFixed(2));const n="forwards"===e||"both"===e;this.#ht.classList.toggle("animation-fill",n);const s=Math.min(this.#Q.width(),(this.delayOrStartTime()+this.duration()*this.#Y.source().iterations())*this.#Q.pixelTimeRatio());this.#ht.style.transform="translateX("+s.toFixed(2)+"px)",this.#ht.setAttribute("x1",i.toString()),this.#ht.setAttribute("x2",n?(this.#Q.width()-s+i).toFixed(2):(this.#Y.source().endDelay()*this.#Q.pixelTimeRatio()+i).toFixed(2))}drawPoint(e,n,s,o,a){if(this.#st[e].keyframePoints[o])return void this.#st[e].keyframePoints[o].setAttribute("cx",s.toFixed(2));const r=t.UIUtils.createSVGChild(n,"circle",o<=0?"animation-endpoint":"animation-keyframe-point");if(r.setAttribute("cx",s.toFixed(2)),r.setAttribute("cy",P.AnimationHeight.toString()),r.style.stroke=this.#rt,r.setAttribute("r",(P.AnimationMargin/2).toString()),r.setAttribute("jslog",`${i.controlPoint("animations.keyframe").track({drag:!0})}`),r.tabIndex=0,t.ARIAUtils.setLabel(r,S(o<=0?T.animationEndpointSlider:T.animationKeyframeSlider)),o<=0&&(r.style.fill=this.#rt),this.#st[e].keyframePoints[o]=r,!a)return;let l;l=0===o?"StartEndpointMove":-1===o?"FinishEndpointMove":"KeyframeMove",this.animation().viewOrScrollTimeline()||(t.UIUtils.installDragHandle(r,this.mouseDown.bind(this,l,o),this.mouseMove.bind(this),this.mouseUp.bind(this),"ew-resize"),C.installDragHandleKeyboard(r,this.keydownMove.bind(this,l,o)))}renderKeyframe(e,i,n,s,o,r){function l(e,i,n){const s=t.UIUtils.createSVGChild(e,"line");s.setAttribute("x1",i.toString()),s.setAttribute("x2",i.toString()),s.setAttribute("y1",P.AnimationMargin.toString()),s.setAttribute("y2",P.AnimationHeight.toString()),s.style.stroke=n}const h=t.Geometry.CubicBezier.parse(r),d=this.#st[e].keyframeRender;if(!d[i]){const e=h?t.UIUtils.createSVGChild(n,"path","animation-keyframe"):t.UIUtils.createSVGChild(n,"g","animation-keyframe-step");d[i]=e}const c=d[i];if(c.tabIndex=0,t.ARIAUtils.setLabel(c,S(T.sSlider,{PH1:this.#Y.name()})),c.style.transform="translateX("+s.toFixed(2)+"px)","linear"===r){c.style.fill=this.#rt;const t=a.BezierUI.Height;c.setAttribute("d",["M",0,t,"L",0,5,"L",o.toFixed(2),5,"L",o.toFixed(2),t,"Z"].join(" "))}else if(h)c.style.fill=this.#rt,a.BezierUI.BezierUI.drawVelocityChart(h,c,o);else{const t=A.parse(r);if(c.removeChildren(),t){const e={start:0,middle:.5,end:1}[t.stepAtPosition];for(let i=0;i<t.steps;i++)l(c,(i+e)*o/t.steps,this.#rt)}}}redraw(){const e=this.#Q.width()-P.AnimationMargin;if(this.#it.setAttribute("width",(e+2*P.AnimationMargin).toFixed(2)),this.#nt.style.transform="translateX("+(this.delayOrStartTime()*this.#Q.pixelTimeRatio()).toFixed(2)+"px)",this.#et.style.transform="translateX("+(Math.max(this.delayOrStartTime(),0)*this.#Q.pixelTimeRatio()+P.AnimationMargin).toFixed(2)+"px)",this.#et.style.width=(this.duration()*this.#Q.pixelTimeRatio()).toFixed(2)+"px",this.drawDelayLine(this.#it),"CSSTransition"===this.#Y.type())return void this.renderTransition();this.renderIteration(this.#nt,0),this.#dt||(this.#dt=t.UIUtils.createSVGChild(this.#nt,"g","animation-tail-iterations"));const i=this.duration()*this.#Q.pixelTimeRatio();let n;const s=this.delayOrStartTime()<0?-this.delayOrStartTime()*this.#Q.pixelTimeRatio():0;for(n=1;n<this.#Y.source().iterations()&&i*(n-1)<s+this.#Q.width()&&(i>0||this.#Y.source().iterations()!==1/0);n++)this.renderIteration(this.#dt,n);for(;n<this.#st.length;){const t=this.#st.pop();t?.group&&t.group.remove()}}renderTransition(){const t=this.#nt;this.#st[0]||(this.#st[0]={animationLine:null,keyframePoints:{},keyframeRender:{},group:null}),this.drawAnimationLine(0,t),this.renderKeyframe(0,0,t,P.AnimationMargin,this.duration()*this.#Q.pixelTimeRatio(),this.#Y.source().easing()),this.drawPoint(0,t,P.AnimationMargin,0,!0),this.drawPoint(0,t,this.duration()*this.#Q.pixelTimeRatio()+P.AnimationMargin,-1,!0)}renderIteration(e,i){this.#st[i]||(this.#st[i]={animationLine:null,keyframePoints:{},keyframeRender:{},group:t.UIUtils.createSVGChild(e,"g")});const n=this.#st[i].group;if(n){if(n.style.transform="translateX("+(i*this.duration()*this.#Q.pixelTimeRatio()).toFixed(2)+"px)",this.drawAnimationLine(i,n),this.#tt&&this.#tt.length>1)for(let t=0;t<this.#tt.length-1;t++){const e=this.offset(t)*this.duration()*this.#Q.pixelTimeRatio()+P.AnimationMargin,s=this.duration()*(this.offset(t+1)-this.offset(t))*this.#Q.pixelTimeRatio();this.renderKeyframe(i,t,n,e,s,this.#tt[t].easing()),(t||!t&&0===i)&&this.drawPoint(i,n,e,t,0===i)}this.drawPoint(i,n,this.duration()*this.#Q.pixelTimeRatio()+P.AnimationMargin,-1,0===i)}}delayOrStartTime(){let t=this.#Y.delayOrStartTime();return"AnimationDrag"!==this.#ct&&"StartEndpointMove"!==this.#ct||(t+=this.#ot),t}duration(){let t=this.#Y.iterationDuration();return"FinishEndpointMove"===this.#ct?t+=this.#ot:"StartEndpointMove"===this.#ct&&(t-=this.#ot),Math.max(0,t)}offset(t){if(!this.#tt)throw new Error("Unable to calculate offset; keyframes do not exist");let e=this.#tt[t].offsetAsNumber();return"KeyframeMove"===this.#ct&&t===this.#mt&&(console.assert(t>0&&t<this.#tt.length-1,"First and last keyframe cannot be moved"),e+=this.#ot/this.#Y.iterationDuration(),e=Math.max(e,this.#tt[t-1].offsetAsNumber()),e=Math.min(e,this.#tt[t+1].offsetAsNumber())),e}mouseDown(e,i,s){const o=s;if(2===o.buttons)return!1;if(this.#it.enclosingNodeOrSelfWithClass("animation-node-removed"))return!1;this.#ct=e,this.#mt=i,this.#pt=o.clientX,s.consume(!0);const a=t.ViewManager.ViewManager.instance(),r=a.locationNameForViewId("animations"),l=a.locationNameForViewId("elements");return this.#W&&r!==l&&n.Revealer.reveal(this.#W),!0}mouseMove(t){const e=t;this.setMovementAndRedraw((e.clientX-(this.#pt||0))/this.#Q.pixelTimeRatio())}setMovementAndRedraw(t){this.#ot=t,this.delayOrStartTime()+this.duration()>.8*this.#Q.duration()&&this.#Q.setDuration(1.2*this.#Q.duration()),this.redraw()}mouseUp(t){const e=t;this.#ot=(e.clientX-(this.#pt||0))/this.#Q.pixelTimeRatio(),"KeyframeMove"===this.#ct?this.#tt&&null!==this.#mt&&void 0!==this.#mt&&this.#tt[this.#mt].setOffset(this.offset(this.#mt)):this.#Y.setTiming(this.duration(),this.delayOrStartTime()),o.userMetrics.animationPointDragged("AnimationDrag"===this.#ct?0:"KeyframeMove"===this.#ct?1:"StartEndpointMove"===this.#ct?2:"FinishEndpointMove"===this.#ct?3:4),this.#ot=0,this.redraw(),this.#ct=void 0,this.#pt=void 0,this.#mt=void 0}keydownMove(t,e,i){const n=i;switch(this.#ct=t,this.#mt=e,n.key){case"ArrowLeft":case"ArrowUp":this.#ot=-this.#at;break;case"ArrowRight":case"ArrowDown":this.#ot=this.#at;break;default:return}"KeyframeMove"===this.#ct?this.#tt&&null!==this.#mt&&this.#tt[this.#mt].setOffset(this.offset(this.#mt)):this.#Y.setTiming(this.duration(),this.delayOrStartTime()),this.setMovementAndRedraw(0),this.#ct=void 0,this.#mt=void 0,i.consume(!0)}onContextMenu(e){this.#Y.remoteObjectPromise().then(function(i){if(!i)return;const n=new t.ContextMenu.ContextMenu(e);n.appendApplicableItems(i),n.show()}),e.consume(!0)}}const P={AnimationHeight:26,AnimationSVGHeight:50,AnimationMargin:7,EndpointsClickRegionSize:10,GridCanvasHeight:40},G=new Map([["Purple",n.Color.parse("#9C27B0")],["Light Blue",n.Color.parse("#03A9F4")],["Deep Orange",n.Color.parse("#FF5722")],["Blue",n.Color.parse("#5677FC")],["Lime",n.Color.parse("#CDDC39")],["Blue Grey",n.Color.parse("#607D8B")],["Pink",n.Color.parse("#E91E63")],["Green",n.Color.parse("#0F9D58")],["Brown",n.Color.parse("#795548")],["Cyan",n.Color.parse("#00BCD4")]]);var E=Object.freeze({__proto__:null,AnimationUI:C,Colors:G,Options:P});class R{#ut;element;#bt;#vt;#it;#ft;constructor(n){this.#ut=n,this.element=document.createElement("button"),this.element.setAttribute("jslog",`${i.item("animations.buffer-preview"+(n.isScrollDriven()?"-sda":"")).track({click:!0})}`),this.element.classList.add("animation-buffer-preview"),this.element.addEventListener("animationend",()=>{this.element.classList.add("no-animation")}),this.element.createChild("div","animation-paused fill"),n.isScrollDriven()?this.element.appendChild(e.Icon.create("mouse","preview-icon")):this.element.appendChild(e.Icon.create("watch","preview-icon")),this.#bt=this.element.createChild("button","animation-remove-button"),this.#bt.setAttribute("jslog",`${i.action("animations.remove-preview").track({click:!0})}`),this.#bt.appendChild(e.Icon.create("cross")),this.#vt=this.element.createChild("div","animation-buffer-preview-animation"),this.#it=t.UIUtils.createSVGChild(this.element,"svg"),this.#it.setAttribute("width","100%"),this.#it.setAttribute("preserveAspectRatio","none"),this.#it.setAttribute("height","100%"),this.#ft=32,this.#it.setAttribute("viewBox","0 0 100 "+this.#ft),this.#it.setAttribute("shape-rendering","crispEdges"),this.render()}removeButton(){return this.#bt}replay(){this.#vt.animate([{offset:0,width:"0%",opacity:1},{offset:.9,width:"100%",opacity:1},{offset:1,width:"100%",opacity:0}],{duration:200,easing:"cubic-bezier(0, 0, 0.2, 1)"})}render(){this.#it.removeChildren();const e=Math.min(this.#ut.animations().length,10),i=100/Math.max(this.#ut.groupDuration(),750);for(let n=0;n<e;n++){const s=this.#ut.animations()[n],o=t.UIUtils.createSVGChild(this.#it,"line"),a=s.delayOrStartTime(),r=a+s.iterationDuration();o.setAttribute("x1",String(a*i)),o.setAttribute("x2",String(r*i));const l=String(Math.floor(this.#ft/Math.max(6,e)*n+1));o.setAttribute("y1",l),o.setAttribute("y2",l),o.style.stroke=C.colorForAnimation(this.#ut.animations()[n])}}}var I=Object.freeze({__proto__:null,AnimationGroupPreviewUI:R});export{I as AnimationGroupPreviewUI,h as AnimationScreenshotPopover,k as AnimationTimeline,E as AnimationUI};