"use strict";const{unwrapNullable:unwrapNullable}=require("../../../../parsers/parsers-commons"),{wrapOptional:wrapCxxOptional}=require("../../../TypeUtils/Cxx"),{wrapOptional:wrapObjCOptional}=require("../../../TypeUtils/Objective-C"),{capitalize:capitalize}=require("../../../Utils"),{getNamespacedStructName:getNamespacedStructName,getSafePropertyName:getSafePropertyName}=require("../Utils"),StructTemplate=({hasteModuleName:e,structName:t,structProperties:n})=>`namespace JS {\n  namespace ${e} {\n    struct ${t} {\n      ${n}\n\n      ${t}(NSDictionary *const v) : _v(v) {}\n    private:\n      NSDictionary *_v;\n    };\n  }\n}\n\n@interface RCTCxxConvert (${e}_${t})\n+ (RCTManagedPointer *)JS_${e}_${t}:(id)json;\n@end`,MethodTemplate=({returnType:e,returnValue:t,hasteModuleName:n,structName:a,propertyName:r,safePropertyName:o})=>`inline ${e}JS::${n}::${a}::${o}() const\n{\n  id const p = _v[@"${r}"];\n  return ${t};\n}`;function toObjCType(e,t,n=!1){const[a,r]=unwrapNullable(t),o=!r&&!n;switch(a.type){case"ReservedTypeAnnotation":if("RootTag"===a.name)return wrapCxxOptional("double",o);throw a.name,new Error(`Unknown prop type, found: ${a.name}"`);case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return"NSString *";case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"FloatTypeAnnotation":case"Int32TypeAnnotation":case"DoubleTypeAnnotation":return wrapCxxOptional("double",o);case"BooleanTypeAnnotation":return wrapCxxOptional("bool",o);case"EnumDeclaration":switch(a.memberType){case"NumberTypeAnnotation":return wrapCxxOptional("double",o);case"StringTypeAnnotation":return"NSString *";default:throw new Error(`Couldn't convert enum into ObjC type: ${a.type}"`)}case"GenericObjectTypeAnnotation":return wrapObjCOptional("id<NSObject>",o);case"ArrayTypeAnnotation":return"AnyTypeAnnotation"===a.elementType.type?wrapObjCOptional("id<NSObject>",o):wrapCxxOptional(`facebook::react::LazyVector<${toObjCType(e,a.elementType)}>`,o);case"TypeAliasTypeAnnotation":const t=capitalize(a.name),n=getNamespacedStructName(e,t);return wrapCxxOptional(n,o);default:throw a.type,new Error(`Couldn't convert into ObjC type: ${a.type}"`)}}function toObjCValue(e,t,n,a,r=!1){const[o,i]=unwrapNullable(t),p=!i&&!r,u=(e,t)=>{const a=[n,t].filter(Boolean).join(", ");return p?`RCTBridgingTo${e}(${a})`:`RCTBridgingToOptional${e}(${a})`};switch(o.type){case"ReservedTypeAnnotation":if("RootTag"===o.name)return u("Double");throw o.name,new Error(`Couldn't convert into ObjC type: ${o.type}"`);case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return u("String");case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"FloatTypeAnnotation":case"Int32TypeAnnotation":case"DoubleTypeAnnotation":return u("Double");case"BooleanTypeAnnotation":return u("Bool");case"EnumDeclaration":switch(o.memberType){case"NumberTypeAnnotation":return u("Double");case"StringTypeAnnotation":return u("String");default:throw new Error(`Couldn't convert enum into ObjC value: ${o.type}"`)}case"GenericObjectTypeAnnotation":return n;case"ArrayTypeAnnotation":const{elementType:t}=o;if("AnyTypeAnnotation"===t.type)return n;const r=`itemValue_${a}`;return u("Vec",`^${toObjCType(e,t)}(id ${r}) { return ${toObjCValue(e,t,r,a+1)}; }`);case"TypeAliasTypeAnnotation":const i=capitalize(o.name),c=getNamespacedStructName(e,i);return p?`${c}(${n})`:`(${n} == nil ? std::nullopt : std::make_optional(${c}(${n})))`;default:throw o.type,new Error(`Couldn't convert into ObjC value: ${o.type}"`)}}function serializeRegularStruct(e,t){const n=StructTemplate({hasteModuleName:e,structName:t.name,structProperties:t.properties.map(t=>{const{typeAnnotation:n,optional:a}=t,r=getSafePropertyName(t),o=toObjCType(e,n,a),i=" ".repeat(o.endsWith("*")?0:1);return`${o}${i}${r}() const;`}).join("\n      ")});return{methods:t.properties.map(n=>{const{typeAnnotation:a,optional:r,name:o}=n,i=getSafePropertyName(n),p=toObjCType(e,a,r),u=toObjCValue(e,a,"p",0,r),c=" ".repeat(p.endsWith("*")?0:1);return MethodTemplate({hasteModuleName:e,structName:t.name,returnType:p+c,returnValue:u,propertyName:o,safePropertyName:i})}).join("\n"),declaration:n}}module.exports={serializeRegularStruct:serializeRegularStruct};