"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _getBaseUrlFromRequest=_interopRequireDefault(require("../utils/getBaseUrlFromRequest")),_getDevToolsFrontendUrl=_interopRequireDefault(require("../utils/getDevToolsFrontendUrl")),_Device=_interopRequireDefault(require("./Device")),_EventLoopPerfTracker=_interopRequireDefault(require("./EventLoopPerfTracker")),_InspectorProxyHeartbeat=_interopRequireDefault(require("./InspectorProxyHeartbeat")),_nullthrows=_interopRequireDefault(require("nullthrows")),_url=_interopRequireDefault(require("url")),_ws=_interopRequireDefault(require("ws"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const debug=require("debug")("Metro:InspectorProxy"),WS_DEVICE_URL="/inspector/device",WS_DEBUGGER_URL="/inspector/debug",PAGES_LIST_JSON_URL="/json",PAGES_LIST_JSON_URL_2="/json/list",PAGES_LIST_JSON_VERSION_URL="/json/version",HEARTBEAT_TIME_BETWEEN_PINGS_MS=5e3,HEARTBEAT_TIMEOUT_MS=6e4,MIN_PING_TO_REPORT=500,EVENT_LOOP_PERF_MEASUREMENT_MS=5e3,MIN_EVENT_LOOP_DELAY_PERCENT_TO_REPORT=20,INTERNAL_ERROR_CODE=1011,INTERNAL_ERROR_MESSAGES={UNREGISTERED_DEVICE:"[UNREGISTERED_DEVICE] Debugger connection attempted for a device that was not registered",INCORRECT_URL:"[INCORRECT_URL] Incorrect URL - device and page IDs must be provided"};class InspectorProxy{#e;#t;#n;#o=0;#i;#r;#s;#a;#c=null;#l;constructor(e,t,n,o,i,r,s=!1){this.#e=e,this.#t=new URL(t),this.#n=new Map,this.#i=n,this.#r=o,this.#a=i,this.#s=r,s&&(this.#l=new _EventLoopPerfTracker.default({perfMeasurementDuration:5e3,minDelayPercentToReport:20,onHighDelay:({eventLoopUtilization:e,maxEventLoopDelayPercent:t,duration:n,debuggerSessionIDs:o,connectionUptime:i})=>{debug("[perf] high event loop delay in the last %ds- event loop utilization='%d%' max event loop delay percent='%d%'",n/1e3,e,t),this.#i?.logEvent({type:"high_event_loop_delay",eventLoopUtilization:e,maxEventLoopDelayPercent:t,duration:n,connectionUptime:i,...o})}}))}getPageDescriptions({requestorRelativeBaseUrl:e,logNoPagesForConnectedDevice:t=!1}){let n=[];return Array.from(this.#n.entries()).forEach(([o,i])=>{const r=i.getPagesList().map(t=>this.#p(o,i,t,e));t&&0===r.length&&i.dangerouslyGetSocket()?.readyState===_ws.default.OPEN&&(this.#a?.warn("Waiting for a DevTools connection to app='%s' on device='%s'.\n    Try again when the main bundle for the app is built and connection is established.\n    If no connection occurs, try to:\n    - Restart the app. For Android, force stopping the app first might be required.\n    - Ensure a stable connection to the device.\n    - Ensure that the app is built in a mode that supports debugging.\n    - Take the app out of running in the background.",i.getApp(),i.getName()),this.#i?.logEvent({type:"no_debug_pages_for_device",appId:i.getApp(),deviceName:i.getName(),deviceId:o,pageId:null})),n=n.concat(r)}),n}processRequest(e,t,n){const o=_url.default.parse(e.url).pathname;"/json"===o||"/json/list"===o?this.#g(t,this.getPageDescriptions({requestorRelativeBaseUrl:(0,_getBaseUrlFromRequest.default)(e)??this.#t,logNoPagesForConnectedDevice:!0})):"/json/version"===o?this.#g(t,{Browser:"Mobile JavaScript","Protocol-Version":"1.1"}):n()}createWebSocketListeners(){return{[WS_DEVICE_URL]:this.#u(),[WS_DEBUGGER_URL]:this.#d()}}#p(e,t,n,o){const{host:i,protocol:r}=o,s=`${"https:"===r?"wss":"ws"}://${`${i}${WS_DEBUGGER_URL}?device=${e}&page=${n.id}`}`,a=(0,_getDevToolsFrontendUrl.default)(this.#r,s,this.#t.origin,{relative:!0,useFuseboxEntryPoint:n.capabilities.prefersFuseboxFrontend});return{id:`${e}-${n.id}`,title:n.title,description:n.description??n.app,appId:n.app,type:"node",devtoolsFrontendUrl:a,webSocketDebuggerUrl:s,...null!=n.vm?{vm:n.vm}:null,deviceName:t.getName(),reactNative:{logicalDeviceId:e,capabilities:(0,_nullthrows.default)(n.capabilities)}}}#g(e,t){const n=JSON.stringify(t,null,2);e.writeHead(200,{"Content-Type":"application/json; charset=UTF-8","Cache-Control":"no-cache","Content-Length":Buffer.byteLength(n).toString(),Connection:"close"}),e.end(n)}#v(){const e=this.#c;return null==e?null:Date.now()-e}#m(e,t,n){e.includes('"event":"getPages"')||(this.#c=Date.now(),this.#l?.trackPerfThrottled(t,n))}#u(){const e=new _ws.default.Server({noServer:!0,perMessageDeflate:!0,maxPayload:0});return e.on("connection",async(e,t)=>{const n=Date.now(),o=String(this.#o++),i=_url.default.parse(t.url||"",!0).query||{},r=i.device||o,s=i.name||"Unknown",a=i.app||"Unknown",c="true"===i.profiling;try{const o=(0,_getBaseUrlFromRequest.default)(t)??this.#t,i=this.#n.get(r);let l;const p={id:r,name:s,app:a,socket:e,projectRoot:this.#e,eventReporter:this.#i,createMessageMiddleware:this.#s,deviceRelativeBaseUrl:o,serverRelativeBaseUrl:this.#t,isProfilingBuild:c};i?(i.dangerouslyRecreateDevice(p),l=i):l=new _Device.default(p),this.#n.set(r,l),this.#a?.info("Connection established to app='%s' on device='%s'.",a,s),debug("Got new device connection: name='%s', app=%s, device=%s, via=%s",s,a,r,o.origin);const g={appId:l?.getApp()||null,deviceId:r,deviceName:l?.getName()||null,pageId:null};new _InspectorProxyHeartbeat.default({socket:e,timeBetweenPings:5e3,minHighPingToReport:500,timeoutMs:6e4,onHighPing:e=>{debug("[high ping] [ Device ] %sms for app='%s' on device='%s'",String(e).padStart(5),g.appId,g.deviceName),this.#i?.logEvent({type:"device_high_ping",duration:e,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...g})},onTimeout:t=>{e.terminate(),this.#a?.error("[timeout] connection terminated with Device for app='%s' on device='%s' after not responding for %s seconds.",g.appId??"unknown",g.deviceName??"unknown",String(t/1e3)),this.#i?.logEvent({type:"device_timeout",duration:t,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...g})}}).start(),e.on("message",e=>this.#m(e.toString(),g,Date.now()-n)),e.on("close",(t,o)=>{this.#a?.info("Connection closed to device='%s' for app='%s' with code='%s' and reason='%s'.",s,a,String(t),o),this.#i?.logEvent({type:"device_connection_closed",code:t,reason:o,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...g}),this.#n.get(r)?.dangerouslyGetSocket()===e&&this.#n.delete(r)})}catch(t){this.#a?.error("Connection failed to be established with app='%s' on device='%s' with error:",a,s,t),e.close(1011,t?.toString()??"Unknown error")}}),e}#d(){const e=new _ws.default.Server({noServer:!0,perMessageDeflate:!1,maxPayload:0});return e.on("connection",async(e,t)=>{const n=Date.now(),o=_url.default.parse(t.url||"",!0).query||{},i=o.device,r=o.page,s=(0,_getBaseUrlFromRequest.default)(t)??this.#t,a=i?this.#n.get(i):void 0,c={appId:a?.getApp()||null,deviceId:i,deviceName:a?.getName()||null,pageId:r};try{if(null==i||null==r)throw new Error(INTERNAL_ERROR_MESSAGES.INCORRECT_URL);if(null==a)throw new Error(INTERNAL_ERROR_MESSAGES.UNREGISTERED_DEVICE);this.#a?.info("Connection established to DevTools for app='%s' on device='%s'.",a.getApp()||"unknown",a.getName()||"unknown");new _InspectorProxyHeartbeat.default({socket:e,timeBetweenPings:5e3,minHighPingToReport:500,timeoutMs:6e4,onHighPing:e=>{debug("[high ping] [DevTools] %sms for app='%s' on device='%s'",String(e).padStart(5),c.appId,c.deviceName),this.#i?.logEvent({type:"debugger_high_ping",duration:e,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...c})},onTimeout:t=>{e.terminate(),this.#a?.error("[timeout] connection terminated with DevTools for app='%s' on device='%s' after not responding for %s seconds.",c.appId??"unknown",c.deviceName??"unknown",String(t/1e3)),this.#i?.logEvent({type:"debugger_timeout",duration:t,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...c})}}).start(),e.on("message",e=>this.#m(e.toString(),c,Date.now()-n)),a.handleDebuggerConnection(e,r,{debuggerRelativeBaseUrl:s,userAgent:t.headers["user-agent"]??o.userAgent??null}),e.on("close",(e,t)=>{this.#a?.info("Connection closed to DevTools for app='%s' on device='%s' with code='%s' and reason='%s'.",a.getApp()||"unknown",a.getName()||"unknown",String(e),t),this.#i?.logEvent({type:"debugger_connection_closed",code:e,reason:t,timeSinceLastCommunication:this.#v(),connectionUptime:Date.now()-n,...c})})}catch(t){this.#a?.error("Connection failed to be established with DevTools for app='%s' on device='%s' and device id='%s' with error:",a?.getApp()||"unknown",a?.getName()||"unknown",i,t),e.close(1011,t?.toString()??"Unknown error"),this.#i?.logEvent({type:"connect_debugger_frontend",status:"error",error:t,...c})}}),e}}exports.default=InspectorProxy;