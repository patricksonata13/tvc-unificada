import*as e from"../../../core/common/common.js";import*as t from"../../../core/host/host.js";import*as n from"../../../core/root/root.js";let o;const s=new Map;class r extends EventTarget{setting;themeNameInternal="default";computedStyleOfHTML=e.Lazy.lazy(()=>window.getComputedStyle(document.documentElement));#e=new Set([document]);#t;#s;#o=()=>this.#n();#r=()=>this.fetchColorsAndApplyHostTheme();constructor(e){super(),this.setting=e,this.#t=window.matchMedia("(prefers-color-scheme: dark)"),this.#s=window.matchMedia("(forced-colors: active)"),this.#t.addEventListener("change",this.#o),this.#s.addEventListener("change",this.#o),e.addChangeListener(this.#o),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.ColorThemeChanged,this.#r)}#i(){this.#t.removeEventListener("change",this.#o),this.#s.removeEventListener("change",this.#o),this.setting.removeChangeListener(this.#o),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.removeEventListener(t.InspectorFrontendHostAPI.Events.ColorThemeChanged,this.#r)}static hasInstance(){return void 0!==o}static instance(e={forceNew:null,setting:null}){const{forceNew:t,setting:s}=e;if(!o||t){if(!s)throw new Error(`Unable to create theme support: setting must be provided: ${(new Error).stack}`);o&&o.#i(),o=new r(s)}return o}addDocumentToTheme(e){this.#e.add(e),this.#c(e)}getComputedValue(e,t=null){let o=s.get(t);o||(o=new Map,s.set(t,o));let n=o.get(e);if(!n){const s=t?window.getComputedStyle(t):this.computedStyleOfHTML();if("symbol"==typeof s)throw new Error(`Computed value for property (${e}) could not be found on documentElement.`);n=s.getPropertyValue(e).trim(),n&&o.set(e,n)}return n}themeName(){return this.themeNameInternal}appendStyle(e,{cssText:t}){const s=document.createElement("style");s.textContent=t,e.appendChild(s)}#n(){for(const e of this.#e)this.#a(e)}#a(e){const t=window.matchMedia("(forced-colors: active)").matches,o=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"default",r="systemPreferred"===this.setting.get()||t;this.themeNameInternal=r?o:this.setting.get(),e.documentElement.classList.toggle("theme-with-dark-background","dark"===this.themeNameInternal),n.Runtime.hostConfig.isOffTheRecord,e.documentElement.classList.toggle("baseline-grayscale",!0),s.clear(),this.dispatchEvent(new h)}static clearThemeCache(){s.clear()}fetchColorsAndApplyHostTheme(){for(const e of this.#e)this.#c(e)}#c(s){const o=e.Settings.moduleSetting("chrome-theme-colors").get();if(t.InspectorFrontendHost.InspectorFrontendHostInstance.isHostedMode()||!o)return void this.#a(s);const n=s.querySelector("link[href*='//theme/colors.css']"),r=s.createElement("link");r.setAttribute("href",`devtools://theme/colors.css?sets=ui,chrome&version=${(new Date).getTime().toString()}`),r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.onload=()=>{n&&n.remove(),this.#a(s)},s.body.appendChild(r)}}class h extends Event{static eventName="themechange";constructor(){super(h.eventName,{bubbles:!0,composed:!0})}}export{h as ThemeChangeEvent,r as ThemeSupport};