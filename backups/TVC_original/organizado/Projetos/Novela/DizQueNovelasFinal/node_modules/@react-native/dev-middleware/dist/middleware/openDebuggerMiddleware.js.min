"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=openDebuggerMiddleware;var _getDevToolsFrontendUrl=_interopRequireDefault(require("../utils/getDevToolsFrontendUrl")),_url=_interopRequireDefault(require("url"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const LEGACY_SYNTHETIC_PAGE_TITLE="React Native Experimental (Improved Chrome Reloads)";function openDebuggerMiddleware({serverBaseUrl:e,logger:t,browserLauncher:r,eventReporter:n,experiments:o,inspectorProxy:a}){return async(l,i,d)=>{if("POST"===l.method||o.enableOpenDebuggerRedirect&&"GET"===l.method){const d=_url.default.parse(l.url,!0).query,s=a.getPageDescriptions({requestorRelativeBaseUrl:new URL(e)}).filter(e=>{const r=e.title===LEGACY_SYNTHETIC_PAGE_TITLE||!0===e.reactNative.capabilities?.nativePageReloads;return r||t?.warn("Ignoring DevTools app debug target for '%s' with title '%s' and 'nativePageReloads' capability set to '%s'. ",e.appId,e.title,String(e.reactNative.capabilities?.nativePageReloads)),r});let u;const c="POST"===l.method?"launch":"redirect";if("string"==typeof d.target||"string"==typeof d.appId||"string"==typeof d.device?(t?.info(("launch"===c?"Launching":"Redirecting to")+" DevTools..."),u=s.find(e=>!(null!=d.target&&e.id!==d.target||null!=d.appId&&(e.appId!==d.appId||e.title!==LEGACY_SYNTHETIC_PAGE_TITLE)||null!=d.device&&e.reactNative.logicalDeviceId!==d.device))):s.length>0&&(t?.info(("launch"===c?"Launching":"Redirecting to")+` DevTools${1===s.length?"":" for most recently connected target"}...`),u=s[s.length-1]),!u)return i.writeHead(404),i.end("Unable to find debugger target"),t?.warn("No compatible apps connected. React Native DevTools can only be used with the Hermes engine."),void n?.logEvent({type:"launch_debugger_frontend",launchType:c,status:"coded_error",errorCode:"NO_APPS_FOUND"});const p=u.reactNative.capabilities?.prefersFuseboxFrontend??!1;try{switch(c){case"launch":{const t=(0,_getDevToolsFrontendUrl.default)(o,u.webSocketDebuggerUrl,e,{launchId:d.launchId,telemetryInfo:d.telemetryInfo,appId:u.appId,useFuseboxEntryPoint:p});if(p&&o.enableStandaloneFuseboxShell){const n=[e,u.webSocketDebuggerUrl,u.appId].join("-");if(!r.unstable_showFuseboxShell)throw new Error("Fusebox shell is not supported by the current browser launcher");await r.unstable_showFuseboxShell(t,n)}else await r.launchDebuggerAppWindow(t);i.writeHead(200),i.end();break}case"redirect":i.writeHead(302,{Location:(0,_getDevToolsFrontendUrl.default)(o,u.webSocketDebuggerUrl,e,{relative:!0,launchId:d.launchId,telemetryInfo:d.telemetryInfo,appId:u.appId,useFuseboxEntryPoint:p})}),i.end()}return void n?.logEvent({type:"launch_debugger_frontend",launchType:c,status:"success",appId:u.appId,deviceId:u.reactNative.logicalDeviceId,pageId:u.id,deviceName:u.deviceName,targetDescription:u.description,prefersFuseboxFrontend:p})}catch(e){return t?.error("Error launching DevTools: "+e.message??"Unknown error"),i.writeHead(500),i.end(),void n?.logEvent({type:"launch_debugger_frontend",launchType:c,status:"error",error:e,prefersFuseboxFrontend:p})}}d()}}