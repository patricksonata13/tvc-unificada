import*as e from"../../core/common/common.js";import*as t from"../../core/platform/platform.js";import{assertNotNullOrUndefined as o}from"../../core/platform/platform.js";import*as r from"../../core/sdk/sdk.js";import*as s from"../text_utils/text_utils.js";import*as i from"../workspace/workspace.js";import*as n from"../../core/i18n/i18n.js";const a={unknownErrorLoadingFile:"Unknown error loading file"},c=n.i18n.registerUIStrings("models/bindings/ContentProviderBasedProject.ts",a),u=n.i18n.getLocalizedString.bind(void 0,c);class d extends i.Workspace.ProjectStore{#e;#t;constructor(e,t,r,o,s){super(e,t,r,o),this.#e=s,this.#t=new WeakMap,e.addProject(this)}async requestFileContent(e){const{contentProvider:t}=this.#t.get(e);try{return await t.requestContentData()}catch(e){return{error:e?String(e):u(a.unknownErrorLoadingFile)}}}isServiceProject(){return this.#e}async requestMetadata(e){const{metadata:t}=this.#t.get(e);return t}canSetFileContent(){return!1}async setFileContent(e,t,r){}fullDisplayName(e){let t=e.parentURL().replace(/^(?:https?|file)\:\/\//,"");try{t=decodeURI(t)}catch{}return t+"/"+e.displayName(!0)}mimeType(e){const{mimeType:t}=this.#t.get(e);return t}canRename(){return!1}rename(e,t,r){const o=e.url();this.performRename(o,t,(t,o)=>{t&&o&&this.renameUISourceCode(e,o),r(t,o)})}excludeFolder(e){}canExcludeFolder(e){return!1}async createFile(e,t,r,o){return null}canCreateFile(){return!1}deleteFile(e){}remove(){}performRename(e,t,r){r(!1)}searchInFileContent(e,t,r,o){const{contentProvider:s}=this.#t.get(e);return s.searchInContent(t,r,o)}async findFilesMatchingSearchRequest(e,r,o){const i=new Map;return o.setTotalWork(r.length),await Promise.all(r.map(async function(r){let n=!0,a=[];for(const o of e.queries().slice()){const i=await this.searchInFileContent(r,o,!e.ignoreCase(),e.isRegex());if(!i.length){n=!1;break}a=t.ArrayUtilities.mergeOrdered(a,i,s.ContentProvider.SearchMatch.comparator)}n&&i.set(r,a),o.incrementWorked(1)}.bind(this))),o.done(),i}indexContent(e){queueMicrotask(e.done.bind(e))}addUISourceCodeWithProvider(e,t,r,o){this.#t.set(e,{mimeType:o,metadata:r,contentProvider:t}),this.addUISourceCode(e)}addContentProvider(e,t,r){const o=this.createUISourceCode(e,t.contentType());return this.addUISourceCodeWithProvider(o,t,null,r),o}reset(){this.removeProject(),this.workspace().addProject(this)}dispose(){this.removeProject()}}var l=Object.freeze({__proto__:null,ContentProviderBasedProject:d});const g={removeFromIgnoreList:"Remove from ignore list",addScriptToIgnoreList:"Add script to ignore list",addDirectoryToIgnoreList:"Add directory to ignore list",addAllContentScriptsToIgnoreList:"Add all extension scripts to ignore list",addAllThirdPartyScriptsToIgnoreList:"Add all third-party scripts to ignore list",addAllAnonymousScriptsToIgnoreList:"Add all anonymous scripts to ignore list"},p=n.i18n.registerUIStrings("models/bindings/IgnoreListManager.ts",g),h=n.i18n.getLocalizedString.bind(void 0,p);let m;class S{#r;#o;#s;#i;constructor(t){this.#r=t,r.TargetManager.TargetManager.instance().addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.GlobalObjectCleared,this.clearCacheIfNeeded.bind(this),this),r.TargetManager.TargetManager.instance().addModelListener(r.RuntimeModel.RuntimeModel,r.RuntimeModel.Events.ExecutionContextCreated,this.onExecutionContextCreated,this,{scoped:!0}),r.TargetManager.TargetManager.instance().addModelListener(r.RuntimeModel.RuntimeModel,r.RuntimeModel.Events.ExecutionContextDestroyed,this.onExecutionContextDestroyed,this,{scoped:!0}),e.Settings.Settings.instance().moduleSetting("skip-stack-frames-pattern").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("skip-content-scripts").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("automatically-ignore-list-known-third-party-scripts").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("enable-ignore-listing").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("skip-anonymous-scripts").addChangeListener(this.patternChanged.bind(this)),this.#o=new Set,this.#s=new Map,this.#i=new Set,r.TargetManager.TargetManager.instance().observeModels(r.DebuggerModel.DebuggerModel,this)}static instance(e={forceNew:null,debuggerWorkspaceBinding:null}){const{forceNew:t,debuggerWorkspaceBinding:r}=e;if(!m||t){if(!r)throw new Error(`Unable to create settings: debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);m=new S(r)}return m}static removeInstance(){m=void 0}addChangeListener(e){this.#o.add(e)}removeChangeListener(e){this.#o.delete(e)}modelAdded(e){this.setIgnoreListPatterns(e);const t=e.sourceMapManager();t.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}modelRemoved(e){this.clearCacheIfNeeded();const t=e.sourceMapManager();t.removeEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.removeEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}isContentScript(e){return!e.isDefault}onExecutionContextCreated(e){if(this.isContentScript(e.data)&&(this.#i.add(e.data.uniqueId),this.skipContentScripts))for(const e of r.TargetManager.TargetManager.instance().models(r.DebuggerModel.DebuggerModel))this.updateIgnoredExecutionContexts(e)}onExecutionContextDestroyed(e){if(this.isContentScript(e.data)&&(this.#i.delete(e.data.uniqueId),this.skipContentScripts))for(const e of r.TargetManager.TargetManager.instance().models(r.DebuggerModel.DebuggerModel))this.updateIgnoredExecutionContexts(e)}clearCacheIfNeeded(){this.#s.size>1024&&this.#s.clear()}getSkipStackFramesPatternSetting(){return e.Settings.Settings.instance().moduleSetting("skip-stack-frames-pattern")}setIgnoreListPatterns(e){const t=this.enableIgnoreListing?this.getSkipStackFramesPatternSetting().getAsArray():[],r=[];for(const e of t)!e.disabled&&e.pattern&&r.push(e.pattern);return e.setBlackboxPatterns(r,this.skipAnonymousScripts)}updateIgnoredExecutionContexts(e){return e.setBlackboxExecutionContexts(this.skipContentScripts?Array.from(this.#i):[])}getGeneralRulesForUISourceCode(e){return{isContentScript:e.project().type()===i.Workspace.projectTypes.ContentScripts,isKnownThirdParty:e.isKnownThirdParty()}}isUserOrSourceMapIgnoreListedUISourceCode(e){if(e.isUnconditionallyIgnoreListed())return!0;const t=this.uiSourceCodeURL(e);return this.isUserIgnoreListedURL(t,this.getGeneralRulesForUISourceCode(e))}isUserIgnoreListedURL(e,t){if(!this.enableIgnoreListing)return!1;if(t?.isContentScript&&this.skipContentScripts)return!0;if(t?.isKnownThirdParty&&this.automaticallyIgnoreListKnownThirdPartyScripts)return!0;if(!e)return this.skipAnonymousScripts;if(this.#s.has(e))return Boolean(this.#s.get(e));const r=null!==this.getFirstMatchedRegex(e);return this.#s.set(e,r),r}getFirstMatchedRegex(e){if(!e)return null;const t=this.getSkipStackFramesPatternSetting().getAsArray();if(!this.urlToRegExpString(e))return null;for(let r=0;r<t.length;++r){const o=t[r];if(o.disabled||o.disabledForUrl===e)continue;const s=new RegExp(o.pattern);if(s.test(e))return s}return null}sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap;this.updateScriptRanges(t,r)}sourceMapDetached(e){const t=e.data.client;this.updateScriptRanges(t,void 0)}async updateScriptRanges(e,t){let r=!1;if(S.instance().isUserIgnoreListedURL(e.sourceURL,{isContentScript:e.isContentScript()})||(r=t?.sourceURLs().some(e=>this.isUserIgnoreListedURL(e,{isKnownThirdParty:t.hasIgnoreListHint(e)}))??!1),!r)return L.get(e)&&await e.setBlackboxedRanges([])&&L.delete(e),void await this.#r.updateLocations(e);if(!t)return;const o=t.findRanges(e=>this.isUserIgnoreListedURL(e,{isKnownThirdParty:t.hasIgnoreListHint(e)}),{isStartMatching:!0}).flatMap(e=>[e.start,e.end]);!function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r].lineNumber!==t[r].lineNumber||e[r].columnNumber!==t[r].columnNumber)return!1;return!0}(L.get(e)||[],o)&&await e.setBlackboxedRanges(o)&&L.set(e,o),this.#r.updateLocations(e)}uiSourceCodeURL(e){return e.project().type()===i.Workspace.projectTypes.Debugger?null:e.url()}canIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);return!!t&&Boolean(this.urlToRegExpString(t))}ignoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.ignoreListURL(t)}unIgnoreListUISourceCode(e){this.unIgnoreListURL(this.uiSourceCodeURL(e),this.getGeneralRulesForUISourceCode(e))}get enableIgnoreListing(){return e.Settings.Settings.instance().moduleSetting("enable-ignore-listing").get()}set enableIgnoreListing(t){e.Settings.Settings.instance().moduleSetting("enable-ignore-listing").set(t)}get skipContentScripts(){return this.enableIgnoreListing&&e.Settings.Settings.instance().moduleSetting("skip-content-scripts").get()}get skipAnonymousScripts(){return this.enableIgnoreListing&&e.Settings.Settings.instance().moduleSetting("skip-anonymous-scripts").get()}get automaticallyIgnoreListKnownThirdPartyScripts(){return this.enableIgnoreListing&&e.Settings.Settings.instance().moduleSetting("automatically-ignore-list-known-third-party-scripts").get()}ignoreListContentScripts(){this.enableIgnoreListing||(this.enableIgnoreListing=!0),e.Settings.Settings.instance().moduleSetting("skip-content-scripts").set(!0)}unIgnoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skip-content-scripts").set(!1)}ignoreListAnonymousScripts(){this.enableIgnoreListing||(this.enableIgnoreListing=!0),e.Settings.Settings.instance().moduleSetting("skip-anonymous-scripts").set(!0)}unIgnoreListAnonymousScripts(){e.Settings.Settings.instance().moduleSetting("skip-anonymous-scripts").set(!1)}ignoreListThirdParty(){this.enableIgnoreListing||(this.enableIgnoreListing=!0),e.Settings.Settings.instance().moduleSetting("automatically-ignore-list-known-third-party-scripts").set(!0)}unIgnoreListThirdParty(){e.Settings.Settings.instance().moduleSetting("automatically-ignore-list-known-third-party-scripts").set(!1)}ignoreListURL(e){const t=this.urlToRegExpString(e);t&&this.addRegexToIgnoreList(t,e)}addRegexToIgnoreList(e,t){const r=this.getSkipStackFramesPatternSetting().getAsArray();let o=!1;for(let s=0;s<r.length;++s){const i=r[s];(i.pattern===e||t&&i.disabledForUrl===t)&&(i.disabled=!1,i.disabledForUrl=void 0,o=!0)}o||r.push({pattern:e,disabled:!1}),this.enableIgnoreListing||(this.enableIgnoreListing=!0),this.getSkipStackFramesPatternSetting().setAsArray(r)}unIgnoreListURL(e,t){if(t?.isContentScript&&this.unIgnoreListContentScripts(),t?.isKnownThirdParty&&this.unIgnoreListThirdParty(),!e)return void this.unIgnoreListAnonymousScripts();let r=this.getSkipStackFramesPatternSetting().getAsArray();const o=S.instance().urlToRegExpString(e);if(o){r=r.filter(function(e){return e.pattern!==o});for(let t=0;t<r.length;++t){const o=r[t];if(!o.disabled)try{new RegExp(o.pattern).test(e)&&(o.disabled=!0,o.disabledForUrl=e)}catch{}}this.getSkipStackFramesPatternSetting().setAsArray(r)}}removeIgnoreListPattern(e){let t=this.getSkipStackFramesPatternSetting().getAsArray();t=t.filter(function(t){return t.pattern!==e}),this.getSkipStackFramesPatternSetting().setAsArray(t)}ignoreListHasPattern(e,t){return this.getSkipStackFramesPatternSetting().getAsArray().some(r=>!(t&&r.disabled)&&r.pattern===e)}async patternChanged(){this.#s.clear();const e=[];for(const t of r.TargetManager.TargetManager.instance().models(r.DebuggerModel.DebuggerModel)){e.push(this.setIgnoreListPatterns(t));const r=t.sourceMapManager();for(const o of t.scripts())e.push(this.updateScriptRanges(o,r.sourceMapForClient(o)));e.push(this.updateIgnoredExecutionContexts(t))}await Promise.all(e);const t=Array.from(this.#o);for(const e of t)e();this.patternChangeFinishedForTests()}patternChangeFinishedForTests(){}urlToRegExpString(r){const o=new e.ParsedURL.ParsedURL(r);if(o.isAboutBlank()||o.isDataURL())return"";if(!o.isValid)return"^"+t.StringUtilities.escapeForRegExp(r)+"$";let s=o.lastPathComponent;if(s?s="/"+s:o.folderPathComponents&&(s=o.folderPathComponents+"/"),s||(s=o.host),!s)return"";const i=o.scheme;let n="";return i&&"http"!==i&&"https"!==i&&(n="^"+i+"://","chrome-extension"===i&&(n+=o.host+"\\b"),n+=".*"),n+t.StringUtilities.escapeForRegExp(s)+(r.endsWith(s)?"$":"\\b")}getIgnoreListURLContextMenuItems(e){if(e.project().type()===i.Workspace.projectTypes.FileSystem)return[];const t=[],r=this.canIgnoreListUISourceCode(e),o=this.isUserOrSourceMapIgnoreListedUISourceCode(e),s=!this.uiSourceCodeURL(e),{isContentScript:n,isKnownThirdParty:a}=this.getGeneralRulesForUISourceCode(e);return o?(r||n||a||s)&&t.push({text:h(g.removeFromIgnoreList),callback:this.unIgnoreListUISourceCode.bind(this,e),jslogContext:"remove-script-from-ignorelist"}):(r?t.push({text:h(g.addScriptToIgnoreList),callback:this.ignoreListUISourceCode.bind(this,e),jslogContext:"add-script-to-ignorelist"}):s&&t.push({text:h(g.addAllAnonymousScriptsToIgnoreList),callback:this.ignoreListAnonymousScripts.bind(this),jslogContext:"add-anonymous-scripts-to-ignorelist"}),t.push(...this.getIgnoreListGeneralContextMenuItems({isContentScript:n,isKnownThirdParty:a}))),t}getIgnoreListGeneralContextMenuItems(e){const t=[];return e?.isContentScript&&t.push({text:h(g.addAllContentScriptsToIgnoreList),callback:this.ignoreListContentScripts.bind(this),jslogContext:"add-content-scripts-to-ignorelist"}),e?.isKnownThirdParty&&t.push({text:h(g.addAllThirdPartyScriptsToIgnoreList),callback:this.ignoreListThirdParty.bind(this),jslogContext:"add-3p-scripts-to-ignorelist"}),t}getIgnoreListFolderContextMenuItems(e,r){const o=[],s="^"+t.StringUtilities.escapeForRegExp(e)+"/";return this.ignoreListHasPattern(s,!0)?o.push({text:h(g.removeFromIgnoreList),callback:this.removeIgnoreListPattern.bind(this,s),jslogContext:"remove-from-ignore-list"}):this.isUserIgnoreListedURL(e,r)?o.push({text:h(g.removeFromIgnoreList),callback:this.unIgnoreListURL.bind(this,e,r),jslogContext:"remove-from-ignore-list"}):r?.isCurrentlyIgnoreListed||(o.push({text:h(g.addDirectoryToIgnoreList),callback:this.addRegexToIgnoreList.bind(this,s),jslogContext:"add-directory-to-ignore-list"}),o.push(...this.getIgnoreListGeneralContextMenuItems(r))),o}}const L=new WeakMap;var M=Object.freeze({__proto__:null,IgnoreListManager:S});const f=new WeakMap,b=new WeakMap;let C;class w extends e.ObjectWrapper.ObjectWrapper{constructor(){super()}static instance({forceNew:e}={forceNew:!1}){return C&&!e||(C=new w),C}}class I{static resolveFrame(e,t){const o=I.targetForUISourceCode(e),s=o?.model(r.ResourceTreeModel.ResourceTreeModel);return s?s.frameForId(t):null}static setInitialFrameAttribution(e,t){if(!t)return;const r=I.resolveFrame(e,t);if(!r)return;const o=new Map;o.set(t,{frame:r,count:1}),f.set(e,o)}static cloneInitialFrameAttribution(e,t){const r=f.get(e);if(!r)return;const o=new Map;for(const e of r.keys()){const t=r.get(e);void 0!==t&&o.set(e,{frame:t.frame,count:t.count})}f.set(t,o)}static addFrameAttribution(e,t){const r=I.resolveFrame(e,t);if(!r)return;const o=f.get(e);if(!o)return;const s=o.get(t)||{frame:r,count:0};if(s.count+=1,o.set(t,s),1!==s.count)return;const i={uiSourceCode:e,frame:r};w.instance().dispatchEventToListeners("FrameAttributionAdded",i)}static removeFrameAttribution(e,t){const r=f.get(e);if(!r)return;const o=r.get(t);if(console.assert(Boolean(o),"Failed to remove frame attribution for url: "+e.url()),!o)return;if(o.count-=1,o.count>0)return;r.delete(t);const s={uiSourceCode:e,frame:o.frame};w.instance().dispatchEventToListeners("FrameAttributionRemoved",s)}static targetForUISourceCode(e){return b.get(e.project())||null}static setTargetForProject(e,t){b.set(e,t)}static getTargetForProject(e){return b.get(e)||null}static framesForUISourceCode(e){const t=I.targetForUISourceCode(e),o=t?.model(r.ResourceTreeModel.ResourceTreeModel),s=f.get(e);return o&&s?Array.from(s.keys()).map(e=>o.frameForId(e)).filter(e=>!!e):[]}}var v=Object.freeze({__proto__:null,NetworkProject:I,NetworkProjectManager:w});class y{#n;#r;#a=new Map;#c;#u;#d=new Map;#l=new Map;#h=new t.MapUtilities.Multimap;constructor(e,t,o){this.#n=e.sourceMapManager(),this.#r=o,this.#c=new d(t,"jsSourceMaps:stub:"+e.target().id(),i.Workspace.projectTypes.Service,"",!0),this.#u=[this.#n.addEventListener(r.SourceMapManager.Events.SourceMapWillAttach,this.sourceMapWillAttach,this),this.#n.addEventListener(r.SourceMapManager.Events.SourceMapFailedToAttach,this.sourceMapFailedToAttach,this),this.#n.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#n.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}setFunctionRanges(e,t){for(const r of this.#h.get(e))r.augmentWithScopes(e.url(),t)}addStubUISourceCode(t){const r=this.#c.addContentProvider(e.ParsedURL.ParsedURL.concatenate(t.sourceURL,":sourcemap"),s.StaticContentProvider.StaticContentProvider.fromString(t.sourceURL,e.ResourceType.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this.#a.set(t,r)}removeStubUISourceCode(e){const t=this.#a.get(e);this.#a.delete(e),t&&this.#c.removeUISourceCode(t.url())}getLocationRangesForSameSourceLocation(e){const t=e.debuggerModel,r=e.script();if(!r)return[];const o=this.#n.sourceMapForClient(r);if(!o)return[];const{lineNumber:s,columnNumber:i}=r.rawLocationToRelativeLocation(e),n=o.findEntry(s,i);if(!n||!n.sourceURL)return[];const a=this.#l.get(o);if(!a)return[];const c=a.uiSourceCodeForURL(n.sourceURL);return c&&this.#h.hasValue(c,o)?o.findReverseRanges(n.sourceURL,n.sourceLineNumber,n.sourceColumnNumber).map(({startLine:e,startColumn:o,endLine:s,endColumn:i})=>{const n=r.relativeLocationToRawLocation({lineNumber:e,columnNumber:o}),a=r.relativeLocationToRawLocation({lineNumber:s,columnNumber:i});return{start:t.createRawLocation(r,n.lineNumber,n.columnNumber),end:t.createRawLocation(r,a.lineNumber,a.columnNumber)}}):[]}uiSourceCodeForURL(e,t){const r=t?i.Workspace.projectTypes.ContentScripts:i.Workspace.projectTypes.Network;for(const t of this.#d.values()){if(t.type()!==r)continue;const o=t.uiSourceCodeForURL(e);if(o)return o}return null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const{lineNumber:r,columnNumber:o}=t.rawLocationToRelativeLocation(e),s=this.#a.get(t);if(s)return new i.UISourceCode.UILocation(s,r,o);const n=this.#n.sourceMapForClient(t);if(!n)return null;const a=this.#l.get(n);if(!a)return null;const c=n.findEntry(r,o,e.inlineFrameIndex);if(!c||!c.sourceURL)return null;const u=a.uiSourceCodeForURL(c.sourceURL);return u&&this.#h.hasValue(u,n)?u.uiLocation(c.sourceLineNumber,c.sourceColumnNumber):null}uiLocationToRawLocations(e,t,r){const o=[];for(const s of this.#h.get(e)){const i=s.sourceLineMapping(e.url(),t,r);if(!i)continue;const n=this.#n.clientForSourceMap(s);if(!n)continue;const a=n.relativeLocationToRawLocation(i);o.push(n.debuggerModel.createRawLocation(n,a.lineNumber,a.columnNumber))}return o}uiLocationRangeToRawLocationRanges(e,t){if(!this.#h.has(e))return null;const r=[];for(const o of this.#h.get(e)){const s=this.#n.clientForSourceMap(o);if(s)for(const i of o.reverseMapTextRanges(e.url(),t)){const e=s.relativeLocationToRawLocation(i.start),t=s.relativeLocationToRawLocation(i.end),o=s.debuggerModel.createRawLocation(s,e.lineNumber,e.columnNumber),n=s.debuggerModel.createRawLocation(s,t.lineNumber,t.columnNumber);r.push({start:o,end:n})}}return r}getMappedLines(e){if(!this.#h.has(e))return null;const t=new Set;for(const r of this.#h.get(e))for(const o of r.mappings())o.sourceURL===e.url()&&t.add(o.sourceLineNumber);return t}sourceMapWillAttach(e){const{client:t}=e.data;this.addStubUISourceCode(t),this.#r.updateLocations(t),S.instance().isUserIgnoreListedURL(t.sourceURL,{isContentScript:t.isContentScript()})&&this.#n.cancelAttachSourceMap(t)}sourceMapFailedToAttach(e){const{client:t}=e.data;this.removeStubUISourceCode(t),this.#r.updateLocations(t)}sourceMapAttached(t){const{client:o,sourceMap:n}=t.data,a=new Set([o]);this.removeStubUISourceCode(o);const c=o.target(),u=`jsSourceMaps:${o.isContentScript()?"extensions":""}:${c.id()}`;let l=this.#d.get(u);if(!l){const e=o.isContentScript()?i.Workspace.projectTypes.ContentScripts:i.Workspace.projectTypes.Network;l=new d(this.#c.workspace(),u,e,"",!1),I.setTargetForProject(l,c),this.#d.set(u,l)}this.#l.set(n,l);for(const t of n.sourceURLs()){const c=e.ResourceType.resourceTypes.SourceMapScript,u=l.createUISourceCode(t,c);n.hasIgnoreListHint(t)&&u.markKnownThirdParty();const d=n.embeddedContentByURL(t),h=null!==d?s.StaticContentProvider.StaticContentProvider.fromString(t,c,d):new r.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(t,c,o.createPageResourceLoadInitiator());let g=null;if(null!==d){const e=new TextEncoder;g=new i.UISourceCode.UISourceCodeMetadata(null,e.encode(d).length)}const p=e.ResourceType.ResourceType.mimeFromURL(t)??c.canonicalMimeType();this.#h.set(u,n),I.setInitialFrameAttribution(u,o.frameId);const m=l.uiSourceCodeForURL(t);if(null!==m){for(const e of this.#h.get(m)){this.#h.delete(m,e);const r=this.#n.clientForSourceMap(e);r&&(I.removeFrameAttribution(m,r.frameId),n.compatibleForURL(t,e)&&(this.#h.set(u,e),I.addFrameAttribution(u,r.frameId)),a.add(r))}l.removeUISourceCode(t)}l.addUISourceCodeWithProvider(u,h,g,p)}Promise.all([...a].map(e=>this.#r.updateLocations(e))).then(()=>this.sourceMapAttachedForTest(n))}sourceMapDetached(e){const{client:t,sourceMap:r}=e.data,o=this.#l.get(r);if(o){for(const e of o.uiSourceCodes())this.#h.delete(e,r)&&(I.removeFrameAttribution(e,t.frameId),this.#h.has(e)||o.removeUISourceCode(e.url()));this.#l.delete(r),this.#r.updateLocations(t)}}scriptsForUISourceCode(e){const t=[];for(const r of this.#h.get(e)){const e=this.#n.clientForSourceMap(r);e&&t.push(e)}return t}sourceMapAttachedForTest(e){}dispose(){e.EventTarget.removeEventListeners(this.#u);for(const e of this.#d.values())e.dispose();this.#c.dispose()}}var T=Object.freeze({__proto__:null,CompilerScriptMapping:y});class R{#g;#p;#m;constructor(e,t){this.#g=e,this.#p=t,this.#p.add(this),this.#m=null}async update(){this.#g&&(this.#m?await this.#m.then(()=>this.update()):(this.#m=this.#g(this),await this.#m,this.#m=null))}async uiLocation(){throw new Error("Not implemented")}dispose(){this.#p.delete(this),this.#g=null}isDisposed(){return!this.#p.has(this)}async isIgnoreListed(){throw new Error("Not implemented")}}class F{#S;constructor(){this.#S=new Set}add(e){this.#S.add(e)}delete(e){this.#S.delete(e)}has(e){return this.#S.has(e)}disposeAll(){for(const e of this.#S)e.dispose()}}var U=Object.freeze({__proto__:null,LiveLocationPool:F,LiveLocationWithPool:R});class P{#n;#L;#u;#f;constructor(e,t,o){this.#n=t,this.#L=new d(o,"cssSourceMaps:"+e.id(),i.Workspace.projectTypes.Network,"",!1),I.setTargetForProject(this.#L,e),this.#f=new Map,this.#u=[this.#n.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#n.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}sourceMapAttachedForTest(e){}async sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap,o=this.#L,s=this.#f;for(const e of r.sourceURLs()){let i=s.get(e);i||(i=new j(o,e,t.createPageResourceLoadInitiator()),s.set(e,i)),i.addSourceMap(r,t.frameId)}await z.instance().updateLocations(t),this.sourceMapAttachedForTest(r)}async sourceMapDetached(e){const t=e.data.client,r=e.data.sourceMap,o=this.#f;for(const e of r.sourceURLs()){const s=o.get(e);s&&(s.removeSourceMap(r,t.frameId),s.getUiSourceCode()||o.delete(e))}await z.instance().updateLocations(t)}rawLocationToUILocation(e){const t=e.header();if(!t)return null;const r=this.#n.sourceMapForClient(t);if(!r)return null;let{lineNumber:o,columnNumber:s}=e;r.mapsOrigin()&&t.isInline&&(o-=t.startLine,0===o&&(s-=t.startColumn));const i=r.findEntry(o,s);if(!i||!i.sourceURL)return null;const n=this.#L.uiSourceCodeForURL(i.sourceURL);return n?n.uiLocation(i.sourceLineNumber,i.sourceColumnNumber):null}uiLocationToRawLocations(e){const{uiSourceCode:t,lineNumber:o,columnNumber:s=0}=e,i=k.get(t);if(!i)return[];const n=[];for(const e of i.getReferringSourceMaps()){const i=e.findReverseEntries(t.url(),o,s),a=this.#n.clientForSourceMap(e);a&&n.push(...i.map(e=>new r.CSSModel.CSSLocation(a,e.lineNumber,e.columnNumber)))}return n}static uiSourceOrigin(e){const t=k.get(e);return t?t.getReferringSourceMaps().map(e=>e.compiledURL()):[]}dispose(){e.EventTarget.removeEventListeners(this.#u),this.#L.dispose()}}const k=new WeakMap;let j=class{#L;#C;#b;referringSourceMaps;uiSourceCode;constructor(e,t,r){this.#L=e,this.#C=t,this.#b=r,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t){const o=this.referringSourceMaps[this.referringSourceMaps.length-1],n=e.ResourceType.resourceTypes.SourceMapStyleSheet,a=o.embeddedContentByURL(this.#C),c=null!==a?s.StaticContentProvider.StaticContentProvider.fromString(this.#C,n,a):new r.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(this.#C,n,this.#b),u=this.#L.createUISourceCode(this.#C,n);k.set(u,this);const d=e.ResourceType.ResourceType.mimeFromURL(this.#C)||n.canonicalMimeType(),l="string"==typeof a?new i.UISourceCode.UISourceCodeMetadata(null,a.length):null;this.uiSourceCode?(I.cloneInitialFrameAttribution(this.uiSourceCode,u),this.#L.removeUISourceCode(this.uiSourceCode.url())):I.setInitialFrameAttribution(u,t),this.uiSourceCode=u,this.#L.addUISourceCodeWithProvider(this.uiSourceCode,c,l,d)}addSourceMap(e,t){this.uiSourceCode&&I.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const r=this.uiSourceCode;I.removeFrameAttribution(r,t);const o=this.referringSourceMaps.lastIndexOf(e);-1!==o&&this.referringSourceMaps.splice(o,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t):(this.#L.removeUISourceCode(r.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}};var D=Object.freeze({__proto__:null,SASSSourceMapping:P});function E(e){return r.ResourceTreeModel.ResourceTreeModel.resourceForURL(e)}function x(e,t,o){const s=e.model(r.ResourceTreeModel.ResourceTreeModel);if(!s)return null;const i=s.frameForId(t);return i?N(i.resourceForURL(o)):null}function N(e){return!e||"number"!=typeof e.contentSize()&&!e.lastModified()?null:new i.UISourceCode.UISourceCodeMetadata(e.lastModified(),e.contentSize())}var A=Object.freeze({__proto__:null,displayNameForURL:function(o){if(!o)return"";const s=E(o);if(s)return s.displayName;const n=i.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(o);if(n)return n.displayName();const a=r.TargetManager.TargetManager.instance().inspectedURL();if(!a)return t.StringUtilities.trimURL(o,"");const c=e.ParsedURL.ParsedURL.fromString(a);if(!c)return o;const u=c.lastPathComponent,d=a.indexOf(u);if(-1!==d&&d+u.length===a.length){const e=a.substring(0,d);if(o.startsWith(e)&&o.length>d)return o.substring(d)}const l=t.StringUtilities.trimURL(o,c.host);return"/"===l?c.host+"/":l},metadataForURL:x,resourceForURL:E,resourceMetadata:N});const O=new WeakMap;class W{#M;#w;#I;#v;#u;constructor(e,t){this.#M=e;const o=this.#M.target();this.#w=new d(t,"css:"+o.id(),i.Workspace.projectTypes.Network,"",!1),I.setTargetForProject(this.#w,o),this.#I=new d(t,"inspector:"+o.id(),i.Workspace.projectTypes.Inspector,"",!0),this.#v=new Map,this.#u=[this.#M.addEventListener(r.CSSModel.Events.StyleSheetAdded,this.styleSheetAdded,this),this.#M.addEventListener(r.CSSModel.Events.StyleSheetRemoved,this.styleSheetRemoved,this),this.#M.addEventListener(r.CSSModel.Events.StyleSheetChanged,this.styleSheetChanged,this)]}addSourceMap(e,t){this.#v.get(e)?.addSourceMap(e,t)}rawLocationToUILocation(e){const t=e.header();if(!t||!this.acceptsHeader(t))return null;const r=this.#v.get(t.resourceURL());if(!r)return null;let o=e.lineNumber,s=e.columnNumber;if(t.isInline&&t.hasSourceURL){o-=t.lineNumberInSource(0);const e=t.columnNumberInSource(o,0);void 0===e?s=e:s-=e}return r.getUiSourceCode().uiLocation(o,s)}uiLocationToRawLocations(e){const t=O.get(e.uiSourceCode);if(!t)return[];const o=[];for(const s of t.getHeaders()){let t=e.lineNumber,i=e.columnNumber;s.isInline&&s.hasSourceURL&&(i=s.columnNumberInSource(t,e.columnNumber||0),t=s.lineNumberInSource(t)),o.push(new r.CSSModel.CSSLocation(s,t,i))}return o}acceptsHeader(e){return!(e.isConstructedByNew()||e.isInline&&!e.hasSourceURL&&"inspector"!==e.origin||!e.resourceURL())}styleSheetAdded(e){const t=e.data;if(!this.acceptsHeader(t))return;const r=t.resourceURL();let o=this.#v.get(r);if(o)o.addHeader(t);else{const e=t.isViaInspector()?this.#I:this.#w;o=new B(this.#M,e,t),this.#v.set(r,o)}}styleSheetRemoved(e){const t=e.data;if(!this.acceptsHeader(t))return;const r=t.resourceURL(),o=this.#v.get(r);o&&(1===o.getHeaders().size?(o.dispose(),this.#v.delete(r)):o.removeHeader(t))}styleSheetChanged(e){const t=this.#M.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!this.acceptsHeader(t))return;const r=this.#v.get(t.resourceURL());r&&r.styleSheetChanged(t)}dispose(){for(const e of this.#v.values())e.dispose();this.#v.clear(),e.EventTarget.removeEventListeners(this.#u),this.#I.removeProject(),this.#w.removeProject()}}class B{#M;#L;headers;uiSourceCode;#u;#R;#y;#F;#T;constructor(t,r,o){this.#M=t,this.#L=r,this.headers=new Set([o]);const s=t.target(),n=o.resourceURL(),a=x(s,o.frameId,n);this.uiSourceCode=this.#L.createUISourceCode(n,o.contentType()),O.set(this.uiSourceCode,this),I.setInitialFrameAttribution(this.uiSourceCode,o.frameId),this.#L.addUISourceCodeWithProvider(this.uiSourceCode,this,a,"text/css"),this.#u=[this.uiSourceCode.addEventListener(i.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.addEventListener(i.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)],this.#R=new e.Throttler.Throttler(B.updateTimeout),this.#y=!1}addHeader(e){this.headers.add(e),I.addFrameAttribution(this.uiSourceCode,e.frameId)}removeHeader(e){this.headers.delete(e),I.removeFrameAttribution(this.uiSourceCode,e.frameId)}styleSheetChanged(e){if(console.assert(this.headers.has(e)),this.#T||!this.headers.has(e))return;const t=this.mirrorContent.bind(this,e,!0);this.#R.schedule(t,"Default")}workingCopyCommitted(){if(this.#F)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!0);this.#R.schedule(e,"AsSoonAsPossible")}workingCopyChanged(){if(this.#F)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!1);this.#R.schedule(e,"Default")}async mirrorContent(e,t){if(this.#y)return void this.styleFileSyncedForTest();let r=null;if(r=e===this.uiSourceCode?this.uiSourceCode.workingCopy():s.ContentData.ContentData.textOr(await e.requestContentData(),null),null===r||this.#y)return void this.styleFileSyncedForTest();e!==this.uiSourceCode&&(this.#F=!0,this.uiSourceCode.setWorkingCopy(r),this.#F=!1),this.#T=!0;const o=[];for(const s of this.headers)s!==e&&o.push(this.#M.setStyleSheetText(s.id,r,t));await Promise.all(o),this.#T=!1,this.styleFileSyncedForTest()}styleFileSyncedForTest(){}dispose(){this.#y||(this.#y=!0,this.#L.removeUISourceCode(this.uiSourceCode.url()),e.EventTarget.removeEventListeners(this.#u))}contentURL(){return console.assert(this.headers.size>0),this.#U().originalContentProvider().contentURL()}contentType(){return console.assert(this.headers.size>0),this.#U().originalContentProvider().contentType()}requestContent(){return console.assert(this.headers.size>0),this.#U().originalContentProvider().requestContent()}requestContentData(){return console.assert(this.headers.size>0),this.#U().originalContentProvider().requestContentData()}searchInContent(e,t,r){return console.assert(this.headers.size>0),this.#U().originalContentProvider().searchInContent(e,t,r)}#U(){return console.assert(this.headers.size>0),this.headers.values().next().value}static updateTimeout=200;getHeaders(){return this.headers}getUiSourceCode(){return this.uiSourceCode}addSourceMap(e,t){const r=this.#M.sourceMapManager();this.headers.forEach(o=>{r.detachSourceMap(o),r.attachSourceMap(o,e,t)})}}var H=Object.freeze({__proto__:null,StyleFile:B,StylesSourceMapping:W});let _;class z{#P;#k;#x;constructor(e,t){this.#P=e,this.#k=new Map,t.observeModels(r.CSSModel.CSSModel,this),this.#x=new Set}static instance(e={forceNew:null,resourceMapping:null,targetManager:null}){const{forceNew:t,resourceMapping:r,targetManager:o}=e;if(!_||t){if(!r||!o)throw new Error(`Unable to create CSSWorkspaceBinding: resourceMapping and targetManager must be provided: ${(new Error).stack}`);_=new z(r,o)}return _}static removeInstance(){_=void 0}get modelToInfo(){return this.#k}getCSSModelInfo(e){return this.#k.get(e)}modelAdded(e){this.#k.set(e,new V(e,this.#P))}modelRemoved(e){this.getCSSModelInfo(e).dispose(),this.#k.delete(e)}async pendingLiveLocationChangesPromise(){await Promise.all(this.#x)}recordLiveLocationChange(e){e.then(()=>{this.#x.delete(e)}),this.#x.add(e)}async updateLocations(e){const t=this.getCSSModelInfo(e.cssModel()).updateLocations(e);this.recordLiveLocationChange(t),await t}createLiveLocation(e,t,r){const o=this.getCSSModelInfo(e.cssModel()).createLiveLocation(e,t,r);return this.recordLiveLocationChange(o),o}propertyRawLocation(e,t){const o=e.ownerStyle;if(!o||o.type!==r.CSSStyleDeclaration.Type.Regular||!o.styleSheetId)return null;const s=o.cssModel().styleSheetHeaderForId(o.styleSheetId);if(!s)return null;const i=t?e.nameRange():e.valueRange();if(!i)return null;const n=i.startLine,a=i.startColumn;return new r.CSSModel.CSSLocation(s,s.lineNumberInSource(n),s.columnNumberInSource(n,a))}propertyUILocation(e,t){const r=this.propertyRawLocation(e,t);return r?this.rawLocationToUILocation(r):null}rawLocationToUILocation(e){return this.getCSSModelInfo(e.cssModel()).rawLocationToUILocation(e)}uiLocationToRawLocations(e){const t=[];for(const r of this.#k.values())t.push(...r.uiLocationToRawLocations(e));return t}}let V=class{#u;#P;#E;#j;#S;#N;constructor(e,o){this.#u=[e.addEventListener(r.CSSModel.Events.StyleSheetAdded,e=>{this.styleSheetAdded(e)},this),e.addEventListener(r.CSSModel.Events.StyleSheetRemoved,e=>{this.styleSheetRemoved(e)},this)],this.#P=o,this.#E=new W(e,o.workspace);const s=e.sourceMapManager();this.#j=new P(e.target(),s,o.workspace),this.#S=new t.MapUtilities.Multimap,this.#N=new t.MapUtilities.Multimap}get locations(){return this.#S}async createLiveLocation(e,t,r){const o=new q(e,this,t,r),s=e.header();return s?(o.setHeader(s),this.#S.set(s,o),await o.update()):this.#N.set(e.url,o),o}disposeLocation(e){const t=e.header();t?this.#S.delete(t,e):this.#N.delete(e.url,e)}updateLocations(e){const t=[];for(const r of this.#S.get(e))t.push(r.update());return Promise.all(t)}async styleSheetAdded(e){const t=e.data;if(!t.sourceURL)return;const r=[];for(const e of this.#N.get(t.sourceURL))e.setHeader(t),this.#S.set(t,e),r.push(e.update());await Promise.all(r),this.#N.deleteAll(t.sourceURL)}async styleSheetRemoved(e){const t=e.data,r=[];for(const e of this.#S.get(t))e.setHeader(t),this.#N.set(e.url,e),r.push(e.update());await Promise.all(r),this.#S.deleteAll(t)}addSourceMap(e,t){this.#E.addSourceMap(e,t)}rawLocationToUILocation(e){let t=null;return t=t||this.#j.rawLocationToUILocation(e),t=t||this.#E.rawLocationToUILocation(e),t=t||this.#P.cssLocationToUILocation(e),t}uiLocationToRawLocations(e){let t=this.#j.uiLocationToRawLocations(e);return t.length?t:(t=this.#E.uiLocationToRawLocations(e),t.length?t:this.#P.uiLocationToCSSLocations(e))}dispose(){e.EventTarget.removeEventListeners(this.#u),this.#E.dispose(),this.#j.dispose()}};class q extends R{url;#D;#A;#O;headerInternal;constructor(e,t,r,o){super(r,o),this.url=e.url,this.#D=e.lineNumber,this.#A=e.columnNumber,this.#O=t,this.headerInternal=null}header(){return this.headerInternal}setHeader(e){this.headerInternal=e}async uiLocation(){if(!this.headerInternal)return null;const e=new r.CSSModel.CSSLocation(this.headerInternal,this.#D,this.#A);return z.instance().rawLocationToUILocation(e)}dispose(){super.dispose(),this.#O.disposeLocation(this)}async isIgnoreListed(){return!1}}var G=Object.freeze({__proto__:null,CSSWorkspaceBinding:z,LiveLocation:q,ModelInfo:V});const K={errorInDebuggerLanguagePlugin:"Error in debugger language plugin: {PH1}",loadingDebugSymbolsForVia:"[{PH1}] Loading debug symbols for {PH2} (via {PH3})...",loadingDebugSymbolsFor:"[{PH1}] Loading debug symbols for {PH2}...",loadedDebugSymbolsForButDidnt:"[{PH1}] Loaded debug symbols for {PH2}, but didn't find any source files",loadedDebugSymbolsForFound:"[{PH1}] Loaded debug symbols for {PH2}, found {PH3} source file(s)",failedToLoadDebugSymbolsFor:"[{PH1}] Failed to load debug symbols for {PH2} ({PH3})",failedToLoadDebugSymbolsForFunction:'No debug information for function "{PH1}"',debugSymbolsIncomplete:"The debug information for function {PH1} is incomplete"},$=n.i18n.registerUIStrings("models/bindings/DebuggerLanguagePlugins.ts",K),J=n.i18n.getLocalizedString.bind(void 0,$);function X(e){return`${e.sourceURL}@${e.hash}`}function Q(e){const{script:t}=e;return{rawModuleId:X(t),codeOffset:e.location().columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex}}class Y extends Error{exception;exceptionDetails;constructor(e,t){const{description:r}=t.exception||{};super(r||t.text),this.exception=e,this.exceptionDetails=t}static makeLocal(e,t){const r={type:"object",subtype:"error",description:t},o={text:"Uncaught",exceptionId:-1,columnNumber:0,lineNumber:0,exception:r},s=e.debuggerModel.runtimeModel().createRemoteObject(r);return new Y(s,o)}}class Z extends r.RemoteObject.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}async function ee(e,t,r){if("reftype"===t.type){const r=await async function(e,t){if(!/^(local|global|operand)$/.test(t.valueClass))return{type:"undefined"};const r=Number(t.index),o=`${t.valueClass}s[${r}]`,s=await e.debuggerModel.agent.invoke_evaluateOnCallFrame({callFrameId:e.id,expression:o,silent:!0,generatePreview:!0,throwOnSideEffect:!0});return s.getError()||s.exceptionDetails?{type:"undefined"}:s.result}(e,t);return e.debuggerModel.runtimeModel().createRemoteObject(r)}return new re(e,t,r)}class te extends r.RemoteObject.RemoteObjectImpl{variables;#W;#B;stopId;constructor(e,t,r){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this.#W=e,this.#B=r,this.stopId=t}async doGetProperties(e,t,o){if(t)return{properties:[],internalProperties:[]};const s=[],i={};function n(e,t){return new r.RemoteObject.RemoteObjectProperty(e,t,!1,!1,!0,!1)}for(const t of this.variables){let o;try{const e=await this.#B.evaluate(t.name,Q(this.#W),this.stopId);o=e?await ee(this.#W,e,this.#B):new r.RemoteObject.LocalJSONObject(void 0)}catch(e){console.warn(e),o=new r.RemoteObject.LocalJSONObject(void 0)}if(t.nestedName&&t.nestedName.length>1){let e=i;for(let r=0;r<t.nestedName.length-1;r++){const o=t.nestedName[r];let s=e[o];s||(s=new Z({}),e[o]=s),e=s.value}e[t.nestedName[t.nestedName.length-1]]=o}else s.push(n(t.name,o))}for(const e in i)s.push(n(e,i[e]));return{properties:s,internalProperties:[]}}}class oe{#H;#_;#z;#$;#J;constructor(e,t,r,o,s,i){if(s&&"data:"!==new URL(s).protocol)throw new Error("The icon must be a data:-URL");this.#H=e,this.#_=r,this.#z=o,this.#$=s,this.#J=new te(e,t,i)}async getVariableValue(e){for(let t=0;t<this.#J.variables.length;++t){if(this.#J.variables[t].name!==e)continue;const r=await this.#J.getAllProperties(!1,!1);if(!r.properties)continue;const{value:o}=r.properties[t];if(o)return o}return null}callFrame(){return this.#H}type(){return this.#_}typeName(){return this.#z}name(){}range(){return null}object(){return this.#J}description(){return""}icon(){return this.#$}extraProperties(){return[]}}class re extends r.RemoteObject.RemoteObject{extensionObject;plugin;callFrame;constructor(e,t,r){super(),this.extensionObject=t,this.plugin=r,this.callFrame=e}get linearMemoryAddress(){return this.extensionObject.linearMemoryAddress}get linearMemorySize(){return this.extensionObject.linearMemorySize}get objectId(){return this.extensionObject.objectId}get type(){return"array"===this.extensionObject.type||"null"===this.extensionObject.type?"object":this.extensionObject.type}get subtype(){if("array"===this.extensionObject.type||"null"===this.extensionObject.type)return this.extensionObject.type}get value(){return this.extensionObject.value}unserializableValue(){}get description(){return this.extensionObject.description}set description(e){}get hasChildren(){return this.extensionObject.hasChildren}get preview(){}get className(){return this.extensionObject.className??null}arrayLength(){return 0}arrayBufferByteLength(){return 0}getOwnProperties(e,t){return this.getAllProperties(!1,e,t)}async getAllProperties(e,t,s){const{objectId:i}=this.extensionObject;if(i){o(this.plugin.getProperties);const e=await this.plugin.getProperties(i);return{properties:await Promise.all(e.map(async e=>new r.RemoteObject.RemoteObjectProperty(e.name,await ee(this.callFrame,e.value,this.plugin)))),internalProperties:null}}return{properties:null,internalProperties:null}}release(){const{objectId:e}=this.extensionObject;e&&(o(this.plugin.releaseObject),this.plugin.releaseObject(e))}debuggerModel(){return this.callFrame.debuggerModel}runtimeModel(){return this.callFrame.debuggerModel.runtimeModel()}isLinearMemoryInspectable(){return void 0!==this.extensionObject.linearMemoryAddress}}class se{#V;#r;#K;#q;#G;callFrameByStopId=new Map;stopIdByCallFrame=new Map;nextStopId=0n;constructor(e,t,o){this.#V=t,this.#r=o,this.#K=[],this.#q=new Map,e.observeModels(r.DebuggerModel.DebuggerModel,this),this.#G=new Map}async evaluateOnCallFrame(e,t){const{script:o}=e,{expression:s,returnByValue:i,throwOnSideEffect:n}=t,{plugin:a}=await this.rawModuleIdAndPluginForScript(o);if(!a)return null;const c=Q(e);if(0===(await a.rawLocationToSourceLocation(c)).length)return null;if(i)return{error:"Cannot return by value"};if(n)return{error:"Cannot guarantee side-effect freedom"};try{const t=await a.evaluate(s,c,this.stopIdForCallFrame(e));return t?{object:await ee(e,t,a),exceptionDetails:void 0}:{object:new r.RemoteObject.LocalJSONObject(void 0),exceptionDetails:void 0}}catch(t){if(t instanceof Y){const{exception:e,exceptionDetails:r}=t;return{object:e,exceptionDetails:r}}const{exception:r,exceptionDetails:o}=Y.makeLocal(e,t.message);return{object:r,exceptionDetails:o}}}stopIdForCallFrame(e){let t=this.stopIdByCallFrame.get(e);return void 0!==t||(t=this.nextStopId++,this.stopIdByCallFrame.set(e,t),this.callFrameByStopId.set(t,e)),t}callFrameForStopId(e){return this.callFrameByStopId.get(e)}expandCallFrames(e){return Promise.all(e.map(async e=>{const t=await this.getFunctionInfo(e.script,e.location());if(t){if("frames"in t&&t.frames.length)return t.frames.map(({name:t},r)=>e.createVirtualCallFrame(r,t));if("missingSymbolFiles"in t&&t.missingSymbolFiles.length){const r=t.missingSymbolFiles,o=J(K.debugSymbolsIncomplete,{PH1:e.functionName});e.missingDebugInfoDetails={details:o,resources:r}}else e.missingDebugInfoDetails={details:J(K.failedToLoadDebugSymbolsForFunction,{PH1:e.functionName}),resources:[]}}return e})).then(e=>e.flat())}modelAdded(e){this.#q.set(e,new ie(e,this.#V)),e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),e.setEvaluateOnCallFrameCallback(this.evaluateOnCallFrame.bind(this)),e.setExpandCallFramesCallback(this.expandCallFrames.bind(this))}modelRemoved(t){t.removeEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),t.removeEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),t.removeEventListener(r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),t.setEvaluateOnCallFrameCallback(null),t.setExpandCallFramesCallback(null);const o=this.#q.get(t);o&&(o.dispose(),this.#q.delete(t)),this.#G.forEach((r,o)=>{const s=r.scripts.filter(e=>e.debuggerModel!==t);0===s.length?(r.plugin.removeRawModule(o).catch(t=>{e.Console.Console.instance().error(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message}),!1)}),this.#G.delete(o)):r.scripts=s})}globalObjectCleared(e){const t=e.data;this.modelRemoved(t),this.modelAdded(t)}addPlugin(e){this.#K.push(e);for(const e of this.#q.keys())for(const t of e.scripts())this.hasPluginForScript(t)||this.parsedScriptSource({data:t})}removePlugin(e){this.#K=this.#K.filter(t=>t!==e);const t=new Set;this.#G.forEach((r,o)=>{r.plugin===e&&(r.scripts.forEach(e=>t.add(e)),this.#G.delete(o))});for(const e of t)this.#q.get(e.debuggerModel).removeScript(e),this.parsedScriptSource({data:e})}hasPluginForScript(e){const t=X(e),r=this.#G.get(t);return r?.scripts.includes(e)??!1}async rawModuleIdAndPluginForScript(e){const t=X(e),r=this.#G.get(t);return r&&(await r.addRawModulePromise,r===this.#G.get(t))?{rawModuleId:t,plugin:r.plugin}:{rawModuleId:t,plugin:null}}uiSourceCodeForURL(e,t){const r=this.#q.get(e);return r?r.getProject().uiSourceCodeForURL(t):null}async rawLocationToUILocation(t){const r=t.script();if(!r)return null;const{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(r);if(!s)return null;const i={rawModuleId:o,codeOffset:t.columnNumber-(r.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex};try{const e=await s.rawLocationToSourceLocation(i);for(const t of e){const e=this.uiSourceCodeForURL(r.debuggerModel,t.sourceFileURL);if(e)return e.uiLocation(t.lineNumber,t.columnNumber>=0?t.columnNumber:void 0)}}catch(t){e.Console.Console.instance().error(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message}),!1)}return null}uiLocationToRawLocationRanges(t,o,s=-1){const i=[];return this.scriptsForUISourceCode(t).forEach(e=>{const n=X(e),a=this.#G.get(n);if(!a)return;const{plugin:c}=a;i.push(async function(e,i,n){const a={rawModuleId:e,sourceFileURL:t.url(),lineNumber:o,columnNumber:s},c=await i.sourceLocationToRawLocation(a);return c?c.map(e=>({start:new r.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.startOffset)+(n.codeOffset()||0)),end:new r.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.endOffset)+(n.codeOffset()||0))})):[]}(n,c,e))}),0===i.length?Promise.resolve(null):Promise.all(i).then(e=>e.flat()).catch(t=>(e.Console.Console.instance().error(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message}),!1),null))}async uiLocationToRawLocations(e,t,r){const o=await this.uiLocationToRawLocationRanges(e,t,r);return o?o.map(({start:e})=>e):null}async uiLocationRangeToRawLocationRanges(e,t){const r=[];for(let o=t.startLine;o<=t.endLine;++o)r.push(this.uiLocationToRawLocationRanges(e,o));const o=[];for(const e of await Promise.all(r)){if(null===e)return null;for(const r of e){const[e,i]=await Promise.all([this.rawLocationToUILocation(r.start),this.rawLocationToUILocation(r.end)]);null!==e&&null!==i&&(t.intersection(new s.TextRange.TextRange(e.lineNumber,e.columnNumber??0,i.lineNumber,i.columnNumber??1/0)).isEmpty()||o.push(r))}}return o}scriptsForUISourceCode(e){for(const t of this.#q.values()){const r=t.uiSourceCodeToScripts.get(e);if(r)return r}return[]}setDebugInfoURL(e,t){this.hasPluginForScript(e)||(e.debugSymbols={type:"ExternalDWARF",externalURL:t},this.parsedScriptSource({data:e}),e.debuggerModel.setDebugInfoURL(e,t))}parsedScriptSource(t){const r=t.data;if(r.sourceURL)for(const t of this.#K){if(!t.handleScript(r))continue;const o=X(r);let s=this.#G.get(o);if(s)s.scripts.push(r);else{const i=(async()=>{const i=e.Console.Console.instance(),n=r.sourceURL,a=r.debugSymbols?.externalURL||"";a?i.log(J(K.loadingDebugSymbolsForVia,{PH1:t.name,PH2:n,PH3:a})):i.log(J(K.loadingDebugSymbolsFor,{PH1:t.name,PH2:n}));try{const c=!a&&e.ParsedURL.schemeIs(n,"wasm:")?await r.getWasmBytecode():void 0,u=await t.addRawModule(o,a,{url:n,code:c});if(s!==this.#G.get(o))return[];if("missingSymbolFiles"in u){const e=t.createPageResourceLoadInitiator();return{missingSymbolFiles:u.missingSymbolFiles.map(t=>({resourceUrl:t,initiator:e}))}}const d=u;return 0===d.length?i.warn(J(K.loadedDebugSymbolsForButDidnt,{PH1:t.name,PH2:n})):i.log(J(K.loadedDebugSymbolsForFound,{PH1:t.name,PH2:n,PH3:d.length})),d}catch(e){return i.error(J(K.failedToLoadDebugSymbolsFor,{PH1:t.name,PH2:n,PH3:e.message}),!1),this.#G.delete(o),[]}})();s={rawModuleId:o,plugin:t,scripts:[r],addRawModulePromise:i},this.#G.set(o,s)}return void s.addRawModulePromise.then(e=>{if(!("missingSymbolFiles"in e)&&r.debuggerModel.scriptForId(r.scriptId)===r){const t=this.#q.get(r.debuggerModel);t&&(t.addSourceFiles(r,e),this.#r.updateLocations(r))}})}}debuggerResumed(e){const t=Array.from(this.callFrameByStopId.values()).filter(t=>t.debuggerModel===e.data);for(const e of t){const t=this.stopIdByCallFrame.get(e);o(t),this.stopIdByCallFrame.delete(e),this.callFrameByStopId.delete(t)}}getSourcesForScript(e){const t=X(e),r=this.#G.get(t);return r?r.addRawModulePromise:Promise.resolve(void 0)}async resolveScopeChain(t){const r=t.script,{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(r);if(!s)return null;const i={rawModuleId:o,codeOffset:t.location().columnNumber-(r.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex},n=this.stopIdForCallFrame(t);try{if(0===(await s.rawLocationToSourceLocation(i)).length)return null;const e=new Map,r=await s.listVariablesInScope(i);for(const o of r||[]){let r=e.get(o.scope);if(!r){const{type:i,typeName:a,icon:c}=await s.getScopeInfo(o.scope);r=new oe(t,n,i,a,c,s),e.set(o.scope,r)}r.object().variables.push(o)}return Array.from(e.values())}catch(t){return e.Console.Console.instance().error(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message}),!1),null}}async getFunctionInfo(t,r){const{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(t);if(!s)return null;const i={rawModuleId:o,codeOffset:r.columnNumber-(t.codeOffset()||0),inlineFrameIndex:0};try{const e=await s.getFunctionInfo(i);if("missingSymbolFiles"in e){const t=s.createPageResourceLoadInitiator();return{missingSymbolFiles:e.missingSymbolFiles.map(e=>({resourceUrl:e,initiator:t})),..."frames"in e&&{frames:e.frames}}}return e}catch(t){return e.Console.Console.instance().warn(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message})),{frames:[]}}}async getInlinedFunctionRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return[];const n={rawModuleId:s,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await i.getInlinedFunctionRanges(n)).map(e=>({start:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))}))}catch(t){return e.Console.Console.instance().warn(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getInlinedCalleesRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return[];const n={rawModuleId:s,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await i.getInlinedCalleesRanges(n)).map(e=>({start:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))}))}catch(t){return e.Console.Console.instance().warn(J(K.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getMappedLines(e){const t=await Promise.all(this.scriptsForUISourceCode(e).map(e=>this.rawModuleIdAndPluginForScript(e)));let r=null;for(const{rawModuleId:o,plugin:s}of t){if(!s)continue;const t=await s.getMappedLines(o,e.url());void 0!==t&&(null===r?r=new Set(t):t.forEach(e=>r.add(e)))}return r}}let ie=class{project;uiSourceCodeToScripts;constructor(e,t){this.project=new d(t,"language_plugins::"+e.target().id(),i.Workspace.projectTypes.Network,"",!1),I.setTargetForProject(this.project,e.target()),this.uiSourceCodeToScripts=new Map}addSourceFiles(t,o){const s=t.createPageResourceLoadInitiator();for(const i of o){let o=this.project.uiSourceCodeForURL(i);if(o){const e=this.uiSourceCodeToScripts.get(o);e.includes(t)||e.push(t)}else{o=this.project.createUISourceCode(i,e.ResourceType.resourceTypes.SourceMapScript),I.setInitialFrameAttribution(o,t.frameId),this.uiSourceCodeToScripts.set(o,[t]);const n=new r.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(i,e.ResourceType.resourceTypes.SourceMapScript,s),a=e.ResourceType.ResourceType.mimeFromURL(i)||"text/javascript";this.project.addUISourceCodeWithProvider(o,n,null,a)}}}removeScript(e){this.uiSourceCodeToScripts.forEach((t,r)=>{0===(t=t.filter(t=>t!==e)).length?(this.uiSourceCodeToScripts.delete(r),this.project.removeUISourceCode(r.url())):this.uiSourceCodeToScripts.set(r,t)})}dispose(){this.project.dispose()}getProject(){return this.project}};var ne=Object.freeze({__proto__:null,DebuggerLanguagePluginManager:se,ExtensionRemoteObject:re,SourceScope:oe});class ae{#r;#L;#u;#Q;#X;constructor(e,t,o){ce.add(this),this.#r=o,this.#L=new d(t,"debugger:"+e.target().id(),i.Workspace.projectTypes.Debugger,"",!0),this.#u=[e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(r.DebuggerModel.Events.DiscardedAnonymousScriptSource,this.discardedScriptSource,this)],this.#Q=new Map,this.#X=new Map}static createV8ScriptURL(t){const r=e.ParsedURL.ParsedURL.extractName(t.sourceURL);return"debugger:///VM"+t.scriptId+(r?" "+r:"")}static scriptForUISourceCode(e){for(const t of ce){const r=t.#Q.get(e);if(void 0!==r)return r}return null}uiSourceCodeForScript(e){return this.#X.get(e)??null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=this.#X.get(t);if(!r)return null;const{lineNumber:o,columnNumber:s}=t.rawLocationToRelativeLocation(e);return r.uiLocation(o,s)}uiLocationToRawLocations(e,t,r){const o=this.#Q.get(e);return o?(({lineNumber:t,columnNumber:r}=o.relativeLocationToRawLocation({lineNumber:t,columnNumber:r})),[o.debuggerModel.createRawLocation(o,t,r??0)]):[]}uiLocationRangeToRawLocationRanges(e,{startLine:t,startColumn:r,endLine:o,endColumn:s}){const i=this.#Q.get(e);return i?(({lineNumber:t,columnNumber:r}=i.relativeLocationToRawLocation({lineNumber:t,columnNumber:r})),({lineNumber:o,columnNumber:s}=i.relativeLocationToRawLocation({lineNumber:o,columnNumber:s})),[{start:i.debuggerModel.createRawLocation(i,t,r),end:i.debuggerModel.createRawLocation(i,o,s)}]):[]}parsedScriptSource(t){const r=t.data,o=ae.createV8ScriptURL(r),s=this.#L.createUISourceCode(o,e.ResourceType.resourceTypes.Script);r.isBreakpointCondition&&s.markAsUnconditionallyIgnoreListed(),this.#Q.set(s,r),this.#X.set(r,s),this.#L.addUISourceCodeWithProvider(s,r,null,"text/javascript"),this.#r.updateLocations(r)}discardedScriptSource(e){const t=e.data,r=this.#X.get(t);void 0!==r&&(this.#X.delete(t),this.#Q.delete(r),this.#L.removeUISourceCode(r.url()))}globalObjectCleared(){this.#X.clear(),this.#Q.clear(),this.#L.reset()}dispose(){ce.delete(this),e.EventTarget.removeEventListeners(this.#u),this.globalObjectCleared(),this.#L.dispose()}}const ce=new Set;var ue=Object.freeze({__proto__:null,DefaultScriptMapping:ae});const de={liveEditFailed:"`LiveEdit` failed: {PH1}",liveEditCompileFailed:"`LiveEdit` compile failed: {PH1}"},le=n.i18n.registerUIStrings("models/bindings/ResourceScriptMapping.ts",de),ge=n.i18n.getLocalizedString.bind(void 0,le);class pe{debuggerModel;#V;debuggerWorkspaceBinding;#Z;#d;#X;#u;constructor(e,t,o){this.debuggerModel=e,this.#V=t,this.debuggerWorkspaceBinding=o,this.#Z=new Map,this.#d=new Map,this.#X=new Map;const s=e.runtimeModel();this.#u=[this.debuggerModel.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,e=>this.addScript(e.data),this),this.debuggerModel.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),s.addEventListener(r.RuntimeModel.Events.ExecutionContextDestroyed,this.executionContextDestroyed,this),s.target().targetManager().addEventListener("InspectedURLChanged",this.inspectedURLChanged,this)]}project(e){const t=(e.isContentScript()?"js:extensions:":"js::")+this.debuggerModel.target().id()+":"+e.frameId;let r=this.#d.get(t);if(!r){const o=e.isContentScript()?i.Workspace.projectTypes.ContentScripts:i.Workspace.projectTypes.Network;r=new d(this.#V,t,o,"",!1),I.setTargetForProject(r,this.debuggerModel.target()),this.#d.set(t,r)}return r}uiSourceCodeForScript(e){return this.#X.get(e)??null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=this.#X.get(t);if(!r)return null;const o=this.#Z.get(r);if(!o)return null;if(o.hasDivergedFromVM()&&!o.isMergingToVM()||o.isDivergingFromVM())return null;if(o.script!==t)return null;const{lineNumber:s,columnNumber:i=0}=e;return r.uiLocation(s,i)}uiLocationToRawLocations(e,t,r){const o=this.#Z.get(e);if(!o)return[];const{script:s}=o;return s?[this.debuggerModel.createRawLocation(s,t,r)]:[]}uiLocationRangeToRawLocationRanges(e,{startLine:t,startColumn:r,endLine:o,endColumn:s}){const i=this.#Z.get(e);if(!i)return null;const{script:n}=i;return n?[{start:this.debuggerModel.createRawLocation(n,t,r),end:this.debuggerModel.createRawLocation(n,o,s)}]:null}inspectedURLChanged(e){for(let t=this.debuggerModel.target();t!==e.data;t=t.parentTarget())if(null===t)return;for(const e of Array.from(this.#X.keys()))this.removeScripts([e]),this.addScript(e)}addScript(t){if(t.isLiveEdit()||t.isBreakpointCondition)return;let o=t.sourceURL;if(!o)return;if(t.hasSourceURL)o=r.SourceMapManager.SourceMapManager.resolveRelativeSourceURL(t.debuggerModel.target(),o);else{if(t.isInlineScript())return;if(t.isContentScript()&&!new e.ParsedURL.ParsedURL(o).isValid)return}const s=this.project(t),i=s.uiSourceCodeForURL(o);if(i){const e=this.#Z.get(i);e?.script&&this.removeScripts([e.script])}const n=t.originalContentProvider(),a=s.createUISourceCode(o,n.contentType());I.setInitialFrameAttribution(a,t.frameId);const c=x(this.debuggerModel.target(),t.frameId,o),u=new he(this,a,t);this.#Z.set(a,u),this.#X.set(t,a);const d=t.isWasm()?"application/wasm":"text/javascript";s.addUISourceCodeWithProvider(a,n,c,d),this.debuggerWorkspaceBinding.updateLocations(t)}scriptFile(e){return this.#Z.get(e)||null}removeScripts(e){const r=new t.MapUtilities.Multimap;for(const t of e){const e=this.#X.get(t);if(!e)continue;const o=this.#Z.get(e);o&&o.dispose(),this.#Z.delete(e),this.#X.delete(t),r.set(e.project(),e),this.debuggerWorkspaceBinding.updateLocations(t)}for(const e of r.keysArray()){const t=r.get(e);let o=!0;for(const r of e.uiSourceCodes())if(!t.has(r)){o=!1;break}o?(this.#d.delete(e.id()),e.removeProject()):t.forEach(t=>e.removeUISourceCode(t.url()))}}executionContextDestroyed(e){const t=e.data;this.removeScripts(this.debuggerModel.scriptsForExecutionContext(t))}globalObjectCleared(){const e=Array.from(this.#X.keys());this.removeScripts(e)}resetForTest(){this.globalObjectCleared()}dispose(){e.EventTarget.removeEventListeners(this.#u),this.globalObjectCleared()}}class he extends e.ObjectWrapper.ObjectWrapper{#Y;uiSourceCode;script;#ee;#te;#re;#oe;#se=new e.Mutex.Mutex;constructor(e,t,r){super(),this.#Y=e,this.uiSourceCode=t,this.script=this.uiSourceCode.contentType().isScript()?r:null,this.uiSourceCode.addEventListener(i.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.addEventListener(i.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}isDiverged(){if(this.uiSourceCode.isDirty())return!0;if(!this.script)return!1;if(void 0===this.#ee||null===this.#ee)return!1;const e=this.uiSourceCode.workingCopy();if(!e)return!1;if(!e.startsWith(this.#ee.trimEnd()))return!0;const t=this.uiSourceCode.workingCopy().substr(this.#ee.length);return Boolean(t.length)&&!t.match(r.Script.sourceURLRegex)}workingCopyChanged(){this.update()}workingCopyCommitted(){if(this.uiSourceCode.project().canSetFileContent())return;if(!this.script)return;const e=this.uiSourceCode.workingCopy();this.script.editSource(e).then(({status:t,exceptionDetails:r})=>{this.scriptSourceWasSet(e,t,r)})}async scriptSourceWasSet(t,r,o){if("Ok"===r&&(this.#ee=t),await this.update(),"Ok"===r)return;if(!o)return void e.Console.Console.instance().addMessage(ge(de.liveEditFailed,{PH1:function(e){switch(e){case"BlockedByActiveFunction":return"Functions that are on the stack (currently being executed) can not be edited";case"BlockedByActiveGenerator":return"Async functions/generators that are active can not be edited";case"BlockedByTopLevelEsModuleChange":return"The top-level of ES modules can not be edited";case"CompileError":case"Ok":throw new Error("Compile errors and Ok status must not be reported on the console")}}(r)}),"warning");const s=ge(de.liveEditCompileFailed,{PH1:o.text});this.uiSourceCode.addLineMessage("Error",s,o.lineNumber,o.columnNumber)}async update(){const e=await this.#se.acquire(),t=this.isDiverged();t&&!this.#re?await this.divergeFromVM():!t&&this.#re&&await this.mergeToVM(),e()}async divergeFromVM(){this.script&&(this.#te=!0,await this.#Y.debuggerWorkspaceBinding.updateLocations(this.script),this.#te=void 0,this.#re=!0,this.dispatchEventToListeners("DidDivergeFromVM"))}async mergeToVM(){this.script&&(this.#re=void 0,this.#oe=!0,await this.#Y.debuggerWorkspaceBinding.updateLocations(this.script),this.#oe=void 0,this.dispatchEventToListeners("DidMergeToVM"))}hasDivergedFromVM(){return Boolean(this.#re)}isDivergingFromVM(){return Boolean(this.#te)}isMergingToVM(){return Boolean(this.#oe)}checkMapping(){this.script&&void 0===this.#ee?this.script.requestContentData().then(e=>{this.#ee=s.ContentData.ContentData.textOr(e,null),this.update().then(()=>this.mappingCheckedForTest())}):this.mappingCheckedForTest()}mappingCheckedForTest(){}dispose(){this.uiSourceCode.removeEventListener(i.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.removeEventListener(i.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}addSourceMapURL(e){this.script&&this.script.debuggerModel.setSourceMapURL(this.script,e)}addDebugInfoURL(e){if(!this.script)return;const{pluginManager:t}=Le.instance();t.setDebugInfoURL(this.script,e)}hasSourceMapURL(){return Boolean(this.script?.sourceMapURL)}async missingSymbolFiles(){if(!this.script)return null;const{pluginManager:e}=this.#Y.debuggerWorkspaceBinding,t=await e.getSourcesForScript(this.script);return t&&"missingSymbolFiles"in t?t.missingSymbolFiles:null}}var me=Object.freeze({__proto__:null,ResourceScriptFile:he,ResourceScriptMapping:pe});let Se;class Le{resourceMapping;#ie;#q;#x;pluginManager;constructor(e,t){this.resourceMapping=e,this.#ie=[],this.#q=new Map,t.addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),t.addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),t.observeModels(r.DebuggerModel.DebuggerModel,this),this.#x=new Set,this.pluginManager=new se(t,e.workspace,this)}setFunctionRanges(e,t){for(const r of this.#q.values())r.compilerMapping.setFunctionRanges(e,t)}static instance(e={forceNew:null,resourceMapping:null,targetManager:null}){const{forceNew:t,resourceMapping:r,targetManager:o}=e;if(!Se||t){if(!r||!o)throw new Error(`Unable to create DebuggerWorkspaceBinding: resourceMapping and targetManager must be provided: ${(new Error).stack}`);Se=new Le(r,o)}return Se}static removeInstance(){Se=void 0}addSourceMapping(e){this.#ie.push(e)}removeSourceMapping(e){const t=this.#ie.indexOf(e);-1!==t&&this.#ie.splice(t,1)}async computeAutoStepRanges(e,t){function r(e,t){const{start:r,end:o}=t;return!(r.scriptId!==e.scriptId||e.lineNumber<r.lineNumber||e.lineNumber>o.lineNumber||e.lineNumber===r.lineNumber&&e.columnNumber<r.columnNumber||e.lineNumber===o.lineNumber&&e.columnNumber>=o.columnNumber)}const o=t.location();if(!o)return[];const s=this.pluginManager;let i=[];if("StepOut"===e)return await s.getInlinedFunctionRanges(o);const n=await s.rawLocationToUILocation(o);if(n)return i=await s.uiLocationToRawLocationRanges(n.uiSourceCode,n.lineNumber,n.columnNumber)||[],i=i.filter(e=>r(o,e)),"StepOver"===e&&(i=i.concat(await s.getInlinedCalleesRanges(o))),i;const a=this.#q.get(o.debuggerModel)?.compilerMapping;return a?(i=a.getLocationRangesForSameSourceLocation(o),i=i.filter(e=>r(o,e)),i):[]}modelAdded(e){e.setBeforePausedCallback(this.shouldPause.bind(this)),this.#q.set(e,new Me(e,this)),e.setComputeAutoStepRangesCallback(this.computeAutoStepRanges.bind(this))}modelRemoved(e){e.setComputeAutoStepRangesCallback(null);const t=this.#q.get(e);t&&(t.dispose(),this.#q.delete(e))}async pendingLiveLocationChangesPromise(){await Promise.all(this.#x)}recordLiveLocationChange(e){e.then(()=>{this.#x.delete(e)}),this.#x.add(e)}async updateLocations(e){const t=this.#q.get(e.debuggerModel);if(t){const r=t.updateLocations(e);this.recordLiveLocationChange(r),await r}}async createLiveLocation(e,t,r){const o=this.#q.get(e.debuggerModel);if(!o)return null;const s=o.createLiveLocation(e,t,r);return this.recordLiveLocationChange(s),await s}async createStackTraceTopFrameLiveLocation(e,t,r){console.assert(e.length>0);const o=be.createStackTraceTopFrameLocation(e,this,t,r);return this.recordLiveLocationChange(o),await o}async createCallFrameLiveLocation(e,t,r){if(!e.script())return null;const o=e.debuggerModel,s=this.createLiveLocation(e,t,r);this.recordLiveLocationChange(s);const i=await s;return i?(this.registerCallFrameLiveLocation(o,i),i):null}async rawLocationToUILocation(e){for(const t of this.#ie){const r=t.rawLocationToUILocation(e);if(r)return r}const t=await this.pluginManager.rawLocationToUILocation(e);if(t)return t;const r=this.#q.get(e.debuggerModel);return r?r.rawLocationToUILocation(e):null}uiSourceCodeForSourceMapSourceURL(e,t,r){const o=this.#q.get(e);return o?o.compilerMapping.uiSourceCodeForURL(t,r):null}async uiSourceCodeForSourceMapSourceURLPromise(e,t,r){const o=this.uiSourceCodeForSourceMapSourceURL(e,t,r);return await(o||this.waitForUISourceCodeAdded(t,e.target()))}async uiSourceCodeForDebuggerLanguagePluginSourceURLPromise(e,t){const r=this.pluginManager.uiSourceCodeForURL(e,t);return await(r||this.waitForUISourceCodeAdded(t,e.target()))}uiSourceCodeForScript(e){const t=this.#q.get(e.debuggerModel);return t?t.uiSourceCodeForScript(e):null}waitForUISourceCodeAdded(e,t){return new Promise(r=>{const o=i.Workspace.WorkspaceImpl.instance(),s=o.addEventListener(i.Workspace.Events.UISourceCodeAdded,n=>{const a=n.data;a.url()===e&&I.targetForUISourceCode(a)===t&&(o.removeEventListener(i.Workspace.Events.UISourceCodeAdded,s.listener),r(a))})})}async uiLocationToRawLocations(e,t,r){for(const o of this.#ie){const s=o.uiLocationToRawLocations(e,t,r);if(s.length)return s}const o=await this.pluginManager.uiLocationToRawLocations(e,t,r);if(o)return o;for(const o of this.#q.values()){const s=o.uiLocationToRawLocations(e,t,r);if(s.length)return s}return[]}async uiLocationRangeToRawLocationRanges(e,t){for(const r of this.#ie){const o=r.uiLocationRangeToRawLocationRanges(e,t);if(o)return o}const r=await this.pluginManager.uiLocationRangeToRawLocationRanges(e,t);if(r)return r;for(const r of this.#q.values()){const o=r.uiLocationRangeToRawLocationRanges(e,t);if(o)return o}return[]}async normalizeUILocation(e){const t=await this.uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,e.columnNumber);for(const e of t){const t=await this.rawLocationToUILocation(e);if(t)return t}return e}async getMappedLines(e){for(const t of this.#q.values()){const r=t.getMappedLines(e);if(null!==r)return r}return await this.pluginManager.getMappedLines(e)}scriptFile(e,t){const r=this.#q.get(t);return r?r.getResourceScriptMapping().scriptFile(e):null}scriptsForUISourceCode(e){const t=new Set;this.pluginManager.scriptsForUISourceCode(e).forEach(e=>t.add(e));for(const r of this.#q.values()){const o=r.getResourceScriptMapping().scriptFile(e);o?.script&&t.add(o.script),r.compilerMapping.scriptsForUISourceCode(e).forEach(e=>t.add(e))}return[...t]}supportsConditionalBreakpoints(e){return this.pluginManager.scriptsForUISourceCode(e).every(e=>e.isJavaScript())}globalObjectCleared(e){this.reset(e.data)}reset(e){const t=this.#q.get(e);if(t){for(const e of t.callFrameLocations.values())this.removeLiveLocation(e);t.callFrameLocations.clear()}}resetForTest(e){const t=e.model(r.DebuggerModel.DebuggerModel),o=this.#q.get(t);o&&o.getResourceScriptMapping().resetForTest()}registerCallFrameLiveLocation(e,t){const r=this.#q.get(e);r&&r.callFrameLocations.add(t)}removeLiveLocation(e){const t=this.#q.get(e.rawLocation.debuggerModel);t&&t.disposeLocation(e)}debuggerResumed(e){this.reset(e.data)}async shouldPause(t,r){const{callFrames:[o]}=t;if(!o)return!1;const s=o.functionLocation();return!(r&&"step"===t.reason&&s&&o.script.isWasm()&&e.Settings.moduleSetting("wasm-auto-stepping").get()&&this.pluginManager.hasPluginForScript(o.script))||(!!await this.pluginManager.rawLocationToUILocation(o.location())||r.script()!==s.script()||r.columnNumber!==s.columnNumber||r.lineNumber!==s.lineNumber)}}class Me{#ne;#r;callFrameLocations;#ae;#P;#Y;compilerMapping;#S;constructor(e,r){this.#ne=e,this.#r=r,this.callFrameLocations=new Set;const{workspace:o}=r.resourceMapping;this.#ae=new ae(e,o,r),this.#P=r.resourceMapping,this.#Y=new pe(e,o,r),this.compilerMapping=new y(e,o,r),this.#S=new t.MapUtilities.Multimap}async createLiveLocation(e,t,r){console.assert(""!==e.scriptId);const o=e.scriptId,s=new fe(o,e,this.#r,t,r);return this.#S.set(o,s),await s.update(),s}disposeLocation(e){this.#S.delete(e.scriptId,e)}async updateLocations(e){const t=[];for(const r of this.#S.get(e.scriptId))t.push(r.update());await Promise.all(t)}rawLocationToUILocation(e){let t=this.compilerMapping.rawLocationToUILocation(e);return t=t||this.#Y.rawLocationToUILocation(e),t=t||this.#P.jsLocationToUILocation(e),t=t||this.#ae.rawLocationToUILocation(e),t}uiSourceCodeForScript(e){let t=null;return t=t||this.#Y.uiSourceCodeForScript(e),t=t||this.#P.uiSourceCodeForScript(e),t=t||this.#ae.uiSourceCodeForScript(e),t}uiLocationToRawLocations(e,t,r=0){let o=this.compilerMapping.uiLocationToRawLocations(e,t,r);return o=o.length?o:this.#Y.uiLocationToRawLocations(e,t,r),o=o.length?o:this.#P.uiLocationToJSLocations(e,t,r),o=o.length?o:this.#ae.uiLocationToRawLocations(e,t,r),o}uiLocationRangeToRawLocationRanges(e,t){let r=this.compilerMapping.uiLocationRangeToRawLocationRanges(e,t);return r??=this.#Y.uiLocationRangeToRawLocationRanges(e,t),r??=this.#P.uiLocationRangeToJSLocationRanges(e,t),r??=this.#ae.uiLocationRangeToRawLocationRanges(e,t),r}getMappedLines(e){return this.compilerMapping.getMappedLines(e)}dispose(){this.#ne.setBeforePausedCallback(null),this.compilerMapping.dispose(),this.#Y.dispose(),this.#ae.dispose()}getResourceScriptMapping(){return this.#Y}}class fe extends R{scriptId;rawLocation;#ce;constructor(e,t,r,o,s){super(o,s),this.scriptId=e,this.rawLocation=t,this.#ce=r}async uiLocation(){const e=this.rawLocation;return await this.#ce.rawLocationToUILocation(e)}dispose(){super.dispose(),this.#ce.removeLiveLocation(this)}async isIgnoreListed(){const e=await this.uiLocation();return!!e&&S.instance().isUserOrSourceMapIgnoreListedUISourceCode(e.uiSourceCode)}}class be extends R{#ue;#de;#S;constructor(e,t){super(e,t),this.#ue=!0,this.#de=null,this.#S=null}static async createStackTraceTopFrameLocation(e,t,r,o){const s=new be(r,o),i=e.map(e=>t.createLiveLocation(e,s.scheduleUpdate.bind(s),o));return s.#S=(await Promise.all(i)).filter(e=>!!e),await s.updateLocation(),s}async uiLocation(){return this.#de?await this.#de.uiLocation():null}async isIgnoreListed(){return!!this.#de&&await this.#de.isIgnoreListed()}dispose(){if(super.dispose(),this.#S)for(const e of this.#S)e.dispose();this.#S=null,this.#de=null}async scheduleUpdate(){this.#ue||(this.#ue=!0,queueMicrotask(()=>{this.updateLocation()}))}async updateLocation(){if(this.#ue=!1,this.#S&&0!==this.#S.length){this.#de=this.#S[0];for(const e of this.#S)if(!await e.isIgnoreListed()){this.#de=e;break}this.update()}}}var Ce=Object.freeze({__proto__:null,DebuggerWorkspaceBinding:Le,Location:fe});class we{#le;#he;#ge;#pe;#me;#Se;#Le;#fe;#Ce;#be;#Me;#we;constructor(e,t,r){this.#le=e,this.#he=e.size,this.#ge=0,this.#me=t||Number.MAX_VALUE,this.#Se=r,this.#Le=new TextDecoder,this.#fe=!1,this.#Ce=null,this.#pe=null}async read(e){if(this.#Se&&this.#Se(this),this.#le?.type.endsWith("gzip")){const e=this.#le.stream(),t=this.decompressStream(e);this.#pe=t.getReader()}else this.#we=new FileReader,this.#we.onload=this.onChunkLoaded.bind(this),this.#we.onerror=this.onError.bind(this);return this.#Me=e,this.loadChunk(),await new Promise(e=>{this.#be=e})}cancel(){this.#fe=!0}loadedSize(){return this.#ge}fileSize(){return this.#he}fileName(){return this.#le?this.#le.name:""}error(){return this.#Ce}decompressStream(e){const t=new DecompressionStream("gzip");return e.pipeThrough(t)}onChunkLoaded(e){if(this.#fe)return;if(e.target.readyState!==FileReader.DONE)return;if(!this.#we)return;const t=this.#we.result;this.#ge+=t.byteLength;const r=this.#ge===this.#he;this.decodeChunkBuffer(t,r)}async decodeChunkBuffer(e,t){if(!this.#Me)return;const r=this.#Le.decode(e,{stream:!t});await this.#Me.write(r,t),this.#fe||(this.#Se&&this.#Se(this),t?this.finishRead():this.loadChunk())}async finishRead(){this.#Me&&(this.#le=null,this.#we=null,await this.#Me.close(),this.#be(!this.#Ce))}async loadChunk(){if(this.#Me&&this.#le){if(this.#pe){const{value:e,done:t}=await this.#pe.read();if(t||!e)return await this.#Me.write("",!0),await this.finishRead();this.decodeChunkBuffer(e.buffer,!1)}if(this.#we){const e=this.#ge,t=Math.min(this.#he,e+this.#me),r=this.#le.slice(e,t);this.#we.readAsArrayBuffer(r)}}}onError(e){const t=e.target;this.#Ce=t.error,this.#be(!1)}}var Ie=Object.freeze({__proto__:null,ChunkedFileReader:we,FileOutputStream:class{#Ie;#ve;#Re;constructor(){this.#Ie=[]}async open(e){this.#Re=!1,this.#Ie=[],this.#ve=e;const t=await i.FileManager.FileManager.instance().save(this.#ve,"",!0,!1);return t&&i.FileManager.FileManager.instance().addEventListener("AppendedToURL",this.onAppendDone,this),Boolean(t)}write(e){return new Promise(t=>{this.#Ie.push(t),i.FileManager.FileManager.instance().append(this.#ve,e)})}async close(){this.#Re=!0,this.#Ie.length||(i.FileManager.FileManager.instance().removeEventListener("AppendedToURL",this.onAppendDone,this),i.FileManager.FileManager.instance().close(this.#ve))}onAppendDone(e){if(e.data!==this.#ve)return;const t=this.#Ie.shift();t&&t(),this.#Ie.length||this.#Re&&(i.FileManager.FileManager.instance().removeEventListener("AppendedToURL",this.onAppendDone,this),i.FileManager.FileManager.instance().close(this.#ve))}}});class ve{#ye=new WeakMap;constructor(){r.TargetManager.TargetManager.instance().observeModels(r.DebuggerModel.DebuggerModel,this),r.TargetManager.TargetManager.instance().observeModels(r.CSSModel.CSSModel,this)}modelAdded(e){const t=e.target(),o=this.#ye.get(t)??new ye;e instanceof r.DebuggerModel.DebuggerModel?o.setDebuggerModel(e):o.setCSSModel(e),this.#ye.set(t,o)}modelRemoved(e){const t=e.target(),r=this.#ye.get(t);r?.clear()}addMessage(e,t,r){const o=this.#ye.get(r);o?.addMessage(e,t)}clear(){for(const e of r.TargetManager.TargetManager.instance().targets()){const t=this.#ye.get(e);t?.clear()}}}class ye{#ne;#M;#Fe=new Map;#p;constructor(){this.#p=new F,i.Workspace.WorkspaceImpl.instance().addEventListener(i.Workspace.Events.UISourceCodeAdded,this.#Te.bind(this))}setDebuggerModel(e){if(this.#ne)throw new Error("Cannot set DebuggerModel twice");this.#ne=e,e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,e=>{queueMicrotask(()=>{this.#Ue(e)})}),e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.#Pe,this)}setCSSModel(e){if(this.#M)throw new Error("Cannot set CSSModel twice");this.#M=e,e.addEventListener(r.CSSModel.Events.StyleSheetAdded,e=>queueMicrotask(()=>this.#ke(e)))}async addMessage(e,t){const r=new Re(e,this.#p),o=this.#xe(t)??this.#Ee(t)??this.#je(t);if(o&&await r.updateLocationSource(o),t.url){let e=this.#Fe.get(t.url);e||(e=[],this.#Fe.set(t.url,e)),e.push({source:t,presentation:r})}}#je(e){if(!e.url)return null;const t=i.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e.url);return t?new i.UISourceCode.UILocation(t,e.line,e.column):null}#Ee(e){return this.#M&&e.url?this.#M.createRawLocationsByURL(e.url,e.line,e.column)[0]??null:null}#xe(e){if(!this.#ne)return null;if(e.scriptId)return this.#ne.createRawLocationByScriptId(e.scriptId,e.line,e.column);const t=e.stackTrace?.callFrames?e.stackTrace.callFrames[0]:null;return t?this.#ne.createRawLocationByScriptId(t.scriptId,t.lineNumber,t.columnNumber):e.url?this.#ne.createRawLocationByURL(e.url,e.line,e.column):null}#Ue(e){const t=e.data,r=this.#Fe.get(t.sourceURL),o=[];for(const{presentation:e,source:s}of r??[]){const r=this.#xe(s);r&&t.scriptId===r.scriptId&&o.push(e.updateLocationSource(r))}Promise.all(o).then(this.parsedScriptSourceForTest.bind(this))}parsedScriptSourceForTest(){}#Te(e){const t=e.data,r=this.#Fe.get(t.url()),o=[];for(const{presentation:e,source:s}of r??[])o.push(e.updateLocationSource(new i.UISourceCode.UILocation(t,s.line,s.column)));Promise.all(o).then(this.uiSourceCodeAddedForTest.bind(this))}uiSourceCodeAddedForTest(){}#ke(e){const t=e.data,o=this.#Fe.get(t.sourceURL),s=[];for(const{source:e,presentation:i}of o??[])t.containsLocation(e.line,e.column)&&s.push(i.updateLocationSource(new r.CSSModel.CSSLocation(t,e.line,e.column)));Promise.all(s).then(this.styleSheetAddedForTest.bind(this))}styleSheetAddedForTest(){}clear(){this.#Pe()}#Pe(){const e=Array.from(this.#Fe.values()).flat();for(const{presentation:t}of e)t.dispose();this.#Fe.clear(),this.#p.disposeAll()}}class Te extends R{#je;constructor(e,t,r){super(t,r),this.#je=e}async isIgnoreListed(){return!1}async uiLocation(){return this.#je}}class Re{#Ne;#De;#p;#Ae;constructor(e,t){this.#Ae=e,this.#p=t}async updateLocationSource(e){e instanceof r.DebuggerModel.Location?await Le.instance().createLiveLocation(e,this.#Oe.bind(this),this.#p):e instanceof r.CSSModel.CSSLocation?await z.instance().createLiveLocation(e,this.#Oe.bind(this),this.#p):e instanceof i.UISourceCode.UILocation&&(this.#De||(this.#De=new Te(e,this.#Oe.bind(this),this.#p),await this.#De.update()))}async#Oe(e){this.#Ne&&this.#Ne.removeMessage(this.#Ae),e!==this.#De&&(this.#Ne?.removeMessage(this.#Ae),this.#De?.dispose(),this.#De=e);const t=await e.uiLocation();t&&(this.#Ae.range=s.TextRange.TextRange.createFromLocation(t.lineNumber,t.columnNumber||0),this.#Ne=t.uiSourceCode,this.#Ne.addMessage(this.#Ae))}dispose(){this.#Ne?.removeMessage(this.#Ae),this.#De?.dispose()}}var Fe=Object.freeze({__proto__:null,PresentationConsoleMessageManager:class{#We=new ve;constructor(){r.TargetManager.TargetManager.instance().addModelListener(r.ConsoleModel.ConsoleModel,r.ConsoleModel.Events.MessageAdded,e=>this.consoleMessageAdded(e.data)),r.ConsoleModel.ConsoleModel.allMessagesUnordered().forEach(this.consoleMessageAdded,this),r.TargetManager.TargetManager.instance().addModelListener(r.ConsoleModel.ConsoleModel,r.ConsoleModel.Events.ConsoleCleared,()=>this.#We.clear())}consoleMessageAdded(e){const t=e.runtimeModel();if(!e.isErrorOrWarning()||!e.runtimeModel()||"violation"===e.source||!t)return;const r="error"===e.level?"Error":"Warning";this.#We.addMessage(new i.UISourceCode.Message(r,e.messageText),e,t.target())}},PresentationSourceFrameMessage:Re,PresentationSourceFrameMessageHelper:ye,PresentationSourceFrameMessageManager:ve});const Ue=new WeakMap,Pe=new WeakMap,ke=new WeakSet;function je(e){return new s.TextRange.TextRange(e.lineOffset,e.columnOffset,e.endLine,e.endColumn)}function De(e){return new s.TextRange.TextRange(e.startLine,e.startColumn,e.endLine,e.endColumn)}class Ee{project;#f;#M;#u;constructor(e,t){const o=t.target();this.project=new d(e,"resources:"+o.id(),i.Workspace.projectTypes.Network,"",!1),I.setTargetForProject(this.project,o),this.#f=new Map;const s=o.model(r.CSSModel.CSSModel);console.assert(Boolean(s)),this.#M=s;for(const e of t.frames())for(const t of e.getResourcesMap().values())this.addResource(t);this.#u=[t.addEventListener(r.ResourceTreeModel.Events.ResourceAdded,this.resourceAdded,this),t.addEventListener(r.ResourceTreeModel.Events.FrameWillNavigate,this.frameWillNavigate,this),t.addEventListener(r.ResourceTreeModel.Events.FrameDetached,this.frameDetached,this),this.#M.addEventListener(r.CSSModel.Events.StyleSheetChanged,e=>{this.styleSheetChanged(e)},this)]}async styleSheetChanged(e){const t=this.#M.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const r=this.#f.get(t.resourceURL());r&&await r.styleSheetChanged(t,e.data.edit||null)}acceptsResource(t){const r=t.resourceType();return!(r!==e.ResourceType.resourceTypes.Image&&r!==e.ResourceType.resourceTypes.Font&&r!==e.ResourceType.resourceTypes.Document&&r!==e.ResourceType.resourceTypes.Manifest&&r!==e.ResourceType.resourceTypes.Fetch&&r!==e.ResourceType.resourceTypes.XHR||r===e.ResourceType.resourceTypes.Image&&t.mimeType&&!t.mimeType.startsWith("image")||r===e.ResourceType.resourceTypes.Font&&t.mimeType&&!t.mimeType.includes("font")||(r===e.ResourceType.resourceTypes.Image||r===e.ResourceType.resourceTypes.Font)&&e.ParsedURL.schemeIs(t.contentURL(),"data:"))}resourceAdded(e){this.addResource(e.data)}addResource(e){if(!this.acceptsResource(e))return;let t=this.#f.get(e.url);t?t.addResource(e):(t=new xe(this.project,e),this.#f.set(e.url,t))}removeFrameResources(e){for(const t of e.resources()){if(!this.acceptsResource(t))continue;const e=this.#f.get(t.url);e&&(1===e.resources.size?(e.dispose(),this.#f.delete(t.url)):e.removeResource(t))}}frameWillNavigate(e){this.removeFrameResources(e.data)}frameDetached(e){this.removeFrameResources(e.data.frame)}resetForTest(){for(const e of this.#f.values())e.dispose();this.#f.clear()}dispose(){e.EventTarget.removeEventListeners(this.#u);for(const e of this.#f.values())e.dispose();this.#f.clear(),this.project.removeProject()}getProject(){return this.project}}class xe{resources;#L;#Ne;#Be;constructor(e,t){this.resources=new Set([t]),this.#L=e,this.#Ne=this.#L.createUISourceCode(t.url,t.contentType()),ke.add(this.#Ne),t.frameId&&I.setInitialFrameAttribution(this.#Ne,t.frameId),this.#L.addUISourceCodeWithProvider(this.#Ne,this,N(t),t.mimeType),this.#Be=[],Promise.all([...this.inlineScripts().map(e=>Le.instance().updateLocations(e)),...this.inlineStyles().map(e=>z.instance().updateLocations(e))])}inlineStyles(){const e=I.targetForUISourceCode(this.#Ne),t=[];if(!e)return t;const o=e.model(r.CSSModel.CSSModel);if(o)for(const e of o.getStyleSheetIdsForURL(this.#Ne.url())){const r=o.styleSheetHeaderForId(e);r&&t.push(r)}return t}inlineScripts(){const e=I.targetForUISourceCode(this.#Ne);if(!e)return[];const t=e.model(r.DebuggerModel.DebuggerModel);return t?t.scripts().filter(e=>e.embedderName()===this.#Ne.url()):[]}async styleSheetChanged(e,t){if(this.#Be.push({stylesheet:e,edit:t}),this.#Be.length>1)return;const r=await this.#Ne.requestContentData();s.ContentData.ContentData.isError(r)||await this.innerStyleSheetChanged(r.text),this.#Be=[]}async innerStyleSheetChanged(e){const t=this.inlineScripts(),r=this.inlineStyles();let o=new s.Text.Text(e);for(const e of this.#Be){const i=e.edit;if(!i)continue;const n=e.stylesheet,a=Ue.get(n)??De(n),c=i.oldRange.relativeFrom(a.startLine,a.startColumn),u=i.newRange.relativeFrom(a.startLine,a.startColumn);o=new s.Text.Text(o.replaceRange(c,i.newText));const d=[];for(const e of t){const t=Pe.get(e)??je(e);t.follows(c)&&(Pe.set(e,t.rebaseAfterTextEdit(c,u)),d.push(Le.instance().updateLocations(e)))}for(const e of r){const t=Ue.get(e)??De(e);t.follows(c)&&(Ue.set(e,t.rebaseAfterTextEdit(c,u)),d.push(z.instance().updateLocations(e)))}await Promise.all(d)}this.#Ne.addRevision(o.value())}addResource(e){this.resources.add(e),e.frameId&&I.addFrameAttribution(this.#Ne,e.frameId)}removeResource(e){this.resources.delete(e),e.frameId&&I.removeFrameAttribution(this.#Ne,e.frameId)}dispose(){this.#L.removeUISourceCode(this.#Ne.url()),Promise.all([...this.inlineScripts().map(e=>Le.instance().updateLocations(e)),...this.inlineStyles().map(e=>z.instance().updateLocations(e))])}firstResource(){return console.assert(this.resources.size>0),this.resources.values().next().value}contentURL(){return this.firstResource().contentURL()}contentType(){return this.firstResource().contentType()}requestContent(){return this.firstResource().requestContent()}requestContentData(){return this.firstResource().requestContentData()}searchInContent(e,t,r){return this.firstResource().searchInContent(e,t,r)}}var Ne=Object.freeze({__proto__:null,ResourceMapping:class{workspace;#k;constructor(e,t){this.workspace=t,this.#k=new Map,e.observeModels(r.ResourceTreeModel.ResourceTreeModel,this)}modelAdded(e){const t=new Ee(this.workspace,e);this.#k.set(e,t)}modelRemoved(e){const t=this.#k.get(e);t&&(t.dispose(),this.#k.delete(e))}infoForTarget(e){const t=e.model(r.ResourceTreeModel.ResourceTreeModel);return t&&this.#k.get(t)||null}uiSourceCodeForScript(e){const t=this.infoForTarget(e.debuggerModel.target());return t?t.getProject().uiSourceCodeForURL(e.sourceURL):null}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const r=this.infoForTarget(e.cssModel().target());if(!r)return null;const o=r.getProject().uiSourceCodeForURL(e.url);if(!o)return null;const s=Ue.get(t)??De(t),i=e.lineNumber+s.startLine-t.startLine;let n=e.columnNumber;return e.lineNumber===t.startLine&&(n+=s.startColumn-t.startColumn),o.uiLocation(i,n)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const r=this.infoForTarget(e.debuggerModel.target());if(!r)return null;const o=t.embedderName();if(!o)return null;const s=r.getProject().uiSourceCodeForURL(o);if(!s)return null;const{startLine:i,startColumn:n}=Pe.get(t)??je(t);let{lineNumber:a,columnNumber:c}=e;return a===t.lineOffset&&(c+=n-t.columnOffset),a+=i-t.lineOffset,t.hasSourceURL&&(0===a&&(c+=t.columnOffset),a+=t.lineOffset),s.uiLocation(a,c)}uiLocationToJSLocations(e,t,o){if(!ke.has(e))return[];const s=I.targetForUISourceCode(e);if(!s)return[];const i=s.model(r.DebuggerModel.DebuggerModel);if(!i)return[];const n=[];for(const r of i.scripts()){if(r.embedderName()!==e.url())continue;const s=Pe.get(r)??je(r);if(!s.containsLocation(t,o))continue;let a=t,c=o;r.hasSourceURL&&(a-=s.startLine,0===a&&(c-=s.startColumn)),n.push(i.createRawLocation(r,a,c))}return n}uiLocationRangeToJSLocationRanges(e,t){if(!ke.has(e))return null;const o=I.targetForUISourceCode(e);if(!o)return null;const s=o.model(r.DebuggerModel.DebuggerModel);if(!s)return null;const i=[];for(const r of s.scripts()){if(r.embedderName()!==e.url())continue;const o=(Pe.get(r)??je(r)).intersection(t);if(o.isEmpty())continue;let{startLine:n,startColumn:a,endLine:c,endColumn:u}=o;r.hasSourceURL&&(n-=o.startLine,0===n&&(a-=o.startColumn),c-=o.startLine,0===c&&(u-=o.startColumn));const d=s.createRawLocation(r,n,a),l=s.createRawLocation(r,c,u);i.push({start:d,end:l})}return i}getMappedLines(e){if(!ke.has(e))return null;const t=I.targetForUISourceCode(e);if(!t)return null;const o=t.model(r.DebuggerModel.DebuggerModel);if(!o)return null;const s=new Set;for(const t of o.scripts()){if(t.embedderName()!==e.url())continue;const{startLine:r,endLine:o}=Pe.get(t)??je(t);for(let e=r;e<=o;++e)s.add(e)}return s}uiLocationToCSSLocations(e){if(!ke.has(e.uiSourceCode))return[];const t=I.targetForUISourceCode(e.uiSourceCode);if(!t)return[];const o=t.model(r.CSSModel.CSSModel);return o?o.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}resetForTest(e){const t=e.model(r.ResourceTreeModel.ResourceTreeModel),o=t?this.#k.get(t):null;o&&o.resetForTest()}}}),Ae=Object.freeze({__proto__:null,TempFile:class{#He;constructor(){this.#He=null}write(e){this.#He&&e.unshift(this.#He),this.#He=new Blob(e,{type:"text/plain"})}read(){return this.readRange()}size(){return this.#He?this.#He.size:0}async readRange(t,r){if(!this.#He)return e.Console.Console.instance().error("Attempt to read a temp file that was never written"),"";const o="number"==typeof t||"number"==typeof r?this.#He.slice(t,r):this.#He,s=new FileReader;try{await new Promise((e,t)=>{s.onloadend=e,s.onerror=t,s.readAsText(o)})}catch(t){e.Console.Console.instance().error("Failed to read from temp file: "+t.message)}return s.result}async copyToOutputStream(e,t){if(!this.#He)return e.close(),null;const r=new we(this.#He,1e7,t);return await r.read(e).then(e=>e?null:r.error())}remove(){this.#He=null}}});export{G as CSSWorkspaceBinding,T as CompilerScriptMapping,l as ContentProviderBasedProject,ne as DebuggerLanguagePlugins,Ce as DebuggerWorkspaceBinding,ue as DefaultScriptMapping,Ie as FileUtils,M as IgnoreListManager,U as LiveLocation,v as NetworkProject,Fe as PresentationConsoleMessageHelper,Ne as ResourceMapping,me as ResourceScriptMapping,A as ResourceUtils,D as SASSSourceMapping,H as StylesSourceMapping,Ae as TempFile};