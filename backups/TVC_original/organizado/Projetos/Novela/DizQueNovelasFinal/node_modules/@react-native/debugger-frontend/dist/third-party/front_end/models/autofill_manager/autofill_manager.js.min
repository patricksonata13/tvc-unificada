import*as e from"../../core/common/common.js";import*as s from"../../core/host/host.js";import*as t from"../../core/platform/platform.js";import*as l from"../../core/sdk/sdk.js";import*as i from"../../ui/legacy/legacy.js";let d;class a extends e.ObjectWrapper.ObjectWrapper{#e;#t="";#s=[];#i=[];#l=null;constructor(){super(),l.TargetManager.TargetManager.instance().addModelListener(l.AutofillModel.AutofillModel,"AddressFormFilled",this.#a,this,{scoped:!0}),this.#e=e.Settings.Settings.instance().createSetting("auto-open-autofill-view-on-event",!0)}static instance(e={forceNew:null}){const{forceNew:t}=e;return d&&!t||(d=new a),d}onShowAutofillTestAddressesSettingsChanged(){for(const e of l.TargetManager.TargetManager.instance().models(l.AutofillModel.AutofillModel))e.setTestAddresses()}async#a({data:e}){this.#e.get()?(await i.ViewManager.ViewManager.instance().showView("autofill-view"),s.userMetrics.actionTaken(s.UserMetrics.Action.AutofillReceivedAndTabAutoOpened)):s.userMetrics.actionTaken(s.UserMetrics.Action.AutofillReceived),this.#l=e.autofillModel,this.#o(e.event),this.#t&&this.dispatchEventToListeners("AddressFormFilled",{address:this.#t,filledFields:this.#s,matches:this.#i,autofillModel:this.#l})}getLastFilledAddressForm(){return this.#t&&this.#l?{address:this.#t,filledFields:this.#s,matches:this.#i,autofillModel:this.#l}:null}#o({addressUi:e,filledFields:s}){this.#t=e.addressFields.map(e=>(e=>e.fields.filter(e=>e.value.length).map(e=>e.value).join(" "))(e)).filter(e=>e.length).join("\n"),this.#s=s,this.#i=[];for(let e=0;e<this.#s.length;e++){if(""===this.#s[e].value)continue;const s=t.StringUtilities.escapeForRegExp(this.#s[e].value.replaceAll(/\s/g," ")).replaceAll(/([.,]+)\s/g,"$1? "),i=this.#t.replaceAll(/\s/g," ").matchAll(new RegExp(s,"g"));for(const t of i)void 0!==t.index&&this.#i.push({startIndex:t.index,endIndex:t.index+t[0].length,filledFieldIndex:e})}}}var o=Object.freeze({__proto__:null,AutofillManager:a});export{o as AutofillManager};