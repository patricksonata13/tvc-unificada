class e extends Error{}class t{static rewriteChromeInternalUrl(e){return e?.startsWith("chrome://")?(e.endsWith("/")&&(e=e.replace(/\/$/,"")),e.replace(/^chrome:\/\/chrome\//,"chrome://")):e}static equalWithExcludedFragments(e,t){[e,t]=[e,t].map(this.rewriteChromeInternalUrl);try{const r=new URL(e);r.hash="";const n=new URL(t);return n.hash="",r.href===n.href}catch{return!1}}}const n={Document:.9,XHR:.9,Fetch:.9};class r{static get summary(){return"__SUMMARY__"}static groupByOrigin(e){const t=new Map;return e.forEach(e=>{const r=e.parsedURL.securityOrigin,n=t.get(r)||[];n.push(e),t.set(r,n)}),t}static getSummary(e){let t;return e.sort((e,t)=>e-t),t=0===e.length?e[0]:e.length%2==0?(e[Math.floor((e.length-1)/2)]+e[Math.floor((e.length-1)/2)+1])/2:e[Math.floor((e.length-1)/2)],{min:e[0],max:e[e.length-1],avg:e.reduce((e,t)=>e+t,0)/e.length,median:t}}static summarize(e){const t=new Map,n=[];for(const[s,i]of e)t.set(s,r.getSummary(i)),n.push(...i);return t.set(r.summary,r.getSummary(n)),t}static estimateValueByOrigin(e,t){const n=r.estimateIfConnectionWasReused(e),s=r.groupByOrigin(e),i=new Map;for(const[e,r]of s.entries()){let s=[];for(const e of r){const r=e.timing;if(!r)continue;const i=t({request:e,timing:r,connectionReused:n.get(e.requestId)});void 0!==i&&(s=s.concat(i))}s.length&&i.set(e,s)}return i}static estimateRTTViaConnectionTiming(e){const{timing:t,connectionReused:r,request:n}=e;if(r)return;const{connectStart:s,sslStart:i,sslEnd:o,connectEnd:a}=t;return a>=0&&s>=0&&n.protocol.startsWith("h3")?a-s:i>=0&&o>=0&&i!==s?[a-i,i-s]:s>=0&&a>=0?a-s:void 0}static estimateRTTViaDownloadTiming(e){const{timing:t,connectionReused:r,request:n}=e;if(r)return;if(n.transferSize<=14336)return;if(!Number.isFinite(t.receiveHeadersEnd)||t.receiveHeadersEnd<0)return;const s=n.networkEndTime-n.networkRequestTime-t.receiveHeadersEnd,i=Math.log2(n.transferSize/14336);return i>5?void 0:s/i}static estimateRTTViaSendStartTiming(e){const{timing:t,connectionReused:r,request:n}=e;if(r)return;if(!Number.isFinite(t.sendStart)||t.sendStart<0)return;let s=1;return n.protocol.startsWith("h3")||(s+=1),"https"===n.parsedURL.scheme&&(s+=1),t.sendStart/s}static estimateRTTViaHeadersEndTiming(e){const{timing:t,connectionReused:r,request:s}=e;if(!Number.isFinite(t.receiveHeadersEnd)||t.receiveHeadersEnd<0)return;if(!s.resourceType)return;const i=n[s.resourceType]||.4,o=t.receiveHeadersEnd*i;let a=1;return r||(a+=1,s.protocol.startsWith("h3")||(a+=1),"https"===s.parsedURL.scheme&&(a+=1)),Math.max((t.receiveHeadersEnd-o)/a,3)}static estimateResponseTimeByOrigin(e,t){return r.estimateValueByOrigin(e,({request:e,timing:n})=>{if(void 0!==e.serverResponseTime)return e.serverResponseTime;if(!Number.isFinite(n.receiveHeadersEnd)||n.receiveHeadersEnd<0)return;if(!Number.isFinite(n.sendEnd)||n.sendEnd<0)return;const s=n.receiveHeadersEnd-n.sendEnd,i=e.parsedURL.securityOrigin,o=t.get(i)||t.get(r.summary)||0;return Math.max(s-o,0)})}static canTrustConnectionInformation(e){const t=new Map;for(const r of e){const e=t.get(r.connectionId)||!r.connectionReused;t.set(r.connectionId,e)}return!(t.size<=1)&&Array.from(t.values()).every(e=>e)}static estimateIfConnectionWasReused(e,t){const{forceCoarseEstimates:n=!1}=t||{};if(!n&&r.canTrustConnectionInformation(e))return new Map(e.map(e=>[e.requestId,Boolean(e.connectionReused)]));const s=new Map,i=r.groupByOrigin(e);for(const e of i.values()){const t=e.map(e=>e.networkEndTime).reduce((e,t)=>Math.min(e,t),1/0);for(const r of e)s.set(r.requestId,r.networkRequestTime>=t||"h2"===r.protocol);const r=e.reduce((e,t)=>e.networkRequestTime>t.networkRequestTime?t:e);s.set(r.requestId,!1)}return s}static estimateRTTByOrigin(t,n){const{forceCoarseEstimates:s=!1,coarseEstimateMultiplier:i=.3,useDownloadEstimates:o=!0,useSendStartEstimates:a=!0,useHeadersEndEstimates:c=!0}=n||{},u=r.estimateIfConnectionWasReused(t),m=r.groupByOrigin(t),d=new Map;for(const[l,h]of m.entries()){const g=[];function f(e,t=1){for(const r of h){const n=r.timing;if(!n||!r.transferSize)continue;const s=e({request:r,timing:n,connectionReused:u.get(r.requestId)});void 0!==s&&(Array.isArray(s)?g.push(...s.map(e=>e*t)):g.push(s*t))}}s||f(this.estimateRTTViaConnectionTiming),g.length||(o&&f(this.estimateRTTViaDownloadTiming,i),a&&f(this.estimateRTTViaSendStartTiming,i),c&&f(this.estimateRTTViaHeadersEndTiming,i)),g.length&&d.set(l,g)}if(!d.size)throw new e("No timing information available");return r.summarize(d)}static estimateServerResponseTimeByOrigin(e,t){let n=t?.rttByOrigin;if(!n){n=new Map;const s=r.estimateRTTByOrigin(e,t);for(const[e,t]of s.entries())n.set(e,t.min)}const s=r.estimateResponseTimeByOrigin(e,n);return r.summarize(s)}static estimateThroughput(e){let t=0;const r=e.reduce((e,r)=>{const n=r.parsedURL?.scheme;return"data"===n||r.failed||!r.finished||r.statusCode>300||!r.transferSize||(t+=r.transferSize,e.push({time:r.responseHeadersEndTime/1e3,isStart:!0}),e.push({time:r.networkEndTime/1e3,isStart:!1})),e},[]).sort((e,t)=>e.time-t.time);if(!r.length)return null;let n=0,s=0,i=0;return r.forEach(e=>{e.isStart?(0===n&&(s=e.time),n++):(n--,0===n&&(i+=e.time-s))}),8*t/i}static computeRTTAndServerResponseTime(e){const t=new Map;for(const[n,s]of r.estimateRTTByOrigin(e).entries())t.set(n,s.min);const n=Math.min(...Array.from(t.values())),s=r.estimateServerResponseTimeByOrigin(e,{rttByOrigin:t}),i=new Map,o=new Map;for(const[e,r]of s.entries()){const s=t.get(e)||n;i.set(e,s-n),o.set(e,r.median)}return{rtt:n,additionalRttByOrigin:i,serverResponseTimeByOrigin:o}}static analyze(e){const t=r.estimateThroughput(e);return null===t?null:{throughput:t,...r.computeRTTAndServerResponseTime(e)}}static findResourceForUrl(e,r){return e.find(e=>r.startsWith(e.url)&&t.equalWithExcludedFragments(e.url,r))}static findLastDocumentForUrl(e,r){const n=e.filter(e=>"Document"===e.resourceType&&!e.failed&&r.startsWith(e.url)&&t.equalWithExcludedFragments(e.url,r));return n[n.length-1]}static resolveRedirects(e){for(;e.redirectDestination;)e=e.redirectDestination;return e}}export{e as LanternError,r as NetworkAnalyzer};