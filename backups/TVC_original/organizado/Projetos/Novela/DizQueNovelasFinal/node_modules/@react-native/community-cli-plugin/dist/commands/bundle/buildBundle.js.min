"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unstable_buildBundleWithConfig=exports.default=void 0;var _loadMetroConfig=_interopRequireDefault(require("../../utils/loadMetroConfig")),_parseKeyValueParamArray=_interopRequireDefault(require("../../utils/parseKeyValueParamArray")),_saveAssets=_interopRequireDefault(require("./saveAssets")),_fs=require("fs"),_metro=require("metro"),_path=_interopRequireDefault(require("path")),_util=require("util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}async function buildBundle(e,t,r,s){return buildBundleWithConfig(r,await(0,_loadMetroConfig.default)(t,{maxWorkers:r.maxWorkers,resetCache:r.resetCache,config:r.config}),s)}async function buildBundleWithConfig(e,t,r){const s=(0,_parseKeyValueParamArray.default)(e.resolverOption??[]);if(-1===t.resolver.platforms.indexOf(e.platform))throw console.error(`${(0,_util.styleText)("red","error")}: Invalid platform ${e.platform?`"${(0,_util.styleText)("bold",e.platform)}" `:""}selected.`),console.info(`Available platforms are: ${t.resolver.platforms.map(e=>`"${(0,_util.styleText)("bold",e)}"`).join(", ")}. If you are trying to bundle for an out-of-tree platform, it may not be installed.`),new Error("Bundling failed");process.env.NODE_ENV=e.dev?"development":"production";let o=e.sourcemapOutput;null==o||e.sourcemapUseAbsolutePath||(o=_path.default.basename(o));const u={assets:null!=e.assetsDest,bundleOut:e.bundleOutput,customResolverOptions:s,dev:e.dev,entry:e.entryFile,minify:void 0!==e.minify?e.minify:!e.dev,output:r,platform:e.platform,sourceMap:null!=e.sourcemapOutput,sourceMapOut:e.sourcemapOutput,sourceMapUrl:o,unstable_transformProfile:e.unstableTransformProfile};await _fs.promises.mkdir(_path.default.dirname(e.bundleOutput),{recursive:!0,mode:493});const l=await(0,_metro.runBuild)(t,u);if(null==e.assetsDest)return void console.warn("Warning: Assets destination folder is not set, skipping...");if(null==l.assets)throw new Error("Assets missing from Metro's runBuild result");const a=l.assets;await(0,_saveAssets.default)(a,e.platform,e.assetsDest,e.assetCatalogDest)}const unstable_buildBundleWithConfig=exports.unstable_buildBundleWithConfig=buildBundleWithConfig;var _default=exports.default=buildBundle;