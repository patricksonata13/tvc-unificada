"use strict";function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}const{UnsupportedObjectPropertyTypeAnnotationParserError:UnsupportedObjectPropertyTypeAnnotationParserError}=require("../errors"),{buildModuleSchema:buildModuleSchema,buildPropSchema:buildPropSchema,buildSchema:buildSchema,handleGenericTypeAnnotation:handleGenericTypeAnnotation}=require("../parsers-commons"),{Visitor:Visitor}=require("../parsers-primitives"),{wrapComponentSchema:wrapComponentSchema}=require("../schema.js"),{buildComponentSchema:buildComponentSchema}=require("./components"),{flattenProperties:flattenProperties,getSchemaInfo:getSchemaInfo,getTypeAnnotation:getTypeAnnotation}=require("./components/componentsUtils"),{flowTranslateTypeAnnotation:flowTranslateTypeAnnotation}=require("./modules"),{parseFlowAndThrowErrors:parseFlowAndThrowErrors}=require("./parseFlowAndThrowErrors"),fs=require("fs"),invariant=require("invariant");class FlowParser{constructor(){_defineProperty(this,"typeParameterInstantiation","TypeParameterInstantiation"),_defineProperty(this,"typeAlias","TypeAlias"),_defineProperty(this,"enumDeclaration","EnumDeclaration"),_defineProperty(this,"interfaceDeclaration","InterfaceDeclaration"),_defineProperty(this,"nullLiteralTypeAnnotation","NullLiteralTypeAnnotation"),_defineProperty(this,"undefinedLiteralTypeAnnotation","VoidLiteralTypeAnnotation")}isProperty(e){return"ObjectTypeProperty"===e.type}getKeyName(e,t){if(!this.isProperty(e))throw new UnsupportedObjectPropertyTypeAnnotationParserError(t,e,e.type,this.language());return e.key.name}language(){return"Flow"}getTypeAnnotationName(e){var t,n;return"QualifiedTypeIdentifier"===(null==e||null===(t=e.id)||void 0===t?void 0:t.type)?e.id.id.name:null==e||null===(n=e.id)||void 0===n?void 0:n.name}checkIfInvalidModule(e){return"TypeParameterInstantiation"!==e.type||1!==e.params.length||"GenericTypeAnnotation"!==e.params[0].type||"Spec"!==e.params[0].id.name}remapUnionTypeAnnotationMemberNames(e){return[...new Set(e.map(e=>e.type.replace("NumberLiteralTypeAnnotation","NumberTypeAnnotation").replace("StringLiteralTypeAnnotation","StringTypeAnnotation")))]}getStringLiteralUnionTypeAnnotationStringLiterals(e){return e.map(e=>e.value)}parseFile(e){const t=fs.readFileSync(e,"utf8");return this.parseString(t,e)}parseString(e,t){return buildSchema(e,t,wrapComponentSchema,buildComponentSchema,buildModuleSchema,Visitor,this,flowTranslateTypeAnnotation)}parseModuleFixture(e){const t=fs.readFileSync(e,"utf8");return this.parseString(t,"path/NativeSampleTurboModule.js")}getAst(e,t){return parseFlowAndThrowErrors(e,{filename:t})}getFunctionTypeAnnotationParameters(e){return e.params}getFunctionNameFromParameter(e){return e.name}getParameterName(e){return e.name.name}getParameterTypeAnnotation(e){return e.typeAnnotation}getFunctionTypeAnnotationReturnType(e){return e.returnType}parseEnumMembersType(e){const t="EnumStringBody"===e.type?"StringTypeAnnotation":"EnumNumberBody"===e.type?"NumberTypeAnnotation":null;if(!t)throw new Error(`Unknown enum type annotation type. Got: ${e.type}. Expected: EnumStringBody or EnumNumberBody.`);return t}validateEnumMembersSupported(e,t){if(!e.members||0===e.members.length)throw new Error("Enums should have at least one member and member values can not be mixed- they all must be either blank, number, or string values.");e.members.forEach(e=>{if(("StringTypeAnnotation"!==t||e.init&&"string"!=typeof e.init.value)&&("NumberTypeAnnotation"!==t||!e.init||"number"!=typeof e.init.value))throw new Error("Enums can not be mixed- they all must be either blank, number, or string values.")})}parseEnumMembers(e){return e.members.map(e=>{var t,n;const r="number"==typeof(null===(t=e.init)||void 0===t?void 0:t.value)?{type:"NumberLiteralTypeAnnotation",value:e.init.value}:"string"==typeof(null===(n=e.init)||void 0===n?void 0:n.value)?{type:"StringLiteralTypeAnnotation",value:e.init.value}:{type:"StringLiteralTypeAnnotation",value:e.id.name};return{name:e.id.name,value:r}})}isModuleInterface(e){return"InterfaceDeclaration"===e.type&&1===e.extends.length&&"InterfaceExtends"===e.extends[0].type&&"TurboModule"===e.extends[0].id.name}isGenericTypeAnnotation(e){return"GenericTypeAnnotation"===e}extractAnnotatedElement(e,t){return t[e.typeParameters.params[0].id.name]}getTypes(e){return e.body.reduce((e,t)=>("ExportNamedDeclaration"===t.type&&"type"===t.exportKind?null==t.declaration||"TypeAlias"!==t.declaration.type&&"OpaqueType"!==t.declaration.type&&"InterfaceDeclaration"!==t.declaration.type||(e[t.declaration.id.name]=t.declaration):"ExportNamedDeclaration"===t.type&&"value"===t.exportKind&&t.declaration&&"EnumDeclaration"===t.declaration.type?e[t.declaration.id.name]=t.declaration:"TypeAlias"!==t.type&&"OpaqueType"!==t.type&&"InterfaceDeclaration"!==t.type&&"EnumDeclaration"!==t.type||(e[t.id.name]=t),e),{})}callExpressionTypeParameters(e){return e.typeArguments||null}computePartialProperties(e,t,n,r,o,a,i){return e.map(e=>({name:e.key.name,optional:!0,typeAnnotation:flowTranslateTypeAnnotation(t,e.value,n,r,o,a,i,this)}))}functionTypeAnnotation(e){return"FunctionTypeAnnotation"===e}getTypeArgumentParamsFromDeclaration(e){return e.typeArguments.params}getNativeComponentType(e,t){return{propsTypeName:e[0].id.name,componentName:t[0].value}}getAnnotatedElementProperties(e){return e.right.properties}bodyProperties(e){return e.body.properties}convertKeywordToTypeAnnotation(e){return e}argumentForProp(e){return e.argument}nameForArgument(e){return e.argument.id.name}isOptionalProperty(e){return"NullableTypeAnnotation"===e.value.type||e.optional}getGetSchemaInfoFN(){return getSchemaInfo}getTypeAnnotationFromProperty(e){return"NullableTypeAnnotation"===e.value.type?e.value.typeAnnotation:e.value}getGetTypeAnnotationFN(){return getTypeAnnotation}getResolvedTypeAnnotation(e,t,n){invariant(null!=e,"resolveTypeAnnotation(): typeAnnotation cannot be null");let r=e,o=!1,a={successful:!1};for(;;){if("NullableTypeAnnotation"===r.type){o=!0,r=r.typeAnnotation;continue}if("GenericTypeAnnotation"!==r.type)break;const e=t[this.getTypeAnnotationName(r)];if(null==e)break;const{typeAnnotation:n,typeResolutionStatus:i}=handleGenericTypeAnnotation(r,e,this);a=i,r=n}return{nullable:o,typeAnnotation:r,typeResolutionStatus:a}}getResolveTypeAnnotationFN(){return(e,t,n)=>this.getResolvedTypeAnnotation(e,t,n)}extendsForProp(e,t,n){this.argumentForProp(e)||console.log("null",e);const r=n.nameForArgument(e);if(null!=t[r])return null;if("ViewProps"===r)return{type:"ReactNativeBuiltInType",knownTypeName:"ReactNativeCoreViewProps"};throw new Error(`Unable to handle prop spread: ${r}`)}removeKnownExtends(e,t){return e.filter(e=>"ObjectTypeSpreadProperty"!==e.type||null===this.extendsForProp(e,t,this))}getExtendsProps(e,t){return e.filter(e=>"ObjectTypeSpreadProperty"===e.type).map(e=>this.extendsForProp(e,t,this)).filter(Boolean)}getProps(e,t){const n=this.removeKnownExtends(e,t);return{props:flattenProperties(n,t,this).map(e=>buildPropSchema(e,t,this)).filter(Boolean),extendsProps:this.getExtendsProps(e,t)}}getProperties(e,t){const n=t[e];try{return n.right.typeParameters.params[0].properties}catch(t){throw new Error(`Failed to find type definition for "${e}", please check that you have a valid codegen flow file`)}}nextNodeForTypeAlias(e){return"OpaqueType"===e.type?e.impltype:e.right}nextNodeForEnum(e){return e.body}genericTypeAnnotationErrorMessage(e){return`A non GenericTypeAnnotation must be a type declaration ('${this.typeAlias}') or enum ('${this.enumDeclaration}'). Instead, got the unsupported ${e.type}.`}extractTypeFromTypeAnnotation(e){return"GenericTypeAnnotation"===e.type?e.id.name:e.type}getObjectProperties(e){return e.properties}getLiteralValue(e){return e.value}getPaperTopLevelNameDeprecated(e){return e.typeParameters.params.length>1?e.typeParameters.params[1].value:null}}module.exports={FlowParser:FlowParser};