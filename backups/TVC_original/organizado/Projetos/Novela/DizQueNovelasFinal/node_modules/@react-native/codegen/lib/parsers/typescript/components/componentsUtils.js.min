"use strict";const{verifyPropNotAlreadyDefined:verifyPropNotAlreadyDefined}=require("../../parsers-commons"),{flattenIntersectionType:flattenIntersectionType,parseTopLevelType:parseTopLevelType}=require("../parseTopLevelType");function getUnionOfLiterals(e,t,n,r,o){var a,i;if(n.reduce((t,n)=>{const r=t&&"TSLiteralType"===t.type?t.literal.type:t.type,o="TSLiteralType"===n.type?n.literal.type:n.type;if(r&&o!==r)throw new Error(`Mixed types are not supported (see "${e}")`);return n}),void 0===r)throw new Error(`A default enum value is required for "${e}"`);const p=n[0].type;if("TSLiteralType"===p&&"StringLiteral"===(null===(a=n[0].literal)||void 0===a?void 0:a.type))return{type:"StringEnumTypeAnnotation",default:r,options:n.map(e=>e.literal.value)};if("TSLiteralType"===p&&"NumericLiteral"===(null===(i=n[0].literal)||void 0===i?void 0:i.type)){if(t)throw new Error(`Arrays of int enums are not supported (see: "${e}")`);return{type:"Int32EnumTypeAnnotation",default:r,options:n.map(e=>e.literal.value)}}var y;throw new Error(`Unsupported union type for "${e}", received "${"TSLiteralType"===p?null===(y=n[0].literal)||void 0===y?void 0:y.type:p}"`)}function detectArrayType(e,t,n,r,o,a){return"TSTypeOperator"===t.type&&"readonly"===t.operator&&"TSArrayType"===t.typeAnnotation.type?{type:"ArrayTypeAnnotation",elementType:getTypeAnnotationForArray(e,t.typeAnnotation.elementType,n,r,o,a)}:"TSArrayType"===t.type?{type:"ArrayTypeAnnotation",elementType:getTypeAnnotationForArray(e,t.elementType,n,r,o,a)}:"TSTypeReference"!==t.type||"ReadonlyArray"!==o.getTypeAnnotationName(t)&&"Array"!==o.getTypeAnnotationName(t)?null:{type:"ArrayTypeAnnotation",elementType:getTypeAnnotationForArray(e,t.typeParameters.params[0],n,r,o,a)}}function buildObjectType(e,t,n,r){return{type:"ObjectTypeAnnotation",properties:flattenProperties(e,t,n).map(e=>r(e,t,n)).filter(Boolean)}}function getPrimitiveTypeAnnotation(e){switch(e){case"Int32":return{type:"Int32TypeAnnotation"};case"Double":return{type:"DoubleTypeAnnotation"};case"Float":return{type:"FloatTypeAnnotation"};case"TSBooleanKeyword":return{type:"BooleanTypeAnnotation"};case"Stringish":case"TSStringKeyword":return{type:"StringTypeAnnotation"};default:throw new Error(`Unknown primitive type "${e}"`)}}function getCommonTypeAnnotation(e,t,n,r,o,a,i,p){switch(n){case"TSTypeLiteral":return buildObjectType(r.members,a,i,p);case"TSInterfaceDeclaration":return buildObjectType([r],a,i,p);case"TSIntersectionType":return buildObjectType(flattenIntersectionType(r,i,a),a,i,p);case"ImageSource":return{type:"ReservedPropTypeAnnotation",name:"ImageSourcePrimitive"};case"ImageRequest":return{type:"ReservedPropTypeAnnotation",name:"ImageRequestPrimitive"};case"ColorValue":case"ProcessedColorValue":return{type:"ReservedPropTypeAnnotation",name:"ColorPrimitive"};case"PointValue":return{type:"ReservedPropTypeAnnotation",name:"PointPrimitive"};case"EdgeInsetsValue":return{type:"ReservedPropTypeAnnotation",name:"EdgeInsetsPrimitive"};case"DimensionValue":return{type:"ReservedPropTypeAnnotation",name:"DimensionPrimitive"};case"TSUnionType":return getUnionOfLiterals(e,t,r.types,o,a);case"Int32":case"Double":case"Float":case"TSBooleanKeyword":case"Stringish":case"TSStringKeyword":return getPrimitiveTypeAnnotation(n);case"UnsafeMixed":return{type:"MixedTypeAnnotation"};default:return}}function getTypeAnnotationForArray(e,t,n,r,o,a){var i;const p=parseTopLevelType(t,o,r);if(void 0!==p.defaultValue)throw new Error('Nested optionals such as "ReadonlyArray<boolean | null | undefined>" are not supported, please declare optionals at the top level of value definitions as in "ReadonlyArray<boolean> | null | undefined"');if(p.optional)throw new Error('Nested optionals such as "ReadonlyArray<boolean | null | undefined>" are not supported, please declare optionals at the top level of value definitions as in "ReadonlyArray<boolean> | null | undefined"');const y=p.type,l=detectArrayType(e,y,n,r,o,a);if(l){if("ObjectTypeAnnotation"!==l.elementType.type)throw new Error(`Only array of array of object is supported for "${e}".`);return l}const s="TSTypeReference"===y.elementType?o.getTypeAnnotationName(y.elementType):(null===(i=y.elementType)||void 0===i?void 0:i.type)||o.getTypeAnnotationName(y)||y.type,u=getCommonTypeAnnotation(e,!0,s,y,n,r,o,a);if(u)return u;if("TSNumberKeyword"===s)return{type:"FloatTypeAnnotation"};throw new Error(`Unknown prop type for "${e}": ${s}`)}function setDefaultValue(e,t){switch(e.type){case"Int32TypeAnnotation":case"DoubleTypeAnnotation":e.default=t||0;break;case"FloatTypeAnnotation":e.default=null===t?null:t||0;break;case"BooleanTypeAnnotation":e.default=null===t?null:!!t;break;case"StringTypeAnnotation":e.default=void 0===t?null:t}}function getTypeAnnotation(e,t,n,r,o,a,i){const p=parseTopLevelType(t,a,o).type,y=detectArrayType(e,p,n,o,a,i);if(y)return y;const l="TSTypeReference"===p.type||"TSTypeAliasDeclaration"===p.type?a.getTypeAnnotationName(p):p.type,s=getCommonTypeAnnotation(e,!1,l,p,n,o,a,i);if(s)return setDefaultValue(s,n),s;switch(l){case"ColorArrayValue":return{type:"ArrayTypeAnnotation",elementType:{type:"ReservedPropTypeAnnotation",name:"ColorPrimitive"}};case"TSNumberKeyword":throw new Error(`Cannot use "${l}" type annotation for "${e}": must use a specific numeric type like Int32, Double, or Float`);case"TSFunctionType":throw new Error(`Cannot use "${l}" type annotation for "${e}": must use a specific function type like BubblingEventHandler, or DirectEventHandler`);default:throw new Error(`Unknown prop type for "${e}": "${l}"`)}}function getSchemaInfo(e,t,n){const r=parseTopLevelType(e.typeAnnotation.typeAnnotation,n,t),o=e.key.name;if(!e.optional&&void 0!==r.defaultValue)throw new Error(`key ${o} must be optional if used with WithDefault<> annotation`);return{name:o,optional:e.optional||r.optional,typeAnnotation:r.type,defaultValue:r.defaultValue,withNullDefault:!1}}function flattenProperties(e,t,n){return e.map(e=>{if("TSPropertySignature"===e.type)return e;if("TSTypeReference"===e.type)return flattenProperties(n.getProperties(e.typeName.name,t),t,n);if("TSExpressionWithTypeArguments"===e.type||"TSInterfaceHeritage"===e.type)return flattenProperties(n.getProperties(e.expression.name,t),t,n);if("TSTypeLiteral"===e.type)return flattenProperties(e.members,t,n);if("TSInterfaceDeclaration"===e.type)return flattenProperties(n.getProperties(e.id.name,t),t,n);if("TSIntersectionType"===e.type)return flattenProperties(e.types,t,n);throw new Error(`${e.type} is not a supported object literal type.`)}).filter(Boolean).reduce((e,t)=>Array.isArray(t)?(t.forEach(t=>{verifyPropNotAlreadyDefined(e,t)}),e.concat(t)):(verifyPropNotAlreadyDefined(e,t),e.push(t),e),[]).filter(Boolean)}module.exports={getSchemaInfo:getSchemaInfo,getTypeAnnotation:getTypeAnnotation,getPrimitiveTypeAnnotation:getPrimitiveTypeAnnotation,flattenProperties:flattenProperties};