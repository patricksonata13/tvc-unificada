"use strict";const{indent:indent}=require("../Utils"),{IncludeTemplate:IncludeTemplate,generateEventStructName:generateEventStructName}=require("./CppHelpers"),FileTemplate=({events:e,extraIncludes:n,headerPrefix:t})=>`\n/**\n * This code was generated by [react-native-codegen](https://www.npmjs.com/package/react-native-codegen).\n *\n * Do not edit this file as changes may cause incorrect behavior and will be lost\n * once the code is regenerated.\n *\n * @generated by codegen project: GenerateEventEmitterCpp.js\n */\n\n${IncludeTemplate({headerPrefix:t,file:"EventEmitters.h"})}\n${[...n].join("\n")}\n\nnamespace facebook::react {\n${e}\n} // namespace facebook::react\n`,ComponentTemplate=({className:e,eventName:n,structName:t,dispatchEventName:r,implementation:a})=>`\nvoid ${e}EventEmitter::${n}(${t} event) const {\n  dispatchEvent("${r}", [${a.includes("event")?"event=std::move(event)":""}](jsi::Runtime &runtime) {\n    ${a}\n  });\n}\n`,BasicComponentTemplate=({className:e,eventName:n,dispatchEventName:t})=>`\nvoid ${e}EventEmitter::${n}() const {\n  dispatchEvent("${t}");\n}\n`.trim();function generateSetter(e,n,t,r,a=e=>e){const o=r?`event.${[...t,n].join(".")}`:[...t,n].join(".");return`${e}.setProperty(runtime, "${n}", ${a(o)});`}function generateObjectSetter(e,n,t,r,a,o){return`\n{\n  auto ${n} = jsi::Object(runtime);\n  ${indent(generateSetters(n,r.properties,t.concat([n]),a,o),2)}\n  ${e}.setProperty(runtime, "${n}", ${n});\n}\n`.trim()}function setValueAtIndex(e,n,t,r=e=>e){return`${e}.setValueAtIndex(runtime, ${n}++, ${r(t)});`}function generateArraySetter(e,n,t,r,a,o){const i=o?`event.${[...t,n].join(".")}`:[...t,n].join("."),c=`${n}Index`,s=`${n}Value`;return`\n    auto ${n} = jsi::Array(runtime, ${i}.size());\n    size_t ${c} = 0;\n    for (auto ${s} : ${i}) {\n      ${handleArrayElementType(r,n,c,s,t,a,o)}\n    }\n    ${e}.setProperty(runtime, "${n}", ${n});\n  `}function handleArrayElementType(e,n,t,r,a,o,i){switch(e.type){case"BooleanTypeAnnotation":return setValueAtIndex(n,t,r,e=>`(bool)${e}`);case"StringTypeAnnotation":case"Int32TypeAnnotation":case"DoubleTypeAnnotation":case"FloatTypeAnnotation":return setValueAtIndex(n,t,r);case"MixedTypeAnnotation":return setValueAtIndex(n,t,r,e=>`jsi::valueFromDynamic(runtime, ${e})`);case"StringLiteralUnionTypeAnnotation":return setValueAtIndex(n,t,r,e=>`toString(${e})`);case"ObjectTypeAnnotation":return convertObjectTypeArray(n,t,r,a,e,o);case"ArrayTypeAnnotation":return convertArrayTypeArray(n,t,r,a,e,o,i);default:throw new Error(`Received invalid elementType for array ${e.type}`)}}function convertObjectTypeArray(e,n,t,r,a,o){return`auto ${e}Object = jsi::Object(runtime);\n      ${generateSetters(`${e}Object`,a.properties,[].concat([t]),o,!1)}\n      ${setValueAtIndex(e,n,`${e}Object`)}`}function convertArrayTypeArray(e,n,t,r,a,o,i){if("ArrayTypeAnnotation"!==a.type)throw new Error(`Inconsistent eventTypeAnnotation received. Expected type = 'ArrayTypeAnnotation'; received = ${a.type}`);return`auto ${e}Array = jsi::Array(runtime, ${t}.size());\n      size_t ${n}Internal = 0;\n      for (auto ${t}Internal : ${t}) {\n        ${handleArrayElementType(a.elementType,`${e}Array`,`${n}Internal`,`${t}Internal`,r,o,i)}\n      }\n      ${setValueAtIndex(e,n,`${e}Array`)}`}function generateSetters(e,n,t,r,a=!0){return n.map(n=>{const{typeAnnotation:o}=n;switch(o.type){case"BooleanTypeAnnotation":case"StringTypeAnnotation":case"Int32TypeAnnotation":case"DoubleTypeAnnotation":case"FloatTypeAnnotation":return generateSetter(e,n.name,t,a);case"MixedTypeAnnotation":return r.add("#include <jsi/JSIDynamic.h>"),generateSetter(e,n.name,t,a,e=>`jsi::valueFromDynamic(runtime, ${e})`);case"StringLiteralUnionTypeAnnotation":return generateSetter(e,n.name,t,a,e=>`toString(${e})`);case"ObjectTypeAnnotation":return generateObjectSetter(e,n.name,t,o,r,a);case"ArrayTypeAnnotation":return generateArraySetter(e,n.name,t,o.elementType,r,a);default:throw o.type,new Error(`Received invalid event property type ${o.type}`)}}).join("\n")}function generateEvent(e,n,t){const r=null!=n.paperTopLevelNameDeprecated?n.paperTopLevelNameDeprecated:`${n.name[2].toLowerCase()}${n.name.slice(3)}`;if(n.typeAnnotation.argument){const a=`\n    auto payload = jsi::Object(runtime);\n    ${generateSetters("payload",n.typeAnnotation.argument.properties,[],t)}\n    return payload;\n  `.trim();if(!n.name.startsWith("on"))throw new Error("Expected the event name to start with `on`");return ComponentTemplate({className:e,eventName:n.name,dispatchEventName:r,structName:generateEventStructName([n.name]),implementation:a})}return BasicComponentTemplate({className:e,eventName:n.name,dispatchEventName:r})}module.exports={generate(e,n,t,r=!1,a){const o=Object.keys(n.modules).map(e=>{const t=n.modules[e];if("Component"!==t.type)return;const{components:r}=t;return null==r?null:r}).filter(Boolean).reduce((e,n)=>Object.assign(e,n),{}),i=new Set,c=Object.keys(o).map(e=>o[e].events.map(n=>generateEvent(e,n,i)).join("\n")).join("\n"),s=FileTemplate({events:c,extraIncludes:i,headerPrefix:null!=a?a:""});return new Map([["EventEmitters.cpp",s]])}};