import*as e from"../../../core/sdk/sdk.js";import*as t from"../types/types.js";import*as n from"../../../core/platform/platform.js";import*as r from"../helpers/helpers.js";import*as i from"../handlers/handlers.js";import*as a from"../../../core/common/common.js";const s=new Map,o=new Map;async function l(t,n){const i=s.get(t)?.get(n);if(void 0!==i)return i;const r=e.TargetManager.TargetManager.instance().primaryPageTarget(),a=r?.model(e.DOMModel.DOMModel);if(!a)return null;const o=await a.pushNodesByBackendIdsToFrontend(new Set([n])),l=o?.get(n)||null,c=s.get(t)||new Map;return c.set(n,l),s.set(t,c),l}const c=new WeakMap;function d(e,n){const i=c.get(n);if(i)return i;const r=new Set;if(t.Events.isLayout(n))n.args.endData?.layoutRoots.forEach(e=>r.add(e.nodeId));else if(t.Events.isSyntheticLayoutShift(n)&&n.args.data?.impacted_nodes)n.args.data.impacted_nodes.forEach(e=>r.add(e.node_id));else if(t.Events.isLargestContentfulPaintCandidate(n)&&void 0!==n.args.data?.nodeId)r.add(n.args.data.nodeId);else if(t.Events.isPaint(n)&&void 0!==n.args.data.nodeId)r.add(n.args.data.nodeId);else if(t.Events.isPaintImage(n)&&void 0!==n.args.data.nodeId)r.add(n.args.data.nodeId);else if(t.Events.isScrollLayer(n)&&void 0!==n.args.data.nodeId)r.add(n.args.data.nodeId);else if(t.Events.isSyntheticAnimation(n)&&void 0!==n.args.data.beginEvent.args.data.nodeId)r.add(n.args.data.beginEvent.args.data.nodeId);else if(t.Events.isDecodeImage(n)){const t=e.ImagePainting.paintImageForEvent.get(n);void 0!==t?.args.data.nodeId&&r.add(t.args.data.nodeId)}else if(t.Events.isDrawLazyPixelRef(n)&&n.args?.LazyPixelRef){const t=e.ImagePainting.paintImageByDrawLazyPixelRef.get(n.args.LazyPixelRef);void 0!==t?.args.data.nodeId&&r.add(t.args.data.nodeId)}else t.Events.isParseMetaViewport(n)&&void 0!==n.args?.data.node_id&&r.add(n.args.data.node_id);return c.set(n,r),r}async function u(t,n){const i=o.get(t)?.get(n);if(i)return i;const r=e.TargetManager.TargetManager.instance().primaryPageTarget(),s=r?.model(e.DOMModel.DOMModel);if(!s)return new Map;const a=await s.pushNodesByBackendIdsToFrontend(new Set(n))||new Map,l=o.get(t)||new Map;return l.set(n,a),o.set(t,l),a}const h=new Map,p=new Map;var m=Object.freeze({__proto__:null,clearCacheForTesting:function(){s.clear(),o.clear(),h.clear(),p.clear()},domNodeForBackendNodeID:l,domNodesForMultipleBackendNodeIds:u,extractRelatedDOMNodesFromEvent:async function(e,t){const n=d(e,t);return n.size?await u(e,Array.from(n)):null},nodeIdsForEvent:d,normalizedImpactedNodesForLayoutShift:async function(t,n){const i=p.get(t)?.get(n);if(i)return i;const r=n.args?.data?.impacted_nodes;if(!r)return[];let s=null;const a=e.TargetManager.TargetManager.instance().primaryPageTarget(),o=await(a?.runtimeAgent().invoke_evaluate({expression:"window.devicePixelRatio"}));if("number"===o?.result.type&&(s=o?.result.value??null),!s)return r;const l=[];for(const e of r){const t={...e};for(let n=0;n<e.old_rect.length;n++)t.old_rect[n]/=s;for(let n=0;n<e.new_rect.length;n++)t.new_rect[n]/=s;l.push(t)}const c=p.get(t)||new Map;return c.set(n,l),p.set(t,c),l},sourcesForLayoutShift:async function(e,t){const n=h.get(e)?.get(t);if(n)return n;const i=t.args.data?.impacted_nodes;if(!i)return[];const r=[];await Promise.all(i.map(async t=>{const n=await l(e,t.node_id);n&&r.push({previousRect:new DOMRect(t.old_rect[0],t.old_rect[1],t.old_rect[2],t.old_rect[3]),currentRect:new DOMRect(t.new_rect[0],t.new_rect[1],t.new_rect[2],t.new_rect[3]),node:n})}));const s=h.get(e)||new Map;return s.set(t,r),h.set(e,s),r}});const f=new WeakMap;var g=Object.freeze({__proto__:null,frameClosestToTimestamp:function(e,t){const i=n.ArrayUtilities.nearestIndexFromEnd(e.frames,e=>e.screenshotEvent.ts<t);return null===i?null:e.frames[i]},fromParsedTrace:function(e,t){const i=[],r=void 0!==t?t:e.Meta.traceBounds.min,s=e.Meta.traceBounds.range,a=f.get(e)?.get(r);if(a)return a;const o=e.Screenshots.screenshots??e.Screenshots.legacySyntheticScreenshots??[];for(const e of o){if(e.ts<r)continue;const t={index:i.length,screenshotEvent:e};i.push(t)}const l={zeroTime:r,spanTime:s,frames:Array.from(i)};return n.MapUtilities.getWithDefault(f,e,()=>new Map).set(r,l),l}});const v=new Set(["(program)","(idle)","(root)"]);var T=Object.freeze({__proto__:null,calculateWindow:function(e,n){if(!n.length)return e;const i=n.filter(e=>!(t.Events.isProfileCall(e)&&(v.has(e.callFrame.functionName)||!e.callFrame.functionName)));if(0===i.length)return e;function s(e,t){let n=e;const s=i[n],a=r.Timing.eventTimingsMicroSeconds(s);let o=(a.startTime+a.endTime)/2,l=0;const c=Math.sign(t-e);for(let s=e;s!==t;s+=c){const e=i[s],t=r.Timing.eventTimingsMicroSeconds(e),a=(t.startTime+t.endTime)/2;l<.1*Math.abs(o-a)&&(n=s,o=a,l=0),l+=t.duration}return n}const a=s(i.length-1,0),o=s(0,a),l=r.Timing.eventTimingsMicroSeconds(i[o]),c=r.Timing.eventTimingsMicroSeconds(i[a]);let d=l.startTime,u=c.endTime;const h=u-d;return h<.1*e.range?e:(d=t.Timing.Micro(Math.max(d-.05*h,e.min)),u=t.Timing.Micro(Math.min(u+.05*h,e.max)),{min:d,max:u,range:t.Timing.Micro(u-d)})}}),S=Object.freeze({__proto__:null,forNewRecording:async function(t,n,i,r){try{if(t)return{dataOrigin:"CPUProfile"};const s=e.CPUThrottlingManager.CPUThrottlingManager.instance().hasPrimaryPageTargetSet()?await Promise.race([e.CPUThrottlingManager.CPUThrottlingManager.instance().getHardwareConcurrency(),new Promise(e=>{setTimeout(()=>e(void 0),1e3)})]):void 0,a=e.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate(),o=e.NetworkManager.MultitargetNetworkManager.instance().isThrottling()?e.NetworkManager.MultitargetNetworkManager.instance().networkConditions():void 0;let l,c;return o&&(l={download:o.download,upload:o.upload,latency:o.latency,packetLoss:o.packetLoss,packetQueueLength:o.packetQueueLength,packetReordering:o.packetReordering,targetLatency:o.targetLatency},c="function"==typeof o.title?o.title():o.title),{source:"DevTools",startTime:n?new Date(n).toJSON():void 0,emulatedDeviceTitle:i,cpuThrottling:1!==a?a:void 0,networkThrottling:c,networkThrottlingConditions:l,hardwareConcurrency:s,dataOrigin:"TraceEvents",cruxFieldData:r}}catch{return{}}}});function I(e){const t=(e=e.replace(/\?$/,"")).lastIndexOf("node_modules");return-1!==t&&(e=e.substring(t)),e}function k(e){for(const[t,n]of e){if(n.duplicates.sort((e,t)=>t.attributedSize-e.attributedSize),n.duplicates.length>1){const e=n.duplicates[0].attributedSize;n.duplicates=n.duplicates.filter(t=>t.attributedSize/e>=.1)}n.duplicates=n.duplicates.filter(e=>e.attributedSize>=512),n.duplicates.length<=1?e.delete(t):n.estimatedDuplicateBytes=n.duplicates.slice(1).reduce((e,t)=>e+t.attributedSize,0)}}function C(e,t,n=0){const i=e.indexOf(t,n);return-1===i?e.length:i}function M(e){const t=e.split("node_modules/"),n=C(e=t[t.length-1],"/");return"@"===e[0]?e.slice(0,C(e,"/",n+1)):e.slice(0,n)}function y(e){return new Map([...e].sort((e,t)=>t[1].estimatedDuplicateBytes-e[1].estimatedDuplicateBytes))}var E=Object.freeze({__proto__:null,computeScriptDuplication:function(e){const t=new Map;for(const r of e.scripts){if(!r.content||!r.sourceMap)continue;const e=i.ModelHandlers.Scripts.getScriptGeneratedSizes(r);if(!e)continue;if("errorMessage"in e){console.error(e.errorMessage);continue}const s=[];t.set(r,s);const a=r.sourceMap.sourceURLs();for(let t=0;t<a.length;t++){if((n=a[t]).includes("webpack/bootstrap")||n.includes("(webpack)/buildin")||n.includes("external "))continue;const i=e.files[a[t]];s.push({source:I(a[t]),resourceSize:i})}}var n;const r=new Map;for(const[e,n]of t)for(const t of n){let n=r.get(t.source);n||(n={estimatedDuplicateBytes:0,duplicates:[]},r.set(t.source,n)),n.duplicates.push({script:e,attributedSize:t.resourceSize})}const s=function(e){const t=new Map;for(const[n,i]of e){if(!n.includes("node_modules")){t.set(n,i);continue}const e="node_modules/"+M(n),r=t.get(e)??{duplicates:[],estimatedDuplicateBytes:0};t.set(e,r);for(const{script:e,attributedSize:t}of i.duplicates){let n=r.duplicates.find(t=>t.script===e);n||(n={script:e,attributedSize:0},r.duplicates.push(n)),n.attributedSize+=t}}return t}(r);return k(r),k(s),{duplication:y(r),duplicationGroupedByNodeModules:y(s)}},getNodeModuleName:M,normalizeDuplication:k,normalizeSource:I});const w=new Map;function b(e,n){let i=w.get(n);i||(i=new Map,w.set(n,i));const r=i.get(e);if(r)return r;let s=null;if(t.Events.isProfileCall(e))s=function(e,n){const i=n.Renderer.entryToNode.size>0?n.Renderer.entryToNode:n.Samples.entryToNode,r={callFrames:[]};let s=r,a=e,o=i.get(e);const l=w.get(n)||new Map;for(w.set(n,l);o;){if(!t.Events.isProfileCall(o.entry)){o=o.parent;continue}a=o.entry;const e=l.get(o.entry);if(e){s.callFrames.push(...e.callFrames.filter(e=>!F(e))),s.parent=e.parent,s.description=s.description||e.description;break}F(a.callFrame)||s.callFrames.push(a.callFrame);const r=n.AsyncJSCalls.asyncCallToScheduler.get(a),c=r&&i.get(r.scheduler);c?(s.parent={callFrames:[]},s=s.parent,s.description=r.taskName,o=c):o=o.parent}return r}(e,n);else if(t.Extensions.isSyntheticExtensionEntry(e))s=function(e,t){return P(e.rawSourceEvent,t)}(e,n);else if(t.Events.isUserTiming(e))s=P(e,n);else if(t.Events.isLayout(e)||t.Events.isUpdateLayoutTree(e)){const t=n.Renderer.entryToNode.get(e),i=t?.parent?.entry;i&&(s=b(i,n))}return s&&i.set(e,s),s}function P(e,n){let i=e;if(t.Events.isPerformanceMeasureBegin(e)){if(void 0===e.args.traceId)return null;i=n.UserTimings.measureTraceByTraceId.get(e.args.traceId)}if(!i)return null;let r=n.Renderer.entryToNode.get(i);for(;r&&!t.Events.isProfileCall(r.entry);)r=r.parent;return r&&t.Events.isProfileCall(r.entry)?b(r.entry,n):null}function F({columnNumber:e,lineNumber:t,url:n,scriptId:i}){return-1===t&&-1===e&&""===n&&"0"===i}var N=Object.freeze({__proto__:null,clearCacheForTrace:function(e){w.delete(e)},get:b,stackTraceForEventInTrace:w});let R=class{};class D extends R{visibleTypes;constructor(e){super(),this.visibleTypes=new Set(e)}accept(e){return!!t.Extensions.isSyntheticExtensionEntry(e)||this.visibleTypes.has(D.eventType(e))}static eventType(e){return e.cat.includes("blink.console")?"ConsoleTime":e.cat.includes("blink.user_timing")?"UserTiming":e.name}}class _ extends R{#e;constructor(e){super(),this.#e=new Set(e)}accept(e){return!this.#e.has(e.name)}}var z=Object.freeze({__proto__:null,ExclusiveNameFilter:_,InvisibleEventsFilter:class extends R{#t;constructor(e){super(),this.#t=new Set(e)}accept(e){return!this.#t.has(D.eventType(e))}},TraceFilter:R,VisibleEventsFilter:D});function x(e,n){const i=e.ts,r=n.ts;if(i<r)return-1;if(i>r)return 1;const s=i+(e.dur??0),a=r+(n.dur??0);return s>a?-1:s<a?1:t.Events.isProfileCall(e)&&!t.Events.isProfileCall(n)?-1:t.Events.isProfileCall(n)&&!t.Events.isProfileCall(e)?1:0}function G(e,n,i,r,s,a){return{cat:"",name:"ProfileCall",nodeId:e.id,args:{},ph:"X",pid:s,tid:a,ts:r,dur:t.Timing.Micro(0),callFrame:e.callFrame,sampleIndex:i,profileId:n}}function J(e){return e.args?"beginData"in e.args?e.args.beginData.sampleTraceId??null:e.args?.sampleTraceId??e.args?.data?.sampleTraceId??null:null}new Map,new Set(["AbortPostTaskCallback","Animation","AsyncTask","v8.deserializeOnBackground","BeginFrame","BeginMainThreadFrame","v8.produceModuleCache","v8.produceCache","CancelAnimationFrame","CancelIdleCallback","v8.compile","V8.CompileCode","V8.CompileModule","Commit","CompositeLayers","ComputeIntersections","ConsoleTime","TimeStamp","CppGC.IncrementalSweep","DoDecrypt","DoDecryptReply","DoDigest","DoDigestReply","DoEncrypt","DoEncryptReply","DoSign","DoSignReply","DoVerify","DoVerifyReply","Decode Image","DrawFrame","EmbedderCallback","v8.evaluateModule","EvaluateScript","EventDispatch","EventTiming","V8.FinalizeDeserialization","FireAnimationFrame","FireIdleCallback","FrameStartedLoading","FunctionCall","GCEvent","BlinkGC.AtomicPhase","GPUTask","HandlePostMessage","HitTest","InvalidateLayout","JSSample","Layerize","Layout","LayoutShift","MajorGC","MarkDOMContent","firstPaint","firstContentfulPaint","largestContentfulPaint::Candidate","MarkLoad","MinorGC","V8.OptimizeCode","Paint","PaintImage","PaintSetup","ParseAuthorStyleSheet","ParseHTML","PrePaint","ProfileCall","Program","RasterTask","RequestAnimationFrame","RequestIdleCallback","RequestMainThreadFrame","ResourceFinish","ResourceReceivedData","ResourceReceiveResponse","ResourceSendRequest","ResourceWillSendRequest","RunMicrotasks","RunPostTaskCallback","RunTask","SchedulePostMessage","SchedulePostTaskCallback","ScheduleStyleRecalculation","ScrollLayer","CpuProfiler::StartProfiling","v8.parseOnBackground","v8.parseOnBackgroundParsing","v8.parseOnBackgroundWaiting","SyntheticLayoutShift","SyntheticLayoutShiftCluster","TimerFire","TimerInstall","TimerRemove","UpdateLayer","UpdateLayerTree","UpdateLayoutTree","UserTiming","V8Console::runTask","v8.wasm.cachedModule","v8.wasm.compiledModule","v8.wasm.moduleCacheHit","v8.wasm.moduleCacheInvalid","v8.wasm.streamFromResponseCallback","WebSocketCreate","WebSocketDestroy","WebSocketReceive","WebSocketReceiveHandshakeResponse","WebSocketSend","WebSocketSendHandshakeRequest","XHRLoad","XHRReadyStateChange"]);const L=e=>t.Timing.Micro(1e3*e);class B{#n=[];#i=[];#r;#s;#a=[];#o=!1;#l;#c=new Map;#d;#u;jsSampleEvents=[];constructor(e,n,i,r,s){this.#l=e,this.#s=r,this.#r=i,this.#d=s||t.Configuration.defaults(),this.#u=n}buildProfileCalls(e){const n=function(e,t){const n=[];let i=0,r=0;for(;i<e.length&&r<t.length;){const s=e[i],a=t[r],o=x(s,a);o<=0&&(n.push(s),i++),1===o&&(n.push(a),r++)}for(;i<e.length;)n.push(e[i++]);for(;r<t.length;)n.push(t[r++]);return n}(e,this.callsFromProfileSamples()),i=[];for(let e=0;e<n.length;e++){const r=n[e];if("I"===r.ph&&!J(r))continue;if(0===i.length){if(t.Events.isProfileCall(r)){this.#h(r);continue}i.push(r),this.#p(r);continue}const s=i.at(-1);void 0!==s&&(r.ts>=s.ts+(s.dur||0)?(this.#m(s),i.pop(),e--):t.Events.isProfileCall(r)?this.#h(r,s):(this.#p(r),i.push(r)))}for(;i.length;){const e=i.pop();e&&this.#m(e)}return this.jsSampleEvents.sort(x),this.#n}#p(e){"RunMicrotasks"!==e.name&&"RunTask"!==e.name||(this.#a=[],this.#g(0,e.ts),this.#o=!1),this.#o&&(this.#g(this.#a.pop()||0,e.ts),this.#o=!1),this.#f(e),this.#a.push(this.#i.length)}#h(e,n){if(n&&t.Events.isJSInvocationEvent(n)||this.#o)this.#f(e);else if(t.Events.isProfileCall(e)&&0===this.#i.length){this.#o=!0;const t=this.#i.length;this.#f(e),this.#a.push(t)}}#m(e){const n=t.Timing.Micro(e.ts+(e.dur??0));this.#g(this.#a.pop()||0,n)}callsFromProfileSamples(){const e=this.#l.samples,n=this.#l.timestamps;if(!e)return[];const i=[];let r;for(let s=0;s<e.length;s++){const e=this.#l.nodeByIndex(s),a=L(t.Timing.Milli(n[s]));if(!e)continue;const o=G(e,this.#u,s,a,this.#r,this.#s);if(i.push(o),this.#d.debugMode){const e=this.#l.traceIds?.[s];this.jsSampleEvents.push(this.#v(o,a,e))}e.id===this.#l.gcNode?.id&&r?this.#c.set(o,r):r=e}return i}#T(e,t){let n=this.#l.nodeById(e.nodeId);const i=n?.id===this.#l.gcNode?.id;if(i&&(n=this.#c.get(e)||null),!n)return[];const r=new Array(n.depth+1+Number(i));let s=r.length-1;for(i&&(r[s--]=e);n;)r[s--]=G(n,e.profileId,e.sampleIndex,t??e.ts,this.#r,this.#s),n=n.parent;return r}#M(e,t){const n=this.#l.traceIds?.[e],i=n&&this.#l.nodeById(n),r=i&&G(i,this.#u,-1,t,this.#r,this.#s);return r?(this.#d.debugMode&&this.jsSampleEvents.push(this.#v(r,t,e)),this.#T(r)):null}#f(e){let n=this.#i;t.Events.isProfileCall(e)&&(n=this.#T(e));const i=J(e),r=i&&this.#M(i,e.ts);r&&(n=r),B.filterStackFrames(n,this.#d);const s=e.ts+(e.dur||0),a=Math.min(n.length,this.#i.length);let o;for(o=this.#a.at(-1)||0;o<a;++o){const e=n[o].callFrame,i=this.#i[o].callFrame;if(!B.framesAreEqual(e,i))break;this.#i[o].dur=t.Timing.Micro(Math.max(this.#i[o].dur||0,s-this.#i[o].ts))}for(this.#g(o,e.ts);o<n.length;++o){const e=n[o];e.nodeId!==this.#l.programNode?.id&&e.nodeId!==this.#l.root?.id&&e.nodeId!==this.#l.idleNode?.id&&e.nodeId!==this.#l.gcNode?.id&&(this.#i.push(e),this.#n.push(e))}}#g(e,n){if(this.#a.length){const t=this.#a.at(-1);t&&e<t&&(console.error(`Child stack is shallower (${e}) than the parent stack (${t}) at ${n}`),e=t)}this.#i.length<e&&(console.error(`Trying to truncate higher than the current stack size at ${n}`),e=this.#i.length);for(let e=0;e<this.#i.length;++e)this.#i[e].dur=t.Timing.Micro(Math.max(n-this.#i[e].ts,0));this.#i.length=e}#v(e,n,i){return{name:"JSSample",cat:"devtools.timeline",args:{data:{traceId:i,stackTrace:this.#T(e).map(e=>e.callFrame)}},ph:"I",ts:n,dur:t.Timing.Micro(0),pid:this.#r,tid:this.#s}}static framesAreEqual(e,t){return e.scriptId===t.scriptId&&e.functionName===t.functionName&&e.lineNumber===t.lineNumber}static showNativeName(e,t){return t&&Boolean(B.nativeGroup(e))}static nativeGroup(e){return e.startsWith("Parse")?"Parse":e.startsWith("Compile")||e.startsWith("Recompile")?"Compile":null}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static filterStackFrames(e,t){if(t.showAllEvents)return;let n=null,i=0;for(let r=0;r<e.length;++r){const s=e[r].callFrame,a=B.isNativeRuntimeFrame(s);if(a&&!B.showNativeName(s.functionName,t.includeRuntimeCallStats))continue;const o=a?B.nativeGroup(s.functionName):null;n&&n===o||(n=o,e[i++]=e[r])}e.length=i}static createFakeTraceFromCpuProfile(e,n){const i=[],r=`Thread ${n}`;return s("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),s("thread_name",{name:r},0,0,"M","__metadata"),e?(s("JSRoot",{},e.startTime,e.endTime-e.startTime,"X","toplevel"),s("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"X"),{traceEvents:i,metadata:{dataOrigin:"CPUProfile"}}):{traceEvents:i,metadata:{}};function s(e,r,s,a,o,l){const c={cat:l||"disabled-by-default-devtools.timeline",name:e,ph:o||"X",pid:t.Events.ProcessID(1),tid:n,ts:t.Timing.Micro(s),args:r};return a&&(c.dur=t.Timing.Micro(a)),i.push(c),c}}}class A{totalTime;selfTime;transferSize;id;event;events;parent;groupId;isGroupNodeInternal;depth;constructor(e,t){this.totalTime=0,this.selfTime=0,this.transferSize=0,this.id=e,this.event=t,this.events=[t],this.groupId="",this.isGroupNodeInternal=!1,this.depth=0}isGroupNode(){return this.isGroupNodeInternal}hasChildren(){throw new Error("Not implemented")}setHasChildren(e){throw new Error("Not implemented")}children(){throw new Error("Not implemented")}searchTree(e,t){t=t||[],this.event&&e(this.event)&&t.push(this);for(const n of this.children().values())n.searchTree(e,t);return t}}class O extends A{root;hasChildrenInternal;childrenInternal;parent;constructor(e,t,n){super(e,t),this.root=n?.root??null,this.hasChildrenInternal=!1,this.childrenInternal=null,this.parent=n}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){return this.childrenInternal||this.buildChildren()}buildChildren(){const e=[];for(let t=this;t.parent&&!t.isGroupNode();t=t.parent)e.push(t);e.reverse();const n=new Map,i=this,s=this.root;if(!s)return this.childrenInternal=n,this.childrenInternal;const a=s.startTime,o=s.endTime,l=s.doNotAggregate||s.includeInstantEvents?function(t){++u,h===e.length&&u<=e.length+2&&m(t,0),--u}:void 0,c=s.doNotAggregate?void 0:$,d=s.getEventGroupIdCallback();let u=0,h=0,p=null;function m(r,s){if(u===e.length+2){if(!p)return;return p.setHasChildren(!0),void(p.selfTime-=s)}let a,o="";c?(a=c(r),o=d?d(r):"",o&&(a+="/"+o)):a=Symbol("uniqueId");let l=n.get(a);l?l.events.push(r):(l=new O(a,r,i),l.groupId=o,n.set(a,l)),l.selfTime+=s,l.totalTime+=s,t.Events.isReceivedDataEvent(r)&&(l.transferSize+=r.args.data.encodedDataLength),p=l}return r.Trace.forEachEvent(s.events,{onStartEvent:function(t){const{startTime:n,endTime:i}=r.Timing.eventTimingsMilliSeconds(t);if(++u,u>e.length+2)return;if(!function(t){const{endTime:n}=r.Timing.eventTimingsMilliSeconds(t);if(h===e.length)return!0;if(h!==u-1)return!1;if(!n)return!1;if(!c)return t===e[h].event&&++h,!1;let i=c(t);const s=d?d(t):"";return s&&(i+="/"+s),i===e[h].id&&++h,!1}(t))return;const s=(void 0!==i?Math.min(i,o):o)-Math.max(a,n);s<0&&console.error("Negative event duration"),m(t,s)},onEndEvent:function(){--u,h>u&&(h=u)},onInstantEvent:l,startTime:r.Timing.milliToMicro(a),endTime:r.Timing.milliToMicro(o),eventFilter:s.filter,ignoreAsyncEvents:!1}),this.childrenInternal=n,n}getRoot(){return this.root}}class U extends A{childrenInternal;textFilter;filter;startTime;endTime;totalTime;eventGroupIdCallback;calculateTransferSize;forceGroupIdCallback;constructor(e,{textFilter:t,filters:n,startTime:i,endTime:r,eventGroupIdCallback:s,calculateTransferSize:a,forceGroupIdCallback:o}){super("",e[0]),this.childrenInternal=null,this.events=e,this.textFilter=t,this.filter=e=>n.every(t=>t.accept(e)),this.startTime=i,this.endTime=r,this.eventGroupIdCallback=s,this.totalTime=r-i,this.calculateTransferSize=a,this.forceGroupIdCallback=o}hasChildren(){return!0}filterChildren(e){for(const[t,n]of e)n.event&&n.depth<=1&&!this.textFilter.accept(n.event)&&e.delete(t);return e}children(){return this.childrenInternal||(this.childrenInternal=this.filterChildren(this.grouppedTopNodes())),this.childrenInternal}ungrouppedTopNodes(){const e=this,n=this.startTime,i=this.endTime,s=new Map,a=[i-n],o=[],l=new Map,c=this.eventGroupIdCallback,d=this.forceGroupIdCallback;r.Trace.forEachEvent(this.events,{onStartEvent:function(e){const{startTime:t,endTime:s}=r.Timing.eventTimingsMilliSeconds(e),u=(void 0!==s?Math.min(s,i):i)-Math.max(t,n);a[a.length-1]-=u,a.push(u);let h=$(e);d&&c&&(h=`${h}-${c(e)}`);const p=!l.has(h);p&&l.set(h,u),o.push(p)},onEndEvent:function(t){let n=$(t);d&&c&&(n=`${n}-${c(t)}`);let i=s.get(n);i?i.events.push(t):(i=new W(e,n,t,!1,e),s.set(n,i)),i.selfTime+=a.pop()||0,o.pop()&&(i.totalTime+=l.get(n)||0,l.delete(n)),o.length&&i.setHasChildren(!0)},onInstantEvent:this.calculateTransferSize?n=>{if(t.Events.isReceivedDataEvent(n)){let t=$(n);this.forceGroupIdCallback&&this.eventGroupIdCallback&&(t=`${t}-${this.eventGroupIdCallback(n)}`);let i=s.get(t);i?i.events.push(n):(i=new W(e,t,n,!1,e),s.set(t,i)),"ResourceReceivedData"===n.name?i.transferSize+=n.args.data.encodedDataLength:n.args.data.encodedDataLength>0&&(i.transferSize=n.args.data.encodedDataLength)}}:void 0,startTime:r.Timing.milliToMicro(this.startTime),endTime:r.Timing.milliToMicro(this.endTime),eventFilter:this.filter,ignoreAsyncEvents:!1}),this.selfTime=a.pop()||0;for(const e of s)e[1].selfTime<=0&&(!this.calculateTransferSize||e[1].transferSize<=0)&&s.delete(e[0]);return s}grouppedTopNodes(){const e=this.ungrouppedTopNodes();if(!this.eventGroupIdCallback)return e;const t=new Map;for(const n of e.values()){const e=this.eventGroupIdCallback(n.event);let i=t.get(e);i?i.events.push(...n.events):(i=new j(e,this,n.events),t.set(e,i)),i.addChild(n,n.selfTime,n.selfTime,n.transferSize)}return t}}class j extends A{childrenInternal;isGroupNodeInternal;events;constructor(e,t,n){super(e,n[0]),this.events=n,this.childrenInternal=new Map,this.parent=t,this.isGroupNodeInternal=!0}addChild(e,t,n,i){this.childrenInternal.set(e.id,e),this.selfTime+=t,this.totalTime+=n,this.transferSize+=i,e.parent=this}hasChildren(){return!0}children(){return this.childrenInternal}}class W extends A{parent;root;depth;cachedChildren;hasChildrenInternal;constructor(e,t,n,i,r){super(t,n),this.parent=r,this.root=e,this.depth=(r.depth||0)+1,this.cachedChildren=null,this.hasChildrenInternal=i}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){if(this.cachedChildren)return this.cachedChildren;const e=[0],t=[],n=[],i=new Map,s=this.root.startTime,a=this.root.endTime;let o=s;const l=this;return r.Trace.forEachEvent(this.root.events,{onStartEvent:function(i){const{startTime:o,endTime:l}=r.Timing.eventTimingsMilliSeconds(i),c=(void 0!==l?Math.min(l,a):a)-Math.max(o,s);c<0&&console.assert(!1,"Negative duration of an event"),e[e.length-1]-=c,e.push(c);const d=$(i);t.push(d),n.push(i)},onEndEvent:function(s){const{startTime:c,endTime:d}=r.Timing.eventTimingsMilliSeconds(s),u=e.pop(),h=t.pop();let p;for(n.pop(),p=l;p.depth>1;p=p.parent)if(p.id!==t[t.length+1-p.depth])return;if(p.id!==h||t.length<l.depth)return;const m=t[t.length-l.depth];if(p=i.get(m),p)p.events.push(s);else{const e=n[n.length-l.depth],t=n.length>l.depth;p=new W(l.root,m,e,t,l),i.set(m,p)}const g=void 0!==d?Math.min(d,a):a,f=g-Math.max(c,o);p.selfTime+=u||0,p.totalTime+=f,o=g},startTime:r.Timing.milliToMicro(s),endTime:r.Timing.milliToMicro(a),eventFilter:this.root.filter,ignoreAsyncEvents:!1}),this.cachedChildren=this.root.filterChildren(i),this.cachedChildren}searchTree(e,t){return t=t||[],this.event&&e(this.event)&&t.push(this),t}}function $(e){return t.Events.isProfileCall(e)?`f:${B.isNativeRuntimeFrame(e.callFrame)?B.nativeGroup(e.callFrame.functionName):e.callFrame.functionName}@${e.callFrame.scriptId||e.callFrame.url||""}`:t.Events.isConsoleTimeStamp(e)&&e.args.data?`${e.name}:${e.args.data.name}`:t.Events.isSyntheticNetworkRequest(e)||t.Events.isReceivedDataEvent(e)?`req:${e.args.data.requestId}`:e.name}var H=Object.freeze({__proto__:null,BottomUpNode:W,BottomUpRootNode:U,GroupNode:j,Node:A,TopDownNode:O,TopDownRootNode:class extends O{filter;startTime;endTime;eventGroupIdCallback;doNotAggregate;includeInstantEvents;totalTime;selfTime;constructor(e,{filters:t,startTime:n,endTime:i,doNotAggregate:r,eventGroupIdCallback:s,includeInstantEvents:a}){super("",e[0],null),this.event=e[0],this.root=this,this.events=e,this.filter=e=>t.every(t=>t.accept(e)),this.startTime=n,this.endTime=i,this.eventGroupIdCallback=s,this.doNotAggregate=r,this.includeInstantEvents=a,this.totalTime=i-n,this.selfTime=this.totalTime}children(){return this.childrenInternal||this.grouppedTopNodes()}grouppedTopNodes(){const e=super.children();for(const t of e.values())this.selfTime-=t.totalTime;if(!this.eventGroupIdCallback)return e;const t=new Map;for(const n of e.values()){const e=this.eventGroupIdCallback(n.event);let i=t.get(e);i?i.events.push(...n.events):(i=new j(e,this,n.events),t.set(e,i)),i.addChild(n,n.selfTime,n.totalTime,n.transferSize)}return this.childrenInternal=t,t}getEventGroupIdCallback(){return this.eventGroupIdCallback}},eventStackFrame:function(e){if(t.Events.isProfileCall(e))return e.callFrame;const n=e.args?.data?.stackTrace?.[0];return n?{...n,scriptId:String(n.scriptId)}:null},generateEventID:$}),q=Object.freeze({__proto__:null,summarizeThirdParties:function(e,n){const i=function(e,t,n){const i=t.Renderer.entityMappings,s=r.Trace.VISIBLE_TRACE_EVENT_TYPES.values().toArray(),a=new D(s.concat(["SyntheticNetworkRequest"])),o=r.Timing.microToMilli(n.min),l=r.Timing.microToMilli(n.max),c=new U(e,{textFilter:new _([]),filters:[a],startTime:o,endTime:l,eventGroupIdCallback:e=>{const t=i?.entityByEvent.get(e);return t?.name??""},calculateTransferSize:!0,forceGroupIdCallback:!0});return c}(function(e){const t=e.Renderer.processes.values().find(e=>{const t=e.url??"";return e.isOnMainFrame&&!t.startsWith("about:")&&!t.startsWith("chrome:")})?.threads.values().find(e=>"CrRendererMain"===e.name);return t?t.entries:[]}(e).sort(r.Trace.eventTimeComparator),e,n);return function(e,n){const i=new Map,r=[],s=[...e.children().values()].flat();for(const e of s){if(""===e.id)continue;const s=n.Renderer.entityMappings.entityByEvent.get(e.event);if(!s)continue;const a={transferSize:e.transferSize,mainThreadTime:t.Timing.Milli(e.selfTime),relatedEvents:n.Renderer.entityMappings.eventsByEntity.get(s)??[],entity:s};i.set(s,a),r.push(a)}return r}(i,e)}});export{m as FetchNodes,g as FilmStrip,T as MainThreadActivity,S as Metadata,E as ScriptDuplication,N as StackTraceForEvent,q as ThirdParties,z as TraceFilter,H as TraceTree};