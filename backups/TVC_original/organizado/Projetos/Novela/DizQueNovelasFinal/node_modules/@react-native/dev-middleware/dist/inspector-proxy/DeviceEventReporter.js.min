"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ttlcache=_interopRequireDefault(require("@isaacs/ttlcache"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}class DeviceEventReporter{#e;#t=new _ttlcache.default({ttl:1e4,dispose:(e,t,a)=>{"delete"!==a&&"set"!==a&&this.#a(e)}});#r;#d;constructor(e,t){this.#e=e,this.#r=t,this.#d=Date.now()}logRequest(e,t,a){this.#t.set(e.id,{method:e.method,requestOrigin:t,requestTime:Date.now(),metadata:a})}logResponse(e,t,a){const r=this.#t.get(e.id);if(!r)return void this.#e.logEvent({type:"debugger_command",protocol:"CDP",requestOrigin:null,method:null,status:"coded_error",errorCode:"UNMATCHED_REQUEST_ID",responseOrigin:"proxy",timeSinceStart:null,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:a.pageId,frontendUserAgent:a.frontendUserAgent,prefersFuseboxFrontend:a.prefersFuseboxFrontend,connectionUptime:this.#d-Date.now()});const d=Date.now()-r.requestTime;if(this.#t.delete(e.id),e.error){let{message:n}=e.error;return"data"in e.error&&(n+=` (${String(e.error.data)})`),void this.#e.logEvent({type:"debugger_command",requestOrigin:r.requestOrigin,method:r.method,protocol:"CDP",status:"coded_error",errorCode:"PROTOCOL_ERROR",errorDetails:n,responseOrigin:t,timeSinceStart:d,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:r.metadata.pageId,frontendUserAgent:r.metadata.frontendUserAgent,prefersFuseboxFrontend:a.prefersFuseboxFrontend,connectionUptime:this.#d-Date.now()})}this.#e.logEvent({type:"debugger_command",protocol:"CDP",requestOrigin:r.requestOrigin,method:r.method,status:"success",responseOrigin:t,timeSinceStart:d,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:r.metadata.pageId,frontendUserAgent:r.metadata.frontendUserAgent,prefersFuseboxFrontend:a.prefersFuseboxFrontend,connectionUptime:this.#d-Date.now()})}logProfilingTargetRegistered(){this.#e.logEvent({type:"profiling_target_registered",status:"success",appId:this.#r.appId,deviceName:this.#r.deviceName,deviceId:this.#r.deviceId,pageId:null})}logConnection(e,t){this.#e.logEvent({type:"connect_debugger_frontend",status:"success",appId:this.#r.appId,deviceName:this.#r.deviceName,deviceId:this.#r.deviceId,pageId:t.pageId,frontendUserAgent:t.frontendUserAgent})}logDisconnection(e){if(!this.#e)return;const t="device"===e?"DEVICE_DISCONNECTED":"DEBUGGER_DISCONNECTED";for(const e of this.#t.values())this.#e.logEvent({type:"debugger_command",protocol:"CDP",requestOrigin:e.requestOrigin,method:e.method,status:"coded_error",errorCode:t,responseOrigin:"proxy",timeSinceStart:Date.now()-e.requestTime,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:e.metadata.pageId,frontendUserAgent:e.metadata.frontendUserAgent,prefersFuseboxFrontend:e.metadata.prefersFuseboxFrontend,connectionUptime:this.#d-Date.now()});this.#t.clear()}logProxyMessageHandlingError(e,t,a){this.#e.logEvent({type:"proxy_error",status:"error",messageOrigin:e,message:a,error:t.message,errorStack:t.stack,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:null,connectionUptime:this.#d-Date.now()})}logFuseboxConsoleNotice(){this.#e.logEvent({type:"fusebox_console_notice"})}#a(e){this.#e.logEvent({type:"debugger_command",protocol:"CDP",requestOrigin:e.requestOrigin,method:e.method,status:"coded_error",errorCode:"TIMED_OUT",responseOrigin:"proxy",timeSinceStart:Date.now()-e.requestTime,appId:this.#r.appId,deviceId:this.#r.deviceId,deviceName:this.#r.deviceName,pageId:e.metadata.pageId,frontendUserAgent:e.metadata.frontendUserAgent,prefersFuseboxFrontend:e.metadata.prefersFuseboxFrontend,connectionUptime:this.#d-Date.now()})}}var _default=exports.default=DeviceEventReporter;