import*as e from"../../core/common/common.js";import*as t from"../../core/host/host.js";import*as n from"../../core/platform/platform.js";import*as r from"../../core/i18n/i18n.js";import*as o from"../text_utils/text_utils.js";let s;class i extends e.ObjectWrapper.ObjectWrapper{saveCallbacks;constructor(){super(),this.saveCallbacks=new Map,t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.SavedURL,this.savedURL,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.CanceledSaveURL,this.canceledSavedURL,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.AppendedToURL,this.appendedToURL,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return s&&!t||(s=new i),s}save(e,n,s,r){const o=new Promise(t=>this.saveCallbacks.set(e,t));return t.InspectorFrontendHost.InspectorFrontendHostInstance.save(e,n,s,r),o}savedURL(e){const{url:t,fileSystemPath:n}=e.data,s=this.saveCallbacks.get(t);this.saveCallbacks.delete(t),s&&s({fileSystemPath:n})}canceledSavedURL({data:e}){const t=this.saveCallbacks.get(e);this.saveCallbacks.delete(e),t&&t(null)}append(e,n){t.InspectorFrontendHost.InspectorFrontendHostInstance.append(e,n)}close(e){t.InspectorFrontendHost.InspectorFrontendHostInstance.close(e)}appendedToURL({data:e}){this.dispatchEventToListeners("AppendedToURL",e)}}var a=Object.freeze({__proto__:null,FileManager:i});class c{#e;#t;#n;#s;#r;constructor(e,t,n){this.#e=e,this.#t=t,this.#n=n;const{queries:s,fileRegexQueries:r}=c.#o(e,t,n);this.#s=s,this.#r=r}static fromPlainObject(e){return new c(e.query,e.ignoreCase,e.isRegex)}filePathMatchesFileQuery(e){return this.#r.every(({regex:t,shouldMatch:n})=>Boolean(e.match(t))===n)}queries(){return this.#s}query(){return this.#e}ignoreCase(){return this.#t}isRegex(){return this.#n}toPlainObject(){return{query:this.query(),ignoreCase:this.ignoreCase(),isRegex:this.isRegex()}}static#o(e,t,n){const s=/(\s*(?!-?f(ile)?:)[^\\ ]|\\.)+/,r=s.source+"(\\s+"+s.source+")*",o=["(\\s*"+u.source+"\\s*)","("+/"([^\\"]|\\.)+"/.source+")","("+r+")"].join("|"),i=new RegExp(o,"g"),a=e.match(i)||[],h=[],l=[];for(const e of a){if(!e)continue;const s=c.#i(e);if(s){const e=new RegExp(s.text,t?"i":"");l.push({regex:e,shouldMatch:s.shouldMatch})}else n?h.push(e):e.startsWith('"')&&e.endsWith('"')?h.push(c.#a(e)):h.push(c.#c(e))}return{queries:h,fileRegexQueries:l}}static#c(e){return e.replace(/\\(.)/g,"$1")}static#a(e){return e.substring(1,e.length-1).replace(/\\(.)/g,"$1")}static#i(e){const t=e.match(u);if(!t)return null;e=t[3];let s="";for(let t=0;t<e.length;++t){const r=e[t];"*"===r?s+=".*":"\\"===r?(++t," "===e[t]&&(s+=" ")):(-1!==n.StringUtilities.regexSpecialCharacters().indexOf(e.charAt(t))&&(s+="\\"),s+=e.charAt(t))}return{text:s,shouldMatch:!Boolean(t[1])}}}const u=/(-)?f(ile)?:((?:[^\\ ]|\\.)+)/;var h,l=Object.freeze({__proto__:null,SearchConfig:c});let d;!function(e){e.Debugger="debugger",e.Formatter="formatter",e.Inspector="inspector",e.Network="network",e.FileSystem="filesystem",e.ContentScripts="contentscripts",e.Service="service"}(h||(h={}));class p extends e.ObjectWrapper.ObjectWrapper{projectsInternal;hasResourceContentTrackingExtensionsInternal;constructor(){super(),this.projectsInternal=new Map,this.hasResourceContentTrackingExtensionsInternal=!1}static instance(e={forceNew:null}){const{forceNew:t}=e;return d&&!t||(d=new p),d}static removeInstance(){d=void 0}uiSourceCode(e,t){const n=this.projectsInternal.get(e);return n?n.uiSourceCodeForURL(t):null}uiSourceCodeForURL(e){for(const t of this.projectsInternal.values()){const n=t.uiSourceCodeForURL(e);if(n)return n}return null}findCompatibleUISourceCodes(e){const t=e.url(),n=e.contentType(),s=[];for(const r of this.projectsInternal.values()){if(e.project().type()!==r.type())continue;const o=r.uiSourceCodeForURL(t);o&&o.url()===t&&o.contentType()===n&&s.push(o)}return s}uiSourceCodesForProjectType(e){const t=[];for(const n of this.projectsInternal.values())if(n.type()===e)for(const e of n.uiSourceCodes())t.push(e);return t}addProject(e){console.assert(!this.projectsInternal.has(e.id()),`A project with id ${e.id()} already exists!`),this.projectsInternal.set(e.id(),e),this.dispatchEventToListeners(C.ProjectAdded,e)}removeProject(e){this.projectsInternal.delete(e.id()),this.dispatchEventToListeners(C.ProjectRemoved,e)}project(e){return this.projectsInternal.get(e)||null}projects(){return[...this.projectsInternal.values()]}projectsForType(e){return this.projects().filter(function(t){return t.type()===e})}uiSourceCodes(){const e=[];for(const t of this.projectsInternal.values())for(const n of t.uiSourceCodes())e.push(n);return e}setHasResourceContentTrackingExtensions(e){this.hasResourceContentTrackingExtensionsInternal=e}hasResourceContentTrackingExtensions(){return this.hasResourceContentTrackingExtensionsInternal}}var C;!function(e){e.UISourceCodeAdded="UISourceCodeAdded",e.UISourceCodeRemoved="UISourceCodeRemoved",e.UISourceCodeRenamed="UISourceCodeRenamed",e.WorkingCopyChanged="WorkingCopyChanged",e.WorkingCopyCommitted="WorkingCopyCommitted",e.WorkingCopyCommittedByUser="WorkingCopyCommittedByUser",e.ProjectAdded="ProjectAdded",e.ProjectRemoved="ProjectRemoved"}(C||(C={}));var m=Object.freeze({__proto__:null,get Events(){return C},ProjectStore:class{workspaceInternal;idInternal;typeInternal;displayNameInternal;#h;constructor(e,t,n,s){this.workspaceInternal=e,this.idInternal=t,this.typeInternal=n,this.displayNameInternal=s,this.#h=new Map}id(){return this.idInternal}type(){return this.typeInternal}displayName(){return this.displayNameInternal}workspace(){return this.workspaceInternal}createUISourceCode(e,t){return new I(this,e,t)}addUISourceCode(e){const t=e.url();return!this.uiSourceCodeForURL(t)&&(this.#h.set(t,e),this.workspaceInternal.dispatchEventToListeners(C.UISourceCodeAdded,e),!0)}removeUISourceCode(e){const t=this.#h.get(e);void 0!==t&&(this.#h.delete(e),this.workspaceInternal.dispatchEventToListeners(C.UISourceCodeRemoved,t))}removeProject(){this.workspaceInternal.removeProject(this),this.#h.clear()}uiSourceCodeForURL(e){return this.#h.get(e)??null}uiSourceCodes(){return this.#h.values()}renameUISourceCode(t,n){const s=t.url(),r=t.parentURL()?e.ParsedURL.ParsedURL.urlFromParentUrlAndName(t.parentURL(),n):e.ParsedURL.ParsedURL.preEncodeSpecialCharactersInPath(n);this.#h.set(r,t),this.#h.delete(s)}rename(e,t,n){}excludeFolder(e){}deleteFile(e){}deleteDirectoryRecursively(e){return Promise.resolve(!1)}remove(){}indexContent(e){}},WorkspaceImpl:p,get projectTypes(){return h}});const g={index:"(index)",thisFileWasChangedExternally:"This file was changed externally. Would you like to reload it?"},y=r.i18n.registerUIStrings("models/workspace/UISourceCode.ts",g),v=r.i18n.getLocalizedString.bind(void 0,y);class I extends e.ObjectWrapper.ObjectWrapper{#u;#l;#d;#p;#m;#C;#g=null;#y=new Map;#I=!1;#v=null;#k=null;#S=!1;#f=!1;#R=null;#T=null;#w=null;#U=!1;#L;#b=!1;#x=!1;#j=!1;constructor(t,s,r){super(),this.#d=t,this.#p=s;const o=e.ParsedURL.ParsedURL.fromString(s);o?(this.#u=o.securityOrigin(),this.#l=e.ParsedURL.ParsedURL.concatenate(this.#u,o.folderPathComponents),!o.queryParams||o.lastPathComponent&&r.isFromSourceMap()?this.#m=decodeURIComponent(o.lastPathComponent):this.#m=o.lastPathComponent+"?"+o.queryParams):(this.#u=n.DevToolsPath.EmptyUrlString,this.#l=n.DevToolsPath.EmptyUrlString,this.#m=s),this.#C=r}requestMetadata(){return this.#d.requestMetadata(this)}name(){return this.#m}mimeType(){return this.#d.mimeType(this)}url(){return this.#p}canonicalScriptId(){return`${this.#C.name()},${this.#p}`}parentURL(){return this.#l}origin(){return this.#u}fullDisplayName(){return this.#d.fullDisplayName(this)}displayName(e){if(!this.#m)return v(g.index);const t=this.#m;return e?t:n.StringUtilities.trimEndWithMaxLength(t,100)}canRename(){return this.#d.canRename()}rename(e){const{resolve:t,promise:n}=Promise.withResolvers();return this.#d.rename(this,e,function(e,n,s,r){e&&this.#P(n,s,r),t(e)}.bind(this)),n}remove(){this.#d.deleteFile(this)}#P(t,n,s){const r=this.#p;this.#m=t,this.#p=n||e.ParsedURL.ParsedURL.relativePathToUrlString(t,r),s&&(this.#C=s),this.dispatchEventToListeners(k.TitleChanged,this),this.project().workspace().dispatchEventToListeners(C.UISourceCodeRenamed,{oldURL:r,uiSourceCode:this})}contentURL(){return this.url()}contentType(){return this.#C}project(){return this.#d}requestContentData({cachedWasmOnly:e}={}){return this.#g?this.#g:this.#k?Promise.resolve(this.#k):e&&"application/wasm"===this.mimeType()?Promise.resolve(new o.WasmDisassembly.WasmDisassembly([],[],[])):(this.#g=this.#E(),this.#g)}async requestContent(e={}){return o.ContentData.ContentData.asDeferredContent(await this.requestContentData(e))}async#E(){if(this.#k)throw new Error("Called UISourceCode#requestContentImpl even though content is available for "+this.#p);try{this.#k=await this.#d.requestFileContent(this)}catch(e){this.#k={error:e?String(e):""}}return this.#k}#F(e){return e?e.isEncoded&&e.content?window.atob(e.content):e.content:null}#N(e){return!e||o.ContentData.ContentData.isError(e)?null:e.createdFromBase64?window.atob(e.base64):e.text}async checkContentUpdated(){if(!this.#k&&!this.#S)return;if(!this.#d.canSetFileContent()||this.#f)return;this.#f=!0;const t=o.ContentData.ContentData.asDeferredContent(await this.#d.requestFileContent(this));if(!("error"in t)){if(this.#f=!1,null===t.content){const e=this.workingCopy();return this.#D("",!1),void this.setWorkingCopy(e)}this.#R!==t.content&&(this.#N(this.#k)!==this.#F(t)?this.isDirty()&&this.#T!==t.content?(await e.Revealer.reveal(this),await new Promise(e=>window.setTimeout(e,0)),window.confirm(v(g.thisFileWasChangedExternally))?this.#D(t.content,!1):this.#R=t.content):this.#D(t.content,!1):this.#R=null)}}forceLoadOnCheckContent(){this.#S=!0}#W(e){this.#d.canSetFileContent()&&this.#d.setFileContent(this,e,!1),this.#D(e,!0)}#D(e,t){this.#R=null,this.#k=new o.ContentData.ContentData(e,Boolean(this.#L),this.mimeType()),this.#g=null,this.#I=!0,this.#M();const n={uiSourceCode:this,content:e,encoded:this.#L};this.dispatchEventToListeners(k.WorkingCopyCommitted,n),this.#d.workspace().dispatchEventToListeners(C.WorkingCopyCommitted,n),t&&this.#d.workspace().dispatchEventToListeners(C.WorkingCopyCommittedByUser,n)}addRevision(e){this.#W(e)}hasCommits(){return this.#I}workingCopy(){return this.workingCopyContent().content||""}workingCopyContent(){return this.workingCopyContentData().asDeferedContent()}workingCopyContentData(){this.#w&&(this.#T=this.#w(),this.#w=null);const e=this.#k?o.ContentData.ContentData.contentDataOrEmpty(this.#k):o.ContentData.EMPTY_TEXT_CONTENT_DATA;return null!==this.#T?new o.ContentData.ContentData(this.#T,!1,e.mimeType):e}resetWorkingCopy(){this.#M(),this.#A()}#M(){this.#T=null,this.#w=null,this.setContainsAiChanges(!1)}setWorkingCopy(e){this.#T=e,this.#w=null,this.#A()}setContainsAiChanges(e){this.#j=e}containsAiChanges(){return this.#j}setContent(e,t){this.#L=t,this.#d.canSetFileContent()&&this.#d.setFileContent(this,e,t),this.#D(e,!0)}setWorkingCopyGetter(e){this.#w=e,this.#A()}#A(){this.#q(),this.dispatchEventToListeners(k.WorkingCopyChanged,this),this.#d.workspace().dispatchEventToListeners(C.WorkingCopyChanged,{uiSourceCode:this})}removeWorkingCopyGetter(){this.#w&&(this.#T=this.#w(),this.#w=null)}commitWorkingCopy(){this.isDirty()&&this.#W(this.workingCopy())}isDirty(){return null!==this.#T||null!==this.#w}isKnownThirdParty(){return this.#b}markKnownThirdParty(){this.#b=!0}isUnconditionallyIgnoreListed(){return this.#x}isFetchXHR(){return[e.ResourceType.resourceTypes.XHR,e.ResourceType.resourceTypes.Fetch].includes(this.contentType())}markAsUnconditionallyIgnoreListed(){this.#x=!0}extension(){return e.ParsedURL.ParsedURL.extractExtension(this.#m)}content(){return!this.#k||"error"in this.#k?"":this.#k.text}loadError(){return this.#k&&"error"in this.#k&&this.#k.error||null}searchInContent(e,t,n){return!this.#k||"error"in this.#k?this.#d.searchInFileContent(this,e,t,n):Promise.resolve(o.TextUtils.performSearchInContentData(this.#k,e,t,n))}contentLoaded(){return Boolean(this.#k)}uiLocation(e,t){return new f(this,e,t)}messages(){return this.#v?new Set(this.#v):new Set}addLineMessage(e,t,n,s,r){const i=o.TextRange.TextRange.createFromLocation(n,s||0),a=new w(e,t,r,i);return this.addMessage(a),a}addMessage(e){this.#v||(this.#v=new Set),this.#v.add(e),this.dispatchEventToListeners(k.MessageAdded,e)}removeMessage(e){this.#v?.delete(e)&&this.dispatchEventToListeners(k.MessageRemoved,e)}#q(){if(this.#v){for(const e of this.#v)this.dispatchEventToListeners(k.MessageRemoved,e);this.#v=null}}setDecorationData(e,t){t!==this.#y.get(e)&&(this.#y.set(e,t),this.dispatchEventToListeners(k.DecorationChanged,e))}getDecorationData(e){return this.#y.get(e)}disableEdit(){this.#U=!0}editDisabled(){return this.#U}}var k;!function(e){e.WorkingCopyChanged="WorkingCopyChanged",e.WorkingCopyCommitted="WorkingCopyCommitted",e.TitleChanged="TitleChanged",e.MessageAdded="MessageAdded",e.MessageRemoved="MessageRemoved",e.DecorationChanged="DecorationChanged"}(k||(k={}));class f{uiSourceCode;lineNumber;columnNumber;constructor(e,t,n){this.uiSourceCode=e,this.lineNumber=t,this.columnNumber=n}linkText(e=!1,t=!1){const n=this.uiSourceCode.displayName(e),s=this.lineAndColumnText(t);let r=s?n+":"+s:n;return this.uiSourceCode.isDirty()&&(r="*"+r),r}lineAndColumnText(e=!1){let t;return"application/wasm"===this.uiSourceCode.mimeType()?"number"==typeof this.columnNumber&&(t=`0x${this.columnNumber.toString(16)}`):(t=`${this.lineNumber+1}`,e&&"number"==typeof this.columnNumber&&(t+=":"+(this.columnNumber+1))),t}id(){return"number"==typeof this.columnNumber?this.uiSourceCode.project().id()+":"+this.uiSourceCode.url()+":"+this.lineNumber+":"+this.columnNumber:this.lineId()}lineId(){return this.uiSourceCode.project().id()+":"+this.uiSourceCode.url()+":"+this.lineNumber}static comparator(e,t){return e.compareTo(t)}compareTo(e){return this.uiSourceCode.url()!==e.uiSourceCode.url()?this.uiSourceCode.url()>e.uiSourceCode.url()?1:-1:this.lineNumber!==e.lineNumber?this.lineNumber-e.lineNumber:this.columnNumber===e.columnNumber?0:"number"!=typeof this.columnNumber?-1:"number"!=typeof e.columnNumber?1:this.columnNumber-e.columnNumber}}class w{levelInternal;textInternal;range;clickHandlerInternal;constructor(e,t,n,s){this.levelInternal=e,this.textInternal=t,this.range=s??new o.TextRange.TextRange(0,0,0,0),this.clickHandlerInternal=n}level(){return this.levelInternal}text(){return this.textInternal}clickHandler(){return this.clickHandlerInternal}lineNumber(){return this.range.startLine}columnNumber(){return this.range.startColumn}isEqual(e){return this.text()===e.text()&&this.level()===e.level()&&this.range.equal(e.range)}}var S=Object.freeze({__proto__:null,get Events(){return k},Message:w,UILocation:f,UILocationRange:class{uiSourceCode;range;constructor(e,t){this.uiSourceCode=e,this.range=t}},UISourceCode:I,UISourceCodeMetadata:class{modificationTime;contentSize;constructor(e,t){this.modificationTime=e,this.contentSize=t}}});export{a as FileManager,l as SearchConfig,S as UISourceCode,m as Workspace};