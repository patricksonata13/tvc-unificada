import*as e from"../../core/common/common.js";import{assertNotNullOrUndefined as t}from"../../core/platform/platform.js";import*as o from"../../core/root/root.js";import*as i from"../../core/sdk/sdk.js";import*as r from"../bindings/bindings.js";import*as s from"../formatter/formatter.js";import*as n from"../source_map_scopes/source_map_scopes.js";import*as a from"../workspace/workspace.js";let u;class d extends e.ObjectWrapper.ObjectWrapper{storage=new h;#e;targetManager;debuggerWorkspaceBinding;#t=new Map;#i=new Map;#o=new Map;#r=[];constructor(e,t,o,r){super(),this.#e=t,this.targetManager=e,this.debuggerWorkspaceBinding=o,this.storage.mute(),this.#s(r??100),this.storage.unmute(),this.#e.addEventListener(a.Workspace.Events.UISourceCodeAdded,this.uiSourceCodeAdded,this),this.#e.addEventListener(a.Workspace.Events.UISourceCodeRemoved,this.uiSourceCodeRemoved,this),this.#e.addEventListener(a.Workspace.Events.ProjectRemoved,this.projectRemoved,this),this.targetManager.observeModels(i.DebuggerModel.DebuggerModel,this)}#s(e){let t=this.storage.breakpoints.size-e;for(const e of this.storage.breakpoints.values()){if(t>0){t--;continue}const i=h.computeId(e),o=new l(this,null,e,"RESTORED");this.#o.set(i,o)}}static instance(e={forceNew:null,targetManager:null,workspace:null,debuggerWorkspaceBinding:null}){const{forceNew:t,targetManager:i,workspace:o,debuggerWorkspaceBinding:r,restoreInitialBreakpointCount:s}=e;if(!u||t){if(!i||!o||!r)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);u=new d(i,o,r,s)}return u}modelAdded(e){o.Runtime.experiments.isEnabled("instrumentation-breakpoints")&&e.setSynchronizeBreakpointsCallback(this.restoreBreakpointsForScript.bind(this))}modelRemoved(e){e.setSynchronizeBreakpointsCallback(null)}addUpdateBindingsCallback(e){this.#r.push(e)}async copyBreakpoints(e,t){const i=t.project().uiSourceCodeForURL(t.url())!==t||this.#e.project(t.project().id())!==t.project(),o=this.storage.breakpointItems(e.url(),e.contentType().name());for(const e of o)i?this.storage.updateBreakpoint({...e,url:t.url(),resourceTypeName:t.contentType().name()}):await this.setBreakpoint(t,e.lineNumber,e.columnNumber,e.condition,e.enabled,e.isLogpoint,"RESTORED")}async restoreBreakpointsForScript(e){if(!o.Runtime.experiments.isEnabled("instrumentation-breakpoints"))return;if(!e.sourceURL)return;const i=await this.getUISourceCodeWithUpdatedBreakpointInfo(e);this.#n(e.sourceURL)&&await this.#a(i);const r=e.debuggerModel,s=await r.sourceMapManager().sourceMapForClientPromise(e);if(s)for(const t of s.sourceURLs())if(this.#n(t)){const i=await this.debuggerWorkspaceBinding.uiSourceCodeForSourceMapSourceURLPromise(r,t,e.isContentScript());await this.#a(i)}const{pluginManager:n}=this.debuggerWorkspaceBinding,a=await n.getSourcesForScript(e);if(Array.isArray(a))for(const e of a)if(this.#n(e)){const i=await this.debuggerWorkspaceBinding.uiSourceCodeForDebuggerLanguagePluginSourceURLPromise(r,e);t(i),await this.#a(i)}}async getUISourceCodeWithUpdatedBreakpointInfo(e){const i=this.debuggerWorkspaceBinding.uiSourceCodeForScript(e);return t(i),await this.#u(i),i}async#u(e){if(this.#r.length>0){const t=[];for(const i of this.#r)t.push(i(e));await Promise.all(t)}}async#a(e){this.restoreBreakpoints(e);const t=this.#o.values(),i=Array.from(t).filter(t=>t.uiSourceCodes.has(e));await Promise.all(i.map(e=>e.updateBreakpoint()))}#n(e){return this.storage.breakpointItems(e).length>0}static getScriptForInlineUiSourceCode(e){const t=r.DefaultScriptMapping.DefaultScriptMapping.scriptForUISourceCode(e);return t&&t.isInlineScript()&&!t.hasSourceURL?t:null}static breakpointLocationFromUiLocation(e){const t=e.uiSourceCode,i=d.getScriptForInlineUiSourceCode(t),{lineNumber:o,columnNumber:r}=i?i.relativeLocationToRawLocation(e):e;return{lineNumber:o,columnNumber:r}}static uiLocationFromBreakpointLocation(e,t,i){const o=d.getScriptForInlineUiSourceCode(e);return o&&({lineNumber:t,columnNumber:i}=o.rawLocationToRelativeLocation({lineNumber:t,columnNumber:i})),e.uiLocation(t,i)}static isValidPositionInScript(e,t,i){return!(i&&(e<i.lineOffset||e>i.endLine||e===i.lineOffset&&t&&t<i.columnOffset||e===i.endLine&&(!t||t>=i.endColumn)))}restoreBreakpoints(e){const t=d.getScriptForInlineUiSourceCode(e),i=t?.sourceURL??e.url();if(!i)return;const o=e.contentType();this.storage.mute();const r=this.storage.breakpointItems(i,o.name());for(const i of r){const{lineNumber:o,columnNumber:r}=i;d.isValidPositionInScript(o,r,t)&&this.innerSetBreakpoint(e,o,r,i.condition,i.enabled,i.isLogpoint,"RESTORED")}this.storage.unmute()}uiSourceCodeAdded(e){const t=e.data;this.restoreBreakpoints(t)}uiSourceCodeRemoved(e){const t=e.data;this.removeUISourceCode(t)}projectRemoved(e){const t=e.data;for(const e of t.uiSourceCodes())this.removeUISourceCode(e)}removeUISourceCode(e){this.#c(e).forEach(t=>t.removeUISourceCode(e))}async setBreakpoint(t,i,o,r,s,n,u){const c=this.#e.findCompatibleUISourceCodes(t);let l;for(const h of c){const c=new a.UISourceCode.UILocation(h,i,o),p=await this.debuggerWorkspaceBinding.normalizeUILocation(c),m=d.breakpointLocationFromUiLocation(p),g=this.innerSetBreakpoint(p.uiSourceCode,m.lineNumber,m.columnNumber,r,s,n,u);t===h&&(p.id()!==c.id()&&e.Revealer.reveal(p),l=g)}return console.assert(void 0!==l,"The passed uiSourceCode is expected to be a valid uiSourceCode"),l}innerSetBreakpoint(e,t,i,o,r,s,n){const a={url:d.getScriptForInlineUiSourceCode(e)?.sourceURL??e.url(),resourceTypeName:e.contentType().name(),lineNumber:t,columnNumber:i,condition:o,enabled:r,isLogpoint:s},u=h.computeId(a);let c=this.#o.get(u);return c?(c.updateState(a),c.addUISourceCode(e),c.updateBreakpoint(),c):(c=new l(this,e,a,n),this.#o.set(u,c),c)}findBreakpoint(e){const t=this.#i.get(e.uiSourceCode);return t&&t.get(e.id())||null}addHomeUISourceCode(e,t){let i=this.#t.get(e);i||(i=new Set,this.#t.set(e,i)),i.add(t)}removeHomeUISourceCode(e,t){const i=this.#t.get(e);i&&(i.delete(t),0===i.size&&this.#t.delete(e))}async possibleBreakpoints(e,t){const i=await this.debuggerWorkspaceBinding.uiLocationRangeToRawLocationRanges(e,t),o=(await Promise.all(i.map(({start:e,end:t})=>e.debuggerModel.getPossibleBreakpoints(e,t,!1)))).flat(),r=new Map;return await Promise.all(o.map(async i=>{const o=await this.debuggerWorkspaceBinding.rawLocationToUILocation(i);null!==o&&o.uiSourceCode===e&&t.containsLocation(o.lineNumber,o.columnNumber??0)&&r.set(o.id(),o)})),[...r.values()]}breakpointLocationsForUISourceCode(e){const t=this.#i.get(e);return t?Array.from(t.values()):[]}#c(e){return this.breakpointLocationsForUISourceCode(e).map(e=>e.breakpoint).concat(Array.from(this.#t.get(e)??[]))}allBreakpointLocations(){const e=[];for(const t of this.#i.values())e.push(...t.values());return e}removeBreakpoint(e,t){const i=e.breakpointStorageId();t&&this.storage.removeBreakpoint(i),this.#o.delete(i)}uiLocationAdded(e,t){let i=this.#i.get(t.uiSourceCode);i||(i=new Map,this.#i.set(t.uiSourceCode,i));const o=new g(e,t);i.set(t.id(),o),this.dispatchEventToListeners(c.BreakpointAdded,o)}uiLocationRemoved(e,t){const i=this.#i.get(t.uiSourceCode);if(!i)return;const o=i.get(t.id())||null;o&&(i.delete(t.id()),0===i.size&&this.#i.delete(t.uiSourceCode),this.dispatchEventToListeners(c.BreakpointRemoved,o))}supportsConditionalBreakpoints(e){return this.debuggerWorkspaceBinding.supportsConditionalBreakpoints(e)}}var c;!function(e){e.BreakpointAdded="breakpoint-added",e.BreakpointRemoved="breakpoint-removed"}(c||(c={}));class l{breakpointManager;#d=new Set;uiSourceCodes=new Set;#l;#h;isRemoved=!1;#p=null;#m=new Map;constructor(e,t,o,r){this.breakpointManager=e,this.#h=r,this.updateState(o),t?(console.assert(t.contentType().name()===o.resourceTypeName),this.addUISourceCode(t)):this.#g(o),this.breakpointManager.targetManager.observeModels(i.DebuggerModel.DebuggerModel,this)}#g(t){t.resolvedState?this.#p=t.resolvedState.map(e=>({...e,scriptHash:""})):t.resourceTypeName===e.ResourceType.resourceTypes.Script.name()&&(this.#p=[{url:t.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,scriptHash:"",condition:this.backendCondition()}])}getLastResolvedState(){return this.#p}updateLastResolvedState(e){let t;this.#p=e,e&&(t=e.map(e=>({url:e.url,lineNumber:e.lineNumber,columnNumber:e.columnNumber,condition:e.condition}))),function(e,t){if(e===t)return!0;if(!e||!t||e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const o=e[i],r=t[i];if(o.url!==r.url||o.lineNumber!==r.lineNumber||o.columnNumber!==r.columnNumber||o.condition!==r.condition)return!1}return!0}(this.#l.resolvedState,t)||(this.#l={...this.#l,resolvedState:t},this.breakpointManager.storage.updateBreakpoint(this.#l))}get origin(){return this.#h}async refreshInDebugger(){if(!this.isRemoved){const e=Array.from(this.#m.values());await Promise.all(e.map(async e=>(await e.resetBreakpoint(),await this.#b(e))))}}modelAdded(e){const t=this.breakpointManager.debuggerWorkspaceBinding,o=new p(e,this,t);this.#m.set(e,o),this.#b(o),e.addEventListener(i.DebuggerModel.Events.DebuggerWasEnabled,this.#k,this),e.addEventListener(i.DebuggerModel.Events.DebuggerWasDisabled,this.#f,this),e.addEventListener(i.DebuggerModel.Events.ScriptSourceWasEdited,this.#v,this)}modelRemoved(e){const t=this.#m.get(e);t?.cleanUpAfterDebuggerIsGone(),this.#m.delete(e),this.#S(e)}#S(e){e.removeEventListener(i.DebuggerModel.Events.DebuggerWasEnabled,this.#k,this),e.removeEventListener(i.DebuggerModel.Events.DebuggerWasDisabled,this.#f,this),e.removeEventListener(i.DebuggerModel.Events.ScriptSourceWasEdited,this.#v,this)}#k(e){const t=e.data,i=this.#m.get(t);i&&this.#b(i)}#f(e){const t=e.data,i=this.#m.get(t);i?.cleanUpAfterDebuggerIsGone()}async#v(e){const{source:t,data:{script:o,status:r}}=e;if("Ok"!==r)return;console.assert(t instanceof i.DebuggerModel.DebuggerModel);const s=this.#m.get(t);s?.wasSetIn(o.scriptId)&&(await s.resetBreakpoint(),this.#b(s))}modelBreakpoint(e){return this.#m.get(e)}addUISourceCode(e){this.uiSourceCodes.has(e)||(this.uiSourceCodes.add(e),this.breakpointManager.addHomeUISourceCode(e,this),this.bound()||this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e)))}clearUISourceCodes(){this.bound()||this.removeAllUnboundLocations();for(const e of this.uiSourceCodes)this.removeUISourceCode(e)}removeUISourceCode(e){if(this.uiSourceCodes.has(e)&&(this.uiSourceCodes.delete(e),this.breakpointManager.removeHomeUISourceCode(e,this),this.bound()||this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))),this.bound()){for(const t of this.#d)t.uiSourceCode===e&&(this.#d.delete(t),this.breakpointManager.uiLocationRemoved(this,t));this.bound()||this.isRemoved||this.addAllUnboundLocations()}}url(){return this.#l.url}lineNumber(){return this.#l.lineNumber}columnNumber(){return this.#l.columnNumber}uiLocationAdded(e){this.isRemoved||(this.bound()||this.removeAllUnboundLocations(),this.#d.add(e),this.breakpointManager.uiLocationAdded(this,e))}uiLocationRemoved(e){this.#d.has(e)&&(this.#d.delete(e),this.breakpointManager.uiLocationRemoved(this,e),this.bound()||this.isRemoved||this.addAllUnboundLocations())}enabled(){return this.#l.enabled}bound(){return 0!==this.#d.size}setEnabled(e){this.updateState({...this.#l,enabled:e})}condition(){return this.#l.condition}backendCondition(e){const t=this.condition();if(""===t)return"";const o=e=>{let t=i.DebuggerModel.COND_BREAKPOINT_SOURCE_URL;return this.isLogpoint()&&(e=`${b}${e}${m}`,t=i.DebuggerModel.LOGPOINT_SOURCE_URL),`${e}\n\n//# sourceURL=${t}`};return e?n.NamesResolver.allVariablesAtPosition(e).then(e=>e.size>0?s.FormatterWorkerPool.formatterWorkerPool().javaScriptSubstitute(t,e):t).then(e=>o(e),()=>o(t)):o(t)}setCondition(e,t){this.updateState({...this.#l,condition:e,isLogpoint:t})}isLogpoint(){return this.#l.isLogpoint}get storageState(){return this.#l}updateState(e){if(this.#l&&(this.#l.url!==e.url||this.#l.lineNumber!==e.lineNumber||this.#l.columnNumber!==e.columnNumber))throw new Error("Invalid breakpoint state update");this.#l?.enabled===e.enabled&&this.#l?.condition===e.condition&&this.#l?.isLogpoint===e.isLogpoint||(this.#l=e,this.breakpointManager.storage.updateBreakpoint(this.#l),this.updateBreakpoint())}async updateBreakpoint(){return this.bound()||(this.removeAllUnboundLocations(),this.isRemoved||this.addAllUnboundLocations()),await this.#L()}async remove(e){if(this.getIsRemoved())return;this.isRemoved=!0;const t=!e;for(const e of this.#m.keys())this.#S(e);await this.#L(),this.breakpointManager.removeBreakpoint(this,t),this.breakpointManager.targetManager.unobserveModels(i.DebuggerModel.DebuggerModel,this),this.clearUISourceCodes()}breakpointStorageId(){return h.computeId(this.#l)}defaultUILocation(e){return d.uiLocationFromBreakpointLocation(e,this.#l.lineNumber,this.#l.columnNumber)}removeAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))}addAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e))}getUiSourceCodes(){return this.uiSourceCodes}getIsRemoved(){return this.isRemoved}async#L(){await Promise.all(Array.from(this.#m.values()).map(e=>this.#b(e)))}async#b(e){const t=await e.scheduleUpdateInDebugger();"ERROR_BACKEND"===t?await this.remove(!0):"ERROR_BREAKPOINT_CLASH"===t&&await this.remove(!1)}}class p{#R;#I;#B;#N=new r.LiveLocation.LiveLocationPool;#d=new Map;#w=new e.Mutex.Mutex;#C=!1;#U=null;#M=[];#E=new Set;constructor(e,t,i){this.#R=e,this.#I=t,this.#B=i}get currentState(){return this.#U}resetLocations(){for(const e of this.#d.values())this.#I.uiLocationRemoved(e);this.#d.clear(),this.#N.disposeAll(),this.#E.clear()}async scheduleUpdateInDebugger(){if(!this.#R.debuggerEnabled())return"OK";const e=await this.#w.acquire();let t="PENDING";for(;"PENDING"===t;)t=await this.#D();return e(),t}scriptDiverged(){for(const e of this.#I.getUiSourceCodes()){const t=this.#B.scriptFile(e,this.#R);if(t?.hasDivergedFromVM())return!0}return!1}async#D(){if(this.#R.target().isDisposed())return this.cleanUpAfterDebuggerIsGone(),"OK";const e=this.#I.lineNumber(),t=this.#I.columnNumber(),i=this.#I.backendCondition();let s=null;if(!this.#I.getIsRemoved()&&this.#I.enabled()&&!this.scriptDiverged()){let n=[];for(const i of this.#I.getUiSourceCodes()){const{lineNumber:o,columnNumber:s}=d.uiLocationFromBreakpointLocation(i,e,t);if(n=(await r.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().uiLocationToRawLocations(i,o,s)).filter(e=>e.debuggerModel===this.#R),n.length)break}if(n.length&&n.every(e=>e.script())){const e=await Promise.all(n.map(async e=>{const t=e.script(),i=await this.#I.backendCondition(e);return{url:t.sourceURL,scriptHash:t.hash,lineNumber:e.lineNumber,columnNumber:e.columnNumber,condition:i}}));s=e.slice(0)}else if(!o.Runtime.experiments.isEnabled("instrumentation-breakpoints")){const o=this.#I.getLastResolvedState();s=o?o.map(e=>({...e,condition:i})):[{url:this.#I.url(),scriptHash:"",lineNumber:e,columnNumber:t,condition:i}]}}const n=this.#M.length;if(n&&l.State.subset(s,this.#U))return"OK";if(this.#I.updateLastResolvedState(s),n)return await this.resetBreakpoint(),"PENDING";if(!s)return"OK";const{breakpointIds:a,locations:u,serverError:c}=await this.#y(s),h=c&&this.#R.debuggerEnabled()&&!this.#R.isReadyToPause();return!a.length&&h?"PENDING":(this.#U=s,this.#C?(this.#C=!1,"OK"):a.length?(this.#M=a,this.#M.forEach(e=>this.#R.addBreakpointListener(e,this.breakpointResolved,this)),(await Promise.all(u.map(e=>this.addResolvedLocation(e)))).includes("ERROR")?"ERROR_BREAKPOINT_CLASH":"OK"):"ERROR_BACKEND")}async#y(e){const t=await Promise.all(e.map(e=>e.url?this.#R.setBreakpointByURL(e.url,e.lineNumber,e.columnNumber,e.condition):this.#R.setBreakpointInAnonymousScript(e.scriptHash,e.lineNumber,e.columnNumber,e.condition))),i=[];let o=[],r=!1;for(const e of t)e.breakpointId?(i.push(e.breakpointId),o=o.concat(e.locations)):r=!0;return{breakpointIds:i,locations:o,serverError:r}}async resetBreakpoint(){this.#M.length&&(this.resetLocations(),await Promise.all(this.#M.map(e=>this.#R.removeBreakpoint(e))),this.didRemoveFromDebugger(),this.#U=null)}didRemoveFromDebugger(){this.#C?this.#C=!1:(this.resetLocations(),this.#M.forEach(e=>this.#R.removeBreakpointListener(e,this.breakpointResolved,this)),this.#M=[])}async breakpointResolved({data:e}){"ERROR"===await this.addResolvedLocation(e)&&await this.#I.remove(!1)}async locationUpdated(e){const t=this.#d.get(e),i=await e.uiLocation();t&&this.#I.uiLocationRemoved(t),i?(this.#d.set(e,i),this.#I.uiLocationAdded(i)):this.#d.delete(e)}async addResolvedLocation(e){this.#E.add(e.scriptId);const t=await this.#B.rawLocationToUILocation(e);if(!t)return"OK";const i=this.#I.breakpointManager.findBreakpoint(t);return i&&i.breakpoint!==this.#I?"ERROR":(await this.#B.createLiveLocation(e,this.locationUpdated.bind(this),this.#N),"OK")}cleanUpAfterDebuggerIsGone(){this.#C=!0,this.resetLocations(),this.#U=null,this.#M.length&&this.didRemoveFromDebugger()}wasSetIn(e){return this.#E.has(e)}}!function(e){let t;!function(e){e.subset=function(e,t){if(e===t)return!0;if(!e||!t)return!1;if(0===e.length)return!1;for(const i of e)if(void 0===t.find(e=>i.url===e.url&&i.scriptHash===e.scriptHash&&i.lineNumber===e.lineNumber&&i.columnNumber===e.columnNumber&&i.condition===e.condition))return!1;return!0}}(t=e.State||(e.State={}))}(l||(l={}));class h{setting;breakpoints;#A;constructor(){this.setting=e.Settings.Settings.instance().createLocalSetting("breakpoints",[]),this.breakpoints=new Map,this.#A=!1;for(const e of this.setting.get())this.breakpoints.set(h.computeId(e),e)}mute(){this.#A=!0}unmute(){this.#A=!1}breakpointItems(e,t){const i=[];for(const o of this.breakpoints.values())o.url===e&&(o.resourceTypeName!==t&&void 0!==t||i.push(o));return i}updateBreakpoint(e){if(this.#A)return;const t=h.computeId(e);t&&(this.breakpoints.delete(t),this.breakpoints.set(t,e),this.save())}removeBreakpoint(e){this.#A||(this.breakpoints.delete(e),this.save())}save(){this.setting.set(Array.from(this.breakpoints.values()))}static computeId({url:e,resourceTypeName:t,lineNumber:i,columnNumber:o}){if(!e)return"";let r=`${e}:${t}:${i}`;return void 0!==o&&(r+=`:${o}`),r}}class g{breakpoint;uiLocation;constructor(e,t){this.breakpoint=e,this.uiLocation=t}}const b="/** DEVTOOLS_LOGPOINT */ console.log(",m=")";var k=Object.freeze({__proto__:null,get Breakpoint(){return l},BreakpointLocation:g,BreakpointManager:d,EMPTY_BREAKPOINT_CONDITION:"",get Events(){return c},ModelBreakpoint:p,NEVER_PAUSE_HERE_CONDITION:"false"});export{k as BreakpointManager};