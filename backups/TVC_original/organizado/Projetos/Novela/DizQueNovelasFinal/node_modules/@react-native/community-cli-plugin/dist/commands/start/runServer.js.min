"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _createDevMiddlewareLogger=_interopRequireDefault(require("../../utils/createDevMiddlewareLogger")),_isDevServerRunning=_interopRequireDefault(require("../../utils/isDevServerRunning")),_loadMetroConfig=_interopRequireDefault(require("../../utils/loadMetroConfig")),version=_interopRequireWildcard(require("../../utils/version")),_attachKeyHandlers=_interopRequireDefault(require("./attachKeyHandlers")),_middleware=require("./middleware"),_devMiddleware=require("@react-native/dev-middleware"),_metro=_interopRequireDefault(require("metro")),_metroCore=require("metro-core"),_path=_interopRequireDefault(require("path")),_url=_interopRequireDefault(require("url")),_util=require("util");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var o={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&{}.hasOwnProperty.call(e,a)){var n=i?Object.getOwnPropertyDescriptor(e,a):null;n&&(n.get||n.set)?Object.defineProperty(o,a,n):o[a]=e[a]}return o.default=e,t&&t.set(e,o),o}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}async function runServer(e,r,t){const o=await(0,_loadMetroConfig.default)(r,{config:t.config,maxWorkers:t.maxWorkers,port:t.port,resetCache:t.resetCache,watchFolders:t.watchFolders,projectRoot:t.projectRoot,sourceExts:t.sourceExts}),i=t.host?.length?t.host:"localhost",{projectRoot:a,server:{port:n},watchFolders:u}=o,l=!0===t.https?"https":"http",s=_url.default.format({protocol:l,hostname:i,port:n});console.info((0,_util.styleText)("blue",`\nWelcome to React Native v${r.reactNativeVersion}`));const d=await(0,_isDevServerRunning.default)(s,a);if("matched_server_running"===d)return void console.info(`A dev server is already running for this project on port ${n}. Exiting.`);if("port_taken"===d)return void console.error(`${(0,_util.styleText)("red","error")}: Another process is running on port ${n}. Please terminate this process and try again, or use another port with "--port".`);let c;console.info(`Starting dev server on ${s}\n`),t.assetPlugins&&(o.transformer.assetPlugins=t.assetPlugins.map(e=>require.resolve(e))),t.clientLogs||(o.server.forwardClientLogs=!1);const p=new _metroCore.Terminal(process.stdout),f=new(getReporterImpl(t.customLogReporterPath))(p),{middleware:v,websocketEndpoints:_,messageSocketEndpoint:g,eventsSocketEndpoint:h}=(0,_middleware.createDevServerMiddleware)({host:i,port:n,watchFolders:u}),{middleware:w,websocketEndpoints:m}=(0,_devMiddleware.createDevMiddleware)({projectRoot:a,serverBaseUrl:s,logger:(0,_createDevMiddlewareLogger.default)(f)});o.reporter={update(e){f.update(e),c&&c(e),t.interactive&&"initialize_done"===e.type&&(f.update({type:"unstable_server_log",level:"info",data:`Dev server ready. ${(0,_util.styleText)("dim","Press Ctrl+C to exit.")}`}),(0,_attachKeyHandlers.default)({devServerUrl:s,messageSocket:g,reporter:f}))}};const{httpServer:q}=await _metro.default.runServer(o,{host:t.host,secure:t.https,secureCert:t.cert,secureKey:t.key,unstable_extraMiddleware:[v,w],websocketEndpoints:{..._,...m}});c=h.reportEvent,q.keepAliveTimeout=3e4,await version.logIfUpdateAvailable(r,f)}function getReporterImpl(e){if(null==e)return require("metro").TerminalReporter;try{return require(e)}catch(r){if("MODULE_NOT_FOUND"!==r.code)throw r;return require(_path.default.resolve(e))}}var _default=exports.default=runServer;