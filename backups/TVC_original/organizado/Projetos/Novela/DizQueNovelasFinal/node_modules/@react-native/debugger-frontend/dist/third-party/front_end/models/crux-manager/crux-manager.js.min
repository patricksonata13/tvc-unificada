import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as i from"../../core/root/root.js";import*as r from"../../core/sdk/sdk.js";import*as n from"../emulation/emulation.js";const a={fieldOverrideWarning:"Field data is configured for a different URL than the current page."},o=t.i18n.registerUIStrings("models/crux-manager/CrUXManager.ts",a),s=t.i18n.getLocalizedString.bind(void 0,o);let c;const l=["ALL","DESKTOP","PHONE"],g=["origin","url"],d=["first_contentful_paint","largest_contentful_paint","cumulative_layout_shift","interaction_to_next_paint","round_trip_time","form_factors","largest_contentful_paint_image_time_to_first_byte","largest_contentful_paint_image_resource_load_delay","largest_contentful_paint_image_resource_load_duration","largest_contentful_paint_image_element_render_delay"];class u extends e.ObjectWrapper.ObjectWrapper{#e=new Map;#t=new Map;#r;#i;#n="https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=AIzaSyCCSOx25vrb5z0tbedCB3_JRzzbVW6Uwgw";#s;fieldDeviceOption="AUTO";fieldPageScope="url";constructor(){super();const t=!0===i.Runtime.hostConfig.isOffTheRecord?"Session":"Global";this.#i=e.Settings.Settings.instance().createSetting("field-data",{enabled:!1,override:"",originMappings:[],overrideEnabled:!1},t),this.#i.addChangeListener(()=>{this.refresh()}),r.TargetManager.TargetManager.instance().addModelListener(r.ResourceTreeModel.ResourceTreeModel,r.ResourceTreeModel.Events.FrameNavigated,this.#a,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return c&&!t||(c=new u),c}get pageResult(){return this.#s}getConfigSetting(){return this.#i}isEnabled(){return this.#i.get().enabled}async getFieldDataForPage(e){const t={"origin-ALL":null,"origin-DESKTOP":null,"origin-PHONE":null,"origin-TABLET":null,"url-ALL":null,"url-DESKTOP":null,"url-PHONE":null,"url-TABLET":null,warnings:[]};try{const r=this.#o(e),i=[];for(const e of g)for(const n of l){const s=this.#c(r,e,n).then(r=>{t[`${e}-${n}`]=r});i.push(s)}await Promise.all(i)}catch(e){console.error(e)}finally{return t}}#l(e){try{const t=new URL(e),r=(this.#i.get().originMappings||[]).find(e=>e.developmentOrigin===t.origin);if(!r)return e;const i=new URL(r.productionOrigin);return i.pathname=t.pathname,i.href}catch{return e}}async getFieldDataForCurrentPageForTesting(){return await this.#d()}async#d(){const e=this.#r||await this.#g(),t=this.#i.get().overrideEnabled?this.#i.get().override||"":this.#l(e),r=await this.getFieldDataForPage(t);return e!==t&&r.warnings.push(s(a.fieldOverrideWarning)),r}async#g(){const e=r.TargetManager.TargetManager.instance();let t=e.inspectedURL();return t||(t=await new Promise(t=>{e.addEventListener("InspectedURLChanged",function r(i){const n=i.data.inspectedURL();n&&(t(n),e.removeEventListener("InspectedURLChanged",r))})})),t}async#a(e){e.data.isPrimaryFrame()&&(this.#r=e.data.url,await this.refresh())}async refresh(){this.#s=void 0,this.dispatchEventToListeners("field-data-changed",void 0),this.#i.get().enabled&&(this.#s=await this.#d(),this.dispatchEventToListeners("field-data-changed",this.#s))}#o(e){const t=new URL(e);return t.hash="",t.search="",t}async#c(e,t,r){const{origin:i,href:n,hostname:s}=e;if("localhost"===s||"127.0.0.1"===s||!i.startsWith("http"))return null;const a="origin"===t?this.#e:this.#t,o="origin"===t?`${i}-${r}`:`${n}-${r}`,c=a.get(o);if(void 0!==c)return c;try{const e="ALL"===r?void 0:r,s="origin"===t?await this.#u({origin:i,metrics:d,formFactor:e}):await this.#u({url:n,metrics:d,formFactor:e});return a.set(o,s),s}catch(e){return console.error(e),null}}async#u(e){const t=JSON.stringify(e),r=await fetch(this.#n,{method:"POST",body:t});if(!r.ok&&404!==r.status)throw new Error(`Failed to fetch data from CrUX server (Status code: ${r.status})`);const i=await r.json();if(404===r.status){if("NOT_FOUND"===i?.error?.status)return null;throw new Error(`Failed to fetch data from CrUX server (Status code: ${r.status})`)}if(!("record"in i))throw new Error(`Failed to find data in CrUX response: ${JSON.stringify(i)}`);return i}#h(){const e=n.DeviceModeModel.DeviceModeModel.tryInstance();return null===e?"ALL":e.isMobile()?this.#s?.[`${this.fieldPageScope}-PHONE`]?"PHONE":"ALL":this.#s?.[`${this.fieldPageScope}-DESKTOP`]?"DESKTOP":"ALL"}resolveDeviceOptionToScope(e){return"AUTO"===e?this.#h():e}getSelectedDeviceScope(){return this.resolveDeviceOptionToScope(this.fieldDeviceOption)}getSelectedScope(){return{pageScope:this.fieldPageScope,deviceScope:this.getSelectedDeviceScope()}}getSelectedFieldResponse(){const e=this.fieldPageScope,t=this.getSelectedDeviceScope();return this.getFieldResponse(e,t)}getSelectedFieldMetricData(e){return this.getSelectedFieldResponse()?.record.metrics[e]}getFieldResponse(e,t){return this.#s?.[`${e}-${t}`]}setEndpointForTesting(e){this.#n=e}}export{u as CrUXManager,l as DEVICE_SCOPE_LIST};