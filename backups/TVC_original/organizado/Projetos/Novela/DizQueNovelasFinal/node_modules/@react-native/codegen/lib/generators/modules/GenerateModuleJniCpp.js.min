"use strict";const{unwrapNullable:unwrapNullable}=require("../../parsers/parsers-commons"),{createAliasResolver:createAliasResolver,getModules:getModules}=require("./Utils"),HostFunctionTemplate=({hasteModuleName:e,propertyName:n,jniSignature:t,jsReturnType:a})=>`static facebook::jsi::Value __hostFunction_${e}SpecJSI_${n}(facebook::jsi::Runtime& rt, TurboModule &turboModule, const facebook::jsi::Value* args, size_t count) {\n  static jmethodID cachedMethodId = nullptr;\n  return static_cast<JavaTurboModule &>(turboModule).invokeJavaMethod(rt, ${a}, "${n}", "${t}", args, count, cachedMethodId);\n}`,ModuleClassConstructorTemplate=({hasteModuleName:e,eventEmitters:n,methods:t})=>`\n${e}SpecJSI::${e}SpecJSI(const JavaTurboModule::InitParams &params)\n  : JavaTurboModule(params) {\n${t.map(({propertyName:n,argCount:t})=>`  methodMap_["${n}"] = MethodMetadata {${t}, __hostFunction_${e}SpecJSI_${n}};`).join("\n")}${n.length>0?n.map(e=>`\n  eventEmitterMap_["${e.name}"] = std::make_shared<AsyncEventEmitter<folly::dynamic>>();`).join(""):""}${n.length>0?"\n  configureEventEmitterCallback();":""}\n}`.trim(),ModuleLookupTemplate=({moduleName:e,hasteModuleName:n})=>`  if (moduleName == "${e}") {\n    return std::make_shared<${n}SpecJSI>(params);\n  }`,FileTemplate=({libraryName:e,include:n,modules:t,moduleLookups:a})=>`\n/**\n * This code was generated by [react-native-codegen](https://www.npmjs.com/package/react-native-codegen).\n *\n * Do not edit this file as changes may cause incorrect behavior and will be lost\n * once the code is regenerated.\n *\n * @generated by codegen project: GenerateModuleJniCpp.js\n */\n\n#include ${n}\n\nnamespace facebook::react {\n\n${t}\n\nstd::shared_ptr<TurboModule> ${e}_ModuleProvider(const std::string &moduleName, const JavaTurboModule::InitParams &params) {\n${a.map(ModuleLookupTemplate).join("\n")}\n  return nullptr;\n}\n\n} // namespace facebook::react\n`;function translateReturnTypeToKind(e,n){const[t]=unwrapNullable(e);let a=t;switch("TypeAliasTypeAnnotation"===a.type&&(a=n(a.name)),a.type){case"ReservedTypeAnnotation":if("RootTag"===a.name)return"NumberKind";throw a.name,new Error(`Invalid ReservedFunctionValueTypeName name, got ${a.name}`);case"VoidTypeAnnotation":return"VoidKind";case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return"StringKind";case"BooleanTypeAnnotation":return"BooleanKind";case"EnumDeclaration":switch(t.memberType){case"NumberTypeAnnotation":return"NumberKind";case"StringTypeAnnotation":return"StringKind";default:throw new Error(`Unknown enum prop type for returning value, found: ${a.type}"`)}case"UnionTypeAnnotation":switch(t.memberType){case"NumberTypeAnnotation":return"NumberKind";case"ObjectTypeAnnotation":return"ObjectKind";case"StringTypeAnnotation":return"StringKind";default:throw new Error(`Unsupported union member returning value, found: ${a.memberType}"`)}case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"DoubleTypeAnnotation":case"FloatTypeAnnotation":case"Int32TypeAnnotation":return"NumberKind";case"PromiseTypeAnnotation":return"PromiseKind";case"GenericObjectTypeAnnotation":case"ObjectTypeAnnotation":return"ObjectKind";case"ArrayTypeAnnotation":return"ArrayKind";default:throw a.type,new Error(`Unknown prop type for returning value, found: ${a.type}"`)}}function translateParamTypeToJniType(e,n){const{optional:t,typeAnnotation:a}=e,[o,r]=unwrapNullable(a),i=!t&&!r;let p=o;switch("TypeAliasTypeAnnotation"===p.type&&(p=n(p.name)),p.type){case"ReservedTypeAnnotation":if("RootTag"===p.name)return i?"D":"Ljava/lang/Double;";throw p.name,new Error(`Invalid ReservedFunctionValueTypeName name, got ${p.name}`);case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return"Ljava/lang/String;";case"BooleanTypeAnnotation":return i?"Z":"Ljava/lang/Boolean;";case"EnumDeclaration":switch(o.memberType){case"NumberTypeAnnotation":return i?"D":"Ljava/lang/Double;";case"StringTypeAnnotation":return"Ljava/lang/String;";default:throw new Error(`Unknown enum prop type for method arg, found: ${p.type}"`)}case"UnionTypeAnnotation":switch(o.memberType){case"NumberTypeAnnotation":return i?"D":"Ljava/lang/Double;";case"ObjectTypeAnnotation":return"Lcom/facebook/react/bridge/ReadableMap;";case"StringTypeAnnotation":return"Ljava/lang/String;";default:throw new Error(`Unsupported union prop value, found: ${p.memberType}"`)}case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"DoubleTypeAnnotation":case"FloatTypeAnnotation":case"Int32TypeAnnotation":return i?"D":"Ljava/lang/Double;";case"GenericObjectTypeAnnotation":case"ObjectTypeAnnotation":return"Lcom/facebook/react/bridge/ReadableMap;";case"ArrayTypeAnnotation":return"Lcom/facebook/react/bridge/ReadableArray;";case"FunctionTypeAnnotation":return"Lcom/facebook/react/bridge/Callback;";default:throw p.type,new Error(`Unknown prop type for method arg, found: ${p.type}"`)}}function translateReturnTypeToJniType(e,n){const[t,a]=unwrapNullable(e);let o=t;switch("TypeAliasTypeAnnotation"===o.type&&(o=n(o.name)),o.type){case"ReservedTypeAnnotation":if("RootTag"===o.name)return a?"Ljava/lang/Double;":"D";throw o.name,new Error(`Invalid ReservedFunctionValueTypeName name, got ${o.name}`);case"VoidTypeAnnotation":return"V";case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return"Ljava/lang/String;";case"BooleanTypeAnnotation":return a?"Ljava/lang/Boolean;":"Z";case"EnumDeclaration":switch(t.memberType){case"NumberTypeAnnotation":return a?"Ljava/lang/Double;":"D";case"StringTypeAnnotation":return"Ljava/lang/String;";default:throw new Error(`Unknown enum prop type for method return type, found: ${o.type}"`)}case"UnionTypeAnnotation":switch(t.memberType){case"NumberTypeAnnotation":return a?"Ljava/lang/Double;":"D";case"ObjectTypeAnnotation":return"Lcom/facebook/react/bridge/WritableMap;";case"StringTypeAnnotation":return"Ljava/lang/String;";default:throw new Error(`Unsupported union member type, found: ${o.memberType}"`)}case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"DoubleTypeAnnotation":case"FloatTypeAnnotation":case"Int32TypeAnnotation":return a?"Ljava/lang/Double;":"D";case"PromiseTypeAnnotation":return"Lcom/facebook/react/bridge/Promise;";case"GenericObjectTypeAnnotation":case"ObjectTypeAnnotation":return"Lcom/facebook/react/bridge/WritableMap;";case"ArrayTypeAnnotation":return"Lcom/facebook/react/bridge/WritableArray;";default:throw o.type,new Error(`Unknown prop type for method return type, found: ${o.type}"`)}}function translateMethodTypeToJniSignature(e,n){const{name:t,typeAnnotation:a}=e;let[{returnTypeAnnotation:o,params:r}]=unwrapNullable(a);r=[...r];let i=o;const p="PromiseTypeAnnotation"===o.type;p&&(i={type:"VoidTypeAnnotation"});const u=r.map(e=>translateParamTypeToJniType(e,n));p&&u.push(translateReturnTypeToJniType(o,n));return`(${u.join("")})${"getConstants"===t?"Ljava/util/Map;":translateReturnTypeToJniType(i,n)}`}function translateMethodForImplementation(e,n,t){const[a]=unwrapNullable(n.typeAnnotation),{returnTypeAnnotation:o}=a;return"getConstants"===n.name&&"ObjectTypeAnnotation"===o.type&&0===o.properties.length?"":HostFunctionTemplate({hasteModuleName:e,propertyName:n.name,jniSignature:translateMethodTypeToJniSignature(n,t),jsReturnType:translateReturnTypeToKind(o,t)})}module.exports={generate(e,n,t,a=!1,o){const r=getModules(n),i=Object.keys(r).filter(e=>{const n=r[e];return!(null!=n.excludedPlatforms&&n.excludedPlatforms.includes("android"))}).sort().map(e=>{const{aliasMap:n,spec:{eventEmitters:t,methods:a}}=r[e],o=createAliasResolver(n);return a.map(n=>translateMethodForImplementation(e,n,o)).join("\n\n")+"\n\n"+ModuleClassConstructorTemplate({hasteModuleName:e,eventEmitters:t,methods:a.map(({name:e,typeAnnotation:n})=>{const[{returnTypeAnnotation:t,params:a}]=unwrapNullable(n);return"getConstants"===e&&"ObjectTypeAnnotation"===t.type&&t.properties&&0===t.properties.length?null:{propertyName:e,argCount:a.length}}).filter(Boolean)})}).join("\n"),p=Object.keys(r).filter(e=>{const n=r[e];return!(null!=n.excludedPlatforms&&n.excludedPlatforms.includes("android"))}).sort((e,n)=>{const t=r[e].moduleName,a=r[n].moduleName;return t<a?-1:t>a?1:0}).map(e=>({moduleName:r[e].moduleName,hasteModuleName:e})),u=`${e}-generated.cpp`,s=FileTemplate({modules:i,libraryName:e.replace(/-/g,"_"),moduleLookups:p,include:`"${e}.h"`});return new Map([[`jni/${u}`,s]])}};