"use strict";const{randomBytes:randomBytes}=require("crypto"),PerMessageDeflate=require("./permessage-deflate"),{EMPTY_BUFFER:EMPTY_BUFFER}=require("./constants"),{isValidStatusCode:isValidStatusCode}=require("./validation"),{mask:applyMask,toBuffer:toBuffer}=require("./buffer-util");class Sender{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const s=t.mask&&t.readOnly;var r=t.mask?6:2,i=e.length;e.length>=65536?(r+=8,i=127):e.length>125&&(r+=2,i=126);const n=Buffer.allocUnsafe(s?e.length+r:r);if(n[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(n[0]|=64),n[1]=i,126===i?n.writeUInt16BE(e.length,2):127===i&&(n.writeUInt32BE(0,2),n.writeUInt32BE(e.length,6)),!t.mask)return[n,e];const a=randomBytes(4);return n[1]|=128,n[r-4]=a[0],n[r-3]=a[1],n[r-2]=a[2],n[r-1]=a[3],s?(applyMask(e,a,n,r,e.length),[n]):(applyMask(e,a,e,0,e.length),[n,e])}close(e,t,s,r){var i;if(void 0===e)i=EMPTY_BUFFER;else{if("number"!=typeof e||!isValidStatusCode(e))throw new TypeError("First argument must be a valid error code number");void 0===t||""===t?(i=Buffer.allocUnsafe(2)).writeUInt16BE(e,0):((i=Buffer.allocUnsafe(2+Buffer.byteLength(t))).writeUInt16BE(e,0),i.write(t,2))}this._deflating?this.enqueue([this.doClose,i,s,r]):this.doClose(i,s,r)}doClose(e,t,s){this.sendFrame(Sender.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),s)}ping(e,t,s){const r=toBuffer(e);this._deflating?this.enqueue([this.doPing,r,t,toBuffer.readOnly,s]):this.doPing(r,t,toBuffer.readOnly,s)}doPing(e,t,s,r){this.sendFrame(Sender.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:s}),r)}pong(e,t,s){const r=toBuffer(e);this._deflating?this.enqueue([this.doPong,r,t,toBuffer.readOnly,s]):this.doPong(r,t,toBuffer.readOnly,s)}doPong(e,t,s,r){this.sendFrame(Sender.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:s}),r)}send(e,t,s){const r=toBuffer(e),i=this._extensions[PerMessageDeflate.extensionName];var n=t.binary?2:1,a=t.compress;if(this._firstFragment?(this._firstFragment=!1,a&&i&&(a=r.length>=i._threshold),this._compress=a):(a=!1,n=0),t.fin&&(this._firstFragment=!0),i){const e={fin:t.fin,rsv1:a,opcode:n,mask:t.mask,readOnly:toBuffer.readOnly};this._deflating?this.enqueue([this.dispatch,r,this._compress,e,s]):this.dispatch(r,this._compress,e,s)}else this.sendFrame(Sender.frame(r,{fin:t.fin,rsv1:!1,opcode:n,mask:t.mask,readOnly:toBuffer.readOnly}),s)}dispatch(e,t,s,r){if(!t)return void this.sendFrame(Sender.frame(e,s),r);const i=this._extensions[PerMessageDeflate.extensionName];this._deflating=!0,i.compress(e,s.fin,(e,t)=>{this._deflating=!1,s.readOnly=!1,this.sendFrame(Sender.frame(t,s),r),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,e[0].apply(this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}module.exports=Sender;