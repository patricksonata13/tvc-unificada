import*as e from"../../core/common/common.js";import*as t from"../../core/sdk/sdk.js";import*as i from"../../core/i18n/i18n.js";import*as o from"../../core/root/root.js";import*as s from"../../ui/legacy/components/color_picker/color_picker.js";import"../../ui/components/buttons/buttons.js";import*as n from"../../ui/legacy/legacy.js";import*as r from"../../core/platform/platform.js";import*as a from"../../models/text_utils/text_utils.js";import*as l from"../../ui/components/icon_button/icon_button.js";import*as d from"../../ui/legacy/components/data_grid/data_grid.js";import*as c from"../../ui/legacy/components/utils/utils.js";import*as h from"../../ui/visual_logging/visual_logging.js";import*as u from"../../core/host/host.js";import*as v from"./components/components.js";class p extends e.ObjectWrapper.ObjectWrapper{currentUrl;constructor(){super(),this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),t.TargetManager.TargetManager.instance().addEventListener("InspectedURLChanged",this.#e,this)}#e(){this.currentUrl!==t.TargetManager.TargetManager.instance().inspectedURL()&&(this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),this.dispatchEventToListeners("Reset"))}}var m=Object.freeze({__proto__:null,OverviewController:p});const g={topAppliedToAStatically:"`Top` applied to a statically positioned element",leftAppliedToAStatically:"`Left` applied to a statically positioned element",rightAppliedToAStatically:"`Right` applied to a statically positioned element",bottomAppliedToAStatically:"`Bottom` applied to a statically positioned element",widthAppliedToAnInlineElement:"`Width` applied to an inline element",heightAppliedToAnInlineElement:"`Height` applied to an inline element",verticalAlignmentAppliedTo:"Vertical alignment applied to element which is neither `inline` nor `table-cell`"},f=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewUnusedDeclarations.ts",g),w=i.i18n.getLocalizedString.bind(void 0,f);class b{static add(e,t,i){const s=e.get(t)||[];s.push(i),e.set(t,s)}static checkForUnusedPositionValues(e,t,i,s,o,n,r,a){if("static"===i[s]){if("auto"!==i[o]){const s=w(g.topAppliedToAStatically);this.add(e,s,{declaration:`top: ${i[o]}`,nodeId:t})}if("auto"!==i[n]){const s=w(g.leftAppliedToAStatically);this.add(e,s,{declaration:`left: ${i[n]}`,nodeId:t})}if("auto"!==i[r]){const s=w(g.rightAppliedToAStatically);this.add(e,s,{declaration:`right: ${i[r]}`,nodeId:t})}if("auto"!==i[a]){const s=w(g.bottomAppliedToAStatically);this.add(e,s,{declaration:`bottom: ${i[a]}`,nodeId:t})}}}static checkForUnusedWidthAndHeightValues(e,t,i,s,o,n){if("inline"===i[s]){if("auto"!==i[o]){const s=w(g.widthAppliedToAnInlineElement);this.add(e,s,{declaration:`width: ${i[o]}`,nodeId:t})}if("auto"!==i[n]){const s=w(g.heightAppliedToAnInlineElement);this.add(e,s,{declaration:`height: ${i[n]}`,nodeId:t})}}}static checkForInvalidVerticalAlignment(e,t,i,s,o){if(i[s]&&!i[s].startsWith("inline")&&!i[s].startsWith("table")&&"baseline"!==i[o]){const s=w(g.verticalAlignmentAppliedTo);this.add(e,s,{declaration:`vertical-align: ${i[o]}`,nodeId:t})}}}var C=Object.freeze({__proto__:null,CSSOverviewUnusedDeclarations:b});class S extends t.SDKModel.SDKModel{#t;#i;#s;#o;constructor(e){super(e),this.#t=e.runtimeAgent(),this.#i=e.cssAgent(),this.#s=e.domsnapshotAgent(),this.#o=e.overlayAgent()}highlightNode(t){const i={contentColor:e.Color.PageHighlight.Content.toProtocolRGBA(),showInfo:!0,contrastAlgorithm:o.Runtime.experiments.isEnabled("apca")?"apca":"aa"};this.#o.invoke_hideHighlight(),this.#o.invoke_highlightNode({backendNodeId:t,highlightConfig:i})}async getNodeStyleStats(){const t=new Map,i=new Map,n=new Map,r=new Map,a=new Map,l=new Map,d=new Map,c=t=>t instanceof e.Color.Legacy?t.hasAlpha()?t.asString("hexa"):t.asString("hex"):t.asString(),h=(t,i,s)=>{if(-1===t)return;const o=f[t];if(!o)return;const n=e.Color.parse(o);if(!n||0===n.asLegacyColor().rgba()[3])return;const r=c(n);if(!r)return;const a=s.get(r)||new Set;return a.add(i),s.set(r,a),n},v=e=>new Set(["altglyph","circle","ellipse","path","polygon","polyline","rect","svg","text","textpath","tref","tspan"]).has(e.toLowerCase()),u=e=>new Set(["iframe","video","embed","img"]).has(e.toLowerCase()),p=(e,t)=>new Set(["tr","td","thead","tbody"]).has(e.toLowerCase())&&t.startsWith("table");let g=0;const{documents:m,strings:f}=await this.#s.invoke_captureSnapshot({computedStyles:["background-color","color","fill","border-top-width","border-top-color","border-bottom-width","border-bottom-color","border-left-width","border-left-color","border-right-width","border-right-color","font-family","font-size","font-weight","line-height","position","top","right","bottom","left","display","width","height","vertical-align"],includeTextColorOpacities:!0,includeBlendedBackgroundColors:!0});for(const{nodes:w,layout:S}of m){g+=S.nodeIndex.length;for(let g=0;g<S.styles.length;g++){const m=S.styles[g],y=S.nodeIndex[g];if(!w.backendNodeId||!w.nodeName)continue;const x=w.backendNodeId[y],C=w.nodeName[y],[k,$,I,T,z,W,E,A,M,L,R,O,P,F,_,N,U,D,j,V,q,H,B,G]=m;h(k,x,t);const Q=h($,x,i);if(v(f[C])&&h(I,x,r),"0px"!==f[T]&&h(z,x,a),"0px"!==f[W]&&h(E,x,a),"0px"!==f[A]&&h(M,x,a),"0px"!==f[L]&&h(R,x,a),O&&-1!==O){const e=f[O],t=l.get(e)||new Map,i="font-size",s="font-weight",o="line-height",n=t.get(i)||new Map,r=t.get(s)||new Map,a=t.get(o)||new Map;if(-1!==P){const e=f[P],t=n.get(e)||[];t.push(x),n.set(e,t)}if(-1!==F){const e=f[F],t=r.get(e)||[];t.push(x),r.set(e,t)}if(-1!==_){const e=f[_],t=a.get(e)||[];t.push(x),a.set(e,t)}t.set(i,n),t.set(s,r),t.set(o,a),l.set(e,t)}const K=Q&&S.blendedBackgroundColors&&-1!==S.blendedBackgroundColors[g]?e.Color.parse(f[S.blendedBackgroundColors[g]]):null;if(Q&&K){const e=new s.ContrastInfo.ContrastInfo({backgroundColors:[K.asString("hexa")],computedFontSize:-1!==P?f[P]:"",computedFontWeight:-1!==F?f[F]:""}),t=Q.asLegacyColor().blendWithAlpha(S.textColorOpacities?S.textColorOpacities[g]:1);e.setColor(t);const i=`${c(t)}_${c(K.asLegacyColor())}`;if(o.Runtime.experiments.isEnabled("apca")){const s=e.contrastRatioAPCA(),o=e.contrastRatioAPCAThreshold();if(!(s&&o&&Math.abs(s)>=o)&&s){const e={nodeId:x,contrastRatio:s,textColor:t,backgroundColor:K,thresholdsViolated:{aa:!1,aaa:!1,apca:!0}};n.has(i)?n.get(i).push(e):n.set(i,[e])}}else{const s=e.contrastRatioThreshold("aa")||0,o=e.contrastRatioThreshold("aaa")||0,r=e.contrastRatio()||0;if(s>r||o>r){const e={nodeId:x,contrastRatio:r,textColor:t,backgroundColor:K,thresholdsViolated:{aa:s>r,aaa:o>r,apca:!1}};n.has(i)?n.get(i).push(e):n.set(i,[e])}}}b.checkForUnusedPositionValues(d,x,f,N,U,V,D,j),v(f[C])||u(f[C])||b.checkForUnusedWidthAndHeightValues(d,x,f,q,H,B),-1===G||p(f[C],f[q])||b.checkForInvalidVerticalAlignment(d,x,f,q,G)}}return{backgroundColors:t,textColors:i,textColorContrastIssues:n,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d,elementCount:g}}getComputedStyleForNode(e){return this.#i.invoke_getComputedStyleForNode({nodeId:e})}async getMediaQueries(){const e=await this.#i.invoke_getMediaQueries(),t=new Map;if(!e)return t;for(const i of e.medias){if("linkedSheet"===i.source)continue;const e=t.get(i.text)||[];e.push(i),t.set(i.text,e)}return t}async getGlobalStylesheetStats(){const{result:e}=await this.#t.invoke_evaluate({expression:"(function() {\n      let styleRules = 0;\n      let inlineStyles = 0;\n      let externalSheets = 0;\n      const stats = {\n        // Simple.\n        type: new Set(),\n        class: new Set(),\n        id: new Set(),\n        universal: new Set(),\n        attribute: new Set(),\n\n        // Non-simple.\n        nonSimple: new Set()\n      };\n\n      for (const styleSheet of document.styleSheets) {\n        if (styleSheet.href) {\n          externalSheets++;\n        } else {\n          inlineStyles++;\n        }\n\n        // Attempting to grab rules can trigger a DOMException.\n        // Try it and if it fails skip to the next stylesheet.\n        let rules;\n        try {\n          rules = styleSheet.rules;\n        } catch (err) {\n          continue;\n        }\n\n        for (const rule of rules) {\n          if ('selectorText' in rule) {\n            styleRules++;\n\n            // Each group that was used.\n            for (const selectorGroup of rule.selectorText.split(',')) {\n              // Each selector in the group.\n              for (const selector of selectorGroup.split(/[\\t\\n\\f\\r ]+/g)) {\n                if (selector.startsWith('.')) {\n                  // Class.\n                  stats.class.add(selector);\n                } else if (selector.startsWith('#')) {\n                  // Id.\n                  stats.id.add(selector);\n                } else if (selector.startsWith('*')) {\n                  // Universal.\n                  stats.universal.add(selector);\n                } else if (selector.startsWith('[')) {\n                  // Attribute.\n                  stats.attribute.add(selector);\n                } else {\n                  // Type or non-simple selector.\n                  const specialChars = /[#.:\\[\\]|\\+>~]/;\n                  if (specialChars.test(selector)) {\n                    stats.nonSimple.add(selector);\n                  } else {\n                    stats.type.add(selector);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      return {\n        styleRules,\n        inlineStyles,\n        externalSheets,\n        stats: {\n          // Simple.\n          type: stats.type.size,\n          class: stats.class.size,\n          id: stats.id.size,\n          universal: stats.universal.size,\n          attribute: stats.attribute.size,\n\n          // Non-simple.\n          nonSimple: stats.nonSimple.size\n        }\n      }\n    })()",returnByValue:!0});if("object"===e.type)return e.value}}t.SDKModel.SDKModel.register(S,{capabilities:2,autostart:!1});var y=Object.freeze({__proto__:null,CSSOverviewModel:S}),x={cssText:`.overview-processing-view{overflow:hidden;padding:16px;justify-content:center;align-items:center;height:100%}.overview-processing-view h1{font-size:16px;text-align:center;font-weight:normal;margin:0;padding:8px}.overview-processing-view h2{font-size:12px;text-align:center;font-weight:normal;margin:0;padding-top:32px}\n/*# sourceURL=${import.meta.resolve("./cssOverviewProcessingView.css")} */\n`};const k={cancel:"Cancel"},$=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewProcessingView.ts",k),I=i.i18n.getLocalizedString.bind(void 0,$);class T extends n.Widget.Widget{#n;fragment;constructor(e){super(),this.registerRequiredCSS(x),this.#n=e,this.#r()}#r(){const e=n.UIUtils.createTextButton(I(k.cancel),()=>this.#n.dispatchEventToListeners("RequestOverviewCancel"),{jslogContext:"css-overview.cancel-processing",variant:"outlined"});this.setDefaultFocusedElement(e),this.fragment=n.Fragment.Fragment.build`
      <div class="vbox overview-processing-view">
        <h1>Processing page</h1>
        <div>${e}</div>
      </div>
    `,this.contentElement.appendChild(this.fragment.element()),this.contentElement.style.overflow="auto"}}var M=Object.freeze({__proto__:null,CSSOverviewProcessingView:T}),A={cssText:`.overview-completed-view{overflow:auto;--overview-default-padding:28px;--overview-icon-padding:32px}.overview-completed-view .summary ul,\n.overview-completed-view .colors ul{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0}.overview-completed-view .summary ul{display:grid;grid-template-columns:repeat(auto-fill,140px);grid-gap:16px}.overview-completed-view .colors ul li{display:inline-block;margin:0 0 16px;padding:0 8px 0 0}.overview-completed-view .summary ul li{display:flex;flex-direction:column;grid-column-start:auto}.overview-completed-view li .label{font-size:12px;padding-bottom:2px}.overview-completed-view li .value{font-size:17px}.overview-completed-view ul li span{font-weight:bold}.unused-rules-grid .header-container,\n.unused-rules-grid .data-container,\n.unused-rules-grid table.data{position:relative}.unused-rules-grid .data-container{top:0;max-height:350px}.unused-rules-grid{border-left:none;border-right:none}.unused-rules-grid .monospace{display:block;height:18px}.element-grid{flex:1;border-left:none;border-right:none;overflow:auto}.block{width:65px;height:25px;border-radius:3px;margin-right:16px}.block-title{padding-top:4px;font-size:12px;color:var(--sys-color-on-surface);letter-spacing:0;text-transform:uppercase}.block-title.color-text{text-transform:none;max-width:65px;text-overflow:ellipsis;white-space:nowrap;cursor:text;user-select:text;overflow:hidden}.results-section{flex-shrink:0;border-bottom:1px solid var(--sys-color-divider);padding:var(--overview-default-padding) 0 var(--overview-default-padding) 0}.horizontally-padded{padding-left:var(--overview-default-padding);padding-right:var(--overview-default-padding)}.results-section h1{font-size:15px;font-weight:normal;padding:0;margin:0 0 20px;padding-left:calc(var(--overview-default-padding) + var(--overview-icon-padding));position:relative;height:26px;line-height:26px}.results-section h1::before{content:"";display:block;position:absolute;left:var(--overview-default-padding);top:0;width:26px;height:26px;background-image:var(--image-file-cssoverview_icons_2x);background-size:104px 26px}.results-section.horizontally-padded h1{padding-left:var(--overview-icon-padding)}.results-section.horizontally-padded h1::before{left:0}.results-section.summary h1{padding-left:0}.results-section.summary h1::before{display:none}.results-section.colors h1::before{background-position:0 0}.results-section.font-info h1::before{background-position:-26px 0}.results-section.unused-declarations h1::before{background-position:-52px 0}.results-section.media-queries h1::before{background-position:-78px 0}.results-section.colors h2{margin-top:20px;font-size:13px;font-weight:normal}.overview-completed-view .font-info ul,\n.overview-completed-view .media-queries ul,\n.overview-completed-view .unused-declarations ul{width:100%;list-style:none;margin:0;padding:0 var(--overview-default-padding)}.overview-completed-view .font-info ul li,\n.overview-completed-view .media-queries ul li,\n.overview-completed-view .unused-declarations ul li{display:grid;grid-template-columns:2fr 3fr;grid-gap:12px;margin-bottom:4px;align-items:center}.overview-completed-view .font-info button .details,\n.overview-completed-view .media-queries button .details,\n.overview-completed-view .unused-declarations button .details{min-width:100px;text-align:right;margin-right:8px;color:var(--sys-color-primary);pointer-events:none}.overview-completed-view .font-info button .bar-container,\n.overview-completed-view .media-queries button .bar-container,\n.overview-completed-view .unused-declarations button .bar-container{flex:1;pointer-events:none}.overview-completed-view .font-info button .bar,\n.overview-completed-view .media-queries button .bar,\n.overview-completed-view .unused-declarations button .bar{height:8px;background:var(--sys-color-primary-bright);border-radius:2px;min-width:2px}.overview-completed-view .font-info button,\n.overview-completed-view .media-queries button,\n.overview-completed-view .unused-declarations button{border:none;padding:0;padding-right:10px;margin:0;display:flex;align-items:center;border-radius:2px;cursor:pointer;height:28px;background:none;&:focus-visible{outline:2px solid var(--sys-color-state-focus-ring)}&:hover{border-radius:12px;background:var(--sys-color-state-hover-on-subtle)}&:hover .details,\n  &:focus .details{color:color-mix(in srgb,var(--sys-color-primary),var(--sys-color-state-hover-on-prominent) 6%)}&:hover .bar,\n  &:focus .bar{background-color:color-mix(in srgb,var(--sys-color-primary-bright),var(--sys-color-state-hover-on-prominent) 6%);color:var(--sys-color-on-primary)}}.overview-completed-view .font-info .font-metric{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));grid-gap:12px}.overview-completed-view .font-info ul{padding:0}.overview-completed-view .font-info ul li{grid-template-columns:1fr 4fr}.overview-completed-view .font-info h2{font-size:14px;font-weight:bold;margin:0 0 1em}.overview-completed-view .font-info h3{font-size:13px;font-weight:normal;font-style:italic;margin:0 0 0.5em}.overview-completed-view .font-info{padding-bottom:0}.overview-completed-view .font-family{padding:var(--overview-default-padding)}.overview-completed-view .font-family:nth-child(2n+1){background:var(--sys-color-cdt-base-container)}.overview-completed-view .font-family:first-of-type{padding-top:0}.contrast-warning{display:flex;align-items:center;margin-top:2px}.contrast-warning .threshold-label{font-weight:normal;width:30px}.contrast-warning devtools-icon{margin-left:2px}.contrast-preview{padding:0 5px}.contrast-container-in-grid{display:flex;align-items:center}.contrast-container-in-grid > *{margin-right:5px;min-width:initial}.data .nodeId-column{align-items:center;display:flex;height:20px}.nodeId-column .monospace{overflow:hidden}.show-element{margin:0 0 0 8px;display:none;cursor:pointer;flex:none;--icon-show-element:var(--icon-default)}.show-element:focus,\n.show-element:hover{--icon-show-element:var(--icon-default-hover)}.nodeId-column:focus-within .show-element,\n.nodeId-column:hover .show-element{display:inline-block}.results-section.colors{forced-color-adjust:none}\n/*# sourceURL=${import.meta.resolve("./cssOverviewCompletedView.css")} */\n`},E={cssText:`.overview-sidebar-panel{overflow:auto;display:flex;background:var(--sys-color-cdt-base-container)}.overview-sidebar-panel-container{min-width:fit-content}.overview-sidebar-panel-item{height:30px;padding-left:30px;display:flex;align-items:center;color:var(--sys-color-on-surface);white-space:nowrap;&:hover{background:var(--sys-color-state-hover-on-subtle)}&:focus{background:var(--sys-color-state-focus-highlight)}&.selected{background:var(--sys-color-tonal-container);color:var(--sys-color-on-tonal-container)}}.overview-toolbar{border-bottom:1px solid var(--sys-color-divider);flex:0 0 auto}.overview-sidebar-panel-item:focus-visible{outline-width:unset}@media (forced-colors: active){.overview-sidebar-panel-item.selected{forced-color-adjust:none;background:Highlight;color:HighlightText}.overview-sidebar-panel-item:hover{forced-color-adjust:none;background:Highlight;color:HighlightText}}\n/*# sourceURL=${import.meta.resolve("./cssOverviewSidebarPanel.css")} */\n`};const L={clearOverview:"Clear overview",cssOverviewPanelSidebar:"CSS overview panel sidebar"},F=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewSidebarPanel.ts",L),O=i.i18n.getLocalizedString.bind(void 0,F),R="overview-sidebar-panel-item",V="selected";class P extends(e.ObjectWrapper.eventMixin(n.Widget.VBox)){containerElement;constructor(){super(!0),this.registerRequiredCSS(E),this.contentElement.classList.add("overview-sidebar-panel"),this.contentElement.addEventListener("click",this.#a.bind(this)),this.contentElement.addEventListener("keydown",this.#l.bind(this)),this.containerElement=this.contentElement.createChild("div","overview-sidebar-panel-container"),n.ARIAUtils.setLabel(this.containerElement,O(L.cssOverviewPanelSidebar)),n.ARIAUtils.markAsTree(this.containerElement);const e=new n.Toolbar.ToolbarButton(O(L.clearOverview),"clear",void 0,"css-overview.clear-overview");e.addEventListener("Click",this.#d,this),this.containerElement.createChild("div","overview-toolbar").createChild("devtools-toolbar").appendToolbarItem(e)}addItem(e,t){const i=this.containerElement.createChild("div",R);i.setAttribute("jslog",`${h.item().track({click:!0,keydown:"Enter|ArrowUp|ArrowDown"}).context(`css-overview.${t}`)}`),n.ARIAUtils.markAsTreeitem(i),i.textContent=e,i.dataset.id=t,i.tabIndex=0}#d(){this.dispatchEventToListeners("Reset")}#c(){this.containerElement.querySelectorAll(`.${R}`).forEach(e=>{e.classList.remove(V)})}#a(e){const t=e.composedPath()[0];if(!t.classList.contains(R))return;const{id:i}=t.dataset;i&&(this.select(i,!1),this.dispatchEventToListeners("ItemSelected",{id:i,isMouseEvent:!0,key:void 0}))}#l(e){if("Enter"!==e.key&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key)return;const t=e.composedPath()[0];if(!t.classList.contains(R))return;const{id:i}=t.dataset;if(i){if("Enter"===e.key)this.select(i,!1),this.dispatchEventToListeners("ItemSelected",{id:i,isMouseEvent:!1,key:e.key});else{const t=this.containerElement.querySelectorAll(`.${R}`);let s=-1;for(let e=0;e<t.length;e++)if(t[e].dataset.id===i){s=e;break}if(s<0)return;const o=t[(s+("ArrowDown"===e.key?1:-1))%t.length].dataset.id;if(!o)return;this.select(o,!0),this.dispatchEventToListeners("ItemSelected",{id:o,isMouseEvent:!1,key:e.key})}e.consume(!0)}}select(e,t){const i=this.containerElement.querySelector(`[data-id=${CSS.escape(e)}]`);i&&(i.classList.contains(V)||(this.#c(),i.classList.add(V),t&&(i.contentEditable="true",i.focus(),i.contentEditable="false")))}}var N=Object.freeze({__proto__:null,CSSOverviewSidebarPanel:P});const W={overviewSummary:"Overview summary",colors:"Colors",fontInfo:"Font info",unusedDeclarations:"Unused declarations",mediaQueries:"Media queries",elements:"Elements",externalStylesheets:"External stylesheets",inlineStyleElements:"Inline style elements",styleRules:"Style rules",typeSelectors:"Type selectors",idSelectors:"ID selectors",classSelectors:"Class selectors",universalSelectors:"Universal selectors",attributeSelectors:"Attribute selectors",nonsimpleSelectors:"Non-simple selectors",backgroundColorsS:"Background colors: {PH1}",textColorsS:"Text colors: {PH1}",fillColorsS:"Fill colors: {PH1}",borderColorsS:"Border colors: {PH1}",thereAreNoFonts:"There are no fonts.",thereAreNoUnusedDeclarations:"There are no unused declarations.",thereAreNoMediaQueries:"There are no media queries.",contrastIssues:"Contrast issues",nOccurrences:"{n, plural, =1 {# occurrence} other {# occurrences}}",contrastIssuesS:"Contrast issues: {PH1}",textColorSOverSBackgroundResults:"Text color {PH1} over {PH2} background results in low contrast for {PH3} elements",aa:"AA",aaa:"AAA",apca:"APCA",element:"Element",declaration:"Declaration",source:"Source",contrastRatio:"Contrast ratio",cssOverviewElements:"CSS overview elements",showElement:"Show element"},D=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewCompletedView.ts",W),z=i.i18n.getLocalizedString.bind(void 0,D);function _(e){let{h:t,s:i,l:s}=e.as("hsl");return t=Math.round(360*t),i=Math.round(100*i),s=Math.round(100*s),s=Math.max(0,s-15),`1px solid hsl(${t}deg ${i}% ${s}%)`}class B extends n.Widget.VBox{#h;#n;#v;#u;#p;#g;#m;#f;#w;#b;#S;#y;#x;constructor(e){super(),this.registerRequiredCSS(A),this.#n=e,this.#v=new Intl.NumberFormat("en-US"),this.#h=new n.SplitWidget.SplitWidget(!0,!1,void 0,200),this.#h.show(this.element),this.#u=new n.SplitWidget.SplitWidget(!0,!0),this.#p=new n.Widget.VBox,this.#g=new U,this.#g.addEventListener("TabClosed",e=>{0===e.data&&this.#u.setSidebarMinimized(!0)}),this.#u.setMainWidget(this.#p),this.#u.setSidebarWidget(this.#g),this.#u.setVertical(!1),this.#u.setSecondIsSidebar(!0),this.#u.setSidebarMinimized(!0),this.#u.registerRequiredCSS(A),this.#m=new P,this.#m.setMinimumSize(100,25),this.#h.setSidebarWidget(this.#m),this.#h.setMainWidget(this.#u),this.#b=new c.Linkifier.Linkifier(20,!0),this.#S=new Map,this.#m.addItem(z(W.overviewSummary),"summary"),this.#m.addItem(z(W.colors),"colors"),this.#m.addItem(z(W.fontInfo),"font-info"),this.#m.addItem(z(W.unusedDeclarations),"unused-declarations"),this.#m.addItem(z(W.mediaQueries),"media-queries"),this.#m.select("summary",!1),this.#m.addEventListener("ItemSelected",this.#C,this),this.#m.addEventListener("Reset",this.#k,this),this.#n.addEventListener("Reset",this.#d,this),this.#n.addEventListener("PopulateNodes",this.#$,this),this.#p.element.addEventListener("click",this.#I.bind(this)),this.#y=null}initializeModels(e){const i=e.model(t.CSSModel.CSSModel),s=e.model(t.DOMModel.DOMModel);if(!i||!s)throw new Error("Target must provide CSS and DOM models");this.#f=i,this.#w=s}#C(e){const{data:t}=e,i=this.#x.$(t.id);if(i&&(i.scrollIntoView(),!t.isMouseEvent&&"Enter"===t.key)){const e=i.querySelector('button, [tabindex="0"]');e?.focus()}}#k(){this.#n.dispatchEventToListeners("Reset")}#d(){this.#p.element.removeChildren(),this.#u.setSidebarMinimized(!0),this.#g.closeTabs(),this.#S=new Map,B.pushedNodes.clear(),this.#m.select("summary",!1)}#I(e){if(!e.target)return;const t=e.target.dataset,i=t.type;if(!i||!this.#y)return;let s;switch(i){case"contrast":{const e=t.section,o=t.key;if(!o)return;s={type:i,key:o,nodes:this.#y.textColorContrastIssues.get(o)||[],section:e};break}case"color":{const e=t.color,o=t.section;if(!e)return;let n;switch(o){case"text":n=this.#y.textColors.get(e);break;case"background":n=this.#y.backgroundColors.get(e);break;case"fill":n=this.#y.fillColors.get(e);break;case"border":n=this.#y.borderColors.get(e)}if(!n)return;n=Array.from(n).map(e=>({nodeId:e})),s={type:i,color:e,nodes:n,section:o};break}case"unused-declarations":{const e=t.declaration;if(!e)return;const o=this.#y.unusedDeclarations.get(e);if(!o)return;s={type:i,declaration:e,nodes:o};break}case"media-queries":{const e=t.text;if(!e)return;const o=this.#y.mediaQueries.get(e);if(!o)return;s={type:i,text:e,nodes:o};break}case"font-info":{const e=t.value;if(!t.path)return;const[o,n]=t.path.split("/");if(!e)return;const r=this.#y.fontInfo.get(o);if(!r)return;const a=r.get(n);if(!a)return;const l=a.get(e);if(!l)return;s={type:i,name:`${e} (${o}, ${n})`,nodes:l.map(e=>({nodeId:e}))};break}default:return}e.consume(),this.#n.dispatchEventToListeners("PopulateNodes",{payload:s}),this.#u.setSidebarMinimized(!1)}async#r(e){if(!e||!("backgroundColors"in e)||!("textColors"in e))return;this.#y=e;const{elementCount:t,backgroundColors:i,textColors:s,textColorContrastIssues:o,fillColors:r,borderColors:a,globalStyleStats:l,mediaQueries:d,unusedDeclarations:c,fontInfo:h}=this.#y,v=this.#T(i),u=this.#T(s),p=this.#T(r),g=this.#T(a);this.#x=n.Fragment.Fragment.build`
    <div class="vbox overview-completed-view">
      <div $="summary" class="results-section horizontally-padded summary">
        <h1>${z(W.overviewSummary)}</h1>

        <ul>
          <li>
            <div class="label">${z(W.elements)}</div>
            <div class="value">${this.#v.format(t)}</div>
          </li>
          <li>
            <div class="label">${z(W.externalStylesheets)}</div>
            <div class="value">${this.#v.format(l.externalSheets)}</div>
          </li>
          <li>
            <div class="label">${z(W.inlineStyleElements)}</div>
            <div class="value">${this.#v.format(l.inlineStyles)}</div>
          </li>
          <li>
            <div class="label">${z(W.styleRules)}</div>
            <div class="value">${this.#v.format(l.styleRules)}</div>
          </li>
          <li>
            <div class="label">${z(W.mediaQueries)}</div>
            <div class="value">${this.#v.format(d.size)}</div>
          </li>
          <li>
            <div class="label">${z(W.typeSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.type)}</div>
          </li>
          <li>
            <div class="label">${z(W.idSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.id)}</div>
          </li>
          <li>
            <div class="label">${z(W.classSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.class)}</div>
          </li>
          <li>
            <div class="label">${z(W.universalSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.universal)}</div>
          </li>
          <li>
            <div class="label">${z(W.attributeSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.attribute)}</div>
          </li>
          <li>
            <div class="label">${z(W.nonsimpleSelectors)}</div>
            <div class="value">${this.#v.format(l.stats.nonSimple)}</div>
          </li>
        </ul>
      </div>

      <div $="colors" class="results-section horizontally-padded colors">
        <h1>${z(W.colors)}</h1>
        <h2>${z(W.backgroundColorsS,{PH1:v.length})}</h2>
        <ul>
          ${v.map(this.#z.bind(this,"background"))}
        </ul>

        <h2>${z(W.textColorsS,{PH1:u.length})}</h2>
        <ul>
          ${u.map(this.#z.bind(this,"text"))}
        </ul>

        ${o.size>0?this.#W(o):""}

        <h2>${z(W.fillColorsS,{PH1:p.length})}</h2>
        <ul>
          ${p.map(this.#z.bind(this,"fill"))}
        </ul>

        <h2>${z(W.borderColorsS,{PH1:g.length})}</h2>
        <ul>
          ${g.map(this.#z.bind(this,"border"))}
        </ul>
      </div>

      <div $="font-info" class="results-section font-info">
        <h1>${z(W.fontInfo)}</h1>
        ${h.size>0?this.#E(h):n.Fragment.Fragment.build`<div>${z(W.thereAreNoFonts)}</div>`}
      </div>

      <div $="unused-declarations" class="results-section unused-declarations">
        <h1>${z(W.unusedDeclarations)}</h1>
        ${c.size>0?this.#A(c,"unused-declarations","declaration"):n.Fragment.Fragment.build`<div class="horizontally-padded">${z(W.thereAreNoUnusedDeclarations)}</div>`}
      </div>

      <div $="media-queries" class="results-section media-queries">
        <h1>${z(W.mediaQueries)}</h1>
        ${d.size>0?this.#A(d,"media-queries","text"):n.Fragment.Fragment.build`<div class="horizontally-padded">${z(W.thereAreNoMediaQueries)}</div>`}
      </div>
    </div>`,this.#p.element.appendChild(this.#x.element())}#$(e){const{payload:t}=e.data;let i="",s="";switch(t.type){case"contrast":{const{section:e,key:o}=t;i=`${e}-${o}`,s=z(W.contrastIssues);break}case"color":{const{section:e,color:o}=t;i=`${e}-${o}`,s=`${o.toUpperCase()} (${e})`;break}case"unused-declarations":{const{declaration:e}=t;i=`${e}`,s=`${e}`;break}case"media-queries":{const{text:e}=t;i=`${e}`,s=`${e}`;break}case"font-info":{const{name:e}=t;i=`${e}`,s=`${e}`;break}}let o=this.#S.get(i);if(!o){if(!this.#w||!this.#f)throw new Error("Unable to initialize CSS overview, missing models");o=new j(this.#n,this.#w,this.#f,this.#b),o.populateNodes(t.nodes),this.#S.set(i,o)}this.#g.appendTab(i,s,o,t.type)}#E(e){const t=Array.from(e.entries());return n.Fragment.Fragment.build`
  ${t.map(([e,t])=>n.Fragment.Fragment.build`<section class="font-family"><h2>${e}</h2> ${this.#M(e,t)}</section>`)}
  `}#M(e,t){const i=Array.from(t.entries());return n.Fragment.Fragment.build`
  <div class="font-metric">
  ${i.map(([t,i])=>{const s=`${e}/${t}`;return n.Fragment.Fragment.build`
  <div>
  <h3>${t}</h3>
  ${this.#A(i,"font-info","value",s)}
  </div>`})}
  </div>`}#A(e,t,i,s=""){const o=Array.from(e.entries()).sort((e,t)=>{const i=e[1];return t[1].length-i.length}),r=o.reduce((e,t)=>e+t[1].length,0);return n.Fragment.Fragment.build`<ul aria-label="${t}">
    ${o.map(([e,o])=>{const a=100*o.length/r,l=z(W.nOccurrences,{n:o.length});return n.Fragment.Fragment.build`<li>
        <div class="title">${e}</div>
        <button data-type="${t}" data-path="${s}" data-${i}="${e}"
        jslog="${h.action().track({click:!0}).context(`css-overview.${t}`)}"
        aria-label="${e}: ${l}">
          <div class="details">${l}</div>
          <div class="bar-container">
            <div class="bar" style="width: ${a}%;"></div>
          </div>
        </button>
      </li>`})}
    </ul>`}#W(e){return n.Fragment.Fragment.build`
  <h2>${z(W.contrastIssuesS,{PH1:e.size})}</h2>
  <ul>
  ${[...e.entries()].map(([e,t])=>this.#L(e,t))}
  </ul>
  `}#L(e,t){console.assert(t.length>0);let i=t[0];for(const e of t)Math.abs(e.contrastRatio)<Math.abs(i.contrastRatio)&&(i=e);const s=i.textColor.asString("hexa"),r=i.backgroundColor.asString("hexa"),a=o.Runtime.experiments.isEnabled("apca"),l=z(W.textColorSOverSBackgroundResults,{PH1:s,PH2:r,PH3:t.length}),d=n.Fragment.Fragment.build`<li>
      <button
        title="${l}" aria-label="${l}"
        data-type="contrast" data-key="${e}" data-section="contrast" class="block" $="color"
        jslog="${h.action("css-overview.contrast").track({click:!0})}">
        Text
      </button>
      <div class="block-title">
        <div class="contrast-warning hidden" $="aa"><span class="threshold-label">${z(W.aa)}</span></div>
        <div class="contrast-warning hidden" $="aaa"><span class="threshold-label">${z(W.aaa)}</span></div>
        <div class="contrast-warning hidden" $="apca"><span class="threshold-label">${z(W.apca)}</span></div>
      </div>
    </li>`;if(a){const e=d.$("apca");i.thresholdsViolated.apca?e.appendChild(q()):e.appendChild(G()),e.classList.remove("hidden")}else{const e=d.$("aa");i.thresholdsViolated.aa?e.appendChild(q()):e.appendChild(G());const t=d.$("aaa");i.thresholdsViolated.aaa?t.appendChild(q()):t.appendChild(G()),e.classList.remove("hidden"),t.classList.remove("hidden")}const c=d.$("color");return c.style.backgroundColor=r,c.style.color=s,c.style.border=_(i.backgroundColor.asLegacyColor()),d}#z(t,i){const s=n.Fragment.Fragment.build`<li>
      <button title=${i} data-type="color" data-color="${i}"
        data-section="${t}" class="block" $="color"
        jslog="${h.action("css-overview.color").track({click:!0})}"></button>
      <div class="block-title color-text">${i}</div>
    </li>`,o=s.$("color");o.style.backgroundColor=i;const r=e.Color.parse(i)?.asLegacyColor();if(r)return o.style.border=_(r),s}#T(t){return Array.from(t.keys()).sort((t,i)=>{const s=e.Color.parse(t)?.asLegacyColor(),o=e.Color.parse(i)?.asLegacyColor();return s&&o?e.ColorUtils.luminance(o.rgba())-e.ColorUtils.luminance(s.rgba()):0})}setOverviewData(e){this.#r(e)}static pushedNodes=new Set}class U extends(e.ObjectWrapper.eventMixin(n.Widget.VBox)){#R;constructor(){super(),this.#R=new n.TabbedPane.TabbedPane,this.#R.show(this.element),this.#R.addEventListener(n.TabbedPane.Events.TabClosed,()=>{this.dispatchEventToListeners("TabClosed",this.#R.tabIds().length)})}appendTab(e,t,i,s){this.#R.hasTab(e)||this.#R.appendTab(e,t,i,void 0,void 0,!0,void 0,void 0,s),this.#R.selectTab(e)}closeTabs(){this.#R.closeTabs(this.#R.tabIds())}}class j extends n.Widget.Widget{#n;#w;#f;#b;#O;#P;constructor(e,t,i,s){super(),this.#n=e,this.#w=t,this.#f=i,this.#b=s,this.#O=[{id:"node-id",title:z(W.element),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"declaration",title:z(W.declaration),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"source-url",title:z(W.source),sortable:!1,weight:100,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"contrast-ratio",title:z(W.contrastRatio),sortable:!0,weight:25,titleDOMFragment:void 0,sort:void 0,align:void 0,width:"150px",fixedWidth:!0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}],this.#P=new d.SortableDataGrid.SortableDataGrid({displayName:z(W.cssOverviewElements),columns:this.#O,deleteCallback:void 0,refreshCallback:void 0}),this.#P.element.classList.add("element-grid"),this.#P.element.addEventListener("mouseover",this.#F.bind(this)),this.#P.setStriped(!0),this.#P.addEventListener("SortingChanged",this.#_.bind(this)),this.#P.asWidget().show(this.element)}#_(){const e=this.#P.sortColumnId();if(!e)return;const t=d.SortableDataGrid.SortableDataGrid.StringComparator.bind(null,e);this.#P.sortNodes(t,!this.#P.isSortOrderAscending())}#F(e){const t=e.composedPath().find(e=>e.dataset?.backendNodeId);if(!t)return;const i=Number(t.dataset.backendNodeId);this.#n.dispatchEventToListeners("RequestNodeHighlight",i)}async populateNodes(e){if(this.#P.rootNode().removeChildren(),!e.length)return;const[t]=e,i=new Set;let s;if("nodeId"in t&&t.nodeId&&i.add("node-id"),"declaration"in t&&t.declaration&&i.add("declaration"),"sourceURL"in t&&t.sourceURL&&i.add("source-url"),"contrastRatio"in t&&t.contrastRatio&&i.add("contrast-ratio"),"nodeId"in t&&i.has("node-id")){const t=e.reduce((e,t)=>{const i=t.nodeId;return B.pushedNodes.has(i)?e:(B.pushedNodes.add(i),e.add(i))},new Set);s=await this.#w.pushNodesByBackendIdsToFrontend(t)}for(const t of e){let e;if("nodeId"in t&&i.has("node-id")){if(!s)continue;if(e=s.get(t.nodeId),!e)continue}const o=new H(t,e,this.#b,this.#f);o.selectable=!1,this.#P.insertChild(o)}this.#P.setColumnsVisibility(i),this.#P.renderInline(),this.#P.wasShown()}}class H extends d.SortableDataGrid.SortableDataGridNode{#b;#f;#N;constructor(e,t,i,s){super(e),this.#N=t,this.#b=i,this.#f=s}createCell(t){const i=this.#N;if("node-id"===t){const s=this.createTD(t);if(s.textContent="...",!i)throw new Error("Node entry is missing a related frontend node.");return e.Linkifier.Linkifier.linkify(i).then(e=>{s.textContent="",e.dataset.backendNodeId=i.backendNodeId().toString(),s.appendChild(e);const t=new l.Icon.Icon;t.data={iconName:"select-element",color:"var(--icon-show-element)",width:"16px"},t.classList.add("show-element"),n.Tooltip.Tooltip.install(t,z(W.showElement)),t.tabIndex=0,t.onclick=()=>i.scrollIntoView(),s.appendChild(t)}),s}if("source-url"===t){const e=this.createTD(t);if(this.data.range){const t=this.#U(this.#f,this.#b,this.data.styleSheetId,a.TextRange.TextRange.fromObject(this.data.range));t&&""!==t.textContent?e.appendChild(t):e.textContent="(unable to link)"}else e.textContent="(unable to link to inlined styles)";return e}if("contrast-ratio"===t){const e=this.createTD(t),i=o.Runtime.experiments.isEnabled("apca"),s=r.NumberUtilities.floor(this.data.contrastRatio,2),a=i?s+"%":s,l=_(this.data.backgroundColor),d=this.data.textColor.asString(),c=this.data.backgroundColor.asString(),h=n.Fragment.Fragment.build`
        <div class="contrast-container-in-grid" $="container">
          <span class="contrast-preview" style="border: ${l};
          color: ${d};
          background-color: ${c};">Aa</span>
          <span>${a}</span>
        </div>
      `,v=h.$("container");return i?(v.append(n.Fragment.Fragment.build`<span>${z(W.apca)}</span>`.element()),this.data.thresholdsViolated.apca?v.appendChild(q()):v.appendChild(G())):(v.append(n.Fragment.Fragment.build`<span>${z(W.aa)}</span>`.element()),this.data.thresholdsViolated.aa?v.appendChild(q()):v.appendChild(G()),v.append(n.Fragment.Fragment.build`<span>${z(W.aaa)}</span>`.element()),this.data.thresholdsViolated.aaa?v.appendChild(q()):v.appendChild(G())),e.appendChild(h.element()),e}return super.createCell(t)}#U(e,i,s,o){const n=e.styleSheetHeaderForId(s);if(!n)return;const r=n.lineNumberInSource(o.startLine),a=n.columnNumberInSource(o.startLine,o.startColumn),l=new t.CSSModel.CSSLocation(n,r,a);return i.linkifyCSSLocation(l)}}function q(){const e=new l.Icon.Icon;return e.data={iconName:"clear",color:"var(--icon-error)",width:"14px",height:"14px"},e}function G(){const e=new l.Icon.Icon;return e.data={iconName:"checkmark",color:"var(--icon-checkmark-green)",width:"14px",height:"14px"},e}var Q=Object.freeze({__proto__:null,CSSOverviewCompletedView:B,DetailsView:U,ElementDetailsView:j,ElementNode:H}),K={cssText:`.css-overview-panel{overflow:hidden}devtools-css-overview-start-view{overflow:auto}\n/*# sourceURL=${import.meta.resolve("./cssOverview.css")} */\n`};class J extends n.Panel.Panel{#n;#D;#j;#V;#q;#H;#B;#G;#Q;#K;#J;#X;#Y;#Z;#ee;constructor(e){super("css-overview"),this.registerRequiredCSS(K),this.element.classList.add("css-overview-panel"),this.#n=e,this.#D=new v.CSSOverviewStartView.CSSOverviewStartView,this.#D.addEventListener("overviewstartrequested",()=>this.#n.dispatchEventToListeners("RequestOverviewStart")),this.#j=new T(this.#n),this.#V=new B(this.#n),t.TargetManager.TargetManager.instance().observeTargets(this),this.#n.addEventListener("RequestOverviewStart",e=>{u.userMetrics.actionTaken(u.UserMetrics.Action.CaptureCssOverviewClicked),this.#te()},this),this.#n.addEventListener("OverviewCompleted",this.#ie,this),this.#n.addEventListener("Reset",this.#d,this),this.#n.addEventListener("RequestNodeHighlight",this.#se,this),this.#d()}targetAdded(e){if(e!==t.TargetManager.TargetManager.instance().primaryPageTarget())return;this.#V.initializeModels(e);const i=e.model(S);this.#q=i}targetRemoved(){}#oe(){if(!this.#q)throw new Error("Did not retrieve model information yet.");return this.#q}#d(){this.#H=new Map,this.#B=new Map,this.#G=new Map,this.#Q=new Map,this.#K=new Map,this.#J=new Map,this.#X=new Map,this.#Y=0,this.#Z={styleRules:0,inlineStyles:0,externalSheets:0,stats:{type:0,class:0,id:0,universal:0,attribute:0,nonSimple:0}},this.#ee=new Map,this.#ne()}#se(e){this.#oe().highlightNode(e.data)}#ne(){this.#j.hideWidget(),this.#V.hideWidget(),this.contentElement.append(this.#D),this.#D.show()}#re(){this.#D.hide(),this.#V.hideWidget(),this.#j.show(this.contentElement)}#ae(){this.#D.hide(),this.#j.hideWidget(),this.#V.show(this.contentElement),this.#V.setOverviewData({backgroundColors:this.#H,textColors:this.#B,textColorContrastIssues:this.#ee,fillColors:this.#G,borderColors:this.#Q,globalStyleStats:this.#Z,fontInfo:this.#K,elementCount:this.#Y,mediaQueries:this.#J,unusedDeclarations:this.#X})}async#te(){this.#re();const e=this.#oe(),[t,{elementCount:i,backgroundColors:s,textColors:o,textColorContrastIssues:n,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d},c]=await Promise.all([e.getGlobalStylesheetStats(),e.getNodeStyleStats(),e.getMediaQueries()]);i&&(this.#Y=i),t&&(this.#Z=t),c&&(this.#J=c),s&&(this.#H=s),o&&(this.#B=o),n&&(this.#ee=n),r&&(this.#G=r),a&&(this.#Q=a),l&&(this.#K=l),d&&(this.#X=d),this.#n.dispatchEventToListeners("OverviewCompleted")}#ie(){this.#ae()}}var X=Object.freeze({__proto__:null,CSSOverviewPanel:J});export{Q as CSSOverviewCompletedView,m as CSSOverviewController,y as CSSOverviewModel,X as CSSOverviewPanel,M as CSSOverviewProcessingView,N as CSSOverviewSidebarPanel,C as CSSOverviewUnusedDeclarations};