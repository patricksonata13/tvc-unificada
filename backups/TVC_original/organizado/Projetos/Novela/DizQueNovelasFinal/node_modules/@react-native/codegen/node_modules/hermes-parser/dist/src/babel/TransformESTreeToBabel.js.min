"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformProgram=transformProgram;var _SimpleTransform=require("../transform/SimpleTransform"),_SimpleTraverser=require("../traverse/SimpleTraverser"),_ESTreeVisitorKeys=_interopRequireDefault(require("../generated/ESTreeVisitorKeys")),_createSyntaxError=require("../utils/createSyntaxError");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const EMPTY_PARENT=null,FlowESTreeAndBabelVisitorKeys={..._ESTreeVisitorKeys.default,BigIntLiteral:[],BlockStatement:["directives",..._ESTreeVisitorKeys.default.BlockStatement],BooleanLiteral:[],ClassMethod:["key","params","body","returnType","typeParameters"],ClassPrivateMethod:["key","params","body","returnType","typeParameters"],ClassProperty:["key","value","typeAnnotation","variance"],ClassPrivateProperty:["key","value","typeAnnotation","variance"],Directive:["value"],DirectiveLiteral:[],ExportNamespaceSpecifier:["exported"],File:["program","comments"],Import:[],NullLiteral:[],NumericLiteral:[],ObjectMethod:[..._ESTreeVisitorKeys.default.Property,"params","body","returnType","typeParameters"],ObjectProperty:_ESTreeVisitorKeys.default.Property,OptionalCallExpression:["callee","arguments","typeArguments"],OptionalMemberExpression:["object","property"],PrivateName:["id"],Program:["directives",..._ESTreeVisitorKeys.default.Program],RegExpLiteral:[],RestElement:[..._ESTreeVisitorKeys.default.RestElement,"typeAnnotation"],StringLiteral:[],CommentBlock:[],CommentLine:[]};function nodeWith(e,t){return _SimpleTransform.SimpleTransform.nodeWith(e,t,FlowESTreeAndBabelVisitorKeys)}function fixSourceLocation(e,t){const r=e.loc;null!=r&&(e.loc={start:r.start,end:r.end},"Identifier"===e.type&&(e.loc.identifierName=e.name),e.start=e.range[0],e.end=e.range[1],delete e.range,delete e.parent)}function mapNodeWithDirectives(e){if(null!=e.directives)return e;const t=[];for(const r of e.body){if("ExpressionStatement"!==r.type||null==r.directive)break;t.push({type:"Directive",value:{type:"DirectiveLiteral",value:r.directive,extra:{rawValue:r.directive,raw:"Literal"===r.expression.type?r.expression.raw:""},loc:r.expression.loc,range:r.expression.range,parent:null},loc:r.loc,range:r.range,parent:e})}return nodeWith(e,{directives:t,body:0===t.length?e.body:e.body.slice(t.length)})}function mapProgram(e){var t;const r=mapNodeWithDirectives(e);let n=r.loc.end,a=r.range[1];if(r.comments.length>0){const e=r.comments[r.comments.length-1];e.range[1]>a&&(n=e.loc.end,a=e.range[1])}const o={start:{line:1,column:0},end:n},l=[0,a],i=r.comments.map(e=>{switch(e.type){case"Line":return{type:"CommentLine",value:e.value,loc:e.loc,range:e.range};case"Block":return{type:"CommentBlock",value:e.value,loc:e.loc,range:e.range}}});return{type:"File",program:{type:"Program",body:r.body,directives:null!=(t=r.directives)?t:[],sourceType:r.sourceType,interpreter:r.interpreter,loc:o,range:l,parent:null},comments:i,loc:o,range:l,parent:null}}function mapTemplateElement(e){const t=e.tail?1:2;return e.loc={start:{line:e.loc.start.line,column:e.loc.start.column+1},end:{line:e.loc.end.line,column:e.loc.end.column-t}},e.range=[e.range[0]+1,e.range[1]-t],e}function mapProperty(e){const t=e.key,r=e.value;if(e.method||"init"!==e.kind){if("FunctionExpression"!==r.type)throw(0,_createSyntaxError.createSyntaxError)(e,`Invalid method property, the value must be a "FunctionExpression" or "ArrowFunctionExpression. Instead got "${r.type}".`);const n={type:"ObjectMethod",kind:"init"===e.kind?"method":e.kind,method:"init"===e.kind,computed:e.computed,key:t,id:null,params:r.params,body:r.body,async:r.async,generator:r.generator,returnType:r.returnType,typeParameters:r.typeParameters,loc:e.loc,range:e.range,parent:e.parent};return"init"!==e.kind&&(n.variance=null),n}return{type:"ObjectProperty",computed:e.computed,key:e.key,value:e.value,method:e.method,shorthand:e.shorthand,loc:e.loc,range:e.range,parent:e.parent}}function mapMethodDefinition(e){const t=e.value,r={kind:e.kind,computed:e.computed,static:e.static,key:e.key,id:null,params:t.params,body:t.body,async:t.async,generator:t.generator,returnType:t.returnType,typeParameters:t.typeParameters,predicate:null,loc:e.loc,range:e.range,parent:e.parent};return"PrivateIdentifier"===e.key.type?{...r,type:"ClassPrivateMethod"}:{...r,type:"ClassMethod"}}function mapExportAllDeclaration(e){return null!=e.exported?{type:"ExportNamedDeclaration",declaration:null,specifiers:[{type:"ExportNamespaceSpecifier",exported:e.exported,loc:{start:{column:e.loc.start.column+7,line:e.loc.start.line},end:e.exported.loc.end},range:[e.range[0]+7,e.exported.range[1]],parent:null}],source:e.source,exportKind:e.exportKind,loc:e.loc,range:e.range,parent:e.parent}:(delete e.exported,e)}function mapRestElement(e){const t=e.argument;if(("Identifier"===t.type||"ObjectPattern"===t.type||"ArrayPattern"===t.type)&&null!=t.typeAnnotation){const r=t.range;let n=t.loc;return"Identifier"===t.type&&(r[1]=r[0]+t.name.length,n={start:n.start,end:{line:n.start.line,column:n.start.column+t.name.length}}),nodeWith(e,{typeAnnotation:t.typeAnnotation,argument:nodeWith(t,{typeAnnotation:null,range:r,loc:n})})}return e}function mapImportExpression(e){return{type:"CallExpression",callee:{type:"Import",loc:{start:e.loc.start,end:{line:e.loc.start.line,column:e.loc.start.column+6}},range:[e.range[0],e.range[0]+6],parent:null},arguments:[e.source],loc:e.loc,range:e.range,parent:e.parent}}function mapPrivateIdentifier(e){return{type:"PrivateName",id:{type:"Identifier",name:e.name,optional:!1,typeAnnotation:null,loc:{start:{line:e.loc.start.line,column:e.loc.start.column+1},end:e.loc.end},range:[e.range[0]+1,e.range[1]],parent:null},loc:e.loc,range:e.range,parent:e.parent}}function mapPropertyDefinition(e){return"PrivateIdentifier"===e.key.type?{type:"ClassPrivateProperty",key:mapPrivateIdentifier(e.key),value:e.value,typeAnnotation:e.typeAnnotation,static:e.static,variance:e.variance,loc:e.loc,range:e.range,parent:e.parent}:{type:"ClassProperty",key:e.key,value:e.value,typeAnnotation:e.typeAnnotation,static:e.static,variance:e.variance,declare:e.declare,optional:e.optional,computed:e.computed,loc:e.loc,range:e.range,parent:e.parent}}function mapTypeofTypeAnnotation(e){return delete e.typeArguments,"GenericTypeAnnotation"!==e.argument.type?nodeWith(e,{argument:{type:"GenericTypeAnnotation",id:e.argument,typeParameters:null,loc:e.argument.loc,range:e.argument.range,parent:null}}):e}function mapDeclareVariable(e){return null!=e.kind&&delete e.kind,e}function mapJSXElement(e){return null!=e.openingElement.typeArguments&&delete e.openingElement.typeArguments,e}function mapChainExpressionInnerNode(e){switch(e.type){case"MemberExpression":{const t=mapChainExpressionInnerNode(e.object);return e.optional||"OptionalMemberExpression"===t.type||"OptionalCallExpression"===t.type?{type:"OptionalMemberExpression",object:t,property:e.property,computed:e.computed,optional:e.optional,loc:e.loc,range:e.range,parent:e.parent}:e}case"CallExpression":{const t=mapChainExpressionInnerNode(e.callee);return e.optional||"OptionalMemberExpression"===t.type||"OptionalCallExpression"===t.type?{type:"OptionalCallExpression",callee:t,optional:e.optional,arguments:e.arguments,typeArguments:e.typeArguments,loc:e.loc,range:e.range,parent:e.parent}:e}default:return e}}function mapChainExpression(e){return mapChainExpressionInnerNode(e.expression)}function mapLiteral(e){const t={loc:e.loc,range:e.range,parent:e.parent};switch(e.literalType){case"string":return{type:"StringLiteral",value:e.value,extra:{rawValue:e.value,raw:e.raw},...t};case"numeric":return{type:"NumericLiteral",value:e.value,extra:{rawValue:e.value,raw:e.raw},...t};case"bigint":return{type:"BigIntLiteral",value:e.bigint,extra:{rawValue:e.bigint,raw:e.raw},...t};case"boolean":return{type:"BooleanLiteral",value:e.value,...t};case"null":return{type:"NullLiteral",...t};case"regexp":return{type:"RegExpLiteral",extra:{raw:e.raw},pattern:e.regex.pattern,flags:e.regex.flags,...t}}}function transformNode(e){switch(e.type){case"Program":var t;return"File"===(null==(t=e.parent)?void 0:t.type)?e:mapProgram(e);case"BlockStatement":return mapNodeWithDirectives(e);case"Property":return mapProperty(e);case"TemplateElement":return mapTemplateElement(e);case"MethodDefinition":return mapMethodDefinition(e);case"ExportAllDeclaration":return mapExportAllDeclaration(e);case"RestElement":return mapRestElement(e);case"ImportExpression":return mapImportExpression(e);case"PrivateIdentifier":return mapPrivateIdentifier(e);case"PropertyDefinition":return mapPropertyDefinition(e);case"TypeofTypeAnnotation":return mapTypeofTypeAnnotation(e);case"DeclareVariable":return mapDeclareVariable(e);case"JSXElement":return mapJSXElement(e);case"Literal":return mapLiteral(e);case"ChainExpression":return mapChainExpression(e);case"TypeCastExpression":return e.loc.start.column=e.loc.start.column+1,e.loc.end.column=e.loc.end.column-1,e.range=[e.range[0]+1,e.range[1]-1],e;case"AsExpression":{const{typeAnnotation:t}=e;return e.type="TypeCastExpression",e.typeAnnotation={type:"TypeAnnotation",typeAnnotation:t,loc:t.loc,range:t.range},e}case"AsConstExpression":return e.expression;case"NumberLiteralTypeAnnotation":case"StringLiteralTypeAnnotation":case"JSXText":return e.extra={rawValue:e.value,raw:e.raw},delete e.raw,e;case"BigIntLiteralTypeAnnotation":return e.extra={rawValue:e.bigint,raw:e.raw},delete e.bigint,delete e.raw,e;case"BooleanLiteralTypeAnnotation":return delete e.raw,e;case"TupleTypeAnnotation":return delete e.inexact,e;case"Identifier":return!1!==e.optional&&null!=e.optional||delete e.optional,null==e.typeAnnotation&&delete e.typeAnnotation,e;case"CallExpression":return!1===e.optional&&delete e.optional,null==e.typeArguments&&delete e.typeArguments,e;case"OptionalCallExpression":case"JSXOpeningElement":return null==e.typeArguments&&delete e.typeArguments,e;case"MemberExpression":return delete e.optional,e;case"ExpressionStatement":return delete e.directive,e;case"ObjectPattern":case"ArrayPattern":case"ClassPrivateProperty":return null==e.typeAnnotation&&delete e.typeAnnotation,e;case"FunctionDeclaration":case"FunctionExpression":case"ArrowFunctionExpression":case"ClassMethod":return delete e.expression,null==e.predicate&&delete e.predicate,null==e.returnType&&delete e.returnType,null==e.typeParameters&&delete e.typeParameters,e;case"ObjectMethod":return null==e.returnType&&delete e.returnType,null==e.typeParameters&&delete e.typeParameters,e;case"ClassPrivateMethod":return!1===e.computed&&delete e.computed,null==e.predicate&&delete e.predicate,null==e.returnType&&delete e.returnType,null==e.typeParameters&&delete e.typeParameters,e;case"ClassExpression":case"ClassDeclaration":return null!=e.decorators&&0!==e.decorators.length||delete e.decorators,null!=e.implements&&0!==e.implements.length||delete e.implements,null==e.superTypeParameters&&delete e.superTypeParameters,null==e.typeParameters&&delete e.typeParameters,e;case"ClassProperty":return!1===e.optional&&delete e.optional,!1===e.declare&&delete e.declare,null==e.typeAnnotation&&delete e.typeAnnotation,e;case"ExportNamedDeclaration":return null==e.declaration&&delete e.declaration,e;case"ImportDeclaration":return null!=e.assertions&&0!==e.assertions.length||delete e.assertions,e;case"ArrayExpression":return delete e.trailingComma,e;default:return e}}function transformProgram(e,t){var r;const n=_SimpleTransform.SimpleTransform.transform(e,{transform:e=>transformNode(e),visitorKeys:FlowESTreeAndBabelVisitorKeys});if(_SimpleTraverser.SimpleTraverser.traverse(n,{enter(e){fixSourceLocation(e,t)},leave(){},visitorKeys:FlowESTreeAndBabelVisitorKeys}),"File"===(null==n?void 0:n.type))return n;throw new Error(`Unknown AST node of type "${null!=(r=null==n?void 0:n.type)?r:"NULL"}" returned from Babel conversion`)}