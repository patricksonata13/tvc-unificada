import*as e from"../../../core/common/common.js";import*as t from"../../../core/i18n/i18n.js";import*as r from"../../../third_party/puppeteer-replay/puppeteer-replay.js";import{AssertedEventType as s,SelectorType as n,StepType as i}from"../../../third_party/puppeteer-replay/puppeteer-replay.js";import*as a from"../../../ui/legacy/legacy.js";import*as o from"../../../core/sdk/sdk.js";import*as c from"../../../services/puppeteer/puppeteer.js";import*as d from"../../../core/platform/platform.js";import*as l from"../util/util.js";var g=Object.freeze({__proto__:null}),p=Object.freeze({__proto__:null,AssertedEventType:s,SelectorType:n,StepType:i});const h={defaultRecordingName:"Recording {DATE} at {TIME}"},u=t.i18n.registerUIStrings("panels/recorder/models/RecorderSettings.ts",h),m=t.i18n.getLocalizedString.bind(void 0,u);var f=Object.freeze({__proto__:null,RecorderSettings:class{#e=e.Settings.Settings.instance().createSetting("recorder-selector-attribute","");#t=e.Settings.Settings.instance().createSetting("recorder-panel-replay-speed","normal");#r=e.Settings.Settings.instance().createSetting("recorder-panel-replay-extension","");#s=new Map;#i=e.Settings.Settings.instance().createSetting("recorder-preferred-copy-format","json");constructor(){for(const t of Object.values(n))this.#s.set(t,e.Settings.Settings.instance().createSetting(`recorder-${t}-selector-enabled`,!0))}get selectorAttribute(){return this.#e.get()}set selectorAttribute(e){this.#e.set(e)}get speed(){return this.#t.get()}set speed(e){this.#t.set(e)}get replayExtension(){return this.#r.get()}set replayExtension(e){this.#r.set(e)}get defaultTitle(){const e=new Date;return m(h.defaultRecordingName,{DATE:e.toLocaleDateString(),TIME:e.toLocaleTimeString()})}get defaultSelectors(){return Object.values(n).filter(e=>this.getSelectorByType(e))}getSelectorByType(e){return this.#s.get(e)?.get()}setSelectorByType(e,t){this.#s.get(e)?.set(t)}get preferredCopyFormat(){return this.#i.get()}set preferredCopyFormat(e){this.#i.set(e)}}}),y=Object.freeze({__proto__:null,RecorderShortcutHelper:class{#o;#n=null;#a;constructor(e=200){this.#a=e,this.#o=new AbortController}#c(){this.#o.abort(),this.#n&&clearTimeout(this.#n),this.#o=new AbortController}#d(e){this.#c(),e()}handleShortcut(e){this.#c(),document.addEventListener("keyup",t=>{a.KeyboardShortcut.KeyboardShortcut.eventHasCtrlEquivalentKey(t)&&this.#d(e)},{signal:this.#o.signal}),this.#n=setTimeout(()=>this.#d(e),this.#a)}}});const w={normal:0,slow:500,very_slow:1e3,extremely_slow:2e3};function v(t){return e.ParsedURL.schemeIs(t.url,"devtools:")||"page"===t.type||"background_page"===t.type||"webview"===t.type}class T extends e.ObjectWrapper.ObjectWrapper{userFlow;speed;timeout;breakpointIndexes;steppingOver=!1;aborted=!1;#l=Promise.withResolvers();#h=Promise.withResolvers();#u;constructor(e,{speed:t,breakpointIndexes:r=new Set}){super(),this.userFlow=e,this.speed=t,this.timeout=e.timeout||5e3,this.breakpointIndexes=r}#g(){this.#l.resolve(),this.#l=Promise.withResolvers()}static async connectPuppeteer(){const e=o.TargetManager.TargetManager.instance().rootTarget();if(!e)throw new Error("Could not find the root target");const t=o.TargetManager.TargetManager.instance().primaryPageTarget();if(!t)throw new Error("Could not find the primary page target");const r=t.model(o.ChildTargetManager.ChildTargetManager);if(!r)throw new Error("Could not get childTargetManager");const s=t.model(o.ResourceTreeModel.ResourceTreeModel);if(!s)throw new Error("Could not get resource tree model");if(!s.mainFrame)throw new Error("Could not find main frame");const i=e.model(o.ChildTargetManager.ChildTargetManager);if(!i)throw new Error("Could not find the child target manager class for the root target");const n=(await i.createParallelConnection(()=>{})).connection,a=await r.getParentTargetId(),d=await i.getParentTargetId(),{page:l,browser:h,puppeteerConnection:u}=await c.PuppeteerConnection.PuppeteerConnectionHelper.connectPuppeteerToConnectionViaTab({connection:n,rootTargetId:d,isPageTargetCallback:v});if(!l)throw new Error("could not find main page!");return h.on("targetdiscovered",e=>{"page"===e.type&&e.targetId!==a&&e.openerId===a&&u._createSession(e,!0)}),{page:l,browser:h}}static async disconnectPuppeteer(e){try{const t=await e.pages();for(const e of t){const t=e._client();await t.send("Network.disable"),await t.send("Page.disable"),await t.send("Log.disable"),await t.send("Performance.disable"),await t.send("Runtime.disable"),await t.send("Emulation.clearDeviceMetricsOverride"),await t.send("Emulation.setAutomationOverride",{enabled:!1});for(const t of e.frames()){const e=t.client;await e.send("Network.disable"),await e.send("Page.disable"),await e.send("Log.disable"),await e.send("Performance.disable"),await e.send("Runtime.disable"),await e.send("Emulation.setAutomationOverride",{enabled:!1})}}await e.disconnect()}catch(e){console.error("Error disconnecting Puppeteer",e.message)}}async stop(){await Promise.race([this.#l,this.#h])}get abortPromise(){return this.#h.promise}abort(){this.aborted=!0,this.#h.resolve(),this.#u?.abort()}disposeForTesting(){this.#l.resolve(),this.#h.resolve()}continue(){this.steppingOver=!1,this.#g()}stepOver(){this.steppingOver=!0,this.#g()}updateBreakpointIndexes(e){this.breakpointIndexes=e}async play(){const{page:t,browser:s}=await T.connectPuppeteer();this.aborted=!1;const i=this;class o extends r.PuppeteerRunnerExtension{#t;constructor(e,t,{timeout:r,speed:s}){super(e,t,{timeout:r}),this.#t=s}async beforeEachStep(e,t){const{resolve:r,promise:s}=Promise.withResolvers();i.dispatchEventToListeners("Step",{step:e,resolve:r}),await s;const o=t.steps.indexOf(e),n=i.steppingOver||i.breakpointIndexes.has(o),a="setViewport"!==e.type&&"navigate"!==e.type&&!i.aborted;n?(i.dispatchEventToListeners("Stop"),await i.stop(),i.dispatchEventToListeners("Continue")):a&&await Promise.race([new Promise(e=>setTimeout(e,w[this.#t])),i.abortPromise])}async runStep(r,s){if(!e.ParsedURL.schemeIs(t?.url(),"devtools:")||"setViewport"!==r.type&&"navigate"!==r.type){if("navigate"===r.type&&e.ParsedURL.schemeIs(r.url,"chrome:"))throw new Error("Not allowed to replay on chrome:// URLs");await this.page.bringToFront(),await super.runStep(r,s)}}}const n=new o(s,t,{timeout:this.timeout,speed:this.speed});let a;this.#u=await r.createRunner(this.userFlow,n);try{await this.#u.run()}catch(e){a=e,console.error("Replay error",e.message)}finally{await T.disconnectPuppeteer(s)}this.aborted?this.dispatchEventToListeners("Abort"):a?this.dispatchEventToListeners("Error",a):this.dispatchEventToListeners("Done")}}var S=Object.freeze({__proto__:null,RecordingPlayer:T,defaultTimeout:5e3});function b(e){return{type:i.SetViewport,width:e.clientWidth,height:e.clientHeight,deviceScaleFactor:1,isMobile:!1,hasTouch:!1,isLandscape:!1}}function E(e){return{type:i.EmulateNetworkConditions,download:e.download,upload:e.upload,latency:e.latency}}function C(e,t){return"selectors"in e&&"selectors"in t?JSON.stringify(e.selectors)===JSON.stringify(t.selectors):!("selectors"in e)&&!("selectors"in t)}const R=r.parse,M=r.parseStep;var k=Object.freeze({__proto__:null,areSelectorsEqual:C,createEmulateNetworkConditionsStep:E,createViewportStep:b,maxTimeout:3e4,minTimeout:1,parse:R,parseStep:M});function A(e){return o.TargetManager.TargetManager.instance().primaryPageTarget()===e||"main"===e.id()?"main":e.inspectedURL()}function _(e,t){const r=[];for(;t;){const e=t.sameTargetParentFrame();if(!e)break;const s=e.childFrames.indexOf(t);r.unshift(s),t=e}return{target:A(e),frame:r}}async function N(e,t,r){const s=t.model(o.RuntimeModel.RuntimeModel).executionContexts(),i=t.model(o.ResourceTreeModel.ResourceTreeModel);for(const o of i.frames()){if(!s.find(e=>e.frameId===o.id))continue;const{executionContextId:i}=await t.pageAgent().invoke_createIsolatedWorld({frameId:o.id,worldName:e});await t.runtimeAgent().invoke_evaluate({expression:r,includeCommandLineAPI:!0,contextId:i})}}var I=Object.freeze({__proto__:null,evaluateInAllFrames:N,findFrameIdByExecutionContext:function(e,t){for(const r of e){const e=r.model(o.RuntimeModel.RuntimeModel);if(e)for(const r of e.executionContexts())if(r.id===t&&void 0!==r.frameId)return r.frameId}},findTargetByExecutionContext:function(e,t){for(const r of e){const e=r.model(o.RuntimeModel.RuntimeModel);if(e)for(const s of e.executionContexts())if(s.id===t)return r}},getTargetFrameContext:_,getTargetName:A,isFrameTargetInfo:e=>"page"===e.type||"iframe"===e.type});const P=d.StringUtilities.formatAsJSLiteral,x=new Set(["typed","address_bar","auto_bookmark","auto_subframe","generated","auto_toplevel","reload","keyword","keyword_generated"]),O=Object.freeze({addStep:"addStep",stopShortcut:"stopShortcut"});class F extends e.ObjectWrapper.ObjectWrapper{#p;#f;#m;#w;#y;#v=new Map;#b=new Map;#T=new Map;#S=new Map;#E=new Map;#M=new Map;#R=new e.Mutex.Mutex;#_;#C=new Map;#k=!1;#A=[];constructor(e,t){super(),this.#p=e,this.#f=e.pageAgent(),this.#m=e.targetAgent(),this.#w=o.NetworkManager.MultitargetNetworkManager.instance();const r=e.model(o.ResourceTreeModel.ResourceTreeModel);if(!r)throw new Error("ResourceTreeModel is missing for the target: "+e.id());this.#y=r,this.#p=e,this.#_={title:t.title,selectorAttribute:t.selectorAttribute,steps:[]},this.#A=t.selectorTypesToRecord}cloneUserFlow(){return structuredClone(this.#_)}overwriteUserFlow(e){this.#_=structuredClone(e)}async start(){if(this.#k)throw new Error("The session has started");this.#k=!0,this.#w.addEventListener("ConditionsChanged",this.#O,this),await this.#N(),await this.#f.invoke_bringToFront(),await this.#x(this.#p)}async stop(){await this.#P(),this.#R.acquire(),await Promise.all([...this.#v.values()].map(this.#L)),this.#w.removeEventListener("ConditionsChanged",this.#O,this)}async#N(){const e=this.#y.mainFrame;if(!e)throw new Error("Could not find mainFrame.");this.#w.networkConditions()!==o.NetworkManager.NoThrottlingConditions&&this.#O();const{cssLayoutViewport:t}=await this.#p.pageAgent().invoke_getLayoutMetrics();this.#I(b(t));const r=await this.#y.navigationHistory();if(r){const e=r.entries[r.currentIndex];this.#b.set(this.#p.id(),e.id),this.#T.set(this.#p.id(),r.entries.map(e=>e.id)),this.#_.steps.push({type:i.Navigate,url:e.url,assertedEvents:[{type:s.Navigation,url:e.url,title:e.title}]})}else this.#_.steps.push({type:i.Navigate,url:e.url,assertedEvents:[{type:s.Navigation,url:e.url,title:await this.#F(this.#p)}]});this.#P()}async#F(e){const t=await e.runtimeAgent().invoke_evaluate({expression:"document.title"});return t.result?.value||""}#O(){const e=this.#w.networkConditions();this.#I(E(e))}#j;#D=[];#P(){return this.#j&&clearTimeout(this.#j),this.#j=setTimeout(()=>{this.dispatchEventToListeners("recordingupdated",structuredClone(this.#_)),this.#j=void 0;for(const e of this.#D)e();this.#D.length=0},100),new Promise(e=>{this.#D.push(e)})}get#B(){return this.#_.steps.slice(-1)[0]}#U=new Set;#I(e){switch(e.type){case"doubleClick":for(let t=this.#_.steps.length-1;t>0;t--){const r=this.#_.steps[t];if("click"===r.type){e.selectors=r.selectors,this.#_.steps.splice(t,1);break}}break;case"change":{const t=this.#B;if(!t)break;switch(t.type){case"change":if(!C(e,t))break;return this.#_.steps[this.#_.steps.length-1]=e,void this.#P();case"keyDown":return this.#U.add(t.key),this.#_.steps.pop(),void this.#I(e)}break}case"keyDown":if(this.#U.has(e.key))return;break;case"keyUp":if(this.#U.has(e.key))return void this.#U.delete(e.key)}this.#_.steps.push(e),this.#P()}#z(e,t){const r=this.#_.steps[this.#_.steps.length-1];if(r&&!r.assertedEvents?.find(e=>e.type===s.Navigation)){const i=e.target||"main",o=(e.frame||[]).join(","),n=r.target||"main",a=(("frame"in r?r.frame:[])||[]).join(",");i===n&&o===a&&(r.assertedEvents=[{type:s.Navigation}],this.#C.set(t.id(),r),this.#P())}}#W(e,t){const r=this.#C.get(e.id());if(!r)return;const i=r;if(!i.assertedEvents)return;const o=i.assertedEvents.find(e=>e.type===s.Navigation);o&&!o.url&&(o.url=t.url,o.title=t.title,this.#P())}#$(e){const t=Number(e.data.payload);for(let e=0;e<t-1;e++)this.#_.steps.pop();this.dispatchEventToListeners("recordingstopped",structuredClone(this.#_))}#V(e,t){switch(t.data.name){case O.stopShortcut:return void this.#$(t);case O.addStep:return void this.#J(e,t);default:return}}#J(e,t){const r=t.data.executionContextId;let s;const i=e.model(o.RuntimeModel.RuntimeModel);if(i)for(const e of i.executionContexts())if(e.id===r){s=e.frameId;break}if(!s)throw new Error("No execution context found for the binding call + "+JSON.stringify(t.data));const n=JSON.parse(t.data.payload),a=e.model(o.ResourceTreeModel.ResourceTreeModel).frameForId(s);if(!a)throw new Error("Could not find frame.");const c=_(e,a);if("beforeUnload"!==n.type)switch(n.type){case"change":this.#I({type:"change",value:n.value,selectors:n.selectors,frame:c.frame.length?c.frame:void 0,target:c.target});break;case"doubleClick":this.#I({type:"doubleClick",target:c.target,selectors:n.selectors,offsetY:n.offsetY,offsetX:n.offsetX,frame:c.frame.length?c.frame:void 0,deviceType:n.deviceType,button:n.button});break;case"click":this.#I({type:"click",target:c.target,selectors:n.selectors,offsetY:n.offsetY,offsetX:n.offsetX,frame:c.frame.length?c.frame:void 0,duration:n.duration,deviceType:n.deviceType,button:n.button});break;case"keyUp":this.#I({type:"keyUp",key:n.key,frame:c.frame.length?c.frame:void 0,target:c.target});break;case"keyDown":this.#I({type:"keyDown",frame:c.frame.length?c.frame:void 0,target:c.target,key:n.key});break;default:throw new Error("Unhandled client event")}else this.#z(c,e)}#H(){return(e=>{const t=[];for(const r of e)for(const e of r){const r={meta:!1,ctrl:!1,shift:!1,alt:!1,keyCode:-1},{keyCode:s,modifiers:i}=a.KeyboardShortcut.KeyboardShortcut.keyCodeAndModifiersFromKey(e);r.keyCode=s;const o=a.KeyboardShortcut.Modifiers;r.ctrl=Boolean(i&o.Ctrl.value),r.meta=Boolean(i&o.Meta.value),r.shift=Boolean(i&o.Shift.value),r.shift=Boolean(i&o.Alt.value),-1!==r.keyCode&&t.push(r)}return t})(a.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("chrome-recorder.start-recording").map(e=>e.descriptors.map(e=>e.key)))}static get#K(){try{return e.Settings.Settings.instance().settingForTest("untrusted-recorder-events"),!0}catch{}return!1}#x=async e=>{if(e.type()!==o.Target.Type.FRAME)return;this.#v.set(e.id(),e);const t=e.model(o.AccessibilityModel.AccessibilityModel);d.assertNotNullOrUndefined(t),await t.resumeModel(),await this.#q(e),await this.#G(e);const r=e.model(o.ChildTargetManager.ChildTargetManager);d.assertNotNullOrUndefined(r),this.#M.set(e,[r.addEventListener("TargetCreated",this.#X.bind(this,e)),r.addEventListener("TargetDestroyed",this.#Y.bind(this,e)),r.addEventListener("TargetInfoChanged",this.#Q.bind(this,e))]),await Promise.all(r.childTargets().map(this.#x))};#L=async t=>{const r=this.#M.get(t);r&&e.EventTarget.removeEventListeners(r),await this.#Z(t),await this.#ee(t)};async#q(e){const t=e.model(o.RuntimeModel.RuntimeModel);d.assertNotNullOrUndefined(t),this.#E.set(e,[t.addEventListener(o.RuntimeModel.Events.BindingCalled,this.#V.bind(this,e))]),await Promise.all(Object.values(O).map(e=>t.addBinding({name:e,executionContextName:l.DEVTOOLS_RECORDER_WORLD_NAME})))}async#ee(t){await Promise.all(Object.values(O).map(e=>t.runtimeAgent().invoke_removeBinding({name:e})));const r=this.#E.get(t);r&&e.EventTarget.removeEventListeners(r)}async#G(e){const t=`\n      ${await l.InjectedScript.get()};DevToolsRecorder.startRecording({getAccessibleName, getAccessibleRole}, {\n        debug: ${l.isDebugBuild},\n        allowUntrustedEvents: ${F.#K},\n        selectorTypesToRecord: ${JSON.stringify(this.#A)},\n        selectorAttribute: ${this.#_.selectorAttribute?P(this.#_.selectorAttribute):void 0},\n        stopShortcuts: ${JSON.stringify(this.#H())},\n      });\n    `,[{identifier:r}]=await Promise.all([e.pageAgent().invoke_addScriptToEvaluateOnNewDocument({source:t,worldName:l.DEVTOOLS_RECORDER_WORLD_NAME,includeCommandLineAPI:!0}),N(l.DEVTOOLS_RECORDER_WORLD_NAME,e,t)]);this.#S.set(e.id(),r)}async#Z(e){const t=this.#S.get(e.id());t&&(await e.pageAgent().invoke_removeScriptToEvaluateOnNewDocument({identifier:t}),await(async(e,t)=>{await Promise.all(t.map(t=>N(e,t,"DevToolsRecorder.stopRecording()")))})(l.DEVTOOLS_RECORDER_WORLD_NAME,[...this.#v.values()]))}#X(e,t){this.#te({type:"targetCreated",event:t,target:e})}#Y(e,t){const r=this.#v.get(t.data);r&&this.#te({type:"targetClosed",event:t,target:r})}#Q(e,t){const r=this.#v.get(t.data.targetId)||e;this.#te({type:"targetInfoChanged",event:t,target:r})}#te(e){return this.#R.run(async()=>{try{switch(l.isDebugBuild&&console.time(`Processing ${JSON.stringify(e)}`),e.type){case"targetClosed":await this.#re(e);break;case"targetCreated":await this.#se(e);break;case"targetInfoChanged":await this.#ie(e)}l.isDebugBuild&&console.timeEnd(`Processing ${JSON.stringify(e)}`)}catch(e){console.error("Error happened while processing recording events: ",e.message,e.stack)}})}async#se(e){if("page"!==e.event.data.type&&"iframe"!==e.event.data.type)return;await this.#m.invoke_attachToTarget({targetId:e.event.data.targetId,flatten:!0});const t=o.TargetManager.TargetManager.instance().targets().find(t=>t.id()===e.event.data.targetId);if(!t)throw new Error("Could not find target.");await this.#x(t),window.dispatchEvent(new Event("recorderAttachedToTarget"))}async#re(e){const t=this.#C.get(e.target.id());t&&(delete t.assertedEvents,this.#C.delete(e.target.id()))}async#oe(e,t){const r=await e.navigationHistory();if(!r)return!1;const o=r.entries[r.currentIndex];if(this.#b.get(t.id())===o.id)return!0;this.#b.set(t.id(),o.id);const n=this.#T.get(t.id())||[];if(this.#T.set(t.id(),r.entries.map(e=>e.id)),x.has(o.transitionType)||n.includes(o.id)){const e=this.#C.get(t.id());e&&(delete e.assertedEvents,this.#C.delete(t.id())),this.#I({type:i.Navigate,url:o.url,assertedEvents:[{type:s.Navigation,url:o.url,title:o.title}]})}else this.#W(t,{type:s.Navigation,url:o.url,title:o.title});return!0}async#ie(e){if("page"!==e.event.data.type&&"iframe"!==e.event.data.type)return;const t=e.target,r=t.model(o.ResourceTreeModel.ResourceTreeModel);if(!r)throw new Error("ResourceTreeModel is missing in handleNavigation");if("iframe"===e.event.data.type)this.#W(t,{type:s.Navigation,url:e.event.data.url,title:await this.#F(t)});else if("page"===e.event.data.type){if(await this.#oe(r,t))return;await this.#ne(r,500),this.#W(t,{type:s.Navigation,url:e.event.data.url,title:await this.#F(t)})}}async#ne(e,t){const{resolve:r,promise:s}=Promise.withResolvers(),i=()=>{e.removeEventListener(o.ResourceTreeModel.Events.DOMContentLoaded,i),r()};e.addEventListener(o.ResourceTreeModel.Events.DOMContentLoaded,i),await Promise.any([s,new Promise(r=>setTimeout(()=>{e.removeEventListener(o.ResourceTreeModel.Events.DOMContentLoaded,i),r()},t))])}}var L=Object.freeze({__proto__:null,RecordingSession:F}),D=Object.freeze({__proto__:null});let B=null;class U{next(){return crypto.randomUUID()}}class j{#ae;#R=new e.Mutex.Mutex;#ce=new U;constructor(){this.#ae=e.Settings.Settings.instance().createSetting("recorder-recordings-ng",[])}clearForTest(){this.#ae.set([]),this.#ce=new U}setIdGeneratorForTest(e){this.#ce=e}async saveRecording(e){const t=await this.#R.acquire();try{const t=await this.#ae.forceGet(),r={storageName:this.#ce.next(),flow:e};return t.push(r),this.#ae.set(t),r}finally{t()}}async updateRecording(e,t){const r=await this.#R.acquire();try{const r=await this.#ae.forceGet(),s=r.find(t=>t.storageName===e);if(!s)throw new Error("No recording is found during updateRecording");return s.flow=t,this.#ae.set(r),s}finally{r()}}async deleteRecording(e){const t=await this.#R.acquire();try{const t=await this.#ae.forceGet();this.#ae.set(t.filter(t=>t.storageName!==e))}finally{t()}}getRecording(e){return this.#ae.get().find(t=>t.storageName===e)}getRecordings(){return this.#ae.get()}static instance(){return B||(B=new j),B}}var z=Object.freeze({__proto__:null,RecordingStorage:j});let W=null;const K=52428800;class H{#de;#le;#he;constructor(t=52428800){this.#de=e.Settings.Settings.instance().createSetting("recorder-screenshots",[]),this.#le=this.#ue(),this.#he=t}clear(){this.#de.set([]),this.#le=new Map}getScreenshotForSection(e,t){const r=this.#le.get(this.#ge(e,t));return r?(this.#pe(r),r.data):null}storeScreenshotForSection(e,t,r){const s={recordingName:e,index:t,data:r};this.#le.set(this.#ge(e,t),s),this.#pe(s)}deleteScreenshotsForRecording(e){for(const[t,r]of this.#le)r.recordingName===e&&this.#le.delete(t);this.#pe()}#ge(e,t){return`${e}:${t}`}#ue(){const e=new Map,t=this.#de.get();for(const r of t)e.set(this.#ge(r.recordingName,r.index),r);return e}#pe(e){if(e){const t=this.#ge(e.recordingName,e.index);this.#le.delete(t),this.#le.set(t,e)}const t=[];let r=0;for(const[e,s]of Array.from(this.#le.entries()).reverse())r<this.#he?(r+=s.data.length,t.push(s)):this.#le.delete(e);this.#de.set(t.reverse())}static instance(e={forceNew:null,maxStorageSize:K}){const{forceNew:t,maxStorageSize:r}=e;return W&&!t||(W=new H(r)),W}}var $=Object.freeze({__proto__:null,ScreenshotStorage:H});async function V(e){const t=new Image,r=new Promise(e=>{t.onload=e});t.src=e,await r;const s=document.createElement("canvas"),i=s.getContext("2d");if(!i)throw new Error("Could not create context.");const o=t.width/t.height;s.width=160,s.height=Math.min(240,160/o);const n=await createImageBitmap(t,{resizeWidth:160,resizeQuality:"high"});return i.drawImage(n,0,0),s.toDataURL("image/png")}var G=Object.freeze({__proto__:null,resizeScreenshot:V,takeScreenshot:async function(){const e=await async function(){const e=o.TargetManager.TargetManager.instance().primaryPageTarget();if(!e)throw new Error("Could not find main target");const{data:t}=await e.pageAgent().invoke_captureScreenshot({});return t?"data:image/png;base64,"+t:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"}();return await V(e)}});function J(e){const t=e.assertedEvents?.find(e=>"navigation"===e.type);return"navigate"===e.type?{title:t?.title||"",url:e.url,steps:[],causingStep:e}:t?{title:t.title||"",url:t.url||"",steps:[]}:null}var q=Object.freeze({__proto__:null,buildSections:function(e){let t=null;const r=[];for(const s of e){if(t)t.steps.push(s);else{if("navigate"===s.type){t=J(s);continue}t={title:"Current page",url:"",steps:[s]}}const e=J(s);e&&(t&&r.push(t),t=e)}return!t||r.length&&!t.steps.length||r.push(t),r}}),X=Object.freeze({__proto__:null,getTooltipForActions:function(e,t){let r=e;const s=a.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction(t);for(const e of s)r+=` - ${e.title()}`;return r}});export{g as ConverterIds,f as RecorderSettings,y as RecorderShortcutHelper,S as RecordingPlayer,L as RecordingSession,D as RecordingSettings,z as RecordingStorage,I as SDKUtils,p as Schema,k as SchemaUtils,$ as ScreenshotStorage,G as ScreenshotUtils,q as Section,X as Tooltip};