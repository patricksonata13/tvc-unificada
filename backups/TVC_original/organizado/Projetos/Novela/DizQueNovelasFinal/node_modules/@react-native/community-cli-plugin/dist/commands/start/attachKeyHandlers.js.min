"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=attachKeyHandlers;var _OpenDebuggerKeyboardHandler=_interopRequireDefault(require("./OpenDebuggerKeyboardHandler")),_invariant=_interopRequireDefault(require("invariant")),_readline=_interopRequireDefault(require("readline")),_tty=require("tty"),_util=require("util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const CTRL_C="",CTRL_D="",RELOAD_TIMEOUT=500,throttle=(e,t)=>{let r=0;return()=>{const a=(new Date).getTime();a-r>t&&(r=a,e())}};function attachKeyHandlers({devServerUrl:e,messageSocket:t,reporter:r}){if(!0!==process.stdin.isTTY)return void r.update({type:"unstable_server_log",level:"info",data:"Interactive mode is not supported in this environment"});_readline.default.emitKeypressEvents(process.stdin),setRawMode(!0);const a=throttle(()=>{r.update({type:"unstable_server_log",level:"info",data:"Reloading connected app(s)..."}),t.broadcast("reload",null)},RELOAD_TIMEOUT),n=new _OpenDebuggerKeyboardHandler.default({reporter:r,devServerUrl:e});process.stdin.on("keypress",(e,s)=>{if(!n.maybeHandleTargetSelection(s.name))switch(s.sequence){case"r":a();break;case"d":r.update({type:"unstable_server_log",level:"info",data:"Opening Dev Menu..."}),t.broadcast("devMenu",null);break;case"j":n.handleOpenDebugger();break;case CTRL_C:case CTRL_D:n.dismiss(),r.update({type:"unstable_server_log",level:"info",data:"Stopping server"}),setRawMode(!1),process.stdin.pause(),process.emit("SIGINT"),process.exit()}}),r.update({type:"unstable_server_log",level:"info",data:`Key commands available:\n\n  ${(0,_util.styleText)(["bold","inverse"]," r ")} - reload app(s)\n  ${(0,_util.styleText)(["bold","inverse"]," d ")} - open Dev Menu\n  ${(0,_util.styleText)(["bold","inverse"]," j ")} - open DevTools\n`})}function setRawMode(e){(0,_invariant.default)(process.stdin instanceof _tty.ReadStream,"process.stdin must be a readable stream to modify raw mode"),process.stdin.setRawMode(e)}