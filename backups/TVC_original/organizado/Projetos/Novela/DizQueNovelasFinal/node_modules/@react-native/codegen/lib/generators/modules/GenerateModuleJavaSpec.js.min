"use strict";const{unwrapNullable:unwrapNullable}=require("../../parsers/parsers-commons"),{wrapOptional:wrapOptional}=require("../TypeUtils/Java"),{toPascalCase:toPascalCase}=require("../Utils"),{createAliasResolver:createAliasResolver,getModules:getModules}=require("./Utils");function FileTemplate(e){const{packageName:n,className:t,jsName:a,eventEmitters:o,methods:r,imports:i}=e;return`\n/**\n * This code was generated by [react-native-codegen](https://www.npmjs.com/package/react-native-codegen).\n *\n * Do not edit this file as changes may cause incorrect behavior and will be lost\n * once the code is regenerated.\n *\n * @generated by codegen project: GenerateModuleJavaSpec.js\n *\n * @nolint\n */\n\npackage ${n};\n\n${i}\n\npublic abstract class ${t} extends ReactContextBaseJavaModule implements TurboModule {\n  public static final String NAME = "${a}";\n\n  public ${t}(ReactApplicationContext reactContext) {\n    super(reactContext);\n  }\n\n  @Override\n  public @Nonnull String getName() {\n    return NAME;\n  }\n\n${o}${o.length>0?"\n\n":""}${r}\n}\n`}function EventEmitterTemplate(e,n){return`  protected final void emit${toPascalCase(e.name)}(${"VoidTypeAnnotation"!==e.typeAnnotation.typeAnnotation.type?`${translateEventEmitterTypeToJavaType(e,n)} value`:""}) {\n    mEventEmitterCallback.invoke("${e.name}"${"VoidTypeAnnotation"!==e.typeAnnotation.typeAnnotation.type?", value":""});\n  }`}function MethodTemplate(e){const{abstract:n,methodBody:t,methodJavaAnnotation:a,methodName:o,translatedReturnType:r,traversedArgs:i}=e,p=n?"abstract ":"",l=n?";":null!=t&&t.length>0?` { ${t} }`:" {}";return`  ${a}\n  public ${p}${r} ${o}(${i.join(", ")})${l}`}function translateEventEmitterTypeToJavaType(e,n){const t=e.typeAnnotation.typeAnnotation.type;switch(t){case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return"String";case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"FloatTypeAnnotation":case"DoubleTypeAnnotation":case"Int32TypeAnnotation":return"double";case"BooleanTypeAnnotation":return"boolean";case"GenericObjectTypeAnnotation":case"ObjectTypeAnnotation":case"TypeAliasTypeAnnotation":return n.add("com.facebook.react.bridge.ReadableMap"),"ReadableMap";case"ArrayTypeAnnotation":return n.add("com.facebook.react.bridge.ReadableArray"),"ReadableArray";default:throw new Error(`Unsupported eventType for ${e.name}. Found: ${e.typeAnnotation.typeAnnotation.type}`)}}function translateFunctionParamToJavaType(e,n,t,a){const{optional:o,typeAnnotation:r}=e,[i,p]=unwrapNullable(r),l=!o&&!p;l||a.add("javax.annotation.Nullable");let s=i;switch("TypeAliasTypeAnnotation"===s.type&&(s=t(s.name)),s.type){case"ReservedTypeAnnotation":if("RootTag"===s.name)return wrapOptional("double",l);throw s.name,new Error(n(s.name));case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return wrapOptional("String",l);case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"FloatTypeAnnotation":case"DoubleTypeAnnotation":case"Int32TypeAnnotation":return wrapOptional("double",l);case"BooleanTypeAnnotation":return wrapOptional("boolean",l);case"EnumDeclaration":switch(s.memberType){case"NumberTypeAnnotation":return wrapOptional("double",l);case"StringTypeAnnotation":return wrapOptional("String",l);default:throw new Error(n(s.type))}case"UnionTypeAnnotation":switch(i.memberType){case"NumberTypeAnnotation":return wrapOptional("double",l);case"ObjectTypeAnnotation":return a.add("com.facebook.react.bridge.ReadableMap"),wrapOptional("ReadableMap",l);case"StringTypeAnnotation":return wrapOptional("String",l);default:throw new Error(`Unsupported union member returning value, found: ${s.memberType}"`)}case"ObjectTypeAnnotation":case"GenericObjectTypeAnnotation":return a.add("com.facebook.react.bridge.ReadableMap"),wrapOptional("ReadableMap",l);case"ArrayTypeAnnotation":return a.add("com.facebook.react.bridge.ReadableArray"),wrapOptional("ReadableArray",l);case"FunctionTypeAnnotation":return a.add("com.facebook.react.bridge.Callback"),wrapOptional("Callback",l);default:throw s.type,new Error(n(s.type))}}function translateFunctionReturnTypeToJavaType(e,n,t,a){const[o,r]=unwrapNullable(e);r&&a.add("javax.annotation.Nullable");const i=!r;let p=o;switch("TypeAliasTypeAnnotation"===p.type&&(p=t(p.name)),p.type){case"ReservedTypeAnnotation":if("RootTag"===p.name)return wrapOptional("double",i);throw p.name,new Error(n(p.name));case"VoidTypeAnnotation":case"PromiseTypeAnnotation":return"void";case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return wrapOptional("String",i);case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":case"FloatTypeAnnotation":case"DoubleTypeAnnotation":case"Int32TypeAnnotation":return wrapOptional("double",i);case"BooleanTypeAnnotation":return wrapOptional("boolean",i);case"EnumDeclaration":switch(p.memberType){case"NumberTypeAnnotation":return wrapOptional("double",i);case"StringTypeAnnotation":return wrapOptional("String",i);default:throw new Error(n(p.type))}case"UnionTypeAnnotation":switch(p.memberType){case"NumberTypeAnnotation":return wrapOptional("double",i);case"ObjectTypeAnnotation":return a.add("com.facebook.react.bridge.WritableMap"),wrapOptional("WritableMap",i);case"StringTypeAnnotation":return wrapOptional("String",i);default:throw new Error(`Unsupported union member returning value, found: ${p.memberType}"`)}case"ObjectTypeAnnotation":case"GenericObjectTypeAnnotation":return a.add("com.facebook.react.bridge.WritableMap"),wrapOptional("WritableMap",i);case"ArrayTypeAnnotation":return a.add("com.facebook.react.bridge.WritableArray"),wrapOptional("WritableArray",i);default:throw p.type,new Error(n(p.type))}}function getFalsyReturnStatementFromReturnType(e,n,t){const[a,o]=unwrapNullable(e);let r=a;switch("TypeAliasTypeAnnotation"===r.type&&(r=t(r.name)),r.type){case"ReservedTypeAnnotation":if("RootTag"===r.name)return"return 0.0;";throw r.name,new Error(n(r.name));case"VoidTypeAnnotation":case"PromiseTypeAnnotation":return"";case"NumberTypeAnnotation":case"NumberLiteralTypeAnnotation":return o?"return null;":"return 0;";case"FloatTypeAnnotation":case"DoubleTypeAnnotation":return o?"return null;":"return 0.0;";case"Int32TypeAnnotation":return o?"return null;":"return 0;";case"BooleanTypeAnnotation":return o?"return null;":"return false;";case"EnumDeclaration":switch(r.memberType){case"NumberTypeAnnotation":return o?"return null;":"return 0;";case"StringTypeAnnotation":return o?"return null;":'return "";';default:throw new Error(n(r.type))}case"UnionTypeAnnotation":switch(r.memberType){case"NumberTypeAnnotation":return o?"return null;":"return 0;";case"ObjectTypeAnnotation":return"return null;";case"StringTypeAnnotation":return o?"return null;":'return "";';default:throw new Error(`Unsupported union member returning value, found: ${r.memberType}"`)}case"StringTypeAnnotation":case"StringLiteralTypeAnnotation":case"StringLiteralUnionTypeAnnotation":return o?"return null;":'return "";';case"ObjectTypeAnnotation":case"GenericObjectTypeAnnotation":case"ArrayTypeAnnotation":return"return null;";default:throw r.type,new Error(n(r.type))}}function buildGetConstantsMethod(e,n,t){const[a]=unwrapNullable(e.typeAnnotation);let o=a.returnTypeAnnotation;if("TypeAliasTypeAnnotation"===o.type&&(o=t(o.name)),"ObjectTypeAnnotation"===o.type){const e=[],t=[];if((o.properties||[]).forEach(n=>{n.optional||"NullableTypeAnnotation"===n.typeAnnotation.type?t.push(n.name):e.push(n.name)}),0===e.length&&0===t.length)return"";n.add("com.facebook.react.common.build.ReactBuildConfig"),n.add("java.util.Arrays"),n.add("java.util.HashSet"),n.add("java.util.Map"),n.add("java.util.Set"),n.add("javax.annotation.Nullable");return`  protected abstract Map<String, Object> getTypedExportedConstants();\n\n  @Override\n  @DoNotStrip\n  public final @Nullable Map<String, Object> getConstants() {\n    Map<String, Object> constants = getTypedExportedConstants();\n    if (ReactBuildConfig.DEBUG || ReactBuildConfig.IS_INTERNAL_BUILD) {\n      Set<String> obligatoryFlowConstants = new HashSet<>(${e.length>0?`Arrays.asList(\n          ${e.sort().map(e=>`"${e}"`).join(",\n          ")}\n      )`:""});\n      Set<String> optionalFlowConstants = new HashSet<>(${t.length>0?`Arrays.asList(\n          ${t.sort().map(e=>`"${e}"`).join(",\n          ")}\n      )`:""});\n      Set<String> undeclaredConstants = new HashSet<>(constants.keySet());\n      undeclaredConstants.removeAll(obligatoryFlowConstants);\n      undeclaredConstants.removeAll(optionalFlowConstants);\n      if (!undeclaredConstants.isEmpty()) {\n        throw new IllegalStateException(String.format("Native Module Flow doesn't declare constants: %s", undeclaredConstants));\n      }\n      undeclaredConstants = obligatoryFlowConstants;\n      undeclaredConstants.removeAll(constants.keySet());\n      if (!undeclaredConstants.isEmpty()) {\n        throw new IllegalStateException(String.format("Native Module doesn't fill in constants: %s", undeclaredConstants));\n      }\n    }\n    return constants;\n  }`}return""}module.exports={generate(e,n,t,a=!1,o){const r=new Map,i=getModules(n),p=null==t?"com.facebook.fbreact.specs":t,l=`java/${p.replace(/\./g,"/")}`;return Object.keys(i).forEach(e=>{const{aliasMap:n,excludedPlatforms:t,moduleName:a,spec:o}=i[e];if(null!=t&&t.includes("android"))return;const s=createAliasResolver(n),c=`${e}Spec`,u=new Set(["com.facebook.react.bridge.ReactApplicationContext","com.facebook.react.bridge.ReactContextBaseJavaModule","com.facebook.react.bridge.ReactMethod","com.facebook.react.turbomodule.core.interfaces.TurboModule","com.facebook.proguard.annotations.DoNotStrip","javax.annotation.Nonnull"]),y=o.methods.map(e=>{if("getConstants"===e.name)return buildGetConstantsMethod(e,u,s);const[n]=unwrapNullable(e.typeAnnotation),t=translateFunctionReturnTypeToJavaType(n.returnTypeAnnotation,n=>`Unsupported return type for method ${e.name}. Found: ${n}`,s,u),a="PromiseTypeAnnotation"===n.returnTypeAnnotation.type,o="VoidTypeAnnotation"!==n.returnTypeAnnotation.type&&!a,r=n.params.map(n=>`${translateFunctionParamToJavaType(n,t=>`Unsupported type for param "${n.name}" in ${e.name}. Found: ${t}`,s,u)} ${n.name}`);a&&(u.add("com.facebook.react.bridge.Promise"),r.push("Promise promise"));const i=`@ReactMethod${o?"(isBlockingSynchronousMethod = true)":""}\n  @DoNotStrip`,p=e.optional?getFalsyReturnStatementFromReturnType(n.returnTypeAnnotation,n=>`Cannot build falsy return statement for return type for method ${e.name}. Found: ${n}`,s):null;return MethodTemplate({abstract:!e.optional,methodBody:p,methodJavaAnnotation:i,methodName:e.name,translatedReturnType:t,traversedArgs:r})});r.set(`${l}/${c}.java`,FileTemplate({packageName:p,className:c,jsName:a,eventEmitters:o.eventEmitters.map(e=>EventEmitterTemplate(e,u)).join("\n\n"),methods:y.filter(Boolean).join("\n\n"),imports:Array.from(u).sort().map(e=>`import ${e};`).join("\n")}))}),r}};