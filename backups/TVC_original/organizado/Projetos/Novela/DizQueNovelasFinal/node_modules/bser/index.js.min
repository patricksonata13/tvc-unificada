var EE=require("events").EventEmitter,util=require("util"),os=require("os"),assert=require("assert"),Int64=require("node-int64"),isBigEndian="BE"==os.endianness();function nextPow2(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Accumulator(e){this.buf=Buffer.alloc(nextPow2(e||8192)),this.readOffset=0,this.writeOffset=0}exports.Accumulator=Accumulator,Accumulator.prototype.writeAvail=function(){return this.buf.length-this.writeOffset},Accumulator.prototype.readAvail=function(){return this.writeOffset-this.readOffset},Accumulator.prototype.reserve=function(e){if(!(e<this.writeAvail()||(this.readOffset>0&&(this.buf.copy(this.buf,0,this.readOffset,this.writeOffset),this.writeOffset-=this.readOffset,this.readOffset=0),e<this.writeAvail()))){var t=Buffer.alloc(nextPow2(this.buf.length+e-this.writeAvail()));this.buf.copy(t),this.buf=t}},Accumulator.prototype.append=function(e){if(Buffer.isBuffer(e))this.reserve(e.length),e.copy(this.buf,this.writeOffset,0,e.length),this.writeOffset+=e.length;else{var t=Buffer.byteLength(e);this.reserve(t),this.buf.write(e,this.writeOffset),this.writeOffset+=t}},Accumulator.prototype.assertReadableSize=function(e){if(this.readAvail()<e)throw new Error("wanted to read "+e+" bytes but only have "+this.readAvail())},Accumulator.prototype.peekString=function(e){return this.assertReadableSize(e),this.buf.toString("utf-8",this.readOffset,this.readOffset+e)},Accumulator.prototype.readString=function(e){var t=this.peekString(e);return this.readOffset+=e,t},Accumulator.prototype.peekInt=function(e){switch(this.assertReadableSize(e),e){case 1:return this.buf.readInt8(this.readOffset,e);case 2:return isBigEndian?this.buf.readInt16BE(this.readOffset,e):this.buf.readInt16LE(this.readOffset,e);case 4:return isBigEndian?this.buf.readInt32BE(this.readOffset,e):this.buf.readInt32LE(this.readOffset,e);case 8:var t=this.buf.slice(this.readOffset,this.readOffset+8);return new Int64(isBigEndian?t:byteswap64(t));default:throw new Error("invalid integer size "+e)}},Accumulator.prototype.readInt=function(e){var t=this.peekInt(e);return t instanceof Int64&&isFinite(t.valueOf())&&(t=t.valueOf()),this.readOffset+=e,t},Accumulator.prototype.peekDouble=function(){return this.assertReadableSize(8),isBigEndian?this.buf.readDoubleBE(this.readOffset):this.buf.readDoubleLE(this.readOffset)},Accumulator.prototype.readDouble=function(){var e=this.peekDouble();return this.readOffset+=8,e},Accumulator.prototype.readAdvance=function(e){if(e>0)this.assertReadableSize(e);else if(e<0&&this.readOffset+e<0)throw new Error("advance with negative offset "+e+" would seek off the start of the buffer");this.readOffset+=e},Accumulator.prototype.writeByte=function(e){this.reserve(1),this.buf.writeInt8(e,this.writeOffset),++this.writeOffset},Accumulator.prototype.writeInt=function(e,t){switch(this.reserve(t),t){case 1:this.buf.writeInt8(e,this.writeOffset);break;case 2:isBigEndian?this.buf.writeInt16BE(e,this.writeOffset):this.buf.writeInt16LE(e,this.writeOffset);break;case 4:isBigEndian?this.buf.writeInt32BE(e,this.writeOffset):this.buf.writeInt32LE(e,this.writeOffset);break;default:throw new Error("unsupported integer size "+t)}this.writeOffset+=t},Accumulator.prototype.writeDouble=function(e){this.reserve(8),isBigEndian?this.buf.writeDoubleBE(e,this.writeOffset):this.buf.writeDoubleLE(e,this.writeOffset),this.writeOffset+=8};var BSER_ARRAY=0,BSER_OBJECT=1,BSER_STRING=2,BSER_INT8=3,BSER_INT16=4,BSER_INT32=5,BSER_INT64=6,BSER_REAL=7,BSER_TRUE=8,BSER_FALSE=9,BSER_NULL=10,BSER_TEMPLATE=11,BSER_SKIP=12,ST_NEED_PDU=0,ST_FILL_PDU=1,MAX_INT8=127,MAX_INT16=32767,MAX_INT32=2147483647;function BunserBuf(){EE.call(this),this.buf=new Accumulator,this.state=ST_NEED_PDU}function loadFromBuffer(e){var t=new BunserBuf,r=t.append(e,!0);if(t.buf.readAvail())throw Error("excess data found after input buffer, use BunserBuf instead");if(void 0===r)throw Error("no bser found in string and no error raised!?");return r}function byteswap64(e){for(var t=Buffer.alloc(e.length),r=0;r<e.length;r++)t[r]=e[e.length-1-r];return t}function dump_int64(e,t){var r=t.toBuffer();if(isBigEndian)return e.writeByte(BSER_INT64),void e.append(r);var i=byteswap64(r);e.writeByte(BSER_INT64),e.append(i)}function dump_int(e,t){var r=Math.abs(t);r<=MAX_INT8?(e.writeByte(BSER_INT8),e.writeInt(t,1)):r<=MAX_INT16?(e.writeByte(BSER_INT16),e.writeInt(t,2)):r<=MAX_INT32?(e.writeByte(BSER_INT32),e.writeInt(t,4)):dump_int64(e,new Int64(t))}function dump_any(e,t){switch(typeof t){case"number":return void(isFinite(t)&&Math.floor(t)===t?dump_int(e,t):(e.writeByte(BSER_REAL),e.writeDouble(t)));case"string":return e.writeByte(BSER_STRING),dump_int(e,Buffer.byteLength(t)),void e.append(t);case"boolean":return void e.writeByte(t?BSER_TRUE:BSER_FALSE);case"object":if(null===t)return void e.writeByte(BSER_NULL);if(t instanceof Int64)return void dump_int64(e,t);if(Array.isArray(t)){e.writeByte(BSER_ARRAY),dump_int(e,t.length);for(var r=0;r<t.length;++r)dump_any(e,t[r]);return}e.writeByte(BSER_OBJECT);var i=Object.keys(t),s=i.length;for(r=0;r<i.length;++r){void 0===(f=t[n=i[r]])&&s--}dump_int(e,s);for(r=0;r<i.length;++r){var n,f;if(void 0!==(f=t[n=i[r]])){dump_any(e,n);try{dump_any(e,f)}catch(e){throw new Error(e.message+" (while serializing object property with name `"+n+"')")}}}return;default:throw new Error("cannot serialize type "+typeof t+" to BSER")}}function dumpToBuffer(e){var t=new Accumulator;t.writeByte(0),t.writeByte(1),t.writeByte(BSER_INT32),t.writeInt(0,4),dump_any(t,e);var r=t.writeOffset,i=r-7;return t.writeOffset=3,t.writeInt(i,4),t.writeOffset=r,t.buf.slice(0,r)}util.inherits(BunserBuf,EE),exports.BunserBuf=BunserBuf,BunserBuf.prototype.append=function(e,t){if(t)return this.buf.append(e),this.process(t);try{this.buf.append(e)}catch(e){return void this.emit("error",e)}this.processLater()},BunserBuf.prototype.processLater=function(){var e=this;process.nextTick(function(){try{e.process(!1)}catch(t){e.emit("error",t)}})},BunserBuf.prototype.process=function(e){if(this.state==ST_NEED_PDU){if(this.buf.readAvail()<2)return;if(this.expectCode(0),this.expectCode(1),this.pduLen=this.decodeInt(!0),!1===this.pduLen)return void this.buf.readAdvance(-2);this.buf.reserve(this.pduLen),this.state=ST_FILL_PDU}if(this.state==ST_FILL_PDU){if(this.buf.readAvail()<this.pduLen)return;var t=this.decodeAny();if(e)return t;this.emit("value",t),this.state=ST_NEED_PDU}!e&&this.buf.readAvail()>0&&this.processLater()},BunserBuf.prototype.raise=function(e){throw new Error(e+", in Buffer of length "+this.buf.buf.length+" ("+this.buf.readAvail()+" readable) at offset "+this.buf.readOffset+" buffer: "+JSON.stringify(this.buf.buf.slice(this.buf.readOffset,this.buf.readOffset+32).toJSON()))},BunserBuf.prototype.expectCode=function(e){var t=this.buf.readInt(1);t!=e&&this.raise("expected bser opcode "+e+" but got "+t)},BunserBuf.prototype.decodeAny=function(){var e=this.buf.peekInt(1);switch(e){case BSER_INT8:case BSER_INT16:case BSER_INT32:case BSER_INT64:return this.decodeInt();case BSER_REAL:return this.buf.readAdvance(1),this.buf.readDouble();case BSER_TRUE:return this.buf.readAdvance(1),!0;case BSER_FALSE:return this.buf.readAdvance(1),!1;case BSER_NULL:return this.buf.readAdvance(1),null;case BSER_STRING:return this.decodeString();case BSER_ARRAY:return this.decodeArray();case BSER_OBJECT:return this.decodeObject();case BSER_TEMPLATE:return this.decodeTemplate();default:this.raise("unhandled bser opcode "+e)}},BunserBuf.prototype.decodeArray=function(){this.expectCode(BSER_ARRAY);for(var e=this.decodeInt(),t=[],r=0;r<e;++r)t.push(this.decodeAny());return t},BunserBuf.prototype.decodeObject=function(){this.expectCode(BSER_OBJECT);for(var e=this.decodeInt(),t={},r=0;r<e;++r){var i=this.decodeString(),s=this.decodeAny();t[i]=s}return t},BunserBuf.prototype.decodeTemplate=function(){this.expectCode(BSER_TEMPLATE);for(var e=this.decodeArray(),t=this.decodeInt(),r=[],i=0;i<t;++i){for(var s={},n=0;n<e.length;++n)if(this.buf.peekInt(1)!=BSER_SKIP){var f=this.decodeAny();s[e[n]]=f}else this.buf.readAdvance(1);r.push(s)}return r},BunserBuf.prototype.decodeString=function(){this.expectCode(BSER_STRING);var e=this.decodeInt();return this.buf.readString(e)},BunserBuf.prototype.decodeInt=function(e){if(e&&this.buf.readAvail()<1)return!1;this.buf.assertReadableSize(1);var t=this.buf.peekInt(1),r=0;switch(t){case BSER_INT8:r=1;break;case BSER_INT16:r=2;break;case BSER_INT32:r=4;break;case BSER_INT64:r=8;break;default:this.raise("invalid bser int encoding "+t)}return!(e&&this.buf.readAvail()<1+r)&&(this.buf.readAdvance(1),this.buf.readInt(r))},exports.loadFromBuffer=loadFromBuffer,exports.dumpToBuffer=dumpToBuffer;