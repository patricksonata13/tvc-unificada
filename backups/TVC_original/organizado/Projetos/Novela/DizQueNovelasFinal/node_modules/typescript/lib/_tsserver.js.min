/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
"use strict";var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(e,t,r,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of __getOwnPropNames(t))__hasOwnProp.call(e,o)||o===r||__defProp(e,o,{get:()=>t[o],enumerable:!(s=__getOwnPropDesc(t,o))||s.enumerable});return e},__reExport=(e,t,r)=>(__copyProps(e,t,"default"),r&&__copyProps(r,t,"default")),__toESM=(e,t,r)=>(r=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?r:__defProp(r,"default",{value:e,enumerable:!0}),e)),import_os2=__toESM(require("os")),typescript_exports={};__reExport(typescript_exports,require("./typescript.js"));var import_child_process=__toESM(require("child_process")),import_fs=__toESM(require("fs")),import_net=__toESM(require("net")),import_os=__toESM(require("os")),import_readline=__toESM(require("readline"));function getLogLevel(e){if(e){const t=e.toLowerCase();for(const e in typescript_exports.server.LogLevel)if(isNaN(+e)&&t===e.toLowerCase())return typescript_exports.server.LogLevel[e]}}function parseLoggingEnvironmentString(e){if(!e)return{};const t={logToFile:!0},r=e.split(" "),s=r.length-1;for(let e=0;e<s;e+=2){const s=r[e],{value:i,extraPartCounter:n}=o(e+1);if(e+=n,s&&i)switch(s){case"-file":t.file=i;break;case"-level":const e=getLogLevel(i);t.detailLevel=void 0!==e?e:typescript_exports.server.LogLevel.normal;break;case"-traceToConsole":t.traceToConsole="true"===i.toLowerCase();break;case"-logToFile":t.logToFile="true"===i.toLowerCase()}}return t;function o(e){let t=r[e],s=0;if(t.charCodeAt(0)===typescript_exports.CharacterCodes.doubleQuote&&t.charCodeAt(t.length-1)!==typescript_exports.CharacterCodes.doubleQuote)for(let o=e+1;o<r.length&&(t+=" ",t+=r[o],s++,t.charCodeAt(t.length-1)!==typescript_exports.CharacterCodes.doubleQuote);o++);return{value:(0,typescript_exports.stripQuotes)(t),extraPartCounter:s}}}function parseServerMode(){const e=typescript_exports.server.findArgument("--serverMode");if(e)switch(e.toLowerCase()){case"semantic":return typescript_exports.LanguageServiceMode.Semantic;case"partialsemantic":return typescript_exports.LanguageServiceMode.PartialSemantic;case"syntactic":return typescript_exports.LanguageServiceMode.Syntactic;default:return e}}function initializeNodeSystem(){const e=typescript_exports.Debug.checkDefined(typescript_exports.sys);class t{constructor(e,t,r){if(this.logFilename=e,this.traceToConsole=t,this.level=r,this.seq=0,this.inGroup=!1,this.firstInGroup=!0,this.fd=-1,this.logFilename)try{this.fd=import_fs.default.openSync(this.logFilename,"w")}catch{}}static padStringRight(e,t){return(e+t).slice(0,t.length)}close(){this.fd>=0&&import_fs.default.close(this.fd,typescript_exports.noop)}getLogFileName(){return this.logFilename}perftrc(e){this.msg(e,typescript_exports.server.Msg.Perf)}info(e){this.msg(e,typescript_exports.server.Msg.Info)}err(e){this.msg(e,typescript_exports.server.Msg.Err)}startGroup(){this.inGroup=!0,this.firstInGroup=!0}endGroup(){this.inGroup=!1}loggingEnabled(){return!!this.logFilename||this.traceToConsole}hasLevel(e){return this.loggingEnabled()&&this.level>=e}msg(e,r=typescript_exports.server.Msg.Err){if(this.canWrite()){if(e=`[${typescript_exports.server.nowString()}] ${e}\n`,!this.inGroup||this.firstInGroup){e=t.padStringRight(r+" "+this.seq.toString(),"          ")+e}this.write(e,r),this.inGroup||this.seq++}}canWrite(){return this.fd>=0||this.traceToConsole}write(e,t){if(this.fd>=0){const t=Buffer.from(e);import_fs.default.writeSync(this.fd,t,0,t.length,null)}this.traceToConsole&&console.warn(e)}}const r=(0,typescript_exports.getDirectoryPath)((0,typescript_exports.normalizePath)(e.getExecutingFilePath())),s="win32"===process.platform,o=e.watchDirectory.bind(e),i=function(){const e=typescript_exports.server.findArgument("--logFile"),s=getLogLevel(typescript_exports.server.findArgument("--logVerbosity")),o=parseLoggingEnvironmentString(process.env.TSS_LOG),i=e?(0,typescript_exports.stripQuotes)(e):o.logToFile?o.file||r+"/.log"+process.pid.toString():void 0,n=i?i.replace("PID",process.pid.toString()):void 0,p=s||o.detailLevel;return new t(n,o.traceToConsole,p)}();typescript_exports.Debug.loggingHost={log(e,t){switch(e){case typescript_exports.LogLevel.Error:case typescript_exports.LogLevel.Warning:return i.msg(t,typescript_exports.server.Msg.Err);case typescript_exports.LogLevel.Info:case typescript_exports.LogLevel.Verbose:return i.msg(t,typescript_exports.server.Msg.Info)}}};const n=(0,typescript_exports.createQueue)();let p=!0;if(s){const t=_(e.resolvePath(e.getCurrentDirectory()),void 0),s=new Map;e.watchDirectory=(e,o,n,p)=>{const c=_(e,t);let a=c&&s.get(c);if(void 0===a){i.hasLevel(typescript_exports.server.LogLevel.verbose)&&i.info(`${c} for path ${e} not found in cache...`);try{const t=[(0,typescript_exports.combinePaths)(r,"watchGuard.js"),e];i.hasLevel(typescript_exports.server.LogLevel.verbose)&&i.info(`Starting ${process.execPath} with args:${typescript_exports.server.stringifyIndented(t)}`),import_child_process.default.execFileSync(process.execPath,t,{stdio:"ignore",env:{ELECTRON_RUN_AS_NODE:"1"}}),a=!0,i.hasLevel(typescript_exports.server.LogLevel.verbose)&&i.info(`WatchGuard for path ${e} returned: OK`)}catch(t){a=!1,i.hasLevel(typescript_exports.server.LogLevel.verbose)&&i.info(`WatchGuard for path ${e} returned: ${t.message}`)}c&&s.set(c,a)}else i.hasLevel(typescript_exports.server.LogLevel.verbose)&&i.info(`watchDirectory for ${e} uses cached drive information.`);return a?v(e,o,n,p):typescript_exports.noopFileWatcher}}else e.watchDirectory=v;e.write=e=>h(Buffer.from(e,"utf8")),e.setTimeout=setTimeout,e.clearTimeout=clearTimeout,e.setImmediate=setImmediate,e.clearImmediate=clearImmediate,"undefined"!=typeof global&&global.gc&&(e.gc=()=>{var e;return null==(e=global.gc)?void 0:e.call(global)});const c=createCancellationToken(e.args),a=typescript_exports.server.findArgument("--locale");a&&(0,typescript_exports.validateLocaleAndSetLanguage)(a,e);const l=parseServerMode();let g,u;return void 0!==l&&("number"==typeof l?g=l:u=l),{args:process.argv,logger:i,cancellationToken:c,serverMode:g,unknownServerMode:u,startSession:startNodeSession};function h(e){p?(p=!1,process.stdout.write(e,y)):n.enqueue(e)}function y(){p=!0,n.isEmpty()||h(n.dequeue())}function _(e,t){if(e=(0,typescript_exports.normalizeSlashes)(e),(r=e).length>2&&r.charCodeAt(0)===typescript_exports.CharacterCodes.slash&&r.charCodeAt(1)===typescript_exports.CharacterCodes.slash){const t=e.indexOf(typescript_exports.directorySeparator,2);return-1!==t?(0,typescript_exports.toFileNameLowerCase)(e.substring(0,t)):e}var r;return 0===(0,typescript_exports.getRootLength)(e)?t:e.charCodeAt(1)===typescript_exports.CharacterCodes.colon&&e.charCodeAt(2)===typescript_exports.CharacterCodes.slash?(0,typescript_exports.toFileNameLowerCase)(e.charAt(0)):e.charCodeAt(0)===typescript_exports.CharacterCodes.slash&&e.charCodeAt(1)!==typescript_exports.CharacterCodes.slash?t:void 0}function v(e,t,r,s){try{return o(e,t,r,s)}catch(e){return i.info(`Exception when creating directory watcher: ${e.message}`),typescript_exports.noopFileWatcher}}}function parseEventPort(e){const t=void 0===e?void 0:parseInt(e);return void 0===t||isNaN(t)?void 0:t}function startNodeSession(e,t,r){const s=import_readline.default.createInterface({input:process.stdin,output:process.stdout,terminal:!1}),o=class e extends typescript_exports.server.TypingsInstallerAdapter{constructor(t,r,s,o,i,n,p,c,a){super(t,r,s,o,a,e.maxActiveRequestCount),this.typingSafeListLocation=i,this.typesMapLocation=n,this.npmLocation=p,this.validateDefaultNpmLocation=c}createInstallerProcess(){this.logger.hasLevel(typescript_exports.server.LogLevel.requestTime)&&this.logger.info("Binding...");const e=[typescript_exports.server.Arguments.GlobalCacheLocation,this.globalTypingsCacheLocation];this.telemetryEnabled&&e.push(typescript_exports.server.Arguments.EnableTelemetry),this.logger.loggingEnabled()&&this.logger.getLogFileName()&&e.push(typescript_exports.server.Arguments.LogFile,(0,typescript_exports.combinePaths)((0,typescript_exports.getDirectoryPath)((0,typescript_exports.normalizeSlashes)(this.logger.getLogFileName())),`ti-${process.pid}.log`)),this.typingSafeListLocation&&e.push(typescript_exports.server.Arguments.TypingSafeListLocation,this.typingSafeListLocation),this.typesMapLocation&&e.push(typescript_exports.server.Arguments.TypesMapLocation,this.typesMapLocation),this.npmLocation&&e.push(typescript_exports.server.Arguments.NpmLocation,this.npmLocation),this.validateDefaultNpmLocation&&e.push(typescript_exports.server.Arguments.ValidateDefaultNpmLocation);const t=[];for(const e of process.execArgv){const r=/^--((?:debug|inspect)(?:-brk)?)(?:=(\d+))?$/.exec(e);if(r){const e=void 0!==r[2]?+r[2]:"d"===r[1].charAt(0)?5858:9229;t.push(`--${r[1]}=${e+1}`);break}}const r=(0,typescript_exports.combinePaths)((0,typescript_exports.getDirectoryPath)(typescript_exports.sys.getExecutingFilePath()),"typingsInstaller.js");return this.installer=import_child_process.default.fork(r,e,{execArgv:t}),this.installer.on("message",e=>this.handleMessage(e)),this.host.setImmediate(()=>this.event({pid:this.installer.pid},"typingsInstallerPid")),process.on("exit",()=>{this.installer.kill()}),this.installer}};o.maxActiveRequestCount=10;let i=o;class n extends typescript_exports.server.Session{constructor(){const s=typescript_exports.sys,o=u?void 0:new i(y,t,s,function(){switch(process.platform){case"win32":{const e=process.env.LOCALAPPDATA||process.env.APPDATA||import_os.default.homedir&&import_os.default.homedir()||process.env.USERPROFILE||process.env.HOMEDRIVE&&process.env.HOMEPATH&&(0,typescript_exports.normalizeSlashes)(process.env.HOMEDRIVE+process.env.HOMEPATH)||import_os.default.tmpdir();return(0,typescript_exports.combinePaths)((0,typescript_exports.combinePaths)((0,typescript_exports.normalizeSlashes)(e),"Microsoft/TypeScript"),typescript_exports.versionMajorMinor)}case"openbsd":case"freebsd":case"netbsd":case"darwin":case"linux":case"android":{const e=function(e){if(process.env.XDG_CACHE_HOME)return process.env.XDG_CACHE_HOME;const t=e?"Users":"home",r=import_os.default.homedir&&import_os.default.homedir()||process.env.HOME||(process.env.LOGNAME||process.env.USER)&&`/${t}/${process.env.LOGNAME||process.env.USER}`||import_os.default.tmpdir(),s=e?"Library/Caches":".cache";return(0,typescript_exports.combinePaths)((0,typescript_exports.normalizeSlashes)(r),s)}("darwin"===process.platform);return(0,typescript_exports.combinePaths)((0,typescript_exports.combinePaths)(e,"typescript"),typescript_exports.versionMajorMinor)}default:return typescript_exports.Debug.fail(`unsupported platform '${process.platform}'`)}}(),c,a,l,g,(e,t)=>{this.event(e,t)});if(super({host:s,cancellationToken:r,...e,typingsInstaller:o,byteLength:Buffer.byteLength,hrtime:process.hrtime,logger:t,canUseEvents:!0,typesMapLocation:a}),this.eventPort=p,this.canUseEvents&&this.eventPort){const e=import_net.default.connect({port:this.eventPort},()=>{if(this.eventSocket=e,this.socketEventQueue){for(const e of this.socketEventQueue)this.writeToEventSocket(e.body,e.eventName);this.socketEventQueue=void 0}})}this.constructed=!0}event(e,t){if(typescript_exports.Debug.assert(!!this.constructed,"Should only call `IOSession.prototype.event` on an initialized IOSession"),this.canUseEvents&&this.eventPort){if(!this.eventSocket)return this.logger.hasLevel(typescript_exports.server.LogLevel.verbose)&&this.logger.info(`eventPort: event "${t}" queued, but socket not yet initialized`),void(this.socketEventQueue||(this.socketEventQueue=[])).push({body:e,eventName:t});typescript_exports.Debug.assert(void 0===this.socketEventQueue),this.writeToEventSocket(e,t)}else super.event(e,t)}writeToEventSocket(e,t){this.eventSocket.write(typescript_exports.server.formatMessage(typescript_exports.server.toEvent(t,e),this.logger,this.byteLength,this.host.newLine),"utf8")}exit(){var e;this.logger.info("Exiting..."),this.projectService.closeLog(),null==(e=typescript_exports.tracing)||e.stopTracing(),process.exit(0)}listen(){s.on("line",e=>{const t=e.trim();this.onMessage(t)}),s.on("close",()=>{this.exit()})}}const p=parseEventPort(typescript_exports.server.findArgument("--eventPort")),c=typescript_exports.server.findArgument(typescript_exports.server.Arguments.TypingSafeListLocation),a=typescript_exports.server.findArgument(typescript_exports.server.Arguments.TypesMapLocation)||(0,typescript_exports.combinePaths)((0,typescript_exports.getDirectoryPath)(typescript_exports.sys.getExecutingFilePath()),"typesMap.json"),l=typescript_exports.server.findArgument(typescript_exports.server.Arguments.NpmLocation),g=typescript_exports.server.hasArgument(typescript_exports.server.Arguments.ValidateDefaultNpmLocation),u=typescript_exports.server.hasArgument("--disableAutomaticTypingAcquisition"),h=typescript_exports.server.hasArgument("--useNodeIpc"),y=typescript_exports.server.hasArgument(typescript_exports.server.Arguments.EnableTelemetry),_=typescript_exports.server.findArgument("--traceDirectory"),v=_?(0,typescript_exports.stripQuotes)(_):process.env.TSS_TRACE;v&&(0,typescript_exports.startTracing)("server",v);const d=h?new class extends n{writeMessage(e){if(t.hasLevel(typescript_exports.server.LogLevel.verbose)){const r=JSON.stringify(e);t.info(`${e.type}:${typescript_exports.server.indent(r)}`)}process.send(e)}parseMessage(e){return e}toStringMessage(e){return JSON.stringify(e,void 0,2)}listen(){process.on("message",e=>{this.onMessage(e)}),process.on("disconnect",()=>{this.exit()})}}:new n;process.on("uncaughtException",e=>{d.logError(e,"unknown")}),process.noAsar=!0,d.listen()}function pipeExists(e){return import_fs.default.existsSync(e)}function createCancellationToken(e){let t;for(let r=0;r<e.length-1;r++)if("--cancellationPipeName"===e[r]){t=e[r+1];break}if(!t)return typescript_exports.server.nullCancellationToken;if("*"===t.charAt(t.length-1)){const e=t.slice(0,-1);if(0===e.length||e.includes("*"))throw new Error("Invalid name for template cancellation pipe: it should have length greater than 2 characters and contain only one '*'.");let r,s;return{isCancellationRequested:()=>void 0!==r&&pipeExists(r),setRequest(t){s=t,r=e+t},resetRequest(e){if(s!==e)throw new Error(`Mismatched request id, expected ${s}, actual ${e}`);r=void 0}}}return{isCancellationRequested:()=>pipeExists(t),setRequest:e=>{},resetRequest:e=>{}}}function findArgumentStringArray(e){const t=typescript_exports.server.findArgument(e);return void 0===t?typescript_exports.emptyArray:t.split(",").filter(e=>""!==e)}function start({args:e,logger:t,cancellationToken:r,serverMode:s,unknownServerMode:o,startSession:i},n){t.info("Starting TS Server"),t.info(`Version: ${typescript_exports.version}`),t.info(`Arguments: ${e.join(" ")}`),t.info(`Platform: ${n} NodeVersion: ${process.version} CaseSensitive: ${typescript_exports.sys.useCaseSensitiveFileNames}`),t.info(`ServerMode: ${s} hasUnknownServerMode: ${o}`),typescript_exports.setStackTraceLimit(),typescript_exports.Debug.isDebugging&&typescript_exports.Debug.enableDebugInfo(),typescript_exports.sys.tryEnableSourceMapsForHost&&/^development$/i.test(typescript_exports.sys.getEnvironmentVariable("NODE_ENV"))&&typescript_exports.sys.tryEnableSourceMapsForHost(),console.log=(...e)=>t.msg(1===e.length?e[0]:e.join(", "),typescript_exports.server.Msg.Info),console.warn=(...e)=>t.msg(1===e.length?e[0]:e.join(", "),typescript_exports.server.Msg.Err),console.error=(...e)=>t.msg(1===e.length?e[0]:e.join(", "),typescript_exports.server.Msg.Err),i({globalPlugins:findArgumentStringArray("--globalPlugins"),pluginProbeLocations:findArgumentStringArray("--pluginProbeLocations"),allowLocalPluginLoads:typescript_exports.server.hasArgument("--allowLocalPluginLoads"),useSingleInferredProject:typescript_exports.server.hasArgument("--useSingleInferredProject"),useInferredProjectPerProjectRoot:typescript_exports.server.hasArgument("--useInferredProjectPerProjectRoot"),suppressDiagnosticEvents:typescript_exports.server.hasArgument("--suppressDiagnosticEvents"),noGetErrOnBackgroundUpdate:typescript_exports.server.hasArgument("--noGetErrOnBackgroundUpdate"),canUseWatchEvents:typescript_exports.server.hasArgument("--canUseWatchEvents"),serverMode:s},t,r)}typescript_exports.setStackTraceLimit(),start(initializeNodeSystem(),import_os2.default.platform());