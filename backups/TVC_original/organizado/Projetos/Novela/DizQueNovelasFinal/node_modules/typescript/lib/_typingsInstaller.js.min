/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
"use strict";var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(e,t,s,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of __getOwnPropNames(t))__hasOwnProp.call(e,r)||r===s||__defProp(e,r,{get:()=>t[r],enumerable:!(i=__getOwnPropDesc(t,r))||i.enumerable});return e},__reExport=(e,t,s)=>(__copyProps(e,t,"default"),s&&__copyProps(s,t,"default")),__toESM=(e,t,s)=>(s=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?s:__defProp(s,"default",{value:e,enumerable:!0}),e)),import_child_process=require("child_process"),fs=__toESM(require("fs")),path=__toESM(require("path")),typescript_exports={};__reExport(typescript_exports,require("./typescript.js"));var FileLog=class{constructor(e){this.logFile=e,this.isEnabled=()=>"string"==typeof this.logFile,this.writeLine=e=>{if("string"==typeof this.logFile)try{fs.appendFileSync(this.logFile,`[${typescript_exports.server.nowString()}] ${e}${typescript_exports.sys.newLine}`)}catch{this.logFile=void 0}}}};function getDefaultNPMLocation(e,t,s){if(0===path.basename(e).indexOf("node")){const e=path.join(path.dirname(process.argv[0]),"npm");if(!t)return e;if(s.fileExists(e))return`"${e}"`}return"npm"}function loadTypesRegistryFile(e,t,s){if(!t.fileExists(e))return s.isEnabled()&&s.writeLine(`Types registry file '${e}' does not exist`),new Map;try{const s=JSON.parse(t.readFile(e));return new Map(Object.entries(s.entries))}catch(t){return s.isEnabled()&&s.writeLine(`Error when loading types registry file '${e}': ${t.message}, ${t.stack}`),new Map}}var typesRegistryPackageName="types-registry";function getTypesRegistryFileLocation(e){return(0,typescript_exports.combinePaths)((0,typescript_exports.normalizeSlashes)(e),`node_modules/${typesRegistryPackageName}/index.json`)}var installer,NodeTypingsInstaller=class extends typescript_exports.server.typingsInstaller.TypingsInstaller{constructor(e,t,s,i,r,n,o){const p=(0,typescript_exports.getDirectoryPath)((0,typescript_exports.normalizePath)(typescript_exports.sys.getExecutingFilePath()));super(typescript_exports.sys,e,t?(0,typescript_exports.toPath)(t,"",(0,typescript_exports.createGetCanonicalFileName)(typescript_exports.sys.useCaseSensitiveFileNames)):(0,typescript_exports.toPath)("typingSafeList.json",p,(0,typescript_exports.createGetCanonicalFileName)(typescript_exports.sys.useCaseSensitiveFileNames)),s?(0,typescript_exports.toPath)(s,"",(0,typescript_exports.createGetCanonicalFileName)(typescript_exports.sys.useCaseSensitiveFileNames)):(0,typescript_exports.toPath)("typesMap.json",p,(0,typescript_exports.createGetCanonicalFileName)(typescript_exports.sys.useCaseSensitiveFileNames)),n,o),this.npmPath=void 0!==i?i:getDefaultNPMLocation(process.argv[0],r,this.installTypingHost),this.npmPath.includes(" ")&&'"'!==this.npmPath[0]&&(this.npmPath=`"${this.npmPath}"`),this.log.isEnabled()&&(this.log.writeLine(`Process id: ${process.pid}`),this.log.writeLine(`NPM location: ${this.npmPath} (explicit '${typescript_exports.server.Arguments.NpmLocation}' ${void 0===i?"not ":""} provided)`),this.log.writeLine(`validateDefaultNpmLocation: ${r}`)),this.ensurePackageDirectoryExists(e);try{this.log.isEnabled()&&this.log.writeLine(`Updating ${typesRegistryPackageName} npm package...`),this.execSyncAndLog(`${this.npmPath} install --ignore-scripts ${typesRegistryPackageName}@${this.latestDistTag}`,{cwd:e}),this.log.isEnabled()&&this.log.writeLine(`Updated ${typesRegistryPackageName} npm package`)}catch(e){this.log.isEnabled()&&this.log.writeLine(`Error updating ${typesRegistryPackageName} package: ${e.message}`),this.delayedInitializationError={kind:"event::initializationFailed",message:e.message,stack:e.stack}}this.typesRegistry=loadTypesRegistryFile(getTypesRegistryFileLocation(e),this.installTypingHost,this.log)}handleRequest(e){this.delayedInitializationError&&(this.sendResponse(this.delayedInitializationError),this.delayedInitializationError=void 0),super.handleRequest(e)}sendResponse(e){this.log.isEnabled()&&this.log.writeLine(`Sending response:${typescript_exports.server.stringifyIndented(e)}`),process.send(e),this.log.isEnabled()&&this.log.writeLine("Response has been sent.")}installWorker(e,t,s,i){this.log.isEnabled()&&this.log.writeLine(`#${e} with cwd: ${s} arguments: ${JSON.stringify(t)}`);const r=Date.now(),n=typescript_exports.server.typingsInstaller.installNpmPackages(this.npmPath,typescript_exports.version,t,e=>this.execSyncAndLog(e,{cwd:s}));this.log.isEnabled()&&this.log.writeLine(`npm install #${e} took: ${Date.now()-r} ms`),i(!n)}execSyncAndLog(e,t){this.log.isEnabled()&&this.log.writeLine(`Exec: ${e}`);try{const s=(0,import_child_process.execSync)(e,{...t,encoding:"utf-8"});return this.log.isEnabled()&&this.log.writeLine(`    Succeeded. stdout:${indent(typescript_exports.sys.newLine,s)}`),!1}catch(e){const{stdout:t,stderr:s}=e;return this.log.writeLine(`    Failed. stdout:${indent(typescript_exports.sys.newLine,t)}${typescript_exports.sys.newLine}    stderr:${indent(typescript_exports.sys.newLine,s)}`),!0}}},logFilePath=typescript_exports.server.findArgument(typescript_exports.server.Arguments.LogFile),globalTypingsCacheLocation=typescript_exports.server.findArgument(typescript_exports.server.Arguments.GlobalCacheLocation),typingSafeListLocation=typescript_exports.server.findArgument(typescript_exports.server.Arguments.TypingSafeListLocation),typesMapLocation=typescript_exports.server.findArgument(typescript_exports.server.Arguments.TypesMapLocation),npmLocation=typescript_exports.server.findArgument(typescript_exports.server.Arguments.NpmLocation),validateDefaultNpmLocation=typescript_exports.server.hasArgument(typescript_exports.server.Arguments.ValidateDefaultNpmLocation),log=new FileLog(logFilePath);function indent(e,t){return t&&t.length?`${e}    `+t.replace(/\r?\n/,`${e}    `):""}log.isEnabled()&&process.on("uncaughtException",e=>{log.writeLine(`Unhandled exception: ${e} at ${e.stack}`)}),process.on("disconnect",()=>{log.isEnabled()&&log.writeLine("Parent process has exited, shutting down..."),process.exit(0)}),process.on("message",e=>{installer??(installer=new NodeTypingsInstaller(globalTypingsCacheLocation,typingSafeListLocation,typesMapLocation,npmLocation,validateDefaultNpmLocation,5,log)),installer.handleRequest(e)});