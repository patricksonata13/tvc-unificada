"use strict";const path=require("path"),{promisify:promisify}=require("util"),glob=promisify(require("glob")),minimatch=require("minimatch"),{defaults:defaults}=require("@istanbuljs/schema"),isOutsideDir=require("./is-outside-dir");class TestExclude{constructor(e={}){Object.assign(this,{relativePath:!0},defaults.testExclude);for(const[t,i]of Object.entries(e))void 0!==i&&(this[t]=i);"string"==typeof this.include&&(this.include=[this.include]),"string"==typeof this.exclude&&(this.exclude=[this.exclude]),"string"==typeof this.extension?this.extension=[this.extension]:0===this.extension.length&&(this.extension=!1),this.include&&this.include.length>0?this.include=prepGlobPatterns([].concat(this.include)):this.include=!1,this.excludeNodeModules&&!this.exclude.includes("**/node_modules/**")&&(this.exclude=this.exclude.concat("**/node_modules/**")),this.exclude=prepGlobPatterns([].concat(this.exclude)),this.handleNegation()}handleNegation(){const e=e=>"!"!==e.charAt(0),t=e=>"!"===e.charAt(0),i=e=>e.slice(1);if(Array.isArray(this.include)){const s=this.include.filter(t).map(i);this.exclude.push(...prepGlobPatterns(s)),this.include=this.include.filter(e)}this.excludeNegated=this.exclude.filter(t).map(i),this.exclude=this.exclude.filter(e),this.excludeNegated=prepGlobPatterns(this.excludeNegated)}shouldInstrument(e,t){if(this.extension&&!this.extension.some(t=>e.endsWith(t)))return!1;let i=e;if(this.relativePath){if(t=t||path.relative(this.cwd,e),isOutsideDir(this.cwd,e))return!1;i=t.replace(/^\.[\\/]/,"")}const s={dot:!0},n=e=>minimatch(i,e,s);return(!this.include||this.include.some(n))&&(!this.exclude.some(n)||this.excludeNegated.some(n))}globSync(e=this.cwd){const t=getExtensionPattern(this.extension||[]),i={cwd:e,nodir:!0,dot:!0};return 0===this.excludeNegated.length&&(i.ignore=this.exclude),glob.sync(t,i).filter(t=>this.shouldInstrument(path.resolve(e,t)))}async glob(e=this.cwd){const t=getExtensionPattern(this.extension||[]),i={cwd:e,nodir:!0,dot:!0};0===this.excludeNegated.length&&(i.ignore=this.exclude);return(await glob(t,i)).filter(t=>this.shouldInstrument(path.resolve(e,t)))}}function prepGlobPatterns(e){return e.reduce((e,t)=>(/\/\*\*$/.test(t)||(e=e.concat(t.replace(/\/$/,"")+"/**")),/^\*\*\//.test(t)&&(e=e.concat(t.replace(/^\*\*\//,""))),e.concat(t)),[])}function getExtensionPattern(e){switch(e.length){case 0:return"**";case 1:return`**/*${e[0]}`;default:return`**/*{${e.join()}}`}}module.exports=TestExclude;