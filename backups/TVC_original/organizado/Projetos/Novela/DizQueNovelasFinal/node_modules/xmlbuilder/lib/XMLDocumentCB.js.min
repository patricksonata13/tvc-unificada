(function(){var t,e,r,i,n,s,h,o,u,a,l,c,d,p,w,v,L,m,y,N,D,O,f={}.hasOwnProperty;({isObject:D,isFunction:N,isPlainObject:O,getValue:y}=require("./Utility")),t=require("./NodeType"),c=require("./XMLDocument"),d=require("./XMLElement"),i=require("./XMLCData"),n=require("./XMLComment"),w=require("./XMLRaw"),m=require("./XMLText"),p=require("./XMLProcessingInstruction"),a=require("./XMLDeclaration"),l=require("./XMLDocType"),s=require("./XMLDTDAttList"),o=require("./XMLDTDEntity"),h=require("./XMLDTDElement"),u=require("./XMLDTDNotation"),r=require("./XMLAttribute"),L=require("./XMLStringifier"),v=require("./XMLStringWriter"),e=require("./WriterState"),module.exports=class{constructor(e,r,i){var n;this.name="?xml",this.type=t.Document,e||(e={}),n={},e.writer?O(e.writer)&&(n=e.writer,e.writer=new v):e.writer=new v,this.options=e,this.writer=e.writer,this.writerOptions=this.writer.filterOptions(n),this.stringify=new L(e),this.onDataCallback=r||function(){},this.onEndCallback=i||function(){},this.currentNode=null,this.currentLevel=-1,this.openTags={},this.documentStarted=!1,this.documentCompleted=!1,this.root=null}createChildNode(e){var r,i,n,s,h,o,u,a;switch(e.type){case t.CData:this.cdata(e.value);break;case t.Comment:this.comment(e.value);break;case t.Element:for(i in n={},u=e.attribs)f.call(u,i)&&(r=u[i],n[i]=r.value);this.node(e.name,n);break;case t.Dummy:this.dummy();break;case t.Raw:this.raw(e.value);break;case t.Text:this.text(e.value);break;case t.ProcessingInstruction:this.instruction(e.target,e.value);break;default:throw new Error("This XML node type is not supported in a JS object: "+e.constructor.name)}for(h=0,o=(a=e.children).length;h<o;h++)s=a[h],this.createChildNode(s),s.type===t.Element&&this.up();return this}dummy(){return this}node(t,e,r){if(null==t)throw new Error("Missing node name.");if(this.root&&-1===this.currentLevel)throw new Error("Document can only have one root node. "+this.debugInfo(t));return this.openCurrent(),t=y(t),null==e&&(e={}),e=y(e),D(e)||([r,e]=[e,r]),this.currentNode=new d(this,t,e),this.currentNode.children=!1,this.currentLevel++,this.openTags[this.currentLevel]=this.currentNode,null!=r&&this.text(r),this}element(e,r,i){var n,s,h,o,u,a;if(this.currentNode&&this.currentNode.type===t.DocType)this.dtdElement(...arguments);else if(Array.isArray(e)||D(e)||N(e))for(o=this.options.noValidation,this.options.noValidation=!0,(a=new c(this.options).element("TEMP_ROOT")).element(e),this.options.noValidation=o,s=0,h=(u=a.children).length;s<h;s++)n=u[s],this.createChildNode(n),n.type===t.Element&&this.up();else this.node(e,r,i);return this}attribute(t,e){var i,n;if(!this.currentNode||this.currentNode.children)throw new Error("att() can only be used immediately after an ele() call in callback mode. "+this.debugInfo(t));if(null!=t&&(t=y(t)),D(t))for(i in t)f.call(t,i)&&(n=t[i],this.attribute(i,n));else N(e)&&(e=e.apply()),this.options.keepNullAttributes&&null==e?this.currentNode.attribs[t]=new r(this,t,""):null!=e&&(this.currentNode.attribs[t]=new r(this,t,e));return this}text(t){var e;return this.openCurrent(),e=new m(this,t),this.onData(this.writer.text(e,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}cdata(t){var e;return this.openCurrent(),e=new i(this,t),this.onData(this.writer.cdata(e,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}comment(t){var e;return this.openCurrent(),e=new n(this,t),this.onData(this.writer.comment(e,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}raw(t){var e;return this.openCurrent(),e=new w(this,t),this.onData(this.writer.raw(e,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}instruction(t,e){var r,i,n,s,h;if(this.openCurrent(),null!=t&&(t=y(t)),null!=e&&(e=y(e)),Array.isArray(t))for(r=0,s=t.length;r<s;r++)i=t[r],this.instruction(i);else if(D(t))for(i in t)f.call(t,i)&&(n=t[i],this.instruction(i,n));else N(e)&&(e=e.apply()),h=new p(this,t,e),this.onData(this.writer.processingInstruction(h,this.writerOptions,this.currentLevel+1),this.currentLevel+1);return this}declaration(t,e,r){var i;if(this.openCurrent(),this.documentStarted)throw new Error("declaration() must be the first node.");return i=new a(this,t,e,r),this.onData(this.writer.declaration(i,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}doctype(t,e,r){if(this.openCurrent(),null==t)throw new Error("Missing root node name.");if(this.root)throw new Error("dtd() must come before the root node.");return this.currentNode=new l(this,e,r),this.currentNode.rootNodeName=t,this.currentNode.children=!1,this.currentLevel++,this.openTags[this.currentLevel]=this.currentNode,this}dtdElement(t,e){var r;return this.openCurrent(),r=new h(this,t,e),this.onData(this.writer.dtdElement(r,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}attList(t,e,r,i,n){var h;return this.openCurrent(),h=new s(this,t,e,r,i,n),this.onData(this.writer.dtdAttList(h,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}entity(t,e){var r;return this.openCurrent(),r=new o(this,!1,t,e),this.onData(this.writer.dtdEntity(r,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}pEntity(t,e){var r;return this.openCurrent(),r=new o(this,!0,t,e),this.onData(this.writer.dtdEntity(r,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}notation(t,e){var r;return this.openCurrent(),r=new u(this,t,e),this.onData(this.writer.dtdNotation(r,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this}up(){if(this.currentLevel<0)throw new Error("The document node has no parent.");return this.currentNode?(this.currentNode.children?this.closeNode(this.currentNode):this.openNode(this.currentNode),this.currentNode=null):this.closeNode(this.openTags[this.currentLevel]),delete this.openTags[this.currentLevel],this.currentLevel--,this}end(){for(;this.currentLevel>=0;)this.up();return this.onEnd()}openCurrent(){if(this.currentNode)return this.currentNode.children=!0,this.openNode(this.currentNode)}openNode(r){var i,n,s,h;if(!r.isOpen){if(this.root||0!==this.currentLevel||r.type!==t.Element||(this.root=r),n="",r.type===t.Element){for(s in this.writerOptions.state=e.OpenTag,n=this.writer.indent(r,this.writerOptions,this.currentLevel)+"<"+r.name,h=r.attribs)f.call(h,s)&&(i=h[s],n+=this.writer.attribute(i,this.writerOptions,this.currentLevel));n+=(r.children?">":"/>")+this.writer.endline(r,this.writerOptions,this.currentLevel),this.writerOptions.state=e.InsideTag}else this.writerOptions.state=e.OpenTag,n=this.writer.indent(r,this.writerOptions,this.currentLevel)+"<!DOCTYPE "+r.rootNodeName,r.pubID&&r.sysID?n+=' PUBLIC "'+r.pubID+'" "'+r.sysID+'"':r.sysID&&(n+=' SYSTEM "'+r.sysID+'"'),r.children?(n+=" [",this.writerOptions.state=e.InsideTag):(this.writerOptions.state=e.CloseTag,n+=">"),n+=this.writer.endline(r,this.writerOptions,this.currentLevel);return this.onData(n,this.currentLevel),r.isOpen=!0}}closeNode(r){var i;if(!r.isClosed)return i="",this.writerOptions.state=e.CloseTag,i=r.type===t.Element?this.writer.indent(r,this.writerOptions,this.currentLevel)+"</"+r.name+">"+this.writer.endline(r,this.writerOptions,this.currentLevel):this.writer.indent(r,this.writerOptions,this.currentLevel)+"]>"+this.writer.endline(r,this.writerOptions,this.currentLevel),this.writerOptions.state=e.None,this.onData(i,this.currentLevel),r.isClosed=!0}onData(t,e){return this.documentStarted=!0,this.onDataCallback(t,e+1)}onEnd(){return this.documentCompleted=!0,this.onEndCallback()}debugInfo(t){return null==t?"":"node: <"+t+">"}ele(){return this.element(...arguments)}nod(t,e,r){return this.node(t,e,r)}txt(t){return this.text(t)}dat(t){return this.cdata(t)}com(t){return this.comment(t)}ins(t,e){return this.instruction(t,e)}dec(t,e,r){return this.declaration(t,e,r)}dtd(t,e,r){return this.doctype(t,e,r)}e(t,e,r){return this.element(t,e,r)}n(t,e,r){return this.node(t,e,r)}t(t){return this.text(t)}d(t){return this.cdata(t)}c(t){return this.comment(t)}r(t){return this.raw(t)}i(t,e){return this.instruction(t,e)}att(){return this.currentNode&&this.currentNode.type===t.DocType?this.attList(...arguments):this.attribute(...arguments)}a(){return this.currentNode&&this.currentNode.type===t.DocType?this.attList(...arguments):this.attribute(...arguments)}ent(t,e){return this.entity(t,e)}pent(t,e){return this.pEntity(t,e)}not(t,e){return this.notation(t,e)}}}).call(this);