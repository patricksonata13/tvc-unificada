var feature=require("caniuse-lite/dist/unpacker/feature").default,region=require("caniuse-lite/dist/unpacker/region").default,fs=require("fs"),path=require("path"),BrowserslistError=require("./error"),IS_SECTION=/^\s*\[(.+)]\s*$/,CONFIG_PATTERN=/^browserslist-config-/,SCOPED_CONFIG__PATTERN=/@[^/]+(?:\/[^/]+)?\/browserslist-config(?:-|$|\/)/,FORMAT="Browserslist config should be a string or an array of strings with browser queries",PATHTYPE_UNKNOWN="unknown",PATHTYPE_DIR="directory",PATHTYPE_FILE="file",dataTimeChecked=!1,statCache={},configPathCache={},parseConfigCache={};function checkExtend(e){var r=" Use `dangerousExtend` option to disable.";if(!CONFIG_PATTERN.test(e)&&!SCOPED_CONFIG__PATTERN.test(e))throw new BrowserslistError("Browserslist config needs `browserslist-config-` prefix. "+r);if(-1!==e.replace(/^@[^/]+\//,"").indexOf("."))throw new BrowserslistError("`.` not allowed in Browserslist config name. "+r);if(-1!==e.indexOf("node_modules"))throw new BrowserslistError("`node_modules` not allowed in Browserslist config."+r)}function getPathType(e){var r;try{r=fs.existsSync(e)&&fs.statSync(e)}catch(e){if("ENOENT"!==e.code&&"EACCES"!==e.code&&"ERR_ACCESS_DENIED"!==e.code)throw e}return r&&r.isDirectory()?PATHTYPE_DIR:r&&r.isFile()?PATHTYPE_FILE:PATHTYPE_UNKNOWN}function isFile(e){return getPathType(e)===PATHTYPE_FILE}function isDirectory(e){return getPathType(e)===PATHTYPE_DIR}function eachParent(e,r,s){var t,n=path.resolve(e),o=[];do{if(!pathInRoot(n))break;if(s&&n in s){t=s[n];break}if(o.push(n),isDirectory(n)){var i=r(n);if(void 0!==i){t=i;break}}}while(n!==(n=path.dirname(n)));return s&&!process.env.BROWSERSLIST_DISABLE_CACHE&&o.forEach(function(e){s[e]=t}),t}function pathInRoot(e){if(!process.env.BROWSERSLIST_ROOT_PATH)return!0;var r=path.resolve(process.env.BROWSERSLIST_ROOT_PATH);return".."!==path.relative(r,e).substring(0,2)}function check(e){if(Array.isArray(e)){for(var r=0;r<e.length;r++)if("string"!=typeof e[r])throw new BrowserslistError(FORMAT)}else if("string"!=typeof e)throw new BrowserslistError(FORMAT)}function pickEnv(e,r){if("object"!=typeof e)return e;var s;if(s="string"==typeof r.env?r.env:process.env.BROWSERSLIST_ENV?process.env.BROWSERSLIST_ENV:process.env.NODE_ENV?process.env.NODE_ENV:"production",r.throwOnMissing&&s&&"defaults"!==s&&!e[s])throw new BrowserslistError("Missing config for Browserslist environment `"+s+"`");return e[s]||e.defaults}function parsePackage(e){var r,s=fs.readFileSync(e).toString().replace(/^\uFEFF/m,"");if(s.indexOf('"browserslist"')>=0)r=JSON.parse(s).browserslist;else if(s.indexOf('"browserlist"')>=0){var t=JSON.parse(s);if(t.browserlist&&!t.browserslist)throw new BrowserslistError("`browserlist` key instead of `browserslist` in "+e)}for(var n in(Array.isArray(r)||"string"==typeof r)&&(r={defaults:r}),r)check(r[n]);return r}function parsePackageOrReadConfig(e){if(e in parseConfigCache)return parseConfigCache[e];var r="package.json"===path.basename(e)?parsePackage(e):module.exports.readConfig(e);return process.env.BROWSERSLIST_DISABLE_CACHE||(parseConfigCache[e]=r),r}function latestReleaseTime(e){var r=0;for(var s in e){var t=e[s].releaseDate||{};for(var n in t)r<t[n]&&(r=t[n])}return 1e3*r}function getMonthsPassed(e){var r=new Date,s=new Date(e);return 12*(r.getFullYear()-s.getFullYear())+(r.getMonth()-s.getMonth())}function normalizeStats(e,r){if(e||(e={}),r&&"dataByBrowser"in r&&(r=r.dataByBrowser),"object"==typeof r){var s={};for(var t in r){var n=Object.keys(r[t]);if(1===n.length&&e[t]&&1===e[t].versions.length){var o=e[t].versions[0];s[t]={},s[t][o]=r[t][n[0]]}else s[t]=r[t]}return s}}function normalizeUsageData(e,r){for(var s in e){var t=e[s];if("0"in t){var n=r[s].versions;t[n[n.length-1]]=t[0],delete t[0]}}}module.exports={loadQueries:function(e,r){e.dangerousExtend||process.env.BROWSERSLIST_DANGEROUS_EXTEND||checkExtend(r);var s=require(require.resolve(r,{paths:[".",e.path]}));if("object"==typeof s&&null!==s&&s.__esModule&&(s=s.default),s){if(Array.isArray(s))return s;if("object"==typeof s)return s.defaults||(s.defaults=[]),pickEnv(s,e,r)}throw new BrowserslistError("`"+r+"` config exports not an array of queries or an object of envs")},loadStat:function(e,r,s){return e.dangerousExtend||process.env.BROWSERSLIST_DANGEROUS_EXTEND||checkExtend(r),normalizeStats(s,require(require.resolve(path.posix.join(r,"browserslist-stats.json"),{paths:["."]})))},getStat:function(e,r){var s;if(e.stats?s=e.stats:process.env.BROWSERSLIST_STATS?s=process.env.BROWSERSLIST_STATS:e.path&&path.resolve&&fs.existsSync&&(s=eachParent(e.path,function(e){var r=path.join(e,"browserslist-stats.json");return isFile(r)?r:void 0},statCache)),"string"==typeof s)try{s=JSON.parse(fs.readFileSync(s))}catch(e){throw new BrowserslistError("Can't read "+s)}return normalizeStats(r,s)},loadConfig:function(e){return process.env.BROWSERSLIST?process.env.BROWSERSLIST:e.config||process.env.BROWSERSLIST_CONFIG?pickEnv(parsePackageOrReadConfig(e.config||process.env.BROWSERSLIST_CONFIG),e):e.path?pickEnv(module.exports.findConfig(e.path),e):void 0},loadCountry:function(e,r,s){var t=r.replace(/[^\w-]/g,"");if(!e[t]){var n;try{n=require("caniuse-lite/data/regions/"+t+".js")}catch(e){throw new BrowserslistError("Unknown region name `"+t+"`.")}var o=region(n);for(var i in normalizeUsageData(o,s),e[r]={},o)for(var a in o[i])e[r][i+" "+a]=o[i][a]}},loadFeature:function(e,r){if(!e[r=r.replace(/[^\w-]/g,"")]){var s;try{s=require("caniuse-lite/data/features/"+r+".js")}catch(e){throw new BrowserslistError("Unknown feature name `"+r+"`.")}var t=feature(s).stats;for(var n in e[r]={},t)for(var o in e[r][n]={},t[n])e[r][n][o]=t[n][o]}},parseConfig:function(e){var r={defaults:[]},s=["defaults"];return e.toString().replace(/#[^\n]*/g,"").split(/\n|,/).map(function(e){return e.trim()}).filter(function(e){return""!==e}).forEach(function(e){IS_SECTION.test(e)?(s=e.match(IS_SECTION)[1].trim().split(" ")).forEach(function(e){if(r[e])throw new BrowserslistError("Duplicate section "+e+" in Browserslist config");r[e]=[]}):s.forEach(function(s){r[s].push(e)})}),r},readConfig:function(e){if(!isFile(e))throw new BrowserslistError("Can't read "+e+" config");return module.exports.parseConfig(fs.readFileSync(e))},findConfigFile:function(e){return eachParent(e,function(e){var r,s=path.join(e,"browserslist"),t=path.join(e,"package.json"),n=path.join(e,".browserslistrc");if(isFile(t))try{r=parsePackage(t)}catch(e){if("BrowserslistError"===e.name)throw e;console.warn("[Browserslist] Could not parse "+t+". Ignoring it.")}if(isFile(s)&&r)throw new BrowserslistError(e+" contains both browserslist and package.json with browsers");if(isFile(n)&&r)throw new BrowserslistError(e+" contains both .browserslistrc and package.json with browsers");if(isFile(s)&&isFile(n))throw new BrowserslistError(e+" contains both .browserslistrc and browserslist");return isFile(s)?s:isFile(n)?n:r?t:void 0},configPathCache)},findConfig:function(e){var r=this.findConfigFile(e);return r?parsePackageOrReadConfig(r):void 0},clearCaches:function(){dataTimeChecked=!1,statCache={},configPathCache={},parseConfigCache={},this.cache={}},oldDataWarning:function(e){if(!dataTimeChecked&&(dataTimeChecked=!0,!process.env.BROWSERSLIST_IGNORE_OLD_DATA)){var r=latestReleaseTime(e),s=getMonthsPassed(r);if(0!==r&&s>=6){process.env.BROWSERSLIST_TRACE_WARNING&&(console.info("Last browser release in DB: "+String(new Date(r))),console.trace());var t=s+" "+(s>1?"months":"month");console.warn("Browserslist: browsers data (caniuse-lite) is "+t+" old. Please run:\n  npx update-browserslist-db@latest\n  Why you should do it regularly: https://github.com/browserslist/update-db#readme")}}},currentNode:function(){return"node "+process.versions.node},env:process.env};