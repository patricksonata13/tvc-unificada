/*!
 * node-progress
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
function ProgressBar(t,r){if(this.stream=r.stream||process.stderr,"number"==typeof r){var e=r;(r={}).total=e}else{if(r=r||{},"string"!=typeof t)throw new Error("format required");if("number"!=typeof r.total)throw new Error("total required")}this.fmt=t,this.curr=r.curr||0,this.total=r.total,this.width=r.width||this.total,this.clear=r.clear,this.chars={complete:r.complete||"=",incomplete:r.incomplete||"-",head:r.head||r.complete||"="},this.renderThrottle=0!==r.renderThrottle?r.renderThrottle||16:0,this.lastRender=-1/0,this.callback=r.callback||function(){},this.tokens={},this.lastDraw=""}exports=module.exports=ProgressBar,ProgressBar.prototype.tick=function(t,r){if(0!==t&&(t=t||1),"object"==typeof t&&(r=t,t=1),r&&(this.tokens=r),0==this.curr&&(this.start=new Date),this.curr+=t,this.render(),this.curr>=this.total)return this.render(void 0,!0),this.complete=!0,this.terminate(),void this.callback(this)},ProgressBar.prototype.render=function(t,r){if(r=void 0!==r&&r,t&&(this.tokens=t),this.stream.isTTY){var e=Date.now(),s=e-this.lastRender;if(r||!(s<this.renderThrottle)){this.lastRender=e;var i=this.curr/this.total;i=Math.min(Math.max(i,0),1);var a,h,o,n=Math.floor(100*i),c=new Date-this.start,l=100==n?0:c*(this.total/this.curr-1),m=this.curr/(c/1e3),p=this.fmt.replace(":current",this.curr).replace(":total",this.total).replace(":elapsed",isNaN(c)?"0.0":(c/1e3).toFixed(1)).replace(":eta",isNaN(l)||!isFinite(l)?"0.0":(l/1e3).toFixed(1)).replace(":percent",n.toFixed(0)+"%").replace(":rate",Math.round(m)),u=Math.max(0,this.stream.columns-p.replace(":bar","").length);u&&"win32"===process.platform&&(u-=1);var d=Math.min(this.width,u);if(o=Math.round(d*i),h=Array(Math.max(0,o+1)).join(this.chars.complete),a=Array(Math.max(0,d-o+1)).join(this.chars.incomplete),o>0&&(h=h.slice(0,-1)+this.chars.head),p=p.replace(":bar",h+a),this.tokens)for(var f in this.tokens)p=p.replace(":"+f,this.tokens[f]);this.lastDraw!==p&&(this.stream.cursorTo(0),this.stream.write(p),this.stream.clearLine(1),this.lastDraw=p)}}},ProgressBar.prototype.update=function(t,r){var e=Math.floor(t*this.total)-this.curr;this.tick(e,r)},ProgressBar.prototype.interrupt=function(t){this.stream.clearLine(),this.stream.cursorTo(0),this.stream.write(t),this.stream.write("\n"),this.stream.write(this.lastDraw)},ProgressBar.prototype.terminate=function(){this.clear?this.stream.clearLine&&(this.stream.clearLine(),this.stream.cursorTo(0)):this.stream.write("\n")};