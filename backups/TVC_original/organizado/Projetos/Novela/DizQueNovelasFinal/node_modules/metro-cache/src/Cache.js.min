"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _metroCore=require("metro-core");class Cache{#e;#t=new WeakMap;constructor(e){this.#e=e}async get(e){const t=this.#e,r=t.length;for(let o=0;o<r;o++){const r=t[o],n=(r.name??r.constructor.name)+"::"+e.toString("hex");let a=null;const s=_metroCore.Logger.log(_metroCore.Logger.createActionStartEntry({action_name:"Cache get",log_entry_label:n}));try{const t=r.get(e);a=t&&"function"==typeof t.then?await t:t}finally{const t=null!=a?"hit":"miss";if(_metroCore.Logger.log({..._metroCore.Logger.createActionEndEntry(s),action_result:t}),_metroCore.Logger.log(_metroCore.Logger.createEntry({action_name:"Cache "+t,log_entry_label:n})),null!=a)return this.#t.set(e,r),a}}return null}async set(e,t){const r=this.#e,o=this.#t.get(e),n=r.length,a=[],s=[],g=new Set;for(let c=0;c<n&&r[c]!==o;c++){const o=r[c],n=o.name??o.constructor.name,l=n+"::"+e.toString("hex"),i=_metroCore.Logger.log(_metroCore.Logger.createActionStartEntry({action_name:"Cache set",log_entry_label:l}));a.push((async()=>{try{await r[c].set(e,t),_metroCore.Logger.log(_metroCore.Logger.createActionEndEntry(i))}catch(e){_metroCore.Logger.log(_metroCore.Logger.createActionEndEntry(i,e)),g.add(n),s.push(new Error(`Cache write failed for ${l}`,{cause:e}))}})())}if(await Promise.allSettled(a),s.length>0)throw new AggregateError(s,`Cache write failed for store(s): ${Array.from(g).join(", ")}`)}get isDisabled(){return 0===this.#e.length}}exports.default=Cache;