"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _HttpError=_interopRequireDefault(require("./HttpError")),_NetworkError=_interopRequireDefault(require("./NetworkError")),_exponentialBackoff=require("exponential-backoff"),_http=_interopRequireDefault(require("http")),_https=_interopRequireDefault(require("https")),_httpsProxyAgent=require("https-proxy-agent"),_zlib=_interopRequireDefault(require("zlib"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}const ZLIB_OPTIONS={level:9},NULL_BYTE=0,NULL_BYTE_BUFFER=Buffer.from([0]);class HttpStore{static HttpError=_HttpError.default;static NetworkError=_NetworkError.default;#t;#e;constructor(t){this.#t=this.#r(null!=t.getOptions?t.getOptions:t),this.#e=this.#r(null!=t.setOptions?t.setOptions:t)}#r(t){const e={family:t.family,keepAlive:!0,keepAliveMsecs:t.timeout||5e3,maxSockets:64,maxFreeSockets:64};null!=t.key&&(e.key=t.key),null!=t.cert&&(e.cert=t.cert),null!=t.ca&&(e.ca=t.ca),null!=t.socketPath&&(e.socketPath=t.socketPath);const r=new URL(t.endpoint),n="http:"===r.protocol?_http.default:_https.default,o=null!=t.proxy?new _httpsProxyAgent.HttpsProxyAgent(t.proxy,e):new n.Agent(e);if(!r.hostname||!r.pathname)throw new TypeError("Invalid endpoint: "+t.endpoint);return{agent:o,headers:t.headers,host:r.hostname,path:r.pathname,port:+r.port,params:new URLSearchParams(t.params),timeout:t.timeout||5e3,module:"http:"===r.protocol?_http.default:_https.default,additionalSuccessStatuses:new Set(t.additionalSuccessStatuses??[]),debug:t.debug??!1,maxAttempts:t.maxAttempts??1,retryStatuses:new Set(t.retryStatuses??[]),retryNetworkErrors:t.retryNetworkErrors??!1}}get(t){return this.#n(()=>this.#o(t),this.#t)}#o(t){return new Promise((e,r)=>{let n=this.#t.params.toString();""!=n&&(n="?"+n);const o={agent:this.#t.agent,headers:this.#t.headers,host:this.#t.host,method:"GET",path:`${this.#t.path}/${t.toString("hex")}${n}`,port:this.#t.port,timeout:this.#t.timeout},s=this.#t.module.request(o,t=>{const n=t.statusCode,o=[];if(404===n)return t.resume(),void e(null);if(200!==n&&!this.#t.additionalSuccessStatuses.has(n))return void(this.#t.debug?(t.on("data",t=>{o.push(t)}),t.on("error",t=>{r(new _HttpError.default("Encountered network error ("+t.message+") while handling HTTP error: "+n+" "+_http.default.STATUS_CODES[n],n))}),t.on("end",()=>{const t=Buffer.concat(o);r(new _HttpError.default("HTTP error: "+n+" "+_http.default.STATUS_CODES[n]+"\n\n"+t.toString(),n))})):(t.resume(),r(new _HttpError.default("HTTP error: "+n+" "+_http.default.STATUS_CODES[n],n))));const s=t.pipe(_zlib.default.createGunzip());s.on("data",t=>{o.push(t)}),s.on("error",t=>{r(t)}),s.on("end",()=>{try{const t=Buffer.concat(o);t.length>0&&0===t[0]?e(t.slice(1)):e(JSON.parse(t.toString("utf8")))}catch(t){r(t)}}),t.on("error",t=>s.emit("error",t))});s.on("error",t=>{r(new _NetworkError.default(t.message,t.code))}),s.on("timeout",()=>{s.destroy(new Error("Request timed out"))}),s.end()})}set(t,e){return this.#n(()=>this.#s(t,e),this.#e)}#s(t,e){return new Promise((r,n)=>{const o=_zlib.default.createGzip(ZLIB_OPTIONS);let s=this.#e.params.toString();""!=s&&(s="?"+s);const i={agent:this.#e.agent,headers:this.#e.headers,host:this.#e.host,method:"PUT",path:`${this.#e.path}/${t.toString("hex")}${s}`,port:this.#e.port,timeout:this.#e.timeout},a=this.#e.module.request(i,t=>{const e=t.statusCode;if(!(e<200||e>299)||this.#e.additionalSuccessStatuses.has(e))t.on("error",t=>{n(t)}),t.on("end",()=>{r()}),t.resume();else if(this.#e.debug){const r=[];t.on("data",t=>{r.push(t)}),t.on("error",t=>{n(new _HttpError.default("Encountered network error ("+t.message+") while handling HTTP error: "+e+" "+_http.default.STATUS_CODES[e],e))}),t.on("end",()=>{const t=Buffer.concat(r);n(new _HttpError.default("HTTP error: "+e+" "+_http.default.STATUS_CODES[e]+"\n\n"+t.toString(),e))})}else t.resume(),n(new _HttpError.default("HTTP error: "+e+" "+_http.default.STATUS_CODES[e],e))});a.on("timeout",()=>{a.destroy(new Error("Request timed out"))}),o.pipe(a),e instanceof Buffer?(o.write(NULL_BYTE_BUFFER),o.end(e)):o.end(JSON.stringify(e)||"null")})}clear(){}#n(t,e){return 1===e.maxAttempts?t():(0,_exponentialBackoff.backOff)(t,{jitter:"full",maxDelay:3e4,numOfAttempts:this.#t.maxAttempts||Number.POSITIVE_INFINITY,retry:t=>t instanceof _HttpError.default?this.#t.retryStatuses.has(t.code):t instanceof _NetworkError.default&&this.#t.retryNetworkErrors})}}exports.default=HttpStore;