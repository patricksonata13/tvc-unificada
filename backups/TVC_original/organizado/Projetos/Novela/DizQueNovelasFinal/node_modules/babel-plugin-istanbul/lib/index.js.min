"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _path=_interopRequireDefault(require("path")),_fs=require("fs"),_child_process=require("child_process"),_helperPluginUtils=require("@babel/helper-plugin-utils"),_istanbulLibInstrument=require("istanbul-lib-instrument"),_testExclude=_interopRequireDefault(require("test-exclude")),_schema=_interopRequireDefault(require("@istanbuljs/schema"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getRealpath(e){try{return(0,_fs.realpathSync)(e)||e}catch(t){return e}}const memoize=new Map,memosep="/"===_path.default.sep?":":";";function loadNycConfig(e,t){let s=e;const n=[_path.default.resolve(__dirname,"load-nyc-config-sync.js"),e];if("nycrcPath"in t&&(n.push(t.nycrcPath),s+=memosep+t.nycrcPath),memoize.has(s))return memoize.get(s);const i=JSON.parse((0,_child_process.execFileSync)(process.execPath,n)),r=i["load-nyc-config-sync-error"];if(r)throw new Error(r);const u={..._schema.default.defaults.babelPluginIstanbul,cwd:e,...i};return memoize.set(s,u),u}function findConfig(e){const t=getRealpath(e.cwd||process.env.NYC_CWD||process.cwd()),s=Object.keys(e),n=Object.keys(e).filter(e=>"nycrcPath"===e||"cwd"===e);return s.length>n.length?{..._schema.default.defaults.babelPluginIstanbul,cwd:t,...e}:0===n.length&&process.env.NYC_CONFIG?JSON.parse(process.env.NYC_CONFIG):loadNycConfig(t,e)}function makeShouldSkip(){let e;return function(t,s){return e&&e.cwd===s.cwd||(e=new _testExclude.default({cwd:s.cwd,include:s.include,exclude:s.exclude,extension:s.extension,excludeNodeModules:!1!==s.excludeNodeModules})),!e.shouldInstrument(t)}}var _default=(0,_helperPluginUtils.declare)(e=>{e.assertVersion(7);const t=makeShouldSkip(),s=e.types;return{visitor:{Program:{enter(e){this.__dv__=null,this.nycConfig=findConfig(this.opts);const n=getRealpath(this.file.opts.filename);if(t(n,this.nycConfig))return;let{inputSourceMap:i}=this.opts;!1!==this.opts.useInlineSourceMaps&&!i&&this.file.inputMap&&(i=this.file.inputMap.sourcemap);const r={};Object.entries(_schema.default.defaults.instrumentVisitor).forEach(([e,t])=>{e in this.nycConfig?r[e]=this.nycConfig[e]:r[e]=_schema.default.defaults.instrumentVisitor[e]}),this.__dv__=(0,_istanbulLibInstrument.programVisitor)(s,n,{...r,inputSourceMap:i}),this.__dv__.enter(e)},exit(e){if(!this.__dv__)return;const t=this.__dv__.exit(e);this.opts.onCover&&this.opts.onCover(getRealpath(this.file.opts.filename),t.fileCoverage)}}}}});exports.default=_default;