var forge=require("./forge");require("./jsbn"),require("./random"),require("./sha512"),require("./util");var asn1Validator=require("./asn1-validator"),publicKeyValidator=asn1Validator.publicKeyValidator,privateKeyValidator=asn1Validator.privateKeyValidator;if(void 0===BigInteger)var BigInteger=forge.jsbn.BigInteger;var ByteBuffer=forge.util.ByteBuffer,NativeBuffer="undefined"==typeof Buffer?Uint8Array:Buffer;forge.pki=forge.pki||{},module.exports=forge.pki.ed25519=forge.ed25519=forge.ed25519||{};var ed25519=forge.ed25519;function messageToNativeBuffer(e){var r=e.message;if(r instanceof Uint8Array||r instanceof NativeBuffer)return r;var t=e.encoding;if(void 0===r){if(!e.md)throw new TypeError('"options.message" or "options.md" not specified.');r=e.md.digest().getBytes(),t="binary"}if("string"==typeof r&&!t)throw new TypeError('"options.encoding" must be "binary" or "utf8".');if("string"==typeof r){if("undefined"!=typeof Buffer)return Buffer.from(r,t);r=new ByteBuffer(r,t)}else if(!(r instanceof ByteBuffer))throw new TypeError('"options.message" must be a node.js Buffer, a Uint8Array, a forge ByteBuffer, or a string with "options.encoding" specifying its encoding.');for(var a=new NativeBuffer(r.length()),o=0;o<a.length;++o)a[o]=r.at(o);return a}ed25519.constants={},ed25519.constants.PUBLIC_KEY_BYTE_LENGTH=32,ed25519.constants.PRIVATE_KEY_BYTE_LENGTH=64,ed25519.constants.SEED_BYTE_LENGTH=32,ed25519.constants.SIGN_BYTE_LENGTH=64,ed25519.constants.HASH_BYTE_LENGTH=64,ed25519.generateKeyPair=function(e){var r=(e=e||{}).seed;if(void 0===r)r=forge.random.getBytesSync(ed25519.constants.SEED_BYTE_LENGTH);else if("string"==typeof r){if(r.length!==ed25519.constants.SEED_BYTE_LENGTH)throw new TypeError('"seed" must be '+ed25519.constants.SEED_BYTE_LENGTH+" bytes in length.")}else if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, Uint8Array, or a binary string.');r=messageToNativeBuffer({message:r,encoding:"binary"});for(var t=new NativeBuffer(ed25519.constants.PUBLIC_KEY_BYTE_LENGTH),a=new NativeBuffer(ed25519.constants.PRIVATE_KEY_BYTE_LENGTH),o=0;o<32;++o)a[o]=r[o];return crypto_sign_keypair(t,a),{publicKey:t,privateKey:a}},ed25519.privateKeyFromAsn1=function(e){var r={},t=[];if(!forge.asn1.validate(e,privateKeyValidator,r,t)){var a=new Error("Invalid Key.");throw a.errors=t,a}var o=forge.asn1.derToOid(r.privateKeyOid),n=forge.oids.EdDSA25519;if(o!==n)throw new Error('Invalid OID "'+o+'"; OID must be "'+n+'".');var f=r.privateKey;return{privateKeyBytes:messageToNativeBuffer({message:forge.asn1.fromDer(f).value,encoding:"binary"})}},ed25519.publicKeyFromAsn1=function(e){var r={},t=[];if(!forge.asn1.validate(e,publicKeyValidator,r,t)){var a=new Error("Invalid Key.");throw a.errors=t,a}var o=forge.asn1.derToOid(r.publicKeyOid),n=forge.oids.EdDSA25519;if(o!==n)throw new Error('Invalid OID "'+o+'"; OID must be "'+n+'".');var f=r.ed25519PublicKey;if(f.length!==ed25519.constants.PUBLIC_KEY_BYTE_LENGTH)throw new Error("Key length is invalid.");return messageToNativeBuffer({message:f,encoding:"binary"})},ed25519.publicKeyFromPrivateKey=function(e){var r=messageToNativeBuffer({message:(e=e||{}).privateKey,encoding:"binary"});if(r.length!==ed25519.constants.PRIVATE_KEY_BYTE_LENGTH)throw new TypeError('"options.privateKey" must have a byte length of '+ed25519.constants.PRIVATE_KEY_BYTE_LENGTH);for(var t=new NativeBuffer(ed25519.constants.PUBLIC_KEY_BYTE_LENGTH),a=0;a<t.length;++a)t[a]=r[32+a];return t},ed25519.sign=function(e){var r=messageToNativeBuffer(e=e||{}),t=messageToNativeBuffer({message:e.privateKey,encoding:"binary"});if(t.length===ed25519.constants.SEED_BYTE_LENGTH)t=ed25519.generateKeyPair({seed:t}).privateKey;else if(t.length!==ed25519.constants.PRIVATE_KEY_BYTE_LENGTH)throw new TypeError('"options.privateKey" must have a byte length of '+ed25519.constants.SEED_BYTE_LENGTH+" or "+ed25519.constants.PRIVATE_KEY_BYTE_LENGTH);var a=new NativeBuffer(ed25519.constants.SIGN_BYTE_LENGTH+r.length);crypto_sign(a,r,r.length,t);for(var o=new NativeBuffer(ed25519.constants.SIGN_BYTE_LENGTH),n=0;n<o.length;++n)o[n]=a[n];return o},ed25519.verify=function(e){var r=messageToNativeBuffer(e=e||{});if(void 0===e.signature)throw new TypeError('"options.signature" must be a node.js Buffer, a Uint8Array, a forge ByteBuffer, or a binary string.');var t=messageToNativeBuffer({message:e.signature,encoding:"binary"});if(t.length!==ed25519.constants.SIGN_BYTE_LENGTH)throw new TypeError('"options.signature" must have a byte length of '+ed25519.constants.SIGN_BYTE_LENGTH);var a=messageToNativeBuffer({message:e.publicKey,encoding:"binary"});if(a.length!==ed25519.constants.PUBLIC_KEY_BYTE_LENGTH)throw new TypeError('"options.publicKey" must have a byte length of '+ed25519.constants.PUBLIC_KEY_BYTE_LENGTH);var o,n=new NativeBuffer(ed25519.constants.SIGN_BYTE_LENGTH+r.length),f=new NativeBuffer(ed25519.constants.SIGN_BYTE_LENGTH+r.length);for(o=0;o<ed25519.constants.SIGN_BYTE_LENGTH;++o)n[o]=t[o];for(o=0;o<r.length;++o)n[o+ed25519.constants.SIGN_BYTE_LENGTH]=r[o];return crypto_sign_open(f,n,n.length,a)>=0};var gf0=gf(),gf1=gf([1]),D=gf([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),D2=gf([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),X=gf([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),Y=gf([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),L=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]),I=gf([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function sha512(e,r){var t=forge.md.sha512.create(),a=new ByteBuffer(e);t.update(a.getBytes(r),"binary");var o=t.digest().getBytes();if("undefined"!=typeof Buffer)return Buffer.from(o,"binary");for(var n=new NativeBuffer(ed25519.constants.HASH_BYTE_LENGTH),f=0;f<64;++f)n[f]=o.charCodeAt(f);return n}function crypto_sign_keypair(e,r){var t,a=[gf(),gf(),gf(),gf()],o=sha512(r,32);for(o[0]&=248,o[31]&=127,o[31]|=64,scalarbase(a,o),pack(e,a),t=0;t<32;++t)r[t+32]=e[t];return 0}function crypto_sign(e,r,t,a){var o,n,f=new Float64Array(64),i=[gf(),gf(),gf(),gf()],s=sha512(a,32);s[0]&=248,s[31]&=127,s[31]|=64;var g=t+64;for(o=0;o<t;++o)e[64+o]=r[o];for(o=0;o<32;++o)e[32+o]=s[32+o];var u=sha512(e.subarray(32),t+32);for(reduce(u),scalarbase(i,u),pack(e,i),o=32;o<64;++o)e[o]=a[o];var c=sha512(e,t+64);for(reduce(c),o=32;o<64;++o)f[o]=0;for(o=0;o<32;++o)f[o]=u[o];for(o=0;o<32;++o)for(n=0;n<32;n++)f[o+n]+=c[o]*s[n];return modL(e.subarray(32),f),g}function crypto_sign_open(e,r,t,a){var o,n=new NativeBuffer(32),f=[gf(),gf(),gf(),gf()],i=[gf(),gf(),gf(),gf()];if(t<64)return-1;if(unpackneg(i,a))return-1;for(o=0;o<t;++o)e[o]=r[o];for(o=0;o<32;++o)e[o+32]=a[o];var s=sha512(e,t);if(reduce(s),scalarmult(f,i,s),scalarbase(i,r.subarray(32)),add(f,i),pack(n,f),t-=64,crypto_verify_32(r,0,n,0)){for(o=0;o<t;++o)e[o]=0;return-1}for(o=0;o<t;++o)e[o]=r[o+64];return t}function modL(e,r){var t,a,o,n;for(a=63;a>=32;--a){for(t=0,o=a-32,n=a-12;o<n;++o)r[o]+=t-16*r[a]*L[o-(a-32)],t=r[o]+128>>8,r[o]-=256*t;r[o]+=t,r[a]=0}for(t=0,o=0;o<32;++o)r[o]+=t-(r[31]>>4)*L[o],t=r[o]>>8,r[o]&=255;for(o=0;o<32;++o)r[o]-=t*L[o];for(a=0;a<32;++a)r[a+1]+=r[a]>>8,e[a]=255&r[a]}function reduce(e){for(var r=new Float64Array(64),t=0;t<64;++t)r[t]=e[t],e[t]=0;modL(e,r)}function add(e,r){var t=gf(),a=gf(),o=gf(),n=gf(),f=gf(),i=gf(),s=gf(),g=gf(),u=gf();Z(t,e[1],e[0]),Z(u,r[1],r[0]),M(t,t,u),A(a,e[0],e[1]),A(u,r[0],r[1]),M(a,a,u),M(o,e[3],r[3]),M(o,o,D2),M(n,e[2],r[2]),A(n,n,n),Z(f,a,t),Z(i,n,o),A(s,n,o),A(g,a,t),M(e[0],f,i),M(e[1],g,s),M(e[2],s,i),M(e[3],f,g)}function cswap(e,r,t){for(var a=0;a<4;++a)sel25519(e[a],r[a],t)}function pack(e,r){var t=gf(),a=gf(),o=gf();inv25519(o,r[2]),M(t,r[0],o),M(a,r[1],o),pack25519(e,a),e[31]^=par25519(t)<<7}function pack25519(e,r){var t,a,o,n=gf(),f=gf();for(t=0;t<16;++t)f[t]=r[t];for(car25519(f),car25519(f),car25519(f),a=0;a<2;++a){for(n[0]=f[0]-65517,t=1;t<15;++t)n[t]=f[t]-65535-(n[t-1]>>16&1),n[t-1]&=65535;n[15]=f[15]-32767-(n[14]>>16&1),o=n[15]>>16&1,n[14]&=65535,sel25519(f,n,1-o)}for(t=0;t<16;t++)e[2*t]=255&f[t],e[2*t+1]=f[t]>>8}function unpackneg(e,r){var t=gf(),a=gf(),o=gf(),n=gf(),f=gf(),i=gf(),s=gf();return set25519(e[2],gf1),unpack25519(e[1],r),S(o,e[1]),M(n,o,D),Z(o,o,e[2]),A(n,e[2],n),S(f,n),S(i,f),M(s,i,f),M(t,s,o),M(t,t,n),pow2523(t,t),M(t,t,o),M(t,t,n),M(t,t,n),M(e[0],t,n),S(a,e[0]),M(a,a,n),neq25519(a,o)&&M(e[0],e[0],I),S(a,e[0]),M(a,a,n),neq25519(a,o)?-1:(par25519(e[0])===r[31]>>7&&Z(e[0],gf0,e[0]),M(e[3],e[0],e[1]),0)}function unpack25519(e,r){var t;for(t=0;t<16;++t)e[t]=r[2*t]+(r[2*t+1]<<8);e[15]&=32767}function pow2523(e,r){var t,a=gf();for(t=0;t<16;++t)a[t]=r[t];for(t=250;t>=0;--t)S(a,a),1!==t&&M(a,a,r);for(t=0;t<16;++t)e[t]=a[t]}function neq25519(e,r){var t=new NativeBuffer(32),a=new NativeBuffer(32);return pack25519(t,e),pack25519(a,r),crypto_verify_32(t,0,a,0)}function crypto_verify_32(e,r,t,a){return vn(e,r,t,a,32)}function vn(e,r,t,a,o){var n,f=0;for(n=0;n<o;++n)f|=e[r+n]^t[a+n];return(1&f-1>>>8)-1}function par25519(e){var r=new NativeBuffer(32);return pack25519(r,e),1&r[0]}function scalarmult(e,r,t){var a,o;for(set25519(e[0],gf0),set25519(e[1],gf1),set25519(e[2],gf1),set25519(e[3],gf0),o=255;o>=0;--o)cswap(e,r,a=t[o/8|0]>>(7&o)&1),add(r,e),add(e,e),cswap(e,r,a)}function scalarbase(e,r){var t=[gf(),gf(),gf(),gf()];set25519(t[0],X),set25519(t[1],Y),set25519(t[2],gf1),M(t[3],X,Y),scalarmult(e,t,r)}function set25519(e,r){var t;for(t=0;t<16;t++)e[t]=0|r[t]}function inv25519(e,r){var t,a=gf();for(t=0;t<16;++t)a[t]=r[t];for(t=253;t>=0;--t)S(a,a),2!==t&&4!==t&&M(a,a,r);for(t=0;t<16;++t)e[t]=a[t]}function car25519(e){var r,t,a=1;for(r=0;r<16;++r)t=e[r]+a+65535,a=Math.floor(t/65536),e[r]=t-65536*a;e[0]+=a-1+37*(a-1)}function sel25519(e,r,t){for(var a,o=~(t-1),n=0;n<16;++n)a=o&(e[n]^r[n]),e[n]^=a,r[n]^=a}function gf(e){var r,t=new Float64Array(16);if(e)for(r=0;r<e.length;++r)t[r]=e[r];return t}function A(e,r,t){for(var a=0;a<16;++a)e[a]=r[a]+t[a]}function Z(e,r,t){for(var a=0;a<16;++a)e[a]=r[a]-t[a]}function S(e,r){M(e,r,r)}function M(e,r,t){var a,o,n=0,f=0,i=0,s=0,g=0,u=0,c=0,d=0,v=0,l=0,y=0,E=0,B=0,p=0,h=0,T=0,_=0,N=0,M=0,w=0,m=0,b=0,Y=0,L=0,K=0,G=0,I=0,H=0,A=0,S=0,k=0,D=t[0],P=t[1],V=t[2],U=t[3],q=t[4],O=t[5],C=t[6],F=t[7],Z=t[8],R=t[9],j=t[10],X=t[11],x=t[12],z=t[13],J=t[14],Q=t[15];n+=(a=r[0])*D,f+=a*P,i+=a*V,s+=a*U,g+=a*q,u+=a*O,c+=a*C,d+=a*F,v+=a*Z,l+=a*R,y+=a*j,E+=a*X,B+=a*x,p+=a*z,h+=a*J,T+=a*Q,f+=(a=r[1])*D,i+=a*P,s+=a*V,g+=a*U,u+=a*q,c+=a*O,d+=a*C,v+=a*F,l+=a*Z,y+=a*R,E+=a*j,B+=a*X,p+=a*x,h+=a*z,T+=a*J,_+=a*Q,i+=(a=r[2])*D,s+=a*P,g+=a*V,u+=a*U,c+=a*q,d+=a*O,v+=a*C,l+=a*F,y+=a*Z,E+=a*R,B+=a*j,p+=a*X,h+=a*x,T+=a*z,_+=a*J,N+=a*Q,s+=(a=r[3])*D,g+=a*P,u+=a*V,c+=a*U,d+=a*q,v+=a*O,l+=a*C,y+=a*F,E+=a*Z,B+=a*R,p+=a*j,h+=a*X,T+=a*x,_+=a*z,N+=a*J,M+=a*Q,g+=(a=r[4])*D,u+=a*P,c+=a*V,d+=a*U,v+=a*q,l+=a*O,y+=a*C,E+=a*F,B+=a*Z,p+=a*R,h+=a*j,T+=a*X,_+=a*x,N+=a*z,M+=a*J,w+=a*Q,u+=(a=r[5])*D,c+=a*P,d+=a*V,v+=a*U,l+=a*q,y+=a*O,E+=a*C,B+=a*F,p+=a*Z,h+=a*R,T+=a*j,_+=a*X,N+=a*x,M+=a*z,w+=a*J,m+=a*Q,c+=(a=r[6])*D,d+=a*P,v+=a*V,l+=a*U,y+=a*q,E+=a*O,B+=a*C,p+=a*F,h+=a*Z,T+=a*R,_+=a*j,N+=a*X,M+=a*x,w+=a*z,m+=a*J,b+=a*Q,d+=(a=r[7])*D,v+=a*P,l+=a*V,y+=a*U,E+=a*q,B+=a*O,p+=a*C,h+=a*F,T+=a*Z,_+=a*R,N+=a*j,M+=a*X,w+=a*x,m+=a*z,b+=a*J,Y+=a*Q,v+=(a=r[8])*D,l+=a*P,y+=a*V,E+=a*U,B+=a*q,p+=a*O,h+=a*C,T+=a*F,_+=a*Z,N+=a*R,M+=a*j,w+=a*X,m+=a*x,b+=a*z,Y+=a*J,L+=a*Q,l+=(a=r[9])*D,y+=a*P,E+=a*V,B+=a*U,p+=a*q,h+=a*O,T+=a*C,_+=a*F,N+=a*Z,M+=a*R,w+=a*j,m+=a*X,b+=a*x,Y+=a*z,L+=a*J,K+=a*Q,y+=(a=r[10])*D,E+=a*P,B+=a*V,p+=a*U,h+=a*q,T+=a*O,_+=a*C,N+=a*F,M+=a*Z,w+=a*R,m+=a*j,b+=a*X,Y+=a*x,L+=a*z,K+=a*J,G+=a*Q,E+=(a=r[11])*D,B+=a*P,p+=a*V,h+=a*U,T+=a*q,_+=a*O,N+=a*C,M+=a*F,w+=a*Z,m+=a*R,b+=a*j,Y+=a*X,L+=a*x,K+=a*z,G+=a*J,I+=a*Q,B+=(a=r[12])*D,p+=a*P,h+=a*V,T+=a*U,_+=a*q,N+=a*O,M+=a*C,w+=a*F,m+=a*Z,b+=a*R,Y+=a*j,L+=a*X,K+=a*x,G+=a*z,I+=a*J,H+=a*Q,p+=(a=r[13])*D,h+=a*P,T+=a*V,_+=a*U,N+=a*q,M+=a*O,w+=a*C,m+=a*F,b+=a*Z,Y+=a*R,L+=a*j,K+=a*X,G+=a*x,I+=a*z,H+=a*J,A+=a*Q,h+=(a=r[14])*D,T+=a*P,_+=a*V,N+=a*U,M+=a*q,w+=a*O,m+=a*C,b+=a*F,Y+=a*Z,L+=a*R,K+=a*j,G+=a*X,I+=a*x,H+=a*z,A+=a*J,S+=a*Q,T+=(a=r[15])*D,f+=38*(N+=a*V),i+=38*(M+=a*U),s+=38*(w+=a*q),g+=38*(m+=a*O),u+=38*(b+=a*C),c+=38*(Y+=a*F),d+=38*(L+=a*Z),v+=38*(K+=a*R),l+=38*(G+=a*j),y+=38*(I+=a*X),E+=38*(H+=a*x),B+=38*(A+=a*z),p+=38*(S+=a*J),h+=38*(k+=a*Q),n=(a=(n+=38*(_+=a*P))+(o=1)+65535)-65536*(o=Math.floor(a/65536)),f=(a=f+o+65535)-65536*(o=Math.floor(a/65536)),i=(a=i+o+65535)-65536*(o=Math.floor(a/65536)),s=(a=s+o+65535)-65536*(o=Math.floor(a/65536)),g=(a=g+o+65535)-65536*(o=Math.floor(a/65536)),u=(a=u+o+65535)-65536*(o=Math.floor(a/65536)),c=(a=c+o+65535)-65536*(o=Math.floor(a/65536)),d=(a=d+o+65535)-65536*(o=Math.floor(a/65536)),v=(a=v+o+65535)-65536*(o=Math.floor(a/65536)),l=(a=l+o+65535)-65536*(o=Math.floor(a/65536)),y=(a=y+o+65535)-65536*(o=Math.floor(a/65536)),E=(a=E+o+65535)-65536*(o=Math.floor(a/65536)),B=(a=B+o+65535)-65536*(o=Math.floor(a/65536)),p=(a=p+o+65535)-65536*(o=Math.floor(a/65536)),h=(a=h+o+65535)-65536*(o=Math.floor(a/65536)),T=(a=T+o+65535)-65536*(o=Math.floor(a/65536)),n=(a=(n+=o-1+37*(o-1))+(o=1)+65535)-65536*(o=Math.floor(a/65536)),f=(a=f+o+65535)-65536*(o=Math.floor(a/65536)),i=(a=i+o+65535)-65536*(o=Math.floor(a/65536)),s=(a=s+o+65535)-65536*(o=Math.floor(a/65536)),g=(a=g+o+65535)-65536*(o=Math.floor(a/65536)),u=(a=u+o+65535)-65536*(o=Math.floor(a/65536)),c=(a=c+o+65535)-65536*(o=Math.floor(a/65536)),d=(a=d+o+65535)-65536*(o=Math.floor(a/65536)),v=(a=v+o+65535)-65536*(o=Math.floor(a/65536)),l=(a=l+o+65535)-65536*(o=Math.floor(a/65536)),y=(a=y+o+65535)-65536*(o=Math.floor(a/65536)),E=(a=E+o+65535)-65536*(o=Math.floor(a/65536)),B=(a=B+o+65535)-65536*(o=Math.floor(a/65536)),p=(a=p+o+65535)-65536*(o=Math.floor(a/65536)),h=(a=h+o+65535)-65536*(o=Math.floor(a/65536)),T=(a=T+o+65535)-65536*(o=Math.floor(a/65536)),n+=o-1+37*(o-1),e[0]=n,e[1]=f,e[2]=i,e[3]=s,e[4]=g,e[5]=u,e[6]=c,e[7]=d,e[8]=v,e[9]=l,e[10]=y,e[11]=E,e[12]=B,e[13]=p,e[14]=h,e[15]=T}