var forge=require("./forge");require("./util");var _crypto=null;!forge.util.isNodejs||forge.options.usePureJavaScript||process.versions["node-webkit"]||(_crypto=require("crypto"));var prng=module.exports=forge.prng=forge.prng||{};prng.create=function(e){for(var r={plugin:e,key:null,seed:null,time:null,reseeds:0,generated:0,keyBytes:""},t=e.md,n=new Array(32),o=0;o<32;++o)n[o]=t.create();function s(){if(r.pools[0].messageLength>=32)return l();var e=32-r.pools[0].messageLength<<5;r.collect(r.seedFileSync(e)),l()}function l(){r.reseeds=4294967295===r.reseeds?0:r.reseeds+1;var e=r.plugin.md.create();e.update(r.keyBytes);for(var t=1,n=0;n<32;++n)r.reseeds%t===0&&(e.update(r.pools[n].digest().getBytes()),r.pools[n].start()),t<<=1;r.keyBytes=e.digest().getBytes(),e.start(),e.update(r.keyBytes);var o=e.digest().getBytes();r.key=r.plugin.formatKey(r.keyBytes),r.seed=r.plugin.formatSeed(o),r.generated=0}function a(e){var r=null,t=forge.util.globalScope,n=t.crypto||t.msCrypto;n&&n.getRandomValues&&(r=function(e){return n.getRandomValues(e)});var o=forge.util.createBuffer();if(r)for(;o.length()<e;){var s=Math.max(1,Math.min(e-o.length(),65536)/4),l=new Uint32Array(Math.floor(s));try{r(l);for(var a=0;a<l.length;++a)o.putInt32(l[a])}catch(e){if(!("undefined"!=typeof QuotaExceededError&&e instanceof QuotaExceededError))throw e}}if(o.length()<e)for(var g,u,i,f=Math.floor(65536*Math.random());o.length()<e;){u=16807*(65535&f),u+=(32767&(g=16807*(f>>16)))<<16,f=4294967295&(u=(2147483647&(u+=g>>15))+(u>>31));for(a=0;a<3;++a)i=f>>>(a<<3),i^=Math.floor(256*Math.random()),o.putByte(255&i)}return o.getBytes(e)}return r.pools=n,r.pool=0,r.generate=function(e,t){if(!t)return r.generateSync(e);var n=r.plugin.cipher,o=r.plugin.increment,s=r.plugin.formatKey,a=r.plugin.formatSeed,g=forge.util.createBuffer();r.key=null,function u(i){if(i)return t(i);if(g.length()>=e)return t(null,g.getBytes(e));r.generated>1048575&&(r.key=null);if(null===r.key)return forge.util.nextTick(function(){!function(e){if(r.pools[0].messageLength>=32)return l(),e();var t=32-r.pools[0].messageLength<<5;r.seedFile(t,function(t,n){if(t)return e(t);r.collect(n),l(),e()})}(u)});var f=n(r.key,r.seed);r.generated+=f.length,g.putBytes(f),r.key=s(n(r.key,o(r.seed))),r.seed=a(n(r.key,r.seed)),forge.util.setImmediate(u)}()},r.generateSync=function(e){var t=r.plugin.cipher,n=r.plugin.increment,o=r.plugin.formatKey,l=r.plugin.formatSeed;r.key=null;for(var a=forge.util.createBuffer();a.length()<e;){r.generated>1048575&&(r.key=null),null===r.key&&s();var g=t(r.key,r.seed);r.generated+=g.length,a.putBytes(g),r.key=o(t(r.key,n(r.seed))),r.seed=l(t(r.key,r.seed))}return a.getBytes(e)},_crypto?(r.seedFile=function(e,r){_crypto.randomBytes(e,function(e,t){if(e)return r(e);r(null,t.toString())})},r.seedFileSync=function(e){return _crypto.randomBytes(e).toString()}):(r.seedFile=function(e,r){try{r(null,a(e))}catch(e){r(e)}},r.seedFileSync=a),r.collect=function(e){for(var t=e.length,n=0;n<t;++n)r.pools[r.pool].update(e.substr(n,1)),r.pool=31===r.pool?0:r.pool+1},r.collectInt=function(e,t){for(var n="",o=0;o<t;o+=8)n+=String.fromCharCode(e>>o&255);r.collect(n)},r.registerWorker=function(e){if(e===self)r.seedFile=function(e,r){self.addEventListener("message",function e(t){var n=t.data;n.forge&&n.forge.prng&&(self.removeEventListener("message",e),r(n.forge.prng.err,n.forge.prng.bytes))}),self.postMessage({forge:{prng:{needed:e}}})};else{e.addEventListener("message",function(t){var n=t.data;n.forge&&n.forge.prng&&r.seedFile(n.forge.prng.needed,function(r,t){e.postMessage({forge:{prng:{err:r,bytes:t}}})})})}},r};