var forge=require("./forge");require("./hmac"),require("./md"),require("./util");var crypto,pkcs5=forge.pkcs5=forge.pkcs5||{};forge.util.isNodejs&&!forge.options.usePureJavaScript&&(crypto=require("crypto")),module.exports=forge.pbkdf2=pkcs5.pbkdf2=function(r,t,e,o,n,i){if("function"==typeof n&&(i=n,n=null),forge.util.isNodejs&&!forge.options.usePureJavaScript&&crypto.pbkdf2&&(null===n||"object"!=typeof n)&&(crypto.pbkdf2Sync.length>4||!n||"sha1"===n))return"string"!=typeof n&&(n="sha1"),r=Buffer.from(r,"binary"),t=Buffer.from(t,"binary"),i?4===crypto.pbkdf2Sync.length?crypto.pbkdf2(r,t,e,o,function(r,t){if(r)return i(r);i(null,t.toString("binary"))}):crypto.pbkdf2(r,t,e,o,n,function(r,t){if(r)return i(r);i(null,t.toString("binary"))}):4===crypto.pbkdf2Sync.length?crypto.pbkdf2Sync(r,t,e,o).toString("binary"):crypto.pbkdf2Sync(r,t,e,o,n).toString("binary");if(null==n&&(n="sha1"),"string"==typeof n){if(!(n in forge.md.algorithms))throw new Error("Unknown hash algorithm: "+n);n=forge.md[n].create()}var f=n.digestLength;if(o>4294967295*f){var u=new Error("Derived key is too long.");if(i)return i(u);throw u}var l=Math.ceil(o/f),s=o-(l-1)*f,a=forge.hmac.create();a.start(n,r);var p,g,y,c="";if(!i){for(var d=1;d<=l;++d){a.start(null,null),a.update(t),a.update(forge.util.int32ToBytes(d)),p=y=a.digest().getBytes();for(var b=2;b<=e;++b)a.start(null,null),a.update(y),g=a.digest().getBytes(),p=forge.util.xorBytes(p,g,f),y=g;c+=d<l?p:p.substr(0,s)}return c}d=1;function h(){if(d>l)return i(null,c);a.start(null,null),a.update(t),a.update(forge.util.int32ToBytes(d)),p=y=a.digest().getBytes(),b=2,k()}function k(){if(b<=e)return a.start(null,null),a.update(y),g=a.digest().getBytes(),p=forge.util.xorBytes(p,g,f),y=g,++b,forge.util.setImmediate(k);c+=d<l?p:p.substr(0,s),++d,h()}h()};