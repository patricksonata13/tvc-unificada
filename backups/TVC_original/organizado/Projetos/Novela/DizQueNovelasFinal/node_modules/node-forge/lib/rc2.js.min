var forge=require("./forge");require("./util");var piTable=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],s=[1,2,3,5],rol=function(r,e){return r<<e&65535|(65535&r)>>16-e},ror=function(r,e){return(65535&r)>>e|r<<16-e&65535};module.exports=forge.rc2=forge.rc2||{},forge.rc2.expandKey=function(r,e){"string"==typeof r&&(r=forge.util.createBuffer(r)),e=e||128;var t,n=r,f=r.length(),o=e,u=Math.ceil(o/8),i=255>>(7&o);for(t=f;t<128;t++)n.putByte(piTable[n.at(t-1)+n.at(t-f)&255]);for(n.setAt(128-u,piTable[n.at(128-u)&i]),t=127-u;t>=0;t--)n.setAt(t,piTable[n.at(t+1)^n.at(t+u)]);return n};var createCipher=function(r,e,t){var n,f,o,u,i=!1,a=null,c=null,l=null,p=[];for(r=forge.rc2.expandKey(r,e),o=0;o<64;o++)p.push(r.getInt16Le());t?(n=function(r){for(o=0;o<4;o++)r[o]+=p[u]+(r[(o+3)%4]&r[(o+2)%4])+(~r[(o+3)%4]&r[(o+1)%4]),r[o]=rol(r[o],s[o]),u++},f=function(r){for(o=0;o<4;o++)r[o]+=p[63&r[(o+3)%4]]}):(n=function(r){for(o=3;o>=0;o--)r[o]=ror(r[o],s[o]),r[o]-=p[u]+(r[(o+3)%4]&r[(o+2)%4])+(~r[(o+3)%4]&r[(o+1)%4]),u--},f=function(r){for(o=3;o>=0;o--)r[o]-=p[63&r[(o+3)%4]]});var g=function(r){var e=[];for(o=0;o<4;o++){var n=a.getInt16Le();null!==l&&(t?n^=l.getInt16Le():l.putInt16Le(n)),e.push(65535&n)}u=t?0:63;for(var f=0;f<r.length;f++)for(var i=0;i<r[f][0];i++)r[f][1](e);for(o=0;o<4;o++)null!==l&&(t?l.putInt16Le(e[o]):e[o]^=l.getInt16Le()),c.putInt16Le(e[o])},h=null;return h={start:function(r,e){r&&"string"==typeof r&&(r=forge.util.createBuffer(r)),i=!1,a=forge.util.createBuffer(),c=e||new forge.util.createBuffer,l=r,h.output=c},update:function(r){for(i||a.putBuffer(r);a.length()>=8;)g([[5,n],[1,f],[6,n],[1,f],[5,n]])},finish:function(r){var e=!0;if(t)if(r)e=r(8,a,!t);else{var n=8===a.length()?8:8-a.length();a.fillWithByte(n,n)}if(e&&(i=!0,h.update()),!t&&(e=0===a.length()))if(r)e=r(8,c,!t);else{var f=c.length(),o=c.at(f-1);o>f?e=!1:c.truncate(o)}return e}}};forge.rc2.startEncrypting=function(r,e,t){var n=forge.rc2.createEncryptionCipher(r,128);return n.start(e,t),n},forge.rc2.createEncryptionCipher=function(r,e){return createCipher(r,e,!0)},forge.rc2.startDecrypting=function(r,e,t){var n=forge.rc2.createDecryptionCipher(r,128);return n.start(e,t),n},forge.rc2.createDecryptionCipher=function(r,e){return createCipher(r,e,!1)};