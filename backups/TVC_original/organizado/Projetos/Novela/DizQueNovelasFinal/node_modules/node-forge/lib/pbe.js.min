var forge=require("./forge");if(require("./aes"),require("./asn1"),require("./des"),require("./md"),require("./oids"),require("./pbkdf2"),require("./pem"),require("./random"),require("./rc2"),require("./rsa"),require("./util"),void 0===BigInteger)var BigInteger=forge.jsbn.BigInteger;var asn1=forge.asn1,pki=forge.pki=forge.pki||{};module.exports=pki.pbe=forge.pbe=forge.pbe||{};var oids=pki.oids,encryptedPrivateKeyValidator={name:"EncryptedPrivateKeyInfo",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},PBES2AlgorithmsValidator={name:"PBES2Algorithms",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.INTEGER,constructed:!1,capture:"kdfIterationCount"},{name:"PBES2Algorithms.params.keyLength",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.INTEGER,constructed:!1,optional:!0,capture:"keyLength"},{name:"PBES2Algorithms.params.prf",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,optional:!0,value:[{name:"PBES2Algorithms.params.prf.algorithm",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OID,constructed:!1,capture:"prfOid"}]}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},pkcs12PbeParamsValidator={name:"pkcs-12PbeParams",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:asn1.Class.UNIVERSAL,type:asn1.Type.INTEGER,constructed:!1,capture:"iterations"}]};function hash(e,r){return e.start().update(r).digest().getBytes()}function prfOidToMessageDigest(e){var r;if(e){if(!(r=pki.oids[asn1.derToOid(e)])){var a=new Error("Unsupported PRF OID.");throw a.oid=e,a.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],a}}else r="hmacWithSHA1";return prfAlgorithmToMessageDigest(r)}function prfAlgorithmToMessageDigest(e){var r=forge.md;switch(e){case"hmacWithSHA224":r=forge.md.sha512;case"hmacWithSHA1":case"hmacWithSHA256":case"hmacWithSHA384":case"hmacWithSHA512":e=e.substr(8).toLowerCase();break;default:var a=new Error("Unsupported PRF algorithm.");throw a.algorithm=e,a.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],a}if(!r||!(e in r))throw new Error("Unknown hash algorithm: "+e);return r[e].create()}function createPbkdf2Params(e,r,a,t){var s=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,r.getBytes())]);return"hmacWithSHA1"!==t&&s.value.push(asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,forge.util.hexToBytes(a.toString(16))),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(pki.oids[t]).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.NULL,!1,"")])),s}pki.encryptPrivateKeyInfo=function(e,r,a){(a=a||{}).saltSize=a.saltSize||8,a.count=a.count||2048,a.algorithm=a.algorithm||"aes128",a.prfAlgorithm=a.prfAlgorithm||"sha1";var t,s,n,o=forge.random.getBytesSync(a.saltSize),i=a.count,p=asn1.integerToDer(i);if(0===a.algorithm.indexOf("aes")||"des"===a.algorithm){var c,y,d;switch(a.algorithm){case"aes128":t=16,c=16,y=oids["aes128-CBC"],d=forge.aes.createEncryptionCipher;break;case"aes192":t=24,c=16,y=oids["aes192-CBC"],d=forge.aes.createEncryptionCipher;break;case"aes256":t=32,c=16,y=oids["aes256-CBC"],d=forge.aes.createEncryptionCipher;break;case"des":t=8,c=8,y=oids.desCBC,d=forge.des.createEncryptionCipher;break;default:throw(u=new Error("Cannot encrypt private key. Unknown encryption algorithm.")).algorithm=a.algorithm,u}var E="hmacWith"+a.prfAlgorithm.toUpperCase(),C=prfAlgorithmToMessageDigest(E),l=forge.pkcs5.pbkdf2(r,o,i,t,C),f=forge.random.getBytesSync(c);(h=d(l)).start(f),h.update(asn1.toDer(e)),h.finish(),n=h.output.getBytes();var g=createPbkdf2Params(o,p,t,E);s=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(oids.pkcs5PBES2).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(oids.pkcs5PBKDF2).getBytes()),g]),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(y).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,f)])])])}else{var u;if("3des"!==a.algorithm)throw(u=new Error("Cannot encrypt private key. Unknown encryption algorithm.")).algorithm=a.algorithm,u;t=24;var h,m=new forge.util.ByteBuffer(o);l=pki.pbe.generatePkcs12Key(r,m,1,i,t),f=pki.pbe.generatePkcs12Key(r,m,2,i,t);(h=forge.des.createEncryptionCipher(l)).start(f),h.update(asn1.toDer(e)),h.finish(),n=h.output.getBytes(),s=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,o),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,p.getBytes())])])}return asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[s,asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,n)])},pki.decryptPrivateKeyInfo=function(e,r){var a=null,t={},s=[];if(!asn1.validate(e,encryptedPrivateKeyValidator,t,s)){var n=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw n.errors=s,n}var o=asn1.derToOid(t.encryptionOid),i=pki.pbe.getCipher(o,t.encryptionParams,r),p=forge.util.createBuffer(t.encryptedData);return i.update(p),i.finish()&&(a=asn1.fromDer(i.output)),a},pki.encryptedPrivateKeyToPem=function(e,r){var a={type:"ENCRYPTED PRIVATE KEY",body:asn1.toDer(e).getBytes()};return forge.pem.encode(a,{maxline:r})},pki.encryptedPrivateKeyFromPem=function(e){var r=forge.pem.decode(e)[0];if("ENCRYPTED PRIVATE KEY"!==r.type){var a=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw a.headerType=r.type,a}if(r.procType&&"ENCRYPTED"===r.procType.type)throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return asn1.fromDer(r.body)},pki.encryptRsaPrivateKey=function(e,r,a){if(!(a=a||{}).legacy){var t=pki.wrapRsaPrivateKey(pki.privateKeyToAsn1(e));return t=pki.encryptPrivateKeyInfo(t,r,a),pki.encryptedPrivateKeyToPem(t)}var s,n,o,i;switch(a.algorithm){case"aes128":s="AES-128-CBC",o=16,n=forge.random.getBytesSync(16),i=forge.aes.createEncryptionCipher;break;case"aes192":s="AES-192-CBC",o=24,n=forge.random.getBytesSync(16),i=forge.aes.createEncryptionCipher;break;case"aes256":s="AES-256-CBC",o=32,n=forge.random.getBytesSync(16),i=forge.aes.createEncryptionCipher;break;case"3des":s="DES-EDE3-CBC",o=24,n=forge.random.getBytesSync(8),i=forge.des.createEncryptionCipher;break;case"des":s="DES-CBC",o=8,n=forge.random.getBytesSync(8),i=forge.des.createEncryptionCipher;break;default:var p=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+a.algorithm+'".');throw p.algorithm=a.algorithm,p}var c=i(forge.pbe.opensslDeriveBytes(r,n.substr(0,8),o));c.start(n),c.update(asn1.toDer(pki.privateKeyToAsn1(e))),c.finish();var y={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:s,parameters:forge.util.bytesToHex(n).toUpperCase()},body:c.output.getBytes()};return forge.pem.encode(y)},pki.decryptRsaPrivateKey=function(e,r){var a=null,t=forge.pem.decode(e)[0];if("ENCRYPTED PRIVATE KEY"!==t.type&&"PRIVATE KEY"!==t.type&&"RSA PRIVATE KEY"!==t.type)throw(o=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".')).headerType=o,o;if(t.procType&&"ENCRYPTED"===t.procType.type){var s,n;switch(t.dekInfo.algorithm){case"DES-CBC":s=8,n=forge.des.createDecryptionCipher;break;case"DES-EDE3-CBC":s=24,n=forge.des.createDecryptionCipher;break;case"AES-128-CBC":s=16,n=forge.aes.createDecryptionCipher;break;case"AES-192-CBC":s=24,n=forge.aes.createDecryptionCipher;break;case"AES-256-CBC":s=32,n=forge.aes.createDecryptionCipher;break;case"RC2-40-CBC":s=5,n=function(e){return forge.rc2.createDecryptionCipher(e,40)};break;case"RC2-64-CBC":s=8,n=function(e){return forge.rc2.createDecryptionCipher(e,64)};break;case"RC2-128-CBC":s=16,n=function(e){return forge.rc2.createDecryptionCipher(e,128)};break;default:var o;throw(o=new Error('Could not decrypt private key; unsupported encryption algorithm "'+t.dekInfo.algorithm+'".')).algorithm=t.dekInfo.algorithm,o}var i=forge.util.hexToBytes(t.dekInfo.parameters),p=n(forge.pbe.opensslDeriveBytes(r,i.substr(0,8),s));if(p.start(i),p.update(forge.util.createBuffer(t.body)),!p.finish())return a;a=p.output.getBytes()}else a=t.body;return null!==(a="ENCRYPTED PRIVATE KEY"===t.type?pki.decryptPrivateKeyInfo(asn1.fromDer(a),r):asn1.fromDer(a))&&(a=pki.privateKeyFromAsn1(a)),a},pki.pbe.generatePkcs12Key=function(e,r,a,t,s,n){var o,i;if(null==n){if(!("sha1"in forge.md))throw new Error('"sha1" hash algorithm unavailable.');n=forge.md.sha1.create()}var p=n.digestLength,c=n.blockLength,y=new forge.util.ByteBuffer,d=new forge.util.ByteBuffer;if(null!=e){for(i=0;i<e.length;i++)d.putInt16(e.charCodeAt(i));d.putInt16(0)}var E=d.length(),C=r.length(),l=new forge.util.ByteBuffer;l.fillWithByte(a,c);var f=c*Math.ceil(C/c),g=new forge.util.ByteBuffer;for(i=0;i<f;i++)g.putByte(r.at(i%C));var u=c*Math.ceil(E/c),h=new forge.util.ByteBuffer;for(i=0;i<u;i++)h.putByte(d.at(i%E));var m=g;m.putBuffer(h);for(var S=Math.ceil(s/p),B=1;B<=S;B++){var A=new forge.util.ByteBuffer;A.putBytes(l.bytes()),A.putBytes(m.bytes());for(var T=0;T<t;T++)n.start(),n.update(A.getBytes()),A=n.digest();var k=new forge.util.ByteBuffer;for(i=0;i<c;i++)k.putByte(A.at(i%p));var v=Math.ceil(C/c)+Math.ceil(E/c),I=new forge.util.ByteBuffer;for(o=0;o<v;o++){var P=new forge.util.ByteBuffer(m.getBytes(c)),R=511;for(i=k.length()-1;i>=0;i--)R>>=8,R+=k.at(i)+P.at(i),P.setAt(i,255&R);I.putBuffer(P)}m=I,y.putBuffer(A)}return y.truncate(y.length()-s),y},pki.pbe.getCipher=function(e,r,a){switch(e){case pki.oids.pkcs5PBES2:return pki.pbe.getCipherForPBES2(e,r,a);case pki.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case pki.oids["pbewithSHAAnd40BitRC2-CBC"]:return pki.pbe.getCipherForPKCS12PBE(e,r,a);default:var t=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw t.oid=e,t.supportedOids=["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],t}},pki.pbe.getCipherForPBES2=function(e,r,a){var t,s={},n=[];if(!asn1.validate(r,PBES2AlgorithmsValidator,s,n))throw(t=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.")).errors=n,t;if((e=asn1.derToOid(s.kdfOid))!==pki.oids.pkcs5PBKDF2)throw(t=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.")).oid=e,t.supportedOids=["pkcs5PBKDF2"],t;if((e=asn1.derToOid(s.encOid))!==pki.oids["aes128-CBC"]&&e!==pki.oids["aes192-CBC"]&&e!==pki.oids["aes256-CBC"]&&e!==pki.oids["des-EDE3-CBC"]&&e!==pki.oids.desCBC)throw(t=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.")).oid=e,t.supportedOids=["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],t;var o,i,p=s.kdfSalt,c=forge.util.createBuffer(s.kdfIterationCount);switch(c=c.getInt(c.length()<<3),pki.oids[e]){case"aes128-CBC":o=16,i=forge.aes.createDecryptionCipher;break;case"aes192-CBC":o=24,i=forge.aes.createDecryptionCipher;break;case"aes256-CBC":o=32,i=forge.aes.createDecryptionCipher;break;case"des-EDE3-CBC":o=24,i=forge.des.createDecryptionCipher;break;case"desCBC":o=8,i=forge.des.createDecryptionCipher}var y=prfOidToMessageDigest(s.prfOid),d=forge.pkcs5.pbkdf2(a,p,c,o,y),E=s.encIv,C=i(d);return C.start(E),C},pki.pbe.getCipherForPKCS12PBE=function(e,r,a){var t={},s=[];if(!asn1.validate(r,pkcs12PbeParamsValidator,t,s))throw(y=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.")).errors=s,y;var n,o,i,p=forge.util.createBuffer(t.salt),c=forge.util.createBuffer(t.iterations);switch(c=c.getInt(c.length()<<3),e){case pki.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:n=24,o=8,i=forge.des.startDecrypting;break;case pki.oids["pbewithSHAAnd40BitRC2-CBC"]:n=5,o=8,i=function(e,r){var a=forge.rc2.createDecryptionCipher(e,40);return a.start(r,null),a};break;default:var y;throw(y=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.")).oid=e,y}var d=prfOidToMessageDigest(t.prfOid),E=pki.pbe.generatePkcs12Key(a,p,1,c,n,d);return d.start(),i(E,pki.pbe.generatePkcs12Key(a,p,2,c,o,d))},pki.pbe.opensslDeriveBytes=function(e,r,a,t){if(null==t){if(!("md5"in forge.md))throw new Error('"md5" hash algorithm unavailable.');t=forge.md.md5.create()}null===r&&(r="");for(var s=[hash(t,e+r)],n=16,o=1;n<a;++o,n+=16)s.push(hash(t,s[o-1]+e+r));return s.join("").substr(0,a)};