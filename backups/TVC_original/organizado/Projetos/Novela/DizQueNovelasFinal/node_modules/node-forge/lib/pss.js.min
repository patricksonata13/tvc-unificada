var forge=require("./forge");require("./random"),require("./util");var pss=module.exports=forge.pss=forge.pss||{};pss.create=function(e){3===arguments.length&&(e={md:arguments[0],mgf:arguments[1],saltLength:arguments[2]});var t,r=e.md,o=e.mgf,n=r.digestLength,s=e.salt||null;if("string"==typeof s&&(s=forge.util.createBuffer(s)),"saltLength"in e)t=e.saltLength;else{if(null===s)throw new Error("Salt length not specified or specific salt not given.");t=s.length()}if(null!==s&&s.length()!==t)throw new Error("Given salt length does not match length of given salt.");var a=e.prng||forge.random,i={encode:function(e,i){var f,g,u=i-1,h=Math.ceil(u/8),l=e.digest().getBytes();if(h<n+t+2)throw new Error("Message is too long to encrypt.");g=null===s?a.getBytesSync(t):s.bytes();var d=new forge.util.ByteBuffer;d.fillWithByte(0,8),d.putBytes(l),d.putBytes(g),r.start(),r.update(d.getBytes());var c=r.digest().getBytes(),y=new forge.util.ByteBuffer;y.fillWithByte(0,h-t-n-2),y.putByte(1),y.putBytes(g);var B=y.getBytes(),p=h-n-1,C=o.generate(c,p),v="";for(f=0;f<p;f++)v+=String.fromCharCode(B.charCodeAt(f)^C.charCodeAt(f));var w=65280>>8*h-u&255;return(v=String.fromCharCode(v.charCodeAt(0)&~w)+v.substr(1))+c+String.fromCharCode(188)},verify:function(e,s,a){var i,f=a-1,g=Math.ceil(f/8);if(s=s.substr(-g),g<n+t+2)throw new Error("Inconsistent parameters to PSS signature verification.");if(188!==s.charCodeAt(g-1))throw new Error("Encoded message does not end in 0xBC.");var u=g-n-1,h=s.substr(0,u),l=s.substr(u,n),d=65280>>8*g-f&255;if(0!==(h.charCodeAt(0)&d))throw new Error("Bits beyond keysize not zero as expected.");var c=o.generate(l,u),y="";for(i=0;i<u;i++)y+=String.fromCharCode(h.charCodeAt(i)^c.charCodeAt(i));y=String.fromCharCode(y.charCodeAt(0)&~d)+y.substr(1);var B=g-n-t-2;for(i=0;i<B;i++)if(0!==y.charCodeAt(i))throw new Error("Leftmost octets not zero as expected");if(1!==y.charCodeAt(B))throw new Error("Inconsistent PSS signature, 0x01 marker not found");var p=y.substr(-t),C=new forge.util.ByteBuffer;return C.fillWithByte(0,8),C.putBytes(e),C.putBytes(p),r.start(),r.update(C.getBytes()),l===r.digest().getBytes()}};return i};