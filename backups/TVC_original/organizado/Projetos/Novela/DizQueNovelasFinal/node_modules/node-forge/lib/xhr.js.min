var forge=require("./forge");require("./socket"),require("./http");var xhrApi=module.exports=forge.xhr=forge.xhr||{};!function(e){var r="forge.xhr",t=null,o=0,n=null,s=null,a={},i=10,l=forge.net,u=forge.http;xhrApi.init=function(e){forge.log.debug(r,"initializing",e),o=e.policyPort||o,n=e.policyUrl||n,i=e.connections||i,t=l.createSocketPool({flashId:e.flashId,policyPort:o,policyUrl:n,msie:e.msie||!1}),s=u.createClient({url:e.url||window.location.protocol+"//"+window.location.host,socketPool:t,policyPort:o,policyUrl:n,connections:e.connections||i,caCerts:e.caCerts,cipherSuites:e.cipherSuites,persistCookies:e.persistCookies||!0,primeTlsSockets:e.primeTlsSockets||!1,verify:e.verify,getCertificate:e.getCertificate,getPrivateKey:e.getPrivateKey,getSignature:e.getSignature}),a[s.url.origin]=s,forge.log.debug(r,"ready")},xhrApi.cleanup=function(){for(var e in a)a[e].destroy();a={},s=null,t.destroy(),t=null},xhrApi.setCookie=function(e){if(e.maxAge=e.maxAge||-1,e.domain)for(var r in a){var t=a[r];u.withinCookieDomain(t.url,e)&&t.secure===e.secure&&t.setCookie(e)}else s.setCookie(e)},xhrApi.getCookie=function(e,r,t){var o=null;if(t)for(var n in a){var i=a[n];if(u.withinCookieDomain(i.url,t)){var l=i.getCookie(e,r);null!==l&&(null===o?o=l:forge.util.isArray(o)?o.push(l):o=[o,l])}}else o=s.getCookie(e,r);return o},xhrApi.removeCookie=function(e,r,t){var o=!1;if(t)for(var n in a){var i=a[n];u.withinCookieDomain(i.url,t)&&i.removeCookie(e,r)&&(o=!0)}else o=s.removeCookie(e,r);return o},xhrApi.create=function(l){l=e.extend({logWarningOnError:!0,verbose:!1,logError:function(){},logWarning:function(){},logDebug:function(){},logVerbose:function(){},url:null},l||{});var c={client:null,request:null,response:null,asynchronous:!0,sendFlag:!1,errorFlag:!1},g={error:l.logError||forge.log.error,warning:l.logWarning||forge.log.warning,debug:l.logDebug||forge.log.debug,verbose:l.logVerbose||forge.log.verbose},d={onreadystatechange:null,readyState:0,responseText:"",responseXML:null,status:0,statusText:""};if(null===l.url)c.client=s;else{var p;try{p=new URL(l.url)}catch(e){new Error("Invalid url.").details={url:l.url}}p.origin in a?c.client=a[p.origin]:(c.client=u.createClient({url:l.url,socketPool:t,policyPort:l.policyPort||o,policyUrl:l.policyUrl||n,connections:l.connections||i,caCerts:l.caCerts,cipherSuites:l.cipherSuites,persistCookies:l.persistCookies||!0,primeTlsSockets:l.primeTlsSockets||!1,verify:l.verify,getCertificate:l.getCertificate,getPrivateKey:l.getPrivateKey,getSignature:l.getSignature}),a[p.origin]=c.client)}return d.open=function(e,r,t,o,n){switch(e){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"PATCH":case"POST":case"PUT":break;case"CONNECT":case"TRACE":case"TRACK":throw new Error("CONNECT, TRACE and TRACK methods are disallowed");default:throw new Error("Invalid method: "+e)}c.sendFlag=!1,d.responseText="",d.responseXML=null,d.status=0,d.statusText="",c.request=u.createRequest({method:e,path:r}),d.readyState=1,d.onreadystatechange&&d.onreadystatechange()},d.setRequestHeader=function(e,r){if(1!=d.readyState||c.sendFlag)throw new Error("XHR not open or sending");c.request.setField(e,r)},d.send=function(e){if(1!=d.readyState||c.sendFlag)throw new Error("XHR not open or sending");if(e&&"GET"!==c.request.method&&"HEAD"!==c.request.method)if("undefined"!=typeof XMLSerializer)if(e instanceof Document){var t=new XMLSerializer;c.request.body=t.serializeToString(e)}else c.request.body=e;else void 0!==e.xml?c.request.body=e.xml:c.request.body=e;c.errorFlag=!1,c.sendFlag=!0,d.onreadystatechange&&d.onreadystatechange();var o={};o.request=c.request,o.headerReady=function(e){d.cookies=c.client.cookies,d.readyState=2,d.status=e.response.code,d.statusText=e.response.message,c.response=e.response,d.onreadystatechange&&d.onreadystatechange(),c.response.aborted||(d.readyState=3,d.onreadystatechange&&d.onreadystatechange())},o.bodyReady=function(e){d.readyState=4;var t=e.response.getField("Content-Type");if(t&&(0===t.indexOf("text/xml")||0===t.indexOf("application/xml")||-1!==t.indexOf("+xml")))try{var n=new ActiveXObject("MicrosoftXMLDOM");n.async=!1,n.loadXML(e.response.body),d.responseXML=n}catch(e){var s=new DOMParser;d.responseXML=s.parseFromString(e.body,"text/xml")}var a=0;null!==e.response.body&&(d.responseText=e.response.body,a=e.response.body.length);var i=c.request,l=i.method+" "+i.path+" "+d.status+" "+d.statusText+" "+a+"B "+(e.request.connectTime+e.request.time+e.response.time)+"ms";o.verbose?(d.status>=400&&o.logWarningOnError?g.warning:g.verbose)(r,l,e,e.response.body?"\n"+e.response.body:"\nNo content"):(d.status>=400&&o.logWarningOnError?g.warning:g.debug)(r,l),d.onreadystatechange&&d.onreadystatechange()},o.error=function(e){var t=c.request;g.error(r,t.method+" "+t.path,e),d.responseText="",d.responseXML=null,c.errorFlag=!0,d.status=0,d.statusText="",d.readyState=4,d.onreadystatechange&&d.onreadystatechange()},c.client.send(o)},d.abort=function(){c.request.abort(),d.responseText="",d.responseXML=null,c.errorFlag=!0,d.status=0,d.statusText="",c.request=null,c.response=null,4===d.readyState||0===d.readyState||1===d.readyState&&!c.sendFlag||(d.readyState=4,c.sendFlag=!1,d.onreadystatechange&&d.onreadystatechange()),d.readyState=0},d.getAllResponseHeaders=function(){var r="";if(null!==c.response){var t=c.response.fields;e.each(t,function(t,o){e.each(o,function(e,o){r+=t+": "+o+"\r\n"})})}return r},d.getResponseHeader=function(e){var r=null;return null!==c.response&&e in c.response.fields&&(r=c.response.fields[e],forge.util.isArray(r)&&(r=r.join())),r},d}}(jQuery);