var forge=require("./forge");require("./aes"),require("./asn1"),require("./des"),require("./oids"),require("./pem"),require("./pkcs7asn1"),require("./random"),require("./util"),require("./x509");var asn1=forge.asn1,p7=module.exports=forge.pkcs7=forge.pkcs7||{};function _recipientFromAsn1(e){var t={},n=[];if(!asn1.validate(e,p7.asn1.recipientInfoValidator,t,n)){var r=new Error("Cannot read PKCS#7 RecipientInfo. ASN.1 object is not an PKCS#7 RecipientInfo.");throw r.errors=n,r}return{version:t.version.charCodeAt(0),issuer:forge.pki.RDNAttributesAsArray(t.issuer),serialNumber:forge.util.createBuffer(t.serial).toHex(),encryptedContent:{algorithm:asn1.derToOid(t.encAlgorithm),parameter:t.encParameter?t.encParameter.value:void 0,content:t.encKey}}}function _recipientToAsn1(e){return asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,asn1.integerToDer(e.version).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[forge.pki.distinguishedNameToAsn1({attributes:e.issuer}),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,forge.util.hexToBytes(e.serialNumber))]),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.encryptedContent.algorithm).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.NULL,!1,"")]),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e.encryptedContent.content)])}function _recipientsFromAsn1(e){for(var t=[],n=0;n<e.length;++n)t.push(_recipientFromAsn1(e[n]));return t}function _recipientsToAsn1(e){for(var t=[],n=0;n<e.length;++n)t.push(_recipientToAsn1(e[n]));return t}function _signerFromAsn1(e){var t={},n=[];if(!asn1.validate(e,p7.asn1.signerInfoValidator,t,n)){var r=new Error("Cannot read PKCS#7 SignerInfo. ASN.1 object is not an PKCS#7 SignerInfo.");throw r.errors=n,r}var s={version:t.version.charCodeAt(0),issuer:forge.pki.RDNAttributesAsArray(t.issuer),serialNumber:forge.util.createBuffer(t.serial).toHex(),digestAlgorithm:asn1.derToOid(t.digestAlgorithm),signatureAlgorithm:asn1.derToOid(t.signatureAlgorithm),signature:t.signature,authenticatedAttributes:[],unauthenticatedAttributes:[]};t.authenticatedAttributes,t.unauthenticatedAttributes;return s}function _signerToAsn1(e){var t=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,asn1.integerToDer(e.version).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[forge.pki.distinguishedNameToAsn1({attributes:e.issuer}),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,forge.util.hexToBytes(e.serialNumber))]),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.digestAlgorithm).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.NULL,!1,"")])]);if(e.authenticatedAttributesAsn1&&t.value.push(e.authenticatedAttributesAsn1),t.value.push(asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.signatureAlgorithm).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.NULL,!1,"")])),t.value.push(asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e.signature)),e.unauthenticatedAttributes.length>0){for(var n=asn1.create(asn1.Class.CONTEXT_SPECIFIC,1,!0,[]),r=0;r<e.unauthenticatedAttributes.length;++r){var s=e.unauthenticatedAttributes[r];n.values.push(_attributeToAsn1(s))}t.value.push(n)}return t}function _signersFromAsn1(e){for(var t=[],n=0;n<e.length;++n)t.push(_signerFromAsn1(e[n]));return t}function _signersToAsn1(e){for(var t=[],n=0;n<e.length;++n)t.push(_signerToAsn1(e[n]));return t}function _attributeToAsn1(e){var t;if(e.type===forge.pki.oids.contentType)t=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.value).getBytes());else if(e.type===forge.pki.oids.messageDigest)t=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e.value.bytes());else if(e.type===forge.pki.oids.signingTime){var n=new Date("1950-01-01T00:00:00Z"),r=new Date("2050-01-01T00:00:00Z"),s=e.value;if("string"==typeof s){var a=Date.parse(s);s=isNaN(a)?13===s.length?asn1.utcTimeToDate(s):asn1.generalizedTimeToDate(s):new Date(a)}t=s>=n&&s<r?asn1.create(asn1.Class.UNIVERSAL,asn1.Type.UTCTIME,!1,asn1.dateToUtcTime(s)):asn1.create(asn1.Class.UNIVERSAL,asn1.Type.GENERALIZEDTIME,!1,asn1.dateToGeneralizedTime(s))}return asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.type).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SET,!0,[t])])}function _encryptedContentToAsn1(e){return[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(forge.pki.oids.data).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.algorithm).getBytes()),e.parameter?asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e.parameter.getBytes()):void 0]),asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,e.content.getBytes())])]}function _fromAsn1(e,t,n){var r={};if(!asn1.validate(t,n,r,[])){var s=new Error("Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.");throw s.errors=s,s}if(asn1.derToOid(r.contentType)!==forge.pki.oids.data)throw new Error("Unsupported PKCS#7 message. Only wrapped ContentType Data supported.");if(r.encryptedContent){var a="";if(forge.util.isArray(r.encryptedContent))for(var i=0;i<r.encryptedContent.length;++i){if(r.encryptedContent[i].type!==asn1.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects.");a+=r.encryptedContent[i].value}else a=r.encryptedContent;e.encryptedContent={algorithm:asn1.derToOid(r.encAlgorithm),parameter:forge.util.createBuffer(r.encParameter.value),content:forge.util.createBuffer(a)}}if(r.content){a="";if(forge.util.isArray(r.content))for(i=0;i<r.content.length;++i){if(r.content[i].type!==asn1.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects.");a+=r.content[i].value}else a=r.content;e.content=forge.util.createBuffer(a)}return e.version=r.version.charCodeAt(0),e.rawCapture=r,r}function _decryptContent(e){if(void 0===e.encryptedContent.key)throw new Error("Symmetric key not available.");if(void 0===e.content){var t;switch(e.encryptedContent.algorithm){case forge.pki.oids["aes128-CBC"]:case forge.pki.oids["aes192-CBC"]:case forge.pki.oids["aes256-CBC"]:t=forge.aes.createDecryptionCipher(e.encryptedContent.key);break;case forge.pki.oids.desCBC:case forge.pki.oids["des-EDE3-CBC"]:t=forge.des.createDecryptionCipher(e.encryptedContent.key);break;default:throw new Error("Unsupported symmetric cipher, OID "+e.encryptedContent.algorithm)}if(t.start(e.encryptedContent.parameter),t.update(e.encryptedContent.content),!t.finish())throw new Error("Symmetric decryption failed.");e.content=t.output}}p7.messageFromPem=function(e){var t=forge.pem.decode(e)[0];if("PKCS7"!==t.type){var n=new Error('Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".');throw n.headerType=t.type,n}if(t.procType&&"ENCRYPTED"===t.procType.type)throw new Error("Could not convert PKCS#7 message from PEM; PEM is encrypted.");var r=asn1.fromDer(t.body);return p7.messageFromAsn1(r)},p7.messageToPem=function(e,t){var n={type:"PKCS7",body:asn1.toDer(e.toAsn1()).getBytes()};return forge.pem.encode(n,{maxline:t})},p7.messageFromAsn1=function(e){var t={},n=[];if(!asn1.validate(e,p7.asn1.contentInfoValidator,t,n)){var r=new Error("Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.");throw r.errors=n,r}var s,a=asn1.derToOid(t.contentType);switch(a){case forge.pki.oids.envelopedData:s=p7.createEnvelopedData();break;case forge.pki.oids.encryptedData:s=p7.createEncryptedData();break;case forge.pki.oids.signedData:s=p7.createSignedData();break;default:throw new Error("Cannot read PKCS#7 message. ContentType with OID "+a+" is not (yet) supported.")}return s.fromAsn1(t.content.value[0]),s},p7.createSignedData=function(){var e=null;return e={type:forge.pki.oids.signedData,version:1,certificates:[],crls:[],signers:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(t){if(_fromAsn1(e,t,p7.asn1.signedDataValidator),e.certificates=[],e.crls=[],e.digestAlgorithmIdentifiers=[],e.contentInfo=null,e.signerInfos=[],e.rawCapture.certificates)for(var n=e.rawCapture.certificates.value,r=0;r<n.length;++r)e.certificates.push(forge.pki.certificateFromAsn1(n[r]))},toAsn1:function(){e.contentInfo||e.sign();for(var t=[],n=0;n<e.certificates.length;++n)t.push(forge.pki.certificateToAsn1(e.certificates[n]));var r=[],s=asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,asn1.integerToDer(e.version).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SET,!0,e.digestAlgorithmIdentifiers),e.contentInfo])]);return t.length>0&&s.value[0].value.push(asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,t)),r.length>0&&s.value[0].value.push(asn1.create(asn1.Class.CONTEXT_SPECIFIC,1,!0,r)),s.value[0].value.push(asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SET,!0,e.signerInfos)),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.type).getBytes()),s])},addSigner:function(t){var n=t.issuer,r=t.serialNumber;if(t.certificate){var s=t.certificate;"string"==typeof s&&(s=forge.pki.certificateFromPem(s)),n=s.issuer.attributes,r=s.serialNumber}var a=t.key;if(!a)throw new Error("Could not add PKCS#7 signer; no private key specified.");"string"==typeof a&&(a=forge.pki.privateKeyFromPem(a));var i=t.digestAlgorithm||forge.pki.oids.sha1;switch(i){case forge.pki.oids.sha1:case forge.pki.oids.sha256:case forge.pki.oids.sha384:case forge.pki.oids.sha512:case forge.pki.oids.md5:break;default:throw new Error("Could not add PKCS#7 signer; unknown message digest algorithm: "+i)}var o=t.authenticatedAttributes||[];if(o.length>0){for(var c=!1,p=!1,d=0;d<o.length;++d){var u=o[d];if(c||u.type!==forge.pki.oids.contentType){if(p||u.type!==forge.pki.oids.messageDigest);else if(p=!0,c)break}else if(c=!0,p)break}if(!c||!p)throw new Error("Invalid signer.authenticatedAttributes. If signer.authenticatedAttributes is specified, then it must contain at least two attributes, PKCS #9 content-type and PKCS #9 message-digest.")}e.signers.push({key:a,version:1,issuer:n,serialNumber:r,digestAlgorithm:i,signatureAlgorithm:forge.pki.oids.rsaEncryption,signature:null,authenticatedAttributes:o,unauthenticatedAttributes:[]})},sign:function(t){var n;(t=t||{},"object"!=typeof e.content||null===e.contentInfo)&&(e.contentInfo=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(forge.pki.oids.data).getBytes())]),"content"in e&&(e.content instanceof forge.util.ByteBuffer?n=e.content.bytes():"string"==typeof e.content&&(n=forge.util.encodeUtf8(e.content)),t.detached?e.detachedContent=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,n):e.contentInfo.value.push(asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OCTETSTRING,!1,n)]))));0!==e.signers.length&&function(t){var n;n=e.detachedContent?e.detachedContent:(n=e.contentInfo.value[1]).value[0];if(!n)throw new Error("Could not sign PKCS#7 message; there is no content to sign.");var r=asn1.derToOid(e.contentInfo.value[0].value),s=asn1.toDer(n);for(var a in s.getByte(),asn1.getBerValueLength(s),s=s.getBytes(),t)t[a].start().update(s);for(var i=new Date,o=0;o<e.signers.length;++o){var c=e.signers[o];if(0===c.authenticatedAttributes.length){if(r!==forge.pki.oids.data)throw new Error("Invalid signer; authenticatedAttributes must be present when the ContentInfo content type is not PKCS#7 Data.")}else{c.authenticatedAttributesAsn1=asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,[]);for(var p=asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SET,!0,[]),d=0;d<c.authenticatedAttributes.length;++d){var u=c.authenticatedAttributes[d];u.type===forge.pki.oids.messageDigest?u.value=t[c.digestAlgorithm].digest():u.type===forge.pki.oids.signingTime&&(u.value||(u.value=i)),p.value.push(_attributeToAsn1(u)),c.authenticatedAttributesAsn1.value.push(_attributeToAsn1(u))}s=asn1.toDer(p).getBytes(),c.md.start().update(s)}c.signature=c.key.sign(c.md,"RSASSA-PKCS1-V1_5")}e.signerInfos=_signersToAsn1(e.signers)}(function(){for(var t={},n=0;n<e.signers.length;++n){var r=e.signers[n];(s=r.digestAlgorithm)in t||(t[s]=forge.md[forge.pki.oids[s]].create()),0===r.authenticatedAttributes.length?r.md=t[s]:r.md=forge.md[forge.pki.oids[s]].create()}for(var s in e.digestAlgorithmIdentifiers=[],t)e.digestAlgorithmIdentifiers.push(asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(s).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.NULL,!1,"")]));return t}())},verify:function(){throw new Error("PKCS#7 signature verification not yet implemented.")},addCertificate:function(t){"string"==typeof t&&(t=forge.pki.certificateFromPem(t)),e.certificates.push(t)},addCertificateRevokationList:function(e){throw new Error("PKCS#7 CRL support not yet implemented.")}}},p7.createEncryptedData=function(){var e=null;return e={type:forge.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:forge.pki.oids["aes256-CBC"]},fromAsn1:function(t){_fromAsn1(e,t,p7.asn1.encryptedDataValidator)},decrypt:function(t){void 0!==t&&(e.encryptedContent.key=t),_decryptContent(e)}}},p7.createEnvelopedData=function(){var e=null;return e={type:forge.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:forge.pki.oids["aes256-CBC"]},fromAsn1:function(t){var n=_fromAsn1(e,t,p7.asn1.envelopedDataValidator);e.recipients=_recipientsFromAsn1(n.recipientInfos.value)},toAsn1:function(){return asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.OID,!1,asn1.oidToDer(e.type).getBytes()),asn1.create(asn1.Class.CONTEXT_SPECIFIC,0,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,[asn1.create(asn1.Class.UNIVERSAL,asn1.Type.INTEGER,!1,asn1.integerToDer(e.version).getBytes()),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SET,!0,_recipientsToAsn1(e.recipients)),asn1.create(asn1.Class.UNIVERSAL,asn1.Type.SEQUENCE,!0,_encryptedContentToAsn1(e.encryptedContent))])])])},findRecipient:function(t){for(var n=t.issuer.attributes,r=0;r<e.recipients.length;++r){var s=e.recipients[r],a=s.issuer;if(s.serialNumber===t.serialNumber&&a.length===n.length){for(var i=!0,o=0;o<n.length;++o)if(a[o].type!==n[o].type||a[o].value!==n[o].value){i=!1;break}if(i)return s}}return null},decrypt:function(t,n){if(void 0===e.encryptedContent.key&&void 0!==t&&void 0!==n)switch(t.encryptedContent.algorithm){case forge.pki.oids.rsaEncryption:case forge.pki.oids.desCBC:var r=n.decrypt(t.encryptedContent.content);e.encryptedContent.key=forge.util.createBuffer(r);break;default:throw new Error("Unsupported asymmetric cipher, OID "+t.encryptedContent.algorithm)}_decryptContent(e)},addRecipient:function(t){e.recipients.push({version:0,issuer:t.issuer.attributes,serialNumber:t.serialNumber,encryptedContent:{algorithm:forge.pki.oids.rsaEncryption,key:t.publicKey}})},encrypt:function(t,n){if(void 0===e.encryptedContent.content){var r,s,a;switch(n=n||e.encryptedContent.algorithm,t=t||e.encryptedContent.key,n){case forge.pki.oids["aes128-CBC"]:r=16,s=16,a=forge.aes.createEncryptionCipher;break;case forge.pki.oids["aes192-CBC"]:r=24,s=16,a=forge.aes.createEncryptionCipher;break;case forge.pki.oids["aes256-CBC"]:r=32,s=16,a=forge.aes.createEncryptionCipher;break;case forge.pki.oids["des-EDE3-CBC"]:r=24,s=8,a=forge.des.createEncryptionCipher;break;default:throw new Error("Unsupported symmetric cipher, OID "+n)}if(void 0===t)t=forge.util.createBuffer(forge.random.getBytes(r));else if(t.length()!=r)throw new Error("Symmetric key has wrong length; got "+t.length()+" bytes, expected "+r+".");e.encryptedContent.algorithm=n,e.encryptedContent.key=t,e.encryptedContent.parameter=forge.util.createBuffer(forge.random.getBytes(s));var i=a(t);if(i.start(e.encryptedContent.parameter.copy()),i.update(e.content),!i.finish())throw new Error("Symmetric encryption failed.");e.encryptedContent.content=i.output}for(var o=0;o<e.recipients.length;++o){var c=e.recipients[o];if(void 0===c.encryptedContent.content){if(c.encryptedContent.algorithm!==forge.pki.oids.rsaEncryption)throw new Error("Unsupported asymmetric cipher, OID "+c.encryptedContent.algorithm);c.encryptedContent.content=c.encryptedContent.key.encrypt(e.encryptedContent.key.data)}}}}};