var forge=require("./forge");require("./util"),require("./random"),require("./sha1");var pkcs1=module.exports=forge.pkcs1=forge.pkcs1||{};function rsa_mgf1(e,t,r){r||(r=forge.md.sha1.create());for(var g="",n=Math.ceil(t/r.digestLength),s=0;s<n;++s){var i=String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,255&s);r.start(),r.update(e+i),g+=r.digest().getBytes()}return g.substring(0,t)}pkcs1.encode_rsa_oaep=function(e,t,r){var g,n,s,i;"string"==typeof r?(g=r,n=arguments[3]||void 0,s=arguments[4]||void 0):r&&(g=r.label||void 0,n=r.seed||void 0,s=r.md||void 0,r.mgf1&&r.mgf1.md&&(i=r.mgf1.md)),s?s.start():s=forge.md.sha1.create(),i||(i=s);var h=Math.ceil(e.n.bitLength()/8),o=h-2*s.digestLength-2;if(t.length>o)throw(u=new Error("RSAES-OAEP input message length is too long.")).length=t.length,u.maxLength=o,u;g||(g=""),s.update(g,"raw");for(var d=s.digest(),a="",f=o-t.length,l=0;l<f;l++)a+="\0";var m=d.getBytes()+a+""+t;if(n){if(n.length!==s.digestLength){var u;throw(u=new Error("Invalid RSAES-OAEP seed. The seed length must match the digest length.")).seedLength=n.length,u.digestLength=s.digestLength,u}}else n=forge.random.getBytes(s.digestLength);var v=rsa_mgf1(n,h-s.digestLength-1,i),c=forge.util.xorBytes(m,v,m.length),L=rsa_mgf1(c,s.digestLength,i);return"\0"+forge.util.xorBytes(n,L,n.length)+c},pkcs1.decode_rsa_oaep=function(e,t,r){var g,n,s;"string"==typeof r?(g=r,n=arguments[3]||void 0):r&&(g=r.label||void 0,n=r.md||void 0,r.mgf1&&r.mgf1.md&&(s=r.mgf1.md));var i=Math.ceil(e.n.bitLength()/8);if(t.length!==i)throw(v=new Error("RSAES-OAEP encoded message length is invalid.")).length=t.length,v.expectedLength=i,v;if(void 0===n?n=forge.md.sha1.create():n.start(),s||(s=n),i<2*n.digestLength+2)throw new Error("RSAES-OAEP key is too short for the hash function.");g||(g=""),n.update(g,"raw");for(var h=n.digest().getBytes(),o=t.charAt(0),d=t.substring(1,n.digestLength+1),a=t.substring(1+n.digestLength),f=rsa_mgf1(a,n.digestLength,s),l=rsa_mgf1(forge.util.xorBytes(d,f,d.length),i-n.digestLength-1,s),m=forge.util.xorBytes(a,l,a.length),u=m.substring(0,n.digestLength),v="\0"!==o,c=0;c<n.digestLength;++c)v|=h.charAt(c)!==u.charAt(c);for(var L=1,p=n.digestLength,A=n.digestLength;A<m.length;A++){var E=m.charCodeAt(A);v|=E&(L?65534:0),p+=L&=1&E^1}if(v||1!==m.charCodeAt(p))throw new Error("Invalid RSAES-OAEP padding.");return m.substring(p+1)};