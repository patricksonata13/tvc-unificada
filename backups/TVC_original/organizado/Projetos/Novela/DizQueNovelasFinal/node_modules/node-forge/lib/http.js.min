var forge=require("./forge");require("./tls"),require("./util");var http=module.exports=forge.http=forge.http||{},cat="forge.http",_normalize=function(e){return e.toLowerCase().replace(/(^.)|(-.)/g,function(e){return e.toUpperCase()})},_getStorageId=function(e){return"forge.http."+e.url.protocol.slice(0,-1)+"."+e.url.hostname+"."+e.url.port},_loadCookies=function(e){if(e.persistCookies)try{var t=forge.util.getItem(e.socketPool.flashApi,_getStorageId(e),"cookies");e.cookies=t||{}}catch(e){}},_saveCookies=function(e){if(e.persistCookies)try{forge.util.setItem(e.socketPool.flashApi,_getStorageId(e),"cookies",e.cookies)}catch(e){}_loadCookies(e)},_clearCookies=function(e){if(e.persistCookies)try{forge.util.clearItems(e.socketPool.flashApi,_getStorageId(e))}catch(e){}},_doRequest=function(e,t){t.isConnected()?(t.options.request.connectTime=+new Date,t.connected({type:"connect",id:t.id})):(t.options.request.connectTime=+new Date,t.connect({host:e.url.hostname,port:e.url.port,policyPort:e.policyPort,policyUrl:e.policyUrl}))},_handleNextRequest=function(e,t){t.buffer.clear();for(var o=null;null===o&&e.requests.length>0;)(o=e.requests.shift()).request.aborted&&(o=null);null===o?(null!==t.options&&(t.options=null),e.idle.push(t)):(t.retries=1,t.options=o,_doRequest(e,t))},_initSocket=function(e,t,o){t.options=null,t.connected=function(o){if(null===t.options)_handleNextRequest(e,t);else{var n=t.options.request;if(n.connectTime=+new Date-n.connectTime,o.socket=t,t.options.connected(o),n.aborted)t.close();else{var i=n.toString();n.body&&(i+=n.body),n.time=+new Date,t.send(i),n.time=+new Date-n.time,t.options.response.time=+new Date,t.sending=!0}}},t.closed=function(o){if(t.sending)t.sending=!1,t.retries>0?(--t.retries,_doRequest(e,t)):t.error({id:t.id,type:"ioError",message:"Connection closed during send. Broken pipe.",bytesAvailable:0});else{var n=t.options.response;n.readBodyUntilClose&&(n.time=+new Date-n.time,n.bodyReceived=!0,t.options.bodyReady({request:t.options.request,response:n,socket:t})),t.options.closed(o),_handleNextRequest(e,t)}},t.data=function(o){if(t.sending=!1,t.options.request.aborted)t.close();else{var n=t.options.response,i=t.receive(o.bytesAvailable);if(null!==i)if(t.buffer.putBytes(i),n.headerReceived||(n.readHeader(t.buffer),n.headerReceived&&t.options.headerReady({request:t.options.request,response:n,socket:t})),n.headerReceived&&!n.bodyReceived&&n.readBody(t.buffer),n.bodyReceived)t.options.bodyReady({request:t.options.request,response:n,socket:t}),-1!=(n.getField("Connection")||"").indexOf("close")||"HTTP/1.0"===n.version&&null===n.getField("Keep-Alive")?t.close():_handleNextRequest(e,t)}},t.error=function(e){t.options.error({type:e.type,message:e.message,request:t.options.request,response:t.options.response,socket:t}),t.close()},o?((t=forge.tls.wrapSocket({sessionId:null,sessionCache:{},caStore:o.caStore,cipherSuites:o.cipherSuites,socket:t,virtualHost:o.virtualHost,verify:o.verify,getCertificate:o.getCertificate,getPrivateKey:o.getPrivateKey,getSignature:o.getSignature,deflate:o.deflate||null,inflate:o.inflate||null})).options=null,t.buffer=forge.util.createBuffer(),e.sockets.push(t),o.prime?t.connect({host:e.url.hostname,port:e.url.port,policyPort:e.policyPort,policyUrl:e.policyUrl}):e.idle.push(t)):(t.buffer=forge.util.createBuffer(),e.sockets.push(t),e.idle.push(t))},_hasCookieExpired=function(e){var t=!1;if(-1!==e.maxAge){var o=_getUtcTime(new Date);e.created+e.maxAge<=o&&(t=!0)}return t},_writeCookies=function(e,t){var o=[],n=(e.url,e.cookies);for(var i in n){var r=n[i];for(var l in r){var s=r[l];_hasCookieExpired(s)?o.push(s):0===t.path.indexOf(s.path)&&t.addCookie(s)}}for(var a=0;a<o.length;++a){s=o[a];e.removeCookie(s.name,s.path)}},_readCookies=function(e,t){for(var o=t.getCookies(),n=0;n<o.length;++n)try{e.setCookie(o[n])}catch(e){}};http.createClient=function(e){var t,o=null;e.caCerts&&(o=forge.pki.createCaStore(e.caCerts)),e.url=e.url||window.location.protocol+"//"+window.location.host;try{t=new URL(e.url)}catch(t){var n=new Error("Invalid url.");throw n.details={url:e.url},n}e.connections=e.connections||1;var i=e.socketPool,r={url:t,socketPool:i,policyPort:e.policyPort,policyUrl:e.policyUrl,requests:[],sockets:[],idle:[],secure:"https:"===t.protocol,cookies:{},persistCookies:void 0===e.persistCookies||e.persistCookies};_loadCookies(r);var l=null;r.secure&&(l={caStore:o,cipherSuites:e.cipherSuites||null,virtualHost:e.virtualHost||t.hostname,verify:e.verify||function(e,t,o,n){if(0===o&&!0===t){var i=n[o].subject.getField("CN");null!==i&&r.url.hostname===i.value||(t={message:"Certificate common name does not match url host."})}return t},getCertificate:e.getCertificate||null,getPrivateKey:e.getPrivateKey||null,getSignature:e.getSignature||null,prime:e.primeTlsSockets||!1},null!==i.flashApi&&(l.deflate=function(e){return forge.util.deflate(i.flashApi,e,!0)},l.inflate=function(e){return forge.util.inflate(i.flashApi,e,!0)}));for(var s=0;s<e.connections;++s)_initSocket(r,i.createSocket(),l);return r.send=function(e){null===e.request.getField("Host")&&e.request.setField("Host",r.url.origin);var t={};if(t.request=e.request,t.connected=e.connected||function(){},t.closed=e.close||function(){},t.headerReady=function(t){_readCookies(r,t.response),e.headerReady&&e.headerReady(t)},t.bodyReady=e.bodyReady||function(){},t.error=e.error||function(){},t.response=http.createResponse(),t.response.time=0,t.response.flashApi=r.socketPool.flashApi,t.request.flashApi=r.socketPool.flashApi,t.request.abort=function(){t.request.aborted=!0,t.connected=function(){},t.closed=function(){},t.headerReady=function(){},t.bodyReady=function(){},t.error=function(){}},_writeCookies(r,t.request),0===r.idle.length)r.requests.push(t);else{for(var o=null,n=r.idle.length,i=0;null===o&&i<n;++i)(o=r.idle[i]).isConnected()?r.idle.splice(i,1):o=null;null===o&&(o=r.idle.pop()),o.options=t,_doRequest(r,o)}},r.destroy=function(){r.requests=[];for(var e=0;e<r.sockets.length;++e)r.sockets[e].close(),r.sockets[e].destroy();r.socketPool=null,r.sockets=[],r.idle=[]},r.setCookie=function(e){var t;if(void 0!==e.name)if(null===e.value||void 0===e.value||""===e.value)t=r.removeCookie(e.name,e.path);else{var o;if(e.comment=e.comment||"",e.maxAge=e.maxAge||0,e.secure=void 0===e.secure||e.secure,e.httpOnly=e.httpOnly||!0,e.path=e.path||"/",e.domain=e.domain||null,e.version=e.version||null,e.created=_getUtcTime(new Date),e.secure!==r.secure)throw(o=new Error("Http client url scheme is incompatible with cookie secure flag.")).url=r.url,o.cookie=e,o;if(!http.withinCookieDomain(r.url,e))throw(o=new Error("Http client url scheme is incompatible with cookie secure flag.")).url=r.url,o.cookie=e,o;e.name in r.cookies||(r.cookies[e.name]={}),r.cookies[e.name][e.path]=e,t=!0,_saveCookies(r)}return t},r.getCookie=function(e,t){var o=null;if(e in r.cookies){var n=r.cookies[e];if(t)t in n&&(o=n[t]);else for(var i in n){o=n[i];break}}return o},r.removeCookie=function(e,t){var o=!1;if(e in r.cookies)if(t){if(t in r.cookies[e]){o=!0,delete r.cookies[e][t];var n=!0;for(var i in r.cookies[e]){n=!1;break}n&&delete r.cookies[e]}}else o=!0,delete r.cookies[e];return o&&_saveCookies(r),o},r.clearCookies=function(){r.cookies={},_clearCookies(r)},forge.log&&forge.log.debug("forge.http","created client",e),r};var _trimString=function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},_createHeader=function(){var e={fields:{},setField:function(t,o){e.fields[_normalize(t)]=[_trimString(""+o)]},appendField:function(t,o){(t=_normalize(t))in e.fields||(e.fields[t]=[]),e.fields[t].push(_trimString(""+o))},getField:function(t,o){var n=null;return(t=_normalize(t))in e.fields&&(o=o||0,n=e.fields[t][o]),n}};return e},_getUtcTime=function(e){e.getTimezoneOffset();return Math.floor(+new Date/1e3)};http.createRequest=function(e){e=e||{};var t=_createHeader();t.version=e.version||"HTTP/1.1",t.method=e.method||null,t.path=e.path||null,t.body=e.body||null,t.bodyDeflated=!1,t.flashApi=null;var o=e.headers||[];forge.util.isArray(o)||(o=[o]);for(var n=0;n<o.length;++n)for(var i in o[n])t.appendField(i,o[n][i]);return t.addCookie=function(e){var o="",n=t.getField("Cookie");null!==n&&(o=n+"; ");_getUtcTime(new Date);o+=e.name+"="+e.value,t.setField("Cookie",o)},t.toString=function(){null===t.getField("User-Agent")&&t.setField("User-Agent","forge.http 1.0"),null===t.getField("Accept")&&t.setField("Accept","*/*"),null===t.getField("Connection")&&(t.setField("Connection","keep-alive"),t.setField("Keep-Alive","115")),null!==t.flashApi&&null===t.getField("Accept-Encoding")&&t.setField("Accept-Encoding","deflate"),null!==t.flashApi&&null!==t.body&&null===t.getField("Content-Encoding")&&!t.bodyDeflated&&t.body.length>100?(t.body=forge.util.deflate(t.flashApi,t.body),t.bodyDeflated=!0,t.setField("Content-Encoding","deflate"),t.setField("Content-Length",t.body.length)):null!==t.body&&t.setField("Content-Length",t.body.length);var e=t.method.toUpperCase()+" "+t.path+" "+t.version+"\r\n";for(var o in t.fields)for(var n=t.fields[o],i=0;i<n.length;++i)e+=o+": "+n[i]+"\r\n";return e+="\r\n"},t},http.createResponse=function(){var e=!0,t=0,o=!1,n=_createHeader();n.version=null,n.code=0,n.message=null,n.body=null,n.headerReceived=!1,n.bodyReceived=!1,n.flashApi=null;var i=function(e){var t=null,o=e.data.indexOf("\r\n",e.read);return-1!=o&&(t=e.getBytes(o-e.read),e.getBytes(2)),t},r=function(e){var t=e.indexOf(":"),o=e.substring(0,t++);n.appendField(o,t<e.length?e.substring(t):"")};n.readHeader=function(t){for(var o="";!n.headerReceived&&null!==o;)if(null!==(o=i(t)))if(e){e=!1;var l=o.split(" ");if(!(l.length>=3)){var s=new Error("Invalid http response header.");throw s.details={line:o},s}n.version=l[0],n.code=parseInt(l[1],10),n.message=l.slice(2).join(" ")}else 0===o.length?n.headerReceived=!0:r(o);return n.headerReceived};return n.readBody=function(e){var l=n.getField("Content-Length"),s=n.getField("Transfer-Encoding");if(null!==l&&(l=parseInt(l)),null!==l&&l>=0)n.body=n.body||"",n.body+=e.getBytes(l),n.bodyReceived=n.body.length===l;else if(null!==s){if(-1==s.indexOf("chunked")){var a=new Error("Unknown Transfer-Encoding.");throw a.details={transferEncoding:s},a}n.body=n.body||"",function(e){for(var l="";null!==l&&e.length()>0;)if(t>0){if(t+2>e.length())break;n.body+=e.getBytes(t),e.getBytes(2),t=0}else if(o)for(l=i(e);null!==l;)l.length>0?(r(l),l=i(e)):(n.bodyReceived=!0,l=null);else null!==(l=i(e))&&(t=parseInt(l.split(";",1)[0],16),o=0===t);n.bodyReceived}(e)}else null!==l&&l<0||null===l&&null!==n.getField("Content-Type")?(n.body=n.body||"",n.body+=e.getBytes(),n.readBodyUntilClose=!0):(n.body=null,n.bodyReceived=!0);return n.bodyReceived&&(n.time=+new Date-n.time),null!==n.flashApi&&n.bodyReceived&&null!==n.body&&"deflate"===n.getField("Content-Encoding")&&(n.body=forge.util.inflate(n.flashApi,n.body)),n.bodyReceived},n.getCookies=function(){var e=[];if("Set-Cookie"in n.fields)for(var t=n.fields["Set-Cookie"],o=+new Date/1e3,i=/\s*([^=]*)=?([^;]*)(;|$)/g,r=0;r<t.length;++r){var l,s=t[r];i.lastIndex=0;var a=!0,c={};do{if(null!==(l=i.exec(s))){var u=_trimString(l[1]),d=_trimString(l[2]);if(a)c.name=u,c.value=d,a=!1;else switch(u=u.toLowerCase()){case"expires":d=d.replace(/-/g," ");var f=Date.parse(d)/1e3;c.maxAge=Math.max(0,f-o);break;case"max-age":c.maxAge=parseInt(d,10);break;case"secure":c.secure=!0;break;case"httponly":c.httpOnly=!0;break;default:""!==u&&(c[u]=d)}}}while(null!==l&&""!==l[0]);e.push(c)}return e},n.toString=function(){var e=n.version+" "+n.code+" "+n.message+"\r\n";for(var t in n.fields)for(var o=n.fields[t],i=0;i<o.length;++i)e+=t+": "+o[i]+"\r\n";return e+="\r\n"},n},http.withinCookieDomain=function(e,t){var o=!1,n=null===t||"string"==typeof t?t:t.domain;if(null===n)o=!0;else if("."===n.charAt(0)){"string"==typeof e&&(e=new URL(e));var i="."+e.hostname,r=i.lastIndexOf(n);-1!==r&&r+n.length===i.length&&(o=!0)}return o};