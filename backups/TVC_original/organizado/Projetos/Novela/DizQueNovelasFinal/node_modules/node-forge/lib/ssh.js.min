var forge=require("./forge");require("./aes"),require("./hmac"),require("./md5"),require("./sha1"),require("./util");var ssh=module.exports=forge.ssh=forge.ssh||{};function _addBigIntegerToBuffer(e,r){var t=r.toString(16);t[0]>="8"&&(t="00"+t);var n=forge.util.hexToBytes(t);e.putInt32(n.length),e.putBytes(n)}function _addStringToBuffer(e,r){e.putInt32(r.length),e.putString(r)}function _sha1(){for(var e=forge.md.sha1.create(),r=arguments.length,t=0;t<r;++t)e.update(arguments[t]);return e.digest()}ssh.privateKeyToPutty=function(e,r,t){var n="ssh-rsa",f=""===(r=r||"")?"none":"aes256-cbc",a="PuTTY-User-Key-File-2: "+n+"\r\n";a+="Encryption: "+f+"\r\n",a+="Comment: "+(t=t||"")+"\r\n";var i=forge.util.createBuffer();_addStringToBuffer(i,n),_addBigIntegerToBuffer(i,e.e),_addBigIntegerToBuffer(i,e.n);var u=forge.util.encode64(i.bytes(),64),o=Math.floor(u.length/66)+1;a+="Public-Lines: "+o+"\r\n",a+=u;var g,d=forge.util.createBuffer();if(_addBigIntegerToBuffer(d,e.d),_addBigIntegerToBuffer(d,e.p),_addBigIntegerToBuffer(d,e.q),_addBigIntegerToBuffer(d,e.qInv),r){var s=d.length()+16-1;s-=s%16;var B=_sha1(d.bytes());B.truncate(B.length()-s+d.length()),d.putBuffer(B);var c=forge.util.createBuffer();c.putBuffer(_sha1("\0\0\0\0",r)),c.putBuffer(_sha1("\0\0\0",r));var h=forge.aes.createEncryptionCipher(c.truncate(8),"CBC");h.start(forge.util.createBuffer().fillWithByte(0,16)),h.update(d.copy()),h.finish();var l=h.output;l.truncate(16),g=forge.util.encode64(l.bytes(),64)}else g=forge.util.encode64(d.bytes(),64);a+="\r\nPrivate-Lines: "+(o=Math.floor(g.length/66)+1)+"\r\n",a+=g;var p=_sha1("putty-private-key-file-mac-key",r),v=forge.util.createBuffer();_addStringToBuffer(v,n),_addStringToBuffer(v,f),_addStringToBuffer(v,t),v.putInt32(i.length()),v.putBuffer(i),v.putInt32(d.length()),v.putBuffer(d);var y=forge.hmac.create();return y.start("sha1",p),y.update(v.bytes()),a+="\r\nPrivate-MAC: "+y.digest().toHex()+"\r\n"},ssh.publicKeyToOpenSSH=function(e,r){var t="ssh-rsa";r=r||"";var n=forge.util.createBuffer();return _addStringToBuffer(n,t),_addBigIntegerToBuffer(n,e.e),_addBigIntegerToBuffer(n,e.n),t+" "+forge.util.encode64(n.bytes())+" "+r},ssh.privateKeyToOpenSSH=function(e,r){return r?forge.pki.encryptRsaPrivateKey(e,r,{legacy:!0,algorithm:"aes128"}):forge.pki.privateKeyToPem(e)},ssh.getPublicKeyFingerprint=function(e,r){var t=(r=r||{}).md||forge.md.md5.create(),n=forge.util.createBuffer();_addStringToBuffer(n,"ssh-rsa"),_addBigIntegerToBuffer(n,e.e),_addBigIntegerToBuffer(n,e.n),t.start(),t.update(n.getBytes());var f=t.digest();if("hex"===r.encoding){var a=f.toHex();return r.delimiter?a.match(/.{2}/g).join(r.delimiter):a}if("binary"===r.encoding)return f.getBytes();if(r.encoding)throw new Error('Unknown encoding "'+r.encoding+'".');return f};