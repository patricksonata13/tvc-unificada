"use strict";const generate=require("regjsgen").generate,parse=require("regjsparser").parse,regenerate=require("regenerate"),unicodeMatchProperty=require("unicode-match-property-ecmascript"),unicodeMatchPropertyValue=require("unicode-match-property-value-ecmascript"),iuMappings=require("./data/iu-mappings.js"),iBMPMappings=require("./data/i-bmp-mappings.js"),iuFoldings=require("./data/iu-foldings.js"),ESCAPE_SETS=require("./data/character-class-escape-sets.js"),{UNICODE_SET:UNICODE_SET,UNICODE_IV_SET:UNICODE_IV_SET}=require("./data/all-characters.js");function flatMap(e,n){const r=[];return e.forEach(e=>{const a=n(e);Array.isArray(a)?r.push.apply(r,a):r.push(a)}),r}function regenerateContainsAstral(e){const n=e.data;return n.length>=1&&n[n.length-1]>=65536}const SYNTAX_CHARS=/[\\^$.*+?()[\]{}|]/g,ASTRAL_SET=regenerate().addRange(65536,1114111),NEWLINE_SET=regenerate().add(10,13,8232,8233),DOT_SET_UNICODE=UNICODE_SET.clone().remove(NEWLINE_SET),getCharacterClassEscapeSet=(e,n,r,a)=>{if(n){if(r){const n=ESCAPE_SETS.UNICODE_IGNORE_CASE.get(e);return a?ESCAPE_SETS.UNICODESET_IGNORE_CASE.get(e):n}return ESCAPE_SETS.UNICODE.get(e)}return ESCAPE_SETS.REGULAR.get(e)},getUnicodeDotSet=e=>e?UNICODE_SET:DOT_SET_UNICODE,getUnicodePropertyValueSet=(e,n)=>{const r=n?`${e}/${n}`:`Binary_Property/${e}`;try{return require(`regenerate-unicode-properties/${r}.js`)}catch(r){throw new Error(`Failed to recognize value \`${n}\` for property \`${e}\`.`)}},handleLoneUnicodePropertyNameOrValue=e=>{try{const n="General_Category",r=unicodeMatchPropertyValue(n,e);return getUnicodePropertyValueSet(n,r)}catch(e){}try{return getUnicodePropertyValueSet("Property_of_Strings",e)}catch(e){}const n=unicodeMatchProperty(e);return getUnicodePropertyValueSet(n)},getUnicodePropertyEscapeSet=(e,n,r)=>{const a=e.split("="),s=a[0];let t;if(1==a.length)t=handleLoneUnicodePropertyNameOrValue(s);else{const e=unicodeMatchProperty(s),n=unicodeMatchPropertyValue(e,a[1]);t=getUnicodePropertyValueSet(e,n)}if(n){if(t.strings)throw new Error("Cannot negate Unicode property of strings");return{characters:(r?UNICODE_IV_SET:UNICODE_SET).clone().remove(t.characters),strings:new Set}}return{characters:t.characters.clone(),strings:t.strings?new Set(t.strings.map(e=>e.replace(SYNTAX_CHARS,"\\$&"))):new Set}},getUnicodePropertyEscapeCharacterClassData=(e,n,r,a)=>{const s=getUnicodePropertyEscapeSet(e,n,r),t=getCharacterClassEmptyData(),o=a?regenerate(s.characters.toArray().map(e=>simpleCaseFolding(e))):s.characters,i=configGetCaseEqFlags();if(i)for(const e of o.toArray()){const n=getCaseEquivalents(e,i);n&&o.add(n)}return t.singleChars=o,s.strings.size>0&&(t.longStrings=s.strings,t.maybeIncludesStrings=!0),t},CASE_EQ_FLAG_NONE=0,CASE_EQ_FLAG_BMP=1,CASE_EQ_FLAG_UNICODE=2;function configGetCaseEqFlags(){let e=CASE_EQ_FLAG_NONE;return!0===config.modifiersData.i?config.transform.modifiers&&(e|=CASE_EQ_FLAG_BMP,(config.flags.unicode||config.flags.unicodeSets)&&(e|=CASE_EQ_FLAG_UNICODE)):void 0===config.modifiersData.i&&config.transform.unicodeFlag&&config.flags.ignoreCase&&(e|=CASE_EQ_FLAG_UNICODE),e}regenerate.prototype.iuAddRange=function(e,n,r){const a=this;do{const n=getCaseEquivalents(e,r);n&&a.add(n)}while(++e<=n);return a},regenerate.prototype.iuRemoveRange=function(e,n,r){const a=this;do{const n=getCaseEquivalents(e,r);n&&a.remove(n)}while(++e<=n);return a};const update=(e,n)=>{let r=parse(n,config.useUnicodeFlag?"u":"",{lookbehind:!0,namedGroups:!0,unicodePropertyEscape:!0,unicodeSet:!0,modifiers:!0});switch(r.type){case"characterClass":case"group":case"value":break;default:r=wrap(r,n)}Object.assign(e,r)},wrap=(e,n)=>({type:"group",behavior:"ignore",body:[e],raw:`(?:${n})`}),getCaseEquivalents=(e,n)=>{if(n===CASE_EQ_FLAG_NONE)return!1;let r=(n&CASE_EQ_FLAG_UNICODE?iuMappings.get(e):void 0)||[];if("number"==typeof r&&(r=[r]),n&CASE_EQ_FLAG_BMP)for(const n of[e].concat(r))n>=65&&n<=90?r.push(n+32):n>=97&&n<=122?r.push(n-32):r=r.concat(iBMPMappings.get(n)||[]);return 0!=r.length&&r},simpleCaseFolding=e=>e<=127?e>=65&&e<=90?e+32:e:iuFoldings.get(e)||e,buildHandler=e=>{switch(e){case"union":return{single:(e,n)=>{e.singleChars.add(n)},regSet:(e,n)=>{e.singleChars.add(n)},range:(e,n,r)=>{e.singleChars.addRange(n,r)},iuRange:(e,n,r,a)=>{e.singleChars.iuAddRange(n,r,a)},nested:(e,n)=>{e.singleChars.add(n.singleChars);for(const r of n.longStrings)e.longStrings.add(r);n.maybeIncludesStrings&&(e.maybeIncludesStrings=!0)}};case"union-negative":{const e=(e,n)=>{e.singleChars=UNICODE_SET.clone().remove(n).add(e.singleChars)};return{single:(e,n)=>{const r=UNICODE_SET.clone();e.singleChars=e.singleChars.contains(n)?r:r.remove(n)},regSet:e,range:(e,n,r)=>{e.singleChars=UNICODE_SET.clone().removeRange(n,r).add(e.singleChars)},iuRange:(e,n,r,a)=>{e.singleChars=UNICODE_SET.clone().iuRemoveRange(n,r,a).add(e.singleChars)},nested:(n,r)=>{if(e(n,r.singleChars),r.maybeIncludesStrings)throw new Error("ASSERTION ERROR")}}}case"intersection":{const e=(e,n)=>{e.first?e.singleChars=n:e.singleChars.intersection(n)};return{single:(e,n)=>{e.singleChars=e.first||e.singleChars.contains(n)?regenerate(n):regenerate(),e.longStrings.clear(),e.maybeIncludesStrings=!1},regSet:(n,r)=>{e(n,r),n.longStrings.clear(),n.maybeIncludesStrings=!1},range:(e,n,r)=>{e.first?e.singleChars.addRange(n,r):e.singleChars.intersection(regenerate().addRange(n,r)),e.longStrings.clear(),e.maybeIncludesStrings=!1},iuRange:(e,n,r,a)=>{e.first?e.singleChars.iuAddRange(n,r,a):e.singleChars.intersection(regenerate().iuAddRange(n,r,a)),e.longStrings.clear(),e.maybeIncludesStrings=!1},nested:(n,r)=>{if(e(n,r.singleChars),n.first)n.longStrings=r.longStrings,n.maybeIncludesStrings=r.maybeIncludesStrings;else{for(const e of n.longStrings)r.longStrings.has(e)||n.longStrings.delete(e);r.maybeIncludesStrings||(n.maybeIncludesStrings=!1)}}}}case"subtraction":{const e=(e,n)=>{e.first?e.singleChars.add(n):e.singleChars.remove(n)};return{single:(e,n)=>{e.first?e.singleChars.add(n):e.singleChars.remove(n)},regSet:e,range:(e,n,r)=>{e.first?e.singleChars.addRange(n,r):e.singleChars.removeRange(n,r)},iuRange:(e,n,r,a)=>{e.first?e.singleChars.iuAddRange(n,r,a):e.singleChars.iuRemoveRange(n,r,a)},nested:(n,r)=>{if(e(n,r.singleChars),n.first)n.longStrings=r.longStrings,n.maybeIncludesStrings=r.maybeIncludesStrings;else for(const e of n.longStrings)r.longStrings.has(e)&&n.longStrings.delete(e)}}}default:throw new Error(`Unknown set action: ${characterClassItem.kind}`)}},getCharacterClassEmptyData=()=>({transformed:config.transform.unicodeFlag,singleChars:regenerate(),longStrings:new Set,hasEmptyString:!1,first:!0,maybeIncludesStrings:!1}),concatCaseEquivalents=(e,n)=>{const r=getCaseEquivalents(e,n);return r?[e,...r]:[e]},computeClassStrings=(e,n,r,a)=>{let s=getCharacterClassEmptyData();for(const t of e.strings)if(1===t.characters.length){const e=a?simpleCaseFolding(t.characters[0].codePoint):t.characters[0].codePoint;concatCaseEquivalents(e,r).forEach(e=>{s.singleChars.add(e)})}else{let e="";if(r)for(const s of t.characters){const t=a?simpleCaseFolding(s.codePoint):s.codePoint;e+=regenerate(concatCaseEquivalents(t,r)).toString(n)}else for(const r of t.characters){const s=a?simpleCaseFolding(r.codePoint):r.codePoint;s!==r.codePoint?e+=regenerate(s).toString(n):e+=generate(r)}s.longStrings.add(e),s.maybeIncludesStrings=!0}return s},computeCharacterClass=(e,n,r)=>{let a,s,t=getCharacterClassEmptyData(),o=configGetCaseEqFlags();switch(e.kind){case"union":a=buildHandler("union"),s=buildHandler("union-negative");break;case"intersection":a=buildHandler("intersection"),s=buildHandler("subtraction"),config.transform.unicodeSetsFlag&&(t.transformed=!0),config.isIgnoreCaseMode&&(r=!0);break;case"subtraction":a=buildHandler("subtraction"),s=buildHandler("intersection"),config.transform.unicodeSetsFlag&&(t.transformed=!0),config.isIgnoreCaseMode&&(r=!0);break;default:throw new Error(`Unknown character class kind: ${e.kind}`)}for(const i of e.body){switch(i.type){case"value":const c=r?simpleCaseFolding(i.codePoint):i.codePoint,g=concatCaseEquivalents(c,o);a.regSet(t,regenerate(g)),g.length>1&&(t.transformed=!0);break;case"characterClassRange":const l=i.min.codePoint,d=i.max.codePoint;if(r){let e=[];for(let n=l;n<=d;n++)e.push(simpleCaseFolding(n));a.regSet(t,regenerate(e))}else a.range(t,l,d);o&&(a.iuRange(t,l,d,o),t.transformed=!0);break;case"characterClassEscape":a.regSet(t,getCharacterClassEscapeSet(i.value,config.flags.unicode||config.flags.unicodeSets,config.flags.ignoreCase,r));break;case"unicodePropertyEscape":const f=getUnicodePropertyEscapeCharacterClassData(i.value,i.negative,config.flags.unicodeSets&&config.isIgnoreCaseMode,r);a.nested(t,f),t.transformed=t.transformed||config.transform.unicodePropertyEscapes||config.transform.unicodeSetsFlag&&(f.maybeIncludesStrings||"union"!==e.kind||i.negative);break;case"characterClass":const u=i.negative?s:a,m=computeCharacterClass(i,n,r);u.nested(t,m),t.transformed=!0;break;case"classStrings":a.nested(t,computeClassStrings(i,n,o,r)),t.transformed=!0;break;default:throw new Error(`Unknown term type: ${i.type}`)}t.first=!1}if(e.negative&&t.maybeIncludesStrings)throw new SyntaxError("Cannot negate set containing strings");return t},processCharacterClass=(e,n,r=computeCharacterClass(e,n))=>{const a=e.negative,{singleChars:s,transformed:t,longStrings:o}=r;if(t){const r=regenerateContainsAstral(s),t=s.toString(Object.assign({},n,{bmpOnly:r}));if(a)if(config.useUnicodeFlag)update(e,`[^${"["===t[0]?t.slice(1,-1):t}]`);else if(config.flags.unicode||config.flags.unicodeSets)if(config.flags.ignoreCase){const r=s.clone().intersection(ASTRAL_SET),a=s.clone().remove(r).addRange(55296,57343).toString({bmpOnly:!0}),t=ASTRAL_SET.clone().remove(r).toString(n);update(e,`(?!${a})[^]|${t}`)}else{const r=UNICODE_SET.clone().remove(s);update(e,r.toString(n))}else update(e,`(?!${t})[^]`);else{const n=o.has(""),r=Array.from(o).sort((e,n)=>n.length-e.length);"[]"===t&&0!==o.size||r.splice(r.length-(n?1:0),0,t),update(e,r.join("|"))}}return e},assertNoUnmatchedReferences=e=>{const n=Object.keys(e.unmatchedReferences);if(n.length>0)throw new Error(`Unknown group names: ${n}`)},processModifiers=(e,n,r)=>{const a=e.modifierFlags.enabling,s=e.modifierFlags.disabling,t=Object.assign({},config.modifiersData);for(const e of a)config.modifiersData[e]=!0;for(const e of s)config.modifiersData[e]=!1;return config.transform.modifiers&&(delete e.modifierFlags,e.behavior="ignore"),e.body=e.body.map(e=>processTerm(e,n,r)),config.modifiersData=t,e},processTerm=(e,n,r)=>{switch(e.type){case"dot":config.transform.unicodeFlag?update(e,getUnicodeDotSet(config.isDotAllMode).toString(n)):(null!=config.modifiersData.s?config.modifiersData.s&&config.transform.modifiers:config.transform.dotAllFlag)&&update(e,"[^]");break;case"characterClass":e=processCharacterClass(e,n);break;case"unicodePropertyEscape":const a=getUnicodePropertyEscapeCharacterClassData(e.value,e.negative,config.flags.unicodeSets&&config.isIgnoreCaseMode);if(a.maybeIncludesStrings){if(!config.flags.unicodeSets)throw new Error("Properties of strings are only supported when using the unicodeSets (v) flag.");config.transform.unicodeSetsFlag&&(a.transformed=!0,e=processCharacterClass(e,n,a))}else(config.transform.unicodePropertyEscapes||configGetCaseEqFlags())&&update(e,a.singleChars.toString(n));break;case"characterClassEscape":config.transform.unicodeFlag&&update(e,getCharacterClassEscapeSet(e.value,!0,config.flags.ignoreCase).toString(n));break;case"group":if("normal"==e.behavior&&r.lastIndex++,e.name){const n=e.name.value;if(r.namesConflicts[n])throw new Error(`Group '${n}' has already been defined in this context.`);r.namesConflicts[n]=!0,config.transform.namedGroups&&delete e.name;const a=r.lastIndex;r.names[n]||(r.names[n]=[]),r.names[n].push(a),r.onNamedGroup&&r.onNamedGroup.call(null,n,a),r.unmatchedReferences[n]&&delete r.unmatchedReferences[n]}if(e.modifierFlags)return processModifiers(e,n,r);case"quantifier":e.body=e.body.map(e=>processTerm(e,n,r));break;case"disjunction":const s=r.namesConflicts;e.body=e.body.map(e=>(r.namesConflicts=Object.create(s),processTerm(e,n,r)));break;case"alternative":e.body=flatMap(e.body,e=>{const a=processTerm(e,n,r);return"alternative"===a.type?a.body:a});break;case"value":const t=e.codePoint,o=configGetCaseEqFlags(),i=concatCaseEquivalents(t,o);if(1===i.length&&"symbol"===e.kind&&t>=32&&t<=126)break;const c=regenerate(i);update(e,c.toString(n));break;case"reference":if(e.name){const n=e.name.value,a=r.names[n];if(a||(r.unmatchedReferences[n]=!0),config.transform.namedGroups){if(a){const e=a.map(e=>({type:"reference",matchIndex:e,raw:"\\"+e}));return 1===e.length?e[0]:{type:"alternative",body:e,raw:e.map(e=>e.raw).join("")}}return{type:"group",behavior:"ignore",body:[],raw:"(?:)"}}}break;case"anchor":config.modifiersData.m&&config.transform.modifiers&&("start"==e.kind?update(e,`(?:^|(?<=${NEWLINE_SET.toString()}))`):"end"==e.kind&&update(e,`(?:$|(?=${NEWLINE_SET.toString()}))`));case"empty":break;default:throw new Error(`Unknown term type: ${e.type}`)}return e},config={flags:{ignoreCase:!1,unicode:!1,unicodeSets:!1,dotAll:!1,multiline:!1},transform:{dotAllFlag:!1,unicodeFlag:!1,unicodeSetsFlag:!1,unicodePropertyEscapes:!1,namedGroups:!1,modifiers:!1},modifiersData:{i:void 0,s:void 0,m:void 0},get useUnicodeFlag(){return(this.flags.unicode||this.flags.unicodeSets)&&!this.transform.unicodeFlag},get isDotAllMode(){return void 0!==this.modifiersData.s?this.modifiersData.s:this.flags.dotAll},get isIgnoreCaseMode(){return void 0!==this.modifiersData.i?this.modifiersData.i:this.flags.ignoreCase}},validateOptions=e=>{if(e)for(const n of Object.keys(e)){const r=e[n];switch(n){case"dotAllFlag":case"unicodeFlag":case"unicodePropertyEscapes":case"unicodeSetsFlag":case"namedGroups":if(null!=r&&!1!==r&&"transform"!==r)throw new Error(`.${n} must be false (default) or 'transform'.`);break;case"modifiers":if(null!=r&&!1!==r&&"parse"!==r&&"transform"!==r)throw new Error(`.${n} must be false (default), 'parse' or 'transform'.`);break;case"onNamedGroup":case"onNewFlags":if(null!=r&&"function"!=typeof r)throw new Error(`.${n} must be a function.`);break;default:throw new Error(`.${n} is not a valid regexpu-core option.`)}}},hasFlag=(e,n)=>!!e&&e.includes(n),transform=(e,n)=>!!e&&"transform"===e[n],rewritePattern=(e,n,r)=>{validateOptions(r),config.flags.unicode=hasFlag(n,"u"),config.flags.unicodeSets=hasFlag(n,"v"),config.flags.ignoreCase=hasFlag(n,"i"),config.flags.dotAll=hasFlag(n,"s"),config.flags.multiline=hasFlag(n,"m"),config.transform.dotAllFlag=config.flags.dotAll&&transform(r,"dotAllFlag"),config.transform.unicodeFlag=(config.flags.unicode||config.flags.unicodeSets)&&transform(r,"unicodeFlag"),config.transform.unicodeSetsFlag=config.flags.unicodeSets&&transform(r,"unicodeSetsFlag"),config.transform.unicodePropertyEscapes=(config.flags.unicode||config.flags.unicodeSets)&&(transform(r,"unicodeFlag")||transform(r,"unicodePropertyEscapes")),config.transform.namedGroups=transform(r,"namedGroups"),config.transform.modifiers=transform(r,"modifiers"),config.modifiersData.i=void 0,config.modifiersData.s=void 0,config.modifiersData.m=void 0;const a={hasUnicodeFlag:config.useUnicodeFlag,bmpOnly:!config.flags.unicode&&!config.flags.unicodeSets},s={onNamedGroup:r&&r.onNamedGroup,lastIndex:0,names:Object.create(null),namesConflicts:Object.create(null),unmatchedReferences:Object.create(null)},t=parse(e,n,{modifiers:!0,unicodePropertyEscape:!0,unicodeSet:!0,namedGroups:!0,lookbehind:!0});if(config.transform.modifiers&&/\(\?[a-z]*-[a-z]+:/.test(e)){const e=Object.create(null),n=[t];let r;for(;r=n.pop(),null!=r;)if(Array.isArray(r))Array.prototype.push.apply(n,r);else if("object"==typeof r&&null!=r)for(const a of Object.keys(r)){const s=r[a];if("modifierFlags"==a)for(const n of s.disabling)e[n]=!0;else"object"==typeof s&&null!=s&&n.push(s)}e.i&&(config.modifiersData.i=config.flags.ignoreCase),e.m&&(config.modifiersData.m=config.flags.multiline),e.s&&(config.modifiersData.s=config.flags.dotAll)}processTerm(t,a,s),assertNoUnmatchedReferences(s);const o=r&&r.onNewFlags;if(o){let e=n.split("").filter(e=>!config.modifiersData[e]).join("");config.transform.unicodeSetsFlag&&(e=e.replace("v","u")),config.transform.unicodeFlag&&(e=e.replace("u","")),config.transform.dotAllFlag&&(e=e.replace("s","")),o(e)}return generate(t)};module.exports=rewritePattern;