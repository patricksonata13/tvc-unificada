import{ignoreOverride}from"./Options.js";import{selectParser}from"./selectParser.js";import{getRelativePath}from"./getRelativePath.js";import{parseAnyDef}from"./parsers/any.js";export function parseDef(e,r,t=!1){const n=r.seen.get(e);if(r.override){const s=r.override?.(e,r,n,t);if(s!==ignoreOverride)return s}if(n&&!t){const e=get$ref(n,r);if(void 0!==e)return e}const s={def:e,path:r.currentPath,jsonSchema:void 0};r.seen.set(e,s);const o=selectParser(e,e.typeName,r),a="function"==typeof o?parseDef(o(),r):o;if(a&&addMeta(e,r,a),r.postProcess){const t=r.postProcess(a,e,r);return s.jsonSchema=a,t}return s.jsonSchema=a,a}const get$ref=(e,r)=>{switch(r.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:getRelativePath(r.currentPath,e.path)};case"none":case"seen":return e.path.length<r.currentPath.length&&e.path.every((e,t)=>r.currentPath[t]===e)?(console.warn(`Recursive reference detected at ${r.currentPath.join("/")}! Defaulting to any`),parseAnyDef(r)):"seen"===r.$refStrategy?parseAnyDef(r):void 0}},addMeta=(e,r,t)=>(e.description&&(t.description=e.description,r.markdownDescription&&(t.markdownDescription=e.description)),t);