Object.defineProperty(exports,"__esModule",{value:!0});var graphql_web=require("@0no-co/graphql.web"),urqlCoreInternal=require("./urql-core-chunk.js"),wonka=require("wonka"),collectTypes=(e,r)=>{if(Array.isArray(e))for(var t=0,n=e.length;t<n;t++)collectTypes(e[t],r);else if("object"==typeof e&&null!==e)for(var a in e)"__typename"===a&&"string"==typeof e[a]?r.add(e[a]):collectTypes(e[a],r);return r},collectTypenames=e=>[...collectTypes(e,new Set)],formatNode=e=>{if("definitions"in e){for(var r=[],t=0,n=e.definitions.length;t<n;t++){var a=formatNode(e.definitions[t]);r.push(a)}return{...e,definitions:r}}if("directives"in e&&e.directives&&e.directives.length){for(var o=[],i={},s=0,c=e.directives.length;s<c;s++){var u=e.directives[s],l=u.name.value;"_"!==l[0]?o.push(u):l=l.slice(1),i[l]=u}e={...e,directives:o,_directives:i}}if("selectionSet"in e){var p=[],d=e.kind===graphql_web.Kind.OPERATION_DEFINITION;if(e.selectionSet){for(var k=0,h=e.selectionSet.selections.length;k<h;k++){var m=e.selectionSet.selections[k];d=d||m.kind===graphql_web.Kind.FIELD&&"__typename"===m.name.value&&!m.alias;var f=formatNode(m);p.push(f)}return d||p.push({kind:graphql_web.Kind.FIELD,name:{kind:graphql_web.Kind.NAME,value:"__typename"},_generated:!0}),{...e,selectionSet:{...e.selectionSet,selections:p}}}}return e},formattedDocs=new Map,formatDocument=e=>{var r=urqlCoreInternal.keyDocument(e),t=formattedDocs.get(r.__key);return t||(formattedDocs.set(r.__key,t=formatNode(r)),Object.defineProperty(t,"__key",{value:r.__key,enumerable:!1})),t};function withPromise(e){var r=r=>e(r);return r.toPromise=()=>wonka.toPromise(wonka.take(1)(wonka.filter(e=>!e.stale&&!e.hasNext)(r))),r.then=(e,t)=>r.toPromise().then(e,t),r.subscribe=e=>wonka.subscribe(e)(r),r}function makeOperation(e,r,t){return{...r,kind:e,context:r.context?{...r.context,...t}:t||r.context}}var addMetadata=(e,r)=>makeOperation(e.kind,e,{meta:{...e.context.meta,...r}}),noop=()=>{};function gql(e){for(var r=new Map,t=[],n=[],a=Array.isArray(e)?e[0]:e||"",o=1;o<arguments.length;o++){var i=arguments[o];i&&i.definitions?n.push(i):a+=i,a+=arguments[0][o]}n.unshift(urqlCoreInternal.keyDocument(a));for(var s=0;s<n.length;s++)for(var c=0;c<n[s].definitions.length;c++){var u=n[s].definitions[c];if(u.kind===graphql_web.Kind.FRAGMENT_DEFINITION){var l=u.name.value,p=urqlCoreInternal.stringifyDocument(u);r.has(l)?"production"!==process.env.NODE_ENV&&r.get(l)!==p&&console.warn("[WARNING: Duplicate Fragment] A fragment with name `"+l+"` already exists in this document.\nWhile fragment names may not be unique across your source, each name must be unique per document."):(r.set(l,p),t.push(u))}else t.push(u)}return urqlCoreInternal.keyDocument({kind:graphql_web.Kind.DOCUMENT,definitions:t})}var shouldSkip=({kind:e})=>"mutation"!==e&&"query"!==e,mapTypeNames=e=>{var r=formatDocument(e.query);if(r!==e.query){var t=makeOperation(e.kind,e);return t.query=r,t}return e},cacheExchange=({forward:e,client:r,dispatchDebug:t})=>{var n=new Map,a=new Map,o=e=>"query"===e.kind&&"network-only"!==e.context.requestPolicy&&("cache-only"===e.context.requestPolicy||n.has(e.key));return i=>{var s=wonka.map(e=>{var a=n.get(e.key);"production"!==process.env.NODE_ENV&&t({operation:e,...a?{type:"cacheHit",message:"The result was successfully retrieved from the cache"}:{type:"cacheMiss",message:"The result could not be retrieved from the cache"},source:"cacheExchange"});var o=a||urqlCoreInternal.makeResult(e,{data:null});return o={...o,operation:addMetadata(e,{cacheOutcome:a?"hit":"miss"})},"cache-and-network"===e.context.requestPolicy&&(o.stale=!0,reexecuteOperation(r,e)),o})(wonka.filter(e=>!shouldSkip(e)&&o(e))(i)),c=wonka.tap(e=>{var{operation:o}=e;if(o){var i=o.context.additionalTypenames||[];if("subscription"!==e.operation.kind&&(i=collectTypenames(e.data).concat(i)),"mutation"===e.operation.kind||"subscription"===e.operation.kind){var s=new Set;"production"!==process.env.NODE_ENV&&t({type:"cacheInvalidation",message:`The following typenames have been invalidated: ${i}`,operation:o,data:{typenames:i,response:e},source:"cacheExchange"});for(var c=0;c<i.length;c++){var u=i[c],l=a.get(u);for(var p of(l||a.set(u,l=new Set),l.values()))s.add(p);l.clear()}for(var d of s.values())n.has(d)&&(o=n.get(d).operation,n.delete(d),reexecuteOperation(r,o))}else if("query"===o.kind&&e.data){n.set(o.key,e);for(var k=0;k<i.length;k++){var h=i[k],m=a.get(h);m||a.set(h,m=new Set),m.add(o.key)}}}})(e(wonka.filter(e=>"query"!==e.kind||"cache-only"!==e.context.requestPolicy)(wonka.map(e=>addMetadata(e,{cacheOutcome:"miss"}))(wonka.merge([wonka.map(mapTypeNames)(wonka.filter(e=>!shouldSkip(e)&&!o(e))(i)),wonka.filter(e=>shouldSkip(e))(i)])))));return wonka.merge([s,c])}},reexecuteOperation=(e,r)=>e.reexecuteOperation(makeOperation(r.kind,r,{requestPolicy:"network-only"})),serializeResult=(e,r)=>{var t={hasNext:e.hasNext};return void 0!==e.data&&(t.data=JSON.stringify(e.data)),r&&void 0!==e.extensions&&(t.extensions=JSON.stringify(e.extensions)),e.error&&(t.error={graphQLErrors:e.error.graphQLErrors.map(e=>e.path||e.extensions?{message:e.message,path:e.path,extensions:e.extensions}:e.message)},e.error.networkError&&(t.error.networkError=""+e.error.networkError)),t},deserializeResult=(e,r,t)=>({operation:e,data:r.data?JSON.parse(r.data):void 0,extensions:t&&r.extensions?JSON.parse(r.extensions):void 0,error:r.error?new urqlCoreInternal.CombinedError({networkError:r.error.networkError?new Error(r.error.networkError):void 0,graphQLErrors:r.error.graphQLErrors}):void 0,stale:!1,hasNext:!!r.hasNext}),revalidated=new Set,ssrExchange=(e={})=>{var r=!!e.staleWhileRevalidate,t=!!e.includeExtensions,n={},a=[],o=e=>{a.push(e.operation.key),1===a.length&&Promise.resolve().then(()=>{for(var e;e=a.shift();)n[e]=null})},i=({client:a,forward:i})=>s=>{var c=e&&"boolean"==typeof e.isClient?!!e.isClient:!a.suspense,u=i(wonka.map(mapTypeNames)(wonka.filter(e=>"teardown"===e.kind||!n[e.key]||!!n[e.key].hasNext||"network-only"===e.context.requestPolicy)(s))),l=wonka.map(e=>{var o=n[e.key],i=deserializeResult(e,o,t);return r&&!revalidated.has(e.key)&&(i.stale=!0,revalidated.add(e.key),reexecuteOperation(a,e)),{...i,operation:addMetadata(e,{cacheOutcome:"hit"})}})(wonka.filter(e=>"teardown"!==e.kind&&!!n[e.key]&&"network-only"!==e.context.requestPolicy)(s));return c?l=wonka.tap(o)(l):u=wonka.tap(e=>{var{operation:r}=e;if("mutation"!==r.kind){var a=serializeResult(e,t);n[r.key]=a}})(u),wonka.merge([u,l])};return i.restoreData=e=>{for(var r in e)null!==n[r]&&(n[r]=e[r])},i.extractData=()=>{var e={};for(var r in n)null!=n[r]&&(e[r]=n[r]);return e},e&&e.initialState&&i.restoreData(e.initialState),i},subscriptionExchange=({forwardSubscription:e,enableAllOperations:r,isSubscriptionOperation:t})=>({client:n,forward:a})=>{var o=t||(e=>"subscription"===e.kind||!!r&&("query"===e.kind||"mutation"===e.kind));return r=>{var t=wonka.mergeMap(t=>{var{key:a}=t,o=wonka.filter(e=>"teardown"===e.kind&&e.key===a)(r);return wonka.takeUntil(o)((r=>{var t=e(urqlCoreInternal.makeFetchBody(r),r);return wonka.make(e=>{var a,o,i=!1;function s(t){e.next(o=o?urqlCoreInternal.mergeResultPatch(o,t):urqlCoreInternal.makeResult(r,t))}return Promise.resolve().then(()=>{i||(a=t.subscribe({next:s,error(t){Array.isArray(t)?s({errors:t}):e.next(urqlCoreInternal.makeErrorResult(r,t)),e.complete()},complete(){i||(i=!0,"subscription"===r.kind&&n.reexecuteOperation(makeOperation("teardown",r,r.context)),o&&o.hasNext&&s({hasNext:!1}),e.complete())}}))}),()=>{i=!0,a&&a.unsubscribe()}})})(t))})(wonka.filter(e=>"teardown"!==e.kind&&o(e))(r)),i=a(wonka.filter(e=>"teardown"===e.kind||!o(e))(r));return wonka.merge([t,i])}},debugExchange=({forward:e})=>"production"===process.env.NODE_ENV?r=>e(r):r=>wonka.tap(e=>console.debug("[Exchange debug]: Completed operation: ",e))(e(wonka.tap(e=>console.debug("[Exchange debug]: Incoming operation: ",e))(r))),fetchExchange=({forward:e,dispatchDebug:r})=>t=>{var n=wonka.mergeMap(e=>{var n=urqlCoreInternal.makeFetchBody(e),a=urqlCoreInternal.makeFetchURL(e,n),o=urqlCoreInternal.makeFetchOptions(e,n);"production"!==process.env.NODE_ENV&&r({type:"fetchRequest",message:"A fetch request is being executed.",operation:e,data:{url:a,fetchOptions:o},source:"fetchExchange"});var i=wonka.takeUntil(wonka.filter(r=>"teardown"===r.kind&&r.key===e.key)(t))(urqlCoreInternal.makeFetchSource(e,a,o));return"production"!==process.env.NODE_ENV?wonka.onPush(t=>{var n=t.data?void 0:t.error;"production"!==process.env.NODE_ENV&&r({type:n?"fetchError":"fetchSuccess",message:`A ${n?"failed":"successful"} fetch response has been returned.`,operation:e,data:{url:a,fetchOptions:o,value:n||t},source:"fetchExchange"})})(i):i})(wonka.filter(e=>"teardown"!==e.kind&&("subscription"!==e.kind||!!e.context.fetchSubscriptions))(t)),a=e(wonka.filter(e=>"teardown"===e.kind||"subscription"===e.kind&&!e.context.fetchSubscriptions)(t));return wonka.merge([n,a])},composeExchanges=e=>({client:r,forward:t,dispatchDebug:n})=>e.reduceRight((e,t)=>{var a=!1;return t({client:r,forward(r){if("production"!==process.env.NODE_ENV){if(a)throw new Error("forward() must only be called once in each Exchange.");a=!0}return wonka.share(e(wonka.share(r)))},dispatchDebug(e){"production"!==process.env.NODE_ENV&&n({timestamp:Date.now(),source:t.name,...e})}})},t),mapExchange=({onOperation:e,onResult:r,onError:t})=>({forward:n})=>a=>wonka.mergeMap(e=>{t&&e.error&&t(e.error,e.operation);var n=r&&r(e)||e;return"then"in n?wonka.fromPromise(n):wonka.fromValue(n)})(n(wonka.mergeMap(r=>{var t=e&&e(r)||r;return"then"in t?wonka.fromPromise(t):wonka.fromValue(t)})(a))),fallbackExchange=({dispatchDebug:e})=>r=>("production"!==process.env.NODE_ENV&&(r=wonka.tap(r=>{if("teardown"!==r.kind&&"production"!==process.env.NODE_ENV){var t=`No exchange has handled operations of kind "${r.kind}". Check whether you've added an exchange responsible for these operations.`;"production"!==process.env.NODE_ENV&&e({type:"fallbackCatch",message:t,operation:r,source:"fallbackExchange"}),console.warn(t)}})(r)),wonka.filter(e=>!1)(r)),Client=function e(r){if("production"!==process.env.NODE_ENV&&!r.url)throw new Error("You are creating an urql-client without a url.");var t=0,n=new Map,a=new Map,o=new Set,i=[],s={url:r.url,fetchSubscriptions:r.fetchSubscriptions,fetchOptions:r.fetchOptions,fetch:r.fetch,preferGetMethod:r.preferGetMethod,requestPolicy:r.requestPolicy||"cache-first"},c=wonka.makeSubject();function u(e){"mutation"!==e.kind&&"teardown"!==e.kind&&o.has(e.key)||("teardown"===e.kind?o.delete(e.key):"mutation"!==e.kind&&o.add(e.key),c.next(e))}var l=!1;function p(e){if(e&&u(e),!l){for(l=!0;l&&(e=i.shift());)u(e);l=!1}}var d=e=>{var r=wonka.takeUntil(wonka.filter(r=>"teardown"===r.kind&&r.key===e.key)(c.source))(wonka.filter(r=>r.operation.kind===e.kind&&r.operation.key===e.key&&(!r.operation.context._instance||r.operation.context._instance===e.context._instance))(g));return r="query"!==e.kind?wonka.takeWhile(e=>!!e.hasNext,!0)(r):wonka.switchMap(r=>{var t=wonka.fromValue(r);return r.stale||r.hasNext?t:wonka.merge([t,wonka.map(()=>(r.stale=!0,r))(wonka.take(1)(wonka.filter(r=>r.key===e.key)(c.source)))])})(r),r="mutation"!==e.kind?wonka.onEnd(()=>{o.delete(e.key),n.delete(e.key),a.delete(e.key),l=!1;for(var r=i.length-1;r>=0;r--)i[r].key===e.key&&i.splice(r,1);u(makeOperation("teardown",e,e.context))})(wonka.onPush(r=>{if(r.stale)if(r.hasNext)for(var t=0;t<i.length;t++){var a=i[t];if(a.key===r.operation.key){o.delete(a.key);break}}else o.delete(e.key);else r.hasNext||o.delete(e.key);n.set(e.key,r)})(r)):wonka.onStart(()=>{u(e)})(r),wonka.share(r)},k=this instanceof e?this:Object.create(e.prototype),h=Object.assign(k,{suspense:!!r.suspense,operations$:c.source,reexecuteOperation(e){if("teardown"===e.kind)p(e);else if("mutation"===e.kind)i.push(e),Promise.resolve().then(p);else if(a.has(e.key)){for(var r=!1,t=0;t<i.length;t++)i[t].key===e.key&&(i[t]=e,r=!0);r||o.has(e.key)&&"network-only"!==e.context.requestPolicy?(o.delete(e.key),Promise.resolve().then(p)):(i.push(e),Promise.resolve().then(p))}},createRequestOperation(e,r,n){var a;if(n||(n={}),"production"!==process.env.NODE_ENV&&"teardown"!==e&&(a=urqlCoreInternal.getOperationType(r.query))!==e)throw new Error(`Expected operation of type "${e}" but found "${a}"`);return makeOperation(e,r,{_instance:"mutation"===e?t=t+1|0:void 0,...s,...n,requestPolicy:n.requestPolicy||s.requestPolicy,suspense:n.suspense||!1!==n.suspense&&h.suspense})},executeRequestOperation:e=>"mutation"===e.kind?withPromise(d(e)):withPromise(wonka.lazy(()=>{var r=a.get(e.key);r||a.set(e.key,r=d(e)),r=wonka.onStart(()=>{p(e)})(r);var t=n.get(e.key);return"query"===e.kind&&t&&(t.stale||t.hasNext)?wonka.switchMap(wonka.fromValue)(wonka.merge([r,wonka.filter(r=>r===n.get(e.key))(wonka.fromValue(t))])):r})),executeQuery(e,r){var t=h.createRequestOperation("query",e,r);return h.executeRequestOperation(t)},executeSubscription(e,r){var t=h.createRequestOperation("subscription",e,r);return h.executeRequestOperation(t)},executeMutation(e,r){var t=h.createRequestOperation("mutation",e,r);return h.executeRequestOperation(t)},readQuery(e,r,t){var n=null;return wonka.subscribe(e=>{n=e})(h.query(e,r,t)).unsubscribe(),n},query:(e,r,t)=>h.executeQuery(urqlCoreInternal.createRequest(e,r),t),subscription:(e,r,t)=>h.executeSubscription(urqlCoreInternal.createRequest(e,r),t),mutation:(e,r,t)=>h.executeMutation(urqlCoreInternal.createRequest(e,r),t)}),m=noop;if("production"!==process.env.NODE_ENV){var{next:f,source:w}=wonka.makeSubject();h.subscribeToDebugTarget=e=>wonka.subscribe(e)(w),m=f}var y=composeExchanges(r.exchanges),g=wonka.share(y({client:h,dispatchDebug:m,forward:fallbackExchange({dispatchDebug:m})})(c.source));return wonka.publish(g),h},createClient=Client;exports.CombinedError=urqlCoreInternal.CombinedError,exports.createRequest=urqlCoreInternal.createRequest,exports.getOperationName=urqlCoreInternal.getOperationName,exports.makeErrorResult=urqlCoreInternal.makeErrorResult,exports.makeResult=urqlCoreInternal.makeResult,exports.mergeResultPatch=urqlCoreInternal.mergeResultPatch,exports.stringifyDocument=urqlCoreInternal.stringifyDocument,exports.stringifyVariables=urqlCoreInternal.stringifyVariables,exports.Client=Client,exports.cacheExchange=cacheExchange,exports.composeExchanges=composeExchanges,exports.createClient=createClient,exports.debugExchange=debugExchange,exports.errorExchange=mapExchange,exports.fetchExchange=fetchExchange,exports.formatDocument=formatDocument,exports.gql=gql,exports.makeOperation=makeOperation,exports.mapExchange=mapExchange,exports.ssrExchange=ssrExchange,exports.subscriptionExchange=subscriptionExchange;