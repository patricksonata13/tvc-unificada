"use strict";const childProcess=require("child_process"),{isLinux:isLinux,getReport:getReport}=require("./process"),{LDD_PATH:LDD_PATH,SELF_PATH:SELF_PATH,readFile:readFile,readFileSync:readFileSync}=require("./filesystem"),{interpreterPath:interpreterPath}=require("./elf");let cachedFamilyInterpreter,cachedFamilyFilesystem,cachedVersionFilesystem;const command="getconf GNU_LIBC_VERSION 2>&1 || true; ldd --version 2>&1 || true";let commandOut="";const safeCommand=()=>commandOut||new Promise(e=>{childProcess.exec(command,(r,i)=>{commandOut=r?" ":i,e(commandOut)})}),safeCommandSync=()=>{if(!commandOut)try{commandOut=childProcess.execSync(command,{encoding:"utf8"})}catch(e){commandOut=" "}return commandOut},GLIBC="glibc",RE_GLIBC_VERSION=/LIBC[a-z0-9 \-).]*?(\d+\.\d+)/i,MUSL="musl",isFileMusl=e=>e.includes("libc.musl-")||e.includes("ld-musl-"),familyFromReport=()=>{const e=getReport();return e.header&&e.header.glibcVersionRuntime?GLIBC:Array.isArray(e.sharedObjects)&&e.sharedObjects.some(isFileMusl)?MUSL:null},familyFromCommand=e=>{const[r,i]=e.split(/[\r\n]+/);return r&&r.includes(GLIBC)?GLIBC:i&&i.includes(MUSL)?MUSL:null},familyFromInterpreterPath=e=>{if(e){if(e.includes("/ld-musl-"))return MUSL;if(e.includes("/ld-linux-"))return GLIBC}return null},getFamilyFromLddContent=e=>(e=e.toString()).includes("musl")?MUSL:e.includes("GNU C Library")?GLIBC:null,familyFromFilesystem=async()=>{if(void 0!==cachedFamilyFilesystem)return cachedFamilyFilesystem;cachedFamilyFilesystem=null;try{const e=await readFile(LDD_PATH);cachedFamilyFilesystem=getFamilyFromLddContent(e)}catch(e){}return cachedFamilyFilesystem},familyFromFilesystemSync=()=>{if(void 0!==cachedFamilyFilesystem)return cachedFamilyFilesystem;cachedFamilyFilesystem=null;try{const e=readFileSync(LDD_PATH);cachedFamilyFilesystem=getFamilyFromLddContent(e)}catch(e){}return cachedFamilyFilesystem},familyFromInterpreter=async()=>{if(void 0!==cachedFamilyInterpreter)return cachedFamilyInterpreter;cachedFamilyInterpreter=null;try{const e=await readFile(SELF_PATH),r=interpreterPath(e);cachedFamilyInterpreter=familyFromInterpreterPath(r)}catch(e){}return cachedFamilyInterpreter},familyFromInterpreterSync=()=>{if(void 0!==cachedFamilyInterpreter)return cachedFamilyInterpreter;cachedFamilyInterpreter=null;try{const e=readFileSync(SELF_PATH),r=interpreterPath(e);cachedFamilyInterpreter=familyFromInterpreterPath(r)}catch(e){}return cachedFamilyInterpreter},family=async()=>{let e=null;if(isLinux()&&(e=await familyFromInterpreter(),!e&&(e=await familyFromFilesystem(),e||(e=familyFromReport()),!e))){const r=await safeCommand();e=familyFromCommand(r)}return e},familySync=()=>{let e=null;if(isLinux()&&(e=familyFromInterpreterSync(),!e&&(e=familyFromFilesystemSync(),e||(e=familyFromReport()),!e))){const r=safeCommandSync();e=familyFromCommand(r)}return e},isNonGlibcLinux=async()=>isLinux()&&await family()!==GLIBC,isNonGlibcLinuxSync=()=>isLinux()&&familySync()!==GLIBC,versionFromFilesystem=async()=>{if(void 0!==cachedVersionFilesystem)return cachedVersionFilesystem;cachedVersionFilesystem=null;try{const e=(await readFile(LDD_PATH)).match(RE_GLIBC_VERSION);e&&(cachedVersionFilesystem=e[1])}catch(e){}return cachedVersionFilesystem},versionFromFilesystemSync=()=>{if(void 0!==cachedVersionFilesystem)return cachedVersionFilesystem;cachedVersionFilesystem=null;try{const e=readFileSync(LDD_PATH).match(RE_GLIBC_VERSION);e&&(cachedVersionFilesystem=e[1])}catch(e){}return cachedVersionFilesystem},versionFromReport=()=>{const e=getReport();return e.header&&e.header.glibcVersionRuntime?e.header.glibcVersionRuntime:null},versionSuffix=e=>e.trim().split(/\s+/)[1],versionFromCommand=e=>{const[r,i,n]=e.split(/[\r\n]+/);return r&&r.includes(GLIBC)?versionSuffix(r):i&&n&&i.includes(MUSL)?versionSuffix(n):null},version=async()=>{let e=null;if(isLinux()&&(e=await versionFromFilesystem(),e||(e=versionFromReport()),!e)){const r=await safeCommand();e=versionFromCommand(r)}return e},versionSync=()=>{let e=null;if(isLinux()&&(e=versionFromFilesystemSync(),e||(e=versionFromReport()),!e)){const r=safeCommandSync();e=versionFromCommand(r)}return e};module.exports={GLIBC:GLIBC,MUSL:MUSL,family:family,familySync:familySync,isNonGlibcLinux:isNonGlibcLinux,isNonGlibcLinuxSync:isNonGlibcLinuxSync,version:version,versionSync:versionSync};