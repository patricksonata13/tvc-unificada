"use strict";let{nanoid:nanoid}=require("nanoid/non-secure"),{isAbsolute:isAbsolute,resolve:resolve}=require("path"),{SourceMapConsumer:SourceMapConsumer,SourceMapGenerator:SourceMapGenerator}=require("source-map-js"),{fileURLToPath:fileURLToPath,pathToFileURL:pathToFileURL}=require("url"),CssSyntaxError=require("./css-syntax-error"),PreviousMap=require("./previous-map"),terminalHighlight=require("./terminal-highlight"),fromOffsetCache=Symbol("fromOffsetCache"),sourceMapAvailable=Boolean(SourceMapConsumer&&SourceMapGenerator),pathAvailable=Boolean(resolve&&isAbsolute);class Input{constructor(e,i={}){if(null==e||"object"==typeof e&&!e.toString)throw new Error(`PostCSS received ${e} instead of CSS string`);if(this.css=e.toString(),"\ufeff"===this.css[0]||"ï¿¾"===this.css[0]?(this.hasBOM=!0,this.css=this.css.slice(1)):this.hasBOM=!1,i.from&&(!pathAvailable||/^\w+:\/\//.test(i.from)||isAbsolute(i.from)?this.file=i.from:this.file=resolve(i.from)),pathAvailable&&sourceMapAvailable){let e=new PreviousMap(this.css,i);if(e.text){this.map=e;let i=e.consumer().file;!this.file&&i&&(this.file=this.mapResolve(i))}}this.file||(this.id="<input css "+nanoid(6)+">"),this.map&&(this.map.file=this.from)}error(e,i,t,o={}){let s,l,r;if(i&&"object"==typeof i){let e=i,o=t;if("number"==typeof e.offset){let o=this.fromOffset(e.offset);i=o.line,t=o.col}else i=e.line,t=e.column;if("number"==typeof o.offset){let e=this.fromOffset(o.offset);l=e.line,s=e.col}else l=o.line,s=o.column}else if(!t){let e=this.fromOffset(i);i=e.line,t=e.col}let n=this.origin(i,t,l,s);return r=n?new CssSyntaxError(e,void 0===n.endLine?n.line:{column:n.column,line:n.line},void 0===n.endLine?n.column:{column:n.endColumn,line:n.endLine},n.source,n.file,o.plugin):new CssSyntaxError(e,void 0===l?i:{column:t,line:i},void 0===l?t:{column:s,line:l},this.css,this.file,o.plugin),r.input={column:t,endColumn:s,endLine:l,line:i,source:this.css},this.file&&(pathToFileURL&&(r.input.url=pathToFileURL(this.file).toString()),r.input.file=this.file),r}fromOffset(e){let i,t;if(this[fromOffsetCache])t=this[fromOffsetCache];else{let e=this.css.split("\n");t=new Array(e.length);let i=0;for(let o=0,s=e.length;o<s;o++)t[o]=i,i+=e[o].length+1;this[fromOffsetCache]=t}i=t[t.length-1];let o=0;if(e>=i)o=t.length-1;else{let i,s=t.length-2;for(;o<s;)if(i=o+(s-o>>1),e<t[i])s=i-1;else{if(!(e>=t[i+1])){o=i;break}o=i+1}}return{col:e-t[o]+1,line:o+1}}mapResolve(e){return/^\w+:\/\//.test(e)?e:resolve(this.map.consumer().sourceRoot||this.map.root||".",e)}origin(e,i,t,o){if(!this.map)return!1;let s,l,r=this.map.consumer(),n=r.originalPositionFor({column:i,line:e});if(!n.source)return!1;"number"==typeof t&&(s=r.originalPositionFor({column:o,line:t})),l=isAbsolute(n.source)?pathToFileURL(n.source):new URL(n.source,this.map.consumer().sourceRoot||pathToFileURL(this.map.mapFile));let u={column:n.column,endColumn:s&&s.column,endLine:s&&s.line,line:n.line,url:l.toString()};if("file:"===l.protocol){if(!fileURLToPath)throw new Error("file: protocol is not available in this PostCSS build");u.file=fileURLToPath(l)}let f=r.sourceContentFor(n.source);return f&&(u.source=f),u}toJSON(){let e={};for(let i of["hasBOM","css","file","id"])null!=this[i]&&(e[i]=this[i]);return this.map&&(e.map={...this.map},e.map.consumerCache&&(e.map.consumerCache=void 0)),e}get from(){return this.file||this.id}}module.exports=Input,Input.default=Input,terminalHighlight&&terminalHighlight.registerInput&&terminalHighlight.registerInput(Input);