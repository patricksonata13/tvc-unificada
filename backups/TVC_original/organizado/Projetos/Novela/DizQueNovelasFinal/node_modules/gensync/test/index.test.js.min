"use strict";const promisify=require("util.promisify"),gensync=require("../"),TEST_ERROR=new Error("TEST_ERROR"),DID_ERROR=new Error("DID_ERROR"),doSuccess=gensync({sync:()=>42,async:()=>Promise.resolve(42)}),doError=gensync({sync:()=>{throw DID_ERROR},async:()=>Promise.reject(DID_ERROR)});function throwTestError(){throw TEST_ERROR}async function expectResult(e,c,{error:t,value:n,expectSync:s=!1,syncErrback:r=s}){s?t?expect(()=>e.sync(c)).toThrow(t):expect(e.sync(c)).toBe(n):expect(()=>e.sync(c)).toThrow(TEST_ERROR),t?await expect(e.async(c)).rejects.toBe(t):await expect(e.async(c)).resolves.toBe(n),await new Promise((s,o)=>{let a=!0;e.errback(c,(e,c)=>{try{expect(e).toBe(t),expect(c).toBe(n),expect(a).toBe(r),s()}catch(e){o(e)}}),a=!1})}describe("gensync({})",()=>{describe("option validation",()=>{test("disallow async and errback handler together",()=>{try{gensync({sync:throwTestError,async:throwTestError,errback:throwTestError}),throwTestError()}catch(e){expect(e.message).toMatch(/Expected one of either opts.async or opts.errback, but got _both_\./),expect(e.code).toBe("GENSYNC_OPTIONS_ERROR")}}),test("disallow missing sync handler",()=>{try{gensync({async:throwTestError}),throwTestError()}catch(e){expect(e.message).toMatch(/Expected opts.sync to be a function./),expect(e.code).toBe("GENSYNC_OPTIONS_ERROR")}}),test("errback callback required",()=>{const e=gensync({sync:throwTestError,async:throwTestError});try{e.errback(),throwTestError()}catch(e){expect(e.message).toMatch(/function called without callback/),expect(e.code).toBe("GENSYNC_ERRBACK_NO_CALLBACK")}})}),describe("generator function metadata",()=>{test("automatic naming",()=>{expect(gensync({sync:function(){},async:()=>{}}).name).toBe("readFile"),expect(gensync({sync:function(){},async:()=>{}}).name).toBe("readFile"),expect(gensync({sync:function(){},async:()=>{}}).name).toBe("readFileAsync"),expect(gensync({sync:()=>{},async:function(){}}).name).toBe("readFileSync"),expect(gensync({sync:()=>{},async:function(){}}).name).toBe("readFile"),expect(gensync({sync:()=>{},async:function(){}}).name).toBe("readFile"),expect(gensync({sync:()=>{},errback:function(){}}).name).toBe("readFileSync"),expect(gensync({sync:()=>{},errback:function(){}}).name).toBe("readFile"),expect(gensync({sync:()=>{},errback:function(){}}).name).toBe("readFileAsync")}),test("explicit naming",()=>{expect(gensync({name:"readFile",sync:()=>{},async:()=>{}}).name).toBe("readFile")}),test("default arity",()=>{expect(gensync({sync:function(e,c,t,n,s,r,o){throwTestError()},async:throwTestError}).length).toBe(7)}),test("explicit arity",()=>{expect(gensync({arity:3,sync:throwTestError,async:throwTestError}).length).toBe(3)})}),describe("'sync' handler",async()=>{test("success",async()=>{const e=gensync({sync:(...e)=>JSON.stringify(e)});await expectResult(e,42,{value:"[42]",expectSync:!0})}),test("failure",async()=>{const e=gensync({sync:(...e)=>{throw JSON.stringify(e)}});await expectResult(e,42,{error:"[42]",expectSync:!0})})}),describe("'async' handler",async()=>{test("success",async()=>{const e=gensync({sync:throwTestError,async:(...e)=>Promise.resolve(JSON.stringify(e))});await expectResult(e,42,{value:"[42]"})}),test("failure",async()=>{const e=gensync({sync:throwTestError,async:(...e)=>Promise.reject(JSON.stringify(e))});await expectResult(e,42,{error:"[42]"})})}),describe("'errback' sync handler",async()=>{test("success",async()=>{const e=gensync({sync:throwTestError,errback:(...e)=>e.pop()(null,JSON.stringify(e))});await expectResult(e,42,{value:"[42]",syncErrback:!0})}),test("failure",async()=>{const e=gensync({sync:throwTestError,errback:(...e)=>e.pop()(JSON.stringify(e))});await expectResult(e,42,{error:"[42]",syncErrback:!0})})}),describe("'errback' async handler",async()=>{test("success",async()=>{const e=gensync({sync:throwTestError,errback:(...e)=>process.nextTick(()=>e.pop()(null,JSON.stringify(e)))});await expectResult(e,42,{value:"[42]"})}),test("failure",async()=>{const e=gensync({sync:throwTestError,errback:(...e)=>process.nextTick(()=>e.pop()(JSON.stringify(e)))});await expectResult(e,42,{error:"[42]"})})})}),describe("gensync(function* () {})",()=>{test("sync throw before body",async()=>{const e=gensync(function*(e=throwTestError()){});await expectResult(e,void 0,{error:TEST_ERROR,syncErrback:!0})}),test("sync throw inside body",async()=>{const e=gensync(function*(){throwTestError()});await expectResult(e,void 0,{error:TEST_ERROR,syncErrback:!0})}),test("async throw inside body",async()=>{const e=gensync(function*(){yield*doSuccess();throwTestError()});await expectResult(e,void 0,{error:TEST_ERROR})}),test("error inside body",async()=>{const e=gensync(function*(){yield*doError()});await expectResult(e,void 0,{error:DID_ERROR,expectSync:!0,syncErrback:!1})}),test("successful return value",async()=>{const e=gensync(function*(){const e=yield*doSuccess();return expect(e).toBe(42),84});await expectResult(e,void 0,{value:84,expectSync:!0,syncErrback:!1})}),test("successful final value",async()=>{const e=gensync(function*(){return 42});await expectResult(e,void 0,{value:42,expectSync:!0})}),test("yield unexpected object",async()=>{const e=gensync(function*(){yield{}});try{await e.async(),throwTestError()}catch(e){expect(e.message).toMatch(/Got unexpected yielded value in gensync generator/),expect(e.code).toBe("GENSYNC_EXPECTED_START")}}),test("yield suspend yield",async()=>{const e=gensync(function*(){yield Symbol.for("gensync:v1:start"),yield{}});try{await e.async(),throwTestError()}catch(e){expect(e.message).toMatch(/Expected GENSYNC_SUSPEND, got {}/),expect(e.code).toBe("GENSYNC_EXPECTED_SUSPEND")}}),test("yield suspend return",async()=>{const e=gensync(function*(){return yield Symbol.for("gensync:v1:start"),{}});try{await e.async(),throwTestError()}catch(e){expect(e.message).toMatch(/Unexpected generator completion/),expect(e.code).toBe("GENSYNC_EXPECTED_SUSPEND")}})}),describe("gensync.all()",()=>{test("success",async()=>{const e=gensync(function*(){const e=yield*gensync.all([doSuccess(),doSuccess()]);expect(e).toEqual([42,42])});await expectResult(e,void 0,{value:void 0,expectSync:!0,syncErrback:!1})}),test("error first",async()=>{const e=gensync(function*(){yield*gensync.all([doError(),doSuccess()])});await expectResult(e,void 0,{error:DID_ERROR,expectSync:!0,syncErrback:!1})}),test("error last",async()=>{const e=gensync(function*(){yield*gensync.all([doSuccess(),doError()])});await expectResult(e,void 0,{error:DID_ERROR,expectSync:!0,syncErrback:!1})}),test("empty list",async()=>{const e=gensync(function*(){yield*gensync.all([])});await expectResult(e,void 0,{value:void 0,expectSync:!0,syncErrback:!1})})}),describe("gensync.race()",()=>{test("success",async()=>{const e=gensync(function*(){const e=yield*gensync.race([doSuccess(),doError()]);expect(e).toEqual(42)});await expectResult(e,void 0,{value:void 0,expectSync:!0,syncErrback:!1})}),test("error",async()=>{const e=gensync(function*(){yield*gensync.race([doError(),doSuccess()])});await expectResult(e,void 0,{error:DID_ERROR,expectSync:!0,syncErrback:!1})})});