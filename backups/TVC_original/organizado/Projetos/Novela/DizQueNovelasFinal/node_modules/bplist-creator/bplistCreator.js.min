"use strict";var streamBuffers=require("stream-buffers"),debug=!1;function Real(e){this.value=e}function toEntries(e){if(e.bplistOverride)return[e];if(e instanceof Array)return toEntriesArray(e);if(e instanceof Buffer)return[{type:"data",value:e}];if(e instanceof Real)return[{type:"double",value:e.value}];if("object"==typeof e)return e instanceof Date?[{type:"date",value:e}]:1==Object.keys(e).length&&"number"==typeof e.UID?[{type:"UID",value:e.UID}]:toEntriesObject(e);if("string"==typeof e)return[{type:"string",value:e}];if("number"==typeof e)return[{type:"number",value:e}];if("boolean"==typeof e)return[{type:"boolean",value:e}];if("bigint"==typeof e)return[{type:"number",value:e}];throw new Error("unhandled entry: "+e)}function toEntriesArray(e){debug&&console.log("toEntriesArray");var t=[{type:"array",entries:[]}];return e.forEach(function(e){var r=toEntries(e);t[0].entries.push(r[0]),t=t.concat(r)}),t}function toEntriesObject(e){debug&&console.log("toEntriesObject");var t=[{type:"dict",entryKeys:[],entryValues:[]}];return Object.keys(e).forEach(function(e){var r=toEntries(e);t[0].entryKeys.push(r[0]),t=t.concat(r[0])}),Object.keys(e).forEach(function(r){var n=toEntries(e[r]);t[0].entryValues.push(n[0]),t=t.concat(n)}),t}function computeOffsetSizeInBytes(e){return e<256?1:e<65536?2:e<4294967296?4:8}function computeIdSizeInBytes(e){return e<256?1:e<65536?2:4}module.exports=function(e){var t=new streamBuffers.WritableStreamBuffer;t.write(Buffer.from("bplist00")),debug&&console.log("create",require("util").inspect(e,!1,10)),e instanceof Array&&1===e.length&&(e=e[0]);var r=toEntries(e);debug&&console.log("entries",r);var n,i,o,u,a=computeIdSizeInBytes(r.length),l=[];return o={},u=0,r.forEach(function(e){e.id||("string"===e.type?!e.bplistOverride&&o.hasOwnProperty(e.value)?(e.type="stringref",e.id=o[e.value]):o[e.value]=e.id=u++:e.id=u++)}),(r=r.filter(function(e){return"stringref"!==e.type})).forEach(function(e,r){l[r]=t.size(),e?function(e){switch(e.type){case"dict":!function(e){if(debug){var r=e.entryKeys.map(function(e){return e.id}),n=e.entryValues.map(function(e){return e.id});console.log("0x"+t.size().toString(16),"writeDict","(id: "+e.id+")","(keys: "+r+")","(values: "+n+")")}g(13,e.entryKeys.length),e.entryKeys.forEach(function(e){y(e.id)}),e.entryValues.forEach(function(e){y(e.id)})}(e);break;case"number":case"double":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeNumber",e.value," (type: "+e.type+")","(id: "+e.id+")");if("bigint"==typeof e.value){var r=16,n=e.value.toString(r),i=Buffer.from(n.padStart(2*r,"0").slice(0,2*r),"hex");f(20),t.write(i)}else"double"!==e.type&&parseFloat(e.value).toFixed()==e.value?e.value<0?(f(19),d(e.value,8,!0)):e.value<=255?(f(16),d(e.value,1)):e.value<=65535?(f(17),d(e.value,2)):e.value<=4294967295?(f(18),d(e.value,4)):(f(19),d(e.value,8)):(f(35),c(e.value))}(e);break;case"UID":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeUID",e.value," (type: "+e.type+")","(id: "+e.id+")");g(8,0),y(e.value)}(e);break;case"array":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeArray (length: "+e.entries.length+")","(id: "+e.id+")");g(10,e.entries.length),e.entries.forEach(function(e){y(e.id)})}(e);break;case"boolean":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeBoolean",e.value,"(id: "+e.id+")");f(e.value?9:8)}(e);break;case"string":case"string-utf16":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeString",e.value,"(id: "+e.id+")");if("string-utf16"===e.type||(u=e.value,Buffer.byteLength(u,"utf8")!=u.length)){var r=Buffer.from(e.value,"ucs2");g(6,r.length/2);for(var n=0;n<r.length;n+=2){var i=r[n+0];r[n+0]=r[n+1],r[n+1]=i}t.write(r)}else{var o=Buffer.from(e.value,"ascii");g(5,o.length),t.write(o)}var u}(e);break;case"date":!function(e){f(51);var t=Date.parse(e.value)/1e3-978307200;c(t)}(e);break;case"data":!function(e){debug&&console.log("0x"+t.size().toString(16),"writeData",e.value,"(id: "+e.id+")");g(4,e.value.length),t.write(e.value)}(e);break;default:throw new Error("unhandled entry type: "+e.type)}}(e):t.write(0)}),function(){debug&&console.log("0x"+t.size().toString(16),"writeOffsetTable");i=t.size(),n=computeOffsetSizeInBytes(i),l.forEach(function(e){d(e,n)})}(),function(){debug&&console.log("0x"+t.size().toString(16),"writeTrailer");t.write(Buffer.from([0,0,0,0,0,0])),debug&&console.log("0x"+t.size().toString(16),"writeTrailer(offsetSizeInBytes):",n);f(n),debug&&console.log("0x"+t.size().toString(16),"writeTrailer(offsetSizeInBytes):",a);f(a),debug&&console.log("0x"+t.size().toString(16),"writeTrailer(number of objects):",r.length);s(r.length),debug&&console.log("0x"+t.size().toString(16),"writeTrailer(top object)");s(0),debug&&console.log("0x"+t.size().toString(16),"writeTrailer(offset table offset):",i);s(i)}(),t.getContents();function s(e){d(e,8)}function f(e){t.write(Buffer.from([e]))}function c(e){var r=Buffer.alloc(8);r.writeDoubleBE(e,0),t.write(r)}function g(e,t){t<15?f((e<<4)+t):t<256?(f(15+(e<<4)),f(16),d(t,1)):t<65536?(f(15+(e<<4)),f(17),d(t,2)):(f(15+(e<<4)),f(18),d(t,4))}function y(e){d(e,a)}function d(e,r,n){for(var i=Buffer.alloc(r),o=0;r>4;)i[o++]=n?255:0,r--;for(var u=r-1;u>=0;u--)i[o++]=e>>8*u;t.write(i)}},module.exports.Real=Real;