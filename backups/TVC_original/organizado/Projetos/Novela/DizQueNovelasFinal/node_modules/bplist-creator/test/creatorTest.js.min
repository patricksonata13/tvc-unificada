"use strict";var fs=require("fs"),path=require("path"),nodeunit=require("nodeunit"),bplistParser=require("bplist-parser"),bplistCreator=require("../");function testFile(e,t){fs.readFile(t,function(r,i){if(r)return e.done(r);bplistParser.parseFile(t,function(t,r){if(t)return e.done(t);r&&r[0]&&r[0].loadedTimeRanges&&r[0].loadedTimeRanges[0]&&r[0].loadedTimeRanges[0].hasOwnProperty("start")&&(r[0].loadedTimeRanges[0].start={bplistOverride:!0,type:"double",value:r[0].loadedTimeRanges[0].start}),r&&r[0]&&r[0].loadedTimeRanges&&r[0].seekableTimeRanges[0]&&r[0].seekableTimeRanges[0].hasOwnProperty("start")&&(r[0].seekableTimeRanges[0].start={bplistOverride:!0,type:"double",value:r[0].seekableTimeRanges[0].start}),r&&r[0]&&r[0].hasOwnProperty("rate")&&(r[0].rate={bplistOverride:!0,type:"double",value:r[0].rate}),r&&r[0]&&r[0].hasOwnProperty("NSHumanReadableCopyright")&&(r[0].NSHumanReadableCopyright={bplistOverride:!0,type:"string-utf16",value:r[0].NSHumanReadableCopyright}),r&&r[0]&&r[0].hasOwnProperty("CFBundleExecutable")&&(r[0].CFBundleExecutable={bplistOverride:!0,type:"string",value:r[0].CFBundleExecutable}),r&&r[0]&&r[0].CFBundleURLTypes&&r[0].CFBundleURLTypes[0]&&r[0].CFBundleURLTypes[0].hasOwnProperty("CFBundleURLSchemes")&&(r[0].CFBundleURLTypes[0].CFBundleURLSchemes[0]={bplistOverride:!0,type:"string",value:r[0].CFBundleURLTypes[0].CFBundleURLSchemes[0]}),r&&r[0]&&r[0].hasOwnProperty("CFBundleDisplayName")&&(r[0].CFBundleDisplayName={bplistOverride:!0,type:"string",value:r[0].CFBundleDisplayName}),r&&r[0]&&r[0].hasOwnProperty("DTPlatformBuild")&&(r[0].DTPlatformBuild={bplistOverride:!0,type:"string",value:r[0].DTPlatformBuild}),r&&r[0]&&r[0].hasOwnProperty("int64item")&&(r[0].int64item={bplistOverride:!0,type:"number",value:r[0].int64item.value});var n=bplistCreator(r);return compareBuffers(e,n,i),e.done()})})}function compareBuffers(e,t,r){if(t.length!==r.length)return printBuffers(t,r),e.fail("buffer size mismatch. found: "+t.length+", expected: "+r.length+".");for(var i=0;i<t.length;i++)if(t[i]!==r[i])return printBuffers(t,r),e.fail("buffer mismatch at offset 0x"+i.toString(16)+". found: 0x"+t[i].toString(16)+", expected: 0x"+r[i].toString(16)+".")}function printBuffers(e,t){for(var r,i,n=0;n<e.length||n<t.length;n+=16){var a="";for(a+=(i="000000000"+n.toString(16)).substr(i.length-8)+": ",r=0;r<16;r++)8==r&&(a+=" "),n+r<e.length?a+=(i="00"+e[n+r].toString(16)).substr(i.length-2)+" ":a+="   ";for(a+=" ",r=0;r<16;r++)n+r<e.length?(((i=String.fromCharCode(e[n+r]))<" "||i>"~")&&(i="."),a+=i):a+=" ";for(a+=" - ",r=0;r<16;r++)8==r&&(a+=" "),n+r<t.length?a+=(i="00"+t[n+r].toString(16)).substr(i.length-2)+" ":a+="   ";for(a+=" ",r=0;r<16;r++)n+r<t.length?(((i=String.fromCharCode(t[n+r]))<" "||i>"~")&&(i="."),a+=i):a+=" ";console.log(a)}}module.exports={sample1:function(e){testFile(e,path.join(__dirname,"sample1.bplist"))},sample2:function(e){testFile(e,path.join(__dirname,"sample2.bplist"))},"binary data":function(e){testFile(e,path.join(__dirname,"binaryData.bplist"))},airplay:function(e){testFile(e,path.join(__dirname,"airplay.bplist"))},integers:function(e){testFile(e,path.join(__dirname,"integers.bplist"))}};