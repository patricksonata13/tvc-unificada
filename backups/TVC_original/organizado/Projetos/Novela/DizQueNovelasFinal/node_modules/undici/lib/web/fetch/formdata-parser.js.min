"use strict";const{isUSVString:isUSVString,bufferToLowerCasedHeaderName:bufferToLowerCasedHeaderName}=require("../../core/util"),{utf8DecodeBytes:utf8DecodeBytes}=require("./util"),{HTTP_TOKEN_CODEPOINTS:HTTP_TOKEN_CODEPOINTS,isomorphicDecode:isomorphicDecode}=require("./data-url"),{isFileLike:isFileLike}=require("./file"),{makeEntry:makeEntry}=require("./formdata"),assert=require("node:assert"),{File:NodeFile}=require("node:buffer"),File=globalThis.File??NodeFile,formDataNameBuffer=Buffer.from('form-data; name="'),filenameBuffer=Buffer.from("; filename"),dd=Buffer.from("--"),ddcrlf=Buffer.from("--\r\n");function isAsciiString(e){for(let r=0;r<e.length;++r)if(-128&e.charCodeAt(r))return!1;return!0}function validateBoundary(e){const r=e.length;if(r<27||r>70)return!1;for(let t=0;t<r;++t){const r=e.charCodeAt(t);if(!(r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||39===r||45===r||95===r))return!1}return!0}function multipartFormDataParser(e,r){assert("failure"!==r&&"multipart/form-data"===r.essence);const t=r.parameters.get("boundary");if(void 0===t)return"failure";const i=Buffer.from(`--${t}`,"utf8"),o=[],n={position:0};for(;13===e[n.position]&&10===e[n.position+1];)n.position+=2;let a=e.length;for(;10===e[a-1]&&13===e[a-2];)a-=2;for(a!==e.length&&(e=e.subarray(0,a));;){if(!e.subarray(n.position,n.position+i.length).equals(i))return"failure";if(n.position+=i.length,n.position===e.length-2&&bufferStartsWith(e,dd,n)||n.position===e.length-4&&bufferStartsWith(e,ddcrlf,n))return o;if(13!==e[n.position]||10!==e[n.position+1])return"failure";n.position+=2;const r=parseMultipartFormDataHeaders(e,n);if("failure"===r)return"failure";let t,a,{name:f,filename:s,contentType:u,encoding:l}=r;n.position+=2;{const r=e.indexOf(i.subarray(2),n.position);if(-1===r)return"failure";t=e.subarray(n.position,r-4),n.position+=t.length,"base64"===l&&(t=Buffer.from(t.toString(),"base64"))}if(13!==e[n.position]||10!==e[n.position+1])return"failure";n.position+=2,null!==s?(u??="text/plain",isAsciiString(u)||(u=""),a=new File([t],s,{type:u})):a=utf8DecodeBytes(Buffer.from(t)),assert(isUSVString(f)),assert("string"==typeof a&&isUSVString(a)||isFileLike(a)),o.push(makeEntry(f,a,s))}}function parseMultipartFormDataHeaders(e,r){let t=null,i=null,o=null,n=null;for(;;){if(13===e[r.position]&&10===e[r.position+1])return null===t?"failure":{name:t,filename:i,contentType:o,encoding:n};let a=collectASequenceOfBytes(e=>10!==e&&13!==e&&58!==e,e,r);if(a=removeChars(a,!0,!0,e=>9===e||32===e),!HTTP_TOKEN_CODEPOINTS.test(a.toString()))return"failure";if(58!==e[r.position])return"failure";switch(r.position++,collectASequenceOfBytes(e=>32===e||9===e,e,r),bufferToLowerCasedHeaderName(a)){case"content-disposition":if(t=i=null,!bufferStartsWith(e,formDataNameBuffer,r))return"failure";if(r.position+=17,t=parseMultipartFormDataName(e,r),null===t)return"failure";if(bufferStartsWith(e,filenameBuffer,r)){let t=r.position+filenameBuffer.length;if(42===e[t]&&(r.position+=1,t+=1),61!==e[t]||34!==e[t+1])return"failure";if(r.position+=12,i=parseMultipartFormDataName(e,r),null===i)return"failure"}break;case"content-type":{let t=collectASequenceOfBytes(e=>10!==e&&13!==e,e,r);t=removeChars(t,!1,!0,e=>9===e||32===e),o=isomorphicDecode(t);break}case"content-transfer-encoding":{let t=collectASequenceOfBytes(e=>10!==e&&13!==e,e,r);t=removeChars(t,!1,!0,e=>9===e||32===e),n=isomorphicDecode(t);break}default:collectASequenceOfBytes(e=>10!==e&&13!==e,e,r)}if(13!==e[r.position]&&10!==e[r.position+1])return"failure";r.position+=2}}function parseMultipartFormDataName(e,r){assert(34===e[r.position-1]);let t=collectASequenceOfBytes(e=>10!==e&&13!==e&&34!==e,e,r);return 34!==e[r.position]?null:(r.position++,t=(new TextDecoder).decode(t).replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"'),t)}function collectASequenceOfBytes(e,r,t){let i=t.position;for(;i<r.length&&e(r[i]);)++i;return r.subarray(t.position,t.position=i)}function removeChars(e,r,t,i){let o=0,n=e.length-1;if(r)for(;o<e.length&&i(e[o]);)o++;if(t)for(;n>0&&i(e[n]);)n--;return 0===o&&n===e.length-1?e:e.subarray(o,n+1)}function bufferStartsWith(e,r,t){if(e.length<r.length)return!1;for(let i=0;i<r.length;i++)if(r[i]!==e[t.position+i])return!1;return!0}module.exports={multipartFormDataParser:multipartFormDataParser,validateBoundary:validateBoundary};