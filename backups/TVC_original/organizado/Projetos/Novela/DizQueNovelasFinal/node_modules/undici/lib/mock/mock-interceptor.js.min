"use strict";const{getResponseData:getResponseData,buildKey:buildKey,addMockDispatch:addMockDispatch}=require("./mock-utils"),{kDispatches:kDispatches,kDispatchKey:kDispatchKey,kDefaultHeaders:kDefaultHeaders,kDefaultTrailers:kDefaultTrailers,kContentLength:kContentLength,kMockDispatch:kMockDispatch}=require("./mock-symbols"),{InvalidArgumentError:InvalidArgumentError}=require("../core/errors"),{buildURL:buildURL}=require("../core/util");class MockScope{constructor(e){this[kMockDispatch]=e}delay(e){if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw new InvalidArgumentError("waitInMs must be a valid integer > 0");return this[kMockDispatch].delay=e,this}persist(){return this[kMockDispatch].persist=!0,this}times(e){if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw new InvalidArgumentError("repeatTimes must be a valid integer > 0");return this[kMockDispatch].times=e,this}}class MockInterceptor{constructor(e,t){if("object"!=typeof e)throw new InvalidArgumentError("opts must be an object");if(void 0===e.path)throw new InvalidArgumentError("opts.path must be defined");if(void 0===e.method&&(e.method="GET"),"string"==typeof e.path)if(e.query)e.path=buildURL(e.path,e.query);else{const t=new URL(e.path,"data://");e.path=t.pathname+t.search}"string"==typeof e.method&&(e.method=e.method.toUpperCase()),this[kDispatchKey]=buildKey(e),this[kDispatches]=t,this[kDefaultHeaders]={},this[kDefaultTrailers]={},this[kContentLength]=!1}createMockScopeDispatchData({statusCode:e,data:t,responseOptions:r}){const s=getResponseData(t),i=this[kContentLength]?{"content-length":s.length}:{};return{statusCode:e,data:t,headers:{...this[kDefaultHeaders],...i,...r.headers},trailers:{...this[kDefaultTrailers],...r.trailers}}}validateReplyParameters(e){if(void 0===e.statusCode)throw new InvalidArgumentError("statusCode must be defined");if("object"!=typeof e.responseOptions||null===e.responseOptions)throw new InvalidArgumentError("responseOptions must be an object")}reply(e){if("function"==typeof e){const t=t=>{const r=e(t);if("object"!=typeof r||null===r)throw new InvalidArgumentError("reply options callback must return an object");const s={data:"",responseOptions:{},...r};return this.validateReplyParameters(s),{...this.createMockScopeDispatchData(s)}},r=addMockDispatch(this[kDispatches],this[kDispatchKey],t);return new MockScope(r)}const t={statusCode:e,data:void 0===arguments[1]?"":arguments[1],responseOptions:void 0===arguments[2]?{}:arguments[2]};this.validateReplyParameters(t);const r=this.createMockScopeDispatchData(t),s=addMockDispatch(this[kDispatches],this[kDispatchKey],r);return new MockScope(s)}replyWithError(e){if(void 0===e)throw new InvalidArgumentError("error must be defined");const t=addMockDispatch(this[kDispatches],this[kDispatchKey],{error:e});return new MockScope(t)}defaultReplyHeaders(e){if(void 0===e)throw new InvalidArgumentError("headers must be defined");return this[kDefaultHeaders]=e,this}defaultReplyTrailers(e){if(void 0===e)throw new InvalidArgumentError("trailers must be defined");return this[kDefaultTrailers]=e,this}replyContentLength(){return this[kContentLength]=!0,this}}module.exports.MockInterceptor=MockInterceptor,module.exports.MockScope=MockScope;