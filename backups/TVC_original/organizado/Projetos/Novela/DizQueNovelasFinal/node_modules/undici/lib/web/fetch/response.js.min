"use strict";const{Headers:Headers,HeadersList:HeadersList,fill:fill,getHeadersGuard:getHeadersGuard,setHeadersGuard:setHeadersGuard,setHeadersList:setHeadersList}=require("./headers"),{extractBody:extractBody,cloneBody:cloneBody,mixinBody:mixinBody,hasFinalizationRegistry:hasFinalizationRegistry,streamRegistry:streamRegistry,bodyUnusable:bodyUnusable}=require("./body"),util=require("../../core/util"),nodeUtil=require("node:util"),{kEnumerableProperty:kEnumerableProperty}=util,{isValidReasonPhrase:isValidReasonPhrase,isCancelled:isCancelled,isAborted:isAborted,isBlobLike:isBlobLike,serializeJavascriptValueToJSONString:serializeJavascriptValueToJSONString,isErrorLike:isErrorLike,isomorphicEncode:isomorphicEncode,environmentSettingsObject:relevantRealm}=require("./util"),{redirectStatusSet:redirectStatusSet,nullBodyStatus:nullBodyStatus}=require("./constants"),{kState:kState,kHeaders:kHeaders}=require("./symbols"),{webidl:webidl}=require("./webidl"),{FormData:FormData}=require("./formdata"),{URLSerializer:URLSerializer}=require("./data-url"),{kConstruct:kConstruct}=require("../../core/symbols"),assert=require("node:assert"),{types:types}=require("node:util"),textEncoder=new TextEncoder("utf-8");class Response{static error(){return fromInnerResponse(makeNetworkError(),"immutable")}static json(e,t={}){webidl.argumentLengthCheck(arguments,1,"Response.json"),null!==t&&(t=webidl.converters.ResponseInit(t));const r=textEncoder.encode(serializeJavascriptValueToJSONString(e)),s=extractBody(r),n=fromInnerResponse(makeResponse({}),"response");return initializeResponse(n,t,{body:s[0],type:"application/json"}),n}static redirect(e,t=302){let r;webidl.argumentLengthCheck(arguments,1,"Response.redirect"),e=webidl.converters.USVString(e),t=webidl.converters["unsigned short"](t);try{r=new URL(e,relevantRealm.settingsObject.baseUrl)}catch(t){throw new TypeError(`Failed to parse URL from ${e}`,{cause:t})}if(!redirectStatusSet.has(t))throw new RangeError(`Invalid status code ${t}`);const s=fromInnerResponse(makeResponse({}),"immutable");s[kState].status=t;const n=isomorphicEncode(URLSerializer(r));return s[kState].headersList.append("location",n,!0),s}constructor(e=null,t={}){if(webidl.util.markAsUncloneable(this),e===kConstruct)return;null!==e&&(e=webidl.converters.BodyInit(e)),t=webidl.converters.ResponseInit(t),this[kState]=makeResponse({}),this[kHeaders]=new Headers(kConstruct),setHeadersGuard(this[kHeaders],"response"),setHeadersList(this[kHeaders],this[kState].headersList);let r=null;if(null!=e){const[t,s]=extractBody(e);r={body:t,type:s}}initializeResponse(this,t,r)}get type(){return webidl.brandCheck(this,Response),this[kState].type}get url(){webidl.brandCheck(this,Response);const e=this[kState].urlList,t=e[e.length-1]??null;return null===t?"":URLSerializer(t,!0)}get redirected(){return webidl.brandCheck(this,Response),this[kState].urlList.length>1}get status(){return webidl.brandCheck(this,Response),this[kState].status}get ok(){return webidl.brandCheck(this,Response),this[kState].status>=200&&this[kState].status<=299}get statusText(){return webidl.brandCheck(this,Response),this[kState].statusText}get headers(){return webidl.brandCheck(this,Response),this[kHeaders]}get body(){return webidl.brandCheck(this,Response),this[kState].body?this[kState].body.stream:null}get bodyUsed(){return webidl.brandCheck(this,Response),!!this[kState].body&&util.isDisturbed(this[kState].body.stream)}clone(){if(webidl.brandCheck(this,Response),bodyUnusable(this))throw webidl.errors.exception({header:"Response.clone",message:"Body has already been consumed."});const e=cloneResponse(this[kState]);return hasFinalizationRegistry&&this[kState].body?.stream&&streamRegistry.register(this,new WeakRef(this[kState].body.stream)),fromInnerResponse(e,getHeadersGuard(this[kHeaders]))}[nodeUtil.inspect.custom](e,t){null===t.depth&&(t.depth=2),t.colors??=!0;const r={status:this.status,statusText:this.statusText,headers:this.headers,body:this.body,bodyUsed:this.bodyUsed,ok:this.ok,redirected:this.redirected,type:this.type,url:this.url};return`Response ${nodeUtil.formatWithOptions(t,r)}`}}function cloneResponse(e){if(e.internalResponse)return filterResponse(cloneResponse(e.internalResponse),e.type);const t=makeResponse({...e,body:null});return null!=e.body&&(t.body=cloneBody(t,e.body)),t}function makeResponse(e){return{aborted:!1,rangeRequested:!1,timingAllowPassed:!1,requestIncludesCredentials:!1,type:"default",status:200,timingInfo:null,cacheState:"",statusText:"",...e,headersList:e?.headersList?new HeadersList(e?.headersList):new HeadersList,urlList:e?.urlList?[...e.urlList]:[]}}function makeNetworkError(e){return makeResponse({type:"error",status:0,error:isErrorLike(e)?e:new Error(e?String(e):e),aborted:e&&"AbortError"===e.name})}function isNetworkError(e){return"error"===e.type&&0===e.status}function makeFilteredResponse(e,t){return t={internalResponse:e,...t},new Proxy(e,{get:(e,r)=>r in t?t[r]:e[r],set:(e,r,s)=>(assert(!(r in t)),e[r]=s,!0)})}function filterResponse(e,t){return"basic"===t?makeFilteredResponse(e,{type:"basic",headersList:e.headersList}):"cors"===t?makeFilteredResponse(e,{type:"cors",headersList:e.headersList}):"opaque"===t?makeFilteredResponse(e,{type:"opaque",urlList:Object.freeze([]),status:0,statusText:"",body:null}):"opaqueredirect"===t?makeFilteredResponse(e,{type:"opaqueredirect",status:0,statusText:"",headersList:[],body:null}):void assert(!1)}function makeAppropriateNetworkError(e,t=null){return assert(isCancelled(e)),isAborted(e)?makeNetworkError(Object.assign(new DOMException("The operation was aborted.","AbortError"),{cause:t})):makeNetworkError(Object.assign(new DOMException("Request was cancelled."),{cause:t}))}function initializeResponse(e,t,r){if(null!==t.status&&(t.status<200||t.status>599))throw new RangeError('init["status"] must be in the range of 200 to 599, inclusive.');if("statusText"in t&&null!=t.statusText&&!isValidReasonPhrase(String(t.statusText)))throw new TypeError("Invalid statusText");if("status"in t&&null!=t.status&&(e[kState].status=t.status),"statusText"in t&&null!=t.statusText&&(e[kState].statusText=t.statusText),"headers"in t&&null!=t.headers&&fill(e[kHeaders],t.headers),r){if(nullBodyStatus.includes(e.status))throw webidl.errors.exception({header:"Response constructor",message:`Invalid response status code ${e.status}`});e[kState].body=r.body,null==r.type||e[kState].headersList.contains("content-type",!0)||e[kState].headersList.append("content-type",r.type,!0)}}function fromInnerResponse(e,t){const r=new Response(kConstruct);return r[kState]=e,r[kHeaders]=new Headers(kConstruct),setHeadersList(r[kHeaders],e.headersList),setHeadersGuard(r[kHeaders],t),hasFinalizationRegistry&&e.body?.stream&&streamRegistry.register(r,new WeakRef(e.body.stream)),r}mixinBody(Response),Object.defineProperties(Response.prototype,{type:kEnumerableProperty,url:kEnumerableProperty,status:kEnumerableProperty,ok:kEnumerableProperty,redirected:kEnumerableProperty,statusText:kEnumerableProperty,headers:kEnumerableProperty,clone:kEnumerableProperty,body:kEnumerableProperty,bodyUsed:kEnumerableProperty,[Symbol.toStringTag]:{value:"Response",configurable:!0}}),Object.defineProperties(Response,{json:kEnumerableProperty,redirect:kEnumerableProperty,error:kEnumerableProperty}),webidl.converters.ReadableStream=webidl.interfaceConverter(ReadableStream),webidl.converters.FormData=webidl.interfaceConverter(FormData),webidl.converters.URLSearchParams=webidl.interfaceConverter(URLSearchParams),webidl.converters.XMLHttpRequestBodyInit=function(e,t,r){return"string"==typeof e?webidl.converters.USVString(e,t,r):isBlobLike(e)?webidl.converters.Blob(e,t,r,{strict:!1}):ArrayBuffer.isView(e)||types.isArrayBuffer(e)?webidl.converters.BufferSource(e,t,r):util.isFormDataLike(e)?webidl.converters.FormData(e,t,r,{strict:!1}):e instanceof URLSearchParams?webidl.converters.URLSearchParams(e,t,r):webidl.converters.DOMString(e,t,r)},webidl.converters.BodyInit=function(e,t,r){return e instanceof ReadableStream?webidl.converters.ReadableStream(e,t,r):e?.[Symbol.asyncIterator]?e:webidl.converters.XMLHttpRequestBodyInit(e,t,r)},webidl.converters.ResponseInit=webidl.dictionaryConverter([{key:"status",converter:webidl.converters["unsigned short"],defaultValue:()=>200},{key:"statusText",converter:webidl.converters.ByteString,defaultValue:()=>""},{key:"headers",converter:webidl.converters.HeadersInit}]),module.exports={isNetworkError:isNetworkError,makeNetworkError:makeNetworkError,makeResponse:makeResponse,makeAppropriateNetworkError:makeAppropriateNetworkError,filterResponse:filterResponse,Response:Response,cloneResponse:cloneResponse,fromInnerResponse:fromInnerResponse};