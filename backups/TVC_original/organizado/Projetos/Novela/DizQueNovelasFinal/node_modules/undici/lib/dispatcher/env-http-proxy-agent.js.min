"use strict";const DispatcherBase=require("./dispatcher-base"),{kClose:kClose,kDestroy:kDestroy,kClosed:kClosed,kDestroyed:kDestroyed,kDispatch:kDispatch,kNoProxyAgent:kNoProxyAgent,kHttpProxyAgent:kHttpProxyAgent,kHttpsProxyAgent:kHttpsProxyAgent}=require("../core/symbols"),ProxyAgent=require("./proxy-agent"),Agent=require("./agent"),DEFAULT_PORTS={"http:":80,"https:":443};let experimentalWarned=!1;class EnvHttpProxyAgent extends DispatcherBase{#t=null;#e=null;#o=null;constructor(t={}){super(),this.#o=t,experimentalWarned||(experimentalWarned=!0,process.emitWarning("EnvHttpProxyAgent is experimental, expect them to change at any time.",{code:"UNDICI-EHPA"}));const{httpProxy:e,httpsProxy:o,noProxy:r,...s}=t;this[kNoProxyAgent]=new Agent(s);const n=e??process.env.http_proxy??process.env.HTTP_PROXY;this[kHttpProxyAgent]=n?new ProxyAgent({...s,uri:n}):this[kNoProxyAgent];const i=o??process.env.https_proxy??process.env.HTTPS_PROXY;this[kHttpsProxyAgent]=i?new ProxyAgent({...s,uri:i}):this[kHttpProxyAgent],this.#r()}[kDispatch](t,e){const o=new URL(t.origin);return this.#s(o).dispatch(t,e)}async[kClose](){await this[kNoProxyAgent].close(),this[kHttpProxyAgent][kClosed]||await this[kHttpProxyAgent].close(),this[kHttpsProxyAgent][kClosed]||await this[kHttpsProxyAgent].close()}async[kDestroy](t){await this[kNoProxyAgent].destroy(t),this[kHttpProxyAgent][kDestroyed]||await this[kHttpProxyAgent].destroy(t),this[kHttpsProxyAgent][kDestroyed]||await this[kHttpsProxyAgent].destroy(t)}#s(t){let{protocol:e,host:o,port:r}=t;return o=o.replace(/:\d*$/,"").toLowerCase(),r=Number.parseInt(r,10)||DEFAULT_PORTS[e]||0,this.#n(o,r)?"https:"===e?this[kHttpsProxyAgent]:this[kHttpProxyAgent]:this[kNoProxyAgent]}#n(t,e){if(this.#i&&this.#r(),0===this.#e.length)return!0;if("*"===this.#t)return!1;for(let o=0;o<this.#e.length;o++){const r=this.#e[o];if(!r.port||r.port===e)if(/^[.*]/.test(r.hostname)){if(t.endsWith(r.hostname.replace(/^\*/,"")))return!1}else if(t===r.hostname)return!1}return!0}#r(){const t=this.#o.noProxy??this.#y,e=t.split(/[,\s]/),o=[];for(let t=0;t<e.length;t++){const r=e[t];if(!r)continue;const s=r.match(/^(.+):(\d+)$/);o.push({hostname:(s?s[1]:r).toLowerCase(),port:s?Number.parseInt(s[2],10):0})}this.#t=t,this.#e=o}get#i(){return void 0===this.#o.noProxy&&this.#t!==this.#y}get#y(){return process.env.no_proxy??process.env.NO_PROXY??""}}module.exports=EnvHttpProxyAgent;