"use strict";const{Writable:Writable}=require("node:stream"),assert=require("node:assert"),{parserStates:parserStates,opcodes:opcodes,states:states,emptyBuffer:emptyBuffer,sentCloseFrameState:sentCloseFrameState}=require("./constants"),{kReadyState:kReadyState,kSentClose:kSentClose,kResponse:kResponse,kReceivedClose:kReceivedClose}=require("./symbols"),{channels:channels}=require("../../core/diagnostics"),{isValidStatusCode:isValidStatusCode,isValidOpcode:isValidOpcode,failWebsocketConnection:failWebsocketConnection,websocketMessageReceived:websocketMessageReceived,utf8Decode:utf8Decode,isControlFrame:isControlFrame,isTextBinaryFrame:isTextBinaryFrame,isContinuationFrame:isContinuationFrame}=require("./util"),{WebsocketFrameSend:WebsocketFrameSend}=require("./frame"),{closeWebSocketConnection:closeWebSocketConnection}=require("./connection"),{PerMessageDeflate:PerMessageDeflate}=require("./permessage-deflate");class ByteParser extends Writable{#e=[];#t=0;#s=!1;#i=parserStates.INFO;#o={};#n=[];#r;constructor(e,t){super(),this.ws=e,this.#r=null==t?new Map:t,this.#r.has("permessage-deflate")&&this.#r.set("permessage-deflate",new PerMessageDeflate(t))}_write(e,t,s){this.#e.push(e),this.#t+=e.length,this.#s=!0,this.run(s)}run(e){for(;this.#s;)if(this.#i===parserStates.INFO){if(this.#t<2)return e();const t=this.consume(2),s=!!(128&t[0]),i=15&t[0],o=!(128&~t[1]),n=!s&&i!==opcodes.CONTINUATION,r=127&t[1],a=64&t[0],f=32&t[0],c=16&t[0];if(!isValidOpcode(i))return failWebsocketConnection(this.ws,"Invalid opcode received"),e();if(o)return failWebsocketConnection(this.ws,"Frame cannot be masked"),e();if(0!==a&&!this.#r.has("permessage-deflate"))return void failWebsocketConnection(this.ws,"Expected RSV1 to be clear.");if(0!==f||0!==c)return void failWebsocketConnection(this.ws,"RSV1, RSV2, RSV3 must be clear");if(n&&!isTextBinaryFrame(i))return void failWebsocketConnection(this.ws,"Invalid frame type was fragmented.");if(isTextBinaryFrame(i)&&this.#n.length>0)return void failWebsocketConnection(this.ws,"Expected continuation frame");if(this.#o.fragmented&&n)return void failWebsocketConnection(this.ws,"Fragmented frame exceeded 125 bytes.");if((r>125||n)&&isControlFrame(i))return void failWebsocketConnection(this.ws,"Control frame either too large or fragmented");if(isContinuationFrame(i)&&0===this.#n.length&&!this.#o.compressed)return void failWebsocketConnection(this.ws,"Unexpected continuation frame");r<=125?(this.#o.payloadLength=r,this.#i=parserStates.READ_DATA):126===r?this.#i=parserStates.PAYLOADLENGTH_16:127===r&&(this.#i=parserStates.PAYLOADLENGTH_64),isTextBinaryFrame(i)&&(this.#o.binaryType=i,this.#o.compressed=0!==a),this.#o.opcode=i,this.#o.masked=o,this.#o.fin=s,this.#o.fragmented=n}else if(this.#i===parserStates.PAYLOADLENGTH_16){if(this.#t<2)return e();const t=this.consume(2);this.#o.payloadLength=t.readUInt16BE(0),this.#i=parserStates.READ_DATA}else if(this.#i===parserStates.PAYLOADLENGTH_64){if(this.#t<8)return e();const t=this.consume(8),s=t.readUInt32BE(0);if(s>2**31-1)return void failWebsocketConnection(this.ws,"Received payload length > 2^31 bytes.");const i=t.readUInt32BE(4);this.#o.payloadLength=(s<<8)+i,this.#i=parserStates.READ_DATA}else if(this.#i===parserStates.READ_DATA){if(this.#t<this.#o.payloadLength)return e();const t=this.consume(this.#o.payloadLength);if(isControlFrame(this.#o.opcode))this.#s=this.parseControlFrame(t),this.#i=parserStates.INFO;else{if(this.#o.compressed){this.#r.get("permessage-deflate").decompress(t,this.#o.fin,(t,s)=>{if(t)closeWebSocketConnection(this.ws,1007,t.message,t.message.length);else{if(this.#n.push(s),!this.#o.fin)return this.#i=parserStates.INFO,this.#s=!0,void this.run(e);websocketMessageReceived(this.ws,this.#o.binaryType,Buffer.concat(this.#n)),this.#s=!0,this.#i=parserStates.INFO,this.#n.length=0,this.run(e)}}),this.#s=!1;break}if(this.#n.push(t),!this.#o.fragmented&&this.#o.fin){const e=Buffer.concat(this.#n);websocketMessageReceived(this.ws,this.#o.binaryType,e),this.#n.length=0}this.#i=parserStates.INFO}}}consume(e){if(e>this.#t)throw new Error("Called consume() before buffers satiated.");if(0===e)return emptyBuffer;if(this.#e[0].length===e)return this.#t-=this.#e[0].length,this.#e.shift();const t=Buffer.allocUnsafe(e);let s=0;for(;s!==e;){const i=this.#e[0],{length:o}=i;if(o+s===e){t.set(this.#e.shift(),s);break}if(o+s>e){t.set(i.subarray(0,e-s),s),this.#e[0]=i.subarray(e-s);break}t.set(this.#e.shift(),s),s+=i.length}return this.#t-=e,t}parseCloseBody(e){let t;if(assert(1!==e.length),e.length>=2&&(t=e.readUInt16BE(0)),void 0!==t&&!isValidStatusCode(t))return{code:1002,reason:"Invalid status code",error:!0};let s=e.subarray(2);239===s[0]&&187===s[1]&&191===s[2]&&(s=s.subarray(3));try{s=utf8Decode(s)}catch{return{code:1007,reason:"Invalid UTF-8",error:!0}}return{code:t,reason:s,error:!1}}parseControlFrame(e){const{opcode:t,payloadLength:s}=this.#o;if(t===opcodes.CLOSE){if(1===s)return failWebsocketConnection(this.ws,"Received close frame with a 1-byte body."),!1;if(this.#o.closeInfo=this.parseCloseBody(e),this.#o.closeInfo.error){const{code:e,reason:t}=this.#o.closeInfo;return closeWebSocketConnection(this.ws,e,t,t.length),failWebsocketConnection(this.ws,t),!1}if(this.ws[kSentClose]!==sentCloseFrameState.SENT){let e=emptyBuffer;this.#o.closeInfo.code&&(e=Buffer.allocUnsafe(2),e.writeUInt16BE(this.#o.closeInfo.code,0));const t=new WebsocketFrameSend(e);this.ws[kResponse].socket.write(t.createFrame(opcodes.CLOSE),e=>{e||(this.ws[kSentClose]=sentCloseFrameState.SENT)})}return this.ws[kReadyState]=states.CLOSING,this.ws[kReceivedClose]=!0,!1}if(t===opcodes.PING){if(!this.ws[kReceivedClose]){const t=new WebsocketFrameSend(e);this.ws[kResponse].socket.write(t.createFrame(opcodes.PONG)),channels.ping.hasSubscribers&&channels.ping.publish({payload:e})}}else t===opcodes.PONG&&channels.pong.hasSubscribers&&channels.pong.publish({payload:e});return!0}get closingInfo(){return this.#o.closeInfo}}module.exports={ByteParser:ByteParser};