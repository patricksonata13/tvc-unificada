"use strict";const{kConstruct:kConstruct}=require("../../core/symbols"),{kEnumerableProperty:kEnumerableProperty}=require("../../core/util"),{iteratorMixin:iteratorMixin,isValidHeaderName:isValidHeaderName,isValidHeaderValue:isValidHeaderValue}=require("./util"),{webidl:webidl}=require("./webidl"),assert=require("node:assert"),util=require("node:util"),kHeadersMap=Symbol("headers map"),kHeadersSortedMap=Symbol("headers map sorted");function isHTTPWhiteSpaceCharCode(e){return 10===e||13===e||9===e||32===e}function headerValueNormalize(e){let r=0,t=e.length;for(;t>r&&isHTTPWhiteSpaceCharCode(e.charCodeAt(t-1));)--t;for(;t>r&&isHTTPWhiteSpaceCharCode(e.charCodeAt(r));)++r;return 0===r&&t===e.length?e:e.substring(r,t)}function fill(e,r){if(Array.isArray(r))for(let t=0;t<r.length;++t){const s=r[t];if(2!==s.length)throw webidl.errors.exception({header:"Headers constructor",message:`expected name/value pair to be length 2, found ${s.length}.`});appendHeader(e,s[0],s[1])}else{if("object"!=typeof r||null===r)throw webidl.errors.conversionFailed({prefix:"Headers constructor",argument:"Argument 1",types:["sequence<sequence<ByteString>>","record<ByteString, ByteString>"]});{const t=Object.keys(r);for(let s=0;s<t.length;++s)appendHeader(e,t[s],r[t[s]])}}}function appendHeader(e,r,t){if(t=headerValueNormalize(t),!isValidHeaderName(r))throw webidl.errors.invalidArgument({prefix:"Headers.append",value:r,type:"header name"});if(!isValidHeaderValue(t))throw webidl.errors.invalidArgument({prefix:"Headers.append",value:t,type:"header value"});if("immutable"===getHeadersGuard(e))throw new TypeError("immutable");return getHeadersList(e).append(r,t,!1)}function compareHeaderName(e,r){return e[0]<r[0]?-1:1}class HeadersList{cookies=null;constructor(e){e instanceof HeadersList?(this[kHeadersMap]=new Map(e[kHeadersMap]),this[kHeadersSortedMap]=e[kHeadersSortedMap],this.cookies=null===e.cookies?null:[...e.cookies]):(this[kHeadersMap]=new Map(e),this[kHeadersSortedMap]=null)}contains(e,r){return this[kHeadersMap].has(r?e:e.toLowerCase())}clear(){this[kHeadersMap].clear(),this[kHeadersSortedMap]=null,this.cookies=null}append(e,r,t){this[kHeadersSortedMap]=null;const s=t?e:e.toLowerCase(),a=this[kHeadersMap].get(s);if(a){const e="cookie"===s?"; ":", ";this[kHeadersMap].set(s,{name:a.name,value:`${a.value}${e}${r}`})}else this[kHeadersMap].set(s,{name:e,value:r});"set-cookie"===s&&(this.cookies??=[]).push(r)}set(e,r,t){this[kHeadersSortedMap]=null;const s=t?e:e.toLowerCase();"set-cookie"===s&&(this.cookies=[r]),this[kHeadersMap].set(s,{name:e,value:r})}delete(e,r){this[kHeadersSortedMap]=null,r||(e=e.toLowerCase()),"set-cookie"===e&&(this.cookies=null),this[kHeadersMap].delete(e)}get(e,r){return this[kHeadersMap].get(r?e:e.toLowerCase())?.value??null}*[Symbol.iterator](){for(const{0:e,1:{value:r}}of this[kHeadersMap])yield[e,r]}get entries(){const e={};if(0!==this[kHeadersMap].size)for(const{name:r,value:t}of this[kHeadersMap].values())e[r]=t;return e}rawValues(){return this[kHeadersMap].values()}get entriesList(){const e=[];if(0!==this[kHeadersMap].size)for(const{0:r,1:{name:t,value:s}}of this[kHeadersMap])if("set-cookie"===r)for(const r of this.cookies)e.push([t,r]);else e.push([t,s]);return e}toSortedArray(){const e=this[kHeadersMap].size,r=new Array(e);if(e<=32){if(0===e)return r;const t=this[kHeadersMap][Symbol.iterator](),s=t.next().value;r[0]=[s[0],s[1].value],assert(null!==s[1].value);for(let s,a,i=1,d=0,n=0,o=0,l=0;i<e;++i){for(a=t.next().value,s=r[i]=[a[0],a[1].value],assert(null!==s[1]),o=0,n=i;o<n;)l=o+(n-o>>1),r[l][0]<=s[0]?o=l+1:n=l;if(i!==l){for(d=i;d>o;)r[d]=r[--d];r[o]=s}}if(!t.next().done)throw new TypeError("Unreachable");return r}{let e=0;for(const{0:t,1:{value:s}}of this[kHeadersMap])r[e++]=[t,s],assert(null!==s);return r.sort(compareHeaderName)}}}class Headers{#e;#r;constructor(e=void 0){webidl.util.markAsUncloneable(this),e!==kConstruct&&(this.#r=new HeadersList,this.#e="none",void 0!==e&&fill(this,e=webidl.converters.HeadersInit(e,"Headers contructor","init")))}append(e,r){webidl.brandCheck(this,Headers),webidl.argumentLengthCheck(arguments,2,"Headers.append");const t="Headers.append";return appendHeader(this,e=webidl.converters.ByteString(e,t,"name"),r=webidl.converters.ByteString(r,t,"value"))}delete(e){webidl.brandCheck(this,Headers),webidl.argumentLengthCheck(arguments,1,"Headers.delete");if(e=webidl.converters.ByteString(e,"Headers.delete","name"),!isValidHeaderName(e))throw webidl.errors.invalidArgument({prefix:"Headers.delete",value:e,type:"header name"});if("immutable"===this.#e)throw new TypeError("immutable");this.#r.contains(e,!1)&&this.#r.delete(e,!1)}get(e){webidl.brandCheck(this,Headers),webidl.argumentLengthCheck(arguments,1,"Headers.get");const r="Headers.get";if(e=webidl.converters.ByteString(e,r,"name"),!isValidHeaderName(e))throw webidl.errors.invalidArgument({prefix:r,value:e,type:"header name"});return this.#r.get(e,!1)}has(e){webidl.brandCheck(this,Headers),webidl.argumentLengthCheck(arguments,1,"Headers.has");const r="Headers.has";if(e=webidl.converters.ByteString(e,r,"name"),!isValidHeaderName(e))throw webidl.errors.invalidArgument({prefix:r,value:e,type:"header name"});return this.#r.contains(e,!1)}set(e,r){webidl.brandCheck(this,Headers),webidl.argumentLengthCheck(arguments,2,"Headers.set");const t="Headers.set";if(e=webidl.converters.ByteString(e,t,"name"),r=headerValueNormalize(r=webidl.converters.ByteString(r,t,"value")),!isValidHeaderName(e))throw webidl.errors.invalidArgument({prefix:t,value:e,type:"header name"});if(!isValidHeaderValue(r))throw webidl.errors.invalidArgument({prefix:t,value:r,type:"header value"});if("immutable"===this.#e)throw new TypeError("immutable");this.#r.set(e,r,!1)}getSetCookie(){webidl.brandCheck(this,Headers);const e=this.#r.cookies;return e?[...e]:[]}get[kHeadersSortedMap](){if(this.#r[kHeadersSortedMap])return this.#r[kHeadersSortedMap];const e=[],r=this.#r.toSortedArray(),t=this.#r.cookies;if(null===t||1===t.length)return this.#r[kHeadersSortedMap]=r;for(let s=0;s<r.length;++s){const{0:a,1:i}=r[s];if("set-cookie"===a)for(let r=0;r<t.length;++r)e.push([a,t[r]]);else e.push([a,i])}return this.#r[kHeadersSortedMap]=e}[util.inspect.custom](e,r){return r.depth??=e,`Headers ${util.formatWithOptions(r,this.#r.entries)}`}static getHeadersGuard(e){return e.#e}static setHeadersGuard(e,r){e.#e=r}static getHeadersList(e){return e.#r}static setHeadersList(e,r){e.#r=r}}const{getHeadersGuard:getHeadersGuard,setHeadersGuard:setHeadersGuard,getHeadersList:getHeadersList,setHeadersList:setHeadersList}=Headers;Reflect.deleteProperty(Headers,"getHeadersGuard"),Reflect.deleteProperty(Headers,"setHeadersGuard"),Reflect.deleteProperty(Headers,"getHeadersList"),Reflect.deleteProperty(Headers,"setHeadersList"),iteratorMixin("Headers",Headers,kHeadersSortedMap,0,1),Object.defineProperties(Headers.prototype,{append:kEnumerableProperty,delete:kEnumerableProperty,get:kEnumerableProperty,has:kEnumerableProperty,set:kEnumerableProperty,getSetCookie:kEnumerableProperty,[Symbol.toStringTag]:{value:"Headers",configurable:!0},[util.inspect.custom]:{enumerable:!1}}),webidl.converters.HeadersInit=function(e,r,t){if("Object"===webidl.util.Type(e)){const s=Reflect.get(e,Symbol.iterator);if(!util.types.isProxy(e)&&s===Headers.prototype.entries)try{return getHeadersList(e).entriesList}catch{}return"function"==typeof s?webidl.converters["sequence<sequence<ByteString>>"](e,r,t,s.bind(e)):webidl.converters["record<ByteString, ByteString>"](e,r,t)}throw webidl.errors.conversionFailed({prefix:"Headers constructor",argument:"Argument 1",types:["sequence<sequence<ByteString>>","record<ByteString, ByteString>"]})},module.exports={fill:fill,compareHeaderName:compareHeaderName,Headers:Headers,HeadersList:HeadersList,getHeadersGuard:getHeadersGuard,setHeadersGuard:setHeadersGuard,setHeadersList:setHeadersList,getHeadersList:getHeadersList};