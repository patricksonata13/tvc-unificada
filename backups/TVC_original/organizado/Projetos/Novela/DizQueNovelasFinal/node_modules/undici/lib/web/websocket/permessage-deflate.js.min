"use strict";const{createInflateRaw:createInflateRaw,Z_DEFAULT_WINDOWBITS:Z_DEFAULT_WINDOWBITS}=require("node:zlib"),{isValidClientWindowBits:isValidClientWindowBits}=require("./util"),tail=Buffer.from([0,0,255,255]),kBuffer=Symbol("kBuffer"),kLength=Symbol("kLength");class PerMessageDeflate{#e;#t={};constructor(e){this.#t.serverNoContextTakeover=e.has("server_no_context_takeover"),this.#t.serverMaxWindowBits=e.get("server_max_window_bits")}decompress(e,t,i){if(!this.#e){let e=Z_DEFAULT_WINDOWBITS;if(this.#t.serverMaxWindowBits){if(!isValidClientWindowBits(this.#t.serverMaxWindowBits))return void i(new Error("Invalid server_max_window_bits"));e=Number.parseInt(this.#t.serverMaxWindowBits)}this.#e=createInflateRaw({windowBits:e}),this.#e[kBuffer]=[],this.#e[kLength]=0,this.#e.on("data",e=>{this.#e[kBuffer].push(e),this.#e[kLength]+=e.length}),this.#e.on("error",e=>{this.#e=null,i(e)})}this.#e.write(e),t&&this.#e.write(tail),this.#e.flush(()=>{const e=Buffer.concat(this.#e[kBuffer],this.#e[kLength]);this.#e[kBuffer].length=0,this.#e[kLength]=0,i(null,e)})}}module.exports={PerMessageDeflate:PerMessageDeflate};