"use strict";const util=require("../../core/util"),{ReadableStreamFrom:ReadableStreamFrom,isBlobLike:isBlobLike,isReadableStreamLike:isReadableStreamLike,readableStreamClose:readableStreamClose,createDeferredPromise:createDeferredPromise,fullyReadBody:fullyReadBody,extractMimeType:extractMimeType,utf8DecodeBytes:utf8DecodeBytes}=require("./util"),{FormData:FormData}=require("./formdata"),{kState:kState}=require("./symbols"),{webidl:webidl}=require("./webidl"),{Blob:Blob}=require("node:buffer"),assert=require("node:assert"),{isErrored:isErrored,isDisturbed:isDisturbed}=require("node:stream"),{isArrayBuffer:isArrayBuffer}=require("node:util/types"),{serializeAMimeType:serializeAMimeType}=require("./data-url"),{multipartFormDataParser:multipartFormDataParser}=require("./formdata-parser");let random;try{const e=require("node:crypto");random=t=>e.randomInt(0,t)}catch{random=e=>Math.floor(Math.random(e))}const textEncoder=new TextEncoder;function noop(){}const hasFinalizationRegistry=globalThis.FinalizationRegistry&&0!==process.version.indexOf("v18");let streamRegistry;function extractBody(e,t=!1){let r=null;r=e instanceof ReadableStream?e:isBlobLike(e)?e.stream():new ReadableStream({async pull(e){const t="string"==typeof o?textEncoder.encode(o):o;t.byteLength&&e.enqueue(t),queueMicrotask(()=>readableStreamClose(e))},start(){},type:"bytes"}),assert(isReadableStreamLike(r));let a=null,o=null,n=null,s=null;if("string"==typeof e)o=e,s="text/plain;charset=UTF-8";else if(e instanceof URLSearchParams)o=e.toString(),s="application/x-www-form-urlencoded;charset=UTF-8";else if(isArrayBuffer(e))o=new Uint8Array(e.slice());else if(ArrayBuffer.isView(e))o=new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));else if(util.isFormDataLike(e)){const t=`----formdata-undici-0${`${random(1e11)}`.padStart(11,"0")}`,r=`--${t}\r\nContent-Disposition: form-data`
/*! formdata-polyfill. MIT License. Jimmy WÃ¤rting <https://jimmy.warting.se/opensource> */,i=e=>e.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22"),l=e=>e.replace(/\r?\n|\r/g,"\r\n"),d=[],c=new Uint8Array([13,10]);n=0;let u=!1;for(const[t,a]of e)if("string"==typeof a){const e=textEncoder.encode(r+`; name="${i(l(t))}"`+`\r\n\r\n${l(a)}\r\n`);d.push(e),n+=e.byteLength}else{const e=textEncoder.encode(`${r}; name="${i(l(t))}"`+(a.name?`; filename="${i(a.name)}"`:"")+"\r\n"+`Content-Type: ${a.type||"application/octet-stream"}\r\n\r\n`);d.push(e,a,c),"number"==typeof a.size?n+=e.byteLength+a.size+c.byteLength:u=!0}const y=textEncoder.encode(`--${t}--\r\n`);d.push(y),n+=y.byteLength,u&&(n=null),o=e,a=async function*(){for(const e of d)e.stream?yield*e.stream():yield e},s=`multipart/form-data; boundary=${t}`}else if(isBlobLike(e))o=e,n=e.size,e.type&&(s=e.type);else if("function"==typeof e[Symbol.asyncIterator]){if(t)throw new TypeError("keepalive");if(util.isDisturbed(e)||e.locked)throw new TypeError("Response body object should not be disturbed or locked");r=e instanceof ReadableStream?e:ReadableStreamFrom(e)}if(("string"==typeof o||util.isBuffer(o))&&(n=Buffer.byteLength(o)),null!=a){let t;r=new ReadableStream({async start(){t=a(e)[Symbol.asyncIterator]()},async pull(e){const{value:a,done:o}=await t.next();if(o)queueMicrotask(()=>{e.close(),e.byobRequest?.respond(0)});else if(!isErrored(r)){const t=new Uint8Array(a);t.byteLength&&e.enqueue(t)}return e.desiredSize>0},async cancel(e){await t.return()},type:"bytes"})}return[{stream:r,source:o,length:n},s]}function safelyExtractBody(e,t=!1){return e instanceof ReadableStream&&(assert(!util.isDisturbed(e),"The body has already been consumed."),assert(!e.locked,"The stream is locked.")),extractBody(e,t)}function cloneBody(e,t){const[r,a]=t.stream.tee();return t.stream=r,{stream:a,length:t.length,source:t.source}}function throwIfAborted(e){if(e.aborted)throw new DOMException("The operation was aborted.","AbortError")}function bodyMixinMethods(e){return{blob(){return consumeBody(this,e=>{let t=bodyMimeType(this);return null===t?t="":t&&(t=serializeAMimeType(t)),new Blob([e],{type:t})},e)},arrayBuffer(){return consumeBody(this,e=>new Uint8Array(e).buffer,e)},text(){return consumeBody(this,utf8DecodeBytes,e)},json(){return consumeBody(this,parseJSONFromBytes,e)},formData(){return consumeBody(this,e=>{const t=bodyMimeType(this);if(null!==t)switch(t.essence){case"multipart/form-data":{const r=multipartFormDataParser(e,t);if("failure"===r)throw new TypeError("Failed to parse body as FormData.");const a=new FormData;return a[kState]=r,a}case"application/x-www-form-urlencoded":{const t=new URLSearchParams(e.toString()),r=new FormData;for(const[e,a]of t)r.append(e,a);return r}}throw new TypeError('Content-Type was not one of "multipart/form-data" or "application/x-www-form-urlencoded".')},e)},bytes(){return consumeBody(this,e=>new Uint8Array(e),e)}}}function mixinBody(e){Object.assign(e.prototype,bodyMixinMethods(e))}async function consumeBody(e,t,r){if(webidl.brandCheck(e,r),bodyUnusable(e))throw new TypeError("Body is unusable: Body has already been read");throwIfAborted(e[kState]);const a=createDeferredPromise(),o=e=>a.reject(e),n=e=>{try{a.resolve(t(e))}catch(e){o(e)}};return null==e[kState].body?(n(Buffer.allocUnsafe(0)),a.promise):(await fullyReadBody(e[kState].body,n,o),a.promise)}function bodyUnusable(e){const t=e[kState].body;return null!=t&&(t.stream.locked||util.isDisturbed(t.stream))}function parseJSONFromBytes(e){return JSON.parse(utf8DecodeBytes(e))}function bodyMimeType(e){const t=e[kState].headersList,r=extractMimeType(t);return"failure"===r?null:r}hasFinalizationRegistry&&(streamRegistry=new FinalizationRegistry(e=>{const t=e.deref();!t||t.locked||isDisturbed(t)||isErrored(t)||t.cancel("Response object has been garbage collected").catch(noop)})),module.exports={extractBody:extractBody,safelyExtractBody:safelyExtractBody,cloneBody:cloneBody,mixinBody:mixinBody,streamRegistry:streamRegistry,hasFinalizationRegistry:hasFinalizationRegistry,bodyUnusable:bodyUnusable};