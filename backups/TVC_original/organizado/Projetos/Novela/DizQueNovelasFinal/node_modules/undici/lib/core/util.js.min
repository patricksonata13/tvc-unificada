"use strict";const assert=require("node:assert"),{kDestroyed:kDestroyed,kBodyUsed:kBodyUsed,kListeners:kListeners,kBody:kBody}=require("./symbols"),{IncomingMessage:IncomingMessage}=require("node:http"),stream=require("node:stream"),net=require("node:net"),{Blob:Blob}=require("node:buffer"),nodeUtil=require("node:util"),{stringify:stringify}=require("node:querystring"),{EventEmitter:EE}=require("node:events"),{InvalidArgumentError:InvalidArgumentError}=require("./errors"),{headerNameLowerCasedRecord:headerNameLowerCasedRecord}=require("./constants"),{tree:tree}=require("./tree"),[nodeMajor,nodeMinor]=process.versions.node.split(".").map(e=>Number(e));class BodyAsyncIterable{constructor(e){this[kBody]=e,this[kBodyUsed]=!1}async*[Symbol.asyncIterator](){assert(!this[kBodyUsed],"disturbed"),this[kBodyUsed]=!0,yield*this[kBody]}}function wrapRequestBody(e){return isStream(e)?(0===bodyLength(e)&&e.on("data",function(){assert(!1)}),"boolean"!=typeof e.readableDidRead&&(e[kBodyUsed]=!1,EE.prototype.on.call(e,"data",function(){this[kBodyUsed]=!0})),e):e&&"function"==typeof e.pipeTo||e&&"string"!=typeof e&&!ArrayBuffer.isView(e)&&isIterable(e)?new BodyAsyncIterable(e):e}function nop(){}function isStream(e){return e&&"object"==typeof e&&"function"==typeof e.pipe&&"function"==typeof e.on}function isBlobLike(e){if(null===e)return!1;if(e instanceof Blob)return!0;if("object"!=typeof e)return!1;{const t=e[Symbol.toStringTag];return("Blob"===t||"File"===t)&&("stream"in e&&"function"==typeof e.stream||"arrayBuffer"in e&&"function"==typeof e.arrayBuffer)}}function buildURL(e,t){if(e.includes("?")||e.includes("#"))throw new Error('Query params cannot be passed when url already contains "?" or "#".');const r=stringify(t);return r&&(e+="?"+r),e}function isValidPort(e){const t=parseInt(e,10);return t===Number(e)&&t>=0&&t<=65535}function isHttpOrHttpsPrefixed(e){return null!=e&&"h"===e[0]&&"t"===e[1]&&"t"===e[2]&&"p"===e[3]&&(":"===e[4]||"s"===e[4]&&":"===e[5])}function parseURL(e){if("string"==typeof e){if(!isHttpOrHttpsPrefixed((e=new URL(e)).origin||e.protocol))throw new InvalidArgumentError("Invalid URL protocol: the URL must start with `http:` or `https:`.");return e}if(!e||"object"!=typeof e)throw new InvalidArgumentError("Invalid URL: The URL argument must be a non-null object.");if(!(e instanceof URL)){if(null!=e.port&&""!==e.port&&!1===isValidPort(e.port))throw new InvalidArgumentError("Invalid URL: port must be a valid integer or a string representation of an integer.");if(null!=e.path&&"string"!=typeof e.path)throw new InvalidArgumentError("Invalid URL path: the path must be a string or null/undefined.");if(null!=e.pathname&&"string"!=typeof e.pathname)throw new InvalidArgumentError("Invalid URL pathname: the pathname must be a string or null/undefined.");if(null!=e.hostname&&"string"!=typeof e.hostname)throw new InvalidArgumentError("Invalid URL hostname: the hostname must be a string or null/undefined.");if(null!=e.origin&&"string"!=typeof e.origin)throw new InvalidArgumentError("Invalid URL origin: the origin must be a string or null/undefined.");if(!isHttpOrHttpsPrefixed(e.origin||e.protocol))throw new InvalidArgumentError("Invalid URL protocol: the URL must start with `http:` or `https:`.");const t=null!=e.port?e.port:"https:"===e.protocol?443:80;let r=null!=e.origin?e.origin:`${e.protocol||""}//${e.hostname||""}:${t}`,n=null!=e.path?e.path:`${e.pathname||""}${e.search||""}`;return"/"===r[r.length-1]&&(r=r.slice(0,r.length-1)),n&&"/"!==n[0]&&(n=`/${n}`),new URL(`${r}${n}`)}if(!isHttpOrHttpsPrefixed(e.origin||e.protocol))throw new InvalidArgumentError("Invalid URL protocol: the URL must start with `http:` or `https:`.");return e}function parseOrigin(e){if("/"!==(e=parseURL(e)).pathname||e.search||e.hash)throw new InvalidArgumentError("invalid url");return e}function getHostname(e){if("["===e[0]){const t=e.indexOf("]");return assert(-1!==t),e.substring(1,t)}const t=e.indexOf(":");return-1===t?e:e.substring(0,t)}function getServerName(e){if(!e)return null;assert("string"==typeof e);const t=getHostname(e);return net.isIP(t)?"":t}function deepClone(e){return JSON.parse(JSON.stringify(e))}function isAsyncIterable(e){return!(null==e||"function"!=typeof e[Symbol.asyncIterator])}function isIterable(e){return!(null==e||"function"!=typeof e[Symbol.iterator]&&"function"!=typeof e[Symbol.asyncIterator])}function bodyLength(e){if(null==e)return 0;if(isStream(e)){const t=e._readableState;return t&&!1===t.objectMode&&!0===t.ended&&Number.isFinite(t.length)?t.length:null}return isBlobLike(e)?null!=e.size?e.size:null:isBuffer(e)?e.byteLength:null}function isDestroyed(e){return e&&!!(e.destroyed||e[kDestroyed]||stream.isDestroyed?.(e))}function destroy(e,t){null!=e&&isStream(e)&&!isDestroyed(e)&&("function"==typeof e.destroy?(Object.getPrototypeOf(e).constructor===IncomingMessage&&(e.socket=null),e.destroy(t)):t&&queueMicrotask(()=>{e.emit("error",t)}),!0!==e.destroyed&&(e[kDestroyed]=!0))}const KEEPALIVE_TIMEOUT_EXPR=/timeout=(\d+)/;function parseKeepAliveTimeout(e){const t=e.toString().match(KEEPALIVE_TIMEOUT_EXPR);return t?1e3*parseInt(t[1],10):null}function headerNameToString(e){return"string"==typeof e?headerNameLowerCasedRecord[e]??e.toLowerCase():tree.lookup(e)??e.toString("latin1").toLowerCase()}function bufferToLowerCasedHeaderName(e){return tree.lookup(e)??e.toString("latin1").toLowerCase()}function parseHeaders(e,t){void 0===t&&(t={});for(let r=0;r<e.length;r+=2){const n=headerNameToString(e[r]);let o=t[n];if(o)"string"==typeof o&&(o=[o],t[n]=o),o.push(e[r+1].toString("utf8"));else{const o=e[r+1];t[n]="string"==typeof o?o:Array.isArray(o)?o.map(e=>e.toString("utf8")):o.toString("utf8")}}return"content-length"in t&&"content-disposition"in t&&(t["content-disposition"]=Buffer.from(t["content-disposition"]).toString("latin1")),t}function parseRawHeaders(e){const t=e.length,r=new Array(t);let n,o,i=!1,s=-1,a=0;for(let t=0;t<e.length;t+=2)n=e[t],o=e[t+1],"string"!=typeof n&&(n=n.toString()),"string"!=typeof o&&(o=o.toString("utf8")),a=n.length,14!==a||"-"!==n[7]||"content-length"!==n&&"content-length"!==n.toLowerCase()?19!==a||"-"!==n[7]||"content-disposition"!==n&&"content-disposition"!==n.toLowerCase()||(s=t+1):i=!0,r[t]=n,r[t+1]=o;return i&&-1!==s&&(r[s]=Buffer.from(r[s]).toString("latin1")),r}function isBuffer(e){return e instanceof Uint8Array||Buffer.isBuffer(e)}function validateHandler(e,t,r){if(!e||"object"!=typeof e)throw new InvalidArgumentError("handler must be an object");if("function"!=typeof e.onConnect)throw new InvalidArgumentError("invalid onConnect method");if("function"!=typeof e.onError)throw new InvalidArgumentError("invalid onError method");if("function"!=typeof e.onBodySent&&void 0!==e.onBodySent)throw new InvalidArgumentError("invalid onBodySent method");if(r||"CONNECT"===t){if("function"!=typeof e.onUpgrade)throw new InvalidArgumentError("invalid onUpgrade method")}else{if("function"!=typeof e.onHeaders)throw new InvalidArgumentError("invalid onHeaders method");if("function"!=typeof e.onData)throw new InvalidArgumentError("invalid onData method");if("function"!=typeof e.onComplete)throw new InvalidArgumentError("invalid onComplete method")}}function isDisturbed(e){return!(!e||!stream.isDisturbed(e)&&!e[kBodyUsed])}function isErrored(e){return!(!e||!stream.isErrored(e))}function isReadable(e){return!(!e||!stream.isReadable(e))}function getSocketInfo(e){return{localAddress:e.localAddress,localPort:e.localPort,remoteAddress:e.remoteAddress,remotePort:e.remotePort,remoteFamily:e.remoteFamily,timeout:e.timeout,bytesWritten:e.bytesWritten,bytesRead:e.bytesRead}}function ReadableStreamFrom(e){let t;return new ReadableStream({async start(){t=e[Symbol.asyncIterator]()},async pull(e){const{done:r,value:n}=await t.next();if(r)queueMicrotask(()=>{e.close(),e.byobRequest?.respond(0)});else{const t=Buffer.isBuffer(n)?n:Buffer.from(n);t.byteLength&&e.enqueue(new Uint8Array(t))}return e.desiredSize>0},async cancel(e){await t.return()},type:"bytes"})}function isFormDataLike(e){return e&&"object"==typeof e&&"function"==typeof e.append&&"function"==typeof e.delete&&"function"==typeof e.get&&"function"==typeof e.getAll&&"function"==typeof e.has&&"function"==typeof e.set&&"FormData"===e[Symbol.toStringTag]}function addAbortListener(e,t){return"addEventListener"in e?(e.addEventListener("abort",t,{once:!0}),()=>e.removeEventListener("abort",t)):(e.addListener("abort",t),()=>e.removeListener("abort",t))}const hasToWellFormed="function"==typeof String.prototype.toWellFormed,hasIsWellFormed="function"==typeof String.prototype.isWellFormed;function toUSVString(e){return hasToWellFormed?`${e}`.toWellFormed():nodeUtil.toUSVString(e)}function isUSVString(e){return hasIsWellFormed?`${e}`.isWellFormed():toUSVString(e)===`${e}`}function isTokenCharCode(e){switch(e){case 34:case 40:case 41:case 44:case 47:case 58:case 59:case 60:case 61:case 62:case 63:case 64:case 91:case 92:case 93:case 123:case 125:return!1;default:return e>=33&&e<=126}}function isValidHTTPToken(e){if(0===e.length)return!1;for(let t=0;t<e.length;++t)if(!isTokenCharCode(e.charCodeAt(t)))return!1;return!0}const headerCharRegex=/[^\t\x20-\x7e\x80-\xff]/;function isValidHeaderValue(e){return!headerCharRegex.test(e)}function parseRangeHeader(e){if(null==e||""===e)return{start:0,end:null,size:null};const t=e?e.match(/^bytes (\d+)-(\d+)\/(\d+)?$/):null;return t?{start:parseInt(t[1]),end:t[2]?parseInt(t[2]):null,size:t[3]?parseInt(t[3]):null}:null}function addListener(e,t,r){return(e[kListeners]??=[]).push([t,r]),e.on(t,r),e}function removeAllListeners(e){for(const[t,r]of e[kListeners]??[])e.removeListener(t,r);e[kListeners]=null}function errorRequest(e,t,r){try{t.onError(r),assert(t.aborted)}catch(r){e.emit("error",r)}}const kEnumerableProperty=Object.create(null);kEnumerableProperty.enumerable=!0;const normalizedMethodRecordsBase={delete:"DELETE",DELETE:"DELETE",get:"GET",GET:"GET",head:"HEAD",HEAD:"HEAD",options:"OPTIONS",OPTIONS:"OPTIONS",post:"POST",POST:"POST",put:"PUT",PUT:"PUT"},normalizedMethodRecords={...normalizedMethodRecordsBase,patch:"patch",PATCH:"PATCH"};Object.setPrototypeOf(normalizedMethodRecordsBase,null),Object.setPrototypeOf(normalizedMethodRecords,null),module.exports={kEnumerableProperty:kEnumerableProperty,nop:nop,isDisturbed:isDisturbed,isErrored:isErrored,isReadable:isReadable,toUSVString:toUSVString,isUSVString:isUSVString,isBlobLike:isBlobLike,parseOrigin:parseOrigin,parseURL:parseURL,getServerName:getServerName,isStream:isStream,isIterable:isIterable,isAsyncIterable:isAsyncIterable,isDestroyed:isDestroyed,headerNameToString:headerNameToString,bufferToLowerCasedHeaderName:bufferToLowerCasedHeaderName,addListener:addListener,removeAllListeners:removeAllListeners,errorRequest:errorRequest,parseRawHeaders:parseRawHeaders,parseHeaders:parseHeaders,parseKeepAliveTimeout:parseKeepAliveTimeout,destroy:destroy,bodyLength:bodyLength,deepClone:deepClone,ReadableStreamFrom:ReadableStreamFrom,isBuffer:isBuffer,validateHandler:validateHandler,getSocketInfo:getSocketInfo,isFormDataLike:isFormDataLike,buildURL:buildURL,addAbortListener:addAbortListener,isValidHTTPToken:isValidHTTPToken,isValidHeaderValue:isValidHeaderValue,isTokenCharCode:isTokenCharCode,parseRangeHeader:parseRangeHeader,normalizedMethodRecordsBase:normalizedMethodRecordsBase,normalizedMethodRecords:normalizedMethodRecords,isValidPort:isValidPort,isHttpOrHttpsPrefixed:isHttpOrHttpsPrefixed,nodeMajor:nodeMajor,nodeMinor:nodeMinor,safeHTTPMethods:["GET","HEAD","OPTIONS","TRACE"],wrapRequestBody:wrapRequestBody};