"use strict";const util=require("../core/util"),{kBodyUsed:kBodyUsed}=require("../core/symbols"),assert=require("node:assert"),{InvalidArgumentError:InvalidArgumentError}=require("../core/errors"),EE=require("node:events"),redirectableStatusCodes=[300,301,302,303,307,308],kBody=Symbol("body");class BodyAsyncIterable{constructor(t){this[kBody]=t,this[kBodyUsed]=!1}async*[Symbol.asyncIterator](){assert(!this[kBodyUsed],"disturbed"),this[kBodyUsed]=!0,yield*this[kBody]}}class RedirectHandler{constructor(t,e,o,s){if(null!=e&&(!Number.isInteger(e)||e<0))throw new InvalidArgumentError("maxRedirections must be a positive number");util.validateHandler(s,o.method,o.upgrade),this.dispatch=t,this.location=null,this.abort=null,this.opts={...o,maxRedirections:0},this.maxRedirections=e,this.handler=s,this.history=[],this.redirectionLimitReached=!1,util.isStream(this.opts.body)?(0===util.bodyLength(this.opts.body)&&this.opts.body.on("data",function(){assert(!1)}),"boolean"!=typeof this.opts.body.readableDidRead&&(this.opts.body[kBodyUsed]=!1,EE.prototype.on.call(this.opts.body,"data",function(){this[kBodyUsed]=!0}))):(this.opts.body&&"function"==typeof this.opts.body.pipeTo||this.opts.body&&"string"!=typeof this.opts.body&&!ArrayBuffer.isView(this.opts.body)&&util.isIterable(this.opts.body))&&(this.opts.body=new BodyAsyncIterable(this.opts.body))}onConnect(t){this.abort=t,this.handler.onConnect(t,{history:this.history})}onUpgrade(t,e,o){this.handler.onUpgrade(t,e,o)}onError(t){this.handler.onError(t)}onHeaders(t,e,o,s){if(this.location=this.history.length>=this.maxRedirections||util.isDisturbed(this.opts.body)?null:parseLocation(t,e),this.opts.throwOnMaxRedirect&&this.history.length>=this.maxRedirections)return this.request&&this.request.abort(new Error("max redirects")),this.redirectionLimitReached=!0,void this.abort(new Error("max redirects"));if(this.opts.origin&&this.history.push(new URL(this.opts.path,this.opts.origin)),!this.location)return this.handler.onHeaders(t,e,o,s);const{origin:i,pathname:r,search:n}=util.parseURL(new URL(this.location,this.opts.origin&&new URL(this.opts.path,this.opts.origin))),h=n?`${r}${n}`:r;this.opts.headers=cleanRequestHeaders(this.opts.headers,303===t,this.opts.origin!==i),this.opts.path=h,this.opts.origin=i,this.opts.maxRedirections=0,this.opts.query=null,303===t&&"HEAD"!==this.opts.method&&(this.opts.method="GET",this.opts.body=null)}onData(t){if(!this.location)return this.handler.onData(t)}onComplete(t){this.location?(this.location=null,this.abort=null,this.dispatch(this.opts,this)):this.handler.onComplete(t)}onBodySent(t){this.handler.onBodySent&&this.handler.onBodySent(t)}}function parseLocation(t,e){if(-1===redirectableStatusCodes.indexOf(t))return null;for(let t=0;t<e.length;t+=2)if(8===e[t].length&&"location"===util.headerNameToString(e[t]))return e[t+1]}function shouldRemoveHeader(t,e,o){if(4===t.length)return"host"===util.headerNameToString(t);if(e&&util.headerNameToString(t).startsWith("content-"))return!0;if(o&&(13===t.length||6===t.length||19===t.length)){const e=util.headerNameToString(t);return"authorization"===e||"cookie"===e||"proxy-authorization"===e}return!1}function cleanRequestHeaders(t,e,o){const s=[];if(Array.isArray(t))for(let i=0;i<t.length;i+=2)shouldRemoveHeader(t[i],e,o)||s.push(t[i],t[i+1]);else if(t&&"object"==typeof t)for(const i of Object.keys(t))shouldRemoveHeader(i,e,o)||s.push(i,t[i]);else assert(null==t,"headers must be an object or an array");return s}module.exports=RedirectHandler;