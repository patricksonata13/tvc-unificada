"use strict";const{makeNetworkError:makeNetworkError,makeAppropriateNetworkError:makeAppropriateNetworkError,filterResponse:filterResponse,makeResponse:makeResponse,fromInnerResponse:fromInnerResponse}=require("./response"),{HeadersList:HeadersList}=require("./headers"),{Request:Request,cloneRequest:cloneRequest}=require("./request"),zlib=require("node:zlib"),{bytesMatch:bytesMatch,makePolicyContainer:makePolicyContainer,clonePolicyContainer:clonePolicyContainer,requestBadPort:requestBadPort,TAOCheck:TAOCheck,appendRequestOriginHeader:appendRequestOriginHeader,responseLocationURL:responseLocationURL,requestCurrentURL:requestCurrentURL,setRequestReferrerPolicyOnRedirect:setRequestReferrerPolicyOnRedirect,tryUpgradeRequestToAPotentiallyTrustworthyURL:tryUpgradeRequestToAPotentiallyTrustworthyURL,createOpaqueTimingInfo:createOpaqueTimingInfo,appendFetchMetadata:appendFetchMetadata,corsCheck:corsCheck,crossOriginResourcePolicyCheck:crossOriginResourcePolicyCheck,determineRequestsReferrer:determineRequestsReferrer,coarsenedSharedCurrentTime:coarsenedSharedCurrentTime,createDeferredPromise:createDeferredPromise,isBlobLike:isBlobLike,sameOrigin:sameOrigin,isCancelled:isCancelled,isAborted:isAborted,isErrorLike:isErrorLike,fullyReadBody:fullyReadBody,readableStreamClose:readableStreamClose,isomorphicEncode:isomorphicEncode,urlIsLocal:urlIsLocal,urlIsHttpHttpsScheme:urlIsHttpHttpsScheme,urlHasHttpsScheme:urlHasHttpsScheme,clampAndCoarsenConnectionTimingInfo:clampAndCoarsenConnectionTimingInfo,simpleRangeHeaderValue:simpleRangeHeaderValue,buildContentRange:buildContentRange,createInflate:createInflate,extractMimeType:extractMimeType}=require("./util"),{kState:kState,kDispatcher:kDispatcher}=require("./symbols"),assert=require("node:assert"),{safelyExtractBody:safelyExtractBody,extractBody:extractBody}=require("./body"),{redirectStatusSet:redirectStatusSet,nullBodyStatus:nullBodyStatus,safeMethodsSet:safeMethodsSet,requestBodyHeader:requestBodyHeader,subresourceSet:subresourceSet}=require("./constants"),EE=require("node:events"),{Readable:Readable,pipeline:pipeline,finished:finished}=require("node:stream"),{addAbortListener:addAbortListener,isErrored:isErrored,isReadable:isReadable,bufferToLowerCasedHeaderName:bufferToLowerCasedHeaderName}=require("../../core/util"),{dataURLProcessor:dataURLProcessor,serializeAMimeType:serializeAMimeType,minimizeSupportedMimeType:minimizeSupportedMimeType}=require("./data-url"),{getGlobalDispatcher:getGlobalDispatcher}=require("../../global"),{webidl:webidl}=require("./webidl"),{STATUS_CODES:STATUS_CODES}=require("node:http"),GET_OR_HEAD=["GET","HEAD"],defaultUserAgent="undefined"!=typeof __UNDICI_IS_NODE__||"undefined"!=typeof esbuildDetection?"node":"undici";let resolveObjectURL;class Fetch extends EE{constructor(e){super(),this.dispatcher=e,this.connection=null,this.dump=!1,this.state="ongoing"}terminate(e){"ongoing"===this.state&&(this.state="terminated",this.connection?.destroy(e),this.emit("terminated",e))}abort(e){"ongoing"===this.state&&(this.state="aborted",e||(e=new DOMException("The operation was aborted.","AbortError")),this.serializedAbortReason=e,this.connection?.destroy(e),this.emit("terminated",e))}}function handleFetchDone(e){finalizeAndReportTiming(e,"fetch")}function fetch(e,t=void 0){webidl.argumentLengthCheck(arguments,1,"globalThis.fetch");let r,o=createDeferredPromise();try{r=new Request(e,t)}catch(e){return o.reject(e),o.promise}const n=r[kState];if(r.signal.aborted)return abortFetch(o,n,null,r.signal.reason),o.promise;const s=n.client.globalObject;"ServiceWorkerGlobalScope"===s?.constructor?.name&&(n.serviceWorkers="none");let i=null,a=!1,c=null;addAbortListener(r.signal,()=>{a=!0,assert(null!=c),c.abort(r.signal.reason);const e=i?.deref();abortFetch(o,n,e,r.signal.reason)});return c=fetching({request:n,processResponseEndOfBody:handleFetchDone,processResponse:e=>{a||(e.aborted?abortFetch(o,n,i,c.serializedAbortReason):"error"!==e.type?(i=new WeakRef(fromInnerResponse(e,"immutable")),o.resolve(i.deref()),o=null):o.reject(new TypeError("fetch failed",{cause:e.error})))},dispatcher:r[kDispatcher]}),o.promise}function finalizeAndReportTiming(e,t="other"){if("error"===e.type&&e.aborted)return;if(!e.urlList?.length)return;const r=e.urlList[0];let o=e.timingInfo,n=e.cacheState;urlIsHttpHttpsScheme(r)&&null!==o&&(e.timingAllowPassed||(o=createOpaqueTimingInfo({startTime:o.startTime}),n=""),o.endTime=coarsenedSharedCurrentTime(),e.timingInfo=o,markResourceTiming(o,r.href,t,globalThis,n))}const markResourceTiming=performance.markResourceTiming;function abortFetch(e,t,r,o){if(e&&e.reject(o),null!=t.body&&isReadable(t.body?.stream)&&t.body.stream.cancel(o).catch(e=>{if("ERR_INVALID_STATE"!==e.code)throw e}),null==r)return;const n=r[kState];null!=n.body&&isReadable(n.body?.stream)&&n.body.stream.cancel(o).catch(e=>{if("ERR_INVALID_STATE"!==e.code)throw e})}function fetching({request:e,processRequestBodyChunkLength:t,processRequestEndOfBody:r,processResponse:o,processResponseEndOfBody:n,processResponseConsumeBody:s,useParallelQueue:i=!1,dispatcher:a=getGlobalDispatcher()}){assert(a);let c=null,l=!1;null!=e.client&&(c=e.client.globalObject,l=e.client.crossOriginIsolatedCapability);const d=coarsenedSharedCurrentTime(l),u=createOpaqueTimingInfo({startTime:d}),h={controller:new Fetch(a),request:e,timingInfo:u,processRequestBodyChunkLength:t,processRequestEndOfBody:r,processResponse:o,processResponseConsumeBody:s,processResponseEndOfBody:n,taskDestination:c,crossOriginIsolatedCapability:l};if(assert(!e.body||e.body.stream),"client"===e.window&&(e.window="Window"===e.client?.globalObject?.constructor?.name?e.client:"no-window"),"client"===e.origin&&(e.origin=e.client.origin),"client"===e.policyContainer&&(null!=e.client?e.policyContainer=clonePolicyContainer(e.client.policyContainer):e.policyContainer=makePolicyContainer()),!e.headersList.contains("accept",!0)){const t="*/*";e.headersList.append("accept",t,!0)}return e.headersList.contains("accept-language",!0)||e.headersList.append("accept-language","*",!0),e.priority,subresourceSet.has(e.destination),mainFetch(h).catch(e=>{h.controller.terminate(e)}),h.controller}async function mainFetch(e,t=!1){const r=e.request;let o=null;if(r.localURLsOnly&&!urlIsLocal(requestCurrentURL(r))&&(o=makeNetworkError("local URLs only")),tryUpgradeRequestToAPotentiallyTrustworthyURL(r),"blocked"===requestBadPort(r)&&(o=makeNetworkError("bad port")),""===r.referrerPolicy&&(r.referrerPolicy=r.policyContainer.referrerPolicy),"no-referrer"!==r.referrer&&(r.referrer=determineRequestsReferrer(r)),null===o&&(o=await(async()=>{const t=requestCurrentURL(r);return sameOrigin(t,r.url)&&"basic"===r.responseTainting||"data:"===t.protocol||"navigate"===r.mode||"websocket"===r.mode?(r.responseTainting="basic",await schemeFetch(e)):"same-origin"===r.mode?makeNetworkError('request mode cannot be "same-origin"'):"no-cors"===r.mode?"follow"!==r.redirect?makeNetworkError('redirect mode cannot be "follow" for "no-cors" request'):(r.responseTainting="opaque",await schemeFetch(e)):urlIsHttpHttpsScheme(requestCurrentURL(r))?(r.responseTainting="cors",await httpFetch(e)):makeNetworkError("URL scheme must be a HTTP(S) scheme")})()),t)return o;0===o.status||o.internalResponse||(r.responseTainting,"basic"===r.responseTainting?o=filterResponse(o,"basic"):"cors"===r.responseTainting?o=filterResponse(o,"cors"):"opaque"===r.responseTainting?o=filterResponse(o,"opaque"):assert(!1));let n=0===o.status?o:o.internalResponse;if(0===n.urlList.length&&n.urlList.push(...r.urlList),r.timingAllowFailed||(o.timingAllowPassed=!0),"opaque"===o.type&&206===n.status&&n.rangeRequested&&!r.headers.contains("range",!0)&&(o=n=makeNetworkError()),0===o.status||"HEAD"!==r.method&&"CONNECT"!==r.method&&!nullBodyStatus.includes(n.status)||(n.body=null,e.controller.dump=!0),r.integrity){const t=t=>fetchFinale(e,makeNetworkError(t));if("opaque"===r.responseTainting||null==o.body)return void t(o.error);const n=n=>{bytesMatch(n,r.integrity)?(o.body=safelyExtractBody(n)[0],fetchFinale(e,o)):t("integrity mismatch")};await fullyReadBody(o.body,n,t)}else fetchFinale(e,o)}function schemeFetch(e){if(isCancelled(e)&&0===e.request.redirectCount)return Promise.resolve(makeAppropriateNetworkError(e));const{request:t}=e,{protocol:r}=requestCurrentURL(t);switch(r){case"about:":return Promise.resolve(makeNetworkError("about scheme is not supported"));case"blob:":{resolveObjectURL||(resolveObjectURL=require("node:buffer").resolveObjectURL);const e=requestCurrentURL(t);if(0!==e.search.length)return Promise.resolve(makeNetworkError("NetworkError when attempting to fetch resource."));const r=resolveObjectURL(e.toString());if("GET"!==t.method||!isBlobLike(r))return Promise.resolve(makeNetworkError("invalid method"));const o=makeResponse(),n=r.size,s=isomorphicEncode(`${n}`),i=r.type;if(t.headersList.contains("range",!0)){o.rangeRequested=!0;const e=t.headersList.get("range",!0),s=simpleRangeHeaderValue(e,!0);if("failure"===s)return Promise.resolve(makeNetworkError("failed to fetch the data URL"));let{rangeStartValue:a,rangeEndValue:c}=s;if(null===a)a=n-c,c=a+c-1;else{if(a>=n)return Promise.resolve(makeNetworkError("Range start is greater than the blob's size."));(null===c||c>=n)&&(c=n-1)}const l=r.slice(a,c,i),d=extractBody(l);o.body=d[0];const u=isomorphicEncode(`${l.size}`),h=buildContentRange(a,c,n);o.status=206,o.statusText="Partial Content",o.headersList.set("content-length",u,!0),o.headersList.set("content-type",i,!0),o.headersList.set("content-range",h,!0)}else{const e=extractBody(r);o.statusText="OK",o.body=e[0],o.headersList.set("content-length",s,!0),o.headersList.set("content-type",i,!0)}return Promise.resolve(o)}case"data:":{const e=requestCurrentURL(t),r=dataURLProcessor(e);if("failure"===r)return Promise.resolve(makeNetworkError("failed to fetch the data URL"));const o=serializeAMimeType(r.mimeType);return Promise.resolve(makeResponse({statusText:"OK",headersList:[["content-type",{name:"Content-Type",value:o}]],body:safelyExtractBody(r.body)[0]}))}case"file:":return Promise.resolve(makeNetworkError("not implemented... yet..."));case"http:":case"https:":return httpFetch(e).catch(e=>makeNetworkError(e));default:return Promise.resolve(makeNetworkError("unknown scheme"))}}function finalizeResponse(e,t){e.request.done=!0,null!=e.processResponseDone&&queueMicrotask(()=>e.processResponseDone(t))}function fetchFinale(e,t){let r=e.timingInfo;const o=()=>{const o=Date.now();"document"===e.request.destination&&(e.controller.fullTimingInfo=r),e.controller.reportTimingSteps=()=>{if("https:"!==e.request.url.protocol)return;r.endTime=o;let n=t.cacheState;const s=t.bodyInfo;t.timingAllowPassed||(r=createOpaqueTimingInfo(r),n="");let i=0;if("navigator"!==e.request.mode||!t.hasCrossOriginRedirects){i=t.status;const e=extractMimeType(t.headersList);"failure"!==e&&(s.contentType=minimizeSupportedMimeType(e))}null!=e.request.initiatorType&&markResourceTiming(r,e.request.url.href,e.request.initiatorType,globalThis,n,s,i)};queueMicrotask(()=>(e.request.done=!0,null!=e.processResponseEndOfBody&&queueMicrotask(()=>e.processResponseEndOfBody(t)),void(null!=e.request.initiatorType&&e.controller.reportTimingSteps())))};null!=e.processResponse&&queueMicrotask(()=>{e.processResponse(t),e.processResponse=null});const n="error"===t.type?t:t.internalResponse??t;null==n.body?o():finished(n.body.stream,()=>{o()})}async function httpFetch(e){const t=e.request;let r=null,o=null;const n=e.timingInfo;if(t.serviceWorkers,null===r){if("follow"===t.redirect&&(t.serviceWorkers="none"),o=r=await httpNetworkOrCacheFetch(e),"cors"===t.responseTainting&&"failure"===corsCheck(t,r))return makeNetworkError("cors failure");"failure"===TAOCheck(t,r)&&(t.timingAllowFailed=!0)}return"opaque"!==t.responseTainting&&"opaque"!==r.type||"blocked"!==crossOriginResourcePolicyCheck(t.origin,t.client,t.destination,o)?(redirectStatusSet.has(o.status)&&("manual"!==t.redirect&&e.controller.connection.destroy(void 0,!1),"error"===t.redirect?r=makeNetworkError("unexpected redirect"):"manual"===t.redirect?r=o:"follow"===t.redirect?r=await httpRedirectFetch(e,r):assert(!1)),r.timingInfo=n,r):makeNetworkError("blocked")}function httpRedirectFetch(e,t){const r=e.request,o=t.internalResponse?t.internalResponse:t;let n;try{if(n=responseLocationURL(o,requestCurrentURL(r).hash),null==n)return t}catch(e){return Promise.resolve(makeNetworkError(e))}if(!urlIsHttpHttpsScheme(n))return Promise.resolve(makeNetworkError("URL scheme must be a HTTP(S) scheme"));if(20===r.redirectCount)return Promise.resolve(makeNetworkError("redirect count exceeded"));if(r.redirectCount+=1,"cors"===r.mode&&(n.username||n.password)&&!sameOrigin(r,n))return Promise.resolve(makeNetworkError('cross origin not allowed for request mode "cors"'));if("cors"===r.responseTainting&&(n.username||n.password))return Promise.resolve(makeNetworkError('URL cannot contain credentials for request mode "cors"'));if(303!==o.status&&null!=r.body&&null==r.body.source)return Promise.resolve(makeNetworkError());if([301,302].includes(o.status)&&"POST"===r.method||303===o.status&&!GET_OR_HEAD.includes(r.method)){r.method="GET",r.body=null;for(const e of requestBodyHeader)r.headersList.delete(e)}sameOrigin(requestCurrentURL(r),n)||(r.headersList.delete("authorization",!0),r.headersList.delete("proxy-authorization",!0),r.headersList.delete("cookie",!0),r.headersList.delete("host",!0)),null!=r.body&&(assert(null!=r.body.source),r.body=safelyExtractBody(r.body.source)[0]);const s=e.timingInfo;return s.redirectEndTime=s.postRedirectStartTime=coarsenedSharedCurrentTime(e.crossOriginIsolatedCapability),0===s.redirectStartTime&&(s.redirectStartTime=s.startTime),r.urlList.push(n),setRequestReferrerPolicyOnRedirect(r,o),mainFetch(e,!0)}async function httpNetworkOrCacheFetch(e,t=!1,r=!1){const o=e.request;let n=null,s=null,i=null;"no-window"===o.window&&"error"===o.redirect?(n=e,s=o):(s=cloneRequest(o),n={...e},n.request=s);const a="include"===o.credentials||"same-origin"===o.credentials&&"basic"===o.responseTainting,c=s.body?s.body.length:null;let l=null;if(null==s.body&&["POST","PUT"].includes(s.method)&&(l="0"),null!=c&&(l=isomorphicEncode(`${c}`)),null!=l&&s.headersList.append("content-length",l,!0),null!=c&&s.keepalive,s.referrer instanceof URL&&s.headersList.append("referer",isomorphicEncode(s.referrer.href),!0),appendRequestOriginHeader(s),appendFetchMetadata(s),s.headersList.contains("user-agent",!0)||s.headersList.append("user-agent",defaultUserAgent),"default"===s.cache&&(s.headersList.contains("if-modified-since",!0)||s.headersList.contains("if-none-match",!0)||s.headersList.contains("if-unmodified-since",!0)||s.headersList.contains("if-match",!0)||s.headersList.contains("if-range",!0))&&(s.cache="no-store"),"no-cache"!==s.cache||s.preventNoCacheCacheControlHeaderModification||s.headersList.contains("cache-control",!0)||s.headersList.append("cache-control","max-age=0",!0),"no-store"!==s.cache&&"reload"!==s.cache||(s.headersList.contains("pragma",!0)||s.headersList.append("pragma","no-cache",!0),s.headersList.contains("cache-control",!0)||s.headersList.append("cache-control","no-cache",!0)),s.headersList.contains("range",!0)&&s.headersList.append("accept-encoding","identity",!0),s.headersList.contains("accept-encoding",!0)||(urlHasHttpsScheme(requestCurrentURL(s))?s.headersList.append("accept-encoding","br, gzip, deflate",!0):s.headersList.append("accept-encoding","gzip, deflate",!0)),s.headersList.delete("host",!0),s.cache="no-store","no-store"!==s.cache&&s.cache,null==i){if("only-if-cached"===s.cache)return makeNetworkError("only if cached");const e=await httpNetworkFetch(n,a,r);!safeMethodsSet.has(s.method)&&e.status>=200&&e.status,null==i&&(i=e)}if(i.urlList=[...s.urlList],s.headersList.contains("range",!0)&&(i.rangeRequested=!0),i.requestIncludesCredentials=a,407===i.status)return"no-window"===o.window?makeNetworkError():isCancelled(e)?makeAppropriateNetworkError(e):makeNetworkError("proxy authentication required");if(421===i.status&&!r&&(null==o.body||null!=o.body.source)){if(isCancelled(e))return makeAppropriateNetworkError(e);e.controller.connection.destroy(),i=await httpNetworkOrCacheFetch(e,t,!0)}return i}async function httpNetworkFetch(e,t=!1,r=!1){assert(!e.controller.connection||e.controller.connection.destroyed),e.controller.connection={abort:null,destroyed:!1,destroy(e,t=!0){this.destroyed||(this.destroyed=!0,t&&this.abort?.(e??new DOMException("The operation was aborted.","AbortError")))}};const o=e.request;let n=null;const s=e.timingInfo;o.cache="no-store";o.mode;let i=null;if(null==o.body&&e.processRequestEndOfBody)queueMicrotask(()=>e.processRequestEndOfBody());else if(null!=o.body){const t=async function*(t){isCancelled(e)||(yield t,e.processRequestBodyChunkLength?.(t.byteLength))},r=()=>{isCancelled(e)||e.processRequestEndOfBody&&e.processRequestEndOfBody()},n=t=>{isCancelled(e)||("AbortError"===t.name?e.controller.abort():e.controller.terminate(t))};i=async function*(){try{for await(const e of o.body.stream)yield*t(e);r()}catch(e){n(e)}}()}try{const{body:t,status:r,statusText:a,headersList:c,socket:l}=await function({body:t}){const r=requestCurrentURL(o),n=e.controller.dispatcher;return new Promise((i,a)=>n.dispatch({path:r.pathname+r.search,origin:r.origin,method:o.method,body:n.isMockActive?o.body&&(o.body.source||o.body.stream):t,headers:o.headersList.entries,maxRedirections:0,upgrade:"websocket"===o.mode?"websocket":void 0},{body:null,abort:null,onConnect(t){const{connection:r}=e.controller;s.finalConnectionTimingInfo=clampAndCoarsenConnectionTimingInfo(void 0,s.postRedirectStartTime,e.crossOriginIsolatedCapability),r.destroyed?t(new DOMException("The operation was aborted.","AbortError")):(e.controller.on("terminated",t),this.abort=r.abort=t),s.finalNetworkRequestStartTime=coarsenedSharedCurrentTime(e.crossOriginIsolatedCapability)},onResponseStarted(){s.finalNetworkResponseStartTime=coarsenedSharedCurrentTime(e.crossOriginIsolatedCapability)},onHeaders(e,t,r,n){if(e<200)return;let s=[],a="";const c=new HeadersList;for(let e=0;e<t.length;e+=2)c.append(bufferToLowerCasedHeaderName(t[e]),t[e+1].toString("latin1"),!0);const l=c.get("content-encoding",!0);l&&(s=l.toLowerCase().split(",").map(e=>e.trim())),a=c.get("location",!0),this.body=new Readable({read:r});const d=[],u=a&&"follow"===o.redirect&&redirectStatusSet.has(e);if(0!==s.length&&"HEAD"!==o.method&&"CONNECT"!==o.method&&!nullBodyStatus.includes(e)&&!u)for(let e=s.length-1;e>=0;--e){const t=s[e];if("x-gzip"===t||"gzip"===t)d.push(zlib.createGunzip({flush:zlib.constants.Z_SYNC_FLUSH,finishFlush:zlib.constants.Z_SYNC_FLUSH}));else if("deflate"===t)d.push(createInflate({flush:zlib.constants.Z_SYNC_FLUSH,finishFlush:zlib.constants.Z_SYNC_FLUSH}));else{if("br"!==t){d.length=0;break}d.push(zlib.createBrotliDecompress({flush:zlib.constants.BROTLI_OPERATION_FLUSH,finishFlush:zlib.constants.BROTLI_OPERATION_FLUSH}))}}const h=this.onError.bind(this);return i({status:e,statusText:n,headersList:c,body:d.length?pipeline(this.body,...d,e=>{e&&this.onError(e)}).on("error",h):this.body.on("error",h)}),!0},onData(t){if(e.controller.dump)return;const r=t;return s.encodedBodySize+=r.byteLength,this.body.push(r)},onComplete(){this.abort&&e.controller.off("terminated",this.abort),e.controller.onAborted&&e.controller.off("terminated",e.controller.onAborted),e.controller.ended=!0,this.body.push(null)},onError(t){this.abort&&e.controller.off("terminated",this.abort),this.body?.destroy(t),e.controller.terminate(t),a(t)},onUpgrade(e,t,r){if(101!==e)return;const o=new HeadersList;for(let e=0;e<t.length;e+=2)o.append(bufferToLowerCasedHeaderName(t[e]),t[e+1].toString("latin1"),!0);return i({status:e,statusText:STATUS_CODES[e],headersList:o,socket:r}),!0}}))}({body:i});if(l)n=makeResponse({status:r,statusText:a,headersList:c,socket:l});else{const o=t[Symbol.asyncIterator]();e.controller.next=()=>o.next(),n=makeResponse({status:r,statusText:a,headersList:c})}}catch(t){return"AbortError"===t.name?(e.controller.connection.destroy(),makeAppropriateNetworkError(e,t)):makeNetworkError(t)}const a=new ReadableStream({async start(t){e.controller.controller=t},async pull(t){await(async()=>{await e.controller.resume()})()},async cancel(t){await(t=>{isCancelled(e)||e.controller.abort(t)})(t)},type:"bytes"});function c(t){isAborted(e)?(n.aborted=!0,isReadable(a)&&e.controller.controller.error(e.controller.serializedAbortReason)):isReadable(a)&&e.controller.controller.error(new TypeError("terminated",{cause:isErrorLike(t)?t:void 0})),e.controller.connection.destroy()}return n.body={stream:a,source:null,length:null},e.controller.onAborted=c,e.controller.on("terminated",c),e.controller.resume=async()=>{for(;;){let t,r;try{const{done:r,value:o}=await e.controller.next();if(isAborted(e))break;t=r?void 0:o}catch(o){e.controller.ended&&!s.encodedBodySize?t=void 0:(t=o,r=!0)}if(void 0===t)return readableStreamClose(e.controller.controller),void finalizeResponse(e,n);if(s.decodedBodySize+=t?.byteLength??0,r)return void e.controller.terminate(t);const o=new Uint8Array(t);if(o.byteLength&&e.controller.controller.enqueue(o),isErrored(a))return void e.controller.terminate();if(e.controller.controller.desiredSize<=0)return}},n}module.exports={fetch:fetch,Fetch:Fetch,fetching:fetching,finalizeAndReportTiming:finalizeAndReportTiming};