"use strict";const{kState:kState,kError:kError,kResult:kResult,kAborted:kAborted,kLastProgressEventFired:kLastProgressEventFired}=require("./symbols"),{ProgressEvent:ProgressEvent}=require("./progressevent"),{getEncoding:getEncoding}=require("./encoding"),{serializeAMimeType:serializeAMimeType,parseMIMEType:parseMIMEType}=require("../fetch/data-url"),{types:types}=require("node:util"),{StringDecoder:StringDecoder}=require("string_decoder"),{btoa:btoa}=require("node:buffer"),staticPropertyDescriptors={enumerable:!0,writable:!1,configurable:!1};function readOperation(e,r,t,n){if("loading"===e[kState])throw new DOMException("Invalid state","InvalidStateError");e[kState]="loading",e[kResult]=null,e[kError]=null;const o=r.stream().getReader(),s=[];let a=o.read(),i=!0;(async()=>{for(;!e[kAborted];)try{const{done:c,value:d}=await a;if(i&&!e[kAborted]&&queueMicrotask(()=>{fireAProgressEvent("loadstart",e)}),i=!1,!c&&types.isUint8Array(d))s.push(d),(void 0===e[kLastProgressEventFired]||Date.now()-e[kLastProgressEventFired]>=50)&&!e[kAborted]&&(e[kLastProgressEventFired]=Date.now(),queueMicrotask(()=>{fireAProgressEvent("progress",e)})),a=o.read();else if(c){queueMicrotask(()=>{e[kState]="done";try{const o=packageData(s,t,r.type,n);if(e[kAborted])return;e[kResult]=o,fireAProgressEvent("load",e)}catch(r){e[kError]=r,fireAProgressEvent("error",e)}"loading"!==e[kState]&&fireAProgressEvent("loadend",e)});break}}catch(r){if(e[kAborted])return;queueMicrotask(()=>{e[kState]="done",e[kError]=r,fireAProgressEvent("error",e),"loading"!==e[kState]&&fireAProgressEvent("loadend",e)});break}})()}function fireAProgressEvent(e,r){const t=new ProgressEvent(e,{bubbles:!1,cancelable:!1});r.dispatchEvent(t)}function packageData(e,r,t,n){switch(r){case"DataURL":{let r="data:";const n=parseMIMEType(t||"application/octet-stream");"failure"!==n&&(r+=serializeAMimeType(n)),r+=";base64,";const o=new StringDecoder("latin1");for(const t of e)r+=btoa(o.write(t));return r+=btoa(o.end()),r}case"Text":{let r="failure";if(n&&(r=getEncoding(n)),"failure"===r&&t){const e=parseMIMEType(t);"failure"!==e&&(r=getEncoding(e.parameters.get("charset")))}return"failure"===r&&(r="UTF-8"),decode(e,r)}case"ArrayBuffer":return combineByteSequences(e).buffer;case"BinaryString":{let r="";const t=new StringDecoder("latin1");for(const n of e)r+=t.write(n);return r+=t.end(),r}}}function decode(e,r){const t=combineByteSequences(e),n=BOMSniffing(t);let o=0;null!==n&&(r=n,o="UTF-8"===n?3:2);const s=t.slice(o);return new TextDecoder(r).decode(s)}function BOMSniffing(e){const[r,t,n]=e;return 239===r&&187===t&&191===n?"UTF-8":254===r&&255===t?"UTF-16BE":255===r&&254===t?"UTF-16LE":null}function combineByteSequences(e){const r=e.reduce((e,r)=>e+r.byteLength,0);let t=0;return e.reduce((e,r)=>(e.set(r,t),t+=r.byteLength,e),new Uint8Array(r))}module.exports={staticPropertyDescriptors:staticPropertyDescriptors,readOperation:readOperation,fireAProgressEvent:fireAProgressEvent};