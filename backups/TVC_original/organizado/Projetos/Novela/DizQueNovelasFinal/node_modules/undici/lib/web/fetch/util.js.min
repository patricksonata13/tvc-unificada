"use strict";const{Transform:Transform}=require("node:stream"),zlib=require("node:zlib"),{redirectStatusSet:redirectStatusSet,referrerPolicySet:referrerPolicyTokens,badPortsSet:badPortsSet}=require("./constants"),{getGlobalOrigin:getGlobalOrigin}=require("./global"),{collectASequenceOfCodePoints:collectASequenceOfCodePoints,collectAnHTTPQuotedString:collectAnHTTPQuotedString,removeChars:removeChars,parseMIMEType:parseMIMEType}=require("./data-url"),{performance:performance}=require("node:perf_hooks"),{isBlobLike:isBlobLike,ReadableStreamFrom:ReadableStreamFrom,isValidHTTPToken:isValidHTTPToken,normalizedMethodRecordsBase:normalizedMethodRecordsBase}=require("../../core/util"),assert=require("node:assert"),{isUint8Array:isUint8Array}=require("node:util/types"),{webidl:webidl}=require("./webidl");let crypto,supportedHashes=[];try{crypto=require("node:crypto");const e=["sha256","sha384","sha512"];supportedHashes=crypto.getHashes().filter(t=>e.includes(t))}catch{}function responseURL(e){const t=e.urlList,r=t.length;return 0===r?null:t[r-1].toString()}function responseLocationURL(e,t){if(!redirectStatusSet.has(e.status))return null;let r=e.headersList.get("location",!0);return null!==r&&isValidHeaderValue(r)&&(isValidEncodedURL(r)||(r=normalizeBinaryStringToUtf8(r)),r=new URL(r,responseURL(e))),r&&!r.hash&&(r.hash=t),r}function isValidEncodedURL(e){for(let t=0;t<e.length;++t){const r=e.charCodeAt(t);if(r>126||r<32)return!1}return!0}function normalizeBinaryStringToUtf8(e){return Buffer.from(e,"binary").toString("utf8")}function requestCurrentURL(e){return e.urlList[e.urlList.length-1]}function requestBadPort(e){const t=requestCurrentURL(e);return urlIsHttpHttpsScheme(t)&&badPortsSet.has(t.port)?"blocked":"allowed"}function isErrorLike(e){return e instanceof Error||"Error"===e?.constructor?.name||"DOMException"===e?.constructor?.name}function isValidReasonPhrase(e){for(let t=0;t<e.length;++t){const r=e.charCodeAt(t);if(!(9===r||r>=32&&r<=126||r>=128&&r<=255))return!1}return!0}const isValidHeaderName=isValidHTTPToken;function isValidHeaderValue(e){return!1===("\t"===e[0]||" "===e[0]||"\t"===e[e.length-1]||" "===e[e.length-1]||e.includes("\n")||e.includes("\r")||e.includes("\0"))}function setRequestReferrerPolicyOnRedirect(e,t){const{headersList:r}=t,n=(r.get("referrer-policy",!0)??"").split(",");let o="";if(n.length>0)for(let e=n.length;0!==e;e--){const t=n[e-1].trim();if(referrerPolicyTokens.has(t)){o=t;break}}""!==o&&(e.referrerPolicy=o)}function crossOriginResourcePolicyCheck(){return"allowed"}function corsCheck(){return"success"}function TAOCheck(){return"success"}function appendFetchMetadata(e){let t=null;t=e.mode,e.headersList.set("sec-fetch-mode",t,!0)}function appendRequestOriginHeader(e){let t=e.origin;if("client"!==t&&void 0!==t)if("cors"===e.responseTainting||"websocket"===e.mode)e.headersList.append("origin",t,!0);else if("GET"!==e.method&&"HEAD"!==e.method){switch(e.referrerPolicy){case"no-referrer":t=null;break;case"no-referrer-when-downgrade":case"strict-origin":case"strict-origin-when-cross-origin":e.origin&&urlHasHttpsScheme(e.origin)&&!urlHasHttpsScheme(requestCurrentURL(e))&&(t=null);break;case"same-origin":sameOrigin(e,requestCurrentURL(e))||(t=null)}e.headersList.append("origin",t,!0)}}function coarsenTime(e,t){return e}function clampAndCoarsenConnectionTimingInfo(e,t,r){return!e?.startTime||e.startTime<t?{domainLookupStartTime:t,domainLookupEndTime:t,connectionStartTime:t,connectionEndTime:t,secureConnectionStartTime:t,ALPNNegotiatedProtocol:e?.ALPNNegotiatedProtocol}:{domainLookupStartTime:coarsenTime(e.domainLookupStartTime,r),domainLookupEndTime:coarsenTime(e.domainLookupEndTime,r),connectionStartTime:coarsenTime(e.connectionStartTime,r),connectionEndTime:coarsenTime(e.connectionEndTime,r),secureConnectionStartTime:coarsenTime(e.secureConnectionStartTime,r),ALPNNegotiatedProtocol:e.ALPNNegotiatedProtocol}}function coarsenedSharedCurrentTime(e){return coarsenTime(performance.now(),e)}function createOpaqueTimingInfo(e){return{startTime:e.startTime??0,redirectStartTime:0,redirectEndTime:0,postRedirectStartTime:e.startTime??0,finalServiceWorkerStartTime:0,finalNetworkResponseStartTime:0,finalNetworkRequestStartTime:0,endTime:0,encodedBodySize:0,decodedBodySize:0,finalConnectionTimingInfo:null}}function makePolicyContainer(){return{referrerPolicy:"strict-origin-when-cross-origin"}}function clonePolicyContainer(e){return{referrerPolicy:e.referrerPolicy}}function determineRequestsReferrer(e){const t=e.referrerPolicy;assert(t);let r=null;if("client"===e.referrer){const e=getGlobalOrigin();if(!e||"null"===e.origin)return"no-referrer";r=new URL(e)}else e.referrer instanceof URL&&(r=e.referrer);let n=stripURLForReferrer(r);const o=stripURLForReferrer(r,!0);n.toString().length>4096&&(n=o);const i=sameOrigin(e,n),a=isURLPotentiallyTrustworthy(n)&&!isURLPotentiallyTrustworthy(e.url);switch(t){case"origin":return null!=o?o:stripURLForReferrer(r,!0);case"unsafe-url":return n;case"same-origin":return i?o:"no-referrer";case"origin-when-cross-origin":return i?n:o;case"strict-origin-when-cross-origin":{const t=requestCurrentURL(e);return sameOrigin(n,t)?n:isURLPotentiallyTrustworthy(n)&&!isURLPotentiallyTrustworthy(t)?"no-referrer":o}default:return a?"no-referrer":o}}function stripURLForReferrer(e,t){return assert(e instanceof URL),"file:"===(e=new URL(e)).protocol||"about:"===e.protocol||"blank:"===e.protocol?"no-referrer":(e.username="",e.password="",e.hash="",t&&(e.pathname="",e.search=""),e)}function isURLPotentiallyTrustworthy(e){return e instanceof URL&&("about:blank"===e.href||"about:srcdoc"===e.href||("data:"===e.protocol||("file:"===e.protocol||function(e){if(null==e||"null"===e)return!1;const t=new URL(e);if("https:"===t.protocol||"wss:"===t.protocol)return!0;if(/^127(?:\.[0-9]+){0,2}\.[0-9]+$|^\[(?:0*:)*?:?0*1\]$/.test(t.hostname)||"localhost"===t.hostname||t.hostname.includes("localhost.")||t.hostname.endsWith(".localhost"))return!0;return!1}(e.origin))))}function bytesMatch(e,t){if(void 0===crypto)return!0;const r=parseMetadata(t);if("no metadata"===r)return!0;if(0===r.length)return!0;const n=filterMetadataListByAlgorithm(r,getStrongestMetadata(r));for(const t of n){const r=t.algo,n=t.hash;let o=crypto.createHash(r).update(e).digest("base64");if("="===o[o.length-1]&&(o="="===o[o.length-2]?o.slice(0,-2):o.slice(0,-1)),compareBase64Mixed(o,n))return!0}return!1}const parseHashWithOptions=/(?<algo>sha256|sha384|sha512)-((?<hash>[A-Za-z0-9+/]+|[A-Za-z0-9_-]+)={0,2}(?:\s|$)( +[!-~]*)?)?/i;function parseMetadata(e){const t=[];let r=!0;for(const n of e.split(" ")){r=!1;const e=parseHashWithOptions.exec(n);if(null===e||void 0===e.groups||void 0===e.groups.algo)continue;const o=e.groups.algo.toLowerCase();supportedHashes.includes(o)&&t.push(e.groups)}return!0===r?"no metadata":t}function getStrongestMetadata(e){let t=e[0].algo;if("5"===t[3])return t;for(let r=1;r<e.length;++r){const n=e[r];if("5"===n.algo[3]){t="sha512";break}"3"!==t[3]&&("3"===n.algo[3]&&(t="sha384"))}return t}function filterMetadataListByAlgorithm(e,t){if(1===e.length)return e;let r=0;for(let n=0;n<e.length;++n)e[n].algo===t&&(e[r++]=e[n]);return e.length=r,e}function compareBase64Mixed(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r]){if("+"===e[r]&&"-"===t[r]||"/"===e[r]&&"_"===t[r])continue;return!1}return!0}function tryUpgradeRequestToAPotentiallyTrustworthyURL(e){}function sameOrigin(e,t){return e.origin===t.origin&&"null"===e.origin||e.protocol===t.protocol&&e.hostname===t.hostname&&e.port===t.port}function createDeferredPromise(){let e,t;return{promise:new Promise((r,n)=>{e=r,t=n}),resolve:e,reject:t}}function isAborted(e){return"aborted"===e.controller.state}function isCancelled(e){return"aborted"===e.controller.state||"terminated"===e.controller.state}function normalizeMethod(e){return normalizedMethodRecordsBase[e.toLowerCase()]??e}function serializeJavascriptValueToJSONString(e){const t=JSON.stringify(e);if(void 0===t)throw new TypeError("Value is not JSON serializable");return assert("string"==typeof t),t}const esIteratorPrototype=Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]()));function createIterator(e,t,r=0,n=1){class o{#e;#t;#r;constructor(e,t){this.#e=e,this.#t=t,this.#r=0}next(){if("object"!=typeof this||null===this||!(#e in this))throw new TypeError(`'next' called on an object that does not implement interface ${e} Iterator.`);const o=this.#r,i=this.#e[t];if(o>=i.length)return{value:void 0,done:!0};const{[r]:a,[n]:s}=i[o];let l;switch(this.#r=o+1,this.#t){case"key":l=a;break;case"value":l=s;break;case"key+value":l=[a,s]}return{value:l,done:!1}}}return delete o.prototype.constructor,Object.setPrototypeOf(o.prototype,esIteratorPrototype),Object.defineProperties(o.prototype,{[Symbol.toStringTag]:{writable:!1,enumerable:!1,configurable:!0,value:`${e} Iterator`},next:{writable:!0,enumerable:!0,configurable:!0}}),function(e,t){return new o(e,t)}}function iteratorMixin(e,t,r,n=0,o=1){const i=createIterator(e,r,n,o),a={keys:{writable:!0,enumerable:!0,configurable:!0,value:function(){return webidl.brandCheck(this,t),i(this,"key")}},values:{writable:!0,enumerable:!0,configurable:!0,value:function(){return webidl.brandCheck(this,t),i(this,"value")}},entries:{writable:!0,enumerable:!0,configurable:!0,value:function(){return webidl.brandCheck(this,t),i(this,"key+value")}},forEach:{writable:!0,enumerable:!0,configurable:!0,value:function(r,n=globalThis){if(webidl.brandCheck(this,t),webidl.argumentLengthCheck(arguments,1,`${e}.forEach`),"function"!=typeof r)throw new TypeError(`Failed to execute 'forEach' on '${e}': parameter 1 is not of type 'Function'.`);for(const{0:e,1:t}of i(this,"key+value"))r.call(n,t,e,this)}}};return Object.defineProperties(t.prototype,{...a,[Symbol.iterator]:{writable:!0,enumerable:!1,configurable:!0,value:a.entries.value}})}async function fullyReadBody(e,t,r){const n=t,o=r;let i;try{i=e.stream.getReader()}catch(e){return void o(e)}try{n(await readAllBytes(i))}catch(e){o(e)}}function isReadableStreamLike(e){return e instanceof ReadableStream||"ReadableStream"===e[Symbol.toStringTag]&&"function"==typeof e.tee}function readableStreamClose(e){try{e.close(),e.byobRequest?.respond(0)}catch(e){if(!e.message.includes("Controller is already closed")&&!e.message.includes("ReadableStream is already closed"))throw e}}const invalidIsomorphicEncodeValueRegex=/[^\x00-\xFF]/;function isomorphicEncode(e){return assert(!invalidIsomorphicEncodeValueRegex.test(e)),e}async function readAllBytes(e){const t=[];let r=0;for(;;){const{done:n,value:o}=await e.read();if(n)return Buffer.concat(t,r);if(!isUint8Array(o))throw new TypeError("Received non-Uint8Array chunk");t.push(o),r+=o.length}}function urlIsLocal(e){assert("protocol"in e);const t=e.protocol;return"about:"===t||"blob:"===t||"data:"===t}function urlHasHttpsScheme(e){return"string"==typeof e&&":"===e[5]&&"h"===e[0]&&"t"===e[1]&&"t"===e[2]&&"p"===e[3]&&"s"===e[4]||"https:"===e.protocol}function urlIsHttpHttpsScheme(e){assert("protocol"in e);const t=e.protocol;return"http:"===t||"https:"===t}function simpleRangeHeaderValue(e,t){const r=e;if(!r.startsWith("bytes"))return"failure";const n={position:5};if(t&&collectASequenceOfCodePoints(e=>"\t"===e||" "===e,r,n),61!==r.charCodeAt(n.position))return"failure";n.position++,t&&collectASequenceOfCodePoints(e=>"\t"===e||" "===e,r,n);const o=collectASequenceOfCodePoints(e=>{const t=e.charCodeAt(0);return t>=48&&t<=57},r,n),i=o.length?Number(o):null;if(t&&collectASequenceOfCodePoints(e=>"\t"===e||" "===e,r,n),45!==r.charCodeAt(n.position))return"failure";n.position++,t&&collectASequenceOfCodePoints(e=>"\t"===e||" "===e,r,n);const a=collectASequenceOfCodePoints(e=>{const t=e.charCodeAt(0);return t>=48&&t<=57},r,n),s=a.length?Number(a):null;return n.position<r.length||null===s&&null===i||i>s?"failure":{rangeStartValue:i,rangeEndValue:s}}function buildContentRange(e,t,r){let n="bytes ";return n+=isomorphicEncode(`${e}`),n+="-",n+=isomorphicEncode(`${t}`),n+="/",n+=isomorphicEncode(`${r}`),n}class InflateStream extends Transform{#n;constructor(e){super(),this.#n=e}_transform(e,t,r){if(!this._inflateStream){if(0===e.length)return void r();this._inflateStream=8==(15&e[0])?zlib.createInflate(this.#n):zlib.createInflateRaw(this.#n),this._inflateStream.on("data",this.push.bind(this)),this._inflateStream.on("end",()=>this.push(null)),this._inflateStream.on("error",e=>this.destroy(e))}this._inflateStream.write(e,t,r)}_final(e){this._inflateStream&&(this._inflateStream.end(),this._inflateStream=null),e()}}function createInflate(e){return new InflateStream(e)}function extractMimeType(e){let t=null,r=null,n=null;const o=getDecodeSplit("content-type",e);if(null===o)return"failure";for(const e of o){const o=parseMIMEType(e);"failure"!==o&&"*/*"!==o.essence&&(n=o,n.essence!==r?(t=null,n.parameters.has("charset")&&(t=n.parameters.get("charset")),r=n.essence):n.parameters.has("charset")||null===t||n.parameters.set("charset",t))}return null==n?"failure":n}function gettingDecodingSplitting(e){const t=e,r={position:0},n=[];let o="";for(;r.position<t.length;){if(o+=collectASequenceOfCodePoints(e=>'"'!==e&&","!==e,t,r),r.position<t.length)if(34===t.charCodeAt(r.position)){if(o+=collectAnHTTPQuotedString(t,r),r.position<t.length)continue}else assert(44===t.charCodeAt(r.position)),r.position++;o=removeChars(o,!0,!0,e=>9===e||32===e),n.push(o),o=""}return n}function getDecodeSplit(e,t){const r=t.get(e,!0);return null===r?null:gettingDecodingSplitting(r)}const textDecoder=new TextDecoder;function utf8DecodeBytes(e){if(0===e.length)return"";239===e[0]&&187===e[1]&&191===e[2]&&(e=e.subarray(3));return textDecoder.decode(e)}class EnvironmentSettingsObjectBase{get baseUrl(){return getGlobalOrigin()}get origin(){return this.baseUrl?.origin}policyContainer=makePolicyContainer()}class EnvironmentSettingsObject{settingsObject=new EnvironmentSettingsObjectBase}const environmentSettingsObject=new EnvironmentSettingsObject;module.exports={isAborted:isAborted,isCancelled:isCancelled,isValidEncodedURL:isValidEncodedURL,createDeferredPromise:createDeferredPromise,ReadableStreamFrom:ReadableStreamFrom,tryUpgradeRequestToAPotentiallyTrustworthyURL:tryUpgradeRequestToAPotentiallyTrustworthyURL,clampAndCoarsenConnectionTimingInfo:clampAndCoarsenConnectionTimingInfo,coarsenedSharedCurrentTime:coarsenedSharedCurrentTime,determineRequestsReferrer:determineRequestsReferrer,makePolicyContainer:makePolicyContainer,clonePolicyContainer:clonePolicyContainer,appendFetchMetadata:appendFetchMetadata,appendRequestOriginHeader:appendRequestOriginHeader,TAOCheck:TAOCheck,corsCheck:corsCheck,crossOriginResourcePolicyCheck:crossOriginResourcePolicyCheck,createOpaqueTimingInfo:createOpaqueTimingInfo,setRequestReferrerPolicyOnRedirect:setRequestReferrerPolicyOnRedirect,isValidHTTPToken:isValidHTTPToken,requestBadPort:requestBadPort,requestCurrentURL:requestCurrentURL,responseURL:responseURL,responseLocationURL:responseLocationURL,isBlobLike:isBlobLike,isURLPotentiallyTrustworthy:isURLPotentiallyTrustworthy,isValidReasonPhrase:isValidReasonPhrase,sameOrigin:sameOrigin,normalizeMethod:normalizeMethod,serializeJavascriptValueToJSONString:serializeJavascriptValueToJSONString,iteratorMixin:iteratorMixin,createIterator:createIterator,isValidHeaderName:isValidHeaderName,isValidHeaderValue:isValidHeaderValue,isErrorLike:isErrorLike,fullyReadBody:fullyReadBody,bytesMatch:bytesMatch,isReadableStreamLike:isReadableStreamLike,readableStreamClose:readableStreamClose,isomorphicEncode:isomorphicEncode,urlIsLocal:urlIsLocal,urlHasHttpsScheme:urlHasHttpsScheme,urlIsHttpHttpsScheme:urlIsHttpHttpsScheme,readAllBytes:readAllBytes,simpleRangeHeaderValue:simpleRangeHeaderValue,buildContentRange:buildContentRange,parseMetadata:parseMetadata,createInflate:createInflate,extractMimeType:extractMimeType,getDecodeSplit:getDecodeSplit,utf8DecodeBytes:utf8DecodeBytes,environmentSettingsObject:environmentSettingsObject};