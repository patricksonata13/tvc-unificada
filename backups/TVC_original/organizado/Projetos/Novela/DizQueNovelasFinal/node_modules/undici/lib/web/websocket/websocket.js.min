"use strict";const{webidl:webidl}=require("../fetch/webidl"),{URLSerializer:URLSerializer}=require("../fetch/data-url"),{environmentSettingsObject:environmentSettingsObject}=require("../fetch/util"),{staticPropertyDescriptors:staticPropertyDescriptors,states:states,sentCloseFrameState:sentCloseFrameState,sendHints:sendHints}=require("./constants"),{kWebSocketURL:kWebSocketURL,kReadyState:kReadyState,kController:kController,kBinaryType:kBinaryType,kResponse:kResponse,kSentClose:kSentClose,kByteParser:kByteParser}=require("./symbols"),{isConnecting:isConnecting,isEstablished:isEstablished,isClosing:isClosing,isValidSubprotocol:isValidSubprotocol,fireEvent:fireEvent}=require("./util"),{establishWebSocketConnection:establishWebSocketConnection,closeWebSocketConnection:closeWebSocketConnection}=require("./connection"),{ByteParser:ByteParser}=require("./receiver"),{kEnumerableProperty:kEnumerableProperty,isBlobLike:isBlobLike}=require("../../core/util"),{getGlobalDispatcher:getGlobalDispatcher}=require("../../global"),{types:types}=require("node:util"),{ErrorEvent:ErrorEvent,CloseEvent:CloseEvent}=require("./events"),{SendQueue:SendQueue}=require("./sender");class WebSocket extends EventTarget{#e={open:null,error:null,close:null,message:null};#t=0;#r="";#o="";#s;constructor(e,t=[]){super(),webidl.util.markAsUncloneable(this);const r="WebSocket constructor";webidl.argumentLengthCheck(arguments,1,r);const o=webidl.converters["DOMString or sequence<DOMString> or WebSocketInit"](t,r,"options");e=webidl.converters.USVString(e,r,"url"),t=o.protocols;const s=environmentSettingsObject.settingsObject.baseUrl;let n;try{n=new URL(e,s)}catch(e){throw new DOMException(e,"SyntaxError")}if("http:"===n.protocol?n.protocol="ws:":"https:"===n.protocol&&(n.protocol="wss:"),"ws:"!==n.protocol&&"wss:"!==n.protocol)throw new DOMException(`Expected a ws: or wss: protocol, got ${n.protocol}`,"SyntaxError");if(n.hash||n.href.endsWith("#"))throw new DOMException("Got fragment","SyntaxError");if("string"==typeof t&&(t=[t]),t.length!==new Set(t.map(e=>e.toLowerCase())).size)throw new DOMException("Invalid Sec-WebSocket-Protocol value","SyntaxError");if(t.length>0&&!t.every(e=>isValidSubprotocol(e)))throw new DOMException("Invalid Sec-WebSocket-Protocol value","SyntaxError");this[kWebSocketURL]=new URL(n.href);const i=environmentSettingsObject.settingsObject;this[kController]=establishWebSocketConnection(n,t,i,this,(e,t)=>this.#n(e,t),o),this[kReadyState]=WebSocket.CONNECTING,this[kSentClose]=sentCloseFrameState.NOT_SENT,this[kBinaryType]="blob"}close(e=void 0,t=void 0){webidl.brandCheck(this,WebSocket);const r="WebSocket.close";if(void 0!==e&&(e=webidl.converters["unsigned short"](e,r,"code",{clamp:!0})),void 0!==t&&(t=webidl.converters.USVString(t,r,"reason")),void 0!==e&&1e3!==e&&(e<3e3||e>4999))throw new DOMException("invalid code","InvalidAccessError");let o=0;if(void 0!==t&&(o=Buffer.byteLength(t),o>123))throw new DOMException(`Reason must be less than 123 bytes; received ${o}`,"SyntaxError");closeWebSocketConnection(this,e,t,o)}send(e){webidl.brandCheck(this,WebSocket);const t="WebSocket.send";if(webidl.argumentLengthCheck(arguments,1,t),e=webidl.converters.WebSocketSendData(e,t,"data"),isConnecting(this))throw new DOMException("Sent before connected.","InvalidStateError");if(isEstablished(this)&&!isClosing(this))if("string"==typeof e){const t=Buffer.byteLength(e);this.#t+=t,this.#s.add(e,()=>{this.#t-=t},sendHints.string)}else types.isArrayBuffer(e)?(this.#t+=e.byteLength,this.#s.add(e,()=>{this.#t-=e.byteLength},sendHints.arrayBuffer)):ArrayBuffer.isView(e)?(this.#t+=e.byteLength,this.#s.add(e,()=>{this.#t-=e.byteLength},sendHints.typedArray)):isBlobLike(e)&&(this.#t+=e.size,this.#s.add(e,()=>{this.#t-=e.size},sendHints.blob))}get readyState(){return webidl.brandCheck(this,WebSocket),this[kReadyState]}get bufferedAmount(){return webidl.brandCheck(this,WebSocket),this.#t}get url(){return webidl.brandCheck(this,WebSocket),URLSerializer(this[kWebSocketURL])}get extensions(){return webidl.brandCheck(this,WebSocket),this.#o}get protocol(){return webidl.brandCheck(this,WebSocket),this.#r}get onopen(){return webidl.brandCheck(this,WebSocket),this.#e.open}set onopen(e){webidl.brandCheck(this,WebSocket),this.#e.open&&this.removeEventListener("open",this.#e.open),"function"==typeof e?(this.#e.open=e,this.addEventListener("open",e)):this.#e.open=null}get onerror(){return webidl.brandCheck(this,WebSocket),this.#e.error}set onerror(e){webidl.brandCheck(this,WebSocket),this.#e.error&&this.removeEventListener("error",this.#e.error),"function"==typeof e?(this.#e.error=e,this.addEventListener("error",e)):this.#e.error=null}get onclose(){return webidl.brandCheck(this,WebSocket),this.#e.close}set onclose(e){webidl.brandCheck(this,WebSocket),this.#e.close&&this.removeEventListener("close",this.#e.close),"function"==typeof e?(this.#e.close=e,this.addEventListener("close",e)):this.#e.close=null}get onmessage(){return webidl.brandCheck(this,WebSocket),this.#e.message}set onmessage(e){webidl.brandCheck(this,WebSocket),this.#e.message&&this.removeEventListener("message",this.#e.message),"function"==typeof e?(this.#e.message=e,this.addEventListener("message",e)):this.#e.message=null}get binaryType(){return webidl.brandCheck(this,WebSocket),this[kBinaryType]}set binaryType(e){webidl.brandCheck(this,WebSocket),this[kBinaryType]="blob"!==e&&"arraybuffer"!==e?"blob":e}#n(e,t){this[kResponse]=e;const r=new ByteParser(this,t);r.on("drain",onParserDrain),r.on("error",onParserError.bind(this)),e.socket.ws=this,this[kByteParser]=r,this.#s=new SendQueue(e.socket),this[kReadyState]=states.OPEN;const o=e.headersList.get("sec-websocket-extensions");null!==o&&(this.#o=o);const s=e.headersList.get("sec-websocket-protocol");null!==s&&(this.#r=s),fireEvent("open",this)}}function onParserDrain(){this.ws[kResponse].socket.resume()}function onParserError(e){let t,r;e instanceof CloseEvent?(t=e.reason,r=e.code):t=e.message,fireEvent("error",this,()=>new ErrorEvent("error",{error:e,message:t})),closeWebSocketConnection(this,r)}WebSocket.CONNECTING=WebSocket.prototype.CONNECTING=states.CONNECTING,WebSocket.OPEN=WebSocket.prototype.OPEN=states.OPEN,WebSocket.CLOSING=WebSocket.prototype.CLOSING=states.CLOSING,WebSocket.CLOSED=WebSocket.prototype.CLOSED=states.CLOSED,Object.defineProperties(WebSocket.prototype,{CONNECTING:staticPropertyDescriptors,OPEN:staticPropertyDescriptors,CLOSING:staticPropertyDescriptors,CLOSED:staticPropertyDescriptors,url:kEnumerableProperty,readyState:kEnumerableProperty,bufferedAmount:kEnumerableProperty,onopen:kEnumerableProperty,onerror:kEnumerableProperty,onclose:kEnumerableProperty,close:kEnumerableProperty,onmessage:kEnumerableProperty,binaryType:kEnumerableProperty,send:kEnumerableProperty,extensions:kEnumerableProperty,protocol:kEnumerableProperty,[Symbol.toStringTag]:{value:"WebSocket",writable:!1,enumerable:!1,configurable:!0}}),Object.defineProperties(WebSocket,{CONNECTING:staticPropertyDescriptors,OPEN:staticPropertyDescriptors,CLOSING:staticPropertyDescriptors,CLOSED:staticPropertyDescriptors}),webidl.converters["sequence<DOMString>"]=webidl.sequenceConverter(webidl.converters.DOMString),webidl.converters["DOMString or sequence<DOMString>"]=function(e,t,r){return"Object"===webidl.util.Type(e)&&Symbol.iterator in e?webidl.converters["sequence<DOMString>"](e):webidl.converters.DOMString(e,t,r)},webidl.converters.WebSocketInit=webidl.dictionaryConverter([{key:"protocols",converter:webidl.converters["DOMString or sequence<DOMString>"],defaultValue:()=>new Array(0)},{key:"dispatcher",converter:webidl.converters.any,defaultValue:()=>getGlobalDispatcher()},{key:"headers",converter:webidl.nullableConverter(webidl.converters.HeadersInit)}]),webidl.converters["DOMString or sequence<DOMString> or WebSocketInit"]=function(e){return"Object"!==webidl.util.Type(e)||Symbol.iterator in e?{protocols:webidl.converters["DOMString or sequence<DOMString>"](e)}:webidl.converters.WebSocketInit(e)},webidl.converters.WebSocketSendData=function(e){if("Object"===webidl.util.Type(e)){if(isBlobLike(e))return webidl.converters.Blob(e,{strict:!1});if(ArrayBuffer.isView(e)||types.isArrayBuffer(e))return webidl.converters.BufferSource(e)}return webidl.converters.USVString(e)},module.exports={WebSocket:WebSocket};