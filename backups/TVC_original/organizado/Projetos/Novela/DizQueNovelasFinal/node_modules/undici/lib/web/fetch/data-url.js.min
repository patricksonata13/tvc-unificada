"use strict";const assert=require("node:assert"),encoder=new TextEncoder,HTTP_TOKEN_CODEPOINTS=/^[!#$%&'*+\-.^_|~A-Za-z0-9]+$/,HTTP_WHITESPACE_REGEX=/[\u000A\u000D\u0009\u0020]/,ASCII_WHITESPACE_REPLACE_REGEX=/[\u0009\u000A\u000C\u000D\u0020]/g,HTTP_QUOTED_STRING_TOKENS=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function dataURLProcessor(e){assert("data:"===e.protocol);let t=URLSerializer(e,!0);t=t.slice(5);const i={position:0};let o=collectASequenceOfCodePointsFast(",",t,i);const n=o.length;if(o=removeASCIIWhitespace(o,!0,!0),i.position>=t.length)return"failure";i.position++;let s=stringPercentDecode(t.slice(n+1));if(/;(\u0020){0,}base64$/i.test(o)){if(s=forgivingBase64(isomorphicDecode(s)),"failure"===s)return"failure";o=o.slice(0,-6),o=o.replace(/(\u0020)+$/,""),o=o.slice(0,-1)}o.startsWith(";")&&(o="text/plain"+o);let r=parseMIMEType(o);return"failure"===r&&(r=parseMIMEType("text/plain;charset=US-ASCII")),{mimeType:r,body:s}}function URLSerializer(e,t=!1){if(!t)return e.href;const i=e.href,o=e.hash.length,n=0===o?i:i.substring(0,i.length-o);return!o&&i.endsWith("#")?n.slice(0,-1):n}function collectASequenceOfCodePoints(e,t,i){let o="";for(;i.position<t.length&&e(t[i.position]);)o+=t[i.position],i.position++;return o}function collectASequenceOfCodePointsFast(e,t,i){const o=t.indexOf(e,i.position),n=i.position;return-1===o?(i.position=t.length,t.slice(n)):(i.position=o,t.slice(n,i.position))}function stringPercentDecode(e){return percentDecode(encoder.encode(e))}function isHexCharByte(e){return e>=48&&e<=57||e>=65&&e<=70||e>=97&&e<=102}function hexByteToNumber(e){return e>=48&&e<=57?e-48:(223&e)-55}function percentDecode(e){const t=e.length,i=new Uint8Array(t);let o=0;for(let n=0;n<t;++n){const t=e[n];37!==t?i[o++]=t:37!==t||isHexCharByte(e[n+1])&&isHexCharByte(e[n+2])?(i[o++]=hexByteToNumber(e[n+1])<<4|hexByteToNumber(e[n+2]),n+=2):i[o++]=37}return t===o?i:i.subarray(0,o)}function parseMIMEType(e){const t={position:0},i=collectASequenceOfCodePointsFast("/",e=removeHTTPWhitespace(e,!0,!0),t);if(0===i.length||!HTTP_TOKEN_CODEPOINTS.test(i))return"failure";if(t.position>e.length)return"failure";t.position++;let o=collectASequenceOfCodePointsFast(";",e,t);if(o=removeHTTPWhitespace(o,!1,!0),0===o.length||!HTTP_TOKEN_CODEPOINTS.test(o))return"failure";const n=i.toLowerCase(),s=o.toLowerCase(),r={type:n,subtype:s,parameters:new Map,essence:`${n}/${s}`};for(;t.position<e.length;){t.position++,collectASequenceOfCodePoints(e=>HTTP_WHITESPACE_REGEX.test(e),e,t);let i=collectASequenceOfCodePoints(e=>";"!==e&&"="!==e,e,t);if(i=i.toLowerCase(),t.position<e.length){if(";"===e[t.position])continue;t.position++}if(t.position>e.length)break;let o=null;if('"'===e[t.position])o=collectAnHTTPQuotedString(e,t,!0),collectASequenceOfCodePointsFast(";",e,t);else if(o=collectASequenceOfCodePointsFast(";",e,t),o=removeHTTPWhitespace(o,!1,!0),0===o.length)continue;0===i.length||!HTTP_TOKEN_CODEPOINTS.test(i)||0!==o.length&&!HTTP_QUOTED_STRING_TOKENS.test(o)||r.parameters.has(i)||r.parameters.set(i,o)}return r}function forgivingBase64(e){let t=(e=e.replace(ASCII_WHITESPACE_REPLACE_REGEX,"")).length;if(t%4==0&&61===e.charCodeAt(t-1)&&(--t,61===e.charCodeAt(t-1)&&--t),t%4==1)return"failure";if(/[^+/0-9A-Za-z]/.test(e.length===t?e:e.substring(0,t)))return"failure";const i=Buffer.from(e,"base64");return new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function collectAnHTTPQuotedString(e,t,i){const o=t.position;let n="";for(assert('"'===e[t.position]),t.position++;n+=collectASequenceOfCodePoints(e=>'"'!==e&&"\\"!==e,e,t),!(t.position>=e.length);){const i=e[t.position];if(t.position++,"\\"!==i){assert('"'===i);break}if(t.position>=e.length){n+="\\";break}n+=e[t.position],t.position++}return i?n:e.slice(o,t.position)}function serializeAMimeType(e){assert("failure"!==e);const{parameters:t,essence:i}=e;let o=i;for(let[e,i]of t.entries())o+=";",o+=e,o+="=",HTTP_TOKEN_CODEPOINTS.test(i)||(i=i.replace(/(\\|")/g,"\\$1"),i='"'+i,i+='"'),o+=i;return o}function isHTTPWhiteSpace(e){return 13===e||10===e||9===e||32===e}function removeHTTPWhitespace(e,t=!0,i=!0){return removeChars(e,t,i,isHTTPWhiteSpace)}function isASCIIWhitespace(e){return 13===e||10===e||9===e||12===e||32===e}function removeASCIIWhitespace(e,t=!0,i=!0){return removeChars(e,t,i,isASCIIWhitespace)}function removeChars(e,t,i,o){let n=0,s=e.length-1;if(t)for(;n<e.length&&o(e.charCodeAt(n));)n++;if(i)for(;s>0&&o(e.charCodeAt(s));)s--;return 0===n&&s===e.length-1?e:e.slice(n,s+1)}function isomorphicDecode(e){const t=e.length;if(65535>t)return String.fromCharCode.apply(null,e);let i="",o=0,n=65535;for(;o<t;)o+n>t&&(n=t-o),i+=String.fromCharCode.apply(null,e.subarray(o,o+=n));return i}function minimizeSupportedMimeType(e){switch(e.essence){case"application/ecmascript":case"application/javascript":case"application/x-ecmascript":case"application/x-javascript":case"text/ecmascript":case"text/javascript":case"text/javascript1.0":case"text/javascript1.1":case"text/javascript1.2":case"text/javascript1.3":case"text/javascript1.4":case"text/javascript1.5":case"text/jscript":case"text/livescript":case"text/x-ecmascript":case"text/x-javascript":return"text/javascript";case"application/json":case"text/json":return"application/json";case"image/svg+xml":return"image/svg+xml";case"text/xml":case"application/xml":return"application/xml"}return e.subtype.endsWith("+json")?"application/json":e.subtype.endsWith("+xml")?"application/xml":""}module.exports={dataURLProcessor:dataURLProcessor,URLSerializer:URLSerializer,collectASequenceOfCodePoints:collectASequenceOfCodePoints,collectASequenceOfCodePointsFast:collectASequenceOfCodePointsFast,stringPercentDecode:stringPercentDecode,parseMIMEType:parseMIMEType,collectAnHTTPQuotedString:collectAnHTTPQuotedString,serializeAMimeType:serializeAMimeType,removeChars:removeChars,removeHTTPWhitespace:removeHTTPWhitespace,minimizeSupportedMimeType:minimizeSupportedMimeType,HTTP_TOKEN_CODEPOINTS:HTTP_TOKEN_CODEPOINTS,isomorphicDecode:isomorphicDecode};