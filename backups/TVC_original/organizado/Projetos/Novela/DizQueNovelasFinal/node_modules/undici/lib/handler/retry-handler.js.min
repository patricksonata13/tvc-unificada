"use strict";const assert=require("node:assert"),{kRetryHandlerDefaultRetry:kRetryHandlerDefaultRetry}=require("../core/symbols"),{RequestRetryError:RequestRetryError}=require("../core/errors"),{isDisturbed:isDisturbed,parseHeaders:parseHeaders,parseRangeHeader:parseRangeHeader,wrapRequestBody:wrapRequestBody}=require("../core/util");function calculateRetryAfterHeader(t){const e=Date.now();return new Date(t).getTime()-e}class RetryHandler{constructor(t,e){const{retryOptions:r,...s}=t,{retry:n,maxRetries:i,maxTimeout:a,minTimeout:o,timeoutFactor:h,methods:u,errorCodes:d,retryAfter:l,statusCodes:y}=r??{};this.dispatch=e.dispatch,this.handler=e.handler,this.opts={...s,body:wrapRequestBody(t.body)},this.abort=null,this.aborted=!1,this.retryOpts={retry:n??RetryHandler[kRetryHandlerDefaultRetry],retryAfter:l??!0,maxTimeout:a??3e4,minTimeout:o??500,timeoutFactor:h??2,maxRetries:i??5,methods:u??["GET","HEAD","OPTIONS","PUT","DELETE","TRACE"],statusCodes:y??[500,502,503,504,429],errorCodes:d??["ECONNRESET","ECONNREFUSED","ENOTFOUND","ENETDOWN","ENETUNREACH","EHOSTDOWN","EHOSTUNREACH","EPIPE","UND_ERR_SOCKET"]},this.retryCount=0,this.retryCountCheckpoint=0,this.start=0,this.end=null,this.etag=null,this.resume=null,this.handler.onConnect(t=>{this.aborted=!0,this.abort?this.abort(t):this.reason=t})}onRequestSent(){this.handler.onRequestSent&&this.handler.onRequestSent()}onUpgrade(t,e,r){this.handler.onUpgrade&&this.handler.onUpgrade(t,e,r)}onConnect(t){this.aborted?t(this.reason):this.abort=t}onBodySent(t){if(this.handler.onBodySent)return this.handler.onBodySent(t)}static[kRetryHandlerDefaultRetry](t,{state:e,opts:r},s){const{statusCode:n,code:i,headers:a}=t,{method:o,retryOptions:h}=r,{maxRetries:u,minTimeout:d,maxTimeout:l,timeoutFactor:y,statusCodes:c,errorCodes:R,methods:m}=h,{counter:p}=e;if(i&&"UND_ERR_REQ_RETRY"!==i&&!R.includes(i))return void s(t);if(Array.isArray(m)&&!m.includes(o))return void s(t);if(null!=n&&Array.isArray(c)&&!c.includes(n))return void s(t);if(p>u)return void s(t);let C=a?.["retry-after"];C&&(C=Number(C),C=Number.isNaN(C)?calculateRetryAfterHeader(C):1e3*C);const E=C>0?Math.min(C,l):Math.min(d*y**(p-1),l);setTimeout(()=>s(null),E)}onHeaders(t,e,r,s){const n=parseHeaders(e);if(this.retryCount+=1,t>=300)return!1===this.retryOpts.statusCodes.includes(t)?this.handler.onHeaders(t,e,r,s):(this.abort(new RequestRetryError("Request failed",t,{headers:n,data:{count:this.retryCount}})),!1);if(null!=this.resume){if(this.resume=null,206!==t&&(this.start>0||200!==t))return this.abort(new RequestRetryError("server does not support the range header and the payload was partially consumed",t,{headers:n,data:{count:this.retryCount}})),!1;const e=parseRangeHeader(n["content-range"]);if(!e)return this.abort(new RequestRetryError("Content-Range mismatch",t,{headers:n,data:{count:this.retryCount}})),!1;if(null!=this.etag&&this.etag!==n.etag)return this.abort(new RequestRetryError("ETag mismatch",t,{headers:n,data:{count:this.retryCount}})),!1;const{start:s,size:i,end:a=i-1}=e;return assert(this.start===s,"content-range mismatch"),assert(null==this.end||this.end===a,"content-range mismatch"),this.resume=r,!0}if(null==this.end){if(206===t){const i=parseRangeHeader(n["content-range"]);if(null==i)return this.handler.onHeaders(t,e,r,s);const{start:a,size:o,end:h=o-1}=i;assert(null!=a&&Number.isFinite(a),"content-range mismatch"),assert(null!=h&&Number.isFinite(h),"invalid content-length"),this.start=a,this.end=h}if(null==this.end){const t=n["content-length"];this.end=null!=t?Number(t)-1:null}return assert(Number.isFinite(this.start)),assert(null==this.end||Number.isFinite(this.end),"invalid content-length"),this.resume=r,this.etag=null!=n.etag?n.etag:null,null!=this.etag&&this.etag.startsWith("W/")&&(this.etag=null),this.handler.onHeaders(t,e,r,s)}const i=new RequestRetryError("Request failed",t,{headers:n,data:{count:this.retryCount}});return this.abort(i),!1}onData(t){return this.start+=t.length,this.handler.onData(t)}onComplete(t){return this.retryCount=0,this.handler.onComplete(t)}onError(t){if(this.aborted||isDisturbed(this.opts.body))return this.handler.onError(t);this.retryCount-this.retryCountCheckpoint>0?this.retryCount=this.retryCountCheckpoint+(this.retryCount-this.retryCountCheckpoint):this.retryCount+=1,this.retryOpts.retry(t,{state:{counter:this.retryCount},opts:{retryOptions:this.retryOpts,...this.opts}},function(t){if(null!=t||this.aborted||isDisturbed(this.opts.body))return this.handler.onError(t);if(0!==this.start){const t={range:`bytes=${this.start}-${this.end??""}`};null!=this.etag&&(t["if-match"]=this.etag),this.opts={...this.opts,headers:{...this.opts.headers,...t}}}try{this.retryCountCheckpoint=this.retryCount,this.dispatch(this.opts,this)}catch(t){this.handler.onError(t)}}.bind(this))}}module.exports=RetryHandler;