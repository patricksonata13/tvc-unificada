const assert=require("node:assert"),{ResponseStatusCodeError:ResponseStatusCodeError}=require("../core/errors"),{chunksDecode:chunksDecode}=require("./readable"),CHUNK_LIMIT=131072;async function getResolveErrorBodyCallback({callback:e,body:t,contentType:o,statusCode:s,statusMessage:r,headers:n}){assert(t);let a=[],c=0;try{for await(const e of t)if(a.push(e),c+=e.length,c>131072){a=[],c=0;break}}catch{a=[],c=0}const i=`Response status code ${s}${r?`: ${r}`:""}`;if(204===s||!o||!c)return void queueMicrotask(()=>e(new ResponseStatusCodeError(i,s,n)));const p=Error.stackTraceLimit;let l;Error.stackTraceLimit=0;try{isContentTypeApplicationJson(o)?l=JSON.parse(chunksDecode(a,c)):isContentTypeText(o)&&(l=chunksDecode(a,c))}catch{}finally{Error.stackTraceLimit=p}queueMicrotask(()=>e(new ResponseStatusCodeError(i,s,n,l)))}const isContentTypeApplicationJson=e=>e.length>15&&"/"===e[11]&&"a"===e[0]&&"p"===e[1]&&"p"===e[2]&&"l"===e[3]&&"i"===e[4]&&"c"===e[5]&&"a"===e[6]&&"t"===e[7]&&"i"===e[8]&&"o"===e[9]&&"n"===e[10]&&"j"===e[12]&&"s"===e[13]&&"o"===e[14]&&"n"===e[15],isContentTypeText=e=>e.length>4&&"/"===e[4]&&"t"===e[0]&&"e"===e[1]&&"x"===e[2]&&"t"===e[3];module.exports={getResolveErrorBodyCallback:getResolveErrorBodyCallback,isContentTypeApplicationJson:isContentTypeApplicationJson,isContentTypeText:isContentTypeText};