"use strict";const assert=require("node:assert"),{Readable:Readable}=require("./readable"),{InvalidArgumentError:InvalidArgumentError,RequestAbortedError:RequestAbortedError}=require("../core/errors"),util=require("../core/util"),{getResolveErrorBodyCallback:getResolveErrorBodyCallback}=require("./util"),{AsyncResource:AsyncResource}=require("node:async_hooks");class RequestHandler extends AsyncResource{constructor(e,r){if(!e||"object"!=typeof e)throw new InvalidArgumentError("invalid opts");const{signal:t,method:s,opaque:o,body:n,onInfo:i,responseHeaders:a,throwOnError:l,highWaterMark:u}=e;try{if("function"!=typeof r)throw new InvalidArgumentError("invalid callback");if(u&&("number"!=typeof u||u<0))throw new InvalidArgumentError("invalid highWaterMark");if(t&&"function"!=typeof t.on&&"function"!=typeof t.addEventListener)throw new InvalidArgumentError("signal must be an EventEmitter or EventTarget");if("CONNECT"===s)throw new InvalidArgumentError("invalid method");if(i&&"function"!=typeof i)throw new InvalidArgumentError("invalid onInfo callback");super("UNDICI_REQUEST")}catch(e){throw util.isStream(n)&&util.destroy(n.on("error",util.nop),e),e}this.method=s,this.responseHeaders=a||null,this.opaque=o||null,this.callback=r,this.res=null,this.abort=null,this.body=n,this.trailers={},this.context=null,this.onInfo=i||null,this.throwOnError=l,this.highWaterMark=u,this.signal=t,this.reason=null,this.removeAbortListener=null,util.isStream(n)&&n.on("error",e=>{this.onError(e)}),this.signal&&(this.signal.aborted?this.reason=this.signal.reason??new RequestAbortedError:this.removeAbortListener=util.addAbortListener(this.signal,()=>{this.reason=this.signal.reason??new RequestAbortedError,this.res?util.destroy(this.res.on("error",util.nop),this.reason):this.abort&&this.abort(this.reason),this.removeAbortListener&&(this.res?.off("close",this.removeAbortListener),this.removeAbortListener(),this.removeAbortListener=null)}))}onConnect(e,r){this.reason?e(this.reason):(assert(this.callback),this.abort=e,this.context=r)}onHeaders(e,r,t,s){const{callback:o,opaque:n,abort:i,context:a,responseHeaders:l,highWaterMark:u}=this,h="raw"===l?util.parseRawHeaders(r):util.parseHeaders(r);if(e<200)return void(this.onInfo&&this.onInfo({statusCode:e,headers:h}));const c="raw"===l?util.parseHeaders(r):h,d=c["content-type"],b=c["content-length"],p=new Readable({resume:t,abort:i,contentType:d,contentLength:"HEAD"!==this.method&&b?Number(b):null,highWaterMark:u});this.removeAbortListener&&p.on("close",this.removeAbortListener),this.callback=null,this.res=p,null!==o&&(this.throwOnError&&e>=400?this.runInAsyncScope(getResolveErrorBodyCallback,null,{callback:o,body:p,contentType:d,statusCode:e,statusMessage:s,headers:h}):this.runInAsyncScope(o,null,null,{statusCode:e,headers:h,trailers:this.trailers,opaque:n,body:p,context:a}))}onData(e){return this.res.push(e)}onComplete(e){util.parseHeaders(e,this.trailers),this.res.push(null)}onError(e){const{res:r,callback:t,body:s,opaque:o}=this;t&&(this.callback=null,queueMicrotask(()=>{this.runInAsyncScope(t,null,e,{opaque:o})})),r&&(this.res=null,queueMicrotask(()=>{util.destroy(r,e)})),s&&(this.body=null,util.destroy(s,e)),this.removeAbortListener&&(r?.off("close",this.removeAbortListener),this.removeAbortListener(),this.removeAbortListener=null)}}function request(e,r){if(void 0===r)return new Promise((r,t)=>{request.call(this,e,(e,s)=>e?t(e):r(s))});try{this.dispatch(e,new RequestHandler(e,r))}catch(t){if("function"!=typeof r)throw t;const s=e?.opaque;queueMicrotask(()=>r(t,{opaque:s}))}}module.exports=request,module.exports.RequestHandler=RequestHandler;