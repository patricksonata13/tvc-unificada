"use strict";const assert=require("node:assert"),{Readable:Readable}=require("node:stream"),{RequestAbortedError:RequestAbortedError,NotSupportedError:NotSupportedError,InvalidArgumentError:InvalidArgumentError,AbortError:AbortError}=require("../core/errors"),util=require("../core/util"),{ReadableStreamFrom:ReadableStreamFrom}=require("../core/util"),kConsume=Symbol("kConsume"),kReading=Symbol("kReading"),kBody=Symbol("kBody"),kAbort=Symbol("kAbort"),kContentType=Symbol("kContentType"),kContentLength=Symbol("kContentLength"),noop=()=>{};class BodyReadable extends Readable{constructor({resume:e,abort:t,contentType:r="",contentLength:n,highWaterMark:o=65536}){super({autoDestroy:!0,read:e,highWaterMark:o}),this._readableState.dataEmitted=!1,this[kAbort]=t,this[kConsume]=null,this[kBody]=null,this[kContentType]=r,this[kContentLength]=n,this[kReading]=!1}destroy(e){return e||this._readableState.endEmitted||(e=new RequestAbortedError),e&&this[kAbort](),super.destroy(e)}_destroy(e,t){this[kReading]?t(e):setImmediate(()=>{t(e)})}on(e,...t){return"data"!==e&&"readable"!==e||(this[kReading]=!0),super.on(e,...t)}addListener(e,...t){return this.on(e,...t)}off(e,...t){const r=super.off(e,...t);return"data"!==e&&"readable"!==e||(this[kReading]=this.listenerCount("data")>0||this.listenerCount("readable")>0),r}removeListener(e,...t){return this.off(e,...t)}push(e){return this[kConsume]&&null!==e?(consumePush(this[kConsume],e),!this[kReading]||super.push(e)):super.push(e)}async text(){return consume(this,"text")}async json(){return consume(this,"json")}async blob(){return consume(this,"blob")}async bytes(){return consume(this,"bytes")}async arrayBuffer(){return consume(this,"arrayBuffer")}async formData(){throw new NotSupportedError}get bodyUsed(){return util.isDisturbed(this)}get body(){return this[kBody]||(this[kBody]=ReadableStreamFrom(this),this[kConsume]&&(this[kBody].getReader(),assert(this[kBody].locked))),this[kBody]}async dump(e){let t=Number.isFinite(e?.limit)?e.limit:131072;const r=e?.signal;if(null!=r&&("object"!=typeof r||!("aborted"in r)))throw new InvalidArgumentError("signal must be an AbortSignal");return r?.throwIfAborted(),this._readableState.closeEmitted?null:await new Promise((e,n)=>{this[kContentLength]>t&&this.destroy(new AbortError);const o=()=>{this.destroy(r.reason??new AbortError)};r?.addEventListener("abort",o),this.on("close",function(){r?.removeEventListener("abort",o),r?.aborted?n(r.reason??new AbortError):e(null)}).on("error",noop).on("data",function(e){t-=e.length,t<=0&&this.destroy()}).resume()})}}function isLocked(e){return e[kBody]&&!0===e[kBody].locked||e[kConsume]}function isUnusable(e){return util.isDisturbed(e)||isLocked(e)}async function consume(e,t){return assert(!e[kConsume]),new Promise((r,n)=>{if(isUnusable(e)){const t=e._readableState;t.destroyed&&!1===t.closeEmitted?e.on("error",e=>{n(e)}).on("close",()=>{n(new TypeError("unusable"))}):n(t.errored??new TypeError("unusable"))}else queueMicrotask(()=>{e[kConsume]={type:t,stream:e,resolve:r,reject:n,length:0,body:[]},e.on("error",function(e){consumeFinish(this[kConsume],e)}).on("close",function(){null!==this[kConsume].body&&consumeFinish(this[kConsume],new RequestAbortedError)}),consumeStart(e[kConsume])})})}function consumeStart(e){if(null===e.body)return;const{_readableState:t}=e.stream;if(t.bufferIndex){const r=t.bufferIndex,n=t.buffer.length;for(let o=r;o<n;o++)consumePush(e,t.buffer[o])}else for(const r of t.buffer)consumePush(e,r);for(t.endEmitted?consumeEnd(this[kConsume]):e.stream.on("end",function(){consumeEnd(this[kConsume])}),e.stream.resume();null!=e.stream.read(););}function chunksDecode(e,t){if(0===e.length||0===t)return"";const r=1===e.length?e[0]:Buffer.concat(e,t),n=r.length,o=n>2&&239===r[0]&&187===r[1]&&191===r[2]?3:0;return r.utf8Slice(o,n)}function chunksConcat(e,t){if(0===e.length||0===t)return new Uint8Array(0);if(1===e.length)return new Uint8Array(e[0]);const r=new Uint8Array(Buffer.allocUnsafeSlow(t).buffer);let n=0;for(let t=0;t<e.length;++t){const o=e[t];r.set(o,n),n+=o.length}return r}function consumeEnd(e){const{type:t,body:r,resolve:n,stream:o,length:s}=e;try{"text"===t?n(chunksDecode(r,s)):"json"===t?n(JSON.parse(chunksDecode(r,s))):"arrayBuffer"===t?n(chunksConcat(r,s).buffer):"blob"===t?n(new Blob(r,{type:o[kContentType]})):"bytes"===t&&n(chunksConcat(r,s)),consumeFinish(e)}catch(e){o.destroy(e)}}function consumePush(e,t){e.length+=t.length,e.body.push(t)}function consumeFinish(e,t){null!==e.body&&(t?e.reject(t):e.resolve(),e.type=null,e.stream=null,e.resolve=null,e.reject=null,e.length=0,e.body=null)}module.exports={Readable:BodyReadable,chunksDecode:chunksDecode};