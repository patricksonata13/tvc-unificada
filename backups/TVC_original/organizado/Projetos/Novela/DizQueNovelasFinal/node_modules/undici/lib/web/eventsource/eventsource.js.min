"use strict";const{pipeline:pipeline}=require("node:stream"),{fetching:fetching}=require("../fetch"),{makeRequest:makeRequest}=require("../fetch/request"),{webidl:webidl}=require("../fetch/webidl"),{EventSourceStream:EventSourceStream}=require("./eventsource-stream"),{parseMIMEType:parseMIMEType}=require("../fetch/data-url"),{createFastMessageEvent:createFastMessageEvent}=require("../websocket/events"),{isNetworkError:isNetworkError}=require("../fetch/response"),{delay:delay}=require("./util"),{kEnumerableProperty:kEnumerableProperty}=require("../../core/util"),{environmentSettingsObject:environmentSettingsObject}=require("../fetch/util");let experimentalWarned=!1;const defaultReconnectionTime=3e3,CONNECTING=0,OPEN=1,CLOSED=2,ANONYMOUS="anonymous",USE_CREDENTIALS="use-credentials";class EventSource extends EventTarget{#e={open:null,error:null,message:null};#t=null;#r=!1;#n=0;#s=null;#i=null;#o;#a;constructor(e,t={}){super(),webidl.util.markAsUncloneable(this);const r="EventSource constructor";webidl.argumentLengthCheck(arguments,1,r),experimentalWarned||(experimentalWarned=!0,process.emitWarning("EventSource is experimental, expect them to change at any time.",{code:"UNDICI-ES"})),e=webidl.converters.USVString(e,r,"url"),t=webidl.converters.EventSourceInitDict(t,r,"eventSourceInitDict"),this.#o=t.dispatcher,this.#a={lastEventId:"",reconnectionTime:3e3};const n=environmentSettingsObject;let s;try{s=new URL(e,n.settingsObject.baseUrl),this.#a.origin=s.origin}catch(e){throw new DOMException(e,"SyntaxError")}this.#t=s.href;let i=ANONYMOUS;t.withCredentials&&(i=USE_CREDENTIALS,this.#r=!0);const o={redirect:"follow",keepalive:!0,mode:"cors",credentials:"anonymous"===i?"same-origin":"omit",referrer:"no-referrer"};o.client=environmentSettingsObject.settingsObject,o.headersList=[["accept",{name:"accept",value:"text/event-stream"}]],o.cache="no-store",o.initiator="other",o.urlList=[new URL(this.#t)],this.#s=makeRequest(o),this.#c()}get readyState(){return this.#n}get url(){return this.#t}get withCredentials(){return this.#r}#c(){if(2===this.#n)return;this.#n=0;const e={request:this.#s,dispatcher:this.#o};e.processResponseEndOfBody=e=>{isNetworkError(e)&&(this.dispatchEvent(new Event("error")),this.close()),this.#l()},e.processResponse=e=>{if(isNetworkError(e))return e.aborted?(this.close(),void this.dispatchEvent(new Event("error"))):void this.#l();const t=e.headersList.get("content-type",!0),r=null!==t?parseMIMEType(t):"failure",n="failure"!==r&&"text/event-stream"===r.essence;if(200!==e.status||!1===n)return this.close(),void this.dispatchEvent(new Event("error"));this.#n=1,this.dispatchEvent(new Event("open")),this.#a.origin=e.urlList[e.urlList.length-1].origin;const s=new EventSourceStream({eventSourceSettings:this.#a,push:e=>{this.dispatchEvent(createFastMessageEvent(e.type,e.options))}});pipeline(e.body.stream,s,e=>{!1===e?.aborted&&(this.close(),this.dispatchEvent(new Event("error")))})},this.#i=fetching(e)}async#l(){2!==this.#n&&(this.#n=0,this.dispatchEvent(new Event("error")),await delay(this.#a.reconnectionTime),0===this.#n&&(this.#a.lastEventId.length&&this.#s.headersList.set("last-event-id",this.#a.lastEventId,!0),this.#c()))}close(){webidl.brandCheck(this,EventSource),2!==this.#n&&(this.#n=2,this.#i.abort(),this.#s=null)}get onopen(){return this.#e.open}set onopen(e){this.#e.open&&this.removeEventListener("open",this.#e.open),"function"==typeof e?(this.#e.open=e,this.addEventListener("open",e)):this.#e.open=null}get onmessage(){return this.#e.message}set onmessage(e){this.#e.message&&this.removeEventListener("message",this.#e.message),"function"==typeof e?(this.#e.message=e,this.addEventListener("message",e)):this.#e.message=null}get onerror(){return this.#e.error}set onerror(e){this.#e.error&&this.removeEventListener("error",this.#e.error),"function"==typeof e?(this.#e.error=e,this.addEventListener("error",e)):this.#e.error=null}}const constantsPropertyDescriptors={CONNECTING:{__proto__:null,configurable:!1,enumerable:!0,value:0,writable:!1},OPEN:{__proto__:null,configurable:!1,enumerable:!0,value:1,writable:!1},CLOSED:{__proto__:null,configurable:!1,enumerable:!0,value:2,writable:!1}};Object.defineProperties(EventSource,constantsPropertyDescriptors),Object.defineProperties(EventSource.prototype,constantsPropertyDescriptors),Object.defineProperties(EventSource.prototype,{close:kEnumerableProperty,onerror:kEnumerableProperty,onmessage:kEnumerableProperty,onopen:kEnumerableProperty,readyState:kEnumerableProperty,url:kEnumerableProperty,withCredentials:kEnumerableProperty}),webidl.converters.EventSourceInitDict=webidl.dictionaryConverter([{key:"withCredentials",converter:webidl.converters.boolean,defaultValue:()=>!1},{key:"dispatcher",converter:webidl.converters.any}]),module.exports={EventSource:EventSource,defaultReconnectionTime:3e3};