"use strict";const{isIP:isIP}=require("node:net"),{lookup:lookup}=require("node:dns"),DecoratorHandler=require("../handler/decorator-handler"),{InvalidArgumentError:InvalidArgumentError,InformationalError:InformationalError}=require("../core/errors"),maxInt=Math.pow(2,31)-1;class DNSInstance{#t=0;#n=0;#r=new Map;dualStack=!0;affinity=null;lookup=null;pick=null;constructor(t){this.#t=t.maxTTL,this.#n=t.maxItems,this.dualStack=t.dualStack,this.affinity=t.affinity,this.lookup=t.lookup??this.#e,this.pick=t.pick??this.#o}get full(){return this.#r.size===this.#n}runLookup(t,n,r){const e=this.#r.get(t.hostname);if(null==e&&this.full)return void r(null,t.origin);const o={affinity:this.affinity,dualStack:this.dualStack,lookup:this.lookup,pick:this.pick,...n.dns,maxTTL:this.#t,maxItems:this.#n};if(null==e)this.lookup(t,o,(n,e)=>{if(n||null==e||0===e.length)return void r(n??new InformationalError("No DNS entries found"));this.setRecords(t,e);const i=this.#r.get(t.hostname),s=this.pick(t,i,o.affinity);let l;l="number"==typeof s.port?`:${s.port}`:""!==t.port?`:${t.port}`:"",r(null,`${t.protocol}//${6===s.family?`[${s.address}]`:s.address}${l}`)});else{const i=this.pick(t,e,o.affinity);if(null==i)return this.#r.delete(t.hostname),void this.runLookup(t,n,r);let s;s="number"==typeof i.port?`:${i.port}`:""!==t.port?`:${t.port}`:"",r(null,`${t.protocol}//${6===i.family?`[${i.address}]`:i.address}${s}`)}}#e(t,n,r){lookup(t.hostname,{all:!0,family:!1===this.dualStack?this.affinity:0,order:"ipv4first"},(t,n)=>{if(t)return r(t);const e=new Map;for(const t of n)e.set(`${t.address}:${t.family}`,t);r(null,e.values())})}#o(t,n,r){let e=null;const{records:o,offset:i}=n;let s;if(this.dualStack?(null==r&&(null==i||i===maxInt?(n.offset=0,r=4):(n.offset++,r=1&~n.offset?4:6)),s=null!=o[r]&&o[r].ips.length>0?o[r]:o[4===r?6:4]):s=o[r],null==s||0===s.ips.length)return e;null==s.offset||s.offset===maxInt?s.offset=0:s.offset++;const l=s.offset%s.ips.length;return e=s.ips[l]??null,null==e?e:Date.now()-e.timestamp>e.ttl?(s.ips.splice(l,1),this.pick(t,n,r)):e}setRecords(t,n){const r=Date.now(),e={records:{4:null,6:null}};for(const t of n){t.timestamp=r,"number"==typeof t.ttl?t.ttl=Math.min(t.ttl,this.#t):t.ttl=this.#t;const n=e.records[t.family]??{ips:[]};n.ips.push(t),e.records[t.family]=n}this.#r.set(t.hostname,e)}getHandler(t,n){return new DNSDispatchHandler(this,t,n)}}class DNSDispatchHandler extends DecoratorHandler{#i=null;#s=null;#l=null;#a=null;#u=null;constructor(t,{origin:n,handler:r,dispatch:e},o){super(r),this.#u=n,this.#a=r,this.#s={...o},this.#i=t,this.#l=e}onError(t){switch(t.code){case"ETIMEDOUT":case"ECONNREFUSED":return this.#i.dualStack?void this.#i.runLookup(this.#u,this.#s,(t,n)=>{if(t)return this.#a.onError(t);const r={...this.#s,origin:n};this.#l(r,this)}):void this.#a.onError(t);case"ENOTFOUND":this.#i.deleteRecord(this.#u);default:this.#a.onError(t)}}}module.exports=t=>{if(null!=t?.maxTTL&&("number"!=typeof t?.maxTTL||t?.maxTTL<0))throw new InvalidArgumentError("Invalid maxTTL. Must be a positive number");if(null!=t?.maxItems&&("number"!=typeof t?.maxItems||t?.maxItems<1))throw new InvalidArgumentError("Invalid maxItems. Must be a positive number and greater than zero");if(null!=t?.affinity&&4!==t?.affinity&&6!==t?.affinity)throw new InvalidArgumentError("Invalid affinity. Must be either 4 or 6");if(null!=t?.dualStack&&"boolean"!=typeof t?.dualStack)throw new InvalidArgumentError("Invalid dualStack. Must be a boolean");if(null!=t?.lookup&&"function"!=typeof t?.lookup)throw new InvalidArgumentError("Invalid lookup. Must be a function");if(null!=t?.pick&&"function"!=typeof t?.pick)throw new InvalidArgumentError("Invalid pick. Must be a function");const n=t?.dualStack??!0;let r;r=n?t?.affinity??null:t?.affinity??4;const e=new DNSInstance({maxTTL:t?.maxTTL??1e4,lookup:t?.lookup??null,pick:t?.pick??null,dualStack:n,affinity:r,maxItems:t?.maxItems??1/0});return t=>function(n,r){const o=n.origin.constructor===URL?n.origin:new URL(n.origin);return 0!==isIP(o.hostname)?t(n,r):(e.runLookup(o,n,(i,s)=>{if(i)return r.onError(i);let l=null;l={...n,servername:o.hostname,origin:s,headers:{host:o.hostname,...n.headers}},t(l,e.getHandler({origin:o,dispatch:t,handler:r},n))}),!0)}};