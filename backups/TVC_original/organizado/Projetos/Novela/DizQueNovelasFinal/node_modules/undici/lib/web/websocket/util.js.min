"use strict";const{kReadyState:kReadyState,kController:kController,kResponse:kResponse,kBinaryType:kBinaryType,kWebSocketURL:kWebSocketURL}=require("./symbols"),{states:states,opcodes:opcodes}=require("./constants"),{ErrorEvent:ErrorEvent,createFastMessageEvent:createFastMessageEvent}=require("./events"),{isUtf8:isUtf8}=require("node:buffer"),{collectASequenceOfCodePointsFast:collectASequenceOfCodePointsFast,removeHTTPWhitespace:removeHTTPWhitespace}=require("../fetch/data-url");function isConnecting(e){return e[kReadyState]===states.CONNECTING}function isEstablished(e){return e[kReadyState]===states.OPEN}function isClosing(e){return e[kReadyState]===states.CLOSING}function isClosed(e){return e[kReadyState]===states.CLOSED}function fireEvent(e,t,o=(e,t)=>new Event(e,t),n={}){const s=o(e,n);t.dispatchEvent(s)}function websocketMessageReceived(e,t,o){if(e[kReadyState]!==states.OPEN)return;let n;if(t===opcodes.TEXT)try{n=utf8Decode(o)}catch{return void failWebsocketConnection(e,"Received invalid UTF-8 in text frame.")}else t===opcodes.BINARY&&(n="blob"===e[kBinaryType]?new Blob([o]):toArrayBuffer(o));fireEvent("message",e,createFastMessageEvent,{origin:e[kWebSocketURL].origin,data:n})}function toArrayBuffer(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function isValidSubprotocol(e){if(0===e.length)return!1;for(let t=0;t<e.length;++t){const o=e.charCodeAt(t);if(o<33||o>126||34===o||40===o||41===o||44===o||47===o||58===o||59===o||60===o||61===o||62===o||63===o||64===o||91===o||92===o||93===o||123===o||125===o)return!1}return!0}function isValidStatusCode(e){return e>=1e3&&e<1015?1004!==e&&1005!==e&&1006!==e:e>=3e3&&e<=4999}function failWebsocketConnection(e,t){const{[kController]:o,[kResponse]:n}=e;o.abort(),n?.socket&&!n.socket.destroyed&&n.socket.destroy(),t&&fireEvent("error",e,(e,t)=>new ErrorEvent(e,t),{error:new Error(t),message:t})}function isControlFrame(e){return e===opcodes.CLOSE||e===opcodes.PING||e===opcodes.PONG}function isContinuationFrame(e){return e===opcodes.CONTINUATION}function isTextBinaryFrame(e){return e===opcodes.TEXT||e===opcodes.BINARY}function isValidOpcode(e){return isTextBinaryFrame(e)||isContinuationFrame(e)||isControlFrame(e)}function parseExtensions(e){const t={position:0},o=new Map;for(;t.position<e.length;){const n=collectASequenceOfCodePointsFast(";",e,t),[s,i=""]=n.split("=");o.set(removeHTTPWhitespace(s,!0,!1),removeHTTPWhitespace(i,!1,!0)),t.position++}return o}function isValidClientWindowBits(e){for(let t=0;t<e.length;t++){const o=e.charCodeAt(t);if(o<48||o>57)return!1}return!0}const hasIntl="string"==typeof process.versions.icu,fatalDecoder=hasIntl?new TextDecoder("utf-8",{fatal:!0}):void 0,utf8Decode=hasIntl?fatalDecoder.decode.bind(fatalDecoder):function(e){if(isUtf8(e))return e.toString("utf-8");throw new TypeError("Invalid utf-8 received.")};module.exports={isConnecting:isConnecting,isEstablished:isEstablished,isClosing:isClosing,isClosed:isClosed,fireEvent:fireEvent,isValidSubprotocol:isValidSubprotocol,isValidStatusCode:isValidStatusCode,failWebsocketConnection:failWebsocketConnection,websocketMessageReceived:websocketMessageReceived,utf8Decode:utf8Decode,isControlFrame:isControlFrame,isContinuationFrame:isContinuationFrame,isTextBinaryFrame:isTextBinaryFrame,isValidOpcode:isValidOpcode,parseExtensions:parseExtensions,isValidClientWindowBits:isValidClientWindowBits};