"use strict";const{WebsocketFrameSend:WebsocketFrameSend}=require("./frame"),{opcodes:opcodes,sendHints:sendHints}=require("./constants"),FixedQueue=require("../../dispatcher/fixed-queue"),FastBuffer=Buffer[Symbol.species];class SendQueue{#e=new FixedQueue;#s=!1;#r;constructor(e){this.#r=e}add(e,s,r){if(r!==sendHints.blob){const n=createFrame(e,r);if(this.#s){const e={promise:null,callback:s,frame:n};this.#e.push(e)}else this.#r.write(n,s);return}const n={promise:e.arrayBuffer().then(e=>{n.promise=null,n.frame=createFrame(e,r)}),callback:s,frame:null};this.#e.push(n),this.#s||this.#n()}async#n(){this.#s=!0;const e=this.#e;for(;!e.isEmpty();){const s=e.shift();null!==s.promise&&await s.promise,this.#r.write(s.frame,s.callback),s.callback=s.frame=null}this.#s=!1}}function createFrame(e,s){return new WebsocketFrameSend(toBuffer(e,s)).createFrame(s===sendHints.string?opcodes.TEXT:opcodes.BINARY)}function toBuffer(e,s){switch(s){case sendHints.string:return Buffer.from(e);case sendHints.arrayBuffer:case sendHints.blob:return new FastBuffer(e);case sendHints.typedArray:return new FastBuffer(e.buffer,e.byteOffset,e.byteLength)}}module.exports={SendQueue:SendQueue};