"use strict";const{Transform:Transform}=require("node:stream"),{isASCIINumber:isASCIINumber,isValidLastEventId:isValidLastEventId}=require("./util"),BOM=[239,187,191],LF=10,CR=13,COLON=58,SPACE=32;class EventSourceStream extends Transform{state=null;checkBOM=!0;crlfCheck=!1;eventEndCheck=!1;buffer=null;pos=0;event={data:void 0,event:void 0,id:void 0,retry:void 0};constructor(e={}){e.readableObjectMode=!0,super(e),this.state=e.eventSourceSettings||{},e.push&&(this.push=e.push)}_transform(e,t,s){if(0!==e.length){if(this.buffer?this.buffer=Buffer.concat([this.buffer,e]):this.buffer=e,this.checkBOM)switch(this.buffer.length){case 1:return this.buffer[0]===BOM[0]||(this.checkBOM=!1),void s();case 2:if(this.buffer[0]===BOM[0]&&this.buffer[1]===BOM[1])return void s();this.checkBOM=!1;break;case 3:if(this.buffer[0]===BOM[0]&&this.buffer[1]===BOM[1]&&this.buffer[2]===BOM[2])return this.buffer=Buffer.alloc(0),this.checkBOM=!1,void s();this.checkBOM=!1;break;default:this.buffer[0]===BOM[0]&&this.buffer[1]===BOM[1]&&this.buffer[2]===BOM[2]&&(this.buffer=this.buffer.subarray(3)),this.checkBOM=!1}for(;this.pos<this.buffer.length;)if(this.eventEndCheck){if(this.crlfCheck){if(10===this.buffer[this.pos]){this.buffer=this.buffer.subarray(this.pos+1),this.pos=0,this.crlfCheck=!1;continue}this.crlfCheck=!1}if(10===this.buffer[this.pos]||13===this.buffer[this.pos]){13===this.buffer[this.pos]&&(this.crlfCheck=!0),this.buffer=this.buffer.subarray(this.pos+1),this.pos=0,(void 0!==this.event.data||this.event.event||this.event.id||this.event.retry)&&this.processEvent(this.event),this.clearEvent();continue}this.eventEndCheck=!1}else 10!==this.buffer[this.pos]&&13!==this.buffer[this.pos]?this.pos++:(13===this.buffer[this.pos]&&(this.crlfCheck=!0),this.parseLine(this.buffer.subarray(0,this.pos),this.event),this.buffer=this.buffer.subarray(this.pos+1),this.pos=0,this.eventEndCheck=!0);s()}else s()}parseLine(e,t){if(0===e.length)return;const s=e.indexOf(58);if(0===s)return;let i="",r="";if(-1!==s){i=e.subarray(0,s).toString("utf8");let t=s+1;32===e[t]&&++t,r=e.subarray(t).toString("utf8")}else i=e.toString("utf8"),r="";switch(i){case"data":void 0===t[i]?t[i]=r:t[i]+=`\n${r}`;break;case"retry":isASCIINumber(r)&&(t[i]=r);break;case"id":isValidLastEventId(r)&&(t[i]=r);break;case"event":r.length>0&&(t[i]=r)}}processEvent(e){e.retry&&isASCIINumber(e.retry)&&(this.state.reconnectionTime=parseInt(e.retry,10)),e.id&&isValidLastEventId(e.id)&&(this.state.lastEventId=e.id),void 0!==e.data&&this.push({type:e.event||"message",options:{data:e.data,lastEventId:this.state.lastEventId,origin:this.state.origin}})}clearEvent(){this.event={data:void 0,event:void 0,id:void 0,retry:void 0}}}module.exports={EventSourceStream:EventSourceStream};