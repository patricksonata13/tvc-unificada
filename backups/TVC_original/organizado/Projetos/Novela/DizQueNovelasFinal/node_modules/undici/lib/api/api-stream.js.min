"use strict";const assert=require("node:assert"),{finished:finished,PassThrough:PassThrough}=require("node:stream"),{InvalidArgumentError:InvalidArgumentError,InvalidReturnValueError:InvalidReturnValueError}=require("../core/errors"),util=require("../core/util"),{getResolveErrorBodyCallback:getResolveErrorBodyCallback}=require("./util"),{AsyncResource:AsyncResource}=require("node:async_hooks"),{addSignal:addSignal,removeSignal:removeSignal}=require("./abort-signal");class StreamHandler extends AsyncResource{constructor(e,r,t){if(!e||"object"!=typeof e)throw new InvalidArgumentError("invalid opts");const{signal:n,method:o,opaque:s,body:a,onInfo:i,responseHeaders:l,throwOnError:u}=e;try{if("function"!=typeof t)throw new InvalidArgumentError("invalid callback");if("function"!=typeof r)throw new InvalidArgumentError("invalid factory");if(n&&"function"!=typeof n.on&&"function"!=typeof n.addEventListener)throw new InvalidArgumentError("signal must be an EventEmitter or EventTarget");if("CONNECT"===o)throw new InvalidArgumentError("invalid method");if(i&&"function"!=typeof i)throw new InvalidArgumentError("invalid onInfo callback");super("UNDICI_STREAM")}catch(e){throw util.isStream(a)&&util.destroy(a.on("error",util.nop),e),e}this.responseHeaders=l||null,this.opaque=s||null,this.factory=r,this.callback=t,this.res=null,this.abort=null,this.context=null,this.trailers=null,this.body=a,this.onInfo=i||null,this.throwOnError=u||!1,util.isStream(a)&&a.on("error",e=>{this.onError(e)}),addSignal(this,n)}onConnect(e,r){this.reason?e(this.reason):(assert(this.callback),this.abort=e,this.context=r)}onHeaders(e,r,t,n){const{factory:o,opaque:s,context:a,callback:i,responseHeaders:l}=this,u="raw"===l?util.parseRawHeaders(r):util.parseHeaders(r);if(e<200)return void(this.onInfo&&this.onInfo({statusCode:e,headers:u}));let c;if(this.factory=null,this.throwOnError&&e>=400){const t=("raw"===l?util.parseHeaders(r):u)["content-type"];c=new PassThrough,this.callback=null,this.runInAsyncScope(getResolveErrorBodyCallback,null,{callback:i,body:c,contentType:t,statusCode:e,statusMessage:n,headers:u})}else{if(null===o)return;if(c=this.runInAsyncScope(o,null,{statusCode:e,headers:u,opaque:s,context:a}),!c||"function"!=typeof c.write||"function"!=typeof c.end||"function"!=typeof c.on)throw new InvalidReturnValueError("expected Writable");finished(c,{readable:!1},e=>{const{callback:r,res:t,opaque:n,trailers:o,abort:s}=this;this.res=null,!e&&t.readable||util.destroy(t,e),this.callback=null,this.runInAsyncScope(r,null,e||null,{opaque:n,trailers:o}),e&&s()})}c.on("drain",t),this.res=c;return!0!==(void 0!==c.writableNeedDrain?c.writableNeedDrain:c._writableState?.needDrain)}onData(e){const{res:r}=this;return!r||r.write(e)}onComplete(e){const{res:r}=this;removeSignal(this),r&&(this.trailers=util.parseHeaders(e),r.end())}onError(e){const{res:r,callback:t,opaque:n,body:o}=this;removeSignal(this),this.factory=null,r?(this.res=null,util.destroy(r,e)):t&&(this.callback=null,queueMicrotask(()=>{this.runInAsyncScope(t,null,e,{opaque:n})})),o&&(this.body=null,util.destroy(o,e))}}function stream(e,r,t){if(void 0===t)return new Promise((t,n)=>{stream.call(this,e,r,(e,r)=>e?n(e):t(r))});try{this.dispatch(e,new StreamHandler(e,r,t))}catch(r){if("function"!=typeof t)throw r;const n=e?.opaque;queueMicrotask(()=>t(r,{opaque:n}))}}module.exports=stream;