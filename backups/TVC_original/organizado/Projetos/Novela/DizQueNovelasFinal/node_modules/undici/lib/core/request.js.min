"use strict";const{InvalidArgumentError:InvalidArgumentError,NotSupportedError:NotSupportedError}=require("./errors"),assert=require("node:assert"),{isValidHTTPToken:isValidHTTPToken,isValidHeaderValue:isValidHeaderValue,isStream:isStream,destroy:destroy,isBuffer:isBuffer,isFormDataLike:isFormDataLike,isIterable:isIterable,isBlobLike:isBlobLike,buildURL:buildURL,validateHandler:validateHandler,getServerName:getServerName,normalizedMethodRecords:normalizedMethodRecords}=require("./util"),{channels:channels}=require("./diagnostics.js"),{headerNameLowerCasedRecord:headerNameLowerCasedRecord}=require("./constants"),invalidPathRegex=/[^\u0021-\u00ff]/,kHandler=Symbol("handler");class Request{constructor(e,{path:r,method:t,body:n,headers:s,query:i,idempotent:o,blocking:a,upgrade:l,headersTimeout:h,bodyTimeout:d,reset:u,throwOnError:f,expectContinue:c,servername:b},m){if("string"!=typeof r)throw new InvalidArgumentError("path must be a string");if("/"!==r[0]&&!r.startsWith("http://")&&!r.startsWith("https://")&&"CONNECT"!==t)throw new InvalidArgumentError("path must be an absolute URL or start with a slash");if(invalidPathRegex.test(r))throw new InvalidArgumentError("invalid request path");if("string"!=typeof t)throw new InvalidArgumentError("method must be a string");if(void 0===normalizedMethodRecords[t]&&!isValidHTTPToken(t))throw new InvalidArgumentError("invalid request method");if(l&&"string"!=typeof l)throw new InvalidArgumentError("upgrade must be a string");if(null!=h&&(!Number.isFinite(h)||h<0))throw new InvalidArgumentError("invalid headersTimeout");if(null!=d&&(!Number.isFinite(d)||d<0))throw new InvalidArgumentError("invalid bodyTimeout");if(null!=u&&"boolean"!=typeof u)throw new InvalidArgumentError("invalid reset");if(null!=c&&"boolean"!=typeof c)throw new InvalidArgumentError("invalid expectContinue");if(this.headersTimeout=h,this.bodyTimeout=d,this.throwOnError=!0===f,this.method=t,this.abort=null,null==n)this.body=null;else if(isStream(n)){this.body=n;const e=this.body._readableState;e&&e.autoDestroy||(this.endHandler=function(){destroy(this)},this.body.on("end",this.endHandler)),this.errorHandler=e=>{this.abort?this.abort(e):this.error=e},this.body.on("error",this.errorHandler)}else if(isBuffer(n))this.body=n.byteLength?n:null;else if(ArrayBuffer.isView(n))this.body=n.buffer.byteLength?Buffer.from(n.buffer,n.byteOffset,n.byteLength):null;else if(n instanceof ArrayBuffer)this.body=n.byteLength?Buffer.from(n):null;else if("string"==typeof n)this.body=n.length?Buffer.from(n):null;else{if(!(isFormDataLike(n)||isIterable(n)||isBlobLike(n)))throw new InvalidArgumentError("body must be a string, a Buffer, a Readable stream, an iterable, or an async iterable");this.body=n}if(this.completed=!1,this.aborted=!1,this.upgrade=l||null,this.path=i?buildURL(r,i):r,this.origin=e,this.idempotent=null==o?"HEAD"===t||"GET"===t:o,this.blocking=null!=a&&a,this.reset=null==u?null:u,this.host=null,this.contentLength=null,this.contentType=null,this.headers=[],this.expectContinue=null!=c&&c,Array.isArray(s)){if(s.length%2!=0)throw new InvalidArgumentError("headers array must be even");for(let e=0;e<s.length;e+=2)processHeader(this,s[e],s[e+1])}else if(s&&"object"==typeof s)if(s[Symbol.iterator])for(const e of s){if(!Array.isArray(e)||2!==e.length)throw new InvalidArgumentError("headers must be in key-value pair format");processHeader(this,e[0],e[1])}else{const e=Object.keys(s);for(let r=0;r<e.length;++r)processHeader(this,e[r],s[e[r]])}else if(null!=s)throw new InvalidArgumentError("headers must be an object or an array");validateHandler(m,t,l),this.servername=b||getServerName(this.host),this[kHandler]=m,channels.create.hasSubscribers&&channels.create.publish({request:this})}onBodySent(e){if(this[kHandler].onBodySent)try{return this[kHandler].onBodySent(e)}catch(e){this.abort(e)}}onRequestSent(){if(channels.bodySent.hasSubscribers&&channels.bodySent.publish({request:this}),this[kHandler].onRequestSent)try{return this[kHandler].onRequestSent()}catch(e){this.abort(e)}}onConnect(e){if(assert(!this.aborted),assert(!this.completed),!this.error)return this.abort=e,this[kHandler].onConnect(e);e(this.error)}onResponseStarted(){return this[kHandler].onResponseStarted?.()}onHeaders(e,r,t,n){assert(!this.aborted),assert(!this.completed),channels.headers.hasSubscribers&&channels.headers.publish({request:this,response:{statusCode:e,headers:r,statusText:n}});try{return this[kHandler].onHeaders(e,r,t,n)}catch(e){this.abort(e)}}onData(e){assert(!this.aborted),assert(!this.completed);try{return this[kHandler].onData(e)}catch(e){return this.abort(e),!1}}onUpgrade(e,r,t){return assert(!this.aborted),assert(!this.completed),this[kHandler].onUpgrade(e,r,t)}onComplete(e){this.onFinally(),assert(!this.aborted),this.completed=!0,channels.trailers.hasSubscribers&&channels.trailers.publish({request:this,trailers:e});try{return this[kHandler].onComplete(e)}catch(e){this.onError(e)}}onError(e){if(this.onFinally(),channels.error.hasSubscribers&&channels.error.publish({request:this,error:e}),!this.aborted)return this.aborted=!0,this[kHandler].onError(e)}onFinally(){this.errorHandler&&(this.body.off("error",this.errorHandler),this.errorHandler=null),this.endHandler&&(this.body.off("end",this.endHandler),this.endHandler=null)}addHeader(e,r){return processHeader(this,e,r),this}}function processHeader(e,r,t){if(t&&"object"==typeof t&&!Array.isArray(t))throw new InvalidArgumentError(`invalid ${r} header`);if(void 0===t)return;let n=headerNameLowerCasedRecord[r];if(void 0===n&&(n=r.toLowerCase(),void 0===headerNameLowerCasedRecord[n]&&!isValidHTTPToken(n)))throw new InvalidArgumentError("invalid header key");if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++)if("string"==typeof t[n]){if(!isValidHeaderValue(t[n]))throw new InvalidArgumentError(`invalid ${r} header`);e.push(t[n])}else if(null===t[n])e.push("");else{if("object"==typeof t[n])throw new InvalidArgumentError(`invalid ${r} header`);e.push(`${t[n]}`)}t=e}else if("string"==typeof t){if(!isValidHeaderValue(t))throw new InvalidArgumentError(`invalid ${r} header`)}else t=null===t?"":`${t}`;if(null===e.host&&"host"===n){if("string"!=typeof t)throw new InvalidArgumentError("invalid host header");e.host=t}else if(null===e.contentLength&&"content-length"===n){if(e.contentLength=parseInt(t,10),!Number.isFinite(e.contentLength))throw new InvalidArgumentError("invalid content-length header")}else if(null===e.contentType&&"content-type"===n)e.contentType=t,e.headers.push(r,t);else{if("transfer-encoding"===n||"keep-alive"===n||"upgrade"===n)throw new InvalidArgumentError(`invalid ${n} header`);if("connection"===n){const r="string"==typeof t?t.toLowerCase():null;if("close"!==r&&"keep-alive"!==r)throw new InvalidArgumentError("invalid connection header");"close"===r&&(e.reset=!0)}else{if("expect"===n)throw new NotSupportedError("expect header not supported");e.headers.push(r,t)}}}module.exports=Request;