"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _default=({types:e,traverse:n})=>({name:"inline-requires",visitor:{Program:{enter(){},exit(t,r){const l=new Set,i=new Set(["require"]),a=new Set;let o=!1;const s=r.opts;null!=s&&(s.ignoredRequires?.forEach(e=>l.add(e)),s.inlineableCalls?.forEach(e=>i.add(e)),s.nonMemoizedModules?.forEach(e=>a.add(e)),o=s.memoizeCalls??!1);const u=t.scope.block;"Program"===u.type&&(t.scope.crawl(),t.traverse({CallExpression(t,r){const l=parseInlineableAlias(t,r)||parseInlineableMemberAlias(t,r);if(null==l)return;const{declarationPath:i,moduleName:s,requireFnName:c}=l,d=i.node.init,p=i.node.id?i.node.id.name:null,m=null==p?null:i.scope.getBinding(p);if(null==d||!e.isExpression(d)||null==m||m.constantViolations.length>0)return;const f=d,g=i.get("init");if(Array.isArray(g))return;const y=getNearestLocFromPath(g);deleteLocation(f),n(f,{noScope:!0,enter:e=>deleteLocation(e.node)});let b=!1;const h=l.identifierName;let E=!1;if(o&&m.referencePaths.length>0&&!a.has(s)){const n=e.variableDeclaration("var",[e.variableDeclarator(e.identifier(h))]);i.remove(),E=addStmtToBlock(u,n,0)}function I(){const n=e.cloneDeep(f);return n.METRO_INLINE_REQUIRES_INIT_LOC=y,e.logicalExpression("||",e.identifier(h),e.assignmentExpression("=",e.identifier(h),n))}const N=new Set;for(const n of m.referencePaths){excludeMemberAssignment(s,n,r);try{if(n.scope.rename(c),E){if(n.scope.rename(h),!isDirectlyEnclosedByBlock(e,n)){n.replaceWith(I());continue}N.has(n.scope)?n.replaceWith(e.identifier(h)):(n.replaceWith(I()),N.add(n.scope))}else{const t=e.cloneDeep(f);t.METRO_INLINE_REQUIRES_INIT_LOC=y,n.replaceWith(t)}}catch(e){b=!0}}b||null==i.node||i.remove()}},{ignoredRequires:l,inlineableCalls:i,membersAssigned:new Map}))}}}});function excludeMemberAssignment(e,n,t){const r=n.parentPath?.parent;if("AssignmentExpression"!==r?.type)return;const l=r.left;if("MemberExpression"!==l.type||l.object!==n.node)return;const i=getMemberPropertyName(l);if(null==i)return;let a=t.membersAssigned.get(e);null==a&&(a=new Set,t.membersAssigned.set(e,a)),a.add(i)}function isExcludedMemberAssignment(e,n,t){const r=t.membersAssigned.get(e);return null!=r&&r.has(n)}function getMemberPropertyName(e){return"Identifier"===e.property.type?e.property.name:"StringLiteral"===e.property.type?e.property.value:null}function deleteLocation(e){delete e.start,delete e.end,delete e.loc}function parseInlineableAlias(e,n){const t=getInlineableModule(e,n);if(null==t)return null;const{moduleName:r,requireFnName:l}=t,i=e.parentPath;if(null==i)return null;const a=i.parentPath;if(null==a)return null;if("VariableDeclarator"!==e.parent.type)return null;const o=e.parent;if("Identifier"!==o.id.type)return null;const s=o.id;return"VariableDeclaration"===i.parent.type&&"Program"===a.parent.type&&null!=i.node?{declarationPath:i,moduleName:r,requireFnName:l,identifierName:s.name}:null}function parseInlineableMemberAlias(e,n){const t=getInlineableModule(e,n);if(null==t)return null;const{moduleName:r,requireFnName:l}=t,i=e.parent,a=e.parentPath;if(null==a)return null;const o=a.parentPath;if(null==o)return null;if("MemberExpression"!==i.type)return null;const s=i;if("VariableDeclarator"!==a.parent.type)return null;const u=a.parent;if("Identifier"!==u.id.type)return null;const c=u.id;if("VariableDeclaration"!==o.parent.type||"Program"!==o.parentPath?.parent.type||null==o.node)return null;const d=getMemberPropertyName(s);return null==d||isExcludedMemberAssignment(r,d,n)?null:{declarationPath:o,moduleName:r,requireFnName:l,identifierName:c.name}}function getInlineableModule(e,n){const t=e.node;if(!("CallExpression"===t.type&&"Identifier"===t.callee.type&&n.inlineableCalls.has(t.callee.name)&&t.arguments.length>=1))return null;let r="StringLiteral"===t.arguments[0].type?t.arguments[0].value:null;if(null==r){const e=t.arguments[0];if("CallExpression"===e.type&&"MemberExpression"===e.callee.type&&"Identifier"===e.callee.object.type){const t=e.callee;r="Identifier"===t.object.type&&n.inlineableCalls.has(t.object.name)&&"Identifier"===t.property.type&&"resolve"===t.property.name&&e.arguments.length>=1&&"StringLiteral"===e.arguments[0].type?e.arguments[0].value:null}}const l=t.callee.name;if(null==l)return null;const i=null!=e.scope.getBinding(l);return null==r||n.ignoredRequires.has(r)||r.startsWith("@babel/runtime/")||i?null:{moduleName:r,requireFnName:l}}function getNearestLocFromPath(e){let n=e;for(;n&&!n.node.loc;)n=n.parentPath;return n?.node.loc}function isBranch(e,n){return e.isIfStatement(n)||e.isLogicalExpression(n)||e.isConditionalExpression(n)||e.isSwitchStatement(n)||e.isSwitchCase(n)||e.isForStatement(n)||e.isForInStatement(n)||e.isForOfStatement(n)||e.isWhileStatement(n)}function isDirectlyEnclosedByBlock(e,n){let t=n;for(;t;){if(isBranch(e,t.node))return!1;if(e.isBlockStatement(t.node))return!0;t=t.parentPath}return!0}function addStmtToBlock(e,n,t){const r=e.body;return Array.isArray(r)?(r.splice(t,0,n),!0):!(!r||!Array.isArray(r.body))&&(r.body.splice(t,0,n),!0)}exports.default=_default;