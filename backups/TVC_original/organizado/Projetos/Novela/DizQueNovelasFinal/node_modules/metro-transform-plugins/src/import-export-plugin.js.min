"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=importExportPlugin;var _template=_interopRequireDefault(require("@babel/template")),_nullthrows=_interopRequireDefault(require("nullthrows"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const importTemplate=_template.default.statement("\n  var LOCAL = IMPORT(FILE);\n"),importNamedTemplate=_template.default.statement("\n  var LOCAL = require(FILE).REMOTE;\n"),importSideEffectTemplate=_template.default.statement("\n  require(FILE);\n"),exportAllTemplate=_template.default.statements("\n  var REQUIRED = require(FILE);\n\n  for (var KEY in REQUIRED) {\n    exports[KEY] = REQUIRED[KEY];\n  }\n"),exportTemplate=_template.default.statement("\n  exports.REMOTE = LOCAL;\n"),esModuleExportTemplate=_template.default.statement("\n  Object.defineProperty(exports, '__esModule', {value: true});\n"),resolveTemplate=_template.default.expression("\n  require.resolve(NODE)\n");function resolvePath(e,o){return o?resolveTemplate({NODE:e}):e}function withLocation(e,o){return Array.isArray(e)?e.map(e=>withLocation(e,o)):e.loc?e:{...e,loc:o}}function importExportPlugin({types:e}){const{isDeclaration:o,isVariableDeclaration:t}=e;return{visitor:{ExportAllDeclaration(e,o){o.exportAll.push({file:e.node.source.value,loc:e.node.loc}),e.remove()},ExportDefaultDeclaration(t,r){const l=t.node.declaration,a=l.id||t.scope.generateUidIdentifier("default");l.id=a;const n=t.node.loc;r.exportDefault.push({local:a.name,loc:n}),o(l)?t.insertBefore(withLocation(l,n)):t.insertBefore(withLocation(e.variableDeclaration("var",[e.variableDeclarator(a,l)]),n)),t.remove()},ExportNamedDeclaration(o,r){if(o.node.exportKind&&"value"!==o.node.exportKind)return;const l=o.node.declaration,a=o.node.loc;if(l){if(t(l))l.declarations.forEach(e=>{switch(e.id.type){case"ObjectPattern":e.id.properties.forEach(e=>{const o=e.key.name;r.exportNamed.push({local:o,remote:o,loc:a})});break;case"ArrayPattern":e.id.elements.forEach(e=>{const o=e.name;r.exportNamed.push({local:o,remote:o,loc:a})});break;default:{const o=e.id.name;r.exportNamed.push({local:o,remote:o,loc:a})}}});else{const e=l.id||o.scope.generateUidIdentifier(),t=e.name;l.id=e,r.exportNamed.push({local:t,remote:t,loc:a})}o.insertBefore(l)}const n=o.node.specifiers;n&&n.forEach(t=>{const l=t.local,n=t.exported;if("StringLiteral"===n.type)throw o.buildCodeFrameError("Module string names are not supported");if(o.node.source){const t=o.scope.generateUidIdentifier(l.name);"default"===l.name?(o.insertBefore(withLocation(importTemplate({IMPORT:e.cloneNode(r.importDefault),FILE:resolvePath(e.cloneNode((0,_nullthrows.default)(o.node.source)),r.opts.resolve),LOCAL:t}),a)),r.exportNamed.push({local:t.name,remote:n.name,loc:a})):"default"===n.name?(o.insertBefore(withLocation(importNamedTemplate({FILE:resolvePath(e.cloneNode((0,_nullthrows.default)(o.node.source)),r.opts.resolve),LOCAL:t,REMOTE:l}),a)),r.exportDefault.push({local:t.name,loc:a})):(o.insertBefore(withLocation(importNamedTemplate({FILE:resolvePath(e.cloneNode((0,_nullthrows.default)(o.node.source)),r.opts.resolve),LOCAL:t,REMOTE:l}),a)),r.exportNamed.push({local:t.name,remote:n.name,loc:a}))}else"default"===n.name?r.exportDefault.push({local:l.name,loc:a}):r.exportNamed.push({local:l.name,remote:n.name,loc:a})}),o.remove()},ImportDeclaration(o,t){if(o.node.importKind&&"value"!==o.node.importKind)return;const r=o.node.source,l=o.node.specifiers,a=o.node.loc;if(l.length){let n,i=null;l.filter(e=>"ImportSpecifier"===e.type&&("StringLiteral"===e.imported.type||"default"!==e.imported.name)).length>1&&(n=o.scope.generateUidIdentifierBasedOnNode(r),i=withLocation(e.variableDeclaration("var",[e.variableDeclarator(e.cloneNode(n),e.callExpression(e.identifier("require"),[resolvePath(e.cloneNode(r),t.opts.resolve)]))]),a),t.imports.push({node:i})),l.forEach(o=>{const l=o.imported,p=o.local;switch(o.type){case"ImportNamespaceSpecifier":t.imports.push({node:withLocation(importTemplate({IMPORT:e.cloneNode(t.importAll),FILE:resolvePath(e.cloneNode(r),t.opts.resolve),LOCAL:e.cloneNode(p)}),a)});break;case"ImportDefaultSpecifier":t.imports.push({node:withLocation(importTemplate({IMPORT:e.cloneNode(t.importDefault),FILE:resolvePath(e.cloneNode(r),t.opts.resolve),LOCAL:e.cloneNode(p)}),a)});break;case"ImportSpecifier":"default"===l.name?t.imports.push({node:withLocation(importTemplate({IMPORT:e.cloneNode(t.importDefault),FILE:resolvePath(e.cloneNode(r),t.opts.resolve),LOCAL:e.cloneNode(p)}),a)}):null!=i?i.declarations.push(withLocation(e.variableDeclarator(e.cloneNode(p),e.memberExpression(e.cloneNode(n),e.cloneNode(l))),a)):t.imports.push({node:withLocation(importNamedTemplate({FILE:resolvePath(e.cloneNode(r),t.opts.resolve),LOCAL:e.cloneNode(p),REMOTE:e.cloneNode(l)}),a)});break;default:throw new TypeError("Unknown import type: "+o.type)}})}else t.imports.push({node:withLocation(importSideEffectTemplate({FILE:resolvePath(e.cloneNode(r),t.opts.resolve)}),a)});o.remove()},Program:{enter(o,t){t.exportAll=[],t.exportDefault=[],t.exportNamed=[],t.imports=[],t.importAll=e.identifier(t.opts.importAll),t.importDefault=e.identifier(t.opts.importDefault),["module","global","exports","require"].forEach(e=>o.scope.rename(e))},exit(o,t){const r=o.node.body;t.imports.reverse().forEach(e=>{r.unshift(e.node)}),t.exportDefault.forEach(o=>{r.push(withLocation(exportTemplate({LOCAL:e.identifier(o.local),REMOTE:e.identifier("default")}),o.loc))}),t.exportAll.forEach(l=>{r.push(...withLocation(exportAllTemplate({FILE:resolvePath(e.stringLiteral(l.file),t.opts.resolve),REQUIRED:o.scope.generateUidIdentifier(l.file),KEY:o.scope.generateUidIdentifier("key")}),l.loc))}),t.exportNamed.forEach(o=>{r.push(withLocation(exportTemplate({LOCAL:e.identifier(o.local),REMOTE:e.identifier(o.remote)}),o.loc))}),t.exportDefault.length||t.exportAll.length||t.exportNamed.length?(r.unshift(esModuleExportTemplate()),t.opts.out&&(t.opts.out.isESModule=!0)):t.opts.out&&(t.opts.out.isESModule=!1)}}}}}