(function(){"use strict";var t,r,s,e,i,n,o,a,p,h=function(t,r){return function(){return t.apply(r,arguments)}},c={}.hasOwnProperty;a=require("sax"),s=require("events"),t=require("./bom"),o=require("./processors"),p=require("timers").setImmediate,r=require("./defaults").defaults,e=function(t){return"object"==typeof t&&null!=t&&0===Object.keys(t).length},i=function(t){return"__proto__"!==t&&"constructor"!==t&&"prototype"!==t},n=function(t,r,s){var e,i;for(e=0,i=t.length;e<i;e++)r=(0,t[e])(r,s);return r},exports.Parser=function(s){function u(t){var s,e,i;if(this.parseStringPromise=h(this.parseStringPromise,this),this.parseString=h(this.parseString,this),this.reset=h(this.reset,this),this.assignOrPush=h(this.assignOrPush,this),this.processAsync=h(this.processAsync,this),!(this instanceof exports.Parser))return new exports.Parser(t);for(s in this.options={},e=r[.2])c.call(e,s)&&(i=e[s],this.options[s]=i);for(s in t)c.call(t,s)&&(i=t[s],this.options[s]=i);this.options.xmlns&&(this.options.xmlnskey=this.options.attrkey+"ns"),this.options.normalizeTags&&(this.options.tagNameProcessors||(this.options.tagNameProcessors=[]),this.options.tagNameProcessors.unshift(o.normalize)),this.reset()}return function(t,r){for(var s in r)c.call(r,s)&&(t[s]=r[s]);function e(){this.constructor=t}e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype}(u,s),u.prototype.processAsync=function(){var t,r;try{return this.remaining.length<=this.options.chunkSize?(t=this.remaining,this.remaining="",this.saxParser=this.saxParser.write(t),this.saxParser.close()):(t=this.remaining.substr(0,this.options.chunkSize),this.remaining=this.remaining.substr(this.options.chunkSize,this.remaining.length),this.saxParser=this.saxParser.write(t),p(this.processAsync))}catch(t){if(r=t,!this.saxParser.errThrown)return this.saxParser.errThrown=!0,this.emit(r)}},u.prototype.assignOrPush=function(t,r,s){if(i(r))return r in t?(t[r]instanceof Array||(t[r]=[t[r]]),t[r].push(s)):this.options.explicitArray?t[r]=[s]:t[r]=s},u.prototype.reset=function(){var t,r,s,o,p;return this.removeAllListeners(),this.saxParser=a.parser(this.options.strict,{trim:!1,normalize:!1,xmlns:this.options.xmlns}),this.saxParser.errThrown=!1,this.saxParser.onerror=(p=this,function(t){if(p.saxParser.resume(),!p.saxParser.errThrown)return p.saxParser.errThrown=!0,p.emit("error",t)}),this.saxParser.onend=function(t){return function(){if(!t.saxParser.ended)return t.saxParser.ended=!0,t.emit("end",t.resultObject)}}(this),this.saxParser.ended=!1,this.EXPLICIT_CHARKEY=this.options.explicitCharkey,this.resultObject=null,o=[],t=this.options.attrkey,r=this.options.charkey,this.saxParser.onopentag=function(s){return function(e){var a,p,h,u,l;if((h={})[r]="",!s.options.ignoreAttrs)for(a in l=e.attributes)c.call(l,a)&&(t in h||s.options.mergeAttrs||(h[t]={}),p=s.options.attrValueProcessors?n(s.options.attrValueProcessors,e.attributes[a],a):e.attributes[a],u=s.options.attrNameProcessors?n(s.options.attrNameProcessors,a):a,i(u)&&(s.options.mergeAttrs?s.assignOrPush(h,u,p):h[t][u]=p));return h["#name"]=s.options.tagNameProcessors?n(s.options.tagNameProcessors,e.name):e.name,s.options.xmlns&&(h[s.options.xmlnskey]={uri:e.uri,local:e.local}),o.push(h)}}(this),this.saxParser.onclosetag=function(t){return function(){var s,a,p,h,u,l,f,m,y,P;if(l=o.pop(),u=l["#name"],t.options.explicitChildren&&t.options.preserveChildrenOrder||delete l["#name"],!0===l.cdata&&(s=l.cdata,delete l.cdata),y=o[o.length-1],l[r].match(/^\s*$/)&&!s?(a=l[r],delete l[r]):(t.options.trim&&(l[r]=l[r].trim()),t.options.normalize&&(l[r]=l[r].replace(/\s{2,}/g," ").trim()),l[r]=t.options.valueProcessors?n(t.options.valueProcessors,l[r],u):l[r],1===Object.keys(l).length&&r in l&&!t.EXPLICIT_CHARKEY&&(l=l[r])),e(l)&&(l="function"==typeof t.options.emptyTag?t.options.emptyTag():""!==t.options.emptyTag?t.options.emptyTag:a),null!=t.options.validator&&(P="/"+function(){var t,r,s;for(s=[],t=0,r=o.length;t<r;t++)h=o[t],s.push(h["#name"]);return s}().concat(u).join("/"),function(){var r;try{return l=t.options.validator(P,y&&y[u],l)}catch(s){return r=s,t.emit("error",r)}}()),t.options.explicitChildren&&!t.options.mergeAttrs&&"object"==typeof l)if(t.options.preserveChildrenOrder){if(y){for(p in y[t.options.childkey]=y[t.options.childkey]||[],f={},l)c.call(l,p)&&i(p)&&(f[p]=l[p]);y[t.options.childkey].push(f),delete l["#name"],1===Object.keys(l).length&&r in l&&!t.EXPLICIT_CHARKEY&&(l=l[r])}}else h={},t.options.attrkey in l&&(h[t.options.attrkey]=l[t.options.attrkey],delete l[t.options.attrkey]),!t.options.charsAsChildren&&t.options.charkey in l&&(h[t.options.charkey]=l[t.options.charkey],delete l[t.options.charkey]),Object.getOwnPropertyNames(l).length>0&&(h[t.options.childkey]=l),l=h;return o.length>0?t.assignOrPush(y,u,l):(t.options.explicitRoot&&(m=l,(l={})[u]=m),t.resultObject=l,t.saxParser.ended=!0,t.emit("end",t.resultObject))}}(this),s=function(t){return function(s){var e,i;if(i=o[o.length-1])return i[r]+=s,t.options.explicitChildren&&t.options.preserveChildrenOrder&&t.options.charsAsChildren&&(t.options.includeWhiteChars||""!==s.replace(/\\n/g,"").trim())&&(i[t.options.childkey]=i[t.options.childkey]||[],(e={"#name":"__text__"})[r]=s,t.options.normalize&&(e[r]=e[r].replace(/\s{2,}/g," ").trim()),i[t.options.childkey].push(e)),i}}(this),this.saxParser.ontext=s,this.saxParser.oncdata=function(t){var r;if(r=s(t))return r.cdata=!0}},u.prototype.parseString=function(r,s){var e;null!=s&&"function"==typeof s&&(this.on("end",function(t){return this.reset(),s(null,t)}),this.on("error",function(t){return this.reset(),s(t)}));try{return""===(r=r.toString()).trim()?(this.emit("end",null),!0):(r=t.stripBOM(r),this.options.async?(this.remaining=r,p(this.processAsync),this.saxParser):this.saxParser.write(r).close())}catch(t){if(e=t,!this.saxParser.errThrown&&!this.saxParser.ended)return this.emit("error",e),this.saxParser.errThrown=!0;if(this.saxParser.ended)throw e}},u.prototype.parseStringPromise=function(t){return new Promise((r=this,function(s,e){return r.parseString(t,function(t,r){return t?e(t):s(r)})}));var r},u}(s),exports.parseString=function(t,r,s){var e,i;return null!=s?("function"==typeof s&&(e=s),"object"==typeof r&&(i=r)):("function"==typeof r&&(e=r),i={}),new exports.Parser(i).parseString(t,e)},exports.parseStringPromise=function(t,r){var s;return"object"==typeof r&&(s=r),new exports.Parser(s).parseStringPromise(t)}}).call(this);