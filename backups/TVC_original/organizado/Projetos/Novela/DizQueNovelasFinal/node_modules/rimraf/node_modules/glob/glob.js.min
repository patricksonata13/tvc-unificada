module.exports=glob;var rp=require("fs.realpath"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,inherits=require("inherits"),EE=require("events").EventEmitter,path=require("path"),assert=require("assert"),isAbsolute=require("path-is-absolute"),globSync=require("./sync.js"),common=require("./common.js"),setopts=common.setopts,ownProp=common.ownProp,inflight=require("inflight"),util=require("util"),childrenIgnored=common.childrenIgnored,isIgnored=common.isIgnored,once=require("once");function glob(t,i,e){if("function"==typeof i&&(e=i,i={}),i||(i={}),i.sync){if(e)throw new TypeError("callback provided to sync glob");return globSync(t,i)}return new Glob(t,i,e)}glob.sync=globSync;var GlobSync=glob.GlobSync=globSync.GlobSync;function extend(t,i){if(null===i||"object"!=typeof i)return t;for(var e=Object.keys(i),r=e.length;r--;)t[e[r]]=i[e[r]];return t}function Glob(t,i,e){if("function"==typeof i&&(e=i,i=null),i&&i.sync){if(e)throw new TypeError("callback provided to sync glob");return new GlobSync(t,i)}if(!(this instanceof Glob))return new Glob(t,i,e);setopts(this,t,i),this._didRealPath=!1;var r=this.minimatch.set.length;this.matches=new Array(r),"function"==typeof e&&(e=once(e),this.on("error",e),this.on("end",function(t){e(null,t)}));var s=this;if(this._processing=0,this._emitQueue=[],this._processQueue=[],this.paused=!1,this.noprocess)return this;if(0===r)return h();for(var o=!0,n=0;n<r;n++)this._process(this.minimatch.set[n],n,!1,h);function h(){--s._processing,s._processing<=0&&(o?process.nextTick(function(){s._finish()}):s._finish())}o=!1}function readdirCb(t,i,e){return function(r,s){r?t._readdirError(i,r,e):t._readdirEntries(i,s,e)}}glob.glob=glob,glob.hasMagic=function(t,i){var e=extend({},i);e.noprocess=!0;var r=new Glob(t,e).minimatch.set;if(!t)return!1;if(r.length>1)return!0;for(var s=0;s<r[0].length;s++)if("string"!=typeof r[0][s])return!0;return!1},glob.Glob=Glob,inherits(Glob,EE),Glob.prototype._finish=function(){if(assert(this instanceof Glob),!this.aborted){if(this.realpath&&!this._didRealpath)return this._realpath();common.finish(this),this.emit("end",this.found)}},Glob.prototype._realpath=function(){if(!this._didRealpath){this._didRealpath=!0;var t=this.matches.length;if(0===t)return this._finish();for(var i=this,e=0;e<this.matches.length;e++)this._realpathSet(e,r)}function r(){0===--t&&i._finish()}},Glob.prototype._realpathSet=function(t,i){var e=this.matches[t];if(!e)return i();var r=Object.keys(e),s=this,o=r.length;if(0===o)return i();var n=this.matches[t]=Object.create(null);r.forEach(function(e,r){e=s._makeAbs(e),rp.realpath(e,s.realpathCache,function(r,h){r?"stat"===r.syscall?n[e]=!0:s.emit("error",r):n[h]=!0,0===--o&&(s.matches[t]=n,i())})})},Glob.prototype._mark=function(t){return common.mark(this,t)},Glob.prototype._makeAbs=function(t){return common.makeAbs(this,t)},Glob.prototype.abort=function(){this.aborted=!0,this.emit("abort")},Glob.prototype.pause=function(){this.paused||(this.paused=!0,this.emit("pause"))},Glob.prototype.resume=function(){if(this.paused){if(this.emit("resume"),this.paused=!1,this._emitQueue.length){var t=this._emitQueue.slice(0);this._emitQueue.length=0;for(var i=0;i<t.length;i++){var e=t[i];this._emitMatch(e[0],e[1])}}if(this._processQueue.length){var r=this._processQueue.slice(0);this._processQueue.length=0;for(i=0;i<r.length;i++){var s=r[i];this._processing--,this._process(s[0],s[1],s[2],s[3])}}}},Glob.prototype._process=function(t,i,e,r){if(assert(this instanceof Glob),assert("function"==typeof r),!this.aborted)if(this._processing++,this.paused)this._processQueue.push([t,i,e,r]);else{for(var s,o=0;"string"==typeof t[o];)o++;switch(o){case t.length:return void this._processSimple(t.join("/"),i,r);case 0:s=null;break;default:s=t.slice(0,o).join("/")}var n,h=t.slice(o);null===s?n=".":isAbsolute(s)||isAbsolute(t.map(function(t){return"string"==typeof t?t:"[*]"}).join("/"))?(s&&isAbsolute(s)||(s="/"+s),n=s):n=s;var a=this._makeAbs(n);if(childrenIgnored(this,n))return r();h[0]===minimatch.GLOBSTAR?this._processGlobStar(s,n,a,h,i,e,r):this._processReaddir(s,n,a,h,i,e,r)}},Glob.prototype._processReaddir=function(t,i,e,r,s,o,n){var h=this;this._readdir(e,o,function(a,c){return h._processReaddir2(t,i,e,r,s,o,c,n)})},Glob.prototype._processReaddir2=function(t,i,e,r,s,o,n,h){if(!n)return h();for(var a=r[0],c=!!this.minimatch.negate,l=a._glob,u=this.dot||"."===l.charAt(0),f=[],p=0;p<n.length;p++){if("."!==(m=n[p]).charAt(0)||u)(c&&!t?!m.match(a):m.match(a))&&f.push(m)}var b=f.length;if(0===b)return h();if(1===r.length&&!this.mark&&!this.stat){this.matches[s]||(this.matches[s]=Object.create(null));for(p=0;p<b;p++){var m=f[p];t&&(m="/"!==t?t+"/"+m:t+m),"/"!==m.charAt(0)||this.nomount||(m=path.join(this.root,m)),this._emitMatch(s,m)}return h()}r.shift();for(p=0;p<b;p++){m=f[p];t&&(m="/"!==t?t+"/"+m:t+m),this._process([m].concat(r),s,o,h)}h()},Glob.prototype._emitMatch=function(t,i){if(!this.aborted&&!isIgnored(this,i))if(this.paused)this._emitQueue.push([t,i]);else{var e=isAbsolute(i)?i:this._makeAbs(i);if(this.mark&&(i=this._mark(i)),this.absolute&&(i=e),!this.matches[t][i]){if(this.nodir){var r=this.cache[e];if("DIR"===r||Array.isArray(r))return}this.matches[t][i]=!0;var s=this.statCache[e];s&&this.emit("stat",i,s),this.emit("match",i)}}},Glob.prototype._readdirInGlobStar=function(t,i){if(!this.aborted){if(this.follow)return this._readdir(t,!1,i);var e=this,r=inflight("lstat\0"+t,function(r,s){if(r&&"ENOENT"===r.code)return i();var o=s&&s.isSymbolicLink();e.symlinks[t]=o,o||!s||s.isDirectory()?e._readdir(t,!1,i):(e.cache[t]="FILE",i())});r&&e.fs.lstat(t,r)}},Glob.prototype._readdir=function(t,i,e){if(!this.aborted&&(e=inflight("readdir\0"+t+"\0"+i,e))){if(i&&!ownProp(this.symlinks,t))return this._readdirInGlobStar(t,e);if(ownProp(this.cache,t)){var r=this.cache[t];if(!r||"FILE"===r)return e();if(Array.isArray(r))return e(null,r)}this.fs.readdir(t,readdirCb(this,t,e))}},Glob.prototype._readdirEntries=function(t,i,e){if(!this.aborted){if(!this.mark&&!this.stat)for(var r=0;r<i.length;r++){var s=i[r];s="/"===t?t+s:t+"/"+s,this.cache[s]=!0}return this.cache[t]=i,e(null,i)}},Glob.prototype._readdirError=function(t,i,e){if(!this.aborted){switch(i.code){case"ENOTSUP":case"ENOTDIR":var r=this._makeAbs(t);if(this.cache[r]="FILE",r===this.cwdAbs){var s=new Error(i.code+" invalid cwd "+this.cwd);s.path=this.cwd,s.code=i.code,this.emit("error",s),this.abort()}break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(t)]=!1;break;default:this.cache[this._makeAbs(t)]=!1,this.strict&&(this.emit("error",i),this.abort()),this.silent||console.error("glob error",i)}return e()}},Glob.prototype._processGlobStar=function(t,i,e,r,s,o,n){var h=this;this._readdir(e,o,function(a,c){h._processGlobStar2(t,i,e,r,s,o,c,n)})},Glob.prototype._processGlobStar2=function(t,i,e,r,s,o,n,h){if(!n)return h();var a=r.slice(1),c=t?[t]:[],l=c.concat(a);this._process(l,s,!1,h);var u=this.symlinks[e],f=n.length;if(u&&o)return h();for(var p=0;p<f;p++){if("."!==n[p].charAt(0)||this.dot){var b=c.concat(n[p],a);this._process(b,s,!0,h);var m=c.concat(n[p],r);this._process(m,s,!0,h)}}h()},Glob.prototype._processSimple=function(t,i,e){var r=this;this._stat(t,function(s,o){r._processSimple2(t,i,s,o,e)})},Glob.prototype._processSimple2=function(t,i,e,r,s){if(this.matches[i]||(this.matches[i]=Object.create(null)),!r)return s();if(t&&isAbsolute(t)&&!this.nomount){var o=/[\/\\]$/.test(t);"/"===t.charAt(0)?t=path.join(this.root,t):(t=path.resolve(this.root,t),o&&(t+="/"))}"win32"===process.platform&&(t=t.replace(/\\/g,"/")),this._emitMatch(i,t),s()},Glob.prototype._stat=function(t,i){var e=this._makeAbs(t),r="/"===t.slice(-1);if(t.length>this.maxLength)return i();if(!this.stat&&ownProp(this.cache,e)){var s=this.cache[e];if(Array.isArray(s)&&(s="DIR"),!r||"DIR"===s)return i(null,s);if(r&&"FILE"===s)return i()}var o=this.statCache[e];if(void 0!==o){if(!1===o)return i(null,o);var n=o.isDirectory()?"DIR":"FILE";return r&&"FILE"===n?i():i(null,n,o)}var h=this,a=inflight("stat\0"+e,function(r,s){if(s&&s.isSymbolicLink())return h.fs.stat(e,function(r,o){r?h._stat2(t,e,null,s,i):h._stat2(t,e,r,o,i)});h._stat2(t,e,r,s,i)});a&&h.fs.lstat(e,a)},Glob.prototype._stat2=function(t,i,e,r,s){if(e&&("ENOENT"===e.code||"ENOTDIR"===e.code))return this.statCache[i]=!1,s();var o="/"===t.slice(-1);if(this.statCache[i]=r,"/"===i.slice(-1)&&r&&!r.isDirectory())return s(null,!1,r);var n=!0;return r&&(n=r.isDirectory()?"DIR":"FILE"),this.cache[i]=this.cache[i]||n,o&&"FILE"===n?s():s(null,n,r)};