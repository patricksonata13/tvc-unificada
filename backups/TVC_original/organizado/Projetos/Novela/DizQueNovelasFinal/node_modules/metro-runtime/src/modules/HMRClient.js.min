"use strict";const EventEmitter=require("./vendor/eventemitter3"),inject=({module:[id,code],sourceURL:sourceURL})=>{global.globalEvalWithSourceUrl?global.globalEvalWithSourceUrl(code,sourceURL):eval(code)},injectUpdate=e=>{e.added.forEach(inject),e.modified.forEach(inject)};class HMRClient extends EventEmitter{_isEnabled=!1;_pendingUpdate=null;_queue=[];_state="opening";constructor(e){super(),this._ws=new global.WebSocket(e),this._ws.onopen=()=>{this._state="open",this.emit("open"),this._flushQueue()},this._ws.onerror=e=>{this.emit("connection-error",e)},this._ws.onclose=e=>{this._state="closed",this.emit("close",e)},this._ws.onmessage=e=>{const t=JSON.parse(String(e.data));switch(t.type){case"bundle-registered":this.emit("bundle-registered");break;case"update-start":this.emit("update-start",t.body);break;case"update":this.emit("update",t.body);break;case"update-done":this.emit("update-done");break;case"error":this.emit("error",t.body);break;default:this.emit("error",{type:"unknown-message",message:t})}},this.on("update",e=>{this._isEnabled?injectUpdate(e):null==this._pendingUpdate?this._pendingUpdate=e:this._pendingUpdate=mergeUpdates(this._pendingUpdate,e)})}close(){this._ws.close()}send(e){switch(this._state){case"opening":this._queue.push(e);break;case"open":this._ws.send(e);break;case"closed":break;default:throw new Error("[WebSocketHMRClient] Unknown state: "+this._state)}}_flushQueue(){this._queue.forEach(e=>this.send(e)),this._queue.length=0}enable(){this._isEnabled=!0;const e=this._pendingUpdate;this._pendingUpdate=null,null!=e&&injectUpdate(e)}disable(){this._isEnabled=!1}isEnabled(){return this._isEnabled}hasPendingUpdates(){return null!=this._pendingUpdate}}function mergeUpdates(e,t){const s=new Set,i=new Set,d=new Map;function n(e){e.deleted.forEach(e=>{s.has(e)?s.delete(e):i.add(e),d.delete(e)}),e.added.forEach(e=>{const t=e.module[0];i.has(t)?i.delete(t):s.add(t),d.set(t,e)}),e.modified.forEach(e=>{const t=e.module[0];d.set(t,e)})}n(e),n(t);const a={isInitialUpdate:t.isInitialUpdate,revisionId:t.revisionId,added:[],modified:[],deleted:[]};return i.forEach(e=>{a.deleted.push(e)}),d.forEach((e,t)=>{i.has(t)||(s.has(t)?a.added.push(e):a.modified.push(e))}),a}module.exports=HMRClient;