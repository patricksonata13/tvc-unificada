"use strict";import{cssKeyframesRegistry,CSSKeyframesRuleImpl}from"../keyframes";import{createSingleCSSAnimationProperties,getAnimationSettingsUpdates,normalizeSingleCSSAnimationSettings}from"../normalization";import{applyCSSAnimations,unregisterCSSAnimations}from"../proxy";export default class CSSAnimationsManager{attachedAnimations=[];constructor(e,t,i){this.shadowNodeWrapper=e,this.viewName=t,this.viewTag=i}update(e){if(!e)return void this.detach();const t=this.processAnimations(e);this.registerKeyframesUsage(t);const i=this.getAnimationUpdates(t);if(this.attachedAnimations=t,i){if(i.animationNames&&0===i.animationNames.length)return void this.detach();applyCSSAnimations(this.shadowNodeWrapper,i)}}unmountCleanup(){this.unregisterKeyframesUsage()}detach(){this.attachedAnimations.length>0&&(unregisterCSSAnimations(this.viewTag),this.unregisterKeyframesUsage(),this.attachedAnimations=[])}registerKeyframesUsage(e){const t=new Set;e.forEach(({keyframesRule:e})=>{cssKeyframesRegistry.add(e,this.viewName,this.viewTag),t.add(e.name)}),this.attachedAnimations.forEach(({keyframesRule:{name:e}})=>{t.has(e)||cssKeyframesRegistry.remove(e,this.viewName,this.viewTag)})}unregisterKeyframesUsage(){this.attachedAnimations.forEach(({keyframesRule:{name:e}})=>{cssKeyframesRegistry.remove(e,this.viewName,this.viewTag)})}processAnimations(e){return createSingleCSSAnimationProperties(e).map(e=>{const t=e.animationName;let i;if(t instanceof CSSKeyframesRuleImpl)i=t;else{const e=JSON.stringify(t);i=cssKeyframesRegistry.get(e)??new CSSKeyframesRuleImpl(t,e)}return{normalizedSettings:normalizeSingleCSSAnimationSettings(e),keyframesRule:i}})}buildAnimationsMap(e){return e.reduceRight((e,t)=>{const i=t.keyframesRule.name;return e[i]?e[i].push(t):e[i]=[t],e},{})}getAnimationUpdates(e){const t={},i={};let s=this.attachedAnimations.length!==e.length,a=!1,n=!1;const r=this.buildAnimationsMap(this.attachedAnimations);e.forEach(({keyframesRule:e,normalizedSettings:m},o)=>{const h=r[e.name]?.pop();if(!h)return a=!0,s=!0,void(t[o]=m);const g=getAnimationSettingsUpdates(h.normalizedSettings,m);Object.keys(g).length>0&&(n=!0,i[o]=g),h.keyframesRule.name!==e.name&&(s=!0)});const m={};return s&&(m.animationNames=e.map(({keyframesRule:e})=>e.name)),a&&(m.newAnimationSettings=t),n&&(m.settingsUpdates=i),a||n||s?m:null}}