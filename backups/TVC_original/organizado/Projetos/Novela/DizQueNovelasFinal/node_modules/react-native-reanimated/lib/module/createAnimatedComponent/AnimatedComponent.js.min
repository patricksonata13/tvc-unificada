"use strict";import"../layoutReanimation/animationsManager";import{maybeBuild}from"../animationBuilder";import{IS_JEST,IS_WEB,logger}from"../common";import{LayoutAnimationType}from"../commonTypes";import{SkipEnteringContext}from"../component/LayoutAnimationConfig";import ReanimatedAnimatedComponent from"../css/component/AnimatedComponent";import{configureWebLayoutAnimations,getReducedMotionFromConfig,saveSnapshot,startWebLayoutAnimation,tryActivateLayoutTransition}from"../layoutReanimation/web";import{addHTMLMutationObserver}from"../layoutReanimation/web/domUtils";import{updateLayoutAnimations}from"../UpdateLayoutAnimations";import{InlinePropManager}from"./InlinePropManager";import jsPropsUpdater from"./JSPropsUpdater";import{NativeEventsManager}from"./NativeEventsManager";import{PropsFilter}from"./PropsFilter";import{filterStyles,flattenArray}from"./utils";let id=0;IS_WEB&&configureWebLayoutAnimations();export default class AnimatedComponent extends ReanimatedAnimatedComponent{_animatedStyles=[];_prevAnimatedStyles=[];_animatedProps=[];_prevAnimatedProps=[];_isFirstRender=!0;jestAnimatedStyle={value:{}};jestAnimatedProps={value:{}};_InlinePropManager=new InlinePropManager;_PropsFilter=new PropsFilter;static contextType=SkipEnteringContext;reanimatedID=id++;constructor(t,e,i,n){super(t,e),this._options=n,this._displayName=i,IS_JEST&&(this.jestAnimatedStyle={value:{}},this.jestAnimatedProps={value:{}});const s=this.context?.current;s||this._configureLayoutAnimation(LayoutAnimationType.ENTERING,this.props.entering)}componentDidMount(){if(super.componentDidMount(),IS_WEB||(this._NativeEventsManager=new NativeEventsManager(this,this._options)),this._NativeEventsManager?.attachEvents(),this._updateAnimatedStylesAndProps(),this._InlinePropManager.attachInlineProps(this,this._getViewInfo()),this._options?.jsProps?.length&&jsPropsUpdater.registerComponent(this,this._options.jsProps),this._configureLayoutAnimation(LayoutAnimationType.LAYOUT,this.props.layout),this._configureLayoutAnimation(LayoutAnimationType.EXITING,this.props.exiting),IS_WEB){if(this.props.exiting&&this._componentDOMRef&&saveSnapshot(this._componentDOMRef),!this.props.entering||getReducedMotionFromConfig(this.props.entering))return void(this._isFirstRender=!1);const t=this.context?.current;t?this._componentDOMRef&&(this._componentDOMRef.style.visibility="initial"):startWebLayoutAnimation(this.props,this._componentDOMRef,LayoutAnimationType.ENTERING)}this._isFirstRender=!1}componentWillUnmount(){super.componentWillUnmount(),this._NativeEventsManager?.detachEvents(),this._detachStyles(),this._InlinePropManager.detachInlineProps(),this._options?.jsProps?.length&&jsPropsUpdater.unregisterComponent(this);const t=this.props.exiting;IS_WEB&&this._componentDOMRef&&t&&!getReducedMotionFromConfig(t)&&(addHTMLMutationObserver(),startWebLayoutAnimation(this.props,this._componentDOMRef,LayoutAnimationType.EXITING))}_detachStyles(){const t=this.getComponentViewTag();if(-1!==t){for(const e of this._animatedStyles)e.viewDescriptors.remove(t);this.props.animatedProps?.viewDescriptors&&this.props.animatedProps.viewDescriptors.remove(t)}}setNativeProps(t){this._options?.setNativeProps?this._options.setNativeProps(this._componentRef,t):this._componentRef?.setNativeProps?.(t)}_handleAnimatedStylesUpdate(t,e,i){const{viewTag:n,shadowNodeWrapper:s}=this._getViewInfo(),o=new Set(e),a=t=>t.viewDescriptors.has(n);if(t){if(1===e.length&&1===t.length&&e[0]===t[0]&&a(t[0]))return;for(const i of t){e.some(t=>!(t!==i||!a(t))&&(o.delete(t),!0))||i.viewDescriptors.remove(n)}}o.forEach(t=>{t.viewDescriptors.add({tag:n,shadowNodeWrapper:s},t.styleUpdaterContainer),IS_JEST&&(Object.assign(i.value,t.initial.value),t.jestAnimatedValues.current=i)})}_updateAnimatedStylesAndProps(){this._handleAnimatedStylesUpdate(this._prevAnimatedStyles,this._animatedStyles,this.jestAnimatedStyle),this._handleAnimatedStylesUpdate(this._prevAnimatedProps,this._animatedProps,this.jestAnimatedProps)}componentDidUpdate(t,e,i){this._configureLayoutAnimation(LayoutAnimationType.LAYOUT,this.props.layout,t.layout),this._configureLayoutAnimation(LayoutAnimationType.EXITING,this.props.exiting,t.exiting),this._NativeEventsManager?.updateEvents(t),this._updateAnimatedStylesAndProps(),this._InlinePropManager.attachInlineProps(this,this._getViewInfo()),IS_WEB&&this.props.exiting&&this._componentDOMRef&&saveSnapshot(this._componentDOMRef),IS_WEB&&i&&this.props.layout&&!getReducedMotionFromConfig(this.props.layout)&&tryActivateLayoutTransition(this.props,this._componentDOMRef,i)}_updateStyles(t){const e=filterStyles(flattenArray(t.style??[]));this._prevAnimatedStyles=this._animatedStyles,this._animatedStyles=e.animatedStyles;const i=filterStyles(flattenArray(t.animatedProps??[]));if(this._prevAnimatedProps=this._animatedProps,this._animatedProps=i.animatedStyles,i.cssStyle){if(__DEV__&&e.cssStyle)return logger.warn("AnimatedComponent: CSS properties cannot be used in style and animatedProps at the same time. Using properties from the style object."),void(this._cssStyle=e.cssStyle);const n={...t,...i.cssStyle};delete n.style,delete n.animatedProps,this._cssStyle=n}else this._cssStyle=e.cssStyle??{}}_configureLayoutAnimation(t,e,i){IS_WEB||e===i||updateLayoutAnimations(t===LayoutAnimationType.ENTERING?this.reanimatedID:this.getComponentViewTag(),t,e&&maybeBuild(e,t===LayoutAnimationType.LAYOUT?void 0:this.props?.style,this._displayName))}getSnapshotBeforeUpdate(){return IS_WEB&&this.props.layout&&this._componentDOMRef?.getBoundingClientRect?this._componentDOMRef.getBoundingClientRect():null}render(){const t=this._PropsFilter.filterNonAnimatedProps(this);IS_JEST&&(t.jestAnimatedStyle=this.jestAnimatedStyle,t.jestAnimatedProps=this.jestAnimatedProps),this._isFirstRender&&IS_WEB&&t.entering&&!getReducedMotionFromConfig(t.entering)&&(t.style=Array.isArray(t.style)?t.style.concat([{visibility:"hidden"}]):{...t.style??{},visibility:"hidden"});const e=this.context?.current,i=e?void 0:`${this.reanimatedID}`,n=IS_JEST?{jestInlineStyle:this.props.style&&filterOutAnimatedStyles(this.props.style),jestAnimatedStyle:this.jestAnimatedStyle,jestAnimatedProps:this.jestAnimatedProps}:{};return super.render({nativeID:i,...t,...n})}}function filterOutAnimatedStyles(t){return t?Array.isArray(t)?t.filter(t=>!(t&&"viewDescriptors"in t)).map(t=>Array.isArray(t)?filterOutAnimatedStyles(t):t):t?.viewDescriptors?{}:t:t}