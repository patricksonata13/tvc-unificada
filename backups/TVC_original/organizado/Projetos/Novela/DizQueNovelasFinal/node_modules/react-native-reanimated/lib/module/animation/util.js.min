"use strict";import{createSerializable,isWorkletFunction,runOnUI,RuntimeKind,serializableMappingCache}from"react-native-worklets";import{clampRGBA,convertToRGBA,isColor,rgbaArrayToRGBAColor,toGammaSpace,toLinearSpace}from"../Colors";import{logger,ReanimatedError,SHOULD_BE_USE_WEB}from"../common";import{ReduceMotion}from"../commonTypes";import{ReducedMotionManager}from"../ReducedMotion";import{addMatrices,decomposeMatrixIntoMatricesAndAngles,flatten,getRotationMatrix,isAffineMatrixFlat,multiplyMatrices,scaleMatrix,subtractMatrices}from"./transformationMatrix/matrixUtils";const IN_STYLE_UPDATER={current:!1},IN_STYLE_UPDATER_UI=createSerializable({current:!1});serializableMappingCache.set(IN_STYLE_UPDATER,IN_STYLE_UPDATER_UI);const LAYOUT_ANIMATION_SUPPORTED_PROPS={originX:!0,originY:!0,width:!0,height:!0,borderRadius:!0,globalOriginX:!0,globalOriginY:!0,opacity:!0,transform:!0,backgroundColor:!0};export function isValidLayoutAnimationProp(e){return e in LAYOUT_ANIMATION_SUPPORTED_PROPS}__DEV__&&ReducedMotionManager.jsValue&&logger.warn("Reduced motion setting is enabled on this device. This warning is visible only in the development mode. Some animations will be disabled by default. You can override the behavior for individual animations, see https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#reduced-motion-setting-is-enabled-on-this-device.");export function assertEasingIsWorklet(e){if(globalThis.__RUNTIME_KIND===RuntimeKind.ReactNative&&!SHOULD_BE_USE_WEB&&!e?.factory&&!isWorkletFunction(e))throw new ReanimatedError("The easing function is not a worklet. Please make sure you import `Easing` from react-native-reanimated.")}export function initialUpdaterRun(e){IN_STYLE_UPDATER.current=!0;const t=e();return IN_STYLE_UPDATER.current=!1,t}export function recognizePrefixSuffix(e){if("string"==typeof e){const t=e.match(/([A-Za-z]*)(-?\d*\.?\d*)([eE][-+]?[0-9]+)?([A-Za-z%]*)/);if(!t)throw new ReanimatedError("Couldn't parse animation value.");const r=t[1],o=t[4],n=t[2]+(t[3]??"");return{prefix:r,suffix:o,strippedValue:parseFloat(n)}}return{strippedValue:e}}const isReduceMotionOnUI=ReducedMotionManager.uiValue;export function getReduceMotionFromConfig(e){return e&&e!==ReduceMotion.System?e===ReduceMotion.Always:isReduceMotionOnUI.value}export function getReduceMotionForAnimation(e){if(e)return getReduceMotionFromConfig(e)}function applyProgressToMatrix(e,t,r){return addMatrices(t,scaleMatrix(subtractMatrices(r,t),e))}function applyProgressToNumber(e,t,r){return t+e*(r-t)}function decorateAnimation(e){const t=e.onStart,r=e.onFrame;if(e.isHigherOrder)return void(e.onStart=(e,r,o,n)=>(void 0===e.reduceMotion&&(e.reduceMotion=getReduceMotionFromConfig()),t(e,r,o,n)));const o=Object.assign({},e);delete o.callback;const n=(e,t)=>{e.current=e.strippedCurrent;const o=r(e,t);return e.strippedCurrent=e.current,e.current=(e.__prefix??"")+e.current+(e.__suffix??""),o},i=["R","G","B","A"],a=(e,t)=>{const r=[];let o=!0;return e.current=e.nonscaledCurrent,i.forEach(n=>{const i=e[n].onFrame(e[n],t);o=o&&i,r.push(e[n].current)}),clampRGBA(r),e.nonscaledCurrent=r,e.current=rgbaArrayToRGBAColor(toGammaSpace(r)),o},c=(e,t)=>{let r=!0;const o=e[0].onFrame(e[0],t);r=r&&o;const n=e[0].current/100,i=[];["translationMatrix","scaleMatrix","skewMatrix"].forEach((t,r)=>i.push(applyProgressToMatrix(n,e.startMatrices[t],e.stopMatrices[t])));const[a,c,u]=i,s=[];["x","y","z"].forEach((t,r)=>{const o=applyProgressToNumber(n,e.startMatrices["r"+t],e.stopMatrices["r"+t]);s.push(getRotationMatrix(o,t))});const[l,d,f]=s,m=multiplyMatrices(l,multiplyMatrices(d,f)),p=flatten(multiplyMatrices(multiplyMatrices(c,multiplyMatrices(u,m)),a));return e.current=p,r},u=(e,t)=>{let r=!0;return e.current.forEach((o,n)=>{const i=e[n].onFrame(e[n],t);r=r&&i,e.current[n]=e[n].current}),r},s=(e,t)=>{let r=!0;const o={};for(const n in e.current){const i=e[n].onFrame(e[n],t);r=r&&i,o[n]=e[n].current}return e.current=o,r};e.onStart=(e,r,l,d)=>(void 0===e.reduceMotion&&(e.reduceMotion=getReduceMotionFromConfig()),e.reduceMotion?(void 0!==e.toValue?e.current=e.toValue:t(e,r,l,d),e.startTime=0,void(e.onFrame=()=>!0)):isColor(r)?(((e,t,r,n)=>{let a,c,u;const s=[];isColor(t)&&(c=toLinearSpace(convertToRGBA(e.current)),a=toLinearSpace(convertToRGBA(t)),e.toValue&&(u=toLinearSpace(convertToRGBA(e.toValue)))),i.forEach((t,i)=>{e[t]=Object.assign({},o),e[t].current=c[i],e[t].toValue=u?u[i]:void 0,e[t].onStart(e[t],a[i],r,n?n[t]:void 0),s.push(e[t].current)}),e.unroundedCurrent=s,clampRGBA(s),e.current=rgbaArrayToRGBAColor(toGammaSpace(s))})(e,r,l,d),void(e.onFrame=a)):isAffineMatrixFlat(r)?(((e,t,r,n)=>{const i=e.toValue;e.startMatrices=decomposeMatrixIntoMatricesAndAngles(t),e.stopMatrices=decomposeMatrixIntoMatricesAndAngles(i),e[0]=Object.assign({},o),e[0].current=0,e[0].toValue=100,e[0].onStart(e[0],0,r,n?n[0]:void 0),e.current=t})(e,r,l,d),void(e.onFrame=c)):Array.isArray(r)?(((e,t,r,n)=>{t.forEach((t,i)=>{e[i]=Object.assign({},o),e[i].current=t,e[i].toValue=e.toValue[i],e[i].onStart(e[i],t,r,n?n[i]:void 0)}),e.current=[...t]})(e,r,l,d),void(e.onFrame=u)):"string"==typeof r?(((e,r,o,n)=>{const{prefix:i,suffix:a,strippedValue:c}=recognizePrefixSuffix(r);e.__prefix=i,e.__suffix=a,e.strippedCurrent=c;const{strippedValue:u}=recognizePrefixSuffix(e.toValue);if(e.current=c,e.startValue=c,e.toValue=u,n&&n!==e){const{prefix:e,suffix:t,strippedValue:r}=recognizePrefixSuffix(n.current);n.current=r,n.__prefix=e,n.__suffix=t}t(e,c,o,n),e.current=(e.__prefix??"")+e.current+(e.__suffix??""),n&&n!==e&&(n.current=(n.__prefix??"")+n.current+(n.__suffix??""))})(e,r,l,d),void(e.onFrame=n)):"object"==typeof r&&null!==r?(((e,t,r,n)=>{for(const i in t)e[i]=Object.assign({},o),e[i].onStart=e.onStart,e[i].current=t[i],e[i].toValue=e.toValue[i],e[i].onStart(e[i],t[i],r,n?n[i]:void 0);e.current=t})(e,r,l,d),void(e.onFrame=s)):void t(e,r,l,d))}export function defineAnimation(e,t){if(globalThis.__RUNTIME_KIND===RuntimeKind.ReactNative&&IN_STYLE_UPDATER.current)return e;const r=()=>{const e=t();return decorateAnimation(e),e};return globalThis.__RUNTIME_KIND!==RuntimeKind.ReactNative||SHOULD_BE_USE_WEB?r():(r.__isAnimationDefinition=!0,r)}function cancelAnimationNative(e){globalThis.__RUNTIME_KIND!==RuntimeKind.ReactNative?e.value=e.value:runOnUI(()=>{e.value=e.value})()}function cancelAnimationWeb(e){e.value=e.value}export const cancelAnimation=SHOULD_BE_USE_WEB?cancelAnimationWeb:cancelAnimationNative;