"use strict";import{useEffect,useRef}from"react";import{isWorkletFunction,makeShareable}from"react-native-worklets";import{initialUpdaterRun}from"../animation";import{IS_JEST,ReanimatedError,SHOULD_BE_USE_WEB}from"../common";import{startMapper,stopMapper}from"../core";import{updateProps,updatePropsJestWrapper}from"../updateProps";import{makeViewDescriptorsSet}from"../ViewDescriptorsSet";import{useSharedValue}from"./useSharedValue";import{buildWorkletsHash,isAnimated,shallowEqual,validateAnimatedStyles}from"./utils";function prepareAnimation(e,t,n,a){if(Array.isArray(t)&&t.forEach((t,i)=>{prepareAnimation(e,t,n&&n[i],a&&a[i])}),"object"==typeof t&&t.onFrame){const i=t;let r=i.current;null!=a&&("object"==typeof a?void 0!==a.value?r=a.value:void 0!==a.onFrame&&(void 0!==n?.current?r=n.current:void 0!==a?.current&&(r=a.current)):r=a),i.callStart=e=>{i.onStart(i,r,e,n)},i.callStart(e),i.callStart=null}else"object"==typeof t&&Object.keys(t).forEach(i=>prepareAnimation(e,t[i],n&&n[i],a&&a[i]))}function runAnimations(e,t,n,a,i,r){if(!i.value)return!0;if(Array.isArray(e)){a[n]=[];let o=!0;return r="boxShadow"===n,e.forEach((e,s)=>{runAnimations(e,t,s,a[n],i,r)||(o=!1)}),o}if("object"==typeof e&&e.onFrame){let i=!0;return e.finished||(e.callStart&&(e.callStart(t),e.callStart=null),i=e.onFrame(e,t),e.timestamp=t,i&&(e.finished=!0,e.callback?.(!0))),a[n]=r?{...e.current}:e.current,i}if("object"==typeof e){a[n]={};let o=!0;return Object.keys(e).forEach(s=>{runAnimations(e[s],t,s,a[n],i,r)||(o=!1)}),o}return a[n]=e,!0}function styleUpdater(e,t,n,a,i=!1,r){const o=n.animations??{},s=t()??{},l=n.last,u={};let c,m=!1,p=!1;for(const e in s){const t=s[e];isAnimated(t)?(c=global.__frameTimestamp||global._getAnimationTimestamp(),prepareAnimation(c,t,o[e],l[e]),o[e]=t,m=!0):(p=!0,u[e]=t,delete o[e])}if(m){const t=i=>{const{animations:r,last:o,isAnimationCancelled:s}=n;if(s)return void(n.isAnimationRunning=!1);const l={};let u=!0;for(const e in r){runAnimations(r[e],i,e,l,a)?(Array.isArray(l[e])?l[e].forEach(t=>{for(const n in t)o[e]&&"object"==typeof o[e]||(o[e]={}),o[e][n]=t[n]}):o[e]=l[e],delete r[e]):u=!1}l&&updateProps(e,l),u?n.isAnimationRunning=!1:requestAnimationFrame(t)};n.animations=o,n.isAnimationRunning||(n.isAnimationCancelled=!1,n.isAnimationRunning=!0,t(c)),p&&updateProps(e,u)}else n.isAnimationCancelled=!0,n.animations=[],shallowEqual(l,s)&&!r||updateProps(e,s,i);n.last=s}function jestStyleUpdater(e,t,n,a,i,r,o){const s=n.animations??{},l=t()??{},u=n.last;let c,m=!1;Object.keys(s).forEach(e=>{const t=l[e];isAnimated(t)||delete s[e]}),Object.keys(l).forEach(e=>{const t=l[e];isAnimated(t)&&(c=global.__frameTimestamp||global._getAnimationTimestamp(),prepareAnimation(c,t,s[e],u[e]),s[e]=t,m=!0)}),m?(n.animations=s,n.isAnimationRunning||(n.isAnimationCancelled=!1,n.isAnimationRunning=!0,function t(o){const{animations:s,last:l,isAnimationCancelled:u}=n;if(u)return void(n.isAnimationRunning=!1);const c={};let m=!0;Object.keys(s).forEach(e=>{runAnimations(s[e],o,e,c,a)?(l[e]=c[e],delete s[e]):m=!1}),Object.keys(c).length&&updatePropsJestWrapper(e,c,i,r),m?n.isAnimationRunning=!1:requestAnimationFrame(t)}(c))):(n.isAnimationCancelled=!0,n.animations=[]),n.last=l,shallowEqual(u,l)&&!o||updatePropsJestWrapper(e,l,i,r)}function checkSharedValueUsage(e,t){if(Array.isArray(e))for(const n of e)checkSharedValueUsage(n,t);else if("object"==typeof e&&null!==e&&void 0===e.value)for(const t of Object.keys(e))checkSharedValueUsage(e[t],t);else if(void 0!==t&&"object"==typeof e&&null!==e&&void 0!==e.value)throw new ReanimatedError(`Invalid value passed to \`${t}\`, maybe you forgot to use \`.value\`?`)}export function useAnimatedStyle(e,t,n,a=!1){const i=useRef(null);let r=Object.values(e.__closure??{});if(SHOULD_BE_USE_WEB&&(!r.length&&t?.length&&(r=t),__DEV__&&!r.length&&!t&&!isWorkletFunction(e)))throw new ReanimatedError("`useAnimatedStyle` was used without a dependency array or Babel plugin. Please explicitly pass a dependency array, or enable the Babel plugin.\nFor more, see the docs: `https://docs.swmansion.com/react-native-reanimated/docs/guides/web-support#web-without-the-babel-plugin`.");const o=n?Array.isArray(n)?n:[n]:[],s=n?buildWorkletsHash(o):null,l=useSharedValue(!0),u=useRef({});if(t?t.push(e.__workletHash):t=[...r,e.__workletHash],s&&t.push(s),!i.current){const t=initialUpdaterRun(e);__DEV__&&validateAnimatedStyles(t),i.current={initial:{value:t,updater:e},remoteState:makeShareable({last:t,animations:{},isAnimationCancelled:!1,isAnimationRunning:!1}),viewDescriptors:makeViewDescriptorsSet(),styleUpdaterContainer:{current:void 0}}}const{initial:c,remoteState:m,viewDescriptors:p}=i.current,d=p.shareableViewDescriptors;t.push(d),useEffect(()=>{let t,s=e;n&&(s=()=>{const t=e();return o.forEach(e=>{e(t)}),t}),t=IS_JEST?t=>{jestStyleUpdater(d,e,m,l,u,o,t)}:e=>{styleUpdater(d,s,m,l,a,e)},i.current&&(i.current.styleUpdaterContainer.current=t);const c=startMapper(t,r);return()=>{stopMapper(c)}},t),useEffect(()=>(l.value=!0,()=>{l.value=!1}),[l]),__DEV__&&checkSharedValueUsage(c.value);const f=useRef(null);if(!f.current){const e=i.current.styleUpdaterContainer;f.current=IS_JEST?{viewDescriptors:p,initial:c,jestAnimatedValues:u,toJSON:animatedStyleHandleToJSON,styleUpdaterContainer:e}:{viewDescriptors:p,initial:c,styleUpdaterContainer:e}}return f.current}function animatedStyleHandleToJSON(){return"{}"}