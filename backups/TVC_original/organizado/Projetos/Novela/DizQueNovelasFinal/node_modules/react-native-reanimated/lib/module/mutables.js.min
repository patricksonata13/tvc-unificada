"use strict";import{createSerializable,createSynchronizable,executeOnUIRuntimeSync,runOnUI,serializableMappingCache}from"react-native-worklets";import{IS_JEST,logger,ReanimatedError,SHOULD_BE_USE_WEB}from"./common";import{getStaticFeatureFlag}from"./featureFlags";import{isFirstReactRender,isReactRendering}from"./reactUtils";import{valueSetter}from"./valueSetter";function shouldWarnAboutAccessDuringRender(){return __DEV__&&isReactRendering()&&!isFirstReactRender()}function checkInvalidReadDuringRender(){shouldWarnAboutAccessDuringRender()&&logger.warn("Reading from `value` during component render. Please ensure that you don't access the `value` property nor use `get` method of a shared value while React is rendering a component.",{strict:!0})}function checkInvalidWriteDuringRender(){shouldWarnAboutAccessDuringRender()&&logger.warn("Writing to `value` during component render. Please ensure that you don't access the `value` property nor use `set` method of a shared value while React is rendering a component.",{strict:!0})}function addCompilerSafeGetAndSet(e){Object.defineProperties(e,{get:{value:()=>e.value,configurable:!1,enumerable:!1},set:{value(t){"function"!=typeof t||t.__isAnimationDefinition?e.value=t:e.value=t(e.value)},configurable:!1,enumerable:!1}})}function hideInternalValueProp(e){Object.defineProperty(e,"_value",{configurable:!1,enumerable:!1})}function experimental_makeMutableUI(e,t){const n=new Map;let a=e,r=!1;const i={get value(){return a},set value(e){valueSetter(i,e)},get _value(){return a},set _value(e){r||this.setDirty(!0),a=e,n.forEach(t=>{t(e)})},modify:(e,t=!0)=>{valueSetter(i,void 0!==e?e(a):a,t)},addListener:(e,t)=>{n.set(e,t)},removeListener:e=>{n.delete(e)},setDirty:e=>{t.setBlocking(e),r=e},_animation:null,_isReanimatedSharedValue:!0};return hideInternalValueProp(i),addCompilerSafeGetAndSet(i),i}export function legacy_makeMutableUI(e){const t=new Map;let n=e;const a={get value(){return n},set value(e){valueSetter(a,e)},get _value(){return n},set _value(e){n=e,t.forEach(t=>{t(e)})},modify:(e,t=!0)=>{valueSetter(a,void 0!==e?e(n):n,t)},addListener:(e,n)=>{t.set(e,n)},removeListener:e=>{t.delete(e)},_animation:null,_isReanimatedSharedValue:!0};return hideInternalValueProp(a),addCompilerSafeGetAndSet(a),a}const USE_SYNCHRONIZABLE_FOR_MUTABLES=getStaticFeatureFlag("USE_SYNCHRONIZABLE_FOR_MUTABLES");function experimental_makeMutableNative(e){let t=e;const n=createSynchronizable(!1),a=createSerializable({__init:()=>experimental_makeMutableUI(e,n)}),r={get value(){if(checkInvalidReadDuringRender(),n.getBlocking()){const e=executeOnUIRuntimeSync(e=>(e.setDirty(!1),e.value));t=e(r)}return t},set value(e){checkInvalidWriteDuringRender(),runOnUI(()=>{r.value=e})()},get _value(){throw new ReanimatedError("Reading from `_value` directly is only possible on the UI runtime. Perhaps you passed an Animated Style to a non-animated component?")},set _value(e){throw new ReanimatedError("Setting `_value` directly is only possible on the UI runtime. Perhaps you want to assign to `value` instead?")},modify:(e,t=!0)=>{runOnUI(()=>{r.modify(e,t)})()},addListener:()=>{throw new ReanimatedError("Adding listeners is only possible on the UI runtime.")},removeListener:()=>{throw new ReanimatedError("Removing listeners is only possible on the UI runtime.")},_isReanimatedSharedValue:!0};return hideInternalValueProp(r),addCompilerSafeGetAndSet(r),serializableMappingCache.set(r,a),r}function makeMutableNative(e){const t=createSerializable({__init:()=>legacy_makeMutableUI(e)}),n={get value(){checkInvalidReadDuringRender();return executeOnUIRuntimeSync(e=>e.value)(n)},set value(e){checkInvalidWriteDuringRender(),runOnUI(()=>{n.value=e})()},get _value(){throw new ReanimatedError("Reading from `_value` directly is only possible on the UI runtime. Perhaps you passed an Animated Style to a non-animated component?")},set _value(e){throw new ReanimatedError("Setting `_value` directly is only possible on the UI runtime. Perhaps you want to assign to `value` instead?")},modify:(e,t=!0)=>{runOnUI(()=>{n.modify(e,t)})()},addListener:()=>{throw new ReanimatedError("Adding listeners is only possible on the UI runtime.")},removeListener:()=>{throw new ReanimatedError("Removing listeners is only possible on the UI runtime.")},_isReanimatedSharedValue:!0};return hideInternalValueProp(n),addCompilerSafeGetAndSet(n),serializableMappingCache.set(n,t),n}function makeMutableWeb(e){let t=e;const n=new Map,a={get value(){return checkInvalidReadDuringRender(),t},set value(e){checkInvalidWriteDuringRender(),valueSetter(a,e)},get _value(){return t},set _value(e){t=e,n.forEach(t=>{t(e)})},modify:(e,t=!0)=>{valueSetter(a,void 0!==e?e(a.value):a.value,t)},addListener:(e,t)=>{n.set(e,t)},removeListener:e=>{n.delete(e)},_isReanimatedSharedValue:!0};return hideInternalValueProp(a),addCompilerSafeGetAndSet(a),IS_JEST&&(a.toJSON=()=>mutableToJSON(t)),a}export const makeMutable=SHOULD_BE_USE_WEB?makeMutableWeb:USE_SYNCHRONIZABLE_FOR_MUTABLES?experimental_makeMutableNative:makeMutableNative;function mutableToJSON(e){return JSON.stringify(e)}