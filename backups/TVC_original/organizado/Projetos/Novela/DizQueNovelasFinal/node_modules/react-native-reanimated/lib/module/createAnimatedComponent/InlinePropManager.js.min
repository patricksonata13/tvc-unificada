"use strict";import{isSharedValue}from"../isSharedValue";import{startMapper,stopMapper}from"../mappers";import{updateProps}from"../updateProps";import{makeViewDescriptorsSet}from"../ViewDescriptorsSet";import{flattenArray}from"./utils";function isInlineStyleTransform(e){return!!Array.isArray(e)&&e.some(e=>hasInlineStyles(e))}function inlinePropsHasChanged(e,r){if(Object.keys(e).length!==Object.keys(r).length)return!0;for(const s of Object.keys(e))if(e[s]!==r[s])return!0;return!1}function getInlinePropsUpdate(e){const r={};for(const[s,t]of Object.entries(e))isSharedValue(t)?r[s]=t.value:Array.isArray(t)?r[s]=t.map(e=>getInlinePropsUpdate(e)):r[s]="object"==typeof t?getInlinePropsUpdate(t):t;return r}function extractSharedValuesMapFromProps(e){const r={};for(const s in e){const t=e[s];if("style"===s){flattenArray(e.style??[]).forEach(e=>{if(e)for(const[s,t]of Object.entries(e))(isSharedValue(t)||"transform"===s&&isInlineStyleTransform(t))&&(r[s]=t)})}else isSharedValue(t)&&(r[s]=t)}return r}export function hasInlineStyles(e){return!!e&&Object.keys(e).some(r=>{const s=e[r];return isSharedValue(s)||"transform"===r&&isInlineStyleTransform(s)})}export function getInlineStyle(e,r){if(r)return getInlinePropsUpdate(e);const s={};for(const[r,t]of Object.entries(e))isSharedValue(t)||"transform"===r&&isInlineStyleTransform(t)||(s[r]=t);return s}export class InlinePropManager{_inlinePropsViewDescriptors=null;_inlinePropsMapperId=null;_inlineProps={};attachInlineProps(e,r){const s=extractSharedValuesMapFromProps(e.props);if(inlinePropsHasChanged(s,this._inlineProps)){if(!this._inlinePropsViewDescriptors){this._inlinePropsViewDescriptors=makeViewDescriptorsSet();const{viewTag:e,shadowNodeWrapper:s}=r;this._inlinePropsViewDescriptors.add({tag:e,shadowNodeWrapper:s})}const e=this._inlinePropsViewDescriptors.shareableViewDescriptors,t=()=>{const r=getInlinePropsUpdate(s);updateProps(e,r)};this._inlineProps=s,this._inlinePropsMapperId&&stopMapper(this._inlinePropsMapperId),this._inlinePropsMapperId=null,Object.keys(s).length&&(this._inlinePropsMapperId=startMapper(t,Object.values(s)))}}detachInlineProps(){this._inlinePropsMapperId&&stopMapper(this._inlinePropsMapperId)}}