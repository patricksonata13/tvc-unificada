"use strict";import{convertPropertiesToArrays,kebabizeCamelCase}from"../../utils";import{processKeyframeDefinitions}from"../animationParser";import{configureWebCSSAnimations,insertCSSAnimation,removeCSSAnimation}from"../domUtils";import{CSSKeyframesRuleImpl}from"../keyframes";import{maybeAddSuffixes,parseTimingFunction}from"../utils";const isCSSKeyframesRuleImpl=e=>"object"==typeof e&&"processedKeyframes"in e;export default class CSSAnimationsManager{attachedAnimations={};constructor(e){configureWebCSSAnimations(),this.element=e}update(e){if(!e)return void this.detach();const{animationName:t,...i}=convertPropertiesToArrays(e);if(0===t.length)return void this.detach();const n=t.map(e=>{if(isCSSKeyframesRuleImpl(e))return{keyframesRule:e,removable:!1};const t=e,i=processKeyframeDefinitions(t);return this.attachedAnimations[i]?{keyframesRule:this.attachedAnimations[i].keyframesRule,removable:!0}:{keyframesRule:new CSSKeyframesRuleImpl(t,i),removable:!0}}),a=n.map(({keyframesRule:{name:e}})=>e);this.updateAttachedAnimations(n),this.setElementAnimations(a,i)}unmountCleanup(){setTimeout(this.detach.bind(this))}detach(){const e=Object.values(this.attachedAnimations);0!==e.length&&(this.element.style.animationDuration="",this.element.style.animationDelay="",this.element.style.animationDirection="",this.element.style.animationFillMode="",this.element.style.animationPlayState="",this.element.style.animationTimingFunction="",e.forEach(({keyframesRule:{name:e,processedKeyframes:t},removable:i})=>{i&&t&&removeCSSAnimation(e)}),this.attachedAnimations={})}updateAttachedAnimations(e){const t={};e.forEach(e=>{const i=e.keyframesRule;i.processedKeyframes&&insertCSSAnimation(i.name,i.processedKeyframes),t[i.processedKeyframes]=e}),Object.values(this.attachedAnimations).forEach(({keyframesRule:e,removable:i})=>{i&&e.processedKeyframes&&!t[e.processedKeyframes]&&removeCSSAnimation(e.name)}),this.attachedAnimations=t}setElementAnimations(e,t){this.element.style.animationName=e.join(","),this.element.style.animationDuration=maybeAddSuffixes(t,"animationDuration","ms").join(","),this.element.style.animationDelay=maybeAddSuffixes(t,"animationDelay","ms").join(","),t.animationIterationCount&&(this.element.style.animationIterationCount=t.animationIterationCount.join(",")),t.animationDirection&&(this.element.style.animationDirection=t.animationDirection.map(kebabizeCamelCase).join(",")),t.animationFillMode&&(this.element.style.animationFillMode=t.animationFillMode.join(",")),t.animationPlayState&&(this.element.style.animationPlayState=t.animationPlayState.join(",")),t.animationTimingFunction&&(this.element.style.animationTimingFunction=parseTimingFunction(t.animationTimingFunction))}}