"use strict";import{useEffect,useMemo,useRef}from"react";import{callMicrotasks}from"react-native-worklets";import{InterfaceOrientation,IOSReferenceFrame,SensorType}from"../commonTypes";import{initializeSensor,registerSensor,unregisterSensor}from"../core";function eulerToQuaternion(e,r,t){const n=Math.cos(e/2),i=Math.sin(e/2),o=Math.cos(r/2),a=Math.sin(r/2),c=Math.cos(t/2),s=Math.sin(t/2);return[i*o*c-n*a*s,n*a*c+i*o*s,n*o*s+i*a*c,n*o*c-i*a*s]}function adjustRotationToInterfaceOrientation(e){const{interfaceOrientation:r,pitch:t,roll:n,yaw:i}=e;r===InterfaceOrientation.ROTATION_90?(e.pitch=n,e.roll=-t,e.yaw=i-Math.PI/2):r===InterfaceOrientation.ROTATION_270?(e.pitch=-n,e.roll=t,e.yaw=i+Math.PI/2):r===InterfaceOrientation.ROTATION_180&&(e.pitch*=-1,e.roll*=-1,e.yaw*=-1);const o=eulerToQuaternion(e.pitch,e.roll,e.yaw);return e.qx=o[0],e.qy=o[1],e.qz=o[2],e.qw=o[3],e}function adjustVectorToInterfaceOrientation(e){const{interfaceOrientation:r,x:t,y:n}=e;return r===InterfaceOrientation.ROTATION_90?(e.x=-n,e.y=t):r===InterfaceOrientation.ROTATION_270?(e.x=n,e.y=-t):r===InterfaceOrientation.ROTATION_180&&(e.x*=-1,e.y*=-1),e}export function useAnimatedSensor(e,r){const t=useRef(r);(t.current?.adjustToInterfaceOrientation!==r?.adjustToInterfaceOrientation||t.current?.interval!==r?.interval||t.current?.iosReferenceFrame!==r?.iosReferenceFrame)&&(t.current={...r});const n=useMemo(()=>({interval:"auto",adjustToInterfaceOrientation:!0,iosReferenceFrame:IOSReferenceFrame.Auto,...t.current}),[t.current]),i=useRef({sensor:initializeSensor(e,n),unregister:()=>{},isAvailable:!1,config:n});return useEffect(()=>{i.current={sensor:initializeSensor(e,n),unregister:()=>{},isAvailable:!1,config:n};const r=i.current.sensor,t=i.current.config.adjustToInterfaceOrientation,o=registerSensor(e,n,n=>{t&&(n=e===SensorType.ROTATION?adjustRotationToInterfaceOrientation(n):adjustVectorToInterfaceOrientation(n)),r.value=n,callMicrotasks()});return-1!==o?(i.current.unregister=()=>unregisterSensor(o),i.current.isAvailable=!0):(i.current.unregister=()=>{},i.current.isAvailable=!1),()=>{i.current.unregister()}},[e,n]),i.current}