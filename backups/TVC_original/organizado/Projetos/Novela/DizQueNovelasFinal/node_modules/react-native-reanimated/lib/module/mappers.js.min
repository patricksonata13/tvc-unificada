"use strict";import{runOnUI}from"react-native-worklets";import{IS_JEST}from"./common";import{isSharedValue}from"./isSharedValue";function createMapperRegistry(){const t=new Map;let o=[],e=!1,r=!1;function n(){const e=new Map;t.forEach(t=>{if(t.outputs)for(const o of t.outputs){const r=e.get(o);void 0===r?e.set(o,[t]):r.push(t)}});const r=new Set,n=[];function s(t){r.add(t);for(const o of t.inputs){const t=e.get(o);if(t)for(const o of t)r.has(o)||s(o)}n.push(t)}t.forEach(t=>{r.has(t)||s(t)}),o=n}function s(){if(e=!1,!r)try{r=!0,t.size!==o.length&&n();for(const t of o)t.dirty&&(t.dirty=!1,t.worklet())}finally{r=!1}}function i(){IS_JEST?s():e||(r?requestAnimationFrame(s):queueMicrotask(s),e=!0)}function a(t,o){if(Array.isArray(t))for(const e of t)e&&a(e,o);else if(isSharedValue(t))o.push(t);else if(Object.getPrototypeOf(t)===Object.prototype)for(const e of Object.values(t))e&&a(e,o);return o}return{start:(e,r,n,s)=>{const f={id:e,dirty:!0,worklet:r,inputs:a(n,[]),outputs:s};t.set(f.id,f),o=[];for(const t of f.inputs)t.addListener(f.id,()=>{f.dirty=!0,i()});i()},stop:e=>{const r=t.get(e);if(r){t.delete(r.id),o=[];for(const t of r.inputs)t.removeListener(r.id)}}}}let MAPPER_ID=9999;export function startMapper(t,o=[],e=[]){const r=MAPPER_ID+=1;return runOnUI(()=>{let n=global.__mapperRegistry;void 0===n&&(n=global.__mapperRegistry=createMapperRegistry()),n.start(r,t,o,e)})(),r}export function stopMapper(t){runOnUI(()=>{const o=global.__mapperRegistry;o?.stop(t)})()}