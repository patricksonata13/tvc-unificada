"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExpoError=void 0,exports.createRequestHandler=createRequestHandler,exports.convertHeaders=convertHeaders,exports.convertRequest=convertRequest,exports.respond=respond;const node_stream_1=require("node:stream"),promises_1=require("node:stream/promises"),abstract_1=require("./abstract"),runtime_1=require("../runtime"),node_1=require("./environment/node"),createReadableStreamFromReadable_1=require("../utils/createReadableStreamFromReadable");var abstract_2=require("./abstract");Object.defineProperty(exports,"ExpoError",{enumerable:!0,get:function(){return abstract_2.ExpoError}});const scopeSymbol=Symbol.for("expoServerScope"),SYMBOL_FOR_REQ_CONTEXT=Symbol.for("@vercel/request-context");function getContext(){const e=globalThis;return e[SYMBOL_FOR_REQ_CONTEXT]?.get?.()??{}}const STORE={getStore:()=>getContext()[scopeSymbol],run:(e,r,...t)=>(getContext()[scopeSymbol]=e,r(...t))};function createRequestHandler(e){const r=(0,runtime_1.createRequestScope)(STORE,e=>{const r=e.headers.get("host"),t=e.headers.get("x-forwarded-proto")||"https";return{origin:r?`${t}://${r}`:"null",environment:process.env.VERCEL_ENV??process.env.NODE_ENV,waitUntil:getContext().waitUntil}}),t=(0,abstract_1.createRequestHandler)((0,node_1.createNodeEnv)(e));return async(e,o)=>respond(o,await r(t,convertRequest(e,o)))}function convertHeaders(e){const r=new Headers;for(const[t,o]of Object.entries(e))if(o)if(Array.isArray(o))for(const e of o)r.append(t,e);else r.set(t,o);return r}function convertRawHeaders(e){const r=new Headers;for(let t=0;t<e.length;t+=2)r.append(e[t],e[t+1]);return r}function convertRequest(e,r){const t=e.headers["x-forwarded-host"]||e.headers.host,o=e.headers["x-forwarded-proto"]||"https",s=new URL(`${o}://${t}${e.url}`),a=new AbortController;r.on("close",()=>a.abort());const n={method:e.method,headers:convertRawHeaders(e.rawHeaders),signal:a.signal};return"GET"!==e.method&&"HEAD"!==e.method&&(n.body=(0,createReadableStreamFromReadable_1.createReadableStreamFromReadable)(e),n.duplex="half"),new Request(s.href,n)}async function respond(e,r){e.statusMessage=r.statusText,e.writeHead(r.status,r.statusText,[...r.headers.entries()].flat()),r.body?await(0,promises_1.pipeline)(node_stream_1.Readable.fromWeb(r.body),e):e.end()}