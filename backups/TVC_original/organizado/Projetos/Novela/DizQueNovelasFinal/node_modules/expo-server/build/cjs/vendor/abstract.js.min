"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExpoError=void 0,exports.createRequestHandler=createRequestHandler;const ImmutableRequest_1=require("../ImmutableRequest"),matchers_1=require("../utils/matchers"),middleware_1=require("../utils/middleware");class ExpoError extends Error{constructor(e){super(e),this.name="ExpoError"}static isExpoError(e){return!!e&&e instanceof ExpoError}}function noopBeforeResponse(e,t){return e}function createRequestHandler({getRoutesManifest:e,getHtml:t,getApiRoute:r,getMiddleware:o,beforeErrorResponse:n=noopBeforeResponse,beforeResponse:s=noopBeforeResponse,beforeHTMLResponse:a=noopBeforeResponse,beforeAPIResponse:u=noopBeforeResponse}){let i=null;return async function(n){return i||(i=await e()),async function(e,n){if(!n)return d(null,null,"Not found",{status:404,headers:new Headers({"Content-Type":"text/plain"})});let s=e,a=new URL(s.url);if(n.middleware){const e=await o(n.middleware);if((0,middleware_1.shouldRunMiddleware)(s,e)){const t=await e.default(new ImmutableRequest_1.ImmutableRequest(s));if(t instanceof Response)return t}}if(n.redirects)for(const e of n.redirects)if(e.namedRegex.test(a.pathname)&&(!e.methods||e.methods.includes(s.method)))return f(a,s,e);if(n.rewrites)for(const e of n.rewrites)e.namedRegex.test(a.pathname)&&(e.methods&&!e.methods.includes(s.method)||(a=(0,matchers_1.getRedirectRewriteLocation)(a,s,e),s=new Request(a,s)));if("GET"===s.method||"HEAD"===s.method)for(const e of n.htmlRoutes){if(!e.namedRegex.test(a.pathname))continue;return p(await t(s,e),e)}for(const e of n.apiRoutes){if(!e.namedRegex.test(a.pathname))continue;const t=await r(e);return await c(t,s,e)}if("GET"===s.method||"HEAD"===s.method)for(const e of n.notFoundRoutes)if(e.namedRegex.test(a.pathname))try{return l(await t(s,e),e)}catch{continue}return d(null,null,"Not found",{status:404,headers:new Headers({"Content-Type":"text/plain"})})}(n,i)};function d(e=null,t,r,o){const d=o.status;let l;t&&e?(t.type=e,l=t):l={type:null};let c=o;if(i?.headers)for(const e in i.headers)if(Array.isArray(i.headers[e]))for(const t of i.headers[e])c.headers.append(e,t);else null==i.headers[e]||c.headers.has(e)||c.headers.set(e,i.headers[e]);return"html"===e&&(c=a(c,l)),"api"===e&&(c=u(c,l)),"number"==typeof d&&(0===d||d>399)&&(c=n(c,l)),c=s(c,l),0===d&&(c.status=500),new Response(r,c)}async function l(e,t){if("string"==typeof e)return d("notFoundHtml",t,e,{status:404,headers:new Headers({"Content-Type":"text/html"})});if((0,matchers_1.isResponse)(e))return e;throw new ExpoError(`HTML route file ${t.page}.html could not be loaded`)}async function c(e,t,r){if(!e||"object"!=typeof e)throw new ExpoError(`API route module ${r.page} could not be loaded`);if((0,matchers_1.isResponse)(e))return e;const o=e[t.method];if(!o||"function"!=typeof o)return d("notAllowedApi",r,"Method not allowed",{status:405,headers:new Headers({"Content-Type":"text/plain"})});const n=(0,matchers_1.parseParams)(t,r),s=await o(t,n);if(!(0,matchers_1.isResponse)(s))throw new ExpoError(`API route ${t.method} handler ${r.page} resolved to a non-Response result`);return function(e=null,t,r){const o={headers:new Headers(r.headers),status:r.status,statusText:r.statusText,cf:r.cf,webSocket:r.webSocket};return d(e,t,r.body,o)}("api",r,s)}function p(e,t){if("string"==typeof e)return d("html",t,e,{status:200,headers:new Headers({"Content-Type":"text/html"})});if((0,matchers_1.isResponse)(e))return e;throw new ExpoError(`HTML route file ${t.page}.html could not be loaded`)}function f(e,t,r){const o=(0,matchers_1.getRedirectRewriteLocation)(e,t,r);let n;return n="GET"===t.method||"HEAD"===t.method?r.permanent?301:302:r.permanent?308:307,Response.redirect(o,n)}}exports.ExpoError=ExpoError;