"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createRequestScope=createRequestScope;const error_1=require("./error"),scope_1=require("./scope"),importMetaRegistry_1=require("../utils/importMetaRegistry");function setupRuntime(){try{Object.defineProperty(globalThis,"origin",{enumerable:!0,configurable:!0,get:()=>scope_1.scopeRef.current?.getStore()?.origin||"null"})}catch{}try{Object.defineProperty(globalThis,"__ExpoImportMetaRegistry",{enumerable:!0,configurable:!0,get:()=>importMetaRegistry_1.importMetaRegistry})}catch{}}function createRequestScope(e,r){function t(e){e.finally(()=>{})}return setupRuntime(),async(o,...s)=>{scope_1.scopeRef.current=e;const n=r(...s),{waitUntil:i=t}=n,c=[],a=[],u={...n,origin:n.origin,environment:n.environment,waitUntil:i,deferTask:n.deferTask,setResponseHeaders(e){a.push(e)}};let f;u.deferTask||(u.deferTask=function(e){c.push(e)});try{f=null!=scope_1.scopeRef.current?await scope_1.scopeRef.current.run(u,()=>o(...s)):await o(...s)}catch(e){if(!(null!=e&&e instanceof Response)||e.bodyUsed){if(null!=e&&e instanceof Error&&"status"in e)return(0,error_1.errorToResponse)(e);throw e}f=e}c.forEach(e=>{const r=e();null!=r&&i(r)});for(const e of a){let r=f.headers;if("function"==typeof e)r=e(f.headers)||r;else if(e instanceof Headers)r=e;else if("object"==typeof e&&e)for(const t in e)if(Array.isArray(e[t]))for(const o of e[t])r.append(t,o);else null!=e[t]&&r.set(t,e[t]);if(r!==f.headers)for(const[e,t]of r)f.headers.set(e,t)}return f}}