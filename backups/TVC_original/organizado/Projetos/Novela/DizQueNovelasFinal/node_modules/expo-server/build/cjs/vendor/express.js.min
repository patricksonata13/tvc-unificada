"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExpoError=void 0,exports.createRequestHandler=createRequestHandler,exports.convertHeaders=convertHeaders,exports.convertRequest=convertRequest,exports.respond=respond;const node_async_hooks_1=require("node:async_hooks"),node_stream_1=require("node:stream"),promises_1=require("node:stream/promises"),abstract_1=require("./abstract"),node_1=require("./environment/node");var abstract_2=require("./abstract");Object.defineProperty(exports,"ExpoError",{enumerable:!0,get:function(){return abstract_2.ExpoError}});const STORE=new node_async_hooks_1.AsyncLocalStorage;function createRequestHandler(e,r){const t=(0,node_1.createNodeRequestScope)(STORE,e),o=(0,abstract_1.createRequestHandler)({...(0,node_1.createNodeEnv)(e),...r});return async(e,n,s)=>{if(!e?.url||!e.method)return s();try{const s=convertRequest(e,n),a=await async function(e){try{return await t(o,e)}catch(e){const t=r?.handleRouteError;if(t&&null!=e&&"object"==typeof e)try{return await t(e)}catch{}throw e}}(s);await respond(n,a)}catch(e){s(e)}}}function convertHeaders(e){const r=new Headers;for(const[t,o]of Object.entries(e))if(o)if(Array.isArray(o))for(const e of o)r.append(t,e);else r.set(t,o);return r}function convertRawHeaders(e){const r=new Headers;for(let t=0;t<e.length;t+=2)r.append(e[t],e[t+1]);return r}function convertRequest(e,r){const t=new URL(`${e.protocol}://${e.get("host")}${e.url}`),o=new AbortController;r.on("close",()=>o.abort());const n={method:e.method,headers:convertRawHeaders(e.rawHeaders),signal:o.signal};return"GET"!==e.method&&"HEAD"!==e.method&&(n.body=node_stream_1.Readable.toWeb(e),n.duplex="half"),new Request(t.href,n)}async function respond(e,r){if(e.statusMessage=r.statusText,e.status(r.status),"function"==typeof e.setHeaders)e.setHeaders(r.headers);else for(const[t,o]of r.headers.entries())e.appendHeader(t,o);r.body?await(0,promises_1.pipeline)(node_stream_1.Readable.fromWeb(r.body),e):e.end()}