import{ImmutableRequest}from"../ImmutableRequest";import{getRedirectRewriteLocation,isResponse,parseParams}from"../utils/matchers";import{shouldRunMiddleware}from"../utils/middleware";export class ExpoError extends Error{constructor(e){super(e),this.name="ExpoError"}static isExpoError(e){return!!e&&e instanceof ExpoError}}function noopBeforeResponse(e,t){return e}export function createRequestHandler({getRoutesManifest:e,getHtml:t,getApiRoute:o,getMiddleware:n,beforeErrorResponse:r=noopBeforeResponse,beforeResponse:s=noopBeforeResponse,beforeHTMLResponse:a=noopBeforeResponse,beforeAPIResponse:i=noopBeforeResponse}){let u=null;return async function(r){return u||(u=await e()),async function(e,r){if(!r)return d(null,null,"Not found",{status:404,headers:new Headers({"Content-Type":"text/plain"})});let s=e,a=new URL(s.url);if(r.middleware){const e=await n(r.middleware);if(shouldRunMiddleware(s,e)){const t=await e.default(new ImmutableRequest(s));if(t instanceof Response)return t}}if(r.redirects)for(const e of r.redirects)if(e.namedRegex.test(a.pathname)&&(!e.methods||e.methods.includes(s.method)))return c(a,s,e);if(r.rewrites)for(const e of r.rewrites)e.namedRegex.test(a.pathname)&&(e.methods&&!e.methods.includes(s.method)||(a=getRedirectRewriteLocation(a,s,e),s=new Request(a,s)));if("GET"===s.method||"HEAD"===s.method)for(const e of r.htmlRoutes){if(!e.namedRegex.test(a.pathname))continue;return l(await t(s,e),e)}for(const e of r.apiRoutes){if(!e.namedRegex.test(a.pathname))continue;const t=await o(e);return await p(t,s,e)}if("GET"===s.method||"HEAD"===s.method)for(const e of r.notFoundRoutes)if(e.namedRegex.test(a.pathname))try{return f(await t(s,e),e)}catch{continue}return d(null,null,"Not found",{status:404,headers:new Headers({"Content-Type":"text/plain"})})}(r,u)};function d(e=null,t,o,n){const d=n.status;let f;t&&e?(t.type=e,f=t):f={type:null};let p=n;if(u?.headers)for(const e in u.headers)if(Array.isArray(u.headers[e]))for(const t of u.headers[e])p.headers.append(e,t);else null==u.headers[e]||p.headers.has(e)||p.headers.set(e,u.headers[e]);return"html"===e&&(p=a(p,f)),"api"===e&&(p=i(p,f)),"number"==typeof d&&(0===d||d>399)&&(p=r(p,f)),p=s(p,f),0===d&&(p.status=500),new Response(o,p)}async function f(e,t){if("string"==typeof e)return d("notFoundHtml",t,e,{status:404,headers:new Headers({"Content-Type":"text/html"})});if(isResponse(e))return e;throw new ExpoError(`HTML route file ${t.page}.html could not be loaded`)}async function p(e,t,o){if(!e||"object"!=typeof e)throw new ExpoError(`API route module ${o.page} could not be loaded`);if(isResponse(e))return e;const n=e[t.method];if(!n||"function"!=typeof n)return d("notAllowedApi",o,"Method not allowed",{status:405,headers:new Headers({"Content-Type":"text/plain"})});const r=parseParams(t,o),s=await n(t,r);if(!isResponse(s))throw new ExpoError(`API route ${t.method} handler ${o.page} resolved to a non-Response result`);return function(e=null,t,o){const n={headers:new Headers(o.headers),status:o.status,statusText:o.statusText,cf:o.cf,webSocket:o.webSocket};return d(e,t,o.body,n)}("api",o,s)}function l(e,t){if("string"==typeof e)return d("html",t,e,{status:200,headers:new Headers({"Content-Type":"text/html"})});if(isResponse(e))return e;throw new ExpoError(`HTML route file ${t.page}.html could not be loaded`)}function c(e,t,o){const n=getRedirectRewriteLocation(e,t,o);let r;return r="GET"===t.method||"HEAD"===t.method?o.permanent?301:302:o.permanent?308:307,Response.redirect(n,r)}}