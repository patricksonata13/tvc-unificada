"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeInput=void 0,exports.getRscMiddleware=getRscMiddleware;const decodeInput=e=>{if("index.txt"===e)return"";if(e?.endsWith(".txt"))return e.slice(0,-4);const t=new Error("Invalid encoded input");throw t.statusCode=400,t};function getRscMiddleware(e){let t=e.rscPath;async function r(r){const n=new URL(r.url),{method:s}=r;if("GET"!==s&&"POST"!==s)throw new Error(`Unsupported method '${s}'`);const o=n.searchParams.get("platform")??r.headers.get("expo-platform");if("string"!=typeof o||!o)return new Response("Missing expo-platform header or platform query parameter",{status:500,headers:{"Content-Type":"text/plain"}});const a=n.searchParams.get("transform.engine");if(a&&!["hermes"].includes(a))return new Response(`Query parameter "transform.engine" is an unsupported value: ${a}`,{status:500,headers:{"Content-Type":"text/plain"}});let d=n.pathname.replace(t,"");d=d.replace(new RegExp(`^${o}/`),"");try{d=(0,exports.decodeInput)(d)}catch{return new Response(`Invalid encoded input: "${d}"`,{status:400,headers:{"Content-Type":"text/plain"}})}try{const t={config:e.config,platform:o,engine:a,input:d,searchParams:n.searchParams,method:s,body:r.body,contentType:r.headers.get("Content-Type")??"",decodedBody:r.headers.get("X-Expo-Params"),onError:e.onError,headers:headersToRecord(r.headers)},p=await e.renderRsc(t);return new Response(p,{headers:{"Content-Type":"text/plain"}})}catch(e){if(e instanceof Response)return e;if("development"!==process.env.NODE_ENV)throw e;return console.error(e),new Response("Unexpected server error rendering RSC: "+e.message,{status:"statusCode"in e?e.statusCode:500,headers:{"Content-Type":"text/plain"}})}}return"/"===t||t.endsWith("/")||(t+="/"),{GET:r,POST:r}}function headersToRecord(e){const t={};for(const[r,n]of e.entries())t[r]=n;return t}exports.decodeInput=decodeInput;