import{errorToResponse}from"./error";import{scopeRef}from"./scope";import{importMetaRegistry}from"../utils/importMetaRegistry";function setupRuntime(){try{Object.defineProperty(globalThis,"origin",{enumerable:!0,configurable:!0,get:()=>scopeRef.current?.getStore()?.origin||"null"})}catch{}try{Object.defineProperty(globalThis,"__ExpoImportMetaRegistry",{enumerable:!0,configurable:!0,get:()=>importMetaRegistry})}catch{}}export function createRequestScope(e,r){function t(e){e.finally(()=>{})}return setupRuntime(),async(o,...n)=>{scopeRef.current=e;const s=r(...n),{waitUntil:i=t}=s,f=[],a=[],c={...s,origin:s.origin,environment:s.environment,waitUntil:i,deferTask:s.deferTask,setResponseHeaders(e){a.push(e)}};let u;c.deferTask||(c.deferTask=function(e){f.push(e)});try{u=null!=scopeRef.current?await scopeRef.current.run(c,()=>o(...n)):await o(...n)}catch(e){if(!(null!=e&&e instanceof Response)||e.bodyUsed){if(null!=e&&e instanceof Error&&"status"in e)return errorToResponse(e);throw e}u=e}f.forEach(e=>{const r=e();null!=r&&i(r)});for(const e of a){let r=u.headers;if("function"==typeof e)r=e(u.headers)||r;else if(e instanceof Headers)r=e;else if("object"==typeof e&&e)for(const t in e)if(Array.isArray(e[t]))for(const o of e[t])r.append(t,o);else null!=e[t]&&r.set(t,e[t]);if(r!==u.headers)for(const[e,t]of r)u.headers.set(e,t)}return u}}