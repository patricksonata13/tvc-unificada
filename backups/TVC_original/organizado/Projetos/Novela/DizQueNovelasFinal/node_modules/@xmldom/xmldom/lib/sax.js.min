var NAMESPACE=require("./conventions").NAMESPACE,nameStartChar=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,nameChar=new RegExp("[\\-\\.0-9"+nameStartChar.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),tagNamePattern=new RegExp("^"+nameStartChar.source+nameChar.source+"*(?::"+nameStartChar.source+nameChar.source+"*)?$"),S_TAG=0,S_ATTR=1,S_ATTR_SPACE=2,S_EQ=3,S_ATTR_NOQUOT_VALUE=4,S_ATTR_END=5,S_TAG_SPACE=6,S_TAG_CLOSE=7;function ParseError(e,r){this.message=e,this.locator=r,Error.captureStackTrace&&Error.captureStackTrace(this,ParseError)}function XMLReader(){}function parse(e,r,t,a,n){function s(e){var r=e.slice(1,-1);return Object.hasOwnProperty.call(t,r)?t[r]:"#"===r.charAt(0)?function(e){if(e>65535){var r=55296+((e-=65536)>>10),t=56320+(1023&e);return String.fromCharCode(r,t)}return String.fromCharCode(e)}(parseInt(r.substr(1).replace("x","0x"))):(n.error("entity not found:"+e),e)}function i(r){if(r>T){var t=e.substring(T,r).replace(/&#?\w+;/g,s);m&&c(T),a.characters(t,0,r-T),T=r}}function c(r,t){for(;r>=u&&(t=l.exec(e));)o=t.index,u=o+t[0].length,m.lineNumber++;m.columnNumber=r-o+1}for(var o=0,u=0,l=/.*(?:\r\n?|\n)|.*$/g,m=a.locator,f=[{currentNSMap:r}],S={},T=0;;){try{var A=e.indexOf("<",T);if(A<0){if(!e.substr(T).match(/^\s*$/)){var _=a.doc,p=_.createTextNode(e.substr(T));_.appendChild(p),a.currentElement=p}return}switch(A>T&&i(A),e.charAt(A+1)){case"/":var d=e.indexOf(">",A+3),h=e.substring(A+2,d).replace(/[ \t\n\r]+$/g,""),E=f.pop();d<0?(h=e.substring(A+2).replace(/[\s<].*/,""),n.error("end tag name: "+h+" is not complete:"+E.tagName),d=A+1+h.length):h.match(/\s</)&&(h=h.replace(/[\s<].*/,""),n.error("end tag name: "+h+" maybe not complete"),d=A+1+h.length);var g=E.localNSMap,N=E.tagName==h;if(N||E.tagName&&E.tagName.toLowerCase()==h.toLowerCase()){if(a.endElement(E.uri,E.localName,h),g)for(var b in g)Object.prototype.hasOwnProperty.call(g,b)&&a.endPrefixMapping(b);N||n.fatalError("end tag name: "+h+" is not match the current start tagName:"+E.tagName)}else f.push(E);d++;break;case"?":m&&c(A),d=parseInstruction(e,A,a);break;case"!":m&&c(A),d=parseDCC(e,A,a,n);break;default:m&&c(A);var C=new ElementAttributes,v=f[f.length-1].currentNSMap,w=(d=parseElementStartPart(e,A,C,v,s,n),C.length);if(!C.closed&&fixSelfClosed(e,d,C.tagName,S)&&(C.closed=!0,t.nbsp||n.warning("unclosed xml attribute")),m&&w){for(var x=copyLocator(m,{}),P=0;P<w;P++){var O=C[P];c(O.offset),O.locator=copyLocator(m,{})}a.locator=x,appendElement(C,a,v)&&f.push(C),a.locator=m}else appendElement(C,a,v)&&f.push(C);NAMESPACE.isHTML(C.uri)&&!C.closed?d=parseHtmlSpecialContent(e,d,C.tagName,s,a):d++}}catch(e){if(e instanceof ParseError)throw e;n.error("element parse error: "+e),d=-1}d>T?T=d:i(Math.max(A,T)+1)}}function copyLocator(e,r){return r.lineNumber=e.lineNumber,r.columnNumber=e.columnNumber,r}function parseElementStartPart(e,r,t,a,n,s){function i(e,r,a){t.attributeNames.hasOwnProperty(e)&&s.fatalError("Attribute "+e+" redefined"),t.addValue(e,r.replace(/[\t\n\r]/g," ").replace(/&#?\w+;/g,n),a)}for(var c,o=++r,u=S_TAG;;){var l=e.charAt(o);switch(l){case"=":if(u===S_ATTR)c=e.slice(r,o),u=S_EQ;else{if(u!==S_ATTR_SPACE)throw new Error("attribute equal must after attrName");u=S_EQ}break;case"'":case'"':if(u===S_EQ||u===S_ATTR){if(u===S_ATTR&&(s.warning('attribute value must after "="'),c=e.slice(r,o)),r=o+1,!((o=e.indexOf(l,r))>0))throw new Error("attribute value no end '"+l+"' match");i(c,m=e.slice(r,o),r-1),u=S_ATTR_END}else{if(u!=S_ATTR_NOQUOT_VALUE)throw new Error('attribute value must after "="');i(c,m=e.slice(r,o),r),s.warning('attribute "'+c+'" missed start quot('+l+")!!"),r=o+1,u=S_ATTR_END}break;case"/":switch(u){case S_TAG:t.setTagName(e.slice(r,o));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:u=S_TAG_CLOSE,t.closed=!0;case S_ATTR_NOQUOT_VALUE:case S_ATTR:break;case S_ATTR_SPACE:t.closed=!0;break;default:throw new Error("attribute invalid close char('/')")}break;case"":return s.error("unexpected end of input"),u==S_TAG&&t.setTagName(e.slice(r,o)),o;case">":switch(u){case S_TAG:t.setTagName(e.slice(r,o));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:break;case S_ATTR_NOQUOT_VALUE:case S_ATTR:"/"===(m=e.slice(r,o)).slice(-1)&&(t.closed=!0,m=m.slice(0,-1));case S_ATTR_SPACE:u===S_ATTR_SPACE&&(m=c),u==S_ATTR_NOQUOT_VALUE?(s.warning('attribute "'+m+'" missed quot(")!'),i(c,m,r)):(NAMESPACE.isHTML(a[""])&&m.match(/^(?:disabled|checked|selected)$/i)||s.warning('attribute "'+m+'" missed value!! "'+m+'" instead!!'),i(m,m,r));break;case S_EQ:throw new Error("attribute value missed!!")}return o;case"Â€":l=" ";default:if(l<=" ")switch(u){case S_TAG:t.setTagName(e.slice(r,o)),u=S_TAG_SPACE;break;case S_ATTR:c=e.slice(r,o),u=S_ATTR_SPACE;break;case S_ATTR_NOQUOT_VALUE:var m=e.slice(r,o);s.warning('attribute "'+m+'" missed quot(")!!'),i(c,m,r);case S_ATTR_END:u=S_TAG_SPACE}else switch(u){case S_ATTR_SPACE:t.tagName;NAMESPACE.isHTML(a[""])&&c.match(/^(?:disabled|checked|selected)$/i)||s.warning('attribute "'+c+'" missed value!! "'+c+'" instead2!!'),i(c,c,r),r=o,u=S_ATTR;break;case S_ATTR_END:s.warning('attribute space is required"'+c+'"!!');case S_TAG_SPACE:u=S_ATTR,r=o;break;case S_EQ:u=S_ATTR_NOQUOT_VALUE,r=o;break;case S_TAG_CLOSE:throw new Error("elements closed character '/' and '>' must be connected to")}}o++}}function appendElement(e,r,t){for(var a=e.tagName,n=null,s=e.length;s--;){var i=e[s],c=i.qName,o=i.value;if((f=c.indexOf(":"))>0)var u=i.prefix=c.slice(0,f),l=c.slice(f+1),m="xmlns"===u&&l;else l=c,u=null,m="xmlns"===c&&"";i.localName=l,!1!==m&&(null==n&&(n={},_copy(t,t={})),t[m]=n[m]=o,i.uri=NAMESPACE.XMLNS,r.startPrefixMapping(m,o))}for(s=e.length;s--;){(u=(i=e[s]).prefix)&&("xml"===u&&(i.uri=NAMESPACE.XML),"xmlns"!==u&&(i.uri=t[u||""]))}var f;(f=a.indexOf(":"))>0?(u=e.prefix=a.slice(0,f),l=e.localName=a.slice(f+1)):(u=null,l=e.localName=a);var S=e.uri=t[u||""];if(r.startElement(S,l,a,e),!e.closed)return e.currentNSMap=t,e.localNSMap=n,!0;if(r.endElement(S,l,a),n)for(u in n)Object.prototype.hasOwnProperty.call(n,u)&&r.endPrefixMapping(u)}function parseHtmlSpecialContent(e,r,t,a,n){if(/^(?:script|textarea)$/i.test(t)){var s=e.indexOf("</"+t+">",r),i=e.substring(r+1,s);if(/[&<]/.test(i))return/^script$/i.test(t)?(n.characters(i,0,i.length),s):(i=i.replace(/&#?\w+;/g,a),n.characters(i,0,i.length),s)}return r+1}function fixSelfClosed(e,r,t,a){var n=a[t];return null==n&&((n=e.lastIndexOf("</"+t+">"))<r&&(n=e.lastIndexOf("</"+t)),a[t]=n),n<r}function _copy(e,r){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}function parseDCC(e,r,t,a){if("-"===e.charAt(r+2))return"-"===e.charAt(r+3)?(n=e.indexOf("--\x3e",r+4))>r?(t.comment(e,r+4,n-r-4),n+3):(a.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(r+3,6)){var n=e.indexOf("]]>",r+9);return t.startCDATA(),t.characters(e,r+9,n-r-9),t.endCDATA(),n+3}var s=split(e,r),i=s.length;if(i>1&&/!doctype/i.test(s[0][0])){var c=s[1][0],o=!1,u=!1;i>3&&(/^public$/i.test(s[2][0])?(o=s[3][0],u=i>4&&s[4][0]):/^system$/i.test(s[2][0])&&(u=s[3][0]));var l=s[i-1];return t.startDTD(c,o,u),t.endDTD(),l.index+l[0].length}return-1}function parseInstruction(e,r,t){var a=e.indexOf("?>",r);if(a){var n=e.substring(r,a).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);if(n){n[0].length;return t.processingInstruction(n[1],n[2]),a+2}return-1}return-1}function ElementAttributes(){this.attributeNames={}}function split(e,r){var t,a=[],n=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;for(n.lastIndex=r,n.exec(e);t=n.exec(e);)if(a.push(t),t[1])return a}ParseError.prototype=new Error,ParseError.prototype.name=ParseError.name,XMLReader.prototype={parse:function(e,r,t){var a=this.domBuilder;a.startDocument(),_copy(r,r={}),parse(e,r,t,a,this.errorHandler),a.endDocument()}},ElementAttributes.prototype={setTagName:function(e){if(!tagNamePattern.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,r,t){if(!tagNamePattern.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:r,offset:t}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},exports.XMLReader=XMLReader,exports.ParseError=ParseError;