"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transform=exports.getCacheKey=exports.default=void 0;var assetTransformer=_interopRequireWildcard(require("./utils/assetTransformer")),_getMinifier=_interopRequireDefault(require("./utils/getMinifier")),_core=require("@babel/core"),_generator=_interopRequireDefault(require("@babel/generator")),babylon=_interopRequireWildcard(require("@babel/parser")),types=_interopRequireWildcard(require("@babel/types")),_metroCache=require("metro-cache"),_metroCacheKey=require("metro-cache-key"),_metroSourceMap=require("metro-source-map"),_metroTransformPlugins=_interopRequireDefault(require("metro-transform-plugins")),_collectDependencies=_interopRequireDefault(require("metro/private/ModuleGraph/worker/collectDependencies")),_generateImportNames=_interopRequireDefault(require("metro/private/ModuleGraph/worker/generateImportNames")),_importLocationsPlugin=require("metro/private/ModuleGraph/worker/importLocationsPlugin"),JsFileWrapping=_interopRequireWildcard(require("metro/private/ModuleGraph/worker/JsFileWrapping")),_nullthrows=_interopRequireDefault(require("nullthrows"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&{}.hasOwnProperty.call(e,o)){var i=a?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(n,o,i):n[o]=e[o]}return n.default=e,t&&t.set(e,n),n}const InternalInvalidRequireCallError=_collectDependencies.default.InvalidRequireCallError;function getDynamicDepsBehavior(e,r){switch(e){case"reject":return"reject";case"throwAtRuntime":return/(?:^|[/\\])node_modules[/\\]/.test(r)?e:"reject";default:throw new Error(`invalid value for dynamic deps behavior: \`${e}\``)}}const minifyCode=async(e,r,t,n,a,o,i=[])=>{const s=(0,_metroSourceMap.fromRawMappings)([{code:n,source:a,map:o,functionMap:null,path:t,isIgnored:!1}]).toMap(void 0,{}),l=(0,_getMinifier.default)(e.minifierPath);try{const r=await l({code:n,map:s,filename:t,reserved:i,config:e.minifierConfig});return{code:r.code,map:r.map?(0,_metroSourceMap.toBabelSegments)(r.map).map(_metroSourceMap.toSegmentTuple):[]}}catch(e){if("JS_Parse_Error"===e.constructor.name)throw new Error(`${e.message} in file ${t} at ${e.line}:${e.col}`);throw e}},disabledDependencyTransformer={transformSyncRequire:()=>{},transformImportCall:()=>{},transformImportMaybeSyncCall:()=>{},transformPrefetch:()=>{},transformIllegalDynamicRequire:()=>{}};class InvalidRequireCallError extends Error{constructor(e,r){super(`${r}:${e.message}`),this.innerError=e,this.filename=r}}async function transformJS(e,{config:r,options:t,projectRoot:n}){let a=e.ast??babylon.parse(e.code,{sourceType:"unambiguous"});const{importDefault:o,importAll:i}=(0,_generateImportNames.default)(a),{directives:s}=a.program;"module"===a.program.sourceType&&null!=s&&-1===s.findIndex(e=>"use strict"===e.value.value)&&s.push(types.directive(types.directiveLiteral("use strict")));const l=[];!0===t.experimentalImportSupport&&l.push([_metroTransformPlugins.default.importExportPlugin,{importAll:i,importDefault:o,resolve:!1}]),t.inlineRequires&&l.push([_metroTransformPlugins.default.inlineRequiresPlugin,{ignoredRequires:t.nonInlinedRequires,inlineableCalls:[o,i],memoizeCalls:t.customTransformOptions?.unstable_memoizeInlineRequires??t.unstable_memoizeInlineRequires,nonMemoizedModules:t.unstable_nonMemoizedInlineRequires}]),l.push([_metroTransformPlugins.default.inlinePlugin,{dev:t.dev,inlinePlatform:t.inlinePlatform,isWrapped:!1,platform:t.platform}]),a=(0,_nullthrows.default)((0,_core.transformFromAstSync)(a,"",{ast:!0,babelrc:!1,code:!1,configFile:!1,comments:!0,filename:e.filename,plugins:l,sourceMaps:!1,cloneInputAst:!0}).ast),t.dev||(a=(0,_nullthrows.default)((0,_core.transformFromAstSync)(a,"",{ast:!0,babelrc:!1,code:!1,configFile:!1,comments:!0,filename:e.filename,plugins:[_metroTransformPlugins.default.constantFoldingPlugin],sourceMaps:!1,cloneInputAst:!1}).ast));let u,c,p="";if("js/script"===e.type)u=[],c=JsFileWrapping.wrapPolyfill(a);else{try{const n=e.unstable_importDeclarationLocs??null,s={asyncRequireModulePath:r.asyncRequireModulePath,dependencyTransformer:!0===r.unstable_disableModuleWrapping?disabledDependencyTransformer:void 0,dynamicRequires:getDynamicDepsBehavior(r.dynamicDepsInPackages,e.filename),inlineableCalls:[o,i],keepRequireNames:t.dev,allowOptionalDependencies:r.allowOptionalDependencies,dependencyMapName:r.unstable_dependencyMapReservedName,unstable_allowRequireContext:r.unstable_allowRequireContext,unstable_isESMImportAtSource:null!=n?e=>n.has((0,_importLocationsPlugin.locToKey)(e)):null};({ast:a,dependencies:u,dependencyMapName:p}=(0,_collectDependencies.default)(a,s))}catch(r){if(r instanceof InternalInvalidRequireCallError)throw new InvalidRequireCallError(r,e.filename);throw r}!0===r.unstable_disableModuleWrapping?c=a:({ast:c}=JsFileWrapping.wrapModule(a,o,i,p,r.globalPrefix,!1===r.unstable_renameRequire,{unstable_useStaticHermesModuleFactory:Boolean(t.customTransformOptions?.unstable_staticHermesOptimizedRequire)}))}const m=t.minify&&"hermes-canary"!==t.unstable_transformProfile&&"hermes-stable"!==t.unstable_transformProfile,f=[];null!=r.unstable_dependencyMapReservedName&&f.push(r.unstable_dependencyMapReservedName),m&&e.inputFileSize<=r.optimizationSizeLimit&&!r.unstable_disableNormalizePseudoGlobals&&f.push(..._metroTransformPlugins.default.normalizePseudoGlobals(c,{reservedNames:f}));const d=(0,_generator.default)(c,{comments:!0,compact:r.unstable_compactOutput,filename:e.filename,retainLines:!1,sourceFileName:e.filename,sourceMaps:!0},e.code);let g,_=d.rawMappings?d.rawMappings.map(_metroSourceMap.toSegmentTuple):[],b=d.code;m&&({map:_,code:b}=await minifyCode(r,0,e.filename,d.code,e.code,_,f)),({lineCount:g,map:_}=countLinesAndTerminateMap(b,_));return{dependencies:u,output:[{data:{code:b,lineCount:g,map:_,functionMap:e.functionMap},type:e.type}]}}async function transformAsset(e,r){const{assetRegistryPath:t,assetPlugins:n}=r.config,a=await assetTransformer.transform(getBabelTransformArgs(e,r),t,n);return transformJS({...e,type:"js/module/asset",ast:a.ast,functionMap:null},r)}async function transformJSWithBabel(e,r){const{babelTransformerPath:t}=r.config,n=require(t),a=await n.transform(getBabelTransformArgs(e,r,[_metroSourceMap.functionMapBabelPlugin,_importLocationsPlugin.importLocationsPlugin])),o={...e,ast:a.ast,functionMap:a.metadata?.metro?.functionMap??a.functionMap??null,unstable_importDeclarationLocs:a.metadata?.metro?.unstable_importDeclarationLocs};return await transformJS(o,r)}async function transformJSON(e,{options:r,config:t,projectRoot:n}){let a=!0===t.unstable_disableModuleWrapping?JsFileWrapping.jsonToCommonJS(e.code):JsFileWrapping.wrapJson(e.code,t.globalPrefix,Boolean(r.customTransformOptions?.unstable_staticHermesOptimizedRequire)),o=[];let i,s;r.minify&&"hermes-canary"!==r.unstable_transformProfile&&"hermes-stable"!==r.unstable_transformProfile&&({map:o,code:a}=await minifyCode(t,0,e.filename,a,e.code,o)),i="asset"===e.type?"js/module/asset":"script"===e.type?"js/script":"js/module",({lineCount:s,map:o}=countLinesAndTerminateMap(a,o));return{dependencies:[],output:[{data:{code:a,lineCount:s,map:o,functionMap:null},type:i}]}}function getBabelTransformArgs(e,{options:r,config:t,projectRoot:n},a=[]){const{inlineRequires:o,...i}=r;return{filename:e.filename,options:{...i,enableBabelRCLookup:t.enableBabelRCLookup,enableBabelRuntime:t.enableBabelRuntime,globalPrefix:t.globalPrefix,hermesParser:t.hermesParser,projectRoot:n,publicPath:t.publicPath},plugins:a,src:e.code}}const transform=async(e,r,t,n,a)=>{const o={config:e,projectRoot:r,options:a},i=n.toString("utf8"),s=[];1==a.customTransformOptions?.unstable_staticHermesOptimizedRequire&&s.push("_$$_METRO_MODULE_ID"),null!=e.unstable_dependencyMapReservedName&&s.push(e.unstable_dependencyMapReservedName);for(const e of s){const r=i.indexOf(e);if(r>-1)throw new SyntaxError("Source code contains the reserved string `"+e+"` at character offset "+r)}if(t.endsWith(".json")){const e={filename:t,inputFileSize:n.length,code:i,type:a.type};return await transformJSON(e,o)}if("asset"===a.type){const e={filename:t,inputFileSize:n.length,code:i,type:a.type};return await transformAsset(e,o)}const l={filename:t,inputFileSize:n.length,code:i,type:"script"===a.type?"js/script":"js/module",functionMap:null};return await transformJSWithBabel(l,o)};exports.transform=transform;const getCacheKey=e=>{const{babelTransformerPath:r,minifierPath:t,...n}=e,a=(0,_metroCacheKey.getCacheKey)([__filename,require.resolve(r),require.resolve(t),require.resolve("./utils/getMinifier"),require.resolve("./utils/assetTransformer"),require.resolve("metro/private/ModuleGraph/worker/generateImportNames"),require.resolve("metro/private/ModuleGraph/worker/JsFileWrapping"),..._metroTransformPlugins.default.getTransformPluginCacheKeyFiles()]),o=require(r);return[a,(0,_metroCache.stableHash)(n).toString("hex"),o.getCacheKey?o.getCacheKey():""].join("$")};function countLinesAndTerminateMap(e,r){const t=/\r\n?|\n|\u2028|\u2029/g;let n=1,a=0;for(const r of e.matchAll(t))n++,a=r.index+r[0].length;const o=n,i=e.length-a,s=r[r.length-1],l=[o,i];return s&&s[0]===l[0]&&s[1]===l[1]?{lineCount:n,map:[...r]}:{lineCount:n,map:r.concat([l])}}exports.getCacheKey=getCacheKey;var _default=exports.default={getCacheKey:getCacheKey,transform:transform};