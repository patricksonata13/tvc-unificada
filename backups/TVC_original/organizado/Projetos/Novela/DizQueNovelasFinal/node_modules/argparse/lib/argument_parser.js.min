"use strict";var util=require("util"),format=require("util").format,Path=require("path"),sprintf=require("sprintf-js").sprintf,c=require("./const"),$$=require("./utils"),ActionContainer=require("./action_container"),argumentErrorHelper=require("./argument/error"),HelpFormatter=require("./help/formatter"),Namespace=require("./namespace");function ArgumentParser(r){if(!(this instanceof ArgumentParser))return new ArgumentParser(r);var t=this;function e(r){return r}(r=r||{}).description=r.description||null,r.argumentDefault=r.argumentDefault||null,r.prefixChars=r.prefixChars||"-",r.conflictHandler=r.conflictHandler||"error",ActionContainer.call(this,r),r.addHelp=void 0===r.addHelp||!!r.addHelp,r.parents=r.parents||[],r.prog=r.prog||Path.basename(process.argv[1]),this.prog=r.prog,this.usage=r.usage,this.epilog=r.epilog,this.version=r.version,this.debug=!0===r.debug,this.formatterClass=r.formatterClass||HelpFormatter,this.fromfilePrefixChars=r.fromfilePrefixChars||null,this._positionals=this.addArgumentGroup({title:"Positional arguments"}),this._optionals=this.addArgumentGroup({title:"Optional arguments"}),this._subparsers=null,this.register("type","auto",e),this.register("type",null,e),this.register("type","int",function(r){var t=parseInt(r,10);if(isNaN(t))throw new Error(r+" is not a valid integer.");return t}),this.register("type","float",function(r){var t=parseFloat(r);if(isNaN(t))throw new Error(r+" is not a valid float.");return t}),this.register("type","string",function(r){return""+r});var n=this.prefixChars.indexOf("-")>-1?"-":this.prefixChars[0];r.addHelp&&this.addArgument([n+"h",n+n+"help"],{action:"help",defaultValue:c.SUPPRESS,help:"Show this help message and exit."}),void 0!==this.version&&this.addArgument([n+"v",n+n+"version"],{action:"version",version:this.version,defaultValue:c.SUPPRESS,help:"Show program's version number and exit."}),r.parents.forEach(function(r){if(t._addContainerActions(r),void 0!==r._defaults)for(var e in r._defaults)r._defaults.hasOwnProperty(e)&&(t._defaults[e]=r._defaults[e])})}util.inherits(ArgumentParser,ActionContainer),ArgumentParser.prototype.addSubparsers=function(r){if(this._subparsers&&this.error("Cannot have multiple subparser arguments."),(r=r||{}).debug=!0===this.debug,r.optionStrings=[],r.parserClass=r.parserClass||ArgumentParser,r.title||r.description?(this._subparsers=this.addArgumentGroup({title:r.title||"subcommands",description:r.description}),delete r.title,delete r.description):this._subparsers=this._positionals,!r.prog){var t=this._getFormatter(),e=this._getPositionalActions(),n=this._mutuallyExclusiveGroups;t.addUsage(this.usage,e,n,""),r.prog=t.formatHelp().trim()}var i=new(this._popActionClass(r,"parsers"))(r);return this._subparsers._addAction(i),i},ArgumentParser.prototype._addAction=function(r){return r.isOptional()?this._optionals._addAction(r):this._positionals._addAction(r),r},ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(r){return r.isOptional()})},ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(r){return r.isPositional()})},ArgumentParser.prototype.parseArgs=function(r,t){var e,n=this.parseKnownArgs(r,t);return r=n[0],(e=n[1])&&e.length>0&&this.error(format("Unrecognized arguments: %s.",e.join(" "))),r},ArgumentParser.prototype.parseKnownArgs=function(r,t){var e=this;r=r||process.argv.slice(2),t=t||new Namespace,e._actions.forEach(function(r){if(r.dest!==c.SUPPRESS&&!$$.has(t,r.dest)&&r.defaultValue!==c.SUPPRESS){var n=r.defaultValue;"string"==typeof r.defaultValue&&(n=e._getValue(r,n)),t[r.dest]=n}}),Object.keys(e._defaults).forEach(function(r){t[r]=e._defaults[r]});try{var n=this._parseKnownArgs(r,t);return t=n[0],r=n[1],$$.has(t,c._UNRECOGNIZED_ARGS_ATTR)&&(r=$$.arrayUnion(r,t[c._UNRECOGNIZED_ARGS_ATTR]),delete t[c._UNRECOGNIZED_ARGS_ATTR]),[t,r]}catch(r){this.error(r)}},ArgumentParser.prototype._parseKnownArgs=function(r,t){var e,n,i=this,s=[];function a(r){return r.getName()}null!==this.fromfilePrefixChars&&(r=this._readArgsFromFiles(r));var o={};this._mutuallyExclusiveGroups.forEach(function(r){r._groupActions.forEach(function(r,t,i){n=a(r),$$.has(o,n)||(o[n]=[]),(e=o[n]).push.apply(e,i.slice(0,t)),e.push.apply(e,i.slice(t+1))})});var u={},p=[];r.forEach(function(t,e){if("--"===t)for(p.push("-");e<r.length;)p.push("A"),e++;else{var n,s=i._parseOptional(t);s?(u[e]=s,n="O"):n="A",p.push(n)}});var l=p.join(""),h=[],f=[];function g(r,e,n){h.push(r);var s=i._getValues(r,e);s!==r.defaultValue&&(f.push(r),o[a(r)]&&o[a(r)].forEach(function(t){if(f.indexOf(t)>=0)throw argumentErrorHelper(r,format('Not allowed with argument "%s".',t.getName()))})),s!==c.SUPPRESS&&r.call(i,t,s,n)}function m(t){for(var e,n,a,o,p=u[t],c=p[0],h=p[1],f=p[2],m=[];;){if(!c)return s.push(r[t]),t+1;if(!f){a=t+1;var d=l.substr(a);o=a+(n=i._matchArgument(c,d)),e=r.slice(a,o),m.push([c,e,h]);break}n=i._matchArgument(c,"A");var A=i.prefixChars;if(!(0===n&&A.indexOf(h[1])<0)){if(1===n){o=t+1,e=[f],m.push([c,e,h]);break}throw argumentErrorHelper(c,sprintf("ignored explicit argument %r",f))}m.push([c,[],h]),h=h[0]+f[0];var _=f.slice(1)||null,v=i._optionStringActions;if(!(Object.keys(v).indexOf(h)>=0))throw argumentErrorHelper(c,sprintf("ignored explicit argument %r",f));c=v[h],f=_}if(m.length<1)throw new Error("length should be > 0");for(var y=0;y<m.length;y++)g.apply(i,m[y]);return o}var d=i._getPositionalActions();function A(t){for(var e=l.substr(t),n=i._matchArgumentsPartial(d,e),s=0;s<d.length;s++){var a=d[s],o=n[s];if(void 0!==o){var u=r.slice(t,t+o);t+=o,g(a,u)}}return d=d.slice(n.length),t}var _,v,y,E=0,P=-1;for(Object.keys(u).forEach(function(r){P=Math.max(P,parseInt(r,10))});E<=P;){for(_ in y=null,u)u.hasOwnProperty(_)&&(_=parseInt(_,10))>=E&&(y=null!==y?Math.min(y,_):_);if(E!==y){if((v=A(E))>E){E=v;continue}E=v}if(!u[E]){var O=r.slice(E,y);s=s.concat(O),E=y}E=m(E)}var x=A(E);s=s.concat(r.slice(x)),d.length>0&&i.error("too few arguments"),i._actions.forEach(function(r){r.required&&h.indexOf(r)<0&&i.error(format('Argument "%s" is required',r.getName()))});return i._mutuallyExclusiveGroups.forEach(function(r){if(r.required&&!r._groupActions.some(function(r){return-1!==f.indexOf(r)})){var t=[];r._groupActions.forEach(function(r){r.help!==c.SUPPRESS&&t.push(r.getName())});var e="one of the arguments "+(t=t.join(" "))+" is required";i.error(e)}}),[t,s]},ArgumentParser.prototype._readArgsFromFiles=function(r){var t=this,e=require("fs"),n=[];return r.forEach(function(r){if(t.fromfilePrefixChars.indexOf(r[0])<0)n.push(r);else try{var i=[],s=r.slice(1),a=e.readFileSync(s,"utf8");(a=a.trim().split("\n")).forEach(function(r){t.convertArgLineToArgs(r).forEach(function(r){i.push(r)}),i=t._readArgsFromFiles(i)}),n.push.apply(n,i)}catch(r){return t.error(r.message)}}),n},ArgumentParser.prototype.convertArgLineToArgs=function(r){return[r]},ArgumentParser.prototype._matchArgument=function(r,t){var e,n=new RegExp("^"+this._getNargsPattern(r)),i=t.match(n);if(!i){switch(r.nargs){case void 0:case null:e="Expected one argument.";break;case c.OPTIONAL:e="Expected at most one argument.";break;case c.ONE_OR_MORE:e="Expected at least one argument.";break;default:e="Expected %s argument(s)"}throw argumentErrorHelper(r,format(e,r.nargs))}return i[1].length},ArgumentParser.prototype._matchArgumentsPartial=function(r,t){var e,n,i,s,a,o=[];function u(r){return r.length}for(s=r.length;s>0;s--){for(n="",e=r.slice(0,s),a=0;a<e.length;a++)n+=this._getNargsPattern(e[a]);if(n=new RegExp("^"+n),(i=t.match(n))&&i.length>0){i=i.splice(1),o=o.concat(i.map(u));break}}return o},ArgumentParser.prototype._parseOptional=function(r){var t,e,n;if(!r)return null;if(this.prefixChars.indexOf(r[0])<0)return null;if(this._optionStringActions[r])return[this._optionStringActions[r],r,null];if(1===r.length)return null;if(r.indexOf("=")>=0&&(t=r.split("=",1)[0],e=r.slice(t.length+1),this._optionStringActions[t]))return[this._optionStringActions[t],t,e];if((n=this._getOptionTuples(r)).length>1){var i=n.map(function(r){return r[1]});this.error(format('Ambiguous option: "%s" could match %s.',r,i.join(", ")))}else if(1===n.length)return n[0];return r.match(this._regexpNegativeNumber)&&!this._hasNegativeNumberOptionals.some(Boolean)||r.search(" ")>=0?null:[null,r,null]},ArgumentParser.prototype._getOptionTuples=function(r){var t,e,n,i,s=[],a=this.prefixChars;if(a.indexOf(r[0])>=0&&a.indexOf(r[1])>=0){if(r.indexOf("=")>=0){var o=r.split("=",1);t=o[0],e=o[1]}else t=r,e=null;for(i in this._optionStringActions)i.substr(0,t.length)===t&&(n=this._optionStringActions[i],s.push([n,i,e]))}else{if(!(a.indexOf(r[0])>=0&&a.indexOf(r[1])<0))throw new Error(format("Unexpected option string: %s.",r));t=r,e=null;var u=r.substr(0,2),p=r.substr(2);for(i in this._optionStringActions)$$.has(this._optionStringActions,i)&&(n=this._optionStringActions[i],i===u?s.push([n,i,p]):i.substr(0,t.length)===t&&s.push([n,i,e]))}return s},ArgumentParser.prototype._getNargsPattern=function(r){var t;switch(r.nargs){case void 0:case null:t="(-*A-*)";break;case c.OPTIONAL:t="(-*A?-*)";break;case c.ZERO_OR_MORE:t="(-*[A-]*)";break;case c.ONE_OR_MORE:t="(-*A[A-]*)";break;case c.REMAINDER:t="([-AO]*)";break;case c.PARSER:t="(-*A[-AO]*)";break;default:t="(-*"+$$.repeat("-*A",r.nargs)+"-*)"}return r.isOptional()&&(t=(t=t.replace(/-\*/g,"")).replace(/-/g,"")),t},ArgumentParser.prototype._getValues=function(r,t){var e,n,i=this;return r.nargs!==c.PARSER&&r.nargs!==c.REMAINDER&&(t=t.filter(function(r){return"--"!==r})),0===t.length&&r.nargs===c.OPTIONAL?"string"==typeof(e=r.isOptional()?r.constant:r.defaultValue)&&(e=this._getValue(r,e),this._checkValue(r,e)):0===t.length&&r.nargs===c.ZERO_OR_MORE&&0===r.optionStrings.length?(e=r.defaultValue||t,this._checkValue(r,e)):1!==t.length||r.nargs&&r.nargs!==c.OPTIONAL?r.nargs===c.REMAINDER?e=t.map(function(t){return i._getValue(r,t)}):r.nargs===c.PARSER?(e=t.map(function(t){return i._getValue(r,t)}),this._checkValue(r,e[0])):(e=t.map(function(t){return i._getValue(r,t)})).forEach(function(t){i._checkValue(r,t)}):(n=t[0],e=this._getValue(r,n),this._checkValue(r,e)),e},ArgumentParser.prototype._getValue=function(r,t){var e,n=this._registryGet("type",r.type,r.type);if("function"!=typeof n){var i=format("%s is not callable",n);throw argumentErrorHelper(r,i)}try{e=n(t)}catch(e){var s=null;s="string"==typeof r.type?r.type:r.type.name||r.type.displayName||"<function>";var a=format("Invalid %s value: %s",s,t);throw"<function>"===s&&(a+="\n"+e.message),argumentErrorHelper(r,a)}return e},ArgumentParser.prototype._checkValue=function(r,t){var e=r.choices;if(e){if(("string"==typeof e||Array.isArray(e))&&-1!==e.indexOf(t))return;if("object"==typeof e&&!Array.isArray(e)&&e[t])return;e="string"==typeof e?e.split("").join(", "):Array.isArray(e)?e.join(", "):Object.keys(e).join(", ");var n=format("Invalid choice: %s (choose from [%s])",t,e);throw argumentErrorHelper(r,n)}},ArgumentParser.prototype.formatUsage=function(){var r=this._getFormatter();return r.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),r.formatHelp()},ArgumentParser.prototype.formatHelp=function(){var r=this._getFormatter();return r.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),r.addText(this.description),this._actionGroups.forEach(function(t){r.startSection(t.title),r.addText(t.description),r.addArguments(t._groupActions),r.endSection()}),r.addText(this.epilog),r.formatHelp()},ArgumentParser.prototype._getFormatter=function(){return new(0,this.formatterClass)({prog:this.prog})},ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())},ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())},ArgumentParser.prototype._printMessage=function(r,t){t||(t=process.stdout),r&&t.write(""+r)},ArgumentParser.prototype.exit=function(r,t){t&&(0===r?this._printMessage(t):this._printMessage(t,process.stderr)),process.exit(r)},ArgumentParser.prototype.error=function(r){var t;if(r instanceof Error){if(!0===this.debug)throw r;t=r.message}else t=r;var e=format("%s: error: %s",this.prog,t)+c.EOL;if(!0===this.debug)throw new Error(e);return this.printUsage(process.stderr),this.exit(2,e)},module.exports=ArgumentParser;