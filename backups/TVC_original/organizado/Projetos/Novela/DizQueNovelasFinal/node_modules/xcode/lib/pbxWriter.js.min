var pbxProj=require("./pbxProject"),util=require("util"),f=util.format,INDENT="\t",COMMENT_KEY=/_comment$/,QUOTED=/^"(.*)"$/,EventEmitter=require("events").EventEmitter;function i(t){return t<=0?"":INDENT+i(t-1)}function comment(t,e){var i=e[t+"_comment"];return i||null}function isObject(t){return t===Object(t)}function isArray(t){return Array.isArray(t)}function pbxWriter(t,e){e||(e={}),void 0===e.omitEmptyValues&&(e.omitEmptyValues=!1),this.contents=t,this.sync=!1,this.indentLevel=0,this.omitEmptyValues=e.omitEmptyValues}util.inherits(pbxWriter,EventEmitter),pbxWriter.prototype.write=function(t){var e=f.apply(null,arguments);this.sync&&(this.buffer+=f("%s%s",i(this.indentLevel),e))},pbxWriter.prototype.writeFlush=function(t){var e=this.indentLevel;this.indentLevel=0,this.write.apply(this,arguments),this.indentLevel=e},pbxWriter.prototype.writeSync=function(){return this.sync=!0,this.buffer="",this.writeHeadComment(),this.writeProject(),this.buffer},pbxWriter.prototype.writeHeadComment=function(){this.contents.headComment&&this.write("// %s\n",this.contents.headComment)},pbxWriter.prototype.writeProject=function(){var t,e,i,n=this.contents.project;if(this.write("{\n"),n){for(t in this.indentLevel++,n)if(!COMMENT_KEY.test(t))if(e=comment(t,n),isArray(i=n[t]))this.writeArray(i,t);else if(isObject(i))this.write("%s = {\n",t),this.indentLevel++,"objects"===t?this.writeObjectsSections(i):this.writeObject(i),this.indentLevel--,this.write("};\n");else{if(this.omitEmptyValues&&null==i)continue;e?this.write("%s = %s /* %s */;\n",t,i,e):this.write("%s = %s;\n",t,i)}this.indentLevel--}this.write("}\n")},pbxWriter.prototype.writeObject=function(t){var e,i,n;for(e in t)if(!COMMENT_KEY.test(e))if(n=comment(e,t),isArray(i=t[e]))this.writeArray(i,e);else if(isObject(i))this.write("%s = {\n",e),this.indentLevel++,this.writeObject(i),this.indentLevel--,this.write("};\n");else{if(this.omitEmptyValues&&null==i)continue;n?this.write("%s = %s /* %s */;\n",e,i,n):this.write("%s = %s;\n",e,i)}},pbxWriter.prototype.writeObjectsSections=function(t){var e,i;for(e in t)this.writeFlush("\n"),isObject(i=t[e])&&(this.writeSectionComment(e,!0),this.writeSection(i),this.writeSectionComment(e,!1))},pbxWriter.prototype.writeArray=function(t,e){var i,n;for(this.write("%s = (\n",e),this.indentLevel++,i=0;i<t.length;i++)(n=t[i]).value&&n.comment?this.write("%s /* %s */,\n",n.value,n.comment):isObject(n)?(this.write("{\n"),this.indentLevel++,this.writeObject(n),this.indentLevel--,this.write("},\n")):this.write("%s,\n",n);this.indentLevel--,this.write(");\n")},pbxWriter.prototype.writeSectionComment=function(t,e){e?this.writeFlush("/* Begin %s section */\n",t):this.writeFlush("/* End %s section */\n",t)},pbxWriter.prototype.writeSection=function(t){var e,i,n;for(e in t)COMMENT_KEY.test(e)||(n=comment(e,t),"PBXBuildFile"==(i=t[e]).isa||"PBXFileReference"==i.isa?this.writeInlineObject(e,n,i):(n?this.write("%s /* %s */ = {\n",e,n):this.write("%s = {\n",e),this.indentLevel++,this.writeObject(i),this.indentLevel--,this.write("};\n")))},pbxWriter.prototype.writeInlineObject=function(t,e,i){var n=[],s=this,r=function(t,e,i){var o,h,c;for(o in e?n.push(f("%s /* %s */ = {",t,e)):n.push(f("%s = {",t)),i)if(!COMMENT_KEY.test(o))if(h=comment(o,i),isArray(c=i[o])){n.push(f("%s = (",o));for(var u=0;u<c.length;u++)n.push(f("%s, ",c[u]));n.push("); ")}else if(isObject(c))r(o,h,c);else{if(s.omitEmptyValues&&null==c)continue;h?n.push(f("%s = %s /* %s */; ",o,c,h)):n.push(f("%s = %s; ",o,c))}n.push("}; ")};r(t,e,i),this.write("%s\n",n.join("").trim())},module.exports=pbxWriter;